<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>深入理解Promise | aoaYaoa</title><meta name="author" content="aoaYaoa"><meta name="copyright" content="aoaYaoa"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="深入理解 JavaScript Promise：从入门到精通前言Promise 是 JavaScript 中处理异步操作的核心机制，它的出现让我们告别了回调地狱，使异步代码更加清晰和易于维护。本文将深入探讨 Promise 的方方面面，从基础概念到高级应用，帮助你全面掌握这一重要特性。 目录 1. Promise 基础 2. Promise 状态 3. Promise 方法 4. 错误处理 5.">
<meta property="og:type" content="article">
<meta property="og:title" content="深入理解Promise">
<meta property="og:url" content="https://aoayaoa.github.io/2024/12/13/Promise/index.html">
<meta property="og:site_name" content="aoaYaoa">
<meta property="og:description" content="深入理解 JavaScript Promise：从入门到精通前言Promise 是 JavaScript 中处理异步操作的核心机制，它的出现让我们告别了回调地狱，使异步代码更加清晰和易于维护。本文将深入探讨 Promise 的方方面面，从基础概念到高级应用，帮助你全面掌握这一重要特性。 目录 1. Promise 基础 2. Promise 状态 3. Promise 方法 4. 错误处理 5.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://aoayaoa.github.io/img/promise.png">
<meta property="article:published_time" content="2024-12-12T16:00:00.000Z">
<meta property="article:modified_time" content="2025-03-07T03:59:37.941Z">
<meta property="article:author" content="aoaYaoa">
<meta property="article:tag" content="Promise">
<meta property="article:tag" content="入门">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://aoayaoa.github.io/img/promise.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "深入理解Promise",
  "url": "https://aoayaoa.github.io/2024/12/13/Promise/",
  "image": "https://aoayaoa.github.io/img/promise.png",
  "datePublished": "2024-12-12T16:00:00.000Z",
  "dateModified": "2025-03-07T03:59:37.941Z",
  "author": [
    {
      "@type": "Person",
      "name": "aoaYaoa",
      "url": "https://aoayaoa.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://aoayaoa.github.io/2024/12/13/Promise/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: aoaYaoa","link":"链接: ","source":"来源: aoaYaoa","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '深入理解Promise',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/base.css"><script src="/js/resources.js"></script><link rel="alternate" href="/atom.xml" title="aoaYaoa" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">10</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">10</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-book-open"></i><span> 文章</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-calendar-alt"></i><span> 日常</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fas fa-comment-dots"></i><span> 说说</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/resources/"><i class="fa-fw fas fa-compass"></i><span> 资源</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(/img/promise.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/img/avatar.jpg" alt="Logo"><span class="site-name">aoaYaoa</span></a><a class="nav-page-title" href="/"><span class="site-name">深入理解Promise</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-book-open"></i><span> 文章</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-calendar-alt"></i><span> 日常</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fas fa-comment-dots"></i><span> 说说</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/resources/"><i class="fa-fw fas fa-compass"></i><span> 资源</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">深入理解Promise</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-12-12T16:00:00.000Z" title="发表于 2024-12-13 00:00:00">2024-12-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-03-07T03:59:37.941Z" title="更新于 2025-03-07 11:59:37">2025-03-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%95%99%E7%A8%8B/">教程</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>33分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="深入理解-JavaScript-Promise：从入门到精通"><a href="#深入理解-JavaScript-Promise：从入门到精通" class="headerlink" title="深入理解 JavaScript Promise：从入门到精通"></a>深入理解 JavaScript Promise：从入门到精通</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Promise 是 JavaScript 中处理异步操作的核心机制，它的出现让我们告别了回调地狱，使异步代码更加清晰和易于维护。本文将深入探讨 Promise 的方方面面，从基础概念到高级应用，帮助你全面掌握这一重要特性。</p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#1-promise-%E5%9F%BA%E7%A1%80">1. Promise 基础</a></li>
<li><a href="#2-promise-%E7%8A%B6%E6%80%81">2. Promise 状态</a></li>
<li><a href="#3-promise-%E6%96%B9%E6%B3%95">3. Promise 方法</a></li>
<li><a href="#4-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">4. 错误处理</a></li>
<li><a href="#5-promise-%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8">5. Promise 链式调用</a></li>
<li><a href="#6-promise-%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95">6. Promise 静态方法</a></li>
<li><a href="#7-asyncawait">7. async&#x2F;await</a></li>
<li><a href="#8-%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF">8. 实际应用场景</a></li>
<li><a href="#9-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">9. 最佳实践</a></li>
<li><a href="#10-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E5%92%8C%E9%99%B7%E9%98%B1">10. 常见问题和陷阱</a></li>
<li><a href="#11-%E6%9B%B4%E5%A4%9A%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF">11. 更多实际应用场景</a></li>
<li><a href="#12-%E8%AF%A6%E7%BB%86%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E6%8C%87%E5%8D%97">12. 详细错误处理指南</a></li>
<li><a href="#13-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">13. 性能优化最佳实践</a></li>
<li><a href="#14-%E8%A1%A5%E5%85%85%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E5%BB%BA%E8%AE%AE">14. 补充最佳实践建议</a></li>
</ul>
<h2 id="1-Promise-基础"><a href="#1-Promise-基础" class="headerlink" title="1. Promise 基础"></a>1. Promise 基础</h2><h3 id="1-1-什么是-Promise？"><a href="#1-1-什么是-Promise？" class="headerlink" title="1.1 什么是 Promise？"></a>1.1 什么是 Promise？</h3><p>Promise 是异步编程的一种解决方案，比传统的回调函数更加优雅。它是一个代表了异步操作最终完成或失败的对象。通过 Promise，我们可以用同步操作的流程写法来处理异步操作，避免了回调函数层层嵌套的问题。</p>
<h3 id="1-2-基本语法"><a href="#1-2-基本语法" class="headerlink" title="1.2 基本语法"></a>1.2 基本语法</h3><p>Promise 的基本语法非常简单，让我们通过一个例子来了解：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 异步操作</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="comment">/* 操作成功 */</span>) &#123;</span><br><span class="line">        <span class="title function_">resolve</span>(value);  <span class="comment">// 成功时调用</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">reject</span>(error);   <span class="comment">// 失败时调用</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这个构造函数接收一个执行器（executor）函数作为参数，该函数会立即执行。执行器函数接收两个参数：resolve 和 reject，它们是由 JavaScript 引擎提供的函数。</p>
<h3 id="1-3-基本用法"><a href="#1-3-基本用法" class="headerlink" title="1.3 基本用法"></a>1.3 基本用法</h3><p>Promise 对象创建后，我们可以通过它的方法来处理异步操作的结果：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">promise</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 处理成功情况</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;成功：&#x27;</span>, result);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 处理错误情况</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;错误：&#x27;</span>, error);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">finally</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 总是执行</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;操作完成&#x27;</span>);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>这种链式调用的方式使得异步操作的流程更加清晰，代码更易于理解和维护。</p>
<h2 id="2-Promise-状态"><a href="#2-Promise-状态" class="headerlink" title="2. Promise 状态"></a>2. Promise 状态</h2><p>Promise 的状态是它的核心特性之一，理解 Promise 的状态对于正确使用它至关重要。</p>
<h3 id="2-1-三种状态"><a href="#2-1-三种状态" class="headerlink" title="2.1 三种状态"></a>2.1 三种状态</h3><p>Promise 有且仅有三种状态：</p>
<ul>
<li><strong>pending（进行中）</strong>：初始状态，既不是成功，也不是失败</li>
<li><strong>fulfilled（已成功）</strong>：操作成功完成</li>
<li><strong>rejected（已失败）</strong>：操作失败</li>
</ul>
<h3 id="2-2-状态转换"><a href="#2-2-状态转换" class="headerlink" title="2.2 状态转换"></a>2.2 状态转换</h3><p>Promise 的状态转换是单向的，一旦状态改变，就不会再变。这种特性称为”状态的不可逆性”。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 状态转换示例</span></span><br><span class="line"><span class="keyword">const</span> successPromise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">resolve</span>(<span class="string">&#x27;成功&#x27;</span>);  <span class="comment">// pending -&gt; fulfilled</span></span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> failedPromise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">reject</span>(<span class="string">&#x27;失败&#x27;</span>);   <span class="comment">// pending -&gt; rejected</span></span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="2-3-状态的不可逆性"><a href="#2-3-状态的不可逆性" class="headerlink" title="2.3 状态的不可逆性"></a>2.3 状态的不可逆性</h3><p>一旦 Promise 的状态改变，后续的状态修改操作将被忽略：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">resolve</span>(<span class="string">&#x27;成功&#x27;</span>);    <span class="comment">// 状态变为 fulfilled</span></span><br><span class="line">    <span class="title function_">reject</span>(<span class="string">&#x27;失败&#x27;</span>);     <span class="comment">// 这行代码会被忽略</span></span><br><span class="line">    <span class="title function_">resolve</span>(<span class="string">&#x27;再次成功&#x27;</span>); <span class="comment">// 这行代码也会被忽略</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="3-Promise-方法"><a href="#3-Promise-方法" class="headerlink" title="3. Promise 方法"></a>3. Promise 方法</h2><p>Promise 提供了几个关键的实例方法，让我们能够优雅地处理异步操作的结果。</p>
<h3 id="3-1-then-方法"><a href="#3-1-then-方法" class="headerlink" title="3.1 then() 方法"></a>3.1 then() 方法</h3><p><code>then()</code> 是最常用的 Promise 方法，它可以接收两个回调函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">promise.<span class="title function_">then</span>(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 处理成功的情况</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;成功：&#x27;</span>, result);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 处理失败的情况（可选）</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;失败：&#x27;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="3-2-catch-方法"><a href="#3-2-catch-方法" class="headerlink" title="3.2 catch() 方法"></a>3.2 catch() 方法</h3><p><code>catch()</code> 方法用于处理 Promise 中的错误，它是 <code>.then(null, rejection)</code> 的语法糖：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">promise.<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 处理错误</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;发生错误：&#x27;</span>, error);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="3-3-finally-方法"><a href="#3-3-finally-方法" class="headerlink" title="3.3 finally() 方法"></a>3.3 finally() 方法</h3><p><code>finally()</code> 方法用于指定无论 Promise 对象最后状态如何，都会执行的操作：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">promise.<span class="title function_">finally</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 清理工作</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Promise 已完成&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="4-错误处理"><a href="#4-错误处理" class="headerlink" title="4. 错误处理"></a>4. 错误处理</h2><h3 id="4-1-错误捕获方式"><a href="#4-1-错误捕获方式" class="headerlink" title="4.1 错误捕获方式"></a>4.1 错误捕获方式</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方式 1：使用 catch</span></span><br><span class="line">promise</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;&#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式 2：使用 then 的第二个参数</span></span><br><span class="line">promise.<span class="title function_">then</span>(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> &#123;&#125;,</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> &#123;&#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="4-2-错误处理逻辑"><a href="#4-2-错误处理逻辑" class="headerlink" title="4.2 错误处理逻辑"></a>4.2 错误处理逻辑</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">promise</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 返回普通值 - 恢复到 fulfilled 状态</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;recovered&#x27;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 抛出错误 - 继续 rejected 状态</span></span><br><span class="line">        <span class="keyword">throw</span> error;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 返回 rejected promise - 继续 rejected 状态</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<h2 id="5-Promise-链式调用"><a href="#5-Promise-链式调用" class="headerlink" title="5. Promise 链式调用"></a>5. Promise 链式调用</h2><h3 id="5-1-基本链式调用"><a href="#5-1-基本链式调用" class="headerlink" title="5.1 基本链式调用"></a>5.1 基本链式调用</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">promise</span><br><span class="line">    .<span class="title function_">then</span>(step1)</span><br><span class="line">    .<span class="title function_">then</span>(step2)</span><br><span class="line">    .<span class="title function_">then</span>(step3)</span><br><span class="line">    .<span class="title function_">catch</span>(handleError);</span><br></pre></td></tr></table></figure>

<h3 id="5-2-值的传递"><a href="#5-2-值的传递" class="headerlink" title="5.2 值的传递"></a>5.2 值的传递</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="number">1</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">x</span> =&gt;</span> x + <span class="number">1</span>)     <span class="comment">// 2</span></span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">x</span> =&gt;</span> x * <span class="number">2</span>)     <span class="comment">// 4</span></span><br><span class="line">    .<span class="title function_">then</span>(<span class="variable language_">console</span>.<span class="property">log</span>);   <span class="comment">// 输出: 4</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-Promise-链中的错误处理"><a href="#5-3-Promise-链中的错误处理" class="headerlink" title="5.3 Promise 链中的错误处理"></a>5.3 Promise 链中的错误处理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetchUser</span>()</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!user.<span class="property">id</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Invalid user&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">fetchProfile</span>(user.<span class="property">id</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">profile</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">updateProfile</span>(profile);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 处理任何步骤中的错误</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<h2 id="6-Promise-静态方法"><a href="#6-Promise-静态方法" class="headerlink" title="6. Promise 静态方法"></a>6. Promise 静态方法</h2><h3 id="6-1-Promise-resolve"><a href="#6-1-Promise-resolve" class="headerlink" title="6.1 Promise.resolve()"></a>6.1 Promise.resolve()</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个立即 resolve 的 Promise</span></span><br><span class="line"><span class="keyword">const</span> resolved = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(value);</span><br></pre></td></tr></table></figure>

<h3 id="6-2-Promise-reject"><a href="#6-2-Promise-reject" class="headerlink" title="6.2 Promise.reject()"></a>6.2 Promise.reject()</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个立即 reject 的 Promise</span></span><br><span class="line"><span class="keyword">const</span> rejected = <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br></pre></td></tr></table></figure>

<h3 id="6-3-Promise-all"><a href="#6-3-Promise-all" class="headerlink" title="6.3 Promise.all()"></a>6.3 Promise.all()</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 等待所有 Promise 完成</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">all</span>([promise1, promise2, promise3])</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">results</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// results 是一个数组，包含所有 Promise 的结果</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="6-4-Promise-race"><a href="#6-4-Promise-race" class="headerlink" title="6.4 Promise.race()"></a>6.4 Promise.race()</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回最先完成的 Promise 结果</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">race</span>([promise1, promise2])</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">firstResult</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// firstResult 是最先完成的 Promise 的结果</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="6-5-Promise-allSettled"><a href="#6-5-Promise-allSettled" class="headerlink" title="6.5 Promise.allSettled()"></a>6.5 Promise.allSettled()</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 等待所有 Promise 完成（无论成功或失败）</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">allSettled</span>([promise1, promise2])</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">results</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// results 包含所有 Promise 的状态和结果</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<h2 id="7-async-await"><a href="#7-async-await" class="headerlink" title="7. async&#x2F;await"></a>7. async&#x2F;await</h2><h3 id="7-1-基本用法"><a href="#7-1-基本用法" class="headerlink" title="7.1 基本用法"></a>7.1 基本用法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(url);</span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error:&#x27;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-与-Promise-的关系"><a href="#7-2-与-Promise-的关系" class="headerlink" title="7.2 与 Promise 的关系"></a>7.2 与 Promise 的关系</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Promise 方式</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fetchData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(url)</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>())</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(error));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// async/await 方式</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(url);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-实际应用场景"><a href="#8-实际应用场景" class="headerlink" title="8. 实际应用场景"></a>8. 实际应用场景</h2><h3 id="8-1-API-请求"><a href="#8-1-API-请求" class="headerlink" title="8.1 API 请求"></a>8.1 API 请求</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">fetchUserData</span>(<span class="params">userId</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">`/api/users/<span class="subst">$&#123;userId&#125;</span>`</span>)</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!response.<span class="property">ok</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Network response was not ok&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> response.<span class="title function_">json</span>();</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error fetching user:&#x27;</span>, error);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-2-并行请求"><a href="#8-2-并行请求" class="headerlink" title="8.2 并行请求"></a>8.2 并行请求</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchAllData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> [users, posts, comments] = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">            <span class="title function_">fetchUsers</span>(),</span><br><span class="line">            <span class="title function_">fetchPosts</span>(),</span><br><span class="line">            <span class="title function_">fetchComments</span>()</span><br><span class="line">        ]);</span><br><span class="line">        <span class="keyword">return</span> &#123; users, posts, comments &#125;;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error fetching data:&#x27;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-3-串行请求"><a href="#8-3-串行请求" class="headerlink" title="8.3 串行请求"></a>8.3 串行请求</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchUserAndPosts</span>(<span class="params">userId</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="title function_">fetchUser</span>(userId);</span><br><span class="line">        <span class="keyword">const</span> posts = <span class="keyword">await</span> <span class="title function_">fetchUserPosts</span>(user.<span class="property">id</span>);</span><br><span class="line">        <span class="keyword">return</span> &#123; user, posts &#125;;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error:&#x27;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="9-最佳实践"><a href="#9-最佳实践" class="headerlink" title="9. 最佳实践"></a>9. 最佳实践</h2><h3 id="9-1-错误处理"><a href="#9-1-错误处理" class="headerlink" title="9.1 错误处理"></a>9.1 错误处理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">handleAsyncOperation</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">asyncOperation</span>();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="comment">// 记录错误</span></span><br><span class="line">        <span class="title function_">logError</span>(error);</span><br><span class="line">        <span class="comment">// 返回默认值或重新抛出</span></span><br><span class="line">        <span class="keyword">throw</span> error;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 清理工作</span></span><br><span class="line">        <span class="title function_">cleanup</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9-2-Promise-超时处理"><a href="#9-2-Promise-超时处理" class="headerlink" title="9.2 Promise 超时处理"></a>9.2 Promise 超时处理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">timeoutPromise</span>(<span class="params">promise, timeout</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">race</span>([</span><br><span class="line">        promise,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">_, reject</span>) =&gt;</span></span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Timeout&#x27;</span>)), timeout)</span><br><span class="line">        )</span><br><span class="line">    ]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9-3-取消操作"><a href="#9-3-取消操作" class="headerlink" title="9.3 取消操作"></a>9.3 取消操作</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createCancellablePromise</span>(<span class="params">promise</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> isCancelled = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> wrappedPromise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        promise.<span class="title function_">then</span>(</span><br><span class="line">            <span class="function"><span class="params">value</span> =&gt;</span> isCancelled ? <span class="title function_">reject</span>(<span class="string">&#x27;Cancelled&#x27;</span>) : <span class="title function_">resolve</span>(value),</span><br><span class="line">            <span class="function"><span class="params">error</span> =&gt;</span> isCancelled ? <span class="title function_">reject</span>(<span class="string">&#x27;Cancelled&#x27;</span>) : <span class="title function_">reject</span>(error)</span><br><span class="line">        );</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">promise</span>: wrappedPromise,</span><br><span class="line">        <span class="attr">cancel</span>: <span class="function">() =&gt;</span> &#123; isCancelled = <span class="literal">true</span>; &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="10-常见问题和陷阱"><a href="#10-常见问题和陷阱" class="headerlink" title="10. 常见问题和陷阱"></a>10. 常见问题和陷阱</h2><h3 id="10-1-Promise-执行顺序"><a href="#10-1-Promise-执行顺序" class="headerlink" title="10.1 Promise 执行顺序"></a>10.1 Promise 执行顺序</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误理解：认为 Promise 中的所有操作都是异步的</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2&#x27;</span>));</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;3&#x27;</span>), <span class="number">0</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;4&#x27;</span>);</span><br><span class="line"><span class="comment">// 输出: 1, 4, 2, 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ⚠️ 特别注意：Promise 中的同步和异步操作</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;开始&#x27;</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;同步代码1&#x27;</span>); <span class="comment">// Promise 构造函数中的代码是同步执行的</span></span><br><span class="line">    <span class="title function_">resolve</span>(<span class="string">&#x27;同步代码2&#x27;</span>);     <span class="comment">// resolve/reject 是同步执行的</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;同步代码3&#x27;</span>); <span class="comment">// 这行也会同步执行</span></span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;异步微任务1&#x27;</span>); <span class="comment">// then 回调是异步微任务</span></span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;异步微任务2&#x27;</span>); <span class="comment">// 链式调用的 then 也是异步微任务</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;结束&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出顺序：</span></span><br><span class="line"><span class="comment">// 开始</span></span><br><span class="line"><span class="comment">// 同步代码1</span></span><br><span class="line"><span class="comment">// 同步代码2</span></span><br><span class="line"><span class="comment">// 同步代码3</span></span><br><span class="line"><span class="comment">// 结束</span></span><br><span class="line"><span class="comment">// 异步微任务1</span></span><br><span class="line"><span class="comment">// 异步微任务2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 更复杂的执行顺序示例</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;script start&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;setTimeout&#x27;</span>); <span class="comment">// 宏任务</span></span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;Promise 1&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(msg); <span class="comment">// 微任务</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Promise 2&#x27;</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(msg); <span class="comment">// 微任务</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;Promise 3&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(msg); <span class="comment">// 微任务</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;script end&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出顺序：</span></span><br><span class="line"><span class="comment">// script start</span></span><br><span class="line"><span class="comment">// script end</span></span><br><span class="line"><span class="comment">// Promise 1</span></span><br><span class="line"><span class="comment">// Promise 3</span></span><br><span class="line"><span class="comment">// Promise 2</span></span><br><span class="line"><span class="comment">// setTimeout</span></span><br></pre></td></tr></table></figure>

<h3 id="10-1-1-Promise-中的同步和异步操作"><a href="#10-1-1-Promise-中的同步和异步操作" class="headerlink" title="10.1.1 Promise 中的同步和异步操作"></a>10.1.1 Promise 中的同步和异步操作</h3><ol>
<li><p><strong>同步执行的部分</strong>：</p>
<ul>
<li>Promise 构造函数中的代码</li>
<li>resolve() 或 reject() 的调用</li>
<li>直接在 Promise 中的代码</li>
</ul>
</li>
<li><p><strong>异步微任务</strong>：</p>
<ul>
<li>.then() 的回调</li>
<li>.catch() 的回调</li>
<li>.finally() 的回调</li>
</ul>
</li>
<li><p><strong>执行顺序规则</strong>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 示例：混合同步和异步操作</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1 - 同步&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2 - 同步&#x27;</span>);</span><br><span class="line">    <span class="title function_">resolve</span>(<span class="string">&#x27;3 - 同步&#x27;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;4 - 同步&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;5 - 异步微任务&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;6 - 同步&#x27;</span>);</span><br><span class="line">        <span class="title function_">resolve</span>(<span class="string">&#x27;7 - 同步&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;8 - 异步微任务&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;9 - 异步宏任务&#x27;</span>);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;10 - 同步&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出顺序：</span></span><br><span class="line"><span class="comment">// 1 - 同步</span></span><br><span class="line"><span class="comment">// 2 - 同步</span></span><br><span class="line"><span class="comment">// 4 - 同步</span></span><br><span class="line"><span class="comment">// 10 - 同步</span></span><br><span class="line"><span class="comment">// 5 - 异步微任务</span></span><br><span class="line"><span class="comment">// 6 - 同步</span></span><br><span class="line"><span class="comment">// 8 - 异步微任务</span></span><br><span class="line"><span class="comment">// 9 - 异步宏任务</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>注意事项</strong>：</p>
<ul>
<li>Promise 构造函数是同步执行的</li>
<li>resolve&#x2F;reject 的调用是同步的，但其触发的 then&#x2F;catch 是异步的</li>
<li>微任务优先于宏任务执行</li>
<li>同一轮事件循环中的微任务会在下一个宏任务之前执行完</li>
</ul>
</li>
<li><p><strong>实际应用示例</strong>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">example</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1 - 同步&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2 - 同步&#x27;</span>);</span><br><span class="line">        <span class="title function_">resolve</span>(<span class="string">&#x27;3 - 同步&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;4 - 同步&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">await</span> p; <span class="comment">// await 后面的代码会被转换成 then 的回调（微任务）</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;5 - 异步&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">example</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;6 - 同步&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出顺序：</span></span><br><span class="line"><span class="comment">// 1 - 同步</span></span><br><span class="line"><span class="comment">// 2 - 同步</span></span><br><span class="line"><span class="comment">// 4 - 同步</span></span><br><span class="line"><span class="comment">// 6 - 同步</span></span><br><span class="line"><span class="comment">// 5 - 异步</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="10-2-Promise-错误处理"><a href="#10-2-Promise-错误处理" class="headerlink" title="10.2 Promise 错误处理"></a>10.2 Promise 错误处理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误示例</span></span><br><span class="line">promise.<span class="title function_">then</span>(success).<span class="title function_">catch</span>(error).<span class="title function_">then</span>(next);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确示例</span></span><br><span class="line">promise</span><br><span class="line">    .<span class="title function_">then</span>(success)</span><br><span class="line">    .<span class="title function_">then</span>(next)</span><br><span class="line">    .<span class="title function_">catch</span>(error);</span><br></pre></td></tr></table></figure>

<h3 id="10-3-内存泄漏"><a href="#10-3-内存泄漏" class="headerlink" title="10.3 内存泄漏"></a>10.3 内存泄漏</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 避免这样</span></span><br><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 永远不会 resolve 或 reject</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 建议这样</span></span><br><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 添加超时处理</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Timeout&#x27;</span>)), <span class="number">5000</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="10-4-Promise-嵌套"><a href="#10-4-Promise-嵌套" class="headerlink" title="10.4 Promise 嵌套"></a>10.4 Promise 嵌套</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 避免嵌套</span></span><br><span class="line"><span class="title function_">fetchUser</span>().<span class="title function_">then</span>(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">fetchPosts</span>(user.<span class="property">id</span>).<span class="title function_">then</span>(<span class="function"><span class="params">posts</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">fetchComments</span>(posts[<span class="number">0</span>].<span class="property">id</span>).<span class="title function_">then</span>(<span class="function"><span class="params">comments</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 处理数据</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用链式调用</span></span><br><span class="line"><span class="title function_">fetchUser</span>()</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">user</span> =&gt;</span> <span class="title function_">fetchPosts</span>(user.<span class="property">id</span>))</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">posts</span> =&gt;</span> <span class="title function_">fetchComments</span>(posts[<span class="number">0</span>].<span class="property">id</span>))</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">comments</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 处理数据</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="10-5-常见易错点和特别提示"><a href="#10-5-常见易错点和特别提示" class="headerlink" title="10.5 常见易错点和特别提示"></a>10.5 常见易错点和特别提示</h3><h4 id="1-Promise-构造函数中的代码立即执行"><a href="#1-Promise-构造函数中的代码立即执行" class="headerlink" title="1. Promise 构造函数中的代码立即执行"></a>1. Promise 构造函数中的代码立即执行</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误理解：认为 Promise 中的代码是异步执行</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;开始&#x27;</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Promise 内部&#x27;</span>);</span><br><span class="line">    <span class="title function_">resolve</span>(<span class="string">&#x27;完成&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;结束&#x27;</span>);</span><br><span class="line"><span class="comment">// 实际输出：</span></span><br><span class="line"><span class="comment">// 开始</span></span><br><span class="line"><span class="comment">// Promise 内部</span></span><br><span class="line"><span class="comment">// 结束</span></span><br></pre></td></tr></table></figure>

<h4 id="2-resolve-reject-后的代码仍会执行"><a href="#2-resolve-reject-后的代码仍会执行" class="headerlink" title="2. resolve&#x2F;reject 后的代码仍会执行"></a>2. resolve&#x2F;reject 后的代码仍会执行</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误示例</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">resolve</span>(<span class="string">&#x27;完成&#x27;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;这里仍会执行&#x27;</span>); <span class="comment">// 这行代码会执行</span></span><br><span class="line">    <span class="keyword">return</span>; <span class="comment">// 显式返回也无法阻止后续代码执行</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确做法</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (condition) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">resolve</span>(<span class="string">&#x27;完成&#x27;</span>); <span class="comment">// 使用 return 来确保后续代码不执行</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 其他代码</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="3-then-catch-返回值的问题"><a href="#3-then-catch-返回值的问题" class="headerlink" title="3. then&#x2F;catch 返回值的问题"></a>3. then&#x2F;catch 返回值的问题</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3.1 错误恢复模式</span></span><br><span class="line"><span class="comment">// ❌ 错误理解：认为错误一旦发生，后续的 then 都不会执行</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">reject</span>(<span class="string">&quot;initial error&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;不会执行&quot;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;捕获错误:&quot;</span>, error);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;recovered&quot;</span>;  <span class="comment">// 返回普通值，Promise 变为 fulfilled 状态</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;会执行，值为:&quot;</span>, result); <span class="comment">// 会执行，因为上一个 then 返回了正常值</span></span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;不会执行，因为错误已经被处理&quot;</span>); <span class="comment">// 不会执行</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.2 错误传播模式</span></span><br><span class="line"><span class="comment">// ❌ 错误理解：认为使用了 catch 就一定能捕获所有错误</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">reject</span>(<span class="string">&quot;error1&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;不会执行&quot;</span>),</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;捕获 error1&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="string">&quot;error2&quot;</span>;  <span class="comment">// 抛出新错误，Promise 变为 rejected 状态</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">.<span class="title function_">then</span>(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;不会执行&quot;</span>),</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;捕获 error2&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="string">&quot;error3&quot;</span>);  <span class="comment">// 返回 rejected promise</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">.<span class="title function_">then</span>(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;不会执行&quot;</span>),</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;捕获 error3&quot;</span>);</span><br><span class="line">        <span class="comment">// 没有返回值，默认返回 undefined，Promise 变为 fulfilled 状态</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">.<span class="title function_">then</span>(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;会执行&quot;</span>),</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;不会执行&quot;</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.3 Promise 状态转换规则</span></span><br><span class="line"><span class="comment">// ✅ 正确理解：Promise 状态转换取决于返回值</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">reject</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 情况1：返回普通值（包括 undefined）</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;normal&quot;</span>;  <span class="comment">// Promise 变为 fulfilled 状态</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 情况2：抛出错误</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>();  <span class="comment">// Promise 变为 rejected 状态</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 情况3：返回 resolved 的 Promise</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&quot;ok&quot;</span>);  <span class="comment">// Promise 变为 fulfilled 状态</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 情况4：返回 rejected 的 Promise</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="string">&quot;fail&quot;</span>);  <span class="comment">// Promise 变为 rejected 状态</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 情况5：不返回任何值</span></span><br><span class="line">        <span class="comment">// 默认返回 undefined，Promise 变为 fulfilled 状态</span></span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.4 错误处理最佳实践</span></span><br><span class="line"><span class="comment">// ✅ 推荐做法：根据错误类型决定是恢复还是继续传播</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">handleError</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">riskyOperation</span>();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="keyword">if</span> (error.<span class="property">isRecoverable</span>) &#123;</span><br><span class="line">            <span class="comment">// 可恢复错误，返回默认值</span></span><br><span class="line">            <span class="keyword">return</span> defaultValue;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 不可恢复错误，继续传播</span></span><br><span class="line">            <span class="keyword">throw</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.5 注意事项总结：</span></span><br><span class="line"><span class="comment">// 1. then 的第二个参数（错误处理函数）只处理当前 Promise 的错误</span></span><br><span class="line"><span class="comment">// 2. 错误处理函数的返回值决定了下一个 Promise 的状态</span></span><br><span class="line"><span class="comment">// 3. 返回普通值会将 Promise 转为 fulfilled 状态</span></span><br><span class="line"><span class="comment">// 4. 抛出错误或返回 rejected Promise 会将 Promise 转为 rejected 状态</span></span><br><span class="line"><span class="comment">// 5. 不返回值默认返回 undefined，Promise 变为 fulfilled 状态</span></span><br></pre></td></tr></table></figure>

<h4 id="4-Promise-all-的错误处理"><a href="#4-Promise-all-的错误处理" class="headerlink" title="4. Promise.all 的错误处理"></a>4. Promise.all 的错误处理</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误用法：未考虑部分 Promise 失败的情况</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">all</span>([promise1, promise2, promise3])</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">results</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 如果任何一个 Promise 失败，这里都不会执行</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确做法：为每个 Promise 添加错误处理</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">    promise1.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> (&#123; <span class="attr">error</span>: err &#125;)),</span><br><span class="line">    promise2.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> (&#123; <span class="attr">error</span>: err &#125;)),</span><br><span class="line">    promise3.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> (&#123; <span class="attr">error</span>: err &#125;))</span><br><span class="line">])</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">results</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 即使部分 Promise 失败，这里也会执行</span></span><br><span class="line">    results.<span class="title function_">forEach</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (result.<span class="property">error</span>) &#123;</span><br><span class="line">            <span class="comment">// 处理错误情况</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="5-async-await-常见错误"><a href="#5-async-await-常见错误" class="headerlink" title="5. async&#x2F;await 常见错误"></a>5. async&#x2F;await 常见错误</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误：在普通函数中使用 await</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">fetchData</span>(); <span class="comment">// 语法错误</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ❌ 错误：忘记错误处理</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">fetchData</span>(); <span class="comment">// 如果出错，将导致未捕获的异常</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确做法</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">fetchData</span>();</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error:&#x27;</span>, error);</span><br><span class="line">        <span class="comment">// 处理错误</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-特别提示"><a href="#6-特别提示" class="headerlink" title="6. 特别提示"></a>6. 特别提示</h4><ol>
<li><p><strong>Promise 状态变化</strong></p>
<ul>
<li>Promise 状态一旦改变就不可逆</li>
<li>只有 pending 状态可以变为 fulfilled 或 rejected</li>
<li>状态变化后的值不可变</li>
</ul>
</li>
<li><p><strong>链式调用注意事项</strong></p>
<ul>
<li>每个 then&#x2F;catch 都返回新的 Promise</li>
<li>返回值会被自动包装成 Promise</li>
<li>没有显式返回值时，默认返回 undefined</li>
</ul>
</li>
<li><p><strong>错误处理最佳实践</strong></p>
<ul>
<li>总是在 Promise 链的末尾添加 catch</li>
<li>在适当的位置使用 finally 进行清理</li>
<li>避免在 Promise 链中静默失败</li>
</ul>
</li>
<li><p><strong>async&#x2F;await 使用建议</strong></p>
<ul>
<li>总是使用 try&#x2F;catch 包裹 await</li>
<li>注意 await 的位置，避免不必要的等待</li>
<li>并行操作使用 Promise.all</li>
</ul>
</li>
<li><p><strong>性能考虑</strong></p>
<ul>
<li>避免创建不必要的 Promise</li>
<li>注意内存泄漏（未处理的 Promise）</li>
<li>合理使用 Promise.all 进行并行处理</li>
</ul>
</li>
</ol>
<h3 id="10-6-高级注意事项和陷阱"><a href="#10-6-高级注意事项和陷阱" class="headerlink" title="10.6 高级注意事项和陷阱"></a>10.6 高级注意事项和陷阱</h3><h4 id="1-Promise-resolve-reject-的特殊行为"><a href="#1-Promise-resolve-reject-的特殊行为" class="headerlink" title="1. Promise.resolve&#x2F;reject 的特殊行为"></a>1. Promise.resolve&#x2F;reject 的特殊行为</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误理解：认为 Promise.resolve 总是同步执行</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="number">1</span>))  <span class="comment">// Promise 嵌套的情况</span></span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(value));  <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ⚠️ 特别注意：传入 thenable 对象</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>(&#123;</span><br><span class="line">    <span class="attr">then</span>: <span class="keyword">function</span>(<span class="params">resolve</span>) &#123;</span><br><span class="line">        <span class="title function_">resolve</span>(<span class="number">42</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(value));  <span class="comment">// 42</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意：Promise.resolve 会展平 Promise</span></span><br><span class="line"><span class="keyword">const</span> p1 = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">const</span> p2 = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(p1); <span class="comment">// p2 和 p1 是同一个 Promise</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(p1 === p2); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<h4 id="2-Promise-的并发控制"><a href="#2-Promise-的并发控制" class="headerlink" title="2. Promise 的并发控制"></a>2. Promise 的并发控制</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误做法：无控制地并发请求</span></span><br><span class="line">urls.<span class="title function_">map</span>(<span class="function"><span class="params">url</span> =&gt;</span> <span class="title function_">fetch</span>(url));  <span class="comment">// 可能导致服务器压力过大</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确做法：控制并发数量</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchWithConcurrency</span>(<span class="params">urls, concurrency = <span class="number">3</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> results = [];</span><br><span class="line">    <span class="keyword">const</span> executing = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> url <span class="keyword">of</span> urls) &#123;</span><br><span class="line">        <span class="keyword">const</span> promise = <span class="title function_">fetch</span>(url).<span class="title function_">then</span>(<span class="function"><span class="params">r</span> =&gt;</span> r.<span class="title function_">json</span>());</span><br><span class="line">        results.<span class="title function_">push</span>(promise);</span><br><span class="line">        </span><br><span class="line">        executing.<span class="title function_">add</span>(promise);</span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">clean</span> = (<span class="params"></span>) =&gt; executing.<span class="title function_">delete</span>(promise);</span><br><span class="line">        promise.<span class="title function_">then</span>(clean, clean);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (executing.<span class="property">size</span> &gt;= concurrency) &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">race</span>(executing);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(results);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> urls = [<span class="string">&#x27;url1&#x27;</span>, <span class="string">&#x27;url2&#x27;</span>, <span class="string">&#x27;url3&#x27;</span>, <span class="string">&#x27;url4&#x27;</span>, <span class="string">&#x27;url5&#x27;</span>];</span><br><span class="line"><span class="title function_">fetchWithConcurrency</span>(urls, <span class="number">2</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">results</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;所有请求完成&#x27;</span>));</span><br></pre></td></tr></table></figure>

<h4 id="3-循环中的-Promise-处理"><a href="#3-循环中的-Promise-处理" class="headerlink" title="3. 循环中的 Promise 处理"></a>3. 循环中的 Promise 处理</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误做法：在循环中使用 await</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">wrong</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> urls = [<span class="string">&#x27;url1&#x27;</span>, <span class="string">&#x27;url2&#x27;</span>, <span class="string">&#x27;url3&#x27;</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> url <span class="keyword">of</span> urls) &#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">fetch</span>(url);  <span class="comment">// 串行执行，效率低</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确做法：并行执行</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">right</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> urls = [<span class="string">&#x27;url1&#x27;</span>, <span class="string">&#x27;url2&#x27;</span>, <span class="string">&#x27;url3&#x27;</span>];</span><br><span class="line">    <span class="keyword">const</span> promises = urls.<span class="title function_">map</span>(<span class="function"><span class="params">url</span> =&gt;</span> <span class="title function_">fetch</span>(url));</span><br><span class="line">    <span class="keyword">const</span> results = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(promises);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 需要按顺序执行时的正确做法</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">sequential</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> urls = [<span class="string">&#x27;url1&#x27;</span>, <span class="string">&#x27;url2&#x27;</span>, <span class="string">&#x27;url3&#x27;</span>];</span><br><span class="line">    <span class="keyword">const</span> results = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> url <span class="keyword">of</span> urls) &#123;</span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">fetch</span>(url);</span><br><span class="line">        results.<span class="title function_">push</span>(<span class="keyword">await</span> result.<span class="title function_">json</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> results;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-Promise-竞态问题处理"><a href="#4-Promise-竞态问题处理" class="headerlink" title="4. Promise 竞态问题处理"></a>4. Promise 竞态问题处理</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 潜在问题：多个请求的响应顺序不确定</span></span><br><span class="line"><span class="keyword">let</span> currentData;</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchData</span>(<span class="params">id</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">`/api/<span class="subst">$&#123;id&#125;</span>`</span>);</span><br><span class="line">    currentData = <span class="keyword">await</span> response.<span class="title function_">json</span>();  <span class="comment">// 可能被后发先至的请求覆盖</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确做法：使用标记或取消机制</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createFetchWithAbort</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> currentController = <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchData</span>(<span class="params">id</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (currentController) &#123;</span><br><span class="line">            currentController.<span class="title function_">abort</span>();  <span class="comment">// 取消之前的请求</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        currentController = <span class="keyword">new</span> <span class="title class_">AbortController</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">`/api/<span class="subst">$&#123;id&#125;</span>`</span>, &#123;</span><br><span class="line">                <span class="attr">signal</span>: currentController.<span class="property">signal</span></span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="keyword">if</span> (error.<span class="property">name</span> === <span class="string">&#x27;AbortError&#x27;</span>) &#123;</span><br><span class="line">                <span class="comment">// 请求被取消，忽略错误</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> fetchWithAbort = <span class="title function_">createFetchWithAbort</span>();</span><br><span class="line"><span class="title function_">fetchWithAbort</span>(<span class="string">&#x27;id1&#x27;</span>);</span><br><span class="line"><span class="title function_">fetchWithAbort</span>(<span class="string">&#x27;id2&#x27;</span>); <span class="comment">// id1 的请求会被取消</span></span><br></pre></td></tr></table></figure>

<h4 id="5-async-await-与-Promise-混用的陷阱"><a href="#5-async-await-与-Promise-混用的陷阱" class="headerlink" title="5. async&#x2F;await 与 Promise 混用的陷阱"></a>5. async&#x2F;await 与 Promise 混用的陷阱</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误做法：混合使用可能导致错误处理混乱</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">mixed</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">somePromise</span>()</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> <span class="title function_">process</span>(data))  <span class="comment">// 这里的错误不会被 catch 捕获</span></span><br><span class="line">            .<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> <span class="title function_">handle</span>(err));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="comment">// 这里捕获不到 .then 中的错误</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确做法：统一使用 async/await</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">consistent</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">somePromise</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">process</span>(data);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">handle</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 如果必须混用，确保错误处理的完整性</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">mixedButSafe</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">somePromise</span>()</span><br><span class="line">            .<span class="title function_">then</span>(<span class="keyword">async</span> data =&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">process</span>(data);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> error; <span class="comment">// 确保错误能被外层 catch 捕获</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">handle</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-Promise-内存泄漏的其他情况"><a href="#6-Promise-内存泄漏的其他情况" class="headerlink" title="6. Promise 内存泄漏的其他情况"></a>6. Promise 内存泄漏的其他情况</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 潜在问题：事件监听器中的 Promise</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataLoader</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listener</span> = <span class="variable language_">this</span>.<span class="property">handleData</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">        eventEmitter.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="variable language_">this</span>.<span class="property">listener</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">handleData</span>(<span class="params">data</span>) &#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">processData</span>(data);  <span class="comment">// 如果组件被销毁，这个 Promise 可能永远挂着</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确做法：确保清理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataLoader</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">abortController</span> = <span class="keyword">new</span> <span class="title class_">AbortController</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listener</span> = <span class="variable language_">this</span>.<span class="property">handleData</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">        eventEmitter.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="variable language_">this</span>.<span class="property">listener</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">handleData</span>(<span class="params">data</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">abortController</span>.<span class="property">signal</span>.<span class="property">aborted</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">processData</span>(data);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">destroy</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">abortController</span>.<span class="title function_">abort</span>();</span><br><span class="line">        eventEmitter.<span class="title function_">off</span>(<span class="string">&#x27;data&#x27;</span>, <span class="variable language_">this</span>.<span class="property">listener</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 React 组件中的使用示例</span></span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> loader = <span class="keyword">new</span> <span class="title class_">DataLoader</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> loader.<span class="title function_">destroy</span>(); <span class="comment">// 清理函数</span></span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure>

<h4 id="7-特殊场景的注意事项"><a href="#7-特殊场景的注意事项" class="headerlink" title="7. 特殊场景的注意事项"></a>7. 特殊场景的注意事项</h4><ol>
<li><strong>Promise 链中的值传递</strong>：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误做法：没有正确传递值</span></span><br><span class="line">promise</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">process</span>(value);</span><br><span class="line">        <span class="comment">// 没有返回值，下一个 then 将收到 undefined</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// value 是 undefined</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确做法：确保正确传递值</span></span><br><span class="line">promise</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">process</span>(value);</span><br><span class="line">        <span class="keyword">return</span> value; <span class="comment">// 显式返回需要传递的值</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// value 是上一步返回的值</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>Promise 的错误恢复链</strong>：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 高级错误恢复模式</span></span><br><span class="line"><span class="title function_">fetchData</span>()</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (error.<span class="property">type</span> === <span class="string">&#x27;network&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">fetchFromCache</span>(); <span class="comment">// 尝试从缓存获取</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> error; <span class="comment">// 其他错误继续传播</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (error.<span class="property">type</span> === <span class="string">&#x27;cache&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">fetchFromBackup</span>(); <span class="comment">// 尝试从备份获取</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> error;</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> defaultValue; <span class="comment">// 最后的降级处理</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>条件 Promise 执行</strong>：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 根据条件决定是否执行 Promise</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">conditionalFetch</span>(<span class="params">condition</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!condition) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;/api/data&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Fetch failed:&#x27;</span>, error);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise">MDN Promise 文档</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://promisesaplus.com/">JavaScript Promise 规范</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://tc39.es/ecma262/#sec-promise-objects">ECMAScript Promise 规范</a></li>
</ul>
<h2 id="11-更多实际应用场景"><a href="#11-更多实际应用场景" class="headerlink" title="11. 更多实际应用场景"></a>11. 更多实际应用场景</h2><h3 id="11-1-文件上传与进度监控"><a href="#11-1-文件上传与进度监控" class="headerlink" title="11.1 文件上传与进度监控"></a>11.1 文件上传与进度监控</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">uploadFileWithProgress</span>(<span class="params">file, onProgress</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">        <span class="keyword">const</span> formData = <span class="keyword">new</span> <span class="title class_">FormData</span>();</span><br><span class="line">        formData.<span class="title function_">append</span>(<span class="string">&#x27;file&#x27;</span>, file);</span><br><span class="line"></span><br><span class="line">        xhr.<span class="property">upload</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;progress&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (event.<span class="property">lengthComputable</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> progress = (event.<span class="property">loaded</span> / event.<span class="property">total</span>) * <span class="number">100</span>;</span><br><span class="line">                <span class="title function_">onProgress</span>(progress);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        xhr.<span class="title function_">addEventListener</span>(<span class="string">&#x27;load&#x27;</span>, <span class="function">() =&gt;</span> <span class="title function_">resolve</span>(xhr.<span class="property">response</span>));</span><br><span class="line">        xhr.<span class="title function_">addEventListener</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">() =&gt;</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Upload failed&#x27;</span>)));</span><br><span class="line">        xhr.<span class="title function_">addEventListener</span>(<span class="string">&#x27;abort&#x27;</span>, <span class="function">() =&gt;</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Upload aborted&#x27;</span>)));</span><br><span class="line"></span><br><span class="line">        xhr.<span class="title function_">open</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/api/upload&#x27;</span>);</span><br><span class="line">        xhr.<span class="title function_">send</span>(formData);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> fileInput = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;input[type=&quot;file&quot;]&#x27;</span>);</span><br><span class="line">fileInput.<span class="title function_">addEventListener</span>(<span class="string">&#x27;change&#x27;</span>, <span class="title function_">async</span> (e) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> file = e.<span class="property">target</span>.<span class="property">files</span>[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">uploadFileWithProgress</span>(file, <span class="function">(<span class="params">progress</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Upload progress: <span class="subst">$&#123;progress&#125;</span>%`</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Upload complete&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Upload error:&#x27;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="11-2-带重试机制的API请求"><a href="#11-2-带重试机制的API请求" class="headerlink" title="11.2 带重试机制的API请求"></a>11.2 带重试机制的API请求</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchWithRetry</span>(<span class="params">url, options = &#123;&#125;, maxRetries = <span class="number">3</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">delay</span> = (<span class="params">ms</span>) =&gt; <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(resolve, ms));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; maxRetries; i++) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(url, options);</span><br><span class="line">            <span class="keyword">if</span> (!response.<span class="property">ok</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`HTTP error! status: <span class="subst">$&#123;response.status&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i === maxRetries - <span class="number">1</span>) <span class="keyword">throw</span> error;</span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">delay</span>(<span class="title class_">Math</span>.<span class="title function_">pow</span>(<span class="number">2</span>, i) * <span class="number">1000</span>); <span class="comment">// 指数退避</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Retrying... (<span class="subst">$&#123;i + <span class="number">1</span>&#125;</span>/<span class="subst">$&#123;maxRetries&#125;</span>)`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="title function_">fetchWithRetry</span>(<span class="string">&#x27;/api/data&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Success:&#x27;</span>, data))</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Final error:&#x27;</span>, error));</span><br></pre></td></tr></table></figure>

<h3 id="11-3-资源预加载"><a href="#11-3-资源预加载" class="headerlink" title="11.3 资源预加载"></a>11.3 资源预加载</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ResourcePreloader</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cache</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">preload</span>(<span class="params">url</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">has</span>(url)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">get</span>(url));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> promise = <span class="title function_">fetch</span>(url)</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>())</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">set</span>(url, data);</span><br><span class="line">                <span class="keyword">return</span> data;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">set</span>(url, promise);</span><br><span class="line">        <span class="keyword">return</span> promise;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">get</span>(<span class="params">url</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">get</span>(url) || <span class="variable language_">this</span>.<span class="title function_">preload</span>(url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> preloader = <span class="keyword">new</span> <span class="title class_">ResourcePreloader</span>();</span><br><span class="line"><span class="comment">// 预加载资源</span></span><br><span class="line">preloader.<span class="title function_">preload</span>(<span class="string">&#x27;/api/user/1&#x27;</span>);</span><br><span class="line">preloader.<span class="title function_">preload</span>(<span class="string">&#x27;/api/user/2&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 稍后使用</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">displayUser</span>(<span class="params">id</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> userData = <span class="keyword">await</span> preloader.<span class="title function_">get</span>(<span class="string">`/api/user/<span class="subst">$&#123;id&#125;</span>`</span>);</span><br><span class="line">    <span class="comment">// 使用预加载的数据</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="11-4-并发请求限制器"><a href="#11-4-并发请求限制器" class="headerlink" title="11.4 并发请求限制器"></a>11.4 并发请求限制器</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RequestLimiter</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">maxConcurrent = <span class="number">5</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">maxConcurrent</span> = maxConcurrent;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentRequests</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">queue</span> = [];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">add</span>(<span class="params">promiseFactory</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">currentRequests</span> &gt;= <span class="variable language_">this</span>.<span class="property">maxConcurrent</span>) &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="variable language_">this</span>.<span class="property">queue</span>.<span class="title function_">push</span>(resolve));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentRequests</span>++;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">promiseFactory</span>();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">currentRequests</span>--;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">queue</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> next = <span class="variable language_">this</span>.<span class="property">queue</span>.<span class="title function_">shift</span>();</span><br><span class="line">                <span class="title function_">next</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> limiter = <span class="keyword">new</span> <span class="title class_">RequestLimiter</span>(<span class="number">3</span>);</span><br><span class="line"><span class="keyword">const</span> urls = <span class="title class_">Array</span>.<span class="title function_">from</span>(&#123; <span class="attr">length</span>: <span class="number">10</span> &#125;, <span class="function">(<span class="params">_, i</span>) =&gt;</span> <span class="string">`/api/item/<span class="subst">$&#123;i&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">all</span>(</span><br><span class="line">    urls.<span class="title function_">map</span>(<span class="function"><span class="params">url</span> =&gt;</span> </span><br><span class="line">        limiter.<span class="title function_">add</span>(<span class="function">() =&gt;</span> <span class="title function_">fetch</span>(url).<span class="title function_">then</span>(<span class="function"><span class="params">r</span> =&gt;</span> r.<span class="title function_">json</span>()))</span><br><span class="line">    )</span><br><span class="line">).<span class="title function_">then</span>(<span class="function"><span class="params">results</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;All requests completed&#x27;</span>));</span><br></pre></td></tr></table></figure>

<h2 id="12-详细错误处理指南"><a href="#12-详细错误处理指南" class="headerlink" title="12. 详细错误处理指南"></a>12. 详细错误处理指南</h2><h3 id="12-1-错误类型分类"><a href="#12-1-错误类型分类" class="headerlink" title="12.1 错误类型分类"></a>12.1 错误类型分类</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">NetworkError</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Error</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(message);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">name</span> = <span class="string">&#x27;NetworkError&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ValidationError</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Error</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(message);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">name</span> = <span class="string">&#x27;ValidationError&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TimeoutError</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Error</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(message);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">name</span> = <span class="string">&#x27;TimeoutError&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchWithErrorHandling</span>(<span class="params">url</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(url);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!response.<span class="property">ok</span>) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (response.<span class="property">status</span>) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">404</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ValidationError</span>(<span class="string">&#x27;Resource not found&#x27;</span>);</span><br><span class="line">                <span class="keyword">case</span> <span class="number">401</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ValidationError</span>(<span class="string">&#x27;Unauthorized&#x27;</span>);</span><br><span class="line">                <span class="keyword">case</span> <span class="number">503</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NetworkError</span>(<span class="string">&#x27;Service unavailable&#x27;</span>);</span><br><span class="line">                <span class="attr">default</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`HTTP error! status: <span class="subst">$&#123;response.status&#125;</span>`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="keyword">if</span> (error <span class="keyword">instanceof</span> <span class="title class_">ValidationError</span>) &#123;</span><br><span class="line">            <span class="comment">// 处理验证错误</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Validation error:&#x27;</span>, error.<span class="property">message</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error <span class="keyword">instanceof</span> <span class="title class_">NetworkError</span>) &#123;</span><br><span class="line">            <span class="comment">// 处理网络错误</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Network error:&#x27;</span>, error.<span class="property">message</span>);</span><br><span class="line">            <span class="keyword">throw</span> error; <span class="comment">// 重新抛出网络错误</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 处理其他错误</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Unexpected error:&#x27;</span>, error);</span><br><span class="line">            <span class="keyword">throw</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="12-2-全局错误处理"><a href="#12-2-全局错误处理" class="headerlink" title="12.2 全局错误处理"></a>12.2 全局错误处理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ErrorHandler</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">handle</span>(<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (error <span class="keyword">instanceof</span> <span class="title class_">ValidationError</span>) &#123;</span><br><span class="line">            <span class="comment">// 处理验证错误</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">handleValidationError</span>(error);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error <span class="keyword">instanceof</span> <span class="title class_">NetworkError</span>) &#123;</span><br><span class="line">            <span class="comment">// 处理网络错误</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">handleNetworkError</span>(error);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error <span class="keyword">instanceof</span> <span class="title class_">TimeoutError</span>) &#123;</span><br><span class="line">            <span class="comment">// 处理超时错误</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">handleTimeoutError</span>(error);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 处理未知错误</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">handleUnknownError</span>(error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">handleValidationError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Validation Error:&#x27;</span>, error.<span class="property">message</span>);</span><br><span class="line">        <span class="comment">// 显示用户友好的错误消息</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">handleNetworkError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Network Error:&#x27;</span>, error.<span class="property">message</span>);</span><br><span class="line">        <span class="comment">// 尝试重新连接</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">handleTimeoutError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Timeout Error:&#x27;</span>, error.<span class="property">message</span>);</span><br><span class="line">        <span class="comment">// 提示用户重试</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">handleUnknownError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Unknown Error:&#x27;</span>, error);</span><br><span class="line">        <span class="comment">// 记录错误并通知开发团队</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;unhandledrejection&#x27;</span>, <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">ErrorHandler</span>.<span class="title function_">handle</span>(event.<span class="property">reason</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="13-性能优化最佳实践"><a href="#13-性能优化最佳实践" class="headerlink" title="13. 性能优化最佳实践"></a>13. 性能优化最佳实践</h2><h3 id="13-1-Promise-批处理"><a href="#13-1-Promise-批处理" class="headerlink" title="13.1 Promise 批处理"></a>13.1 Promise 批处理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PromiseBatcher</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">batchSize = <span class="number">100</span>, interval = <span class="number">50</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">batchSize</span> = batchSize;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">interval</span> = interval;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">queue</span> = [];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">pending</span> = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">add</span>(<span class="params">item</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">queue</span>.<span class="title function_">push</span>(&#123; item, resolve, reject &#125;);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">process</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">process</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">pending</span> || <span class="variable language_">this</span>.<span class="property">queue</span>.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">pending</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(resolve, <span class="variable language_">this</span>.<span class="property">interval</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> batch = <span class="variable language_">this</span>.<span class="property">queue</span>.<span class="title function_">splice</span>(<span class="number">0</span>, <span class="variable language_">this</span>.<span class="property">batchSize</span>);</span><br><span class="line">        <span class="keyword">const</span> items = batch.<span class="title function_">map</span>(<span class="function">(<span class="params">&#123; item &#125;</span>) =&gt;</span> item);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> results = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">processBatch</span>(items);</span><br><span class="line">            batch.<span class="title function_">forEach</span>(<span class="function">(<span class="params">&#123; resolve &#125;, index</span>) =&gt;</span> <span class="title function_">resolve</span>(results[index]));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            batch.<span class="title function_">forEach</span>(<span class="function">(<span class="params">&#123; reject &#125;</span>) =&gt;</span> <span class="title function_">reject</span>(error));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">pending</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">queue</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">process</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">processBatch</span>(<span class="params">items</span>) &#123;</span><br><span class="line">        <span class="comment">// 实现批处理逻辑</span></span><br><span class="line">        <span class="keyword">return</span> items.<span class="title function_">map</span>(<span class="function"><span class="params">item</span> =&gt;</span> <span class="string">`Processed <span class="subst">$&#123;item&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> batcher = <span class="keyword">new</span> <span class="title class_">PromiseBatcher</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">    batcher.<span class="title function_">add</span>(i).<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(result));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="13-2-Promise-缓存优化"><a href="#13-2-Promise-缓存优化" class="headerlink" title="13.2 Promise 缓存优化"></a>13.2 Promise 缓存优化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PromiseCache</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">ttl = <span class="number">60000</span></span>) &#123; <span class="comment">// 默认缓存时间 1 分钟</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cache</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ttl</span> = ttl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">get</span>(<span class="params">key, promiseFactory</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> cached = <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">get</span>(key);</span><br><span class="line">        <span class="keyword">if</span> (cached &amp;&amp; <span class="title class_">Date</span>.<span class="title function_">now</span>() - cached.<span class="property">timestamp</span> &lt; <span class="variable language_">this</span>.<span class="property">ttl</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> cached.<span class="property">data</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">promiseFactory</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">set</span>(key, &#123;</span><br><span class="line">            data,</span><br><span class="line">            <span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">invalidate</span>(<span class="params">key</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">delete</span>(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">clear</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">clear</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> cache = <span class="keyword">new</span> <span class="title class_">PromiseCache</span>();</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchUserWithCache</span>(<span class="params">userId</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cache.<span class="title function_">get</span>(</span><br><span class="line">        <span class="string">`user_<span class="subst">$&#123;userId&#125;</span>`</span>,</span><br><span class="line">        <span class="function">() =&gt;</span> <span class="title function_">fetch</span>(<span class="string">`/api/users/<span class="subst">$&#123;userId&#125;</span>`</span>).<span class="title function_">then</span>(<span class="function"><span class="params">r</span> =&gt;</span> r.<span class="title function_">json</span>())</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="13-3-内存优化"><a href="#13-3-内存优化" class="headerlink" title="13.3 内存优化"></a>13.3 内存优化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MemoryEfficientPromise</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">async</span> <span class="title function_">batch</span>(<span class="params">items, processor, batchSize = <span class="number">100</span></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> results = [];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; items.<span class="property">length</span>; i += batchSize) &#123;</span><br><span class="line">            <span class="keyword">const</span> batch = items.<span class="title function_">slice</span>(i, i + batchSize);</span><br><span class="line">            <span class="keyword">const</span> batchResults = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(</span><br><span class="line">                batch.<span class="title function_">map</span>(processor)</span><br><span class="line">            );</span><br><span class="line">            results.<span class="title function_">push</span>(...batchResults);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 允许垃圾回收</span></span><br><span class="line">            <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(resolve, <span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> results;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">async</span> <span class="title function_">stream</span>(<span class="params">asyncIterable, processor</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> results = [];</span><br><span class="line">        <span class="keyword">for</span> <span class="title function_">await</span> (<span class="keyword">const</span> item <span class="keyword">of</span> asyncIterable) &#123;</span><br><span class="line">            results.<span class="title function_">push</span>(<span class="keyword">await</span> <span class="title function_">processor</span>(item));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 定期清理</span></span><br><span class="line">            <span class="keyword">if</span> (results.<span class="property">length</span> % <span class="number">1000</span> === <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(resolve, <span class="number">0</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> results;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> items = <span class="title class_">Array</span>.<span class="title function_">from</span>(&#123; <span class="attr">length</span>: <span class="number">10000</span> &#125;, <span class="function">(<span class="params">_, i</span>) =&gt;</span> i);</span><br><span class="line"><span class="title class_">MemoryEfficientPromise</span>.<span class="title function_">batch</span>(items, <span class="title function_">async</span> (item) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 处理每个项目</span></span><br><span class="line">    <span class="keyword">return</span> item * <span class="number">2</span>;</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">results</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Processed items:&#x27;</span>, results.<span class="property">length</span>));</span><br></pre></td></tr></table></figure>

<h2 id="14-补充最佳实践建议"><a href="#14-补充最佳实践建议" class="headerlink" title="14. 补充最佳实践建议"></a>14. 补充最佳实践建议</h2><h3 id="14-1-Promise-链优化"><a href="#14-1-Promise-链优化" class="headerlink" title="14.1 Promise 链优化"></a>14.1 Promise 链优化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 优化 Promise 链</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">optimizedChain</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 并行执行无依赖的 Promise</span></span><br><span class="line">        <span class="keyword">const</span> [data1, data2] = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">            <span class="title function_">fetchData1</span>(),</span><br><span class="line">            <span class="title function_">fetchData2</span>()</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 串行执行有依赖的 Promise</span></span><br><span class="line">        <span class="keyword">const</span> result1 = <span class="keyword">await</span> <span class="title function_">processData</span>(data1);</span><br><span class="line">        <span class="keyword">const</span> result2 = <span class="keyword">await</span> <span class="title function_">processData</span>(data2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 条件执行</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">needsExtra</span>(result1)) &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">extraProcessing</span>(result1);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [result1, result2];</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="comment">// 统一错误处理</span></span><br><span class="line">        <span class="title class_">ErrorHandler</span>.<span class="title function_">handle</span>(error);</span><br><span class="line">        <span class="keyword">throw</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="14-2-资源管理"><a href="#14-2-资源管理" class="headerlink" title="14.2 资源管理"></a>14.2 资源管理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ResourceManager</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">resources</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">locks</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">acquire</span>(<span class="params">key</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">locks</span>.<span class="title function_">has</span>(key)) &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">locks</span>.<span class="title function_">get</span>(key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> lock = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">locks</span>.<span class="title function_">set</span>(key, resolve);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">resources</span>.<span class="title function_">has</span>(key)) &#123;</span><br><span class="line">                <span class="keyword">const</span> resource = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">createResource</span>(key);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">resources</span>.<span class="title function_">set</span>(key, resource);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">resources</span>.<span class="title function_">get</span>(key);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">locks</span>.<span class="title function_">delete</span>(key);</span><br><span class="line">            lock.<span class="title function_">resolve</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">release</span>(<span class="params">key</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">resources</span>.<span class="title function_">has</span>(key)) &#123;</span><br><span class="line">            <span class="keyword">const</span> resource = <span class="variable language_">this</span>.<span class="property">resources</span>.<span class="title function_">get</span>(key);</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">cleanupResource</span>(resource);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">resources</span>.<span class="title function_">delete</span>(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">createResource</span>(<span class="params">key</span>) &#123;</span><br><span class="line">        <span class="comment">// 实现资源创建逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">cleanupResource</span>(<span class="params">resource</span>) &#123;</span><br><span class="line">        <span class="comment">// 实现资源清理逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="14-3-监控和日志"><a href="#14-3-监控和日志" class="headerlink" title="14.3 监控和日志"></a>14.3 监控和日志</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PromiseMonitor</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">metrics</span> = &#123;</span><br><span class="line">            <span class="attr">total</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">success</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">failure</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">timing</span>: []</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">track</span>(<span class="params">promise, metadata = &#123;&#125;</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> startTime = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">total</span>++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> result = <span class="keyword">await</span> promise;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">success</span>++;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">recordTiming</span>(startTime, metadata);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">failure</span>++;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">recordError</span>(error, metadata);</span><br><span class="line">            <span class="keyword">throw</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">recordTiming</span>(<span class="params">startTime, metadata</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> duration = <span class="title class_">Date</span>.<span class="title function_">now</span>() - startTime;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">timing</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">            duration,</span><br><span class="line">            ...metadata,</span><br><span class="line">            <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">recordError</span>(<span class="params">error, metadata</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Promise Error:&#x27;</span>, &#123;</span><br><span class="line">            <span class="attr">error</span>: error.<span class="property">message</span>,</span><br><span class="line">            <span class="attr">stack</span>: error.<span class="property">stack</span>,</span><br><span class="line">            ...metadata,</span><br><span class="line">            <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">getMetrics</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            ...<span class="variable language_">this</span>.<span class="property">metrics</span>,</span><br><span class="line">            <span class="attr">successRate</span>: <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">success</span> / <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">total</span>,</span><br><span class="line">            <span class="attr">averageDuration</span>: <span class="variable language_">this</span>.<span class="title function_">calculateAverageDuration</span>()</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">calculateAverageDuration</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">timing</span>.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">const</span> sum = <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">timing</span>.<span class="title function_">reduce</span>(<span class="function">(<span class="params">acc, &#123; duration &#125;</span>) =&gt;</span> acc + duration, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> sum / <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">timing</span>.<span class="property">length</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> monitor = <span class="keyword">new</span> <span class="title class_">PromiseMonitor</span>();</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">monitoredOperation</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> monitor.<span class="title function_">track</span>(</span><br><span class="line">        <span class="title function_">fetch</span>(<span class="string">&#x27;/api/data&#x27;</span>),</span><br><span class="line">        &#123; <span class="attr">operation</span>: <span class="string">&#x27;fetchData&#x27;</span>, <span class="attr">priority</span>: <span class="string">&#x27;high&#x27;</span> &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="14-4-测试最佳实践"><a href="#14-4-测试最佳实践" class="headerlink" title="14.4 测试最佳实践"></a>14.4 测试最佳实践</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Promise 测试辅助函数</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PromiseTestUtils</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">async</span> <span class="title function_">expectResolve</span>(<span class="params">promise</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> error;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> promise;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            error = e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">expect</span>(error).<span class="title function_">toBeUndefined</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">async</span> <span class="title function_">expectReject</span>(<span class="params">promise</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> error;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> promise;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            error = e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">expect</span>(error).<span class="title function_">toBeDefined</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">createDeferred</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> resolve, reject;</span><br><span class="line">        <span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">            resolve = res;</span><br><span class="line">            reject = rej;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> &#123; promise, resolve, reject &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试示例</span></span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;Promise Tests&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">it</span>(<span class="string">&#x27;should handle successful operations&#x27;</span>, <span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; promise, resolve &#125; = <span class="title class_">PromiseTestUtils</span>.<span class="title function_">createDeferred</span>();</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">resolve</span>(<span class="string">&#x27;success&#x27;</span>), <span class="number">100</span>);</span><br><span class="line">        <span class="keyword">await</span> <span class="title class_">PromiseTestUtils</span>.<span class="title function_">expectResolve</span>(promise);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">it</span>(<span class="string">&#x27;should handle failures&#x27;</span>, <span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; promise, reject &#125; = <span class="title class_">PromiseTestUtils</span>.<span class="title function_">createDeferred</span>();</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;fail&#x27;</span>)), <span class="number">100</span>);</span><br><span class="line">        <span class="keyword">await</span> <span class="title class_">PromiseTestUtils</span>.<span class="title function_">expectReject</span>(promise);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://aoayaoa.github.io">aoaYaoa</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://aoayaoa.github.io/2024/12/13/Promise/">https://aoayaoa.github.io/2024/12/13/Promise/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://aoayaoa.github.io" target="_blank">aoaYaoa</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Promise/">Promise</a><a class="post-meta__tags" href="/tags/%E5%85%A5%E9%97%A8/">入门</a></div><div class="post-share"><div class="social-share" data-image="/img/promise.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2024/09/08/taro/" title="Taro使用记录"><img class="cover" src="/img/taro.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Taro使用记录</div></div><div class="info-2"><div class="info-item-1">Deno学习记录 📘📱 Taro 学习总结Taro 是一个开放式跨端跨框架解决方案，助力开发者快速构建小程序、H5和原生应用 📑 目录 基础概念 项目结构 基础使用 小程序开发注意事项 常见问题与解决方案 小程序打包与发布 性能优化最佳实践 小程序特有功能 最佳实践   🔰 基础概念Taro 是一个开放式跨端跨框架解决方案，支持使用 React&#x2F;Vue&#x2F;Nerv 等框架来开发小程序、H5、RN 等应用。  📂 项目结构一个典型的 Taro 项目结构：    目录&#x2F;文件 说明    📁 config/ 项目编译配置目录   📁...</div></div></div></a><a class="pagination-related" href="/2025/01/07/nginx/" title="nginx 学习配置记录"><img class="cover" src="/img/nginx.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">nginx 学习配置记录</div></div><div class="info-2"><div class="info-item-1">Nginx Web 服务器配置一个生产环境ready的Nginx配置模板，包含HTTP&#x2F;2、SSL、安全头信息和性能优化。 📋 特性 支持HTTP&#x2F;2以提升性能 自动HTTP到HTTPS重定向 现代SSL&#x2F;TLS配置与安全密码套件 静态文件缓存以提高性能 Gzip压缩以减少带宽使用 PHP-FPM支持PHP应用 后端服务的反向代理配置 包括HSTS在内的安全头信息 优化的性能设置  🚀 安装前提条件 Nginx...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2024/04/08/qiankun/" title="Qiankun 微前端的使用"><img class="cover" src="/img/qiankun.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-08</div><div class="info-item-2">Qiankun 微前端的使用</div></div><div class="info-2"><div class="info-item-1">Qiankun 微前端企业级实践指南目录 基础配置 通信方案 路由管理 样式隔离 性能优化 问题解决方案 最佳实践 子应用间跳转与传值 常见问题解决方案 总结与展望 子应用优化策略   一、基础配置1.1 主应用初始化12345678910111213141516171819202122232425// main-app.jsimport &#123; registerMicroApps, start &#125; from &#x27;qiankun&#x27;;const apps = [&#123;name: &#x27;sub-app&#x27;,entry:...</div></div></div></a><a class="pagination-related" href="/2024/02/01/vite/" title="vite"><img class="cover" src="https://tiven.cn/static/img/vite-03-xbVS9jZm.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-02-01</div><div class="info-item-2">vite</div></div><div class="info-2"><div class="info-item-1">Vite 完全指南：从入门到精通目录第一部分：基础入门 认识 Vite  1.1 什么是 Vite 1.2 核心优势 1.3 基本原理 1.4 应用场景   快速开始  2.1 环境准备 2.2 创建项目 2.3 项目结构 2.4 基本命令 2.5 开发调试    第二部分：核心概念 构建基础  3.1 开发服务器 3.2 构建过程 3.3 依赖预构建 3.4 HMR 机制   资源处理  4.1 静态资源 4.2 样式处理 4.3 JavaScript&#x2F;TypeScript 4.4 JSON 和 Web Workers 4.5...</div></div></div></a><a class="pagination-related" href="/2023/05/26/webpack/" title="webpack"><img class="cover" src="https://img0.baidu.com/it/u=3179744413,569264497&fm=253&fmt=auto&app=138&f=PNG?w=1285&h=500" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-26</div><div class="info-item-2">webpack</div></div><div class="info-2"><div class="info-item-1">Webpack 完全指南：从入门到精通目录 1. 基础概念 2. 核心功能 3. 打包原理 4. 配置详解 5. Loader 体系 6. Plugin 体系 7. 性能优化 8. 实战应用 9. 高级特性 10. 最佳实践  1. 基础概念1.1 什么是 Webpack？ Webpack 是一个现代 JavaScript 应用程序的静态模块打包工具。它将项目中的所有资源视为模块，通过依赖关系图构建应用。 1.2 核心概念1.2.1 入口(Entry)123456789101112// 单入口module.exports = &#123;  entry:...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">aoaYaoa</div><div class="author-info-description">个人博客，记录成长点滴...</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">10</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">10</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/aoaYaoa"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/aoaYaoa" rel="external nofollow noreferrer" target="_blank" title="GitHub"><i class="fab fa-github" style="color: #181717;"></i></a><a class="social-icon" href="https://twitter.com/yourname" rel="external nofollow noreferrer" target="_blank" title="Twitter"><i class="fab fa-twitter" style="color: #1DA1F2;"></i></a><a class="social-icon" href="mailto:skyeeq9@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #EA4335;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">算了，不知道写什么，就这样吧！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-JavaScript-Promise%EF%BC%9A%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A"><span class="toc-number">1.</span> <span class="toc-text">深入理解 JavaScript Promise：从入门到精通</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95"><span class="toc-number">1.2.</span> <span class="toc-text">目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Promise-%E5%9F%BA%E7%A1%80"><span class="toc-number">1.3.</span> <span class="toc-text">1. Promise 基础</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E4%BB%80%E4%B9%88%E6%98%AF-Promise%EF%BC%9F"><span class="toc-number">1.3.1.</span> <span class="toc-text">1.1 什么是 Promise？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-number">1.3.2.</span> <span class="toc-text">1.2 基本语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="toc-number">1.3.3.</span> <span class="toc-text">1.3 基本用法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Promise-%E7%8A%B6%E6%80%81"><span class="toc-number">1.4.</span> <span class="toc-text">2. Promise 状态</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E4%B8%89%E7%A7%8D%E7%8A%B6%E6%80%81"><span class="toc-number">1.4.1.</span> <span class="toc-text">2.1 三种状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.4.2.</span> <span class="toc-text">2.2 状态转换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E7%8A%B6%E6%80%81%E7%9A%84%E4%B8%8D%E5%8F%AF%E9%80%86%E6%80%A7"><span class="toc-number">1.4.3.</span> <span class="toc-text">2.3 状态的不可逆性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Promise-%E6%96%B9%E6%B3%95"><span class="toc-number">1.5.</span> <span class="toc-text">3. Promise 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-then-%E6%96%B9%E6%B3%95"><span class="toc-number">1.5.1.</span> <span class="toc-text">3.1 then() 方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-catch-%E6%96%B9%E6%B3%95"><span class="toc-number">1.5.2.</span> <span class="toc-text">3.2 catch() 方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-finally-%E6%96%B9%E6%B3%95"><span class="toc-number">1.5.3.</span> <span class="toc-text">3.3 finally() 方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">1.6.</span> <span class="toc-text">4. 错误处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E9%94%99%E8%AF%AF%E6%8D%95%E8%8E%B7%E6%96%B9%E5%BC%8F"><span class="toc-number">1.6.1.</span> <span class="toc-text">4.1 错误捕获方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91"><span class="toc-number">1.6.2.</span> <span class="toc-text">4.2 错误处理逻辑</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Promise-%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8"><span class="toc-number">1.7.</span> <span class="toc-text">5. Promise 链式调用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%9F%BA%E6%9C%AC%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8"><span class="toc-number">1.7.1.</span> <span class="toc-text">5.1 基本链式调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E5%80%BC%E7%9A%84%E4%BC%A0%E9%80%92"><span class="toc-number">1.7.2.</span> <span class="toc-text">5.2 值的传递</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-Promise-%E9%93%BE%E4%B8%AD%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">1.7.3.</span> <span class="toc-text">5.3 Promise 链中的错误处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Promise-%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95"><span class="toc-number">1.8.</span> <span class="toc-text">6. Promise 静态方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-Promise-resolve"><span class="toc-number">1.8.1.</span> <span class="toc-text">6.1 Promise.resolve()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-Promise-reject"><span class="toc-number">1.8.2.</span> <span class="toc-text">6.2 Promise.reject()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-Promise-all"><span class="toc-number">1.8.3.</span> <span class="toc-text">6.3 Promise.all()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-Promise-race"><span class="toc-number">1.8.4.</span> <span class="toc-text">6.4 Promise.race()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-Promise-allSettled"><span class="toc-number">1.8.5.</span> <span class="toc-text">6.5 Promise.allSettled()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-async-await"><span class="toc-number">1.9.</span> <span class="toc-text">7. async&#x2F;await</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="toc-number">1.9.1.</span> <span class="toc-text">7.1 基本用法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E4%B8%8E-Promise-%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">1.9.2.</span> <span class="toc-text">7.2 与 Promise 的关系</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.10.</span> <span class="toc-text">8. 实际应用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-API-%E8%AF%B7%E6%B1%82"><span class="toc-number">1.10.1.</span> <span class="toc-text">8.1 API 请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E5%B9%B6%E8%A1%8C%E8%AF%B7%E6%B1%82"><span class="toc-number">1.10.2.</span> <span class="toc-text">8.2 并行请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-%E4%B8%B2%E8%A1%8C%E8%AF%B7%E6%B1%82"><span class="toc-number">1.10.3.</span> <span class="toc-text">8.3 串行请求</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.11.</span> <span class="toc-text">9. 最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">1.11.1.</span> <span class="toc-text">9.1 错误处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-Promise-%E8%B6%85%E6%97%B6%E5%A4%84%E7%90%86"><span class="toc-number">1.11.2.</span> <span class="toc-text">9.2 Promise 超时处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-%E5%8F%96%E6%B6%88%E6%93%8D%E4%BD%9C"><span class="toc-number">1.11.3.</span> <span class="toc-text">9.3 取消操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E5%92%8C%E9%99%B7%E9%98%B1"><span class="toc-number">1.12.</span> <span class="toc-text">10. 常见问题和陷阱</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1-Promise-%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-number">1.12.1.</span> <span class="toc-text">10.1 Promise 执行顺序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1-1-Promise-%E4%B8%AD%E7%9A%84%E5%90%8C%E6%AD%A5%E5%92%8C%E5%BC%82%E6%AD%A5%E6%93%8D%E4%BD%9C"><span class="toc-number">1.12.2.</span> <span class="toc-text">10.1.1 Promise 中的同步和异步操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-2-Promise-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">1.12.3.</span> <span class="toc-text">10.2 Promise 错误处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-3-%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F"><span class="toc-number">1.12.4.</span> <span class="toc-text">10.3 内存泄漏</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-4-Promise-%E5%B5%8C%E5%A5%97"><span class="toc-number">1.12.5.</span> <span class="toc-text">10.4 Promise 嵌套</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-5-%E5%B8%B8%E8%A7%81%E6%98%93%E9%94%99%E7%82%B9%E5%92%8C%E7%89%B9%E5%88%AB%E6%8F%90%E7%A4%BA"><span class="toc-number">1.12.6.</span> <span class="toc-text">10.5 常见易错点和特别提示</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Promise-%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E4%B8%AD%E7%9A%84%E4%BB%A3%E7%A0%81%E7%AB%8B%E5%8D%B3%E6%89%A7%E8%A1%8C"><span class="toc-number">1.12.6.1.</span> <span class="toc-text">1. Promise 构造函数中的代码立即执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-resolve-reject-%E5%90%8E%E7%9A%84%E4%BB%A3%E7%A0%81%E4%BB%8D%E4%BC%9A%E6%89%A7%E8%A1%8C"><span class="toc-number">1.12.6.2.</span> <span class="toc-text">2. resolve&#x2F;reject 后的代码仍会执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-then-catch-%E8%BF%94%E5%9B%9E%E5%80%BC%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.12.6.3.</span> <span class="toc-text">3. then&#x2F;catch 返回值的问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-Promise-all-%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">1.12.6.4.</span> <span class="toc-text">4. Promise.all 的错误处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-async-await-%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF"><span class="toc-number">1.12.6.5.</span> <span class="toc-text">5. async&#x2F;await 常见错误</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E7%89%B9%E5%88%AB%E6%8F%90%E7%A4%BA"><span class="toc-number">1.12.6.6.</span> <span class="toc-text">6. 特别提示</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-6-%E9%AB%98%E7%BA%A7%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%E5%92%8C%E9%99%B7%E9%98%B1"><span class="toc-number">1.12.7.</span> <span class="toc-text">10.6 高级注意事项和陷阱</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Promise-resolve-reject-%E7%9A%84%E7%89%B9%E6%AE%8A%E8%A1%8C%E4%B8%BA"><span class="toc-number">1.12.7.1.</span> <span class="toc-text">1. Promise.resolve&#x2F;reject 的特殊行为</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Promise-%E7%9A%84%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6"><span class="toc-number">1.12.7.2.</span> <span class="toc-text">2. Promise 的并发控制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%BE%AA%E7%8E%AF%E4%B8%AD%E7%9A%84-Promise-%E5%A4%84%E7%90%86"><span class="toc-number">1.12.7.3.</span> <span class="toc-text">3. 循环中的 Promise 处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-Promise-%E7%AB%9E%E6%80%81%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86"><span class="toc-number">1.12.7.4.</span> <span class="toc-text">4. Promise 竞态问题处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-async-await-%E4%B8%8E-Promise-%E6%B7%B7%E7%94%A8%E7%9A%84%E9%99%B7%E9%98%B1"><span class="toc-number">1.12.7.5.</span> <span class="toc-text">5. async&#x2F;await 与 Promise 混用的陷阱</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-Promise-%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E7%9A%84%E5%85%B6%E4%BB%96%E6%83%85%E5%86%B5"><span class="toc-number">1.12.7.6.</span> <span class="toc-text">6. Promise 内存泄漏的其他情况</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-%E7%89%B9%E6%AE%8A%E5%9C%BA%E6%99%AF%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">1.12.7.7.</span> <span class="toc-text">7. 特殊场景的注意事项</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">1.13.</span> <span class="toc-text">参考资料</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-%E6%9B%B4%E5%A4%9A%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.14.</span> <span class="toc-text">11. 更多实际应用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-1-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E4%B8%8E%E8%BF%9B%E5%BA%A6%E7%9B%91%E6%8E%A7"><span class="toc-number">1.14.1.</span> <span class="toc-text">11.1 文件上传与进度监控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-2-%E5%B8%A6%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6%E7%9A%84API%E8%AF%B7%E6%B1%82"><span class="toc-number">1.14.2.</span> <span class="toc-text">11.2 带重试机制的API请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-3-%E8%B5%84%E6%BA%90%E9%A2%84%E5%8A%A0%E8%BD%BD"><span class="toc-number">1.14.3.</span> <span class="toc-text">11.3 资源预加载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-4-%E5%B9%B6%E5%8F%91%E8%AF%B7%E6%B1%82%E9%99%90%E5%88%B6%E5%99%A8"><span class="toc-number">1.14.4.</span> <span class="toc-text">11.4 并发请求限制器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-%E8%AF%A6%E7%BB%86%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E6%8C%87%E5%8D%97"><span class="toc-number">1.15.</span> <span class="toc-text">12. 详细错误处理指南</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#12-1-%E9%94%99%E8%AF%AF%E7%B1%BB%E5%9E%8B%E5%88%86%E7%B1%BB"><span class="toc-number">1.15.1.</span> <span class="toc-text">12.1 错误类型分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-2-%E5%85%A8%E5%B1%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">1.15.2.</span> <span class="toc-text">12.2 全局错误处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.16.</span> <span class="toc-text">13. 性能优化最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#13-1-Promise-%E6%89%B9%E5%A4%84%E7%90%86"><span class="toc-number">1.16.1.</span> <span class="toc-text">13.1 Promise 批处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-2-Promise-%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96"><span class="toc-number">1.16.2.</span> <span class="toc-text">13.2 Promise 缓存优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-3-%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96"><span class="toc-number">1.16.3.</span> <span class="toc-text">13.3 内存优化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-%E8%A1%A5%E5%85%85%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.17.</span> <span class="toc-text">14. 补充最佳实践建议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#14-1-Promise-%E9%93%BE%E4%BC%98%E5%8C%96"><span class="toc-number">1.17.1.</span> <span class="toc-text">14.1 Promise 链优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-2-%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86"><span class="toc-number">1.17.2.</span> <span class="toc-text">14.2 资源管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-3-%E7%9B%91%E6%8E%A7%E5%92%8C%E6%97%A5%E5%BF%97"><span class="toc-number">1.17.3.</span> <span class="toc-text">14.3 监控和日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-4-%E6%B5%8B%E8%AF%95%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.17.4.</span> <span class="toc-text">14.4 测试最佳实践</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/04/25/Go%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" title="Go语言学习总结"><img src="/img/go.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Go语言学习总结"/></a><div class="content"><a class="title" href="/2025/04/25/Go%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" title="Go语言学习总结">Go语言学习总结</a><time datetime="2025-04-24T16:00:00.000Z" title="发表于 2025-04-25 00:00:00">2025-04-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/15/deno%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" title="Deno学习记录"><img src="/img/deno.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Deno学习记录"/></a><div class="content"><a class="title" href="/2025/04/15/deno%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" title="Deno学习记录">Deno学习记录</a><time datetime="2025-04-14T16:00:00.000Z" title="发表于 2025-04-15 00:00:00">2025-04-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/03/15/react/" title="react总结"><img src="/img/react19.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="react总结"/></a><div class="content"><a class="title" href="/2025/03/15/react/" title="react总结">react总结</a><time datetime="2025-03-14T16:00:00.000Z" title="发表于 2025-03-15 00:00:00">2025-03-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/07/nginx/" title="nginx 学习配置记录"><img src="/img/nginx.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="nginx 学习配置记录"/></a><div class="content"><a class="title" href="/2025/01/07/nginx/" title="nginx 学习配置记录">nginx 学习配置记录</a><time datetime="2025-01-06T16:00:00.000Z" title="发表于 2025-01-07 00:00:00">2025-01-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/12/13/Promise/" title="深入理解Promise"><img src="/img/promise.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="深入理解Promise"/></a><div class="content"><a class="title" href="/2024/12/13/Promise/" title="深入理解Promise">深入理解Promise</a><time datetime="2024-12-12T16:00:00.000Z" title="发表于 2024-12-13 00:00:00">2024-12-13</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By aoaYaoa</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.4</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoogo.netlify.app/.netlify/functions/twikoo',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = (el = document, path = location.pathname) => {
    twikoo.init({
      el: el.querySelector('#twikoo-wrap'),
      envId: 'https://twikoogo.netlify.app/.netlify/functions/twikoo',
      region: '',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      },
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    

    isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
      if (el.children.length) {
        el.innerHTML = ''
        el.classList.add('no-comment')
      }
    })
  }

  const loadTwikoo = (el, path) => {
    if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
    else btf.getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(() => init(el, path))
  }

  if (isShuoshuo) {
    'Twikoo' === 'Twikoo'
      ? window.shuoshuoComment = { loadComment: loadTwikoo }
      : window.loadOtherComment = loadTwikoo
    return
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><div class="aplayer no-destroy" data-id="13528716738" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="true"> </div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="富强,民主,文明,和谐,自由,平等,公正,法治,爱国,敬业,诚信,友善" data-fontsize="15px" data-random="true" async="async"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script>(() => {
  const destroyAplayer = () => {
    if (window.aplayers) {
      for (let i = 0; i < window.aplayers.length; i++) {
        if (!window.aplayers[i].options.fixed) {
          window.aplayers[i].destroy()
        }
      }
    }
  }

  const runMetingJS = () => {
    typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()
  }

  btf.addGlobalFn('pjaxSend', destroyAplayer, 'destroyAplayer')
  btf.addGlobalFn('pjaxComplete', loadMeting, 'runMetingJS')
})()</script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => fn())
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      const usePjax = true
      true 
        ? (usePjax ? pjax.loadUrl('/404.html') : window.location.href = '/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章..." type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>