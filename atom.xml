<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>aoaYaoa</title>
  
  <subtitle>ç°è‰²éšæƒ³ï¼šè®°å½•ç”Ÿæ´»ï¼Œæ¢ç´¢æŠ€æœ¯çš„ä¸ªäººç©ºé—´</subtitle>
  <link href="https://aoayaoa.github.io/atom.xml" rel="self"/>
  
  <link href="https://aoayaoa.github.io/"/>
  <updated>2025-08-08T03:24:51.301Z</updated>
  <id>https://aoayaoa.github.io/</id>
  
  <author>
    <name>aoaYaoa</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>BabylonJS</title>
    <link href="https://aoayaoa.github.io/2025/07/31/babylonjs/"/>
    <id>https://aoayaoa.github.io/2025/07/31/babylonjs/</id>
    <published>2025-07-30T16:00:00.000Z</published>
    <updated>2025-08-08T03:24:51.301Z</updated>
    
    <content type="html"><![CDATA[<h1 id="BabylonJS-å®Œæ•´ç¦»çº¿å¼€å‘æŒ‡å—"><a href="#BabylonJS-å®Œæ•´ç¦»çº¿å¼€å‘æŒ‡å—" class="headerlink" title="BabylonJS å®Œæ•´ç¦»çº¿å¼€å‘æŒ‡å—"></a>BabylonJS å®Œæ•´ç¦»çº¿å¼€å‘æŒ‡å—</h1><h2 id="ğŸ“‹-ç›®å½•"><a href="#ğŸ“‹-ç›®å½•" class="headerlink" title="ğŸ“‹ ç›®å½•"></a>ğŸ“‹ ç›®å½•</h2><ul><li><a href="#babylonjs-%E5%AE%8C%E6%95%B4%E7%A6%BB%E7%BA%BF%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97">BabylonJS å®Œæ•´ç¦»çº¿å¼€å‘æŒ‡å—</a><ul><li><a href="#-%E7%9B%AE%E5%BD%95">ğŸ“‹ ç›®å½•</a></li><li><a href="#-babylonjs-%E7%AE%80%E4%BB%8B">ğŸš€ BabylonJS ç®€ä»‹</a></li><li><a href="#-%E7%A6%BB%E7%BA%BF%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE">ğŸ’» ç¦»çº¿ç¯å¢ƒé…ç½®</a></li><li><a href="#-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5">ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ</a></li><li><a href="#-engine-%E5%BC%95%E6%93%8E%E8%AF%A6%E8%A7%A3">ğŸ¬ Engine å¼•æ“è¯¦è§£</a></li><li><a href="#-scene-%E5%9C%BA%E6%99%AF%E8%AF%A6%E8%A7%A3">ğŸ­ Scene åœºæ™¯è¯¦è§£</a></li><li><a href="#-camera-%E7%9B%B8%E6%9C%BA%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">ğŸ“· Camera ç›¸æœºç³»ç»Ÿè¯¦è§£</a></li><li><a href="#-light-%E5%85%89%E7%85%A7%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">ğŸ’¡ Light å…‰ç…§ç³»ç»Ÿè¯¦è§£</a></li><li><a href="#-material-%E6%9D%90%E8%B4%A8%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">ğŸ¨ Material æè´¨ç³»ç»Ÿè¯¦è§£</a></li><li><a href="#-mesh-%E7%BD%91%E6%A0%BC%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">ğŸ­ Mesh ç½‘æ ¼ç³»ç»Ÿè¯¦è§£</a></li><li><a href="#-animation-%E5%8A%A8%E7%94%BB%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">ğŸ¬ Animation åŠ¨ç”»ç³»ç»Ÿè¯¦è§£</a></li><li><a href="#-particlesystem-%E7%B2%92%E5%AD%90%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">ğŸ† ParticleSystem ç²’å­ç³»ç»Ÿè¯¦è§£</a></li><li><a href="#-audio-%E9%9F%B3%E9%A2%91%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">ğŸ”Š Audio éŸ³é¢‘ç³»ç»Ÿè¯¦è§£</a></li><li><a href="#-input-%E8%BE%93%E5%85%A5%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">ğŸ® Input è¾“å…¥ç³»ç»Ÿè¯¦è§£</a></li><li><a href="#-asset-%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E8%AF%A6%E8%A7%A3">ğŸ”§ Asset èµ„æºç®¡ç†è¯¦è§£</a></li><li><a href="#-performance-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E8%AF%A6%E8%A7%A3">âš¡ Performance æ€§èƒ½ä¼˜åŒ–è¯¦è§£</a></li><li><a href="#-%E4%B8%8E-cesium-%E5%90%8C%E5%B1%8F%E5%8F%A0%E5%8A%A0%E5%8D%95%E5%9B%BE%E5%B1%82%E5%AE%9E%E7%8E%B0">ğŸ¤ ä¸ Cesium åŒå±å åŠ ï¼ˆå•å›¾å±‚ï¼‰å®ç°</a></li></ul></li><li><a href="#-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">ğŸ¯ æœ€ä½³å®è·µ</a></li></ul><h2 id="ğŸš€-BabylonJS-ç®€ä»‹"><a href="#ğŸš€-BabylonJS-ç®€ä»‹" class="headerlink" title="ğŸš€ BabylonJS ç®€ä»‹"></a>ğŸš€ BabylonJS ç®€ä»‹</h2><p>BabylonJS æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ 3D JavaScript å¼•æ“ï¼Œç”¨äºåœ¨æµè§ˆå™¨ä¸­åˆ›å»ºä»¤äººæƒŠå¹çš„ 3D ä½“éªŒã€‚å®ƒæ”¯æŒ WebGLã€WebGPU å’Œ WebXRï¼Œä¸ºå¼€å‘è€…æä¾›äº†å®Œæ•´çš„ 3D å¼€å‘å·¥å…·é“¾ã€‚</p><h3 id="æ ¸å¿ƒç‰¹æ€§"><a href="#æ ¸å¿ƒç‰¹æ€§" class="headerlink" title="æ ¸å¿ƒç‰¹æ€§"></a>æ ¸å¿ƒç‰¹æ€§</h3><ul><li><strong>è·¨å¹³å°æ”¯æŒ</strong> - Webã€ç§»åŠ¨ç«¯ã€æ¡Œé¢åº”ç”¨</li><li><strong>ç°ä»£æ¸²æŸ“</strong> - WebGL 2.0ã€WebGPU æ”¯æŒ</li><li><strong>å®Œæ•´å·¥å…·é“¾</strong> - ç¼–è¾‘å™¨ã€è°ƒè¯•å™¨ã€ä¼˜åŒ–å·¥å…·</li><li><strong>ä¸°å¯Œç”Ÿæ€</strong> - æ’ä»¶ç³»ç»Ÿã€ç¤¾åŒºèµ„æº</li><li><strong>é«˜æ€§èƒ½</strong> - ä¼˜åŒ–çš„æ¸²æŸ“ç®¡çº¿å’Œå†…å­˜ç®¡ç†</li></ul><h2 id="ğŸ’»-ç¦»çº¿ç¯å¢ƒé…ç½®"><a href="#ğŸ’»-ç¦»çº¿ç¯å¢ƒé…ç½®" class="headerlink" title="ğŸ’» ç¦»çº¿ç¯å¢ƒé…ç½®"></a>ğŸ’» ç¦»çº¿ç¯å¢ƒé…ç½®</h2><h3 id="Vite-é…ç½®"><a href="#Vite-é…ç½®" class="headerlink" title="Vite é…ç½®"></a>Vite é…ç½®</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.js - BabylonJSç¦»çº¿å¼€å‘é…ç½®</span></span><br><span class="line"><span class="keyword">import</span> &#123; defineConfig &#125; <span class="keyword">from</span> <span class="string">&#x27;vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; resolve &#125; <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">define</span>: &#123;</span><br><span class="line">    <span class="attr">BABYLON_BASE_URL</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="string">&#x27;/babylon/&#x27;</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">publicDir</span>: <span class="string">&#x27;public&#x27;</span>,</span><br><span class="line">  <span class="attr">build</span>: &#123;</span><br><span class="line">    <span class="attr">rollupOptions</span>: &#123;</span><br><span class="line">      <span class="attr">external</span>: [],</span><br><span class="line">      <span class="attr">input</span>: &#123;</span><br><span class="line">        <span class="attr">main</span>: <span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;index.html&#x27;</span>),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">server</span>: &#123;</span><br><span class="line">    <span class="attr">fs</span>: &#123;</span><br><span class="line">      <span class="attr">allow</span>: [<span class="string">&#x27;..&#x27;</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;Cross-Origin-Embedder-Policy&#x27;</span>: <span class="string">&#x27;require-corp&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;Cross-Origin-Opener-Policy&#x27;</span>: <span class="string">&#x27;same-origin&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">optimizeDeps</span>: &#123;</span><br><span class="line">    <span class="attr">include</span>: [</span><br><span class="line">      <span class="string">&#x27;@babylonjs/core&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;@babylonjs/loaders&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;@babylonjs/materials&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;@babylonjs/post-processes&#x27;</span>,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">worker</span>: &#123;</span><br><span class="line">    <span class="attr">format</span>: <span class="string">&#x27;es&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="é¡¹ç›®ç»“æ„"><a href="#é¡¹ç›®ç»“æ„" class="headerlink" title="é¡¹ç›®ç»“æ„"></a>é¡¹ç›®ç»“æ„</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">project/</span><br><span class="line">â”œâ”€â”€ public/</span><br><span class="line">â”‚   â”œâ”€â”€ models/          # 3Dæ¨¡å‹æ–‡ä»¶</span><br><span class="line">â”‚   â”œâ”€â”€ textures/        # çº¹ç†è´´å›¾</span><br><span class="line">â”‚   â”œâ”€â”€ sounds/          # éŸ³é¢‘æ–‡ä»¶</span><br><span class="line">â”‚   â””â”€â”€ environments/    # ç¯å¢ƒè´´å›¾</span><br><span class="line">â”œâ”€â”€ src/</span><br><span class="line">â”‚   â”œâ”€â”€ babylon/</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ engine.js    # å¼•æ“é…ç½®</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ scene.js     # åœºæ™¯ç®¡ç†</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ cameras.js   # ç›¸æœºæ§åˆ¶</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ lights.js    # å…‰ç…§è®¾ç½®</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ materials.js # æè´¨ç®¡ç†</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ meshes.js    # ç½‘æ ¼æ“ä½œ</span><br><span class="line">â”‚   â”‚   â””â”€â”€ animations.js # åŠ¨ç”»æ§åˆ¶</span><br><span class="line">â”‚   â””â”€â”€ main.js</span><br><span class="line">â””â”€â”€ package.json</span><br></pre></td></tr></table></figure><h3 id="ä¾èµ–å®‰è£…"><a href="#ä¾èµ–å®‰è£…" class="headerlink" title="ä¾èµ–å®‰è£…"></a>ä¾èµ–å®‰è£…</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;dependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@babylonjs/core&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^6.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@babylonjs/loaders&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^6.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@babylonjs/materials&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^6.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@babylonjs/post-processes&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^6.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@babylonjs/procedural-textures&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^6.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@babylonjs/serializers&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^6.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@babylonjs/node-geometry-editor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^6.0.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;devDependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;vite&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^4.0.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="åŸºç¡€åˆå§‹åŒ–"><a href="#åŸºç¡€åˆå§‹åŒ–" class="headerlink" title="åŸºç¡€åˆå§‹åŒ–"></a>åŸºç¡€åˆå§‹åŒ–</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js - BabylonJSåŸºç¡€åˆå§‹åŒ–</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Engine</span>, <span class="title class_">Scene</span>, <span class="title class_">FreeCamera</span>, <span class="title class_">HemisphericLight</span>, <span class="title class_">Vector3</span>, <span class="title class_">MeshBuilder</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@babylonjs/core&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;@babylonjs/loaders/glTF&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¦»çº¿ç¯å¢ƒé…ç½®</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">BABYLON_BASE_URL</span> = <span class="string">&#x27;/babylon/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BabylonApp</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">canvasId</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(canvasId)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span> = <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">init</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºå¼•æ“</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span> = <span class="keyword">new</span> <span class="title class_">Engine</span>(<span class="variable language_">this</span>.<span class="property">canvas</span>, <span class="literal">true</span>, &#123;</span><br><span class="line">      <span class="attr">preserveDrawingBuffer</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">stencil</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">disableWebGL2Support</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºåœºæ™¯</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = <span class="keyword">new</span> <span class="title class_">Scene</span>(<span class="variable language_">this</span>.<span class="property">engine</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®åŸºç¡€åœºæ™¯</span></span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">createScene</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯åŠ¨æ¸²æŸ“å¾ªç¯</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">startRenderLoop</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç†çª—å£å¤§å°å˜åŒ–</span></span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;resize&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">resize</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">createScene</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºç›¸æœº</span></span><br><span class="line">    <span class="keyword">const</span> camera = <span class="keyword">new</span> <span class="title class_">FreeCamera</span>(<span class="string">&#x27;camera&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">5</span>, -<span class="number">10</span>), <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    camera.<span class="title function_">setTarget</span>(<span class="title class_">Vector3</span>.<span class="title class_">Zero</span>())</span><br><span class="line">    camera.<span class="title function_">attachControls</span>(<span class="variable language_">this</span>.<span class="property">canvas</span>, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºå…‰æº</span></span><br><span class="line">    <span class="keyword">const</span> light = <span class="keyword">new</span> <span class="title class_">HemisphericLight</span>(<span class="string">&#x27;light&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>), <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    light.<span class="property">intensity</span> = <span class="number">0.7</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºåŸºç¡€å‡ ä½•ä½“</span></span><br><span class="line">    <span class="keyword">const</span> sphere = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateSphere</span>(<span class="string">&#x27;sphere&#x27;</span>, &#123; <span class="attr">diameter</span>: <span class="number">2</span> &#125;, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    sphere.<span class="property">position</span>.<span class="property">y</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> ground = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateGround</span>(<span class="string">&#x27;ground&#x27;</span>, &#123; <span class="attr">width</span>: <span class="number">6</span>, <span class="attr">height</span>: <span class="number">6</span> &#125;, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">startRenderLoop</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">runRenderLoop</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">render</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>?.<span class="title function_">dispose</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>?.<span class="title function_">dispose</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯åŠ¨åº”ç”¨</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">BabylonApp</span>(<span class="string">&#x27;babylonCanvas&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="ğŸ¯-æ ¸å¿ƒæ¦‚å¿µ"><a href="#ğŸ¯-æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ"></a>ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ</h2><h3 id="åæ ‡ç³»ç»Ÿ"><a href="#åæ ‡ç³»ç»Ÿ" class="headerlink" title="åæ ‡ç³»ç»Ÿ"></a>åæ ‡ç³»ç»Ÿ</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BabylonJSåæ ‡ç³»ç»Ÿè¯¦è§£</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CoordinateSystem</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å³æ‰‹åæ ‡ç³»</span></span><br><span class="line">  <span class="comment">// Xè½´: å‘å³ä¸ºæ­£</span></span><br><span class="line">  <span class="comment">// Yè½´: å‘ä¸Šä¸ºæ­£</span></span><br><span class="line">  <span class="comment">// Zè½´: å‘å‰ä¸ºæ­£ï¼ˆæœå‘è§‚å¯Ÿè€…ï¼‰</span></span><br><span class="line">  <span class="title function_">createCoordinateAxes</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> axisLength = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Xè½´ - çº¢è‰²</span></span><br><span class="line">    <span class="keyword">const</span> xAxis = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateCylinder</span>(</span><br><span class="line">      <span class="string">&#x27;xAxis&#x27;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">height</span>: axisLength,</span><br><span class="line">        <span class="attr">diameterTop</span>: <span class="number">0.1</span>,</span><br><span class="line">        <span class="attr">diameterBottom</span>: <span class="number">0.1</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">    )</span><br><span class="line">    xAxis.<span class="property">rotation</span>.<span class="property">z</span> = -<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">2</span></span><br><span class="line">    xAxis.<span class="property">position</span>.<span class="property">x</span> = axisLength / <span class="number">2</span></span><br><span class="line">    xAxis.<span class="property">material</span> = <span class="variable language_">this</span>.<span class="title function_">createAxisMaterial</span>(<span class="string">&#x27;red&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Yè½´ - ç»¿è‰²</span></span><br><span class="line">    <span class="keyword">const</span> yAxis = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateCylinder</span>(</span><br><span class="line">      <span class="string">&#x27;yAxis&#x27;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">height</span>: axisLength,</span><br><span class="line">        <span class="attr">diameterTop</span>: <span class="number">0.1</span>,</span><br><span class="line">        <span class="attr">diameterBottom</span>: <span class="number">0.1</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">    )</span><br><span class="line">    yAxis.<span class="property">position</span>.<span class="property">y</span> = axisLength / <span class="number">2</span></span><br><span class="line">    yAxis.<span class="property">material</span> = <span class="variable language_">this</span>.<span class="title function_">createAxisMaterial</span>(<span class="string">&#x27;green&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Zè½´ - è“è‰²</span></span><br><span class="line">    <span class="keyword">const</span> zAxis = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateCylinder</span>(</span><br><span class="line">      <span class="string">&#x27;zAxis&#x27;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">height</span>: axisLength,</span><br><span class="line">        <span class="attr">diameterTop</span>: <span class="number">0.1</span>,</span><br><span class="line">        <span class="attr">diameterBottom</span>: <span class="number">0.1</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">    )</span><br><span class="line">    zAxis.<span class="property">rotation</span>.<span class="property">x</span> = <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">2</span></span><br><span class="line">    zAxis.<span class="property">position</span>.<span class="property">z</span> = axisLength / <span class="number">2</span></span><br><span class="line">    zAxis.<span class="property">material</span> = <span class="variable language_">this</span>.<span class="title function_">createAxisMaterial</span>(<span class="string">&#x27;blue&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; xAxis, yAxis, zAxis &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createAxisMaterial</span>(<span class="params">color</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">StandardMaterial</span>(<span class="string">`<span class="subst">$&#123;color&#125;</span>Material`</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    material.<span class="property">diffuseColor</span> = <span class="title class_">Color3</span>.<span class="title class_">FromHexString</span>(</span><br><span class="line">      color === <span class="string">&#x27;red&#x27;</span> ? <span class="string">&#x27;#ff0000&#x27;</span> : color === <span class="string">&#x27;green&#x27;</span> ? <span class="string">&#x27;#00ff00&#x27;</span> : <span class="string">&#x27;#0000ff&#x27;</span>,</span><br><span class="line">    )</span><br><span class="line">    material.<span class="property">emissiveColor</span> = material.<span class="property">diffuseColor</span>.<span class="title function_">clone</span>()</span><br><span class="line">    <span class="keyword">return</span> material</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½ç½®å˜æ¢</span></span><br><span class="line">  <span class="title function_">transformPosition</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// æœ¬åœ°åæ ‡åˆ°ä¸–ç•Œåæ ‡</span></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateBox</span>(<span class="string">&#x27;box&#x27;</span>, &#123; <span class="attr">size</span>: <span class="number">1</span> &#125;, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="keyword">const</span> localPosition = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">const</span> worldPosition = <span class="title class_">Vector3</span>.<span class="title class_">TransformCoordinates</span>(localPosition, mesh.<span class="title function_">getWorldMatrix</span>())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸–ç•Œåæ ‡åˆ°æœ¬åœ°åæ ‡</span></span><br><span class="line">    <span class="keyword">const</span> worldToLocal = <span class="title class_">Vector3</span>.<span class="title class_">TransformCoordinates</span>(</span><br><span class="line">      worldPosition,</span><br><span class="line">      <span class="title class_">Matrix</span>.<span class="title class_">Invert</span>(mesh.<span class="title function_">getWorldMatrix</span>()),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Local:&#x27;</span>, localPosition)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;World:&#x27;</span>, worldPosition)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Back to Local:&#x27;</span>, worldToLocal)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; localPosition, worldPosition, worldToLocal &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ—‹è½¬å˜æ¢</span></span><br><span class="line">  <span class="title function_">transformRotation</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateBox</span>(<span class="string">&#x27;rotatedBox&#x27;</span>, &#123; <span class="attr">size</span>: <span class="number">1</span> &#125;, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¬§æ‹‰è§’è®¾ç½®</span></span><br><span class="line">    mesh.<span class="property">rotation</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>, <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">6</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å››å…ƒæ•°è®¾ç½®</span></span><br><span class="line">    mesh.<span class="property">rotationQuaternion</span> = <span class="title class_">Quaternion</span>.<span class="title class_">FromEulerAngles</span>(<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>, <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">6</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»ä¸€ä¸ªæ–¹å‘æ—‹è½¬åˆ°å¦ä¸€ä¸ªæ–¹å‘</span></span><br><span class="line">    <span class="keyword">const</span> fromDirection = <span class="title class_">Vector3</span>.<span class="title class_">Forward</span>()</span><br><span class="line">    <span class="keyword">const</span> toDirection = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>).<span class="title function_">normalize</span>()</span><br><span class="line">    <span class="keyword">const</span> rotation = <span class="title class_">Quaternion</span>.<span class="title class_">FromLookRotation</span>(toDirection, <span class="title class_">Vector3</span>.<span class="title class_">Up</span>())</span><br><span class="line">    mesh.<span class="property">rotationQuaternion</span> = rotation</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¼©æ”¾å˜æ¢</span></span><br><span class="line">  <span class="title function_">transformScale</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateBox</span>(<span class="string">&#x27;scaledBox&#x27;</span>, &#123; <span class="attr">size</span>: <span class="number">1</span> &#125;, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»Ÿä¸€ç¼©æ”¾</span></span><br><span class="line">    mesh.<span class="property">scaling</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éç»Ÿä¸€ç¼©æ”¾</span></span><br><span class="line">    mesh.<span class="property">scaling</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">2</span>, <span class="number">1</span>, <span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ•°å­¦å·¥å…·"><a href="#æ•°å­¦å·¥å…·" class="headerlink" title="æ•°å­¦å·¥å…·"></a>æ•°å­¦å·¥å…·</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BabylonJSæ•°å­¦å·¥å…·é›†</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MathUtils</span> &#123;</span><br><span class="line">  <span class="comment">// Vector3 è¯¦è§£</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">vector3Examples</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºå‘é‡</span></span><br><span class="line">    <span class="keyword">const</span> v1 = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">const</span> v2 = <span class="title class_">Vector3</span>.<span class="title class_">Zero</span>() <span class="comment">// (0, 0, 0)</span></span><br><span class="line">    <span class="keyword">const</span> v3 = <span class="title class_">Vector3</span>.<span class="title class_">One</span>() <span class="comment">// (1, 1, 1)</span></span><br><span class="line">    <span class="keyword">const</span> v4 = <span class="title class_">Vector3</span>.<span class="title class_">Up</span>() <span class="comment">// (0, 1, 0)</span></span><br><span class="line">    <span class="keyword">const</span> v5 = <span class="title class_">Vector3</span>.<span class="title class_">Forward</span>() <span class="comment">// (0, 0, 1)</span></span><br><span class="line">    <span class="keyword">const</span> v6 = <span class="title class_">Vector3</span>.<span class="title class_">Right</span>() <span class="comment">// (1, 0, 0)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘é‡è¿ç®—</span></span><br><span class="line">    <span class="keyword">const</span> sum = v1.<span class="title function_">add</span>(v2) <span class="comment">// å‘é‡åŠ æ³•</span></span><br><span class="line">    <span class="keyword">const</span> diff = v1.<span class="title function_">subtract</span>(v2) <span class="comment">// å‘é‡å‡æ³•</span></span><br><span class="line">    <span class="keyword">const</span> scaled = v1.<span class="title function_">scale</span>(<span class="number">2</span>) <span class="comment">// æ ‡é‡ä¹˜æ³•</span></span><br><span class="line">    <span class="keyword">const</span> dot = <span class="title class_">Vector3</span>.<span class="title class_">Dot</span>(v1, v2) <span class="comment">// ç‚¹ç§¯</span></span><br><span class="line">    <span class="keyword">const</span> cross = <span class="title class_">Vector3</span>.<span class="title class_">Cross</span>(v1, v2) <span class="comment">// å‰ç§¯</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘é‡å±æ€§</span></span><br><span class="line">    <span class="keyword">const</span> length = v1.<span class="title function_">length</span>() <span class="comment">// å‘é‡é•¿åº¦</span></span><br><span class="line">    <span class="keyword">const</span> lengthSq = v1.<span class="title function_">lengthSquared</span>() <span class="comment">// é•¿åº¦å¹³æ–¹</span></span><br><span class="line">    <span class="keyword">const</span> normalized = v1.<span class="title function_">normalize</span>() <span class="comment">// å•ä½å‘é‡</span></span><br><span class="line">    <span class="keyword">const</span> distance = <span class="title class_">Vector3</span>.<span class="title class_">Distance</span>(v1, v2) <span class="comment">// ä¸¤ç‚¹è·ç¦»</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘é‡æ’å€¼</span></span><br><span class="line">    <span class="keyword">const</span> lerp = <span class="title class_">Vector3</span>.<span class="title class_">Lerp</span>(v1, v2, <span class="number">0.5</span>) <span class="comment">// çº¿æ€§æ’å€¼</span></span><br><span class="line">    <span class="keyword">const</span> slerp = <span class="title class_">Vector3</span>.<span class="title class_">Slerp</span>(v1, v2, <span class="number">0.5</span>) <span class="comment">// çƒé¢æ’å€¼</span></span><br><span class="line">    <span class="keyword">const</span> hermite = <span class="title class_">Vector3</span>.<span class="title class_">Hermite</span>(v1, v2, v3, v4, <span class="number">0.5</span>) <span class="comment">// Hermiteæ’å€¼</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; v1, v2, sum, diff, scaled, dot, cross, length, normalized, lerp &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Matrix è¯¦è§£</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">matrixExamples</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºçŸ©é˜µ</span></span><br><span class="line">    <span class="keyword">const</span> identity = <span class="title class_">Matrix</span>.<span class="title class_">Identity</span>() <span class="comment">// å•ä½çŸ©é˜µ</span></span><br><span class="line">    <span class="keyword">const</span> translation = <span class="title class_">Matrix</span>.<span class="title class_">Translation</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>) <span class="comment">// å¹³ç§»çŸ©é˜µ</span></span><br><span class="line">    <span class="keyword">const</span> rotationX = <span class="title class_">Matrix</span>.<span class="title class_">RotationX</span>(<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>) <span class="comment">// Xè½´æ—‹è½¬</span></span><br><span class="line">    <span class="keyword">const</span> rotationY = <span class="title class_">Matrix</span>.<span class="title class_">RotationY</span>(<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>) <span class="comment">// Yè½´æ—‹è½¬</span></span><br><span class="line">    <span class="keyword">const</span> rotationZ = <span class="title class_">Matrix</span>.<span class="title class_">RotationZ</span>(<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>) <span class="comment">// Zè½´æ—‹è½¬</span></span><br><span class="line">    <span class="keyword">const</span> scaling = <span class="title class_">Matrix</span>.<span class="title class_">Scaling</span>(<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>) <span class="comment">// ç¼©æ”¾çŸ©é˜µ</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤åˆå˜æ¢</span></span><br><span class="line">    <span class="keyword">const</span> trs = <span class="title class_">Matrix</span>.<span class="title class_">Compose</span>(</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>), <span class="comment">// ç¼©æ”¾</span></span><br><span class="line">      <span class="title class_">Quaternion</span>.<span class="title class_">FromEulerAngles</span>(<span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>, <span class="number">0</span>), <span class="comment">// æ—‹è½¬</span></span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>), <span class="comment">// å¹³ç§»</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çŸ©é˜µè¿ç®—</span></span><br><span class="line">    <span class="keyword">const</span> multiplied = translation.<span class="title function_">multiply</span>(rotationY)</span><br><span class="line">    <span class="keyword">const</span> inverted = <span class="title class_">Matrix</span>.<span class="title class_">Invert</span>(trs)</span><br><span class="line">    <span class="keyword">const</span> transposed = <span class="title class_">Matrix</span>.<span class="title class_">Transpose</span>(trs)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»çŸ©é˜µæå–ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">const</span> decomposed = trs.<span class="title function_">decompose</span>()</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="attr">scaling</span>: s, <span class="attr">rotation</span>: r, <span class="attr">translation</span>: t &#125; = decomposed</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; identity, translation, trs, multiplied, inverted, decomposed &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Quaternion è¯¦è§£</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">quaternionExamples</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºå››å…ƒæ•°</span></span><br><span class="line">    <span class="keyword">const</span> identity = <span class="title class_">Quaternion</span>.<span class="title class_">Identity</span>() <span class="comment">// å•ä½å››å…ƒæ•°</span></span><br><span class="line">    <span class="keyword">const</span> fromEuler = <span class="title class_">Quaternion</span>.<span class="title class_">FromEulerAngles</span>(<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>, <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">6</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">const</span> fromAxis = <span class="title class_">Quaternion</span>.<span class="title class_">RotationAxis</span>(<span class="title class_">Vector3</span>.<span class="title class_">Up</span>(), <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>)</span><br><span class="line">    <span class="keyword">const</span> fromYawPitchRoll = <span class="title class_">Quaternion</span>.<span class="title class_">RotationYawPitchRoll</span>(<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>, <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">6</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å››å…ƒæ•°è¿ç®—</span></span><br><span class="line">    <span class="keyword">const</span> multiplied = fromEuler.<span class="title function_">multiply</span>(fromAxis)</span><br><span class="line">    <span class="keyword">const</span> conjugate = <span class="title class_">Quaternion</span>.<span class="title class_">Conjugate</span>(fromEuler)</span><br><span class="line">    <span class="keyword">const</span> inverse = <span class="title class_">Quaternion</span>.<span class="title class_">Inverse</span>(fromEuler)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å››å…ƒæ•°æ’å€¼</span></span><br><span class="line">    <span class="keyword">const</span> slerp = <span class="title class_">Quaternion</span>.<span class="title class_">Slerp</span>(fromEuler, fromAxis, <span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è½¬æ¢</span></span><br><span class="line">    <span class="keyword">const</span> toEuler = fromEuler.<span class="title function_">toEulerAngles</span>()</span><br><span class="line">    <span class="keyword">const</span> toMatrix = fromEuler.<span class="title function_">toRotationMatrix</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–¹å‘è®¡ç®—</span></span><br><span class="line">    <span class="keyword">const</span> forward = <span class="title class_">Vector3</span>.<span class="title class_">Forward</span>()</span><br><span class="line">    <span class="keyword">const</span> rotatedForward = forward.<span class="title function_">applyRotationQuaternion</span>(fromEuler)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; identity, fromEuler, multiplied, slerp, toEuler, rotatedForward &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Color è¯¦è§£</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">colorExamples</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºé¢œè‰²</span></span><br><span class="line">    <span class="keyword">const</span> red = <span class="title class_">Color3</span>.<span class="title class_">Red</span>() <span class="comment">// (1, 0, 0)</span></span><br><span class="line">    <span class="keyword">const</span> green = <span class="title class_">Color3</span>.<span class="title class_">Green</span>() <span class="comment">// (0, 1, 0)</span></span><br><span class="line">    <span class="keyword">const</span> blue = <span class="title class_">Color3</span>.<span class="title class_">Blue</span>() <span class="comment">// (0, 0, 1)</span></span><br><span class="line">    <span class="keyword">const</span> white = <span class="title class_">Color3</span>.<span class="title class_">White</span>() <span class="comment">// (1, 1, 1)</span></span><br><span class="line">    <span class="keyword">const</span> black = <span class="title class_">Color3</span>.<span class="title class_">Black</span>() <span class="comment">// (0, 0, 0)</span></span><br><span class="line">    <span class="keyword">const</span> custom = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.5</span>, <span class="number">0.7</span>, <span class="number">0.9</span>) <span class="comment">// è‡ªå®šä¹‰RGB</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»åå…­è¿›åˆ¶åˆ›å»º</span></span><br><span class="line">    <span class="keyword">const</span> fromHex = <span class="title class_">Color3</span>.<span class="title class_">FromHexString</span>(<span class="string">&#x27;#ff6600&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»HSVåˆ›å»º</span></span><br><span class="line">    <span class="keyword">const</span> fromHSV = <span class="title class_">Color3</span>.<span class="title class_">FromHSV</span>(<span class="number">120</span>, <span class="number">0.8</span>, <span class="number">0.9</span>) <span class="comment">// è‰²ç›¸ã€é¥±å’Œåº¦ã€æ˜åº¦</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é¢œè‰²è¿ç®—</span></span><br><span class="line">    <span class="keyword">const</span> added = red.<span class="title function_">add</span>(green) <span class="comment">// é¢œè‰²åŠ æ³•</span></span><br><span class="line">    <span class="keyword">const</span> scaled = red.<span class="title function_">scale</span>(<span class="number">0.5</span>) <span class="comment">// é¢œè‰²ç¼©æ”¾</span></span><br><span class="line">    <span class="keyword">const</span> lerp = <span class="title class_">Color3</span>.<span class="title class_">Lerp</span>(red, blue, <span class="number">0.5</span>) <span class="comment">// é¢œè‰²æ’å€¼</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Color4 (å¸¦é€æ˜åº¦)</span></span><br><span class="line">    <span class="keyword">const</span> transparent = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.5</span>) <span class="comment">// åŠé€æ˜çº¢è‰²</span></span><br><span class="line">    <span class="keyword">const</span> fromColor3 = <span class="keyword">new</span> <span class="title class_">Color4</span>(red.<span class="property">r</span>, red.<span class="property">g</span>, red.<span class="property">b</span>, <span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é¢œè‰²è½¬æ¢</span></span><br><span class="line">    <span class="keyword">const</span> toHex = red.<span class="title function_">toHexString</span>() <span class="comment">// è½¬ä¸ºåå…­è¿›åˆ¶</span></span><br><span class="line">    <span class="keyword">const</span> toHSV = red.<span class="title function_">toHSV</span>() <span class="comment">// è½¬ä¸ºHSV</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; red, fromHex, fromHSV, added, lerp, transparent, toHex &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ğŸ¬-Engine-å¼•æ“è¯¦è§£"><a href="#ğŸ¬-Engine-å¼•æ“è¯¦è§£" class="headerlink" title="ğŸ¬ Engine å¼•æ“è¯¦è§£"></a>ğŸ¬ Engine å¼•æ“è¯¦è§£</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Engine å¼•æ“ç³»ç»Ÿå®Œæ•´é…ç½®</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EngineManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">canvas, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span> = canvas</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span> = <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engineOptions</span> = <span class="variable language_">this</span>.<span class="title function_">getDefaultOptions</span>(options)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">init</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getDefaultOptions</span>(<span class="params">userOptions</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// antialias: boolean - æŠ—é”¯é½¿</span></span><br><span class="line">        <span class="attr">antialias</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// preserveDrawingBuffer: boolean - ä¿ç•™ç»˜åˆ¶ç¼“å†²åŒº</span></span><br><span class="line">        <span class="attr">preserveDrawingBuffer</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// stencil: boolean - å¯ç”¨æ¨¡æ¿ç¼“å†²åŒº</span></span><br><span class="line">        <span class="attr">stencil</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// alpha: boolean - å¯ç”¨é€æ˜åº¦</span></span><br><span class="line">        <span class="attr">alpha</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// premultipliedAlpha: boolean - é¢„ä¹˜é€æ˜åº¦</span></span><br><span class="line">        <span class="attr">premultipliedAlpha</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// powerPreference: string - GPUåŠŸè€—åå¥½</span></span><br><span class="line">        <span class="attr">powerPreference</span>: <span class="string">&#x27;high-performance&#x27;</span>, <span class="comment">// &#x27;default&#x27;, &#x27;high-performance&#x27;, &#x27;low-power&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// failIfMajorPerformanceCaveat: boolean - æ€§èƒ½è­¦å‘Šæ—¶å¤±è´¥</span></span><br><span class="line">        <span class="attr">failIfMajorPerformanceCaveat</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// doNotHandleContextLost: boolean - ä¸å¤„ç†ä¸Šä¸‹æ–‡ä¸¢å¤±</span></span><br><span class="line">        <span class="attr">doNotHandleContextLost</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// audioEngine: boolean - å¯ç”¨éŸ³é¢‘å¼•æ“</span></span><br><span class="line">        <span class="attr">audioEngine</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// disableWebGL2Support: boolean - ç¦ç”¨WebGL2</span></span><br><span class="line">        <span class="attr">disableWebGL2Support</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// xrCompatible: boolean - WebXRå…¼å®¹</span></span><br><span class="line">        <span class="attr">xrCompatible</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// useHighPrecisionFloats: boolean - ä½¿ç”¨é«˜ç²¾åº¦æµ®ç‚¹æ•°</span></span><br><span class="line">        <span class="attr">useHighPrecisionFloats</span>: <span class="literal">false</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      userOptions,</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// åˆ›å»ºå¼•æ“</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">engine</span> = <span class="keyword">new</span> <span class="title class_">Engine</span>(<span class="variable language_">this</span>.<span class="property">canvas</span>, <span class="variable language_">this</span>.<span class="property">engineOptions</span>.<span class="property">antialias</span>, <span class="variable language_">this</span>.<span class="property">engineOptions</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// è®¾ç½®å¼•æ“å±æ€§</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">configureEngine</span>()</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ç»‘å®šäº‹ä»¶</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">bindEvents</span>()</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;BabylonJS Engine åˆå§‹åŒ–æˆåŠŸ&#x27;</span>)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;WebGLç‰ˆæœ¬:&#x27;</span>, <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">webGLVersion</span>)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;GPUä¿¡æ¯:&#x27;</span>, <span class="variable language_">this</span>.<span class="title function_">getGPUInfo</span>())</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;å¼•æ“åˆå§‹åŒ–å¤±è´¥:&#x27;</span>, error)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleInitError</span>(error)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">configureEngine</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®æ¸²æŸ“ç²¾åº¦</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ§åˆ¶æ¸²æŸ“ç²¾åº¦ï¼Œå½±å“æ€§èƒ½å’Œè´¨é‡</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">setHardwareScalingLevel</span>(<span class="number">1.0</span>) <span class="comment">// 1.0 = åŸç”Ÿåˆ†è¾¨ç‡ï¼Œ0.5 = ä¸€åŠåˆ†è¾¨ç‡</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®è§†å£</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å®šä¹‰æ¸²æŸ“åŒºåŸŸ</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">setViewport</span>(<span class="keyword">new</span> <span class="title class_">Viewport</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯ç”¨è‡ªé€‚åº”è®¾å¤‡åƒç´ æ¯”</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è‡ªåŠ¨é€‚é…é«˜DPIæ˜¾ç¤ºå™¨</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">enableAdaptiveDevicePixelRatio</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®æœ€å¤§çº¹ç†å¤§å°</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é™åˆ¶çº¹ç†å¤§å°ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">getCaps</span>().<span class="property">maxTextureSize</span> = <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">getCaps</span>().<span class="property">maxTextureSize</span>, <span class="number">4096</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯ç”¨æ·±åº¦æµ‹è¯•</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ­£ç¡®å¤„ç†ç‰©ä½“å‰åå…³ç³»</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">setDepthFunction</span>(<span class="title class_">Engine</span>.<span class="property">LEQUAL</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®é»˜è®¤æè´¨</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ä¸ºæ²¡æœ‰æè´¨çš„ç½‘æ ¼æä¾›é»˜è®¤æè´¨</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">createDefaultRenderingPipeline</span> = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">bindEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ä¸Šä¸‹æ–‡ä¸¢å¤±äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">onContextLostObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;WebGLä¸Šä¸‹æ–‡ä¸¢å¤±&#x27;</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleContextLost</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸Šä¸‹æ–‡æ¢å¤äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">onContextRestoredObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;WebGLä¸Šä¸‹æ–‡å·²æ¢å¤&#x27;</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleContextRestored</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¼€å§‹æ¸²æŸ“äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">onBeginFrameObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onBeginFrame</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»“æŸæ¸²æŸ“äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">onEndFrameObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onEndFrame</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çª—å£å¤§å°å˜åŒ–</span></span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;resize&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleResize</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é¡µé¢å¯è§æ€§å˜åŒ–</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;visibilitychange&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleVisibilityChange</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¸²æŸ“å¾ªç¯ç®¡ç†</span></span><br><span class="line">  <span class="title function_">startRenderLoop</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">runRenderLoop</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (scene.<span class="property">activeCamera</span>) &#123;</span><br><span class="line">        scene.<span class="title function_">render</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">stopRenderLoop</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">stopRenderLoop</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ€§èƒ½ç›‘æ§</span></span><br><span class="line">  <span class="title function_">enablePerformanceMonitoring</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// FPSç›‘æ§</span></span><br><span class="line">    <span class="keyword">const</span> fpsCounter = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    fpsCounter.<span class="property">style</span>.<span class="property">position</span> = <span class="string">&#x27;absolute&#x27;</span></span><br><span class="line">    fpsCounter.<span class="property">style</span>.<span class="property">top</span> = <span class="string">&#x27;10px&#x27;</span></span><br><span class="line">    fpsCounter.<span class="property">style</span>.<span class="property">left</span> = <span class="string">&#x27;10px&#x27;</span></span><br><span class="line">    fpsCounter.<span class="property">style</span>.<span class="property">color</span> = <span class="string">&#x27;white&#x27;</span></span><br><span class="line">    fpsCounter.<span class="property">style</span>.<span class="property">fontFamily</span> = <span class="string">&#x27;monospace&#x27;</span></span><br><span class="line">    fpsCounter.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;rgba(0,0,0,0.5)&#x27;</span></span><br><span class="line">    fpsCounter.<span class="property">style</span>.<span class="property">padding</span> = <span class="string">&#x27;5px&#x27;</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(fpsCounter)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">onEndFrameObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> fps = <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">getFps</span>()</span><br><span class="line">      <span class="keyword">const</span> deltaTime = <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">getDeltaTime</span>()</span><br><span class="line">      fpsCounter.<span class="property">textContent</span> = <span class="string">`FPS: <span class="subst">$&#123;fps.toFixed(<span class="number">1</span>)&#125;</span> | Delta: <span class="subst">$&#123;deltaTime.toFixed(<span class="number">2</span>)&#125;</span>ms`</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ€§èƒ½åˆ†æ</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">enablePerformanceMonitoring</span> = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–å¼•æ“ä¿¡æ¯</span></span><br><span class="line">  <span class="title function_">getEngineInfo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> caps = <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">getCaps</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="comment">// åŸºç¡€ä¿¡æ¯</span></span><br><span class="line">      <span class="attr">webGLVersion</span>: <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">webGLVersion</span>,</span><br><span class="line">      <span class="attr">isWebGL2</span>: <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">isWebGL2</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ç¡¬ä»¶ä¿¡æ¯</span></span><br><span class="line">      <span class="attr">maxTextureSize</span>: caps.<span class="property">maxTextureSize</span>,</span><br><span class="line">      <span class="attr">maxCubeTextureSize</span>: caps.<span class="property">maxCubeTextureSize</span>,</span><br><span class="line">      <span class="attr">maxRenderTextureSize</span>: caps.<span class="property">maxRenderTextureSize</span>,</span><br><span class="line">      <span class="attr">maxVertexAttribs</span>: caps.<span class="property">maxVertexAttribs</span>,</span><br><span class="line">      <span class="attr">maxVaryingVectors</span>: caps.<span class="property">maxVaryingVectors</span>,</span><br><span class="line">      <span class="attr">maxFragmentUniformVectors</span>: caps.<span class="property">maxFragmentUniformVectors</span>,</span><br><span class="line">      <span class="attr">maxVertexUniformVectors</span>: caps.<span class="property">maxVertexUniformVectors</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ‰©å±•æ”¯æŒ</span></span><br><span class="line">      <span class="attr">standardDerivatives</span>: caps.<span class="property">standardDerivatives</span>,</span><br><span class="line">      <span class="attr">textureFloat</span>: caps.<span class="property">textureFloat</span>,</span><br><span class="line">      <span class="attr">textureHalfFloat</span>: caps.<span class="property">textureHalfFloat</span>,</span><br><span class="line">      <span class="attr">textureAnisotropicFilterExtension</span>: caps.<span class="property">textureAnisotropicFilterExtension</span>,</span><br><span class="line">      <span class="attr">instancedArrays</span>: caps.<span class="property">instancedArrays</span>,</span><br><span class="line">      <span class="attr">uintIndices</span>: caps.<span class="property">uintIndices</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ¸²æŸ“ä¿¡æ¯</span></span><br><span class="line">      <span class="attr">hardwareScalingLevel</span>: <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">getHardwareScalingLevel</span>(),</span><br><span class="line">      <span class="attr">loadedTexturesCache</span>: <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">getLoadedTexturesCache</span>().<span class="property">length</span>,</span><br><span class="line">      <span class="attr">activeRenderLoops</span>: <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">activeRenderLoops</span>.<span class="property">length</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// GPUä¿¡æ¯</span></span><br><span class="line">  <span class="title function_">getGPUInfo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> gl = <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">_gl</span></span><br><span class="line">    <span class="keyword">const</span> debugInfo = gl.<span class="title function_">getExtension</span>(<span class="string">&#x27;WEBGL_debug_renderer_info&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (debugInfo) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">vendor</span>: gl.<span class="title function_">getParameter</span>(debugInfo.<span class="property">UNMASKED_VENDOR_WEBGL</span>),</span><br><span class="line">        <span class="attr">renderer</span>: gl.<span class="title function_">getParameter</span>(debugInfo.<span class="property">UNMASKED_RENDERER_WEBGL</span>),</span><br><span class="line">        <span class="attr">version</span>: gl.<span class="title function_">getParameter</span>(gl.<span class="property">VERSION</span>),</span><br><span class="line">        <span class="attr">shadingLanguageVersion</span>: gl.<span class="title function_">getParameter</span>(gl.<span class="property">SHADING_LANGUAGE_VERSION</span>),</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">vendor</span>: gl.<span class="title function_">getParameter</span>(gl.<span class="property">VENDOR</span>),</span><br><span class="line">      <span class="attr">renderer</span>: gl.<span class="title function_">getParameter</span>(gl.<span class="property">RENDERER</span>),</span><br><span class="line">      <span class="attr">version</span>: gl.<span class="title function_">getParameter</span>(gl.<span class="property">VERSION</span>),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// äº‹ä»¶å¤„ç†</span></span><br><span class="line">  <span class="title function_">handleContextLost</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// åœæ­¢æ¸²æŸ“å¾ªç¯</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">stopRenderLoop</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¾ç¤ºåŠ è½½æç¤º</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">showContextLostMessage</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">handleContextRestored</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// éšè—åŠ è½½æç¤º</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">hideContextLostMessage</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡æ–°å¼€å§‹æ¸²æŸ“</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">scene</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">startRenderLoop</span>(<span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">handleResize</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// å»¶è¿Ÿæ‰§è¡Œï¼Œé¿å…é¢‘ç¹è°ƒç”¨</span></span><br><span class="line">    <span class="built_in">clearTimeout</span>(<span class="variable language_">this</span>.<span class="property">resizeTimeout</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">resizeTimeout</span> = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">resize</span>()</span><br><span class="line">    &#125;, <span class="number">100</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">handleVisibilityChange</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">hidden</span>) &#123;</span><br><span class="line">      <span class="comment">// é¡µé¢éšè—æ—¶æš‚åœæ¸²æŸ“</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">stopRenderLoop</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// é¡µé¢æ˜¾ç¤ºæ—¶æ¢å¤æ¸²æŸ“</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">scene</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">startRenderLoop</span>(<span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">handleInitError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="comment">// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">const</span> errorDiv = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    errorDiv.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">      &lt;div style=&quot;position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); </span></span><br><span class="line"><span class="string">                  background: rgba(255,0,0,0.8); color: white; padding: 20px; border-radius: 10px;&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;h3&gt;BabylonJS åˆå§‹åŒ–å¤±è´¥&lt;/h3&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;é”™è¯¯ä¿¡æ¯: <span class="subst">$&#123;error.message&#125;</span>&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;è¯·æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒWebGL&lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;/div&gt;</span></span><br><span class="line"><span class="string">    `</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(errorDiv)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onBeginFrame</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// æ¯å¸§å¼€å§‹æ—¶çš„å¤„ç†</span></span><br><span class="line">    <span class="comment">// å¯ä»¥åœ¨è¿™é‡Œè¿›è¡Œæ€§èƒ½ç»Ÿè®¡ã€èµ„æºç®¡ç†ç­‰</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onEndFrame</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// æ¯å¸§ç»“æŸæ—¶çš„å¤„ç†</span></span><br><span class="line">    <span class="comment">// å¯ä»¥åœ¨è¿™é‡Œè¿›è¡Œæ¸…ç†å·¥ä½œã€ç»Ÿè®¡ä¿¡æ¯æ›´æ–°ç­‰</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">showContextLostMessage</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> messageDiv = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    messageDiv.<span class="property">id</span> = <span class="string">&#x27;context-lost-message&#x27;</span></span><br><span class="line">    messageDiv.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">      &lt;div style=&quot;position: fixed; top: 0; left: 0; width: 100%; height: 100%; </span></span><br><span class="line"><span class="string">                  background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999;&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div style=&quot;background: white; padding: 20px; border-radius: 10px; text-align: center;&quot;&gt;</span></span><br><span class="line"><span class="string">          &lt;h3&gt;è¿æ¥ä¸¢å¤±&lt;/h3&gt;</span></span><br><span class="line"><span class="string">          &lt;p&gt;æ­£åœ¨å°è¯•é‡æ–°è¿æ¥...&lt;/p&gt;</span></span><br><span class="line"><span class="string">          &lt;div class=&quot;spinner&quot; style=&quot;margin: 10px auto; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 2s linear infinite;&quot;&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">      &lt;/div&gt;</span></span><br><span class="line"><span class="string">    `</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(messageDiv)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">hideContextLostMessage</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> messageDiv = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;context-lost-message&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> (messageDiv) &#123;</span><br><span class="line">      messageDiv.<span class="title function_">remove</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// èµ„æºæ¸…ç†</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// åœæ­¢æ¸²æŸ“å¾ªç¯</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">stopRenderLoop</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç§»é™¤äº‹ä»¶ç›‘å¬</span></span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;resize&#x27;</span>, <span class="variable language_">this</span>.<span class="property">handleResize</span>)</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;visibilitychange&#x27;</span>, <span class="variable language_">this</span>.<span class="property">handleVisibilityChange</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç†å¼•æ“</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">engine</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">dispose</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">engine</span> = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> canvas = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;babylonCanvas&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> engineManager = <span class="keyword">new</span> <span class="title class_">EngineManager</span>(canvas, &#123;</span><br><span class="line">  <span class="attr">antialias</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">preserveDrawingBuffer</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">powerPreference</span>: <span class="string">&#x27;high-performance&#x27;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯ç”¨æ€§èƒ½ç›‘æ§</span></span><br><span class="line">engineManager.<span class="title function_">enablePerformanceMonitoring</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å¼•æ“ä¿¡æ¯</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å¼•æ“ä¿¡æ¯:&#x27;</span>, engineManager.<span class="title function_">getEngineInfo</span>())</span><br></pre></td></tr></table></figure><h2 id="ğŸ­-Scene-åœºæ™¯è¯¦è§£"><a href="#ğŸ­-Scene-åœºæ™¯è¯¦è§£" class="headerlink" title="ğŸ­ Scene åœºæ™¯è¯¦è§£"></a>ğŸ­ Scene åœºæ™¯è¯¦è§£</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Scene åœºæ™¯ç³»ç»Ÿå®Œæ•´ç®¡ç†</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SceneManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">engine</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span> = engine</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sceneOptions</span> = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">init</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºåœºæ™¯</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = <span class="keyword">new</span> <span class="title class_">Scene</span>(<span class="variable language_">this</span>.<span class="property">engine</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é…ç½®åœºæ™¯</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">configureScene</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®ç¯å¢ƒ</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupEnvironment</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»‘å®šäº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">bindEvents</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">configureScene</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ç‰©ç†å¼•æ“é…ç½®</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¯ç”¨ç‰©ç†æ¨¡æ‹Ÿ</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">enablePhysics</span>(<span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, -<span class="number">9.81</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">CannonJSPlugin</span>())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¢°æ’æ£€æµ‹</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¯ç”¨ç½‘æ ¼é—´ç¢°æ’æ£€æµ‹</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">collisionsEnabled</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡åŠ›è®¾ç½®</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è®¾ç½®åœºæ™¯é‡åŠ›</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">gravity</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, -<span class="number">0.9</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŠ¨ç”»é€Ÿåº¦</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ§åˆ¶åŠ¨ç”»æ’­æ”¾é€Ÿåº¦å€ç‡</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">animationTimeScale</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸²æŸ“ç»„</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ§åˆ¶æ¸²æŸ“é¡ºåº</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">setRenderingOrder</span>(</span><br><span class="line">      <span class="number">0</span>, <span class="comment">// opaque sorting</span></span><br><span class="line">      <span class="number">1</span>, <span class="comment">// alpha test sorting</span></span><br><span class="line">      <span class="number">2</span>,</span><br><span class="line">    ) <span class="comment">// transparent sorting</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è‡ªåŠ¨æ¸…ç†</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è‡ªåŠ¨æ¸…ç†æœªä½¿ç”¨çš„èµ„æº</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">autoClear</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">autoClearDepthAndStencil</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// LOD (Level of Detail) é…ç½®</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è·ç¦»ç›¸å…³çš„ç»†èŠ‚å±‚æ¬¡</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">lodGenerationOffset</span> = <span class="number">0.5</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">lodGenerationTransitionTime</span> = <span class="number">250</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupEnvironment</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ç¯å¢ƒçº¹ç†</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupEnvironmentTexture</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é›¾æ•ˆ</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupFog</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤©ç©ºç›’</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupSkybox</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…¨å±€å…‰ç…§</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupGlobalIllumination</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupEnvironmentTexture</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// HDRç¯å¢ƒçº¹ç†</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æä¾›çœŸå®çš„ç¯å¢ƒå…‰ç…§å’Œåå°„</span></span><br><span class="line">    <span class="keyword">const</span> hdrTexture = <span class="title class_">CubeTexture</span>.<span class="title class_">CreateFromPrefilteredData</span>(</span><br><span class="line">      <span class="string">&#x27;/environments/environment.dds&#x27;</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">    )</span><br><span class="line">    hdrTexture.<span class="property">name</span> = <span class="string">&#x27;environmentTexture&#x27;</span></span><br><span class="line">    hdrTexture.<span class="property">gammaSpace</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">environmentTexture</span> = hdrTexture</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">createDefaultSkybox</span>(hdrTexture, <span class="literal">true</span>, <span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¯å¢ƒå¼ºåº¦</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">environmentIntensity</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// IBL (Image Based Lighting)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">imageProcessingConfiguration</span>.<span class="property">exposure</span> = <span class="number">1.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">imageProcessingConfiguration</span>.<span class="property">contrast</span> = <span class="number">1.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">imageProcessingConfiguration</span>.<span class="property">toneMappingEnabled</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">imageProcessingConfiguration</span>.<span class="property">toneMappingType</span> =</span><br><span class="line">      <span class="title class_">ImageProcessingConfiguration</span>.<span class="property">TONEMAPPING_ACES</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupFog</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// é›¾æ•ˆç±»å‹</span></span><br><span class="line">    <span class="comment">// FOG_NONE: æ— é›¾</span></span><br><span class="line">    <span class="comment">// FOG_EXP: æŒ‡æ•°é›¾</span></span><br><span class="line">    <span class="comment">// FOG_EXP2: äºŒæ¬¡æŒ‡æ•°é›¾</span></span><br><span class="line">    <span class="comment">// FOG_LINEAR: çº¿æ€§é›¾</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">fogMode</span> = <span class="title class_">Scene</span>.<span class="property">FOGMODE_LINEAR</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é›¾çš„é¢œè‰²</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">fogColor</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.9</span>, <span class="number">0.9</span>, <span class="number">0.85</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çº¿æ€§é›¾å‚æ•°</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">fogStart</span> = <span class="number">20.0</span> <span class="comment">// é›¾å¼€å§‹è·ç¦»</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">fogEnd</span> = <span class="number">60.0</span> <span class="comment">// é›¾ç»“æŸè·ç¦»</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‡æ•°é›¾å‚æ•°ï¼ˆå½“ä½¿ç”¨æŒ‡æ•°é›¾æ—¶ï¼‰</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">fogDensity</span> = <span class="number">0.01</span> <span class="comment">// é›¾å¯†åº¦</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupSkybox</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ç¨‹åºåŒ–å¤©ç©ºç›’</span></span><br><span class="line">    <span class="keyword">const</span> skybox = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateSphere</span>(<span class="string">&#x27;skyBox&#x27;</span>, &#123; <span class="attr">diameter</span>: <span class="number">1000</span> &#125;, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="keyword">const</span> skyboxMaterial = <span class="keyword">new</span> <span class="title class_">StandardMaterial</span>(<span class="string">&#x27;skyBox&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤©ç©ºç›’æè´¨é…ç½®</span></span><br><span class="line">    skyboxMaterial.<span class="property">backFaceCulling</span> = <span class="literal">false</span></span><br><span class="line">    skyboxMaterial.<span class="property">reflectionTexture</span> = <span class="keyword">new</span> <span class="title class_">CubeTexture</span>(<span class="string">&#x27;/textures/skybox/skybox&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    skyboxMaterial.<span class="property">reflectionTexture</span>.<span class="property">coordinatesMode</span> = <span class="title class_">Texture</span>.<span class="property">SKYBOX_MODE</span></span><br><span class="line">    skyboxMaterial.<span class="property">diffuseColor</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    skyboxMaterial.<span class="property">specularColor</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    skybox.<span class="property">material</span> = skyboxMaterial</span><br><span class="line">    skybox.<span class="property">infiniteDistance</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> skybox</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupGlobalIllumination</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// å›¾åƒå¤„ç†é…ç½®</span></span><br><span class="line">    <span class="keyword">const</span> imageProcessing = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">imageProcessingConfiguration</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è‰²è°ƒæ˜ å°„</span></span><br><span class="line">    imageProcessing.<span class="property">toneMappingEnabled</span> = <span class="literal">true</span></span><br><span class="line">    imageProcessing.<span class="property">toneMappingType</span> = <span class="title class_">ImageProcessingConfiguration</span>.<span class="property">TONEMAPPING_ACES</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ›å…‰åº¦</span></span><br><span class="line">    imageProcessing.<span class="property">exposure</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯¹æ¯”åº¦</span></span><br><span class="line">    imageProcessing.<span class="property">contrast</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è‰²å½©å¹³è¡¡</span></span><br><span class="line">    imageProcessing.<span class="property">colorGradingEnabled</span> = <span class="literal">true</span></span><br><span class="line">    imageProcessing.<span class="property">colorGradingTexture</span> = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;/textures/colorgrading_lut.png&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Bloomæ•ˆæœ</span></span><br><span class="line">    imageProcessing.<span class="property">vignetteEnabled</span> = <span class="literal">true</span></span><br><span class="line">    imageProcessing.<span class="property">vignetteWeight</span> = <span class="number">1.5</span></span><br><span class="line">    imageProcessing.<span class="property">vignetteStretch</span> = <span class="number">0.5</span></span><br><span class="line">    imageProcessing.<span class="property">vignetteCameraFov</span> = <span class="number">0.5</span></span><br><span class="line">    imageProcessing.<span class="property">vignetteColor</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">bindEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// åœºæ™¯å‡†å¤‡å°±ç»ª</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onReadyObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;åœºæ™¯å‡†å¤‡å°±ç»ª&#x27;</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onSceneReady</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸²æŸ“å‰äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onBeforeRender</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸²æŸ“åäº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onAfterRenderObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onAfterRender</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç›¸æœºå˜åŒ–äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onActiveCameraChanged</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onActiveCameraChanged</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–°ç½‘æ ¼æ·»åŠ äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onNewMeshAddedObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onNewMeshAdded</span>(mesh)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç½‘æ ¼ç§»é™¤äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onMeshRemovedObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onMeshRemoved</span>(mesh)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‡é’ˆäº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">actionManager</span> = <span class="keyword">new</span> <span class="title class_">ActionManager</span>(<span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupPointerEvents</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupPointerEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// é¼ æ ‡ç‚¹å‡»äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onPointerObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">pointerInfo</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">switch</span> (pointerInfo.<span class="property">type</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">PointerEventTypes</span>.<span class="property">POINTERDOWN</span>:</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onPointerDown</span>(pointerInfo)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">PointerEventTypes</span>.<span class="property">POINTERUP</span>:</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onPointerUp</span>(pointerInfo)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">PointerEventTypes</span>.<span class="property">POINTERMOVE</span>:</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onPointerMove</span>(pointerInfo)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">PointerEventTypes</span>.<span class="property">POINTERWHEEL</span>:</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onPointerWheel</span>(pointerInfo)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‹¾å–ä¿¡æ¯</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onPointerPick</span> = <span class="function">(<span class="params">evt, pickInfo</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (pickInfo.<span class="property">hit</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ‹¾å–åˆ°ç½‘æ ¼:&#x27;</span>, pickInfo.<span class="property">pickedMesh</span>?.<span class="property">name</span>)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">onMeshPicked</span>(pickInfo.<span class="property">pickedMesh</span>, pickInfo.<span class="property">pickedPoint</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœºæ™¯ä¼˜åŒ–</span></span><br><span class="line">  <span class="title function_">optimizeScene</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// åˆå¹¶ç½‘æ ¼</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">mergeMeshes</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®æ¸²æŸ“ç»„</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupRenderingGroups</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯ç”¨å®ä¾‹åŒ–</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">enableInstancing</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®LOD</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupLevelOfDetail</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†»ç»“å˜æ¢çŸ©é˜µ</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">freezeTransformMatrices</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">mergeMeshes</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// åˆå¹¶é™æ€ç½‘æ ¼ä»¥å‡å°‘ç»˜åˆ¶è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">const</span> staticMeshes = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">meshes</span>.<span class="title function_">filter</span>(</span><br><span class="line">      <span class="function">(<span class="params">mesh</span>) =&gt;</span> mesh.<span class="property">name</span>.<span class="title function_">startsWith</span>(<span class="string">&#x27;static_&#x27;</span>) &amp;&amp; !mesh.<span class="property">skeleton</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (staticMeshes.<span class="property">length</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> merged = <span class="title class_">Mesh</span>.<span class="title class_">MergeMeshes</span>(staticMeshes, <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">true</span>)</span><br><span class="line">      <span class="keyword">if</span> (merged) &#123;</span><br><span class="line">        merged.<span class="property">name</span> = <span class="string">&#x27;merged_static_meshes&#x27;</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`åˆå¹¶äº† <span class="subst">$&#123;staticMeshes.length&#125;</span> ä¸ªé™æ€ç½‘æ ¼`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupRenderingGroups</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// æ¸²æŸ“ç»„ï¼š0-ä¸é€æ˜ç‰©ä½“ï¼Œ1-é€æ˜ç‰©ä½“ï¼Œ2-UIå…ƒç´ </span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (mesh.<span class="property">material</span> &amp;&amp; mesh.<span class="property">material</span>.<span class="property">alpha</span> &lt; <span class="number">1.0</span>) &#123;</span><br><span class="line">        mesh.<span class="property">renderingGroupId</span> = <span class="number">1</span> <span class="comment">// é€æ˜ç‰©ä½“</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mesh.<span class="property">renderingGroupId</span> = <span class="number">0</span> <span class="comment">// ä¸é€æ˜ç‰©ä½“</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">enableInstancing</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ä¸ºé‡å¤çš„ç½‘æ ¼å¯ç”¨å®ä¾‹åŒ–</span></span><br><span class="line">    <span class="keyword">const</span> trees = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">meshes</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> mesh.<span class="property">name</span>.<span class="title function_">includes</span>(<span class="string">&#x27;tree&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> (trees.<span class="property">length</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> sourceMesh = trees[<span class="number">0</span>]</span><br><span class="line">      <span class="keyword">const</span> instances = []</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; trees.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> instance = sourceMesh.<span class="title function_">createInstance</span>(<span class="string">`tree_instance_<span class="subst">$&#123;i&#125;</span>`</span>)</span><br><span class="line">        instance.<span class="property">position</span> = trees[i].<span class="property">position</span></span><br><span class="line">        instance.<span class="property">rotation</span> = trees[i].<span class="property">rotation</span></span><br><span class="line">        instance.<span class="property">scaling</span> = trees[i].<span class="property">scaling</span></span><br><span class="line">        instances.<span class="title function_">push</span>(instance)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç§»é™¤åŸå§‹ç½‘æ ¼</span></span><br><span class="line">        trees[i].<span class="title function_">dispose</span>()</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`åˆ›å»ºäº† <span class="subst">$&#123;instances.length&#125;</span> ä¸ªæ ‘æœ¨å®ä¾‹`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupLevelOfDetail</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ä¸ºå¤§å‹ç½‘æ ¼è®¾ç½®LOD</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (mesh.<span class="title function_">getTotalVertices</span>() &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºç®€åŒ–ç‰ˆæœ¬</span></span><br><span class="line">        <span class="keyword">const</span> lod1 = mesh.<span class="title function_">clone</span>(<span class="string">`<span class="subst">$&#123;mesh.name&#125;</span>_lod1`</span>)</span><br><span class="line">        <span class="keyword">const</span> lod2 = mesh.<span class="title function_">clone</span>(<span class="string">`<span class="subst">$&#123;mesh.name&#125;</span>_lod2`</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿™é‡Œåº”è¯¥ä½¿ç”¨ç®€åŒ–ç®—æ³•åˆ›å»ºä½æ¨¡</span></span><br><span class="line">        <span class="comment">// ç¤ºä¾‹ï¼šå¯ä»¥é›†æˆç¬¬ä¸‰æ–¹ç®€åŒ–åº“</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®LODè·ç¦»</span></span><br><span class="line">        mesh.<span class="title function_">addLODLevel</span>(<span class="number">50</span>, lod1)</span><br><span class="line">        mesh.<span class="title function_">addLODLevel</span>(<span class="number">100</span>, lod2)</span><br><span class="line">        mesh.<span class="title function_">addLODLevel</span>(<span class="number">200</span>, <span class="literal">null</span>) <span class="comment">// å®Œå…¨éšè—</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">freezeTransformMatrices</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// å†»ç»“ä¸å†ç§»åŠ¨çš„ç½‘æ ¼çš„å˜æ¢çŸ©é˜µ</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (mesh.<span class="property">name</span>.<span class="title function_">includes</span>(<span class="string">&#x27;static_&#x27;</span>) || mesh.<span class="property">name</span>.<span class="title function_">includes</span>(<span class="string">&#x27;building_&#x27;</span>)) &#123;</span><br><span class="line">        mesh.<span class="title function_">freezeWorldMatrix</span>()</span><br><span class="line">        mesh.<span class="property">doNotSyncBoundingInfo</span> = <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœºæ™¯åºåˆ—åŒ–å’ŒåŠ è½½</span></span><br><span class="line">  <span class="title function_">serializeScene</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// åºåˆ—åŒ–åœºæ™¯ä¸ºJSON</span></span><br><span class="line">    <span class="keyword">const</span> serializedScene = <span class="title class_">SceneSerializer</span>.<span class="title class_">Serialize</span>(<span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨</span></span><br><span class="line">    <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;babylonjs_scene&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(serializedScene))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> serializedScene</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadScene</span>(<span class="params">sceneData</span>) &#123;</span><br><span class="line">    <span class="comment">// ä»åºåˆ—åŒ–æ•°æ®åŠ è½½åœºæ™¯</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> sceneData === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">      sceneData = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(sceneData)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç†å½“å‰åœºæ™¯</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">dispose</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºæ–°åœºæ™¯</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = <span class="keyword">new</span> <span class="title class_">Scene</span>(<span class="variable language_">this</span>.<span class="property">engine</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯¼å…¥åºåˆ—åŒ–æ•°æ®</span></span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">SceneLoader</span>.<span class="title class_">ImportMeshAsync</span>(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, sceneData, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡æ–°é…ç½®åœºæ™¯</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">configureScene</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">bindEvents</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// äº‹ä»¶å›è°ƒ</span></span><br><span class="line">  <span class="title function_">onSceneReady</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// åœºæ™¯å‡†å¤‡å°±ç»ªåçš„å¤„ç†</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">optimizeScene</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onBeforeRender</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// æ¯å¸§æ¸²æŸ“å‰çš„å¤„ç†</span></span><br><span class="line">    <span class="comment">// å¯ä»¥åœ¨è¿™é‡Œæ›´æ–°åŠ¨ç”»ã€ç‰©ç†ç­‰</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onAfterRender</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// æ¯å¸§æ¸²æŸ“åçš„å¤„ç†</span></span><br><span class="line">    <span class="comment">// å¯ä»¥åœ¨è¿™é‡Œè¿›è¡Œåå¤„ç†ã€UIæ›´æ–°ç­‰</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onActiveCameraChanged</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ç›¸æœºåˆ‡æ¢æ—¶çš„å¤„ç†</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ´»åŠ¨ç›¸æœºå·²åˆ‡æ¢:&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">activeCamera</span>?.<span class="property">name</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onNewMeshAdded</span>(<span class="params">mesh</span>) &#123;</span><br><span class="line">    <span class="comment">// æ–°ç½‘æ ¼æ·»åŠ æ—¶çš„å¤„ç†</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ–°ç½‘æ ¼å·²æ·»åŠ :&#x27;</span>, mesh.<span class="property">name</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è‡ªåŠ¨è®¾ç½®ç‰©ç†å±æ€§</span></span><br><span class="line">    <span class="keyword">if</span> (mesh.<span class="property">name</span>.<span class="title function_">includes</span>(<span class="string">&#x27;physics_&#x27;</span>)) &#123;</span><br><span class="line">      mesh.<span class="property">physicsImpostor</span> = <span class="keyword">new</span> <span class="title class_">PhysicsImpostor</span>(</span><br><span class="line">        mesh,</span><br><span class="line">        <span class="title class_">PhysicsImpostor</span>.<span class="property">BoxImpostor</span>,</span><br><span class="line">        &#123; <span class="attr">mass</span>: <span class="number">1</span> &#125;,</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onMeshRemoved</span>(<span class="params">mesh</span>) &#123;</span><br><span class="line">    <span class="comment">// ç½‘æ ¼ç§»é™¤æ—¶çš„å¤„ç†</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç½‘æ ¼å·²ç§»é™¤:&#x27;</span>, mesh.<span class="property">name</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onPointerDown</span>(<span class="params">pointerInfo</span>) &#123;</span><br><span class="line">    <span class="comment">// é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶å¤„ç†</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onPointerUp</span>(<span class="params">pointerInfo</span>) &#123;</span><br><span class="line">    <span class="comment">// é¼ æ ‡é‡Šæ”¾äº‹ä»¶å¤„ç†</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onPointerMove</span>(<span class="params">pointerInfo</span>) &#123;</span><br><span class="line">    <span class="comment">// é¼ æ ‡ç§»åŠ¨äº‹ä»¶å¤„ç†</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onPointerWheel</span>(<span class="params">pointerInfo</span>) &#123;</span><br><span class="line">    <span class="comment">// é¼ æ ‡æ»šè½®äº‹ä»¶å¤„ç†</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onMeshPicked</span>(<span class="params">mesh, pickPoint</span>) &#123;</span><br><span class="line">    <span class="comment">// ç½‘æ ¼æ‹¾å–äº‹ä»¶å¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> (mesh) &#123;</span><br><span class="line">      <span class="comment">// é«˜äº®è¢«æ‹¾å–çš„ç½‘æ ¼</span></span><br><span class="line">      mesh.<span class="property">renderOutline</span> = <span class="literal">true</span></span><br><span class="line">      mesh.<span class="property">outlineColor</span> = <span class="title class_">Color3</span>.<span class="title class_">Red</span>()</span><br><span class="line">      mesh.<span class="property">outlineWidth</span> = <span class="number">0.02</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// å–æ¶ˆå…¶ä»–ç½‘æ ¼çš„é«˜äº®</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">m</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (m !== mesh) &#123;</span><br><span class="line">          m.<span class="property">renderOutline</span> = <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// èµ„æºæ¸…ç†</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">scene</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">dispose</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span> = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> sceneManager = <span class="keyword">new</span> <span class="title class_">SceneManager</span>(engine)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åºåˆ—åŒ–åœºæ™¯</span></span><br><span class="line"><span class="keyword">const</span> sceneData = sceneManager.<span class="title function_">serializeScene</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŠ è½½åœºæ™¯</span></span><br><span class="line"><span class="comment">// sceneManager.loadScene(sceneData)</span></span><br></pre></td></tr></table></figure><h2 id="ğŸ“·-Camera-ç›¸æœºç³»ç»Ÿè¯¦è§£"><a href="#ğŸ“·-Camera-ç›¸æœºç³»ç»Ÿè¯¦è§£" class="headerlink" title="ğŸ“· Camera ç›¸æœºç³»ç»Ÿè¯¦è§£"></a>ğŸ“· Camera ç›¸æœºç³»ç»Ÿè¯¦è§£</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Camera ç›¸æœºç³»ç»Ÿå®Œæ•´ç®¡ç†</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CameraManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cameras</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">activeCamera</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupDefaultCameras</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupDefaultCameras</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// è‡ªç”±ç›¸æœº - ç¬¬ä¸€äººç§°è§†è§’</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createFreeCamera</span>(<span class="string">&#x27;freeCamera&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">5</span>, -<span class="number">10</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¼§å½¢æ—‹è½¬ç›¸æœº - ç¬¬ä¸‰äººç§°è§†è§’</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createArcRotateCamera</span>(<span class="string">&#x27;arcCamera&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€šç”¨ç›¸æœº - æ··åˆæ¨¡å¼</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createUniversalCamera</span>(<span class="string">&#x27;universalCamera&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">5</span>, -<span class="number">10</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®é»˜è®¤ç›¸æœº</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setActiveCamera</span>(<span class="string">&#x27;arcCamera&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è‡ªç”±ç›¸æœº (FreeCamera)</span></span><br><span class="line">  <span class="title function_">createFreeCamera</span>(<span class="params">name, position</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="keyword">new</span> <span class="title class_">FreeCamera</span>(name, position, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŸºç¡€é…ç½®</span></span><br><span class="line">    camera.<span class="title function_">setTarget</span>(<span class="title class_">Vector3</span>.<span class="title class_">Zero</span>())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç§»åŠ¨é€Ÿåº¦é…ç½®</span></span><br><span class="line">    <span class="comment">// speed: number - ç§»åŠ¨é€Ÿåº¦</span></span><br><span class="line">    camera.<span class="property">speed</span> = <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// angularSensibility: number - é¼ æ ‡çµæ•åº¦</span></span><br><span class="line">    camera.<span class="property">angularSensibility</span> = <span class="number">2000</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é”®ç›˜æ§åˆ¶é…ç½®</span></span><br><span class="line">    camera.<span class="property">keysUp</span> = [<span class="number">87</span>] <span class="comment">// Wé”®</span></span><br><span class="line">    camera.<span class="property">keysDown</span> = [<span class="number">83</span>] <span class="comment">// Sé”®</span></span><br><span class="line">    camera.<span class="property">keysLeft</span> = [<span class="number">65</span>] <span class="comment">// Aé”®</span></span><br><span class="line">    camera.<span class="property">keysRight</span> = [<span class="number">68</span>] <span class="comment">// Dé”®</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æƒ¯æ€§é…ç½®</span></span><br><span class="line">    <span class="comment">// inertia: number - æƒ¯æ€§ç³»æ•° (0-1)</span></span><br><span class="line">    camera.<span class="property">inertia</span> = <span class="number">0.9</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¢°æ’æ£€æµ‹</span></span><br><span class="line">    camera.<span class="property">checkCollisions</span> = <span class="literal">true</span></span><br><span class="line">    camera.<span class="property">collisionRadius</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0.5</span>, <span class="number">1.8</span>, <span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡åŠ›</span></span><br><span class="line">    camera.<span class="property">applyGravity</span> = <span class="literal">true</span></span><br><span class="line">    camera.<span class="property">needMoveForGravity</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¤­çƒä½“ç¢°æ’</span></span><br><span class="line">    camera.<span class="property">ellipsoid</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0.5</span>, <span class="number">1</span>, <span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·³è·ƒ</span></span><br><span class="line">    camera.<span class="property">setUpVector</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">set</span>(name, camera)</span><br><span class="line">    <span class="keyword">return</span> camera</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¼§å½¢æ—‹è½¬ç›¸æœº (ArcRotateCamera)</span></span><br><span class="line">  <span class="title function_">createArcRotateCamera</span>(<span class="params">name, target, radius</span>) &#123;</span><br><span class="line">    <span class="comment">// alpha: æ°´å¹³è§’åº¦ (å¼§åº¦)</span></span><br><span class="line">    <span class="comment">// beta: å‚ç›´è§’åº¦ (å¼§åº¦)</span></span><br><span class="line">    <span class="comment">// radius: è·ç¦»ç›®æ ‡çš„è·ç¦»</span></span><br><span class="line">    <span class="keyword">const</span> camera = <span class="keyword">new</span> <span class="title class_">ArcRotateCamera</span>(</span><br><span class="line">      name,</span><br><span class="line">      -<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">2</span>,</span><br><span class="line">      <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">2.5</span>,</span><br><span class="line">      radius,</span><br><span class="line">      target,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§’åº¦é™åˆ¶</span></span><br><span class="line">    camera.<span class="property">lowerAlphaLimit</span> = -<span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span> <span class="comment">// æ°´å¹³æœ€å°è§’åº¦</span></span><br><span class="line">    camera.<span class="property">upperAlphaLimit</span> = <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span> <span class="comment">// æ°´å¹³æœ€å¤§è§’åº¦</span></span><br><span class="line">    camera.<span class="property">lowerBetaLimit</span> = <span class="number">0.1</span> <span class="comment">// å‚ç›´æœ€å°è§’åº¦</span></span><br><span class="line">    camera.<span class="property">upperBetaLimit</span> = <span class="title class_">Math</span>.<span class="property">PI</span> - <span class="number">0.1</span> <span class="comment">// å‚ç›´æœ€å¤§è§’åº¦</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·ç¦»é™åˆ¶</span></span><br><span class="line">    camera.<span class="property">lowerRadiusLimit</span> = <span class="number">2</span> <span class="comment">// æœ€å°è·ç¦»</span></span><br><span class="line">    camera.<span class="property">upperRadiusLimit</span> = <span class="number">50</span> <span class="comment">// æœ€å¤§è·ç¦»</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¹³ç§»é™åˆ¶</span></span><br><span class="line">    camera.<span class="property">lowerTargetOffsetLimit</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">10</span>, -<span class="number">10</span>, -<span class="number">10</span>)</span><br><span class="line">    camera.<span class="property">upperTargetOffsetLimit</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é¼ æ ‡æ§åˆ¶é…ç½®</span></span><br><span class="line">    camera.<span class="property">angularSensibilityX</span> = <span class="number">1000</span> <span class="comment">// æ°´å¹³çµæ•åº¦</span></span><br><span class="line">    camera.<span class="property">angularSensibilityY</span> = <span class="number">1000</span> <span class="comment">// å‚ç›´çµæ•åº¦</span></span><br><span class="line">    camera.<span class="property">wheelDeltaPercentage</span> = <span class="number">0.01</span> <span class="comment">// æ»šè½®ç¼©æ”¾é€Ÿåº¦</span></span><br><span class="line">    camera.<span class="property">pinchDeltaPercentage</span> = <span class="number">0.01</span> <span class="comment">// è§¦æ‘¸ç¼©æ”¾é€Ÿåº¦</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æƒ¯æ€§</span></span><br><span class="line">    camera.<span class="property">inertia</span> = <span class="number">0.9</span></span><br><span class="line">    camera.<span class="property">panningInertia</span> = <span class="number">0.9</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è‡ªåŠ¨æ—‹è½¬</span></span><br><span class="line">    camera.<span class="property">useAutoRotationBehavior</span> = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">if</span> (camera.<span class="property">useAutoRotationBehavior</span>) &#123;</span><br><span class="line">      camera.<span class="property">autoRotationBehavior</span>.<span class="property">idleRotationSpeed</span> = <span class="number">0.2</span></span><br><span class="line">      camera.<span class="property">autoRotationBehavior</span>.<span class="property">idleRotationWaitTime</span> = <span class="number">2000</span></span><br><span class="line">      camera.<span class="property">autoRotationBehavior</span>.<span class="property">idleRotationSpinupTime</span> = <span class="number">2000</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¾¹ç•Œè¡Œä¸º</span></span><br><span class="line">    camera.<span class="property">useBouncingBehavior</span> = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> (camera.<span class="property">useBouncingBehavior</span>) &#123;</span><br><span class="line">      camera.<span class="property">bouncingBehavior</span>.<span class="property">transitionDuration</span> = <span class="number">450</span></span><br><span class="line">      camera.<span class="property">bouncingBehavior</span>.<span class="property">lowerRadiusTransitionRange</span> = <span class="number">2</span></span><br><span class="line">      camera.<span class="property">bouncingBehavior</span>.<span class="property">upperRadiusTransitionRange</span> = -<span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¡†é€‰è¡Œä¸º</span></span><br><span class="line">    camera.<span class="property">useFramingBehavior</span> = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> (camera.<span class="property">useFramingBehavior</span>) &#123;</span><br><span class="line">      camera.<span class="property">framingBehavior</span>.<span class="property">mode</span> = <span class="title class_">FramingBehavior</span>.<span class="property">FitFrustumSidesMode</span></span><br><span class="line">      camera.<span class="property">framingBehavior</span>.<span class="property">radiusScale</span> = <span class="number">1.0</span></span><br><span class="line">      camera.<span class="property">framingBehavior</span>.<span class="property">positionScale</span> = <span class="number">0.5</span></span><br><span class="line">      camera.<span class="property">framingBehavior</span>.<span class="property">defaultElevation</span> = <span class="number">0.3</span></span><br><span class="line">      camera.<span class="property">framingBehavior</span>.<span class="property">elevationReturnTime</span> = <span class="number">1500</span></span><br><span class="line">      camera.<span class="property">framingBehavior</span>.<span class="property">elevationReturnWaitTime</span> = <span class="number">1000</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">set</span>(name, camera)</span><br><span class="line">    <span class="keyword">return</span> camera</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é€šç”¨ç›¸æœº (UniversalCamera)</span></span><br><span class="line">  <span class="title function_">createUniversalCamera</span>(<span class="params">name, position</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="keyword">new</span> <span class="title class_">UniversalCamera</span>(name, position, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»§æ‰¿è‡ªFreeCameraçš„æ‰€æœ‰å±æ€§</span></span><br><span class="line">    camera.<span class="title function_">setTarget</span>(<span class="title class_">Vector3</span>.<span class="title class_">Zero</span>())</span><br><span class="line">    camera.<span class="property">speed</span> = <span class="number">0.5</span></span><br><span class="line">    camera.<span class="property">angularSensibility</span> = <span class="number">2000</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§¦æ‘¸æ§åˆ¶ (ç§»åŠ¨è®¾å¤‡)</span></span><br><span class="line">    camera.<span class="property">touchAngularSensibility</span> = <span class="number">20000</span></span><br><span class="line">    camera.<span class="property">touchMoveSensibility</span> = <span class="number">250</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸¸æˆæ‰‹æŸ„æ”¯æŒ</span></span><br><span class="line">    camera.<span class="property">gamepadAngularSensibility</span> = <span class="number">200</span></span><br><span class="line">    camera.<span class="property">gamepadMoveSensibility</span> = <span class="number">40</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">set</span>(name, camera)</span><br><span class="line">    <span class="keyword">return</span> camera</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// VRç›¸æœº</span></span><br><span class="line">  <span class="title function_">createVRCamera</span>(<span class="params">name, position</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="keyword">new</span> <span class="title class_">WebVRFreeCamera</span>(name, position, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// VRè®¾å¤‡æ£€æµ‹</span></span><br><span class="line">    camera.<span class="property">deviceOrientationCamera</span>.<span class="property">angularSensibility</span> = <span class="number">2000</span></span><br><span class="line">    camera.<span class="property">deviceOrientationCamera</span>.<span class="property">moveSensibility</span> = <span class="number">50</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">set</span>(name, camera)</span><br><span class="line">    <span class="keyword">return</span> camera</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·Ÿéšç›¸æœº (FollowCamera)</span></span><br><span class="line">  <span class="title function_">createFollowCamera</span>(<span class="params">name, target</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="keyword">new</span> <span class="title class_">FollowCamera</span>(name, <span class="title class_">Vector3</span>.<span class="title class_">Zero</span>(), <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·Ÿéšç›®æ ‡</span></span><br><span class="line">    camera.<span class="property">lockedTarget</span> = target</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·Ÿéšå‚æ•°</span></span><br><span class="line">    camera.<span class="property">radius</span> = <span class="number">10</span> <span class="comment">// è·Ÿéšè·ç¦»</span></span><br><span class="line">    camera.<span class="property">heightOffset</span> = <span class="number">5</span> <span class="comment">// é«˜åº¦åç§»</span></span><br><span class="line">    camera.<span class="property">rotationOffset</span> = <span class="number">0</span> <span class="comment">// æ—‹è½¬åç§»</span></span><br><span class="line">    camera.<span class="property">cameraAcceleration</span> = <span class="number">0.05</span> <span class="comment">// åŠ é€Ÿåº¦</span></span><br><span class="line">    camera.<span class="property">maxCameraSpeed</span> = <span class="number">20</span> <span class="comment">// æœ€å¤§é€Ÿåº¦</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">set</span>(name, camera)</span><br><span class="line">    <span class="keyword">return</span> camera</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®æ´»åŠ¨ç›¸æœº</span></span><br><span class="line">  <span class="title function_">setActiveCamera</span>(<span class="params">cameraName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">get</span>(cameraName)</span><br><span class="line">    <span class="keyword">if</span> (camera) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">activeCamera</span> = camera</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">activeCamera</span> = camera</span><br><span class="line"></span><br><span class="line">      <span class="comment">// é™„åŠ æ§åˆ¶</span></span><br><span class="line">      camera.<span class="title function_">attachControls</span>(<span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>().<span class="title function_">getRenderingCanvas</span>(), <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å–æ¶ˆå…¶ä»–ç›¸æœºçš„æ§åˆ¶</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">cam, name</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (name !== cameraName) &#123;</span><br><span class="line">          cam.<span class="title function_">detachControls</span>(<span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>().<span class="title function_">getRenderingCanvas</span>())</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`åˆ‡æ¢åˆ°ç›¸æœº: <span class="subst">$&#123;cameraName&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç›¸æœºåŠ¨ç”»</span></span><br><span class="line">  <span class="title function_">animateCameraTo</span>(<span class="params">targetPosition, targetTarget, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">activeCamera</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> camera = <span class="variable language_">this</span>.<span class="property">activeCamera</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½ç½®åŠ¨ç”»</span></span><br><span class="line">    <span class="keyword">const</span> positionAnimation = <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">      <span class="string">&#x27;cameraPosition&#x27;</span>,</span><br><span class="line">      camera,</span><br><span class="line">      <span class="string">&#x27;position&#x27;</span>,</span><br><span class="line">      <span class="number">30</span>, <span class="comment">// FPS</span></span><br><span class="line">      (duration / <span class="number">1000</span>) * <span class="number">30</span>, <span class="comment">// æ€»å¸§æ•°</span></span><br><span class="line">      camera.<span class="property">position</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      targetPosition,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯FreeCameraæˆ–UniversalCameraï¼Œä¹Ÿè¦åŠ¨ç”»ç›®æ ‡</span></span><br><span class="line">    <span class="keyword">if</span> (camera <span class="keyword">instanceof</span> <span class="title class_">FreeCamera</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> targetAnimation = <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraTarget&#x27;</span>,</span><br><span class="line">        camera,</span><br><span class="line">        <span class="string">&#x27;target&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">        camera.<span class="title function_">getTarget</span>().<span class="title function_">clone</span>(),</span><br><span class="line">        targetTarget,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ArcRotateCameraï¼Œéœ€è¦è®¡ç®—alphaã€betaã€radius</span></span><br><span class="line">    <span class="keyword">if</span> (camera <span class="keyword">instanceof</span> <span class="title class_">ArcRotateCamera</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> direction = targetPosition.<span class="title function_">subtract</span>(targetTarget)</span><br><span class="line">      <span class="keyword">const</span> radius = direction.<span class="title function_">length</span>()</span><br><span class="line">      <span class="keyword">const</span> alpha = <span class="title class_">Math</span>.<span class="title function_">atan2</span>(direction.<span class="property">x</span>, direction.<span class="property">z</span>)</span><br><span class="line">      <span class="keyword">const</span> beta = <span class="title class_">Math</span>.<span class="title function_">acos</span>(direction.<span class="property">y</span> / radius)</span><br><span class="line"></span><br><span class="line">      <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraAlpha&#x27;</span>,</span><br><span class="line">        camera,</span><br><span class="line">        <span class="string">&#x27;alpha&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">        camera.<span class="property">alpha</span>,</span><br><span class="line">        alpha,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraBeta&#x27;</span>,</span><br><span class="line">        camera,</span><br><span class="line">        <span class="string">&#x27;beta&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">        camera.<span class="property">beta</span>,</span><br><span class="line">        beta,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraRadius&#x27;</span>,</span><br><span class="line">        camera,</span><br><span class="line">        <span class="string">&#x27;radius&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">        camera.<span class="property">radius</span>,</span><br><span class="line">        radius,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraTarget&#x27;</span>,</span><br><span class="line">        camera,</span><br><span class="line">        <span class="string">&#x27;target&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">        camera.<span class="property">target</span>.<span class="title function_">clone</span>(),</span><br><span class="line">        targetTarget,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç›¸æœºèšç„¦åˆ°ç½‘æ ¼</span></span><br><span class="line">  <span class="title function_">focusOnMesh</span>(<span class="params">mesh, offset = <span class="keyword">new</span> Vector3(<span class="number">0</span>, <span class="number">5</span>, -<span class="number">10</span>)</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">activeCamera</span> || !mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> boundingInfo = mesh.<span class="title function_">getBoundingInfo</span>()</span><br><span class="line">    <span class="keyword">const</span> center = boundingInfo.<span class="property">boundingBox</span>.<span class="property">centerWorld</span></span><br><span class="line">    <span class="keyword">const</span> size = boundingInfo.<span class="property">boundingBox</span>.<span class="property">extendSizeWorld</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¡ç®—åˆé€‚çš„è·ç¦»</span></span><br><span class="line">    <span class="keyword">const</span> maxSize = <span class="title class_">Math</span>.<span class="title function_">max</span>(size.<span class="property">x</span>, size.<span class="property">y</span>, size.<span class="property">z</span>)</span><br><span class="line">    <span class="keyword">const</span> distance = maxSize * <span class="number">2.5</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> targetPosition = center.<span class="title function_">add</span>(offset.<span class="title function_">normalize</span>().<span class="title function_">scale</span>(distance))</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">animateCameraTo</span>(targetPosition, center)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¿å­˜ç›¸æœºçŠ¶æ€</span></span><br><span class="line">  <span class="title function_">saveCameraState</span>(<span class="params">cameraName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">get</span>(cameraName)</span><br><span class="line">    <span class="keyword">if</span> (!camera) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> state = &#123;</span><br><span class="line">      <span class="attr">name</span>: cameraName,</span><br><span class="line">      <span class="attr">type</span>: camera.<span class="title function_">getClassName</span>(),</span><br><span class="line">      <span class="attr">position</span>: camera.<span class="property">position</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">target</span>: camera.<span class="title function_">getTarget</span>().<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">upVector</span>: camera.<span class="property">upVector</span>.<span class="title function_">clone</span>(),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ArcRotateCameraé¢å¤–çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> (camera <span class="keyword">instanceof</span> <span class="title class_">ArcRotateCamera</span>) &#123;</span><br><span class="line">      state.<span class="property">alpha</span> = camera.<span class="property">alpha</span></span><br><span class="line">      state.<span class="property">beta</span> = camera.<span class="property">beta</span></span><br><span class="line">      state.<span class="property">radius</span> = camera.<span class="property">radius</span></span><br><span class="line">      state.<span class="property">target</span> = camera.<span class="property">target</span>.<span class="title function_">clone</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¢å¤ç›¸æœºçŠ¶æ€</span></span><br><span class="line">  <span class="title function_">restoreCameraState</span>(<span class="params">state</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">get</span>(state.<span class="property">name</span>)</span><br><span class="line">    <span class="keyword">if</span> (!camera) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    camera.<span class="property">position</span> = state.<span class="property">position</span>.<span class="title function_">clone</span>()</span><br><span class="line">    camera.<span class="property">upVector</span> = state.<span class="property">upVector</span>.<span class="title function_">clone</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (camera <span class="keyword">instanceof</span> <span class="title class_">ArcRotateCamera</span> &amp;&amp; state.<span class="property">alpha</span> !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      camera.<span class="property">alpha</span> = state.<span class="property">alpha</span></span><br><span class="line">      camera.<span class="property">beta</span> = state.<span class="property">beta</span></span><br><span class="line">      camera.<span class="property">radius</span> = state.<span class="property">radius</span></span><br><span class="line">      camera.<span class="property">target</span> = state.<span class="property">target</span>.<span class="title function_">clone</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (camera <span class="keyword">instanceof</span> <span class="title class_">FreeCamera</span>) &#123;</span><br><span class="line">      camera.<span class="title function_">setTarget</span>(state.<span class="property">target</span>.<span class="title function_">clone</span>())</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç›¸æœºæ‘‡æ™ƒæ•ˆæœ</span></span><br><span class="line">  <span class="title function_">addShakeEffect</span>(<span class="params">intensity = <span class="number">0.1</span>, duration = <span class="number">1000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">activeCamera</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> camera = <span class="variable language_">this</span>.<span class="property">activeCamera</span></span><br><span class="line">    <span class="keyword">const</span> originalPosition = camera.<span class="property">position</span>.<span class="title function_">clone</span>()</span><br><span class="line">    <span class="keyword">const</span> shakeAnimation = <span class="keyword">new</span> <span class="title class_">Animation</span>(</span><br><span class="line">      <span class="string">&#x27;cameraShake&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;position&#x27;</span>,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> frameCount = (duration / <span class="number">1000</span>) * <span class="number">30</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= frameCount; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> progress = i / frameCount</span><br><span class="line">      <span class="keyword">const</span> shakeIntensity = intensity * (<span class="number">1</span> - progress) <span class="comment">// é€æ¸å‡å¼±</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> shake = <span class="keyword">new</span> <span class="title class_">Vector3</span>(</span><br><span class="line">        (<span class="title class_">Math</span>.<span class="title function_">random</span>() - <span class="number">0.5</span>) * shakeIntensity,</span><br><span class="line">        (<span class="title class_">Math</span>.<span class="title function_">random</span>() - <span class="number">0.5</span>) * shakeIntensity,</span><br><span class="line">        (<span class="title class_">Math</span>.<span class="title function_">random</span>() - <span class="number">0.5</span>) * shakeIntensity,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: i,</span><br><span class="line">        <span class="attr">value</span>: originalPosition.<span class="title function_">add</span>(shake),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ€åå›åˆ°åŸä½ç½®</span></span><br><span class="line">    keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">      <span class="attr">frame</span>: frameCount,</span><br><span class="line">      <span class="attr">value</span>: originalPosition,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    shakeAnimation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> animatable = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">beginDirectAnimation</span>(</span><br><span class="line">      camera,</span><br><span class="line">      [shakeAnimation],</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      frameCount,</span><br><span class="line">      <span class="literal">false</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> animatable</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¬¬ä¸€äººç§°å°„å‡»æ¸¸æˆç›¸æœºè®¾ç½®</span></span><br><span class="line">  <span class="title function_">setupFPSCamera</span>(<span class="params">cameraName = <span class="string">&#x27;fpsCamera&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="variable language_">this</span>.<span class="title function_">createFreeCamera</span>(cameraName, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">1.8</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// FPSä¸“ç”¨è®¾ç½®</span></span><br><span class="line">    camera.<span class="property">speed</span> = <span class="number">0.2</span></span><br><span class="line">    camera.<span class="property">angularSensibility</span> = <span class="number">1500</span></span><br><span class="line">    camera.<span class="property">minZ</span> = <span class="number">0.1</span> <span class="comment">// è¿‘è£å‰ªé¢</span></span><br><span class="line">    camera.<span class="property">maxZ</span> = <span class="number">1000</span> <span class="comment">// è¿œè£å‰ªé¢</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·³è·ƒè®¾ç½®</span></span><br><span class="line">    camera.<span class="property">jumpSpeed</span> = <span class="number">0.3</span></span><br><span class="line">    camera.<span class="property">gravity</span> = <span class="number">0.9</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é¼ æ ‡é”å®š</span></span><br><span class="line">    camera.<span class="title function_">attachControls</span>(<span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>().<span class="title function_">getRenderingCanvas</span>(), <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­¦å™¨æ‘‡æ‘†æ•ˆæœ</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupWeaponSway</span>(camera)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> camera</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupWeaponSway</span>(<span class="params">camera</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> swayTime = <span class="number">0</span></span><br><span class="line">    <span class="keyword">const</span> swaySpeed = <span class="number">0.005</span></span><br><span class="line">    <span class="keyword">const</span> swayAmount = <span class="number">0.002</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (camera === <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">activeCamera</span>) &#123;</span><br><span class="line">        swayTime += <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>().<span class="title function_">getDeltaTime</span>() * swaySpeed</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¡ç®—æ‘‡æ‘†åç§»</span></span><br><span class="line">        <span class="keyword">const</span> swayX = <span class="title class_">Math</span>.<span class="title function_">sin</span>(swayTime * <span class="number">2</span>) * swayAmount</span><br><span class="line">        <span class="keyword">const</span> swayY = <span class="title class_">Math</span>.<span class="title function_">sin</span>(swayTime) * swayAmount * <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// åº”ç”¨åˆ°ç›¸æœº</span></span><br><span class="line">        camera.<span class="property">position</span>.<span class="property">x</span> += swayX</span><br><span class="line">        camera.<span class="property">position</span>.<span class="property">y</span> += swayY</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç”µå½±çº§ç›¸æœºè¿åŠ¨</span></span><br><span class="line">  <span class="title function_">createCinematicPath</span>(<span class="params">waypoints, duration = <span class="number">10000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (waypoints.<span class="property">length</span> &lt; <span class="number">2</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºè·¯å¾„</span></span><br><span class="line">    <span class="keyword">const</span> path = []</span><br><span class="line">    waypoints.<span class="title function_">forEach</span>(<span class="function">(<span class="params">waypoint</span>) =&gt;</span> &#123;</span><br><span class="line">      path.<span class="title function_">push</span>(waypoint.<span class="property">position</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºå¹³æ»‘æ›²çº¿</span></span><br><span class="line">    <span class="keyword">const</span> curve = <span class="title class_">Curve3</span>.<span class="title class_">CreateCatmullRomSpline</span>(path, path.<span class="property">length</span> * <span class="number">10</span>, <span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">const</span> curvePoints = curve.<span class="title function_">getPoints</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºåŠ¨ç”»</span></span><br><span class="line">    <span class="keyword">const</span> positionAnimation = <span class="keyword">new</span> <span class="title class_">Animation</span>(</span><br><span class="line">      <span class="string">&#x27;cinematicPosition&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;position&#x27;</span>,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">const</span> targetAnimation = <span class="keyword">new</span> <span class="title class_">Animation</span>(</span><br><span class="line">      <span class="string">&#x27;cinematicTarget&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;target&#x27;</span>,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * <span class="number">30</span></span><br><span class="line">    <span class="keyword">const</span> positionKeys = []</span><br><span class="line">    <span class="keyword">const</span> targetKeys = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= totalFrames; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> progress = i / totalFrames</span><br><span class="line">      <span class="keyword">const</span> pointIndex = <span class="title class_">Math</span>.<span class="title function_">floor</span>(progress * (curvePoints.<span class="property">length</span> - <span class="number">1</span>))</span><br><span class="line">      <span class="keyword">const</span> nextPointIndex = <span class="title class_">Math</span>.<span class="title function_">min</span>(pointIndex + <span class="number">1</span>, curvePoints.<span class="property">length</span> - <span class="number">1</span>)</span><br><span class="line">      <span class="keyword">const</span> localProgress = progress * (curvePoints.<span class="property">length</span> - <span class="number">1</span>) - pointIndex</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ’å€¼ä½ç½®</span></span><br><span class="line">      <span class="keyword">const</span> position = <span class="title class_">Vector3</span>.<span class="title class_">Lerp</span>(</span><br><span class="line">        curvePoints[pointIndex],</span><br><span class="line">        curvePoints[nextPointIndex],</span><br><span class="line">        localProgress,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="comment">// è®¡ç®—ç›®æ ‡ï¼ˆå‘å‰çœ‹ï¼‰</span></span><br><span class="line">      <span class="keyword">const</span> lookAheadIndex = <span class="title class_">Math</span>.<span class="title function_">min</span>(pointIndex + <span class="number">5</span>, curvePoints.<span class="property">length</span> - <span class="number">1</span>)</span><br><span class="line">      <span class="keyword">const</span> target = curvePoints[lookAheadIndex]</span><br><span class="line"></span><br><span class="line">      positionKeys.<span class="title function_">push</span>(&#123; <span class="attr">frame</span>: i, <span class="attr">value</span>: position &#125;)</span><br><span class="line">      targetKeys.<span class="title function_">push</span>(&#123; <span class="attr">frame</span>: i, <span class="attr">value</span>: target &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    positionAnimation.<span class="title function_">setKeys</span>(positionKeys)</span><br><span class="line">    targetAnimation.<span class="title function_">setKeys</span>(targetKeys)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [positionAnimation, targetAnimation]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–ç›¸æœºä¿¡æ¯</span></span><br><span class="line">  <span class="title function_">getCameraInfo</span>(<span class="params">cameraName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">get</span>(cameraName)</span><br><span class="line">    <span class="keyword">if</span> (!camera) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> info = &#123;</span><br><span class="line">      <span class="attr">name</span>: cameraName,</span><br><span class="line">      <span class="attr">type</span>: camera.<span class="title function_">getClassName</span>(),</span><br><span class="line">      <span class="attr">position</span>: camera.<span class="property">position</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">target</span>: camera.<span class="title function_">getTarget</span>(),</span><br><span class="line">      <span class="attr">fov</span>: camera.<span class="property">fov</span>,</span><br><span class="line">      <span class="attr">minZ</span>: camera.<span class="property">minZ</span>,</span><br><span class="line">      <span class="attr">maxZ</span>: camera.<span class="property">maxZ</span>,</span><br><span class="line">      <span class="attr">isActive</span>: camera === <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">activeCamera</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (camera <span class="keyword">instanceof</span> <span class="title class_">ArcRotateCamera</span>) &#123;</span><br><span class="line">      info.<span class="property">alpha</span> = camera.<span class="property">alpha</span></span><br><span class="line">      info.<span class="property">beta</span> = camera.<span class="property">beta</span></span><br><span class="line">      info.<span class="property">radius</span> = camera.<span class="property">radius</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// èµ„æºæ¸…ç†</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">camera</span>) =&gt;</span> &#123;</span><br><span class="line">      camera.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> cameraManager = <span class="keyword">new</span> <span class="title class_">CameraManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ‡æ¢ç›¸æœº</span></span><br><span class="line">cameraManager.<span class="title function_">setActiveCamera</span>(<span class="string">&#x27;arcCamera&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// èšç„¦åˆ°ç½‘æ ¼</span></span><br><span class="line">cameraManager.<span class="title function_">focusOnMesh</span>(someMesh)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ æ‘‡æ™ƒæ•ˆæœ</span></span><br><span class="line">cameraManager.<span class="title function_">addShakeEffect</span>(<span class="number">0.2</span>, <span class="number">2000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®FPSç›¸æœº</span></span><br><span class="line"><span class="keyword">const</span> fpsCamera = cameraManager.<span class="title function_">setupFPSCamera</span>()</span><br></pre></td></tr></table></figure><h2 id="ğŸ’¡-Light-å…‰ç…§ç³»ç»Ÿè¯¦è§£"><a href="#ğŸ’¡-Light-å…‰ç…§ç³»ç»Ÿè¯¦è§£" class="headerlink" title="ğŸ’¡ Light å…‰ç…§ç³»ç»Ÿè¯¦è§£"></a>ğŸ’¡ Light å…‰ç…§ç³»ç»Ÿè¯¦è§£</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Light å…‰ç…§ç³»ç»Ÿå®Œæ•´ç®¡ç†</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LightManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadowGenerators</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupDefaultLighting</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupDefaultLighting</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ç¯å¢ƒå…‰</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createHemisphericLight</span>(<span class="string">&#x27;ambientLight&#x27;</span>, <span class="title class_">Vector3</span>.<span class="title class_">Up</span>(), <span class="number">0.3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸»å…‰æº</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createDirectionalLight</span>(<span class="string">&#x27;sunLight&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>), <span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¡¥å…‰</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createSpotLight</span>(<span class="string">&#x27;fillLight&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">5</span>, <span class="number">10</span>, <span class="number">5</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, -<span class="number">1</span>, <span class="number">0</span>), <span class="number">0.5</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŠçƒå…‰ (HemisphericLight) - ç¯å¢ƒå…‰</span></span><br><span class="line">  <span class="title function_">createHemisphericLight</span>(<span class="params">name, direction, intensity = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> light = <span class="keyword">new</span> <span class="title class_">HemisphericLight</span>(name, direction, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŸºç¡€å±æ€§</span></span><br><span class="line">    light.<span class="property">intensity</span> = intensity</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é¢œè‰²é…ç½®</span></span><br><span class="line">    <span class="comment">// diffuse: Color3 - æ¼«åå°„é¢œè‰²</span></span><br><span class="line">    light.<span class="property">diffuse</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// specular: Color3 - é•œé¢åå°„é¢œè‰²</span></span><br><span class="line">    light.<span class="property">specular</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// groundColor: Color3 - åœ°é¢é¢œè‰²ï¼ˆåŠçƒå…‰ç‰¹æœ‰ï¼‰</span></span><br><span class="line">    light.<span class="property">groundColor</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.2</span>, <span class="number">0.2</span>, <span class="number">0.3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½±å“èŒƒå›´</span></span><br><span class="line">    light.<span class="property">range</span> = <span class="title class_">Number</span>.<span class="property">MAX_VALUE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒ…å«/æ’é™¤ç½‘æ ¼</span></span><br><span class="line">    light.<span class="property">includedOnlyMeshes</span> = [] <span class="comment">// åªå½±å“æŒ‡å®šç½‘æ ¼</span></span><br><span class="line">    light.<span class="property">excludedMeshes</span> = [] <span class="comment">// æ’é™¤æŒ‡å®šç½‘æ ¼</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">set</span>(name, light)</span><br><span class="line">    <span class="keyword">return</span> light</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ–¹å‘å…‰ (DirectionalLight) - å¤ªé˜³å…‰</span></span><br><span class="line">  <span class="title function_">createDirectionalLight</span>(<span class="params">name, direction, intensity = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> light = <span class="keyword">new</span> <span class="title class_">DirectionalLight</span>(name, direction, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    light.<span class="property">intensity</span> = intensity</span><br><span class="line">    light.<span class="property">diffuse</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">0.9</span>, <span class="number">0.7</span>) <span class="comment">// æš–ç™½è‰²</span></span><br><span class="line">    light.<span class="property">specular</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0.8</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–¹å‘å…‰ç‰¹æœ‰å±æ€§</span></span><br><span class="line">    <span class="comment">// direction: Vector3 - å…‰ç…§æ–¹å‘</span></span><br><span class="line">    light.<span class="property">direction</span> = direction.<span class="title function_">normalize</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é˜´å½±é…ç½®</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupShadowGenerator</span>(name, light, &#123;</span><br><span class="line">      <span class="attr">mapSize</span>: <span class="number">2048</span>,</span><br><span class="line">      <span class="attr">useExponentialShadowMap</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">useBlurExponentialShadowMap</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">blurScale</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">blurBoxOffset</span>: <span class="number">1</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">set</span>(name, light)</span><br><span class="line">    <span class="keyword">return</span> light</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç‚¹å…‰æº (PointLight)</span></span><br><span class="line">  <span class="title function_">createPointLight</span>(<span class="params">name, position, intensity = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> light = <span class="keyword">new</span> <span class="title class_">PointLight</span>(name, position, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    light.<span class="property">intensity</span> = intensity</span><br><span class="line">    light.<span class="property">diffuse</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">0.8</span>, <span class="number">0.4</span>) <span class="comment">// æ¸©æš–çš„æ©™è‰²</span></span><br><span class="line">    light.<span class="property">specular</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç‚¹å…‰æºç‰¹æœ‰å±æ€§</span></span><br><span class="line">    <span class="comment">// range: number - å…‰ç…§èŒƒå›´</span></span><br><span class="line">    light.<span class="property">range</span> = <span class="number">50</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¡°å‡å‡½æ•°: intensity / (1 + linear * d + quadratic * d^2)</span></span><br><span class="line">    <span class="comment">// å…¶ä¸­ d æ˜¯è·ç¦»</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// çº¿æ€§è¡°å‡</span></span><br><span class="line">    light.<span class="property">diffuseLinearAttenuation</span> = <span class="number">0.1</span></span><br><span class="line">    light.<span class="property">specularLinearAttenuation</span> = <span class="number">0.1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// äºŒæ¬¡è¡°å‡</span></span><br><span class="line">    light.<span class="property">diffuseQuadraticAttenuation</span> = <span class="number">0.01</span></span><br><span class="line">    light.<span class="property">specularQuadraticAttenuation</span> = <span class="number">0.01</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é˜´å½±é…ç½®ï¼ˆå¯é€‰ï¼‰</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupShadowGenerator</span>(name, light, &#123;</span><br><span class="line">      <span class="attr">mapSize</span>: <span class="number">1024</span>,</span><br><span class="line">      <span class="attr">useExponentialShadowMap</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">set</span>(name, light)</span><br><span class="line">    <span class="keyword">return</span> light</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// èšå…‰ç¯ (SpotLight)</span></span><br><span class="line">  <span class="title function_">createSpotLight</span>(<span class="params">name, position, direction, intensity = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="comment">// angle: èšå…‰ç¯é”¥è§’ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">    <span class="comment">// exponent: è¾¹ç¼˜è¡°å‡æŒ‡æ•°</span></span><br><span class="line">    <span class="keyword">const</span> light = <span class="keyword">new</span> <span class="title class_">SpotLight</span>(name, position, direction, <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">3</span>, <span class="number">2</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    light.<span class="property">intensity</span> = intensity</span><br><span class="line">    light.<span class="property">diffuse</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0.9</span>)</span><br><span class="line">    light.<span class="property">specular</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// èšå…‰ç¯ç‰¹æœ‰å±æ€§</span></span><br><span class="line">    <span class="comment">// angle: number - é”¥è§’ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">    light.<span class="property">angle</span> = <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">3</span> <span class="comment">// 60åº¦</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// exponent: number - è¾¹ç¼˜è¡°å‡</span></span><br><span class="line">    light.<span class="property">exponent</span> = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–¹å‘</span></span><br><span class="line">    light.<span class="property">direction</span> = direction.<span class="title function_">normalize</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†…è§’å’Œå¤–è§’ï¼ˆç”¨äºå¹³æ»‘è¿‡æ¸¡ï¼‰</span></span><br><span class="line">    light.<span class="property">innerAngle</span> = <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">6</span> <span class="comment">// 30åº¦</span></span><br><span class="line">    light.<span class="property">outerAngle</span> = <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">3</span> <span class="comment">// 60åº¦</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·ç¦»è¡°å‡</span></span><br><span class="line">    light.<span class="property">range</span> = <span class="number">100</span></span><br><span class="line">    light.<span class="property">diffuseLinearAttenuation</span> = <span class="number">0.05</span></span><br><span class="line">    light.<span class="property">diffuseQuadraticAttenuation</span> = <span class="number">0.005</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é˜´å½±é…ç½®</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupShadowGenerator</span>(name, light, &#123;</span><br><span class="line">      <span class="attr">mapSize</span>: <span class="number">1024</span>,</span><br><span class="line">      <span class="attr">useExponentialShadowMap</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">useCloseExponentialShadowMap</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">set</span>(name, light)</span><br><span class="line">    <span class="keyword">return</span> light</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é˜´å½±ç”Ÿæˆå™¨é…ç½®</span></span><br><span class="line">  <span class="title function_">setupShadowGenerator</span>(<span class="params">lightName, light, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!light.<span class="property">canGenerateShadows</span>) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="attr">mapSize</span>: <span class="number">1024</span>,</span><br><span class="line">      <span class="attr">useExponentialShadowMap</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">useBlurExponentialShadowMap</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">useCloseExponentialShadowMap</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">usePoissonSampling</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">usePercentageCloserFiltering</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">filteringQuality</span>: <span class="title class_">ShadowGenerator</span>.<span class="property">QUALITY_HIGH</span>,</span><br><span class="line">      <span class="attr">blurScale</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">blurBoxOffset</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">bias</span>: <span class="number">0.00005</span>,</span><br><span class="line">      <span class="attr">normalBias</span>: <span class="number">0.0</span>,</span><br><span class="line">      <span class="attr">darkness</span>: <span class="number">0.0</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> config = <span class="title class_">Object</span>.<span class="title function_">assign</span>(defaultOptions, options)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºé˜´å½±ç”Ÿæˆå™¨</span></span><br><span class="line">    <span class="keyword">const</span> shadowGenerator = <span class="keyword">new</span> <span class="title class_">ShadowGenerator</span>(config.<span class="property">mapSize</span>, light)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é˜´å½±æ˜ å°„ç±»å‹</span></span><br><span class="line">    <span class="keyword">if</span> (config.<span class="property">useExponentialShadowMap</span>) &#123;</span><br><span class="line">      shadowGenerator.<span class="property">useExponentialShadowMap</span> = <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config.<span class="property">useBlurExponentialShadowMap</span>) &#123;</span><br><span class="line">      shadowGenerator.<span class="property">useBlurExponentialShadowMap</span> = <span class="literal">true</span></span><br><span class="line">      shadowGenerator.<span class="property">blurScale</span> = config.<span class="property">blurScale</span></span><br><span class="line">      shadowGenerator.<span class="property">blurBoxOffset</span> = config.<span class="property">blurBoxOffset</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config.<span class="property">useCloseExponentialShadowMap</span>) &#123;</span><br><span class="line">      shadowGenerator.<span class="property">useCloseExponentialShadowMap</span> = <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config.<span class="property">usePoissonSampling</span>) &#123;</span><br><span class="line">      shadowGenerator.<span class="property">usePoissonSampling</span> = <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config.<span class="property">usePercentageCloserFiltering</span>) &#123;</span><br><span class="line">      shadowGenerator.<span class="property">usePercentageCloserFiltering</span> = <span class="literal">true</span></span><br><span class="line">      shadowGenerator.<span class="property">filteringQuality</span> = config.<span class="property">filteringQuality</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é˜´å½±å‚æ•°</span></span><br><span class="line">    shadowGenerator.<span class="property">bias</span> = config.<span class="property">bias</span></span><br><span class="line">    shadowGenerator.<span class="property">normalBias</span> = config.<span class="property">normalBias</span></span><br><span class="line">    shadowGenerator.<span class="property">darkness</span> = config.<span class="property">darkness</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€æ˜åº¦é˜ˆå€¼</span></span><br><span class="line">    shadowGenerator.<span class="property">transparencyShadow</span> = <span class="literal">true</span></span><br><span class="line">    shadowGenerator.<span class="property">forceBackFacesOnly</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// çº§è”é˜´å½±ï¼ˆæ–¹å‘å…‰ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (light <span class="keyword">instanceof</span> <span class="title class_">DirectionalLight</span>) &#123;</span><br><span class="line">      shadowGenerator.<span class="property">autoCalcDepthBounds</span> = <span class="literal">true</span></span><br><span class="line">      shadowGenerator.<span class="property">stabilizeCascades</span> = <span class="literal">true</span></span><br><span class="line">      shadowGenerator.<span class="property">lambda</span> = <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¤šçº§è”é…ç½®</span></span><br><span class="line">      <span class="keyword">if</span> (config.<span class="property">cascadeCount</span> &amp;&amp; config.<span class="property">cascadeCount</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        shadowGenerator.<span class="property">numCascades</span> = config.<span class="property">cascadeCount</span></span><br><span class="line">        shadowGenerator.<span class="property">cascadeBlendPercentage</span> = <span class="number">0.1</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadowGenerators</span>.<span class="title function_">set</span>(lightName, shadowGenerator)</span><br><span class="line">    <span class="keyword">return</span> shadowGenerator</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ·»åŠ æŠ•å°„é˜´å½±çš„ç½‘æ ¼</span></span><br><span class="line">  <span class="title function_">addShadowCaster</span>(<span class="params">lightName, mesh</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> shadowGenerator = <span class="variable language_">this</span>.<span class="property">shadowGenerators</span>.<span class="title function_">get</span>(lightName)</span><br><span class="line">    <span class="keyword">if</span> (shadowGenerator) &#123;</span><br><span class="line">      shadowGenerator.<span class="title function_">addShadowCaster</span>(mesh)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ‰¹é‡æ·»åŠ é˜´å½±æŠ•å°„è€…</span></span><br><span class="line">  <span class="title function_">addShadowCasters</span>(<span class="params">lightName, meshes</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> shadowGenerator = <span class="variable language_">this</span>.<span class="property">shadowGenerators</span>.<span class="title function_">get</span>(lightName)</span><br><span class="line">    <span class="keyword">if</span> (shadowGenerator) &#123;</span><br><span class="line">      meshes.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">        shadowGenerator.<span class="title function_">addShadowCaster</span>(mesh)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®ç½‘æ ¼æ¥æ”¶é˜´å½±</span></span><br><span class="line">  <span class="title function_">enableShadowReceiver</span>(<span class="params">mesh</span>) &#123;</span><br><span class="line">    mesh.<span class="property">receiveShadows</span> = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å…‰ç…§åŠ¨ç”»</span></span><br><span class="line">  <span class="title function_">animateLight</span>(<span class="params">lightName, property, targetValue, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> light = <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">get</span>(lightName)</span><br><span class="line">    <span class="keyword">if</span> (!light) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> animation = <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;lightName&#125;</span>_<span class="subst">$&#123;property&#125;</span>`</span>,</span><br><span class="line">      light,</span><br><span class="line">      property,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">      light[property],</span><br><span class="line">      targetValue,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å…‰ç…§é—ªçƒæ•ˆæœ</span></span><br><span class="line">  <span class="title function_">addFlickerEffect</span>(<span class="params">lightName, intensity = <span class="number">0.2</span>, speed = <span class="number">5</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> light = <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">get</span>(lightName)</span><br><span class="line">    <span class="keyword">if</span> (!light) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> baseIntensity = light.<span class="property">intensity</span></span><br><span class="line">    <span class="keyword">let</span> time = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> flickerObserver = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      time += <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>().<span class="title function_">getDeltaTime</span>() * <span class="number">0.001</span> * speed</span><br><span class="line">      <span class="keyword">const</span> flicker = <span class="title class_">Math</span>.<span class="title function_">sin</span>(time * <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>) * intensity + <span class="title class_">Math</span>.<span class="title function_">random</span>() * intensity * <span class="number">0.5</span></span><br><span class="line">      light.<span class="property">intensity</span> = baseIntensity + flicker</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">dispose</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">remove</span>(flickerObserver)</span><br><span class="line">        light.<span class="property">intensity</span> = baseIntensity</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ˜¼å¤œå¾ªç¯</span></span><br><span class="line">  <span class="title function_">setupDayNightCycle</span>(<span class="params">duration = <span class="number">120000</span></span>) &#123;</span><br><span class="line">    <span class="comment">// 2åˆ†é’Ÿä¸€ä¸ªå‘¨æœŸ</span></span><br><span class="line">    <span class="keyword">const</span> sunLight = <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">get</span>(<span class="string">&#x27;sunLight&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> ambientLight = <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">get</span>(<span class="string">&#x27;ambientLight&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!sunLight || !ambientLight) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> time = <span class="number">0</span></span><br><span class="line">    <span class="keyword">const</span> cycleSpeed = (<span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>) / duration <span class="comment">// å¼§åº¦/æ¯«ç§’</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> cycleObserver = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      time += <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>().<span class="title function_">getDeltaTime</span>() * cycleSpeed</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¤ªé˜³é«˜åº¦è§’ (-90Â° åˆ° +90Â°)</span></span><br><span class="line">      <span class="keyword">const</span> sunElevation = (<span class="title class_">Math</span>.<span class="title function_">sin</span>(time) * <span class="title class_">Math</span>.<span class="property">PI</span>) / <span class="number">2</span></span><br><span class="line">      <span class="keyword">const</span> sunAzimuth = time</span><br><span class="line"></span><br><span class="line">      <span class="comment">// è®¡ç®—å¤ªé˜³æ–¹å‘</span></span><br><span class="line">      <span class="keyword">const</span> sunDirection = <span class="keyword">new</span> <span class="title class_">Vector3</span>(</span><br><span class="line">        <span class="title class_">Math</span>.<span class="title function_">cos</span>(sunElevation) * <span class="title class_">Math</span>.<span class="title function_">sin</span>(sunAzimuth),</span><br><span class="line">        <span class="title class_">Math</span>.<span class="title function_">sin</span>(sunElevation),</span><br><span class="line">        <span class="title class_">Math</span>.<span class="title function_">cos</span>(sunElevation) * <span class="title class_">Math</span>.<span class="title function_">cos</span>(sunAzimuth),</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      sunLight.<span class="property">direction</span> = sunDirection.<span class="title function_">negate</span>()</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ ¹æ®å¤ªé˜³é«˜åº¦è°ƒæ•´å…‰ç…§å¼ºåº¦å’Œé¢œè‰²</span></span><br><span class="line">      <span class="keyword">const</span> dayFactor = <span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="number">0</span>, <span class="title class_">Math</span>.<span class="title function_">sin</span>(time)) <span class="comment">// 0-1ï¼Œç™½å¤©ä¸º1ï¼Œå¤œæ™šä¸º0</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¤ªé˜³å…‰å¼ºåº¦</span></span><br><span class="line">      sunLight.<span class="property">intensity</span> = dayFactor * <span class="number">2.0</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¤ªé˜³å…‰é¢œè‰²ï¼ˆæ—¥å‡ºæ—¥è½æ—¶åçº¢ï¼‰</span></span><br><span class="line">      <span class="keyword">const</span> sunColor = <span class="variable language_">this</span>.<span class="title function_">calculateSunColor</span>(sunElevation)</span><br><span class="line">      sunLight.<span class="property">diffuse</span> = sunColor</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ç¯å¢ƒå…‰å¼ºåº¦</span></span><br><span class="line">      ambientLight.<span class="property">intensity</span> = <span class="number">0.1</span> + dayFactor * <span class="number">0.4</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// ç¯å¢ƒå…‰é¢œè‰²</span></span><br><span class="line">      <span class="keyword">const</span> ambientColor = <span class="variable language_">this</span>.<span class="title function_">calculateAmbientColor</span>(dayFactor)</span><br><span class="line">      ambientLight.<span class="property">diffuse</span> = ambientColor</span><br><span class="line">      ambientLight.<span class="property">groundColor</span> = ambientColor.<span class="title function_">scale</span>(<span class="number">0.5</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">dispose</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">remove</span>(cycleObserver)</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">calculateSunColor</span>(<span class="params">elevation</span>) &#123;</span><br><span class="line">    <span class="comment">// æ ¹æ®å¤ªé˜³é«˜åº¦è§’è®¡ç®—é¢œè‰²</span></span><br><span class="line">    <span class="keyword">const</span> factor = <span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="number">0</span>, <span class="title class_">Math</span>.<span class="title function_">sin</span>(elevation))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (factor &gt; <span class="number">0.8</span>) &#123;</span><br><span class="line">      <span class="comment">// æ­£åˆ - ç™½è‰²</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Color3</span>.<span class="title class_">White</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (factor &gt; <span class="number">0.3</span>) &#123;</span><br><span class="line">      <span class="comment">// ç™½å¤© - æš–ç™½è‰²</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Color3</span>.<span class="title class_">Lerp</span>(<span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">0.9</span>, <span class="number">0.7</span>), <span class="title class_">Color3</span>.<span class="title class_">White</span>(), (factor - <span class="number">0.3</span>) / <span class="number">0.5</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (factor &gt; <span class="number">0.1</span>) &#123;</span><br><span class="line">      <span class="comment">// æ—¥å‡ºæ—¥è½ - æ©™çº¢è‰²</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Color3</span>.<span class="title class_">Lerp</span>(<span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">0.3</span>, <span class="number">0.1</span>), <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">0.9</span>, <span class="number">0.7</span>), (factor - <span class="number">0.1</span>) / <span class="number">0.2</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å¤œæ™š - æ·±è“è‰²</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.1</span>, <span class="number">0.1</span>, <span class="number">0.3</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">calculateAmbientColor</span>(<span class="params">dayFactor</span>) &#123;</span><br><span class="line">    <span class="comment">// ç™½å¤©ï¼šæµ…è“è‰²å¤©ç©ºå…‰</span></span><br><span class="line">    <span class="keyword">const</span> dayColor = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.5</span>, <span class="number">0.7</span>, <span class="number">1.0</span>)</span><br><span class="line">    <span class="comment">// å¤œæ™šï¼šæ·±è“ç´«è‰²</span></span><br><span class="line">    <span class="keyword">const</span> nightColor = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.1</span>, <span class="number">0.1</span>, <span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Color3</span>.<span class="title class_">Lerp</span>(nightColor, dayColor, dayFactor)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½“ç§¯å…‰æ•ˆæœ (Volumetric Light)</span></span><br><span class="line">  <span class="title function_">setupVolumetricLight</span>(<span class="params">lightName, density = <span class="number">0.1</span>, decay = <span class="number">0.95</span>, weight = <span class="number">0.5</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> light = <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">get</span>(lightName)</span><br><span class="line">    <span class="keyword">if</span> (!light || !(light <span class="keyword">instanceof</span> <span class="title class_">SpotLight</span> || light <span class="keyword">instanceof</span> <span class="title class_">DirectionalLight</span>)) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;ä½“ç§¯å…‰åªæ”¯æŒèšå…‰ç¯å’Œæ–¹å‘å…‰&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºä½“ç§¯å…‰åå¤„ç†</span></span><br><span class="line">    <span class="keyword">const</span> volumetricLightPostProcess = <span class="keyword">new</span> <span class="title class_">VolumetricLightScatteringPostProcess</span>(</span><br><span class="line">      <span class="string">&#x27;volumetricLight&#x27;</span>,</span><br><span class="line">      <span class="number">1.0</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">activeCamera</span>,</span><br><span class="line">      <span class="literal">undefined</span>, <span class="comment">// ä½¿ç”¨å…‰æºè‡ªèº«</span></span><br><span class="line">      <span class="number">100</span>,</span><br><span class="line">      <span class="title class_">Texture</span>.<span class="property">BILINEAR_SAMPLINGMODE</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>(),</span><br><span class="line">      <span class="literal">false</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é…ç½®å‚æ•°</span></span><br><span class="line">    volumetricLightPostProcess.<span class="property">density</span> = density</span><br><span class="line">    volumetricLightPostProcess.<span class="property">decay</span> = decay</span><br><span class="line">    volumetricLightPostProcess.<span class="property">weight</span> = weight</span><br><span class="line">    volumetricLightPostProcess.<span class="property">samples</span> = <span class="number">50</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> volumetricLightPostProcess</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// IESå…‰åº¦æ–‡ä»¶æ”¯æŒï¼ˆçœŸå®å…‰æºåˆ†å¸ƒï¼‰</span></span><br><span class="line">  <span class="title function_">loadIESProfile</span>(<span class="params">lightName, iesUrl</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> light = <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">get</span>(lightName)</span><br><span class="line">    <span class="keyword">if</span> (!light || !(light <span class="keyword">instanceof</span> <span class="title class_">SpotLight</span>)) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;IESå…‰åº¦æ–‡ä»¶åªæ”¯æŒèšå…‰ç¯&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŠ è½½IESæ–‡ä»¶å¹¶åˆ›å»ºçº¹ç†</span></span><br><span class="line">    <span class="keyword">const</span> iesTexture = <span class="keyword">new</span> <span class="title class_">Texture</span>(iesUrl, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    iesTexture.<span class="property">wrapU</span> = <span class="title class_">Texture</span>.<span class="property">CLAMP_ADDRESSMODE</span></span><br><span class="line">    iesTexture.<span class="property">wrapV</span> = <span class="title class_">Texture</span>.<span class="property">CLAMP_ADDRESSMODE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åº”ç”¨åˆ°å…‰æº</span></span><br><span class="line">    light.<span class="property">projectionTexture</span> = iesTexture</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> iesTexture</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å…‰æºè°ƒè¯•å·¥å…·</span></span><br><span class="line">  <span class="title function_">enableLightGizmos</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">light, name</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> lightGizmo = <span class="keyword">new</span> <span class="title class_">LightGizmo</span>()</span><br><span class="line">      lightGizmo.<span class="property">light</span> = light</span><br><span class="line">      lightGizmo.<span class="property">material</span>.<span class="property">emissiveColor</span> = light.<span class="property">diffuse</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ˜¾ç¤ºå…‰æºæ–¹å‘</span></span><br><span class="line">      <span class="keyword">if</span> (light <span class="keyword">instanceof</span> <span class="title class_">DirectionalLight</span> || light <span class="keyword">instanceof</span> <span class="title class_">SpotLight</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> helper = <span class="variable language_">this</span>.<span class="title function_">createLightHelper</span>(light)</span><br><span class="line">        helper.<span class="property">name</span> = <span class="string">`<span class="subst">$&#123;name&#125;</span>_helper`</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createLightHelper</span>(<span class="params">light</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (light <span class="keyword">instanceof</span> <span class="title class_">DirectionalLight</span>) &#123;</span><br><span class="line">      <span class="comment">// æ–¹å‘å…‰å¸®åŠ©å™¨</span></span><br><span class="line">      <span class="keyword">const</span> helper = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateLines</span>(</span><br><span class="line">        <span class="string">&#x27;lightHelper&#x27;</span>,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">points</span>: [<span class="title class_">Vector3</span>.<span class="title class_">Zero</span>(), light.<span class="property">direction</span>.<span class="title function_">scale</span>(<span class="number">10</span>)],</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">      )</span><br><span class="line">      helper.<span class="property">color</span> = light.<span class="property">diffuse</span></span><br><span class="line">      <span class="keyword">return</span> helper</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (light <span class="keyword">instanceof</span> <span class="title class_">SpotLight</span>) &#123;</span><br><span class="line">      <span class="comment">// èšå…‰ç¯é”¥å½¢å¸®åŠ©å™¨</span></span><br><span class="line">      <span class="keyword">const</span> angle = light.<span class="property">angle</span></span><br><span class="line">      <span class="keyword">const</span> range = light.<span class="property">range</span> || <span class="number">20</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> helper = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateCylinder</span>(</span><br><span class="line">        <span class="string">&#x27;lightHelper&#x27;</span>,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">diameterTop</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="attr">diameterBottom</span>: <span class="title class_">Math</span>.<span class="title function_">tan</span>(angle / <span class="number">2</span>) * range * <span class="number">2</span>,</span><br><span class="line">          <span class="attr">height</span>: range,</span><br><span class="line">          <span class="attr">tessellation</span>: <span class="number">8</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      helper.<span class="property">position</span> = light.<span class="property">position</span>.<span class="title function_">clone</span>()</span><br><span class="line">      helper.<span class="title function_">lookAt</span>(light.<span class="property">position</span>.<span class="title function_">add</span>(light.<span class="property">direction</span>))</span><br><span class="line">      helper.<span class="property">material</span> = <span class="keyword">new</span> <span class="title class_">StandardMaterial</span>(<span class="string">&#x27;lightHelperMat&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">      helper.<span class="property">material</span>.<span class="property">wireframe</span> = <span class="literal">true</span></span><br><span class="line">      helper.<span class="property">material</span>.<span class="property">emissiveColor</span> = light.<span class="property">diffuse</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> helper</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–å…‰ç…§ä¿¡æ¯</span></span><br><span class="line">  <span class="title function_">getLightInfo</span>(<span class="params">lightName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> light = <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">get</span>(lightName)</span><br><span class="line">    <span class="keyword">if</span> (!light) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> info = &#123;</span><br><span class="line">      <span class="attr">name</span>: lightName,</span><br><span class="line">      <span class="attr">type</span>: light.<span class="title function_">getClassName</span>(),</span><br><span class="line">      <span class="attr">intensity</span>: light.<span class="property">intensity</span>,</span><br><span class="line">      <span class="attr">diffuse</span>: light.<span class="property">diffuse</span>,</span><br><span class="line">      <span class="attr">specular</span>: light.<span class="property">specular</span>,</span><br><span class="line">      <span class="attr">range</span>: light.<span class="property">range</span>,</span><br><span class="line">      <span class="attr">enabled</span>: light.<span class="title function_">isEnabled</span>(),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (light <span class="keyword">instanceof</span> <span class="title class_">DirectionalLight</span>) &#123;</span><br><span class="line">      info.<span class="property">direction</span> = light.<span class="property">direction</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (light <span class="keyword">instanceof</span> <span class="title class_">PointLight</span>) &#123;</span><br><span class="line">      info.<span class="property">position</span> = light.<span class="property">position</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (light <span class="keyword">instanceof</span> <span class="title class_">SpotLight</span>) &#123;</span><br><span class="line">      info.<span class="property">position</span> = light.<span class="property">position</span></span><br><span class="line">      info.<span class="property">direction</span> = light.<span class="property">direction</span></span><br><span class="line">      info.<span class="property">angle</span> = light.<span class="property">angle</span></span><br><span class="line">      info.<span class="property">exponent</span> = light.<span class="property">exponent</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (light <span class="keyword">instanceof</span> <span class="title class_">HemisphericLight</span>) &#123;</span><br><span class="line">      info.<span class="property">direction</span> = light.<span class="property">direction</span></span><br><span class="line">      info.<span class="property">groundColor</span> = light.<span class="property">groundColor</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¿å­˜å…‰ç…§è®¾ç½®</span></span><br><span class="line">  <span class="title function_">saveLightingSetup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> setup = &#123;</span><br><span class="line">      <span class="attr">lights</span>: [],</span><br><span class="line">      <span class="attr">shadows</span>: [],</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">light, name</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">lights</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: name,</span><br><span class="line">        ...<span class="variable language_">this</span>.<span class="title function_">getLightInfo</span>(name),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadowGenerators</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">generator, lightName</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">shadows</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">lightName</span>: lightName,</span><br><span class="line">        <span class="attr">mapSize</span>: generator.<span class="property">mapSize</span>,</span><br><span class="line">        <span class="attr">bias</span>: generator.<span class="property">bias</span>,</span><br><span class="line">        <span class="attr">darkness</span>: generator.<span class="property">darkness</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> setup</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// èµ„æºæ¸…ç†</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadowGenerators</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">generator</span>) =&gt;</span> &#123;</span><br><span class="line">      generator.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadowGenerators</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">light</span>) =&gt;</span> &#123;</span><br><span class="line">      light.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> lightManager = <span class="keyword">new</span> <span class="title class_">LightManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºè‡ªå®šä¹‰å…‰æº</span></span><br><span class="line"><span class="keyword">const</span> fireLight = lightManager.<span class="title function_">createPointLight</span>(<span class="string">&#x27;fireLight&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>), <span class="number">2.0</span>)</span><br><span class="line">fireLight.<span class="property">diffuse</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">0.5</span>, <span class="number">0.1</span>) <span class="comment">// æ©™è‰²ç«å…‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ é—ªçƒæ•ˆæœ</span></span><br><span class="line"><span class="keyword">const</span> flicker = lightManager.<span class="title function_">addFlickerEffect</span>(<span class="string">&#x27;fireLight&#x27;</span>, <span class="number">0.3</span>, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®æ˜¼å¤œå¾ªç¯</span></span><br><span class="line"><span class="keyword">const</span> dayNight = lightManager.<span class="title function_">setupDayNightCycle</span>(<span class="number">60000</span>) <span class="comment">// 1åˆ†é’Ÿå‘¨æœŸ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ é˜´å½±æŠ•å°„è€…</span></span><br><span class="line">lightManager.<span class="title function_">addShadowCasters</span>(<span class="string">&#x27;sunLight&#x27;</span>, scene.<span class="property">meshes</span>)</span><br></pre></td></tr></table></figure><h2 id="ğŸ¨-Material-æè´¨ç³»ç»Ÿè¯¦è§£"><a href="#ğŸ¨-Material-æè´¨ç³»ç»Ÿè¯¦è§£" class="headerlink" title="ğŸ¨ Material æè´¨ç³»ç»Ÿè¯¦è§£"></a>ğŸ¨ Material æè´¨ç³»ç»Ÿè¯¦è§£</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Material æè´¨ç³»ç»Ÿå®Œæ•´ç®¡ç†</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MaterialManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">textures</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">nodeMaterials</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupDefaultMaterials</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupDefaultMaterials</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// æ ‡å‡†æè´¨</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createStandardMaterial</span>(<span class="string">&#x27;defaultStandard&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// PBRæè´¨</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createPBRMaterial</span>(<span class="string">&#x27;defaultPBR&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ— å…‰æè´¨</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createUnlitMaterial</span>(<span class="string">&#x27;defaultUnlit&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ‡å‡†æè´¨ (StandardMaterial)</span></span><br><span class="line">  <span class="title function_">createStandardMaterial</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">StandardMaterial</span>(name, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŸºç¡€é¢œè‰²å±æ€§</span></span><br><span class="line">    <span class="comment">// diffuseColor: Color3 - æ¼«åå°„é¢œè‰²</span></span><br><span class="line">    material.<span class="property">diffuseColor</span> = options.<span class="property">diffuseColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// specularColor: Color3 - é•œé¢åå°„é¢œè‰²</span></span><br><span class="line">    material.<span class="property">specularColor</span> = options.<span class="property">specularColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// emissiveColor: Color3 - è‡ªå‘å…‰é¢œè‰²</span></span><br><span class="line">    material.<span class="property">emissiveColor</span> = options.<span class="property">emissiveColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ambientColor: Color3 - ç¯å¢ƒå…‰é¢œè‰²</span></span><br><span class="line">    material.<span class="property">ambientColor</span> = options.<span class="property">ambientColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çº¹ç†å±æ€§</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">diffuseTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">diffuseTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">diffuseTexture</span>, name + <span class="string">&#x27;_diffuse&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">specularTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">specularTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">specularTexture</span>, name + <span class="string">&#x27;_specular&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">normalTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">bumpTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">normalTexture</span>, name + <span class="string">&#x27;_normal&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">emissiveTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">emissiveTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">emissiveTexture</span>, name + <span class="string">&#x27;_emissive&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">ambientTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">ambientTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">ambientTexture</span>, name + <span class="string">&#x27;_ambient&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…‰ç…§å±æ€§</span></span><br><span class="line">    <span class="comment">// specularPower: number - é•œé¢åå°„å¼ºåº¦ (1-128)</span></span><br><span class="line">    material.<span class="property">specularPower</span> = options.<span class="property">specularPower</span> || <span class="number">64</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€æ˜åº¦è®¾ç½®</span></span><br><span class="line">    <span class="comment">// alpha: number - é€æ˜åº¦ (0-1)</span></span><br><span class="line">    material.<span class="property">alpha</span> = options.<span class="property">alpha</span> !== <span class="literal">undefined</span> ? options.<span class="property">alpha</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// èƒŒé¢å‰”é™¤</span></span><br><span class="line">    <span class="comment">// backFaceCulling: boolean - æ˜¯å¦å‰”é™¤èƒŒé¢</span></span><br><span class="line">    material.<span class="property">backFaceCulling</span> =</span><br><span class="line">      options.<span class="property">backFaceCulling</span> !== <span class="literal">undefined</span> ? options.<span class="property">backFaceCulling</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒé¢æè´¨</span></span><br><span class="line">    <span class="comment">// twoSidedLighting: boolean - åŒé¢å…‰ç…§</span></span><br><span class="line">    material.<span class="property">twoSidedLighting</span> = options.<span class="property">twoSidedLighting</span> || <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// çº¿æ¡†æ¨¡å¼</span></span><br><span class="line">    <span class="comment">// wireframe: boolean - çº¿æ¡†æ˜¾ç¤º</span></span><br><span class="line">    material.<span class="property">wireframe</span> = options.<span class="property">wireframe</span> || <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç‚¹æ¨¡å¼</span></span><br><span class="line">    <span class="comment">// pointsCloud: boolean - ç‚¹äº‘æ˜¾ç¤º</span></span><br><span class="line">    material.<span class="property">pointsCloud</span> = options.<span class="property">pointsCloud</span> || <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// UVå˜æ¢</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">uOffset</span> || options.<span class="property">vOffset</span> || options.<span class="property">uScale</span> || options.<span class="property">vScale</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setupUVTransform</span>(material.<span class="property">diffuseTexture</span>, options)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">set</span>(name, material)</span><br><span class="line">    <span class="keyword">return</span> material</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// PBRæè´¨ (PBRMaterial) - åŸºäºç‰©ç†çš„æ¸²æŸ“</span></span><br><span class="line">  <span class="title function_">createPBRMaterial</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">PBRMaterial</span>(name, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŸºç¡€é¢œè‰²</span></span><br><span class="line">    <span class="comment">// baseColor: Color3 - åŸºç¡€é¢œè‰²</span></span><br><span class="line">    material.<span class="property">baseColor</span> = options.<span class="property">baseColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// baseTexture: Texture - åŸºç¡€é¢œè‰²çº¹ç†</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">baseTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">baseTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">baseTexture</span>, name + <span class="string">&#x27;_base&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡‘å±åº¦å’Œç²—ç³™åº¦</span></span><br><span class="line">    <span class="comment">// metallicFactor: number - é‡‘å±åº¦ (0-1)</span></span><br><span class="line">    material.<span class="property">metallicFactor</span> = options.<span class="property">metallicFactor</span> !== <span class="literal">undefined</span> ? options.<span class="property">metallicFactor</span> : <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// roughnessFactor: number - ç²—ç³™åº¦ (0-1)</span></span><br><span class="line">    material.<span class="property">roughnessFactor</span> = options.<span class="property">roughnessFactor</span> !== <span class="literal">undefined</span> ? options.<span class="property">roughnessFactor</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// metallicRoughnessTexture: Texture - é‡‘å±åº¦ç²—ç³™åº¦çº¹ç† (Ré€šé“-æœªä½¿ç”¨, Gé€šé“-ç²—ç³™åº¦, Bé€šé“-é‡‘å±åº¦)</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">metallicRoughnessTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">metallicRoughnessTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(</span><br><span class="line">        options.<span class="property">metallicRoughnessTexture</span>,</span><br><span class="line">        name + <span class="string">&#x27;_metallic_roughness&#x27;</span>,</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³•çº¿è´´å›¾</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">normalTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">normalTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">normalTexture</span>, name + <span class="string">&#x27;_normal&#x27;</span>)</span><br><span class="line">      material.<span class="property">normalTextureScale</span> = options.<span class="property">normalScale</span> || <span class="number">1.0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¯å¢ƒé®è”½</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">occlusionTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">ambientTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">occlusionTexture</span>, name + <span class="string">&#x27;_occlusion&#x27;</span>)</span><br><span class="line">      material.<span class="property">ambientTextureStrength</span> = options.<span class="property">occlusionStrength</span> || <span class="number">1.0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è‡ªå‘å…‰</span></span><br><span class="line">    <span class="comment">// emissiveColor: Color3 - è‡ªå‘å…‰é¢œè‰²</span></span><br><span class="line">    material.<span class="property">emissiveColor</span> = options.<span class="property">emissiveColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">emissiveTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">emissiveTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">emissiveTexture</span>, name + <span class="string">&#x27;_emissive&#x27;</span>)</span><br><span class="line">      material.<span class="property">emissiveIntensity</span> = options.<span class="property">emissiveIntensity</span> || <span class="number">1.0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€æ˜åº¦</span></span><br><span class="line">    material.<span class="property">alpha</span> = options.<span class="property">alpha</span> !== <span class="literal">undefined</span> ? options.<span class="property">alpha</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€æ˜åº¦æ¨¡å¼</span></span><br><span class="line">    <span class="comment">// alphaMode: number - é€æ˜åº¦æ¨¡å¼</span></span><br><span class="line">    <span class="comment">// ALPHA_DISABLE: ä¸é€æ˜</span></span><br><span class="line">    <span class="comment">// ALPHA_BLEND: é€æ˜æ··åˆ</span></span><br><span class="line">    <span class="comment">// ALPHA_MASK: é€æ˜è£å‰ª</span></span><br><span class="line">    material.<span class="property">transparencyMode</span> = options.<span class="property">transparencyMode</span> || <span class="title class_">PBRMaterial</span>.<span class="property">PBRMATERIAL_OPAQUE</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (material.<span class="property">transparencyMode</span> === <span class="title class_">PBRMaterial</span>.<span class="property">PBRMATERIAL_ALPHATEST</span>) &#123;</span><br><span class="line">      material.<span class="property">alphaCutOff</span> = options.<span class="property">alphaCutOff</span> || <span class="number">0.5</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŠ˜å°„ç‡</span></span><br><span class="line">    <span class="comment">// indexOfRefraction: number - æŠ˜å°„ç‡</span></span><br><span class="line">    material.<span class="property">indexOfRefraction</span> = options.<span class="property">indexOfRefraction</span> || <span class="number">1.5</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…æ¼†å±‚ (Clear Coat)</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">clearCoat</span>) &#123;</span><br><span class="line">      material.<span class="property">clearCoat</span>.<span class="property">isEnabled</span> = <span class="literal">true</span></span><br><span class="line">      material.<span class="property">clearCoat</span>.<span class="property">intensity</span> = options.<span class="property">clearCoat</span>.<span class="property">intensity</span> || <span class="number">1.0</span></span><br><span class="line">      material.<span class="property">clearCoat</span>.<span class="property">roughness</span> = options.<span class="property">clearCoat</span>.<span class="property">roughness</span> || <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">clearCoat</span>.<span class="property">texture</span>) &#123;</span><br><span class="line">        material.<span class="property">clearCoat</span>.<span class="property">texture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(</span><br><span class="line">          options.<span class="property">clearCoat</span>.<span class="property">texture</span>,</span><br><span class="line">          name + <span class="string">&#x27;_clearcoat&#x27;</span>,</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">clearCoat</span>.<span class="property">normalTexture</span>) &#123;</span><br><span class="line">        material.<span class="property">clearCoat</span>.<span class="property">bumpTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(</span><br><span class="line">          options.<span class="property">clearCoat</span>.<span class="property">normalTexture</span>,</span><br><span class="line">          name + <span class="string">&#x27;_clearcoat_normal&#x27;</span>,</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¬¡è¡¨é¢æ•£å°„ (Subsurface)</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">subsurface</span>) &#123;</span><br><span class="line">      material.<span class="property">subSurface</span>.<span class="property">isScatteringEnabled</span> = <span class="literal">true</span></span><br><span class="line">      material.<span class="property">subSurface</span>.<span class="property">scatteringColor</span> = options.<span class="property">subsurface</span>.<span class="property">color</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">      material.<span class="property">subSurface</span>.<span class="property">scatteringDistance</span> = options.<span class="property">subsurface</span>.<span class="property">distance</span> || <span class="number">1.0</span></span><br><span class="line">      material.<span class="property">subSurface</span>.<span class="property">scatteringIntensity</span> = options.<span class="property">subsurface</span>.<span class="property">intensity</span> || <span class="number">1.0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…‰æ³½ (Sheen)</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">sheen</span>) &#123;</span><br><span class="line">      material.<span class="property">sheen</span>.<span class="property">isEnabled</span> = <span class="literal">true</span></span><br><span class="line">      material.<span class="property">sheen</span>.<span class="property">color</span> = options.<span class="property">sheen</span>.<span class="property">color</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">      material.<span class="property">sheen</span>.<span class="property">intensity</span> = options.<span class="property">sheen</span>.<span class="property">intensity</span> || <span class="number">1.0</span></span><br><span class="line">      material.<span class="property">sheen</span>.<span class="property">roughness</span> = options.<span class="property">sheen</span>.<span class="property">roughness</span> || <span class="number">0.0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å„å‘å¼‚æ€§ (Anisotropy)</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">anisotropy</span>) &#123;</span><br><span class="line">      material.<span class="property">anisotropy</span>.<span class="property">isEnabled</span> = <span class="literal">true</span></span><br><span class="line">      material.<span class="property">anisotropy</span>.<span class="property">intensity</span> = options.<span class="property">anisotropy</span>.<span class="property">intensity</span> || <span class="number">1.0</span></span><br><span class="line">      material.<span class="property">anisotropy</span>.<span class="property">direction</span> = options.<span class="property">anisotropy</span>.<span class="property">direction</span> || <span class="keyword">new</span> <span class="title class_">Vector2</span>(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">set</span>(name, material)</span><br><span class="line">    <span class="keyword">return</span> material</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ— å…‰æè´¨ (UnlitMaterial) - ä¸å—å…‰ç…§å½±å“</span></span><br><span class="line">  <span class="title function_">createUnlitMaterial</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">UnlitMaterial</span>(name, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŸºç¡€é¢œè‰²</span></span><br><span class="line">    material.<span class="property">diffuseColor</span> = options.<span class="property">diffuseColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çº¹ç†</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">diffuseTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">diffuseTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">diffuseTexture</span>, name + <span class="string">&#x27;_diffuse&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€æ˜åº¦</span></span><br><span class="line">    material.<span class="property">alpha</span> = options.<span class="property">alpha</span> !== <span class="literal">undefined</span> ? options.<span class="property">alpha</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// èƒŒé¢å‰”é™¤</span></span><br><span class="line">    material.<span class="property">backFaceCulling</span> =</span><br><span class="line">      options.<span class="property">backFaceCulling</span> !== <span class="literal">undefined</span> ? options.<span class="property">backFaceCulling</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">set</span>(name, material)</span><br><span class="line">    <span class="keyword">return</span> material</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// èŠ‚ç‚¹æè´¨ (NodeMaterial) - å¯è§†åŒ–èŠ‚ç‚¹ç¼–è¾‘å™¨æè´¨</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">createNodeMaterial</span>(<span class="params">name, nodeJsonUrl</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">NodeMaterial</span>(name, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»JSONåŠ è½½èŠ‚ç‚¹æè´¨</span></span><br><span class="line">    <span class="keyword">await</span> material.<span class="title function_">loadFromUrl</span>(nodeJsonUrl)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„å»ºæè´¨</span></span><br><span class="line">    material.<span class="title function_">build</span>(<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">nodeMaterials</span>.<span class="title function_">set</span>(name, material)</span><br><span class="line">    <span class="keyword">return</span> material</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è‡ªå®šä¹‰ç€è‰²å™¨æè´¨ (ShaderMaterial)</span></span><br><span class="line">  <span class="title function_">createShaderMaterial</span>(<span class="params">name, vertexShader, fragmentShader, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> shaderMaterial = <span class="keyword">new</span> <span class="title class_">ShaderMaterial</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">vertex</span>: vertexShader,</span><br><span class="line">        <span class="attr">fragment</span>: fragmentShader,</span><br><span class="line">      &#125;,</span><br><span class="line">      options,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®uniforms</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">uniforms</span>) &#123;</span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">keys</span>(options.<span class="property">uniforms</span>).<span class="title function_">forEach</span>(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">        shaderMaterial.<span class="title function_">setFloat</span>(key, options.<span class="property">uniforms</span>[key])</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®çº¹ç†</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">textures</span>) &#123;</span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">keys</span>(options.<span class="property">textures</span>).<span class="title function_">forEach</span>(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> texture = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">textures</span>[key], <span class="string">`<span class="subst">$&#123;name&#125;</span>_<span class="subst">$&#123;key&#125;</span>`</span>)</span><br><span class="line">        shaderMaterial.<span class="title function_">setTexture</span>(key, texture)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">set</span>(name, shaderMaterial)</span><br><span class="line">    <span class="keyword">return</span> shaderMaterial</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¨‹åºåŒ–æè´¨</span></span><br><span class="line">  <span class="title function_">createProceduralMaterial</span>(<span class="params">name, type, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> material</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;wood&#x27;</span>:</span><br><span class="line">        material = <span class="variable language_">this</span>.<span class="title function_">createWoodMaterial</span>(name, options)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;marble&#x27;</span>:</span><br><span class="line">        material = <span class="variable language_">this</span>.<span class="title function_">createMarbleMaterial</span>(name, options)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;fire&#x27;</span>:</span><br><span class="line">        material = <span class="variable language_">this</span>.<span class="title function_">createFireMaterial</span>(name, options)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;water&#x27;</span>:</span><br><span class="line">        material = <span class="variable language_">this</span>.<span class="title function_">createWaterMaterial</span>(name, options)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;grass&#x27;</span>:</span><br><span class="line">        material = <span class="variable language_">this</span>.<span class="title function_">createGrassMaterial</span>(name, options)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;æœªçŸ¥çš„ç¨‹åºåŒ–æè´¨ç±»å‹:&#x27;</span>, type)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">set</span>(name, material)</span><br><span class="line">    <span class="keyword">return</span> material</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æœ¨ææè´¨</span></span><br><span class="line">  <span class="title function_">createWoodMaterial</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">WoodProceduralTexture</span>.<span class="title class_">WoodProceduralTexture</span>(name, <span class="number">256</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ¨æå‚æ•°</span></span><br><span class="line">    material.<span class="property">woodColor</span> = options.<span class="property">woodColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.49</span>, <span class="number">0.25</span>, <span class="number">0</span>)</span><br><span class="line">    material.<span class="property">ringColor</span> = options.<span class="property">ringColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.4</span>, <span class="number">0.1</span>, <span class="number">0.1</span>)</span><br><span class="line">    material.<span class="property">textureSize</span> = options.<span class="property">textureSize</span> || <span class="keyword">new</span> <span class="title class_">Vector2</span>(<span class="number">256</span>, <span class="number">256</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> standardMaterial = <span class="keyword">new</span> <span class="title class_">StandardMaterial</span>(name + <span class="string">&#x27;_standard&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    standardMaterial.<span class="property">diffuseTexture</span> = material</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> standardMaterial</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤§ç†çŸ³æè´¨</span></span><br><span class="line">  <span class="title function_">createMarbleMaterial</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">MarbleProceduralTexture</span>.<span class="title class_">MarbleProceduralTexture</span>(name, <span class="number">256</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤§ç†çŸ³å‚æ•°</span></span><br><span class="line">    material.<span class="property">marbleColor</span> = options.<span class="property">marbleColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.77</span>, <span class="number">0.47</span>, <span class="number">0.38</span>)</span><br><span class="line">    material.<span class="property">jointColor</span> = options.<span class="property">jointColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.72</span>, <span class="number">0.72</span>, <span class="number">0.72</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> standardMaterial = <span class="keyword">new</span> <span class="title class_">StandardMaterial</span>(name + <span class="string">&#x27;_standard&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    standardMaterial.<span class="property">diffuseTexture</span> = material</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> standardMaterial</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç«ç„°æè´¨</span></span><br><span class="line">  <span class="title function_">createFireMaterial</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">FireProceduralTexture</span>.<span class="title class_">FireProceduralTexture</span>(name, <span class="number">256</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç«ç„°å‚æ•°</span></span><br><span class="line">    material.<span class="property">fireColors</span> = options.<span class="property">fireColors</span> || <span class="title class_">FireProceduralTexture</span>.<span class="property">RedFireColors</span></span><br><span class="line">    material.<span class="property">speed</span> = options.<span class="property">speed</span> || <span class="keyword">new</span> <span class="title class_">Vector2</span>(<span class="number">1.0</span>, <span class="number">1.0</span>)</span><br><span class="line">    material.<span class="property">shift</span> = options.<span class="property">shift</span> || <span class="number">1.6</span></span><br><span class="line">    material.<span class="property">alpha</span> = options.<span class="property">alpha</span> || <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> unlitMaterial = <span class="keyword">new</span> <span class="title class_">UnlitMaterial</span>(name + <span class="string">&#x27;_unlit&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    unlitMaterial.<span class="property">diffuseTexture</span> = material</span><br><span class="line">    unlitMaterial.<span class="property">hasAlpha</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> unlitMaterial</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ°´æè´¨</span></span><br><span class="line">  <span class="title function_">createWaterMaterial</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> waterMesh = options.<span class="property">waterMesh</span></span><br><span class="line">    <span class="keyword">const</span> skybox = options.<span class="property">skybox</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> waterMaterial = <span class="keyword">new</span> <span class="title class_">WaterMaterial</span>(name, <span class="variable language_">this</span>.<span class="property">scene</span>, <span class="keyword">new</span> <span class="title class_">Vector2</span>(<span class="number">512</span>, <span class="number">512</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ°´é¢å‚æ•°</span></span><br><span class="line">    waterMaterial.<span class="property">backFaceCulling</span> = <span class="literal">true</span></span><br><span class="line">    waterMaterial.<span class="property">bumpTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(</span><br><span class="line">      options.<span class="property">bumpTexture</span> || <span class="string">&#x27;/textures/water_normal.jpg&#x27;</span>,</span><br><span class="line">      name + <span class="string">&#x27;_bump&#x27;</span>,</span><br><span class="line">    )</span><br><span class="line">    waterMaterial.<span class="property">windForce</span> = options.<span class="property">windForce</span> || -<span class="number">10</span></span><br><span class="line">    waterMaterial.<span class="property">waveHeight</span> = options.<span class="property">waveHeight</span> || <span class="number">0.5</span></span><br><span class="line">    waterMaterial.<span class="property">bumpHeight</span> = options.<span class="property">bumpHeight</span> || <span class="number">0.4</span></span><br><span class="line">    waterMaterial.<span class="property">windDirection</span> = options.<span class="property">windDirection</span> || <span class="keyword">new</span> <span class="title class_">Vector2</span>(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">    waterMaterial.<span class="property">waterColor</span> = options.<span class="property">waterColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.1</span>, <span class="number">0.1</span>, <span class="number">0.6</span>)</span><br><span class="line">    waterMaterial.<span class="property">colorBlendFactor</span> = options.<span class="property">colorBlendFactor</span> || <span class="number">0.2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ åˆ°æ¸²æŸ“åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">if</span> (waterMesh) &#123;</span><br><span class="line">      waterMaterial.<span class="title function_">addToRenderList</span>(waterMesh)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (skybox) &#123;</span><br><span class="line">      waterMaterial.<span class="title function_">addToRenderList</span>(skybox)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> waterMaterial</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è‰åœ°æè´¨</span></span><br><span class="line">  <span class="title function_">createGrassMaterial</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">GrassProceduralTexture</span>.<span class="title class_">GrassProceduralTexture</span>(name, <span class="number">256</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è‰åœ°å‚æ•°</span></span><br><span class="line">    material.<span class="property">grassColors</span> = options.<span class="property">grassColors</span> || [</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.29</span>, <span class="number">0.38</span>, <span class="number">0.02</span>),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.36</span>, <span class="number">0.49</span>, <span class="number">0.09</span>),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.51</span>, <span class="number">0.6</span>, <span class="number">0.28</span>),</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> standardMaterial = <span class="keyword">new</span> <span class="title class_">StandardMaterial</span>(name + <span class="string">&#x27;_standard&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    standardMaterial.<span class="property">diffuseTexture</span> = material</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> standardMaterial</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// çº¹ç†åŠ è½½å’Œç®¡ç†</span></span><br><span class="line">  <span class="title function_">loadTexture</span>(<span class="params">url, name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦å·²åŠ è½½</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">has</span>(name)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> texture = <span class="keyword">new</span> <span class="title class_">Texture</span>(url, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çº¹ç†è®¾ç½®</span></span><br><span class="line">    texture.<span class="property">name</span> = name</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒ…è£…æ¨¡å¼</span></span><br><span class="line">    <span class="comment">// WRAP_ADDRESSMODE: é‡å¤</span></span><br><span class="line">    <span class="comment">// CLAMP_ADDRESSMODE: é’³åˆ¶</span></span><br><span class="line">    <span class="comment">// MIRROR_ADDRESSMODE: é•œåƒ</span></span><br><span class="line">    texture.<span class="property">wrapU</span> = options.<span class="property">wrapU</span> || <span class="title class_">Texture</span>.<span class="property">WRAP_ADDRESSMODE</span></span><br><span class="line">    texture.<span class="property">wrapV</span> = options.<span class="property">wrapV</span> || <span class="title class_">Texture</span>.<span class="property">WRAP_ADDRESSMODE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿‡æ»¤æ¨¡å¼</span></span><br><span class="line">    <span class="comment">// NEAREST_SAMPLINGMODE: æœ€è¿‘é‚»</span></span><br><span class="line">    <span class="comment">// BILINEAR_SAMPLINGMODE: åŒçº¿æ€§</span></span><br><span class="line">    <span class="comment">// TRILINEAR_SAMPLINGMODE: ä¸‰çº¿æ€§</span></span><br><span class="line">    texture.<span class="property">samplingMode</span> = options.<span class="property">samplingMode</span> || <span class="title class_">Texture</span>.<span class="property">TRILINEAR_SAMPLINGMODE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Mipmap</span></span><br><span class="line">    texture.<span class="property">generateMipMaps</span> = options.<span class="property">generateMipMaps</span> !== <span class="literal">undefined</span> ? options.<span class="property">generateMipMaps</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å„å‘å¼‚æ€§è¿‡æ»¤</span></span><br><span class="line">    texture.<span class="property">anisotropicFilteringLevel</span> = options.<span class="property">anisotropicFilteringLevel</span> || <span class="number">4</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// UVåç§»å’Œç¼©æ”¾</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">uOffset</span> !== <span class="literal">undefined</span>) texture.<span class="property">uOffset</span> = options.<span class="property">uOffset</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">vOffset</span> !== <span class="literal">undefined</span>) texture.<span class="property">vOffset</span> = options.<span class="property">vOffset</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">uScale</span> !== <span class="literal">undefined</span>) texture.<span class="property">uScale</span> = options.<span class="property">uScale</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">vScale</span> !== <span class="literal">undefined</span>) texture.<span class="property">vScale</span> = options.<span class="property">vScale</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// UVæ—‹è½¬</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">uAng</span> !== <span class="literal">undefined</span>) texture.<span class="property">uAng</span> = options.<span class="property">uAng</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">vAng</span> !== <span class="literal">undefined</span>) texture.<span class="property">vAng</span> = options.<span class="property">vAng</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">wAng</span> !== <span class="literal">undefined</span>) texture.<span class="property">wAng</span> = options.<span class="property">wAng</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// çº§åˆ«è°ƒæ•´</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">level</span> !== <span class="literal">undefined</span>) texture.<span class="property">level</span> = options.<span class="property">level</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">set</span>(name, texture)</span><br><span class="line">    <span class="keyword">return</span> texture</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç«‹æ–¹ä½“çº¹ç†åŠ è½½ (Skybox/Environment)</span></span><br><span class="line">  <span class="title function_">loadCubeTexture</span>(<span class="params">urls, name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">has</span>(name)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> cubeTexture</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(urls)) &#123;</span><br><span class="line">      <span class="comment">// 6ä¸ªé¢çš„çº¹ç†</span></span><br><span class="line">      cubeTexture = <span class="keyword">new</span> <span class="title class_">CubeTexture</span>.<span class="title class_">CreateFromImages</span>(urls, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// DDSæˆ–HDRæ ¼å¼</span></span><br><span class="line">      cubeTexture = <span class="keyword">new</span> <span class="title class_">CubeTexture</span>(urls, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cubeTexture.<span class="property">name</span> = name</span><br><span class="line">    cubeTexture.<span class="property">coordinatesMode</span> = options.<span class="property">coordinatesMode</span> || <span class="title class_">Texture</span>.<span class="property">SKYBOX_MODE</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">set</span>(name, cubeTexture)</span><br><span class="line">    <span class="keyword">return</span> cubeTexture</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// UVå˜æ¢è®¾ç½®</span></span><br><span class="line">  <span class="title function_">setupUVTransform</span>(<span class="params">texture, options</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!texture) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">uOffset</span> !== <span class="literal">undefined</span>) texture.<span class="property">uOffset</span> = options.<span class="property">uOffset</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">vOffset</span> !== <span class="literal">undefined</span>) texture.<span class="property">vOffset</span> = options.<span class="property">vOffset</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">uScale</span> !== <span class="literal">undefined</span>) texture.<span class="property">uScale</span> = options.<span class="property">uScale</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">vScale</span> !== <span class="literal">undefined</span>) texture.<span class="property">vScale</span> = options.<span class="property">vScale</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">uAng</span> !== <span class="literal">undefined</span>) texture.<span class="property">uAng</span> = options.<span class="property">uAng</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">vAng</span> !== <span class="literal">undefined</span>) texture.<span class="property">vAng</span> = options.<span class="property">vAng</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// UVåŠ¨ç”»</span></span><br><span class="line">  <span class="title function_">animateUV</span>(<span class="params">textureName, property, targetValue, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> texture = <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">get</span>(textureName)</span><br><span class="line">    <span class="keyword">if</span> (!texture) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> animation = <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;textureName&#125;</span>_<span class="subst">$&#123;property&#125;</span>`</span>,</span><br><span class="line">      texture,</span><br><span class="line">      property,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">      texture[property],</span><br><span class="line">      targetValue,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ»šåŠ¨UVæ•ˆæœ</span></span><br><span class="line">  <span class="title function_">addScrollingUV</span>(<span class="params">textureName, speedU = <span class="number">0.01</span>, speedV = <span class="number">0.01</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> texture = <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">get</span>(textureName)</span><br><span class="line">    <span class="keyword">if</span> (!texture) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> observer = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      texture.<span class="property">uOffset</span> += speedU * <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>().<span class="title function_">getDeltaTime</span>() * <span class="number">0.001</span></span><br><span class="line">      texture.<span class="property">vOffset</span> += speedV * <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>().<span class="title function_">getDeltaTime</span>() * <span class="number">0.001</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// é˜²æ­¢æ•°å€¼è¿‡å¤§</span></span><br><span class="line">      <span class="keyword">if</span> (texture.<span class="property">uOffset</span> &gt; <span class="number">1</span>) texture.<span class="property">uOffset</span> -= <span class="number">1</span></span><br><span class="line">      <span class="keyword">if</span> (texture.<span class="property">vOffset</span> &gt; <span class="number">1</span>) texture.<span class="property">vOffset</span> -= <span class="number">1</span></span><br><span class="line">      <span class="keyword">if</span> (texture.<span class="property">uOffset</span> &lt; <span class="number">0</span>) texture.<span class="property">uOffset</span> += <span class="number">1</span></span><br><span class="line">      <span class="keyword">if</span> (texture.<span class="property">vOffset</span> &lt; <span class="number">0</span>) texture.<span class="property">vOffset</span> += <span class="number">1</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">dispose</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">remove</span>(observer)</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æè´¨æ··åˆ</span></span><br><span class="line">  <span class="title function_">blendMaterials</span>(<span class="params">name, material1, material2, blendFactor = <span class="number">0.5</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> blendedMaterial = <span class="keyword">new</span> <span class="title class_">StandardMaterial</span>(name, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ··åˆé¢œè‰²</span></span><br><span class="line">    blendedMaterial.<span class="property">diffuseColor</span> = <span class="title class_">Color3</span>.<span class="title class_">Lerp</span>(</span><br><span class="line">      material1.<span class="property">diffuseColor</span> || <span class="title class_">Color3</span>.<span class="title class_">White</span>(),</span><br><span class="line">      material2.<span class="property">diffuseColor</span> || <span class="title class_">Color3</span>.<span class="title class_">White</span>(),</span><br><span class="line">      blendFactor,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    blendedMaterial.<span class="property">specularColor</span> = <span class="title class_">Color3</span>.<span class="title class_">Lerp</span>(</span><br><span class="line">      material1.<span class="property">specularColor</span> || <span class="title class_">Color3</span>.<span class="title class_">White</span>(),</span><br><span class="line">      material2.<span class="property">specularColor</span> || <span class="title class_">Color3</span>.<span class="title class_">White</span>(),</span><br><span class="line">      blendFactor,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ··åˆçº¹ç†ï¼ˆé€šè¿‡æ··åˆç€è‰²å™¨ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (material1.<span class="property">diffuseTexture</span> &amp;&amp; material2.<span class="property">diffuseTexture</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> mixedShader = <span class="variable language_">this</span>.<span class="title function_">createTextureBlendShader</span>(</span><br><span class="line">        name + <span class="string">&#x27;_blend&#x27;</span>,</span><br><span class="line">        material1.<span class="property">diffuseTexture</span>,</span><br><span class="line">        material2.<span class="property">diffuseTexture</span>,</span><br><span class="line">        blendFactor,</span><br><span class="line">      )</span><br><span class="line">      blendedMaterial.<span class="property">diffuseTexture</span> = mixedShader</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">set</span>(name, blendedMaterial)</span><br><span class="line">    <span class="keyword">return</span> blendedMaterial</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// çº¹ç†æ··åˆç€è‰²å™¨</span></span><br><span class="line">  <span class="title function_">createTextureBlendShader</span>(<span class="params">name, texture1, texture2, blendFactor</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> shaderMaterial = <span class="keyword">new</span> <span class="title class_">ShaderMaterial</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">vertex</span>: <span class="string">`</span></span><br><span class="line"><span class="string">        precision highp float;</span></span><br><span class="line"><span class="string">        attribute vec3 position;</span></span><br><span class="line"><span class="string">        attribute vec2 uv;</span></span><br><span class="line"><span class="string">        uniform mat4 worldViewProjection;</span></span><br><span class="line"><span class="string">        varying vec2 vUV;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        void main(void) &#123;</span></span><br><span class="line"><span class="string">          gl_Position = worldViewProjection * vec4(position, 1.0);</span></span><br><span class="line"><span class="string">          vUV = uv;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      `</span>,</span><br><span class="line">        <span class="attr">fragment</span>: <span class="string">`</span></span><br><span class="line"><span class="string">        precision highp float;</span></span><br><span class="line"><span class="string">        varying vec2 vUV;</span></span><br><span class="line"><span class="string">        uniform sampler2D texture1;</span></span><br><span class="line"><span class="string">        uniform sampler2D texture2;</span></span><br><span class="line"><span class="string">        uniform float blendFactor;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        void main(void) &#123;</span></span><br><span class="line"><span class="string">          vec4 color1 = texture2D(texture1, vUV);</span></span><br><span class="line"><span class="string">          vec4 color2 = texture2D(texture2, vUV);</span></span><br><span class="line"><span class="string">          gl_FragColor = mix(color1, color2, blendFactor);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      `</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">attributes</span>: [<span class="string">&#x27;position&#x27;</span>, <span class="string">&#x27;uv&#x27;</span>],</span><br><span class="line">        <span class="attr">uniforms</span>: [<span class="string">&#x27;worldViewProjection&#x27;</span>, <span class="string">&#x27;blendFactor&#x27;</span>],</span><br><span class="line">        <span class="attr">samplers</span>: [<span class="string">&#x27;texture1&#x27;</span>, <span class="string">&#x27;texture2&#x27;</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    shaderMaterial.<span class="title function_">setTexture</span>(<span class="string">&#x27;texture1&#x27;</span>, texture1)</span><br><span class="line">    shaderMaterial.<span class="title function_">setTexture</span>(<span class="string">&#x27;texture2&#x27;</span>, texture2)</span><br><span class="line">    shaderMaterial.<span class="title function_">setFloat</span>(<span class="string">&#x27;blendFactor&#x27;</span>, blendFactor)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> shaderMaterial</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æè´¨åŠ¨ç”»</span></span><br><span class="line">  <span class="title function_">animateMaterial</span>(<span class="params">materialName, property, targetValue, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">get</span>(materialName)</span><br><span class="line">    <span class="keyword">if</span> (!material) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> animation = <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;materialName&#125;</span>_<span class="subst">$&#123;property&#125;</span>`</span>,</span><br><span class="line">      material,</span><br><span class="line">      property,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">      material[property],</span><br><span class="line">      targetValue,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æè´¨åˆ‡æ¢åŠ¨ç”»</span></span><br><span class="line">  <span class="title function_">createMaterialTransition</span>(<span class="params">mesh, fromMaterial, toMaterial, duration = <span class="number">1000</span></span>) &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºè¿‡æ¸¡æè´¨</span></span><br><span class="line">    <span class="keyword">const</span> transitionMaterial = fromMaterial.<span class="title function_">clone</span>(mesh.<span class="property">name</span> + <span class="string">&#x27;_transition&#x27;</span>)</span><br><span class="line">    mesh.<span class="property">material</span> = transitionMaterial</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯StandardMaterialï¼Œå¯ä»¥åŠ¨ç”»é¢œè‰²å±æ€§</span></span><br><span class="line">    <span class="keyword">if</span> (transitionMaterial <span class="keyword">instanceof</span> <span class="title class_">StandardMaterial</span> &amp;&amp; toMaterial <span class="keyword">instanceof</span> <span class="title class_">StandardMaterial</span>) &#123;</span><br><span class="line">      <span class="comment">// é¢œè‰²è¿‡æ¸¡</span></span><br><span class="line">      <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;materialTransition_diffuse&#x27;</span>,</span><br><span class="line">        transitionMaterial,</span><br><span class="line">        <span class="string">&#x27;diffuseColor&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">        fromMaterial.<span class="property">diffuseColor</span>.<span class="title function_">clone</span>(),</span><br><span class="line">        toMaterial.<span class="property">diffuseColor</span>.<span class="title function_">clone</span>(),</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// åŠ¨ç”»å®Œæˆååˆ‡æ¢åˆ°ç›®æ ‡æè´¨</span></span><br><span class="line">          mesh.<span class="property">material</span> = toMaterial</span><br><span class="line">          transitionMaterial.<span class="title function_">dispose</span>()</span><br><span class="line">        &#125;,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;materialTransition_specular&#x27;</span>,</span><br><span class="line">        transitionMaterial,</span><br><span class="line">        <span class="string">&#x27;specularColor&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">        fromMaterial.<span class="property">specularColor</span>.<span class="title function_">clone</span>(),</span><br><span class="line">        toMaterial.<span class="property">specularColor</span>.<span class="title function_">clone</span>(),</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–æè´¨ä¿¡æ¯</span></span><br><span class="line">  <span class="title function_">getMaterialInfo</span>(<span class="params">materialName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">get</span>(materialName)</span><br><span class="line">    <span class="keyword">if</span> (!material) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> info = &#123;</span><br><span class="line">      <span class="attr">name</span>: materialName,</span><br><span class="line">      <span class="attr">type</span>: material.<span class="title function_">getClassName</span>(),</span><br><span class="line">      <span class="attr">alpha</span>: material.<span class="property">alpha</span>,</span><br><span class="line">      <span class="attr">backFaceCulling</span>: material.<span class="property">backFaceCulling</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (material <span class="keyword">instanceof</span> <span class="title class_">StandardMaterial</span>) &#123;</span><br><span class="line">      info.<span class="property">diffuseColor</span> = material.<span class="property">diffuseColor</span></span><br><span class="line">      info.<span class="property">specularColor</span> = material.<span class="property">specularColor</span></span><br><span class="line">      info.<span class="property">emissiveColor</span> = material.<span class="property">emissiveColor</span></span><br><span class="line">      info.<span class="property">specularPower</span> = material.<span class="property">specularPower</span></span><br><span class="line">      info.<span class="property">hasTextures</span> = &#123;</span><br><span class="line">        <span class="attr">diffuse</span>: !!material.<span class="property">diffuseTexture</span>,</span><br><span class="line">        <span class="attr">specular</span>: !!material.<span class="property">specularTexture</span>,</span><br><span class="line">        <span class="attr">normal</span>: !!material.<span class="property">bumpTexture</span>,</span><br><span class="line">        <span class="attr">emissive</span>: !!material.<span class="property">emissiveTexture</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (material <span class="keyword">instanceof</span> <span class="title class_">PBRMaterial</span>) &#123;</span><br><span class="line">      info.<span class="property">baseColor</span> = material.<span class="property">baseColor</span></span><br><span class="line">      info.<span class="property">metallicFactor</span> = material.<span class="property">metallicFactor</span></span><br><span class="line">      info.<span class="property">roughnessFactor</span> = material.<span class="property">roughnessFactor</span></span><br><span class="line">      info.<span class="property">emissiveColor</span> = material.<span class="property">emissiveColor</span></span><br><span class="line">      info.<span class="property">hasTextures</span> = &#123;</span><br><span class="line">        <span class="attr">base</span>: !!material.<span class="property">baseTexture</span>,</span><br><span class="line">        <span class="attr">metallicRoughness</span>: !!material.<span class="property">metallicRoughnessTexture</span>,</span><br><span class="line">        <span class="attr">normal</span>: !!material.<span class="property">normalTexture</span>,</span><br><span class="line">        <span class="attr">emissive</span>: !!material.<span class="property">emissiveTexture</span>,</span><br><span class="line">        <span class="attr">occlusion</span>: !!material.<span class="property">ambientTexture</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ‰¹é‡åº”ç”¨æè´¨</span></span><br><span class="line">  <span class="title function_">applyMaterialToMeshes</span>(<span class="params">materialName, meshes</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">get</span>(materialName)</span><br><span class="line">    <span class="keyword">if</span> (!material) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    meshes.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      mesh.<span class="property">material</span> = material</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ¹æ®è·ç¦»åˆ‡æ¢æè´¨LOD</span></span><br><span class="line">  <span class="title function_">setupMaterialLOD</span>(<span class="params">meshName, materials</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getMeshByName</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// materials: [&#123; distance: number, material: string &#125;, ...]</span></span><br><span class="line">    <span class="keyword">const</span> sortedMaterials = materials.<span class="title function_">sort</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a.<span class="property">distance</span> - b.<span class="property">distance</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> observer = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">activeCamera</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> distance = <span class="title class_">Vector3</span>.<span class="title class_">Distance</span>(mesh.<span class="property">position</span>, <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">activeCamera</span>.<span class="property">position</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = sortedMaterials.<span class="property">length</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">if</span> (distance &gt;= sortedMaterials[i].<span class="property">distance</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> material = <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">get</span>(sortedMaterials[i].<span class="property">material</span>)</span><br><span class="line">          <span class="keyword">if</span> (material &amp;&amp; mesh.<span class="property">material</span> !== material) &#123;</span><br><span class="line">            mesh.<span class="property">material</span> = material</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">dispose</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">remove</span>(observer)</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¿å­˜æè´¨è®¾ç½®</span></span><br><span class="line">  <span class="title function_">saveMaterialSetup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> setup = &#123;</span><br><span class="line">      <span class="attr">materials</span>: [],</span><br><span class="line">      <span class="attr">textures</span>: [],</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">material, name</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">materials</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: name,</span><br><span class="line">        ...<span class="variable language_">this</span>.<span class="title function_">getMaterialInfo</span>(name),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">texture, name</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">textures</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: name,</span><br><span class="line">        <span class="attr">url</span>: texture.<span class="property">url</span>,</span><br><span class="line">        <span class="attr">wrapU</span>: texture.<span class="property">wrapU</span>,</span><br><span class="line">        <span class="attr">wrapV</span>: texture.<span class="property">wrapV</span>,</span><br><span class="line">        <span class="attr">uOffset</span>: texture.<span class="property">uOffset</span>,</span><br><span class="line">        <span class="attr">vOffset</span>: texture.<span class="property">vOffset</span>,</span><br><span class="line">        <span class="attr">uScale</span>: texture.<span class="property">uScale</span>,</span><br><span class="line">        <span class="attr">vScale</span>: texture.<span class="property">vScale</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> setup</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// èµ„æºæ¸…ç†</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">nodeMaterials</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">material</span>) =&gt;</span> &#123;</span><br><span class="line">      material.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">nodeMaterials</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">material</span>) =&gt;</span> &#123;</span><br><span class="line">      material.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">texture</span>) =&gt;</span> &#123;</span><br><span class="line">      texture.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> materialManager = <span class="keyword">new</span> <span class="title class_">MaterialManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºPBRé‡‘å±æè´¨</span></span><br><span class="line"><span class="keyword">const</span> metalMaterial = materialManager.<span class="title function_">createPBRMaterial</span>(<span class="string">&#x27;metal&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">baseColor</span>: <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.7</span>, <span class="number">0.7</span>, <span class="number">0.7</span>),</span><br><span class="line">  <span class="attr">metallicFactor</span>: <span class="number">1.0</span>,</span><br><span class="line">  <span class="attr">roughnessFactor</span>: <span class="number">0.2</span>,</span><br><span class="line">  <span class="attr">baseTexture</span>: <span class="string">&#x27;/textures/metal_base.jpg&#x27;</span>,</span><br><span class="line">  <span class="attr">normalTexture</span>: <span class="string">&#x27;/textures/metal_normal.jpg&#x27;</span>,</span><br><span class="line">  <span class="attr">metallicRoughnessTexture</span>: <span class="string">&#x27;/textures/metal_metallic_roughness.jpg&#x27;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºç¨‹åºåŒ–æœ¨ææè´¨</span></span><br><span class="line"><span class="keyword">const</span> woodMaterial = materialManager.<span class="title function_">createProceduralMaterial</span>(<span class="string">&#x27;wood&#x27;</span>, <span class="string">&#x27;wood&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">woodColor</span>: <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.6</span>, <span class="number">0.3</span>, <span class="number">0.1</span>),</span><br><span class="line">  <span class="attr">ringColor</span>: <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.4</span>, <span class="number">0.2</span>, <span class="number">0.05</span>),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åº”ç”¨æè´¨åˆ°ç½‘æ ¼</span></span><br><span class="line"><span class="keyword">const</span> sphere = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateSphere</span>(<span class="string">&#x27;sphere&#x27;</span>, &#123; <span class="attr">diameter</span>: <span class="number">2</span> &#125;, scene)</span><br><span class="line">sphere.<span class="property">material</span> = metalMaterial</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ UVæ»šåŠ¨æ•ˆæœ</span></span><br><span class="line"><span class="keyword">const</span> scrollEffect = materialManager.<span class="title function_">addScrollingUV</span>(<span class="string">&#x27;metal_metal_base&#x27;</span>, <span class="number">0.02</span>, <span class="number">0</span>)</span><br></pre></td></tr></table></figure><h2 id="ğŸ­-Mesh-ç½‘æ ¼ç³»ç»Ÿè¯¦è§£"><a href="#ğŸ­-Mesh-ç½‘æ ¼ç³»ç»Ÿè¯¦è§£" class="headerlink" title="ğŸ­ Mesh ç½‘æ ¼ç³»ç»Ÿè¯¦è§£"></a>ğŸ­ Mesh ç½‘æ ¼ç³»ç»Ÿè¯¦è§£</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Mesh ç½‘æ ¼ç³»ç»Ÿå®Œæ•´ç®¡ç†</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MeshManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">instancedMeshes</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mergedMeshes</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupBuiltInGeometries</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupBuiltInGeometries</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// æ³¨å†ŒåŸºç¡€å‡ ä½•ä½“åˆ›å»ºå™¨</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">geometryCreators</span> = &#123;</span><br><span class="line">      <span class="attr">box</span>: <span class="variable language_">this</span>.<span class="property">createBox</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">sphere</span>: <span class="variable language_">this</span>.<span class="property">createSphere</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">cylinder</span>: <span class="variable language_">this</span>.<span class="property">createCylinder</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">plane</span>: <span class="variable language_">this</span>.<span class="property">createPlane</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">ground</span>: <span class="variable language_">this</span>.<span class="property">createGround</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">torus</span>: <span class="variable language_">this</span>.<span class="property">createTorus</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">cone</span>: <span class="variable language_">this</span>.<span class="property">createCone</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">polyhedron</span>: <span class="variable language_">this</span>.<span class="property">createPolyhedron</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">ribbon</span>: <span class="variable language_">this</span>.<span class="property">createRibbon</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">tube</span>: <span class="variable language_">this</span>.<span class="property">createTube</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">lines</span>: <span class="variable language_">this</span>.<span class="property">createLines</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">dashedLines</span>: <span class="variable language_">this</span>.<span class="property">createDashedLines</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç«‹æ–¹ä½“åˆ›å»º</span></span><br><span class="line">  <span class="title function_">createBox</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// size: number - ç»Ÿä¸€å°ºå¯¸</span></span><br><span class="line">      <span class="attr">size</span>: options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// width, height, depth: number - åˆ†åˆ«è®¾ç½®å®½é«˜æ·±</span></span><br><span class="line">      <span class="attr">width</span>: options.<span class="property">width</span> || options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">height</span>: options.<span class="property">height</span> || options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">depth</span>: options.<span class="property">depth</span> || options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// faceUV: Vector4[] - æ¯ä¸ªé¢çš„UVåæ ‡</span></span><br><span class="line">      <span class="attr">faceUV</span>: options.<span class="property">faceUV</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// faceColors: Color4[] - æ¯ä¸ªé¢çš„é¢œè‰²</span></span><br><span class="line">      <span class="attr">faceColors</span>: options.<span class="property">faceColors</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number - é¢æœå‘</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// frontUVs, backUVs: Vector4 - æ­£é¢èƒŒé¢UV</span></span><br><span class="line">      <span class="attr">frontUVs</span>: options.<span class="property">frontUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">      <span class="attr">backUVs</span>: options.<span class="property">backUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line"></span><br><span class="line">      <span class="comment">// wrap: boolean - æ˜¯å¦ç¯ç»•</span></span><br><span class="line">      <span class="attr">wrap</span>: options.<span class="property">wrap</span> || <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// topBaseAt: number - é¡¶éƒ¨ä½ç½®</span></span><br><span class="line">      <span class="attr">topBaseAt</span>: options.<span class="property">topBaseAt</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// bottomBaseAt: number - åº•éƒ¨ä½ç½®</span></span><br><span class="line">      <span class="attr">bottomBaseAt</span>: options.<span class="property">bottomBaseAt</span> || <span class="number">0</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateBox</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// çƒä½“åˆ›å»º</span></span><br><span class="line">  <span class="title function_">createSphere</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// diameter: number - ç›´å¾„</span></span><br><span class="line">      <span class="attr">diameter</span>: options.<span class="property">diameter</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// diameterX, diameterY, diameterZ: number - æ¤­çƒå‚æ•°</span></span><br><span class="line">      <span class="attr">diameterX</span>: options.<span class="property">diameterX</span> || options.<span class="property">diameter</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">diameterY</span>: options.<span class="property">diameterY</span> || options.<span class="property">diameter</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">diameterZ</span>: options.<span class="property">diameterZ</span> || options.<span class="property">diameter</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// segments: number - åˆ†æ®µæ•°</span></span><br><span class="line">      <span class="attr">segments</span>: options.<span class="property">segments</span> || <span class="number">32</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// arc: number - å¼§åº¦ï¼ˆ0-1ï¼Œ1ä¸ºå®Œæ•´çƒä½“ï¼‰</span></span><br><span class="line">      <span class="attr">arc</span>: options.<span class="property">arc</span> || <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// slice: number - åˆ‡ç‰‡ï¼ˆ0-1ï¼Œ1ä¸ºå®Œæ•´çƒä½“ï¼‰</span></span><br><span class="line">      <span class="attr">slice</span>: options.<span class="property">slice</span> || <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number - é¢æœå‘</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// frontUVs, backUVs: Vector4</span></span><br><span class="line">      <span class="attr">frontUVs</span>: options.<span class="property">frontUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">      <span class="attr">backUVs</span>: options.<span class="property">backUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateSphere</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœ†æŸ±ä½“åˆ›å»º</span></span><br><span class="line">  <span class="title function_">createCylinder</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// height: number - é«˜åº¦</span></span><br><span class="line">      <span class="attr">height</span>: options.<span class="property">height</span> || <span class="number">2</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// diameterTop: number - é¡¶éƒ¨ç›´å¾„</span></span><br><span class="line">      <span class="attr">diameterTop</span>: options.<span class="property">diameterTop</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// diameterBottom: number - åº•éƒ¨ç›´å¾„</span></span><br><span class="line">      <span class="attr">diameterBottom</span>: options.<span class="property">diameterBottom</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// tessellation: number - åœ†å‘¨åˆ†æ®µæ•°</span></span><br><span class="line">      <span class="attr">tessellation</span>: options.<span class="property">tessellation</span> || <span class="number">24</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// subdivisions: number - é«˜åº¦ç»†åˆ†æ•°</span></span><br><span class="line">      <span class="attr">subdivisions</span>: options.<span class="property">subdivisions</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// arc: number - å¼§åº¦ï¼ˆ0-1ï¼‰</span></span><br><span class="line">      <span class="attr">arc</span>: options.<span class="property">arc</span> || <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// faceUV: Vector4[] - é¢UV</span></span><br><span class="line">      <span class="attr">faceUV</span>: options.<span class="property">faceUV</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// faceColors: Color4[] - é¢é¢œè‰²</span></span><br><span class="line">      <span class="attr">faceColors</span>: options.<span class="property">faceColors</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// hasRings: boolean - æ˜¯å¦æœ‰ç¯</span></span><br><span class="line">      <span class="attr">hasRings</span>: options.<span class="property">hasRings</span> || <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// enclose: boolean - æ˜¯å¦å°é—­</span></span><br><span class="line">      <span class="attr">enclose</span>: options.<span class="property">enclose</span> || <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateCylinder</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¹³é¢åˆ›å»º</span></span><br><span class="line">  <span class="title function_">createPlane</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// size: number - ç»Ÿä¸€å°ºå¯¸</span></span><br><span class="line">      <span class="attr">size</span>: options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// width, height: number - å®½åº¦å’Œé«˜åº¦</span></span><br><span class="line">      <span class="attr">width</span>: options.<span class="property">width</span> || options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">height</span>: options.<span class="property">height</span> || options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// frontUVs, backUVs: Vector4</span></span><br><span class="line">      <span class="attr">frontUVs</span>: options.<span class="property">frontUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">      <span class="attr">backUVs</span>: options.<span class="property">backUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sourcePlane: Plane - æºå¹³é¢</span></span><br><span class="line">      <span class="attr">sourcePlane</span>: options.<span class="property">sourcePlane</span> || <span class="literal">undefined</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreatePlane</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœ°é¢åˆ›å»º</span></span><br><span class="line">  <span class="title function_">createGround</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// width, height: number - åœ°é¢å°ºå¯¸</span></span><br><span class="line">      <span class="attr">width</span>: options.<span class="property">width</span> || <span class="number">10</span>,</span><br><span class="line">      <span class="attr">height</span>: options.<span class="property">height</span> || <span class="number">10</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// subdivisions: number - ç»†åˆ†æ•°</span></span><br><span class="line">      <span class="attr">subdivisions</span>: options.<span class="property">subdivisions</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// subdivisionsX, subdivisionsY: number - XYæ–¹å‘ç»†åˆ†</span></span><br><span class="line">      <span class="attr">subdivisionsX</span>: options.<span class="property">subdivisionsX</span> || options.<span class="property">subdivisions</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">subdivisionsY</span>: options.<span class="property">subdivisionsY</span> || options.<span class="property">subdivisions</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// updatable: boolean - æ˜¯å¦å¯æ›´æ–°</span></span><br><span class="line">      <span class="attr">updatable</span>: options.<span class="property">updatable</span> || <span class="literal">false</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateGround</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¯é¢åˆ›å»º</span></span><br><span class="line">  <span class="title function_">createTorus</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// diameter: number - å¤–ç›´å¾„</span></span><br><span class="line">      <span class="attr">diameter</span>: options.<span class="property">diameter</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// thickness: number - ç®¡å­ç²—ç»†</span></span><br><span class="line">      <span class="attr">thickness</span>: options.<span class="property">thickness</span> || <span class="number">0.5</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// tessellation: number - åˆ†æ®µæ•°</span></span><br><span class="line">      <span class="attr">tessellation</span>: options.<span class="property">tessellation</span> || <span class="number">16</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// frontUVs, backUVs: Vector4</span></span><br><span class="line">      <span class="attr">frontUVs</span>: options.<span class="property">frontUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">      <span class="attr">backUVs</span>: options.<span class="property">backUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateTorus</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœ†é”¥åˆ›å»º</span></span><br><span class="line">  <span class="title function_">createCone</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// diameter: number - åº•é¢ç›´å¾„</span></span><br><span class="line">      <span class="attr">diameter</span>: options.<span class="property">diameter</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// diameterTop: number - é¡¶é¢ç›´å¾„ï¼ˆ0ä¸ºå°–é”¥ï¼‰</span></span><br><span class="line">      <span class="attr">diameterTop</span>: options.<span class="property">diameterTop</span> || <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// diameterBottom: number - åº•é¢ç›´å¾„</span></span><br><span class="line">      <span class="attr">diameterBottom</span>: options.<span class="property">diameterBottom</span> || options.<span class="property">diameter</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// height: number - é«˜åº¦</span></span><br><span class="line">      <span class="attr">height</span>: options.<span class="property">height</span> || <span class="number">2</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// tessellation: number - åœ†å‘¨åˆ†æ®µ</span></span><br><span class="line">      <span class="attr">tessellation</span>: options.<span class="property">tessellation</span> || <span class="number">24</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// subdivisions: number - é«˜åº¦ç»†åˆ†</span></span><br><span class="line">      <span class="attr">subdivisions</span>: options.<span class="property">subdivisions</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// arc: number - å¼§åº¦</span></span><br><span class="line">      <span class="attr">arc</span>: options.<span class="property">arc</span> || <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// faceUV: Vector4[]</span></span><br><span class="line">      <span class="attr">faceUV</span>: options.<span class="property">faceUV</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// faceColors: Color4[]</span></span><br><span class="line">      <span class="attr">faceColors</span>: options.<span class="property">faceColors</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateCylinder</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤šé¢ä½“åˆ›å»º</span></span><br><span class="line">  <span class="title function_">createPolyhedron</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// type: number - å¤šé¢ä½“ç±»å‹</span></span><br><span class="line">      <span class="comment">// 0: å››é¢ä½“, 1: å…«é¢ä½“, 2: åäºŒé¢ä½“, 3: äºŒåé¢ä½“, 4: å…«é¢ä½“, 5: åäºŒé¢ä½“</span></span><br><span class="line">      <span class="attr">type</span>: options.<span class="property">type</span> || <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// size: number - å°ºå¯¸</span></span><br><span class="line">      <span class="attr">size</span>: options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sizeX, sizeY, sizeZ: number - å„è½´å°ºå¯¸</span></span><br><span class="line">      <span class="attr">sizeX</span>: options.<span class="property">sizeX</span> || options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">sizeY</span>: options.<span class="property">sizeY</span> || options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">sizeZ</span>: options.<span class="property">sizeZ</span> || options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// custom: object - è‡ªå®šä¹‰å¤šé¢ä½“æ•°æ®</span></span><br><span class="line">      <span class="attr">custom</span>: options.<span class="property">custom</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// faceUV: Vector4[]</span></span><br><span class="line">      <span class="attr">faceUV</span>: options.<span class="property">faceUV</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// faceColors: Color4[]</span></span><br><span class="line">      <span class="attr">faceColors</span>: options.<span class="property">faceColors</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// flat: boolean - æ˜¯å¦å¹³é¢ç€è‰²</span></span><br><span class="line">      <span class="attr">flat</span>: options.<span class="property">flat</span> || <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreatePolyhedron</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¸¦çŠ¶ç½‘æ ¼åˆ›å»º</span></span><br><span class="line">  <span class="title function_">createRibbon</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// pathArray: Vector3[][] - è·¯å¾„æ•°ç»„</span></span><br><span class="line">      <span class="attr">pathArray</span>: options.<span class="property">pathArray</span> || [</span><br><span class="line">        [<span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)],</span><br><span class="line">        [<span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>)],</span><br><span class="line">      ],</span><br><span class="line"></span><br><span class="line">      <span class="comment">// closeArray: boolean - æ˜¯å¦é—­åˆæ•°ç»„</span></span><br><span class="line">      <span class="attr">closeArray</span>: options.<span class="property">closeArray</span> || <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// closePath: boolean - æ˜¯å¦é—­åˆè·¯å¾„</span></span><br><span class="line">      <span class="attr">closePath</span>: options.<span class="property">closePath</span> || <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// offset: number - åç§»</span></span><br><span class="line">      <span class="attr">offset</span>: options.<span class="property">offset</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// frontUVs, backUVs: Vector4</span></span><br><span class="line">      <span class="attr">frontUVs</span>: options.<span class="property">frontUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">      <span class="attr">backUVs</span>: options.<span class="property">backUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line"></span><br><span class="line">      <span class="comment">// invertUV: boolean - æ˜¯å¦åè½¬UV</span></span><br><span class="line">      <span class="attr">invertUV</span>: options.<span class="property">invertUV</span> || <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// uvs: Vector2[] - UVåæ ‡æ•°ç»„</span></span><br><span class="line">      <span class="attr">uvs</span>: options.<span class="property">uvs</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// colors: Color4[] - é¢œè‰²æ•°ç»„</span></span><br><span class="line">      <span class="attr">colors</span>: options.<span class="property">colors</span> || <span class="literal">undefined</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateRibbon</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç®¡çŠ¶ç½‘æ ¼åˆ›å»º</span></span><br><span class="line">  <span class="title function_">createTube</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// path: Vector3[] - è·¯å¾„ç‚¹</span></span><br><span class="line">      <span class="attr">path</span>: options.<span class="property">path</span> || [<span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>)],</span><br><span class="line"></span><br><span class="line">      <span class="comment">// radius: number - åŠå¾„</span></span><br><span class="line">      <span class="attr">radius</span>: options.<span class="property">radius</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// tessellation: number - åœ†å‘¨åˆ†æ®µ</span></span><br><span class="line">      <span class="attr">tessellation</span>: options.<span class="property">tessellation</span> || <span class="number">8</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// radiusFunction: function - åŠå¾„å‡½æ•°</span></span><br><span class="line">      <span class="attr">radiusFunction</span>: options.<span class="property">radiusFunction</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// cap: number - ç«¯ç›–ç±»å‹</span></span><br><span class="line">      <span class="attr">cap</span>: options.<span class="property">cap</span> || <span class="title class_">Mesh</span>.<span class="property">NO_CAP</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// arc: number - å¼§åº¦</span></span><br><span class="line">      <span class="attr">arc</span>: options.<span class="property">arc</span> || <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// frontUVs, backUVs: Vector4</span></span><br><span class="line">      <span class="attr">frontUVs</span>: options.<span class="property">frontUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">      <span class="attr">backUVs</span>: options.<span class="property">backUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line"></span><br><span class="line">      <span class="comment">// invertUV: boolean</span></span><br><span class="line">      <span class="attr">invertUV</span>: options.<span class="property">invertUV</span> || <span class="literal">false</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateTube</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// çº¿æ¡åˆ›å»º</span></span><br><span class="line">  <span class="title function_">createLines</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// points: Vector3[] - ç‚¹æ•°ç»„</span></span><br><span class="line">      <span class="attr">points</span>: options.<span class="property">points</span> || [<span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)],</span><br><span class="line"></span><br><span class="line">      <span class="comment">// colors: Color4[] - é¢œè‰²æ•°ç»„</span></span><br><span class="line">      <span class="attr">colors</span>: options.<span class="property">colors</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// useVertexAlpha: boolean - æ˜¯å¦ä½¿ç”¨é¡¶ç‚¹é€æ˜åº¦</span></span><br><span class="line">      <span class="attr">useVertexAlpha</span>: options.<span class="property">useVertexAlpha</span> || <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateLines</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è™šçº¿åˆ›å»º</span></span><br><span class="line">  <span class="title function_">createDashedLines</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// points: Vector3[] - ç‚¹æ•°ç»„</span></span><br><span class="line">      <span class="attr">points</span>: options.<span class="property">points</span> || [<span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)],</span><br><span class="line"></span><br><span class="line">      <span class="comment">// dashSize: number - è™šçº¿é•¿åº¦</span></span><br><span class="line">      <span class="attr">dashSize</span>: options.<span class="property">dashSize</span> || <span class="number">3</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// gapSize: number - é—´éš™é•¿åº¦</span></span><br><span class="line">      <span class="attr">gapSize</span>: options.<span class="property">gapSize</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// dashNb: number - è™šçº¿æ•°é‡</span></span><br><span class="line">      <span class="attr">dashNb</span>: options.<span class="property">dashNb</span> || <span class="number">200</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// useVertexAlpha: boolean</span></span><br><span class="line">      <span class="attr">useVertexAlpha</span>: options.<span class="property">useVertexAlpha</span> || <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateDashedLines</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®ç½‘æ ¼é»˜è®¤å±æ€§</span></span><br><span class="line">  <span class="title function_">setupMeshDefaults</span>(<span class="params">mesh, options</span>) &#123;</span><br><span class="line">    <span class="comment">// ä½ç½®å˜æ¢</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">position</span>) mesh.<span class="property">position</span> = options.<span class="property">position</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">rotation</span>) mesh.<span class="property">rotation</span> = options.<span class="property">rotation</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">scaling</span>) mesh.<span class="property">scaling</span> = options.<span class="property">scaling</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æè´¨</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">material</span>) mesh.<span class="property">material</span> = options.<span class="property">material</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯è§æ€§</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">visibility</span> !== <span class="literal">undefined</span>) mesh.<span class="property">visibility</span> = options.<span class="property">visibility</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">isVisible</span> !== <span class="literal">undefined</span>) mesh.<span class="property">isVisible</span> = options.<span class="property">isVisible</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸²æŸ“å±æ€§</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">receiveShadows</span> !== <span class="literal">undefined</span>) mesh.<span class="property">receiveShadows</span> = options.<span class="property">receiveShadows</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">checkCollisions</span> !== <span class="literal">undefined</span>) mesh.<span class="property">checkCollisions</span> = options.<span class="property">checkCollisions</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">isPickable</span> !== <span class="literal">undefined</span>) mesh.<span class="property">isPickable</span> = options.<span class="property">isPickable</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸²æŸ“ç»„</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">renderingGroupId</span> !== <span class="literal">undefined</span>) mesh.<span class="property">renderingGroupId</span> = options.<span class="property">renderingGroupId</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è‡ªå®šä¹‰å±æ€§</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">metadata</span>) mesh.<span class="property">metadata</span> = options.<span class="property">metadata</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç½‘æ ¼å®ä¾‹åŒ–</span></span><br><span class="line">  <span class="title function_">createInstances</span>(<span class="params">sourceMeshName, count, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> sourceMesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(sourceMeshName)</span><br><span class="line">    <span class="keyword">if</span> (!sourceMesh) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;æºç½‘æ ¼ä¸å­˜åœ¨:&#x27;</span>, sourceMeshName)</span><br><span class="line">      <span class="keyword">return</span> []</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> instances = []</span><br><span class="line">    <span class="keyword">const</span> instanceName = options.<span class="property">namePrefix</span> || sourceMeshName + <span class="string">&#x27;_instance&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> instance = sourceMesh.<span class="title function_">createInstance</span>(<span class="string">`<span class="subst">$&#123;instanceName&#125;</span>_<span class="subst">$&#123;i&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// éšæœºæˆ–æŒ‡å®šä½ç½®</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">positions</span> &amp;&amp; options.<span class="property">positions</span>[i]) &#123;</span><br><span class="line">        instance.<span class="property">position</span> = options.<span class="property">positions</span>[i]</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options.<span class="property">randomPosition</span>) &#123;</span><br><span class="line">        instance.<span class="property">position</span> = <span class="variable language_">this</span>.<span class="title function_">generateRandomPosition</span>(options.<span class="property">randomPosition</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// éšæœºæˆ–æŒ‡å®šæ—‹è½¬</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">rotations</span> &amp;&amp; options.<span class="property">rotations</span>[i]) &#123;</span><br><span class="line">        instance.<span class="property">rotation</span> = options.<span class="property">rotations</span>[i]</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options.<span class="property">randomRotation</span>) &#123;</span><br><span class="line">        instance.<span class="property">rotation</span> = <span class="variable language_">this</span>.<span class="title function_">generateRandomRotation</span>(options.<span class="property">randomRotation</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// éšæœºæˆ–æŒ‡å®šç¼©æ”¾</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">scalings</span> &amp;&amp; options.<span class="property">scalings</span>[i]) &#123;</span><br><span class="line">        instance.<span class="property">scaling</span> = options.<span class="property">scalings</span>[i]</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options.<span class="property">randomScaling</span>) &#123;</span><br><span class="line">        instance.<span class="property">scaling</span> = <span class="variable language_">this</span>.<span class="title function_">generateRandomScaling</span>(options.<span class="property">randomScaling</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      instances.<span class="title function_">push</span>(instance)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">instancedMeshes</span>.<span class="title function_">set</span>(sourceMeshName, instances)</span><br><span class="line">    <span class="keyword">return</span> instances</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç”Ÿæˆéšæœºä½ç½®</span></span><br><span class="line">  <span class="title function_">generateRandomPosition</span>(<span class="params">bounds</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; min = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">10</span>, <span class="number">0</span>, -<span class="number">10</span>), max = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>) &#125; = bounds</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Vector3</span>(</span><br><span class="line">      min.<span class="property">x</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">x</span> - min.<span class="property">x</span>),</span><br><span class="line">      min.<span class="property">y</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">y</span> - min.<span class="property">y</span>),</span><br><span class="line">      min.<span class="property">z</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">z</span> - min.<span class="property">z</span>),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç”Ÿæˆéšæœºæ—‹è½¬</span></span><br><span class="line">  <span class="title function_">generateRandomRotation</span>(<span class="params">bounds</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; min = <span class="title class_">Vector3</span>.<span class="title class_">Zero</span>(), max = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>) &#125; =</span><br><span class="line">      bounds</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Vector3</span>(</span><br><span class="line">      min.<span class="property">x</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">x</span> - min.<span class="property">x</span>),</span><br><span class="line">      min.<span class="property">y</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">y</span> - min.<span class="property">y</span>),</span><br><span class="line">      min.<span class="property">z</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">z</span> - min.<span class="property">z</span>),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç”Ÿæˆéšæœºç¼©æ”¾</span></span><br><span class="line">  <span class="title function_">generateRandomScaling</span>(<span class="params">bounds</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; min = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>), max = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1.5</span>, <span class="number">1.5</span>, <span class="number">1.5</span>) &#125; = bounds</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Vector3</span>(</span><br><span class="line">      min.<span class="property">x</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">x</span> - min.<span class="property">x</span>),</span><br><span class="line">      min.<span class="property">y</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">y</span> - min.<span class="property">y</span>),</span><br><span class="line">      min.<span class="property">z</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">z</span> - min.<span class="property">z</span>),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç½‘æ ¼åˆå¹¶</span></span><br><span class="line">  <span class="title function_">mergeMeshes</span>(<span class="params">meshNames, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> meshesToMerge = meshNames.<span class="title function_">map</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(name)).<span class="title function_">filter</span>(<span class="title class_">Boolean</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (meshesToMerge.<span class="property">length</span> &lt; <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;è‡³å°‘éœ€è¦2ä¸ªç½‘æ ¼è¿›è¡Œåˆå¹¶&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mergedMesh = <span class="title class_">Mesh</span>.<span class="title class_">MergeMeshes</span>(</span><br><span class="line">      meshesToMerge,</span><br><span class="line">      options.<span class="property">disposeSource</span> !== <span class="literal">false</span>, <span class="comment">// é»˜è®¤é”€æ¯æºç½‘æ ¼</span></span><br><span class="line">      options.<span class="property">allow32BitsIndices</span> !== <span class="literal">false</span>, <span class="comment">// å…è®¸32ä½ç´¢å¼•</span></span><br><span class="line">      options.<span class="property">meshSubclass</span> || <span class="literal">undefined</span>,</span><br><span class="line">      options.<span class="property">subdivideWithSubMeshes</span> || <span class="literal">false</span>,</span><br><span class="line">      options.<span class="property">multiMultiMaterials</span> || <span class="literal">false</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mergedMesh) &#123;</span><br><span class="line">      <span class="keyword">const</span> mergedName = options.<span class="property">name</span> || <span class="string">&#x27;merged_&#x27;</span> + meshNames.<span class="title function_">join</span>(<span class="string">&#x27;_&#x27;</span>)</span><br><span class="line">      mergedMesh.<span class="property">name</span> = mergedName</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">mergedMeshes</span>.<span class="title function_">set</span>(mergedName, mergedMesh)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ä»åŸå§‹ç½‘æ ¼æ˜ å°„ä¸­ç§»é™¤å·²åˆå¹¶çš„ç½‘æ ¼</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">disposeSource</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">        meshNames.<span class="title function_">forEach</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">delete</span>(name))</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(mergedName, mergedMesh)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mergedMesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç½‘æ ¼ç®€åŒ–</span></span><br><span class="line">  <span class="title function_">simplifyMesh</span>(<span class="params">meshName, settings = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> simplificationSettings = [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">quality</span>: settings.<span class="property">quality</span> || <span class="number">0.5</span>,</span><br><span class="line">        <span class="attr">distance</span>: settings.<span class="property">distance</span> || <span class="number">10</span>,</span><br><span class="line">        <span class="attr">optimizeMesh</span>: settings.<span class="property">optimizeMesh</span> !== <span class="literal">false</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨å››è¾¹å½¢ç®€åŒ–</span></span><br><span class="line">    <span class="keyword">const</span> task = mesh.<span class="title function_">simplify</span>(</span><br><span class="line">      simplificationSettings,</span><br><span class="line">      settings.<span class="property">parallelProcessing</span> !== <span class="literal">false</span>,</span><br><span class="line">      <span class="title class_">SimplificationType</span>.<span class="property">QUADRATIC</span>,</span><br><span class="line">      <span class="function">(<span class="params">simplifiedMesh</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç½‘æ ¼ç®€åŒ–å®Œæˆ:&#x27;</span>, meshName)</span><br><span class="line">        <span class="keyword">if</span> (settings.<span class="property">onSuccess</span>) settings.<span class="title function_">onSuccess</span>(simplifiedMesh)</span><br><span class="line">      &#125;,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> task</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç½‘æ ¼ä¼˜åŒ–</span></span><br><span class="line">  <span class="title function_">optimizeMesh</span>(<span class="params">meshName, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†»ç»“ä¸–ç•ŒçŸ©é˜µ</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">freezeWorldMatrix</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">      mesh.<span class="title function_">freezeWorldMatrix</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†»ç»“æ³•çº¿</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">freezeNormals</span>) &#123;</span><br><span class="line">      mesh.<span class="title function_">freezeNormals</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®ä¸ºä¸å¯æ›´æ–°</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">makeGeometryUnique</span>) &#123;</span><br><span class="line">      mesh.<span class="title function_">makeGeometryUnique</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è½¬æ¢ä¸ºå®ä¾‹åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">convertToInstancedMesh</span> &amp;&amp; mesh.<span class="property">instances</span>.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// åˆ›å»ºå•ä¸ªå®ä¾‹ä»¥å¯ç”¨å®ä¾‹åŒ–ä¼˜åŒ–</span></span><br><span class="line">      <span class="keyword">const</span> instance = mesh.<span class="title function_">createInstance</span>(mesh.<span class="property">name</span> + <span class="string">&#x27;_instance_0&#x27;</span>)</span><br><span class="line">      instance.<span class="property">position</span> = mesh.<span class="property">position</span>.<span class="title function_">clone</span>()</span><br><span class="line">      instance.<span class="property">rotation</span> = mesh.<span class="property">rotation</span>.<span class="title function_">clone</span>()</span><br><span class="line">      instance.<span class="property">scaling</span> = mesh.<span class="property">scaling</span>.<span class="title function_">clone</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç½‘æ ¼ä¼˜åŒ–å®Œæˆ:&#x27;</span>, meshName)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç½‘æ ¼åŠ¨ç”»</span></span><br><span class="line">  <span class="title function_">animateMesh</span>(<span class="params">meshName, property, targetValue, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> animation = <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;meshName&#125;</span>_<span class="subst">$&#123;property&#125;</span>`</span>,</span><br><span class="line">      mesh,</span><br><span class="line">      property,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">      mesh[property],</span><br><span class="line">      targetValue,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç½‘æ ¼å˜å½¢</span></span><br><span class="line">  <span class="title function_">morphMesh</span>(<span class="params">meshName, targetPositions, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> positions = mesh.<span class="title function_">getVerticesData</span>(<span class="title class_">VertexBuffer</span>.<span class="property">PositionKind</span>)</span><br><span class="line">    <span class="keyword">if</span> (!positions || positions.<span class="property">length</span> !== targetPositions.<span class="property">length</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;ç›®æ ‡ä½ç½®æ•°æ®é•¿åº¦ä¸åŒ¹é…&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºå˜å½¢åŠ¨ç”»</span></span><br><span class="line">    <span class="keyword">const</span> morphAnimation = <span class="keyword">new</span> <span class="title class_">Animation</span>(</span><br><span class="line">      <span class="string">&#x27;meshMorph&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;position&#x27;</span>,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> frameCount = (duration / <span class="number">1000</span>) * <span class="number">30</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= frameCount; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> progress = i / frameCount</span><br><span class="line">      <span class="keyword">const</span> interpolatedPositions = []</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; positions.<span class="property">length</span>; j += <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> startPos = <span class="keyword">new</span> <span class="title class_">Vector3</span>(positions[j], positions[j + <span class="number">1</span>], positions[j + <span class="number">2</span>])</span><br><span class="line">        <span class="keyword">const</span> endPos = <span class="keyword">new</span> <span class="title class_">Vector3</span>(</span><br><span class="line">          targetPositions[j],</span><br><span class="line">          targetPositions[j + <span class="number">1</span>],</span><br><span class="line">          targetPositions[j + <span class="number">2</span>],</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">const</span> interpolated = <span class="title class_">Vector3</span>.<span class="title class_">Lerp</span>(startPos, endPos, progress)</span><br><span class="line"></span><br><span class="line">        interpolatedPositions.<span class="title function_">push</span>(interpolated.<span class="property">x</span>, interpolated.<span class="property">y</span>, interpolated.<span class="property">z</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: i,</span><br><span class="line">        <span class="attr">value</span>: interpolatedPositions,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    morphAnimation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡ŒåŠ¨ç”»</span></span><br><span class="line">    <span class="keyword">const</span> animatable = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">beginDirectAnimation</span>(</span><br><span class="line">      mesh,</span><br><span class="line">      [morphAnimation],</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      frameCount,</span><br><span class="line">      <span class="literal">false</span>,</span><br><span class="line">      <span class="number">1</span>,</span><br><span class="line">      <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// åŠ¨ç”»å®Œæˆåæ›´æ–°é¡¶ç‚¹æ•°æ®</span></span><br><span class="line">        mesh.<span class="title function_">updateVerticesData</span>(<span class="title class_">VertexBuffer</span>.<span class="property">PositionKind</span>, targetPositions)</span><br><span class="line">        mesh.<span class="title function_">refreshBoundingInfo</span>()</span><br><span class="line">      &#125;,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> animatable</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç½‘æ ¼ç¢°æ’æ£€æµ‹</span></span><br><span class="line">  <span class="title function_">setupCollision</span>(<span class="params">meshName, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯ç”¨ç¢°æ’æ£€æµ‹</span></span><br><span class="line">    mesh.<span class="property">checkCollisions</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®æ¤­çƒä½“ç¢°æ’å™¨</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">ellipsoid</span>) &#123;</span><br><span class="line">      mesh.<span class="property">ellipsoid</span> = options.<span class="property">ellipsoid</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®æ¤­çƒä½“åç§»</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">ellipsoidOffset</span>) &#123;</span><br><span class="line">      mesh.<span class="property">ellipsoidOffset</span> = options.<span class="property">ellipsoidOffset</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç§»åŠ¨ç¢°æ’å›è°ƒ</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">onCollide</span>) &#123;</span><br><span class="line">      mesh.<span class="property">onCollide</span> = options.<span class="property">onCollide</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¢°æ’ä½ç½®å›è°ƒ</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">onCollisionPositionChange</span>) &#123;</span><br><span class="line">      mesh.<span class="property">onCollisionPositionChange</span> = options.<span class="property">onCollisionPositionChange</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç½‘æ ¼ç‰©ç†è®¾ç½®</span></span><br><span class="line">  <span class="title function_">setupPhysics</span>(<span class="params">meshName, impostor, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> physicsOptions = &#123;</span><br><span class="line">      <span class="attr">mass</span>: options.<span class="property">mass</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">restitution</span>: options.<span class="property">restitution</span> || <span class="number">0.7</span>,</span><br><span class="line">      <span class="attr">friction</span>: options.<span class="property">friction</span> || <span class="number">0.2</span>,</span><br><span class="line">      ...options,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mesh.<span class="property">physicsImpostor</span> = <span class="keyword">new</span> <span class="title class_">PhysicsImpostor</span>(mesh, impostor, physicsOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh.<span class="property">physicsImpostor</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç½‘æ ¼LODç³»ç»Ÿ</span></span><br><span class="line">  <span class="title function_">setupLOD</span>(<span class="params">meshName, lodMeshes</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// lodMeshes: [&#123; distance: number, mesh: string &#125;, ...]</span></span><br><span class="line">    lodMeshes.<span class="title function_">forEach</span>(<span class="function">(<span class="params">lod</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> lodMesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(lod.<span class="property">mesh</span>)</span><br><span class="line">      <span class="keyword">if</span> (lodMesh) &#123;</span><br><span class="line">        mesh.<span class="title function_">addLODLevel</span>(lod.<span class="property">distance</span>, lodMesh)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ å®Œå…¨éšè—çº§åˆ«</span></span><br><span class="line">    <span class="keyword">if</span> (lodMeshes.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> maxDistance = <span class="title class_">Math</span>.<span class="title function_">max</span>(...lodMeshes.<span class="title function_">map</span>(<span class="function">(<span class="params">lod</span>) =&gt;</span> lod.<span class="property">distance</span>))</span><br><span class="line">      mesh.<span class="title function_">addLODLevel</span>(maxDistance * <span class="number">2</span>, <span class="literal">null</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–ç½‘æ ¼ä¿¡æ¯</span></span><br><span class="line">  <span class="title function_">getMeshInfo</span>(<span class="params">meshName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> info = &#123;</span><br><span class="line">      <span class="attr">name</span>: meshName,</span><br><span class="line">      <span class="attr">id</span>: mesh.<span class="property">id</span>,</span><br><span class="line">      <span class="attr">uniqueId</span>: mesh.<span class="property">uniqueId</span>,</span><br><span class="line">      <span class="attr">position</span>: mesh.<span class="property">position</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">rotation</span>: mesh.<span class="property">rotation</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">scaling</span>: mesh.<span class="property">scaling</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">visibility</span>: mesh.<span class="property">visibility</span>,</span><br><span class="line">      <span class="attr">isVisible</span>: mesh.<span class="property">isVisible</span>,</span><br><span class="line">      <span class="attr">isEnabled</span>: mesh.<span class="title function_">isEnabled</span>(),</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å‡ ä½•ä¿¡æ¯</span></span><br><span class="line">      <span class="attr">totalVertices</span>: mesh.<span class="title function_">getTotalVertices</span>(),</span><br><span class="line">      <span class="attr">totalIndices</span>: mesh.<span class="title function_">getTotalIndices</span>(),</span><br><span class="line">      <span class="attr">boundingInfo</span>: &#123;</span><br><span class="line">        <span class="attr">boundingBox</span>: mesh.<span class="title function_">getBoundingInfo</span>().<span class="property">boundingBox</span>,</span><br><span class="line">        <span class="attr">boundingSphere</span>: mesh.<span class="title function_">getBoundingInfo</span>().<span class="property">boundingSphere</span>,</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æè´¨ä¿¡æ¯</span></span><br><span class="line">      <span class="attr">material</span>: mesh.<span class="property">material</span> ? mesh.<span class="property">material</span>.<span class="property">name</span> : <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å®ä¾‹ä¿¡æ¯</span></span><br><span class="line">      <span class="attr">hasInstances</span>: mesh.<span class="property">instances</span>.<span class="property">length</span> &gt; <span class="number">0</span>,</span><br><span class="line">      <span class="attr">instanceCount</span>: mesh.<span class="property">instances</span>.<span class="property">length</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ç‰©ç†ä¿¡æ¯</span></span><br><span class="line">      <span class="attr">hasPhysics</span>: !!mesh.<span class="property">physicsImpostor</span>,</span><br><span class="line">      <span class="attr">checkCollisions</span>: mesh.<span class="property">checkCollisions</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// LODä¿¡æ¯</span></span><br><span class="line">      <span class="attr">hasLODLevels</span>: mesh.<span class="title function_">getLODLevels</span>().<span class="property">length</span> &gt; <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ€§èƒ½ä¿¡æ¯</span></span><br><span class="line">      <span class="attr">isWorldMatrixFrozen</span>: mesh.<span class="property">isWorldMatrixFrozen</span>,</span><br><span class="line">      <span class="attr">doNotSyncBoundingInfo</span>: mesh.<span class="property">doNotSyncBoundingInfo</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç½‘æ ¼æœç´¢å’Œè¿‡æ»¤</span></span><br><span class="line">  <span class="title function_">findMeshes</span>(<span class="params">filter</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> results = []</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh, name</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> match = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (filter.<span class="property">name</span> &amp;&amp; !name.<span class="title function_">includes</span>(filter.<span class="property">name</span>)) match = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">if</span> (filter.<span class="property">tag</span> &amp;&amp; (!mesh.<span class="property">metadata</span> || !mesh.<span class="property">metadata</span>.<span class="property">tag</span> || mesh.<span class="property">metadata</span>.<span class="property">tag</span> !== filter.<span class="property">tag</span>))</span><br><span class="line">        match = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">if</span> (filter.<span class="property">material</span> &amp;&amp; (!mesh.<span class="property">material</span> || mesh.<span class="property">material</span>.<span class="property">name</span> !== filter.<span class="property">material</span>))</span><br><span class="line">        match = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">if</span> (filter.<span class="property">hasPhysics</span> !== <span class="literal">undefined</span> &amp;&amp; !!mesh.<span class="property">physicsImpostor</span> !== filter.<span class="property">hasPhysics</span>)</span><br><span class="line">        match = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">if</span> (filter.<span class="property">isVisible</span> !== <span class="literal">undefined</span> &amp;&amp; mesh.<span class="property">isVisible</span> !== filter.<span class="property">isVisible</span>) match = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (match) &#123;</span><br><span class="line">        results.<span class="title function_">push</span>(&#123; name, mesh &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ‰¹é‡æ“ä½œ</span></span><br><span class="line">  <span class="title function_">batchOperation</span>(<span class="params">meshNames, operation, ...args</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> results = []</span><br><span class="line"></span><br><span class="line">    meshNames.<span class="title function_">forEach</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(name)</span><br><span class="line">      <span class="keyword">if</span> (mesh &amp;&amp; <span class="keyword">typeof</span> mesh[operation] === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> result = mesh[operation](...args)</span><br><span class="line">        results.<span class="title function_">push</span>(&#123; name, result &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¿å­˜ç½‘æ ¼è®¾ç½®</span></span><br><span class="line">  <span class="title function_">saveMeshSetup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> setup = &#123;</span><br><span class="line">      <span class="attr">meshes</span>: [],</span><br><span class="line">      <span class="attr">instances</span>: [],</span><br><span class="line">      <span class="attr">merged</span>: [],</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh, name</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">meshes</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: name,</span><br><span class="line">        ...<span class="variable language_">this</span>.<span class="title function_">getMeshInfo</span>(name),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">instancedMeshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">instances, sourceName</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">instances</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">sourceName</span>: sourceName,</span><br><span class="line">        <span class="attr">count</span>: instances.<span class="property">length</span>,</span><br><span class="line">        <span class="attr">instances</span>: instances.<span class="title function_">map</span>(<span class="function">(<span class="params">instance</span>) =&gt;</span> (&#123;</span><br><span class="line">          <span class="attr">position</span>: instance.<span class="property">position</span>,</span><br><span class="line">          <span class="attr">rotation</span>: instance.<span class="property">rotation</span>,</span><br><span class="line">          <span class="attr">scaling</span>: instance.<span class="property">scaling</span>,</span><br><span class="line">        &#125;)),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mergedMeshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh, name</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">merged</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: name,</span><br><span class="line">        <span class="attr">info</span>: <span class="variable language_">this</span>.<span class="title function_">getMeshInfo</span>(name),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> setup</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// èµ„æºæ¸…ç†</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">instancedMeshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">instances</span>) =&gt;</span> &#123;</span><br><span class="line">      instances.<span class="title function_">forEach</span>(<span class="function">(<span class="params">instance</span>) =&gt;</span> instance.<span class="title function_">dispose</span>())</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">instancedMeshes</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mergedMeshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      mesh.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mergedMeshes</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      mesh.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> meshManager = <span class="keyword">new</span> <span class="title class_">MeshManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºåŸºç¡€å‡ ä½•ä½“</span></span><br><span class="line"><span class="keyword">const</span> box = meshManager.<span class="title function_">createBox</span>(<span class="string">&#x27;myBox&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">size</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">position</span>: <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">  <span class="attr">material</span>: someMaterial,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sphere = meshManager.<span class="title function_">createSphere</span>(<span class="string">&#x27;mySphere&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">diameter</span>: <span class="number">1.5</span>,</span><br><span class="line">  <span class="attr">segments</span>: <span class="number">32</span>,</span><br><span class="line">  <span class="attr">position</span>: <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºå®ä¾‹åŒ–ç½‘æ ¼</span></span><br><span class="line"><span class="keyword">const</span> treeInstances = meshManager.<span class="title function_">createInstances</span>(<span class="string">&#x27;tree&#x27;</span>, <span class="number">100</span>, &#123;</span><br><span class="line">  <span class="attr">randomPosition</span>: &#123;</span><br><span class="line">    <span class="attr">min</span>: <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">50</span>, <span class="number">0</span>, -<span class="number">50</span>),</span><br><span class="line">    <span class="attr">max</span>: <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">50</span>, <span class="number">0</span>, <span class="number">50</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">randomRotation</span>: &#123;</span><br><span class="line">    <span class="attr">min</span>: <span class="title class_">Vector3</span>.<span class="title class_">Zero</span>(),</span><br><span class="line">    <span class="attr">max</span>: <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>, <span class="number">0</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">randomScaling</span>: &#123;</span><br><span class="line">    <span class="attr">min</span>: <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0.8</span>, <span class="number">0.8</span>, <span class="number">0.8</span>),</span><br><span class="line">    <span class="attr">max</span>: <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1.2</span>, <span class="number">1.2</span>, <span class="number">1.2</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®ç‰©ç†å±æ€§</span></span><br><span class="line">meshManager.<span class="title function_">setupPhysics</span>(<span class="string">&#x27;myBox&#x27;</span>, <span class="title class_">PhysicsImpostor</span>.<span class="property">BoxImpostor</span>, &#123;</span><br><span class="line">  <span class="attr">mass</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">restitution</span>: <span class="number">0.8</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç½‘æ ¼åŠ¨ç”»</span></span><br><span class="line">meshManager.<span class="title function_">animateMesh</span>(<span class="string">&#x27;mySphere&#x27;</span>, <span class="string">&#x27;position.y&#x27;</span>, <span class="number">5</span>, <span class="number">3000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå¹¶ç½‘æ ¼</span></span><br><span class="line"><span class="keyword">const</span> mergedMesh = meshManager.<span class="title function_">mergeMeshes</span>([<span class="string">&#x27;box1&#x27;</span>, <span class="string">&#x27;box2&#x27;</span>, <span class="string">&#x27;box3&#x27;</span>], &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;combinedBoxes&#x27;</span>,</span><br><span class="line">  <span class="attr">disposeSource</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="ğŸ¬-Animation-åŠ¨ç”»ç³»ç»Ÿè¯¦è§£"><a href="#ğŸ¬-Animation-åŠ¨ç”»ç³»ç»Ÿè¯¦è§£" class="headerlink" title="ğŸ¬ Animation åŠ¨ç”»ç³»ç»Ÿè¯¦è§£"></a>ğŸ¬ Animation åŠ¨ç”»ç³»ç»Ÿè¯¦è§£</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Animation åŠ¨ç”»ç³»ç»Ÿå®Œæ•´ç®¡ç†</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AnimationManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animations</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animationGroups</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animatables</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupDefaultAnimations</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupDefaultAnimations</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// é¢„å®šä¹‰å¸¸ç”¨åŠ¨ç”»ç±»å‹</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animationTypes</span> = &#123;</span><br><span class="line">      <span class="attr">FLOAT</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_FLOAT</span>,</span><br><span class="line">      <span class="title class_">VECTOR2</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR2</span>,</span><br><span class="line">      <span class="title class_">VECTOR3</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      <span class="title class_">COLOR3</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_COLOR3</span>,</span><br><span class="line">      <span class="title class_">COLOR4</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_COLOR4</span>,</span><br><span class="line">      <span class="attr">QUATERNION</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_QUATERNION</span>,</span><br><span class="line">      <span class="attr">MATRIX</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_MATRIX</span>,</span><br><span class="line">      <span class="attr">SIZE</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_SIZE</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é¢„å®šä¹‰å¾ªç¯æ¨¡å¼</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loopModes</span> = &#123;</span><br><span class="line">      <span class="attr">RELATIVE</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_RELATIVE</span>,</span><br><span class="line">      <span class="attr">CYCLE</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">      <span class="attr">CONSTANT</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºåŸºç¡€åŠ¨ç”»</span></span><br><span class="line">  <span class="title function_">createAnimation</span>(<span class="params">name, targetProperty, frameRate, animationType, loopMode</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="keyword">new</span> <span class="title class_">Animation</span>(</span><br><span class="line">      name,</span><br><span class="line">      targetProperty,</span><br><span class="line">      frameRate || <span class="number">30</span>,</span><br><span class="line">      animationType || <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_FLOAT</span>,</span><br><span class="line">      loopMode || <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animations</span>.<span class="title function_">set</span>(name, animation)</span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½ç½®åŠ¨ç”»</span></span><br><span class="line">  <span class="title function_">createPositionAnimation</span>(<span class="params">name, positions, frameRate = <span class="number">30</span>, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="string">&#x27;position&#x27;</span>,</span><br><span class="line">      frameRate,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * frameRate</span><br><span class="line"></span><br><span class="line">    positions.<span class="title function_">forEach</span>(<span class="function">(<span class="params">position, index</span>) =&gt;</span> &#123;</span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: (totalFrames / (positions.<span class="property">length</span> - <span class="number">1</span>)) * index,</span><br><span class="line">        <span class="attr">value</span>: position,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    animation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®ç¼“åŠ¨å‡½æ•°</span></span><br><span class="line">    animation.<span class="title function_">setEasingFunction</span>(<span class="keyword">new</span> <span class="title class_">CubicEase</span>())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ—‹è½¬åŠ¨ç”»</span></span><br><span class="line">  <span class="title function_">createRotationAnimation</span>(<span class="params">name, rotations, frameRate = <span class="number">30</span>, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="string">&#x27;rotation&#x27;</span>,</span><br><span class="line">      frameRate,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * frameRate</span><br><span class="line"></span><br><span class="line">    rotations.<span class="title function_">forEach</span>(<span class="function">(<span class="params">rotation, index</span>) =&gt;</span> &#123;</span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: (totalFrames / (rotations.<span class="property">length</span> - <span class="number">1</span>)) * index,</span><br><span class="line">        <span class="attr">value</span>: rotation,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    animation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¼©æ”¾åŠ¨ç”»</span></span><br><span class="line">  <span class="title function_">createScalingAnimation</span>(<span class="params">name, scalings, frameRate = <span class="number">30</span>, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="string">&#x27;scaling&#x27;</span>,</span><br><span class="line">      frameRate,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * frameRate</span><br><span class="line"></span><br><span class="line">    scalings.<span class="title function_">forEach</span>(<span class="function">(<span class="params">scaling, index</span>) =&gt;</span> &#123;</span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: (totalFrames / (scalings.<span class="property">length</span> - <span class="number">1</span>)) * index,</span><br><span class="line">        <span class="attr">value</span>: scaling,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    animation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é€æ˜åº¦åŠ¨ç”»</span></span><br><span class="line">  <span class="title function_">createAlphaAnimation</span>(<span class="params">name, alphaValues, frameRate = <span class="number">30</span>, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="string">&#x27;visibility&#x27;</span>,</span><br><span class="line">      frameRate,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_FLOAT</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * frameRate</span><br><span class="line"></span><br><span class="line">    alphaValues.<span class="title function_">forEach</span>(<span class="function">(<span class="params">alpha, index</span>) =&gt;</span> &#123;</span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: (totalFrames / (alphaValues.<span class="property">length</span> - <span class="number">1</span>)) * index,</span><br><span class="line">        <span class="attr">value</span>: alpha,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    animation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é¢œè‰²åŠ¨ç”»ï¼ˆæè´¨ï¼‰</span></span><br><span class="line">  <span class="title function_">createColorAnimation</span>(<span class="params">name, colors, frameRate = <span class="number">30</span>, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="string">&#x27;material.diffuseColor&#x27;</span>,</span><br><span class="line">      frameRate,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_COLOR3</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * frameRate</span><br><span class="line"></span><br><span class="line">    colors.<span class="title function_">forEach</span>(<span class="function">(<span class="params">color, index</span>) =&gt;</span> &#123;</span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: (totalFrames / (colors.<span class="property">length</span> - <span class="number">1</span>)) * index,</span><br><span class="line">        <span class="attr">value</span>: color,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    animation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// çº¹ç†åç§»åŠ¨ç”»</span></span><br><span class="line">  <span class="title function_">createTextureOffsetAnimation</span>(<span class="params">name, property = <span class="string">&#x27;uOffset&#x27;</span>, speed = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="string">`material.diffuseTexture.<span class="subst">$&#123;property&#125;</span>`</span>,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_FLOAT</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = [</span><br><span class="line">      &#123; <span class="attr">frame</span>: <span class="number">0</span>, <span class="attr">value</span>: <span class="number">0</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">frame</span>: <span class="number">30</span>, <span class="attr">value</span>: speed &#125;,</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    animation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç›¸æœºåŠ¨ç”»</span></span><br><span class="line">  <span class="title function_">createCameraAnimation</span>(<span class="params">camera, targetPosition, targetTarget, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animationGroup = <span class="keyword">new</span> <span class="title class_">AnimationGroup</span>(<span class="string">&#x27;cameraAnimation&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½ç½®åŠ¨ç”»</span></span><br><span class="line">    <span class="keyword">const</span> positionAnimation = <span class="variable language_">this</span>.<span class="title function_">createPositionAnimation</span>(</span><br><span class="line">      <span class="string">&#x27;cameraPosition&#x27;</span>,</span><br><span class="line">      [camera.<span class="property">position</span>.<span class="title function_">clone</span>(), targetPosition],</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      duration,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç›®æ ‡åŠ¨ç”»ï¼ˆå¯¹äºFreeCameraï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (camera <span class="keyword">instanceof</span> <span class="title class_">FreeCamera</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> targetAnimation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraTarget&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;target&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      targetAnimation.<span class="title function_">setKeys</span>([</span><br><span class="line">        &#123; <span class="attr">frame</span>: <span class="number">0</span>, <span class="attr">value</span>: camera.<span class="title function_">getTarget</span>().<span class="title function_">clone</span>() &#125;,</span><br><span class="line">        &#123; <span class="attr">frame</span>: (duration / <span class="number">1000</span>) * <span class="number">30</span>, <span class="attr">value</span>: targetTarget &#125;,</span><br><span class="line">      ])</span><br><span class="line"></span><br><span class="line">      animationGroup.<span class="title function_">addTargetedAnimation</span>(targetAnimation, camera)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ArcRotateCameraç‰¹æ®Šå¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> (camera <span class="keyword">instanceof</span> <span class="title class_">ArcRotateCamera</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> direction = targetPosition.<span class="title function_">subtract</span>(targetTarget)</span><br><span class="line">      <span class="keyword">const</span> radius = direction.<span class="title function_">length</span>()</span><br><span class="line">      <span class="keyword">const</span> alpha = <span class="title class_">Math</span>.<span class="title function_">atan2</span>(direction.<span class="property">x</span>, direction.<span class="property">z</span>)</span><br><span class="line">      <span class="keyword">const</span> beta = <span class="title class_">Math</span>.<span class="title function_">acos</span>(direction.<span class="property">y</span> / radius)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> alphaAnimation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraAlpha&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;alpha&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_FLOAT</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> betaAnimation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraBeta&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;beta&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_FLOAT</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> radiusAnimation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraRadius&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;radius&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_FLOAT</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> targetAnimation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraTarget&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;target&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * <span class="number">30</span></span><br><span class="line"></span><br><span class="line">      alphaAnimation.<span class="title function_">setKeys</span>([</span><br><span class="line">        &#123; <span class="attr">frame</span>: <span class="number">0</span>, <span class="attr">value</span>: camera.<span class="property">alpha</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">frame</span>: totalFrames, <span class="attr">value</span>: alpha &#125;,</span><br><span class="line">      ])</span><br><span class="line"></span><br><span class="line">      betaAnimation.<span class="title function_">setKeys</span>([</span><br><span class="line">        &#123; <span class="attr">frame</span>: <span class="number">0</span>, <span class="attr">value</span>: camera.<span class="property">beta</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">frame</span>: totalFrames, <span class="attr">value</span>: beta &#125;,</span><br><span class="line">      ])</span><br><span class="line"></span><br><span class="line">      radiusAnimation.<span class="title function_">setKeys</span>([</span><br><span class="line">        &#123; <span class="attr">frame</span>: <span class="number">0</span>, <span class="attr">value</span>: camera.<span class="property">radius</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">frame</span>: totalFrames, <span class="attr">value</span>: radius &#125;,</span><br><span class="line">      ])</span><br><span class="line"></span><br><span class="line">      targetAnimation.<span class="title function_">setKeys</span>([</span><br><span class="line">        &#123; <span class="attr">frame</span>: <span class="number">0</span>, <span class="attr">value</span>: camera.<span class="property">target</span>.<span class="title function_">clone</span>() &#125;,</span><br><span class="line">        &#123; <span class="attr">frame</span>: totalFrames, <span class="attr">value</span>: targetTarget &#125;,</span><br><span class="line">      ])</span><br><span class="line"></span><br><span class="line">      animationGroup.<span class="title function_">addTargetedAnimation</span>(alphaAnimation, camera)</span><br><span class="line">      animationGroup.<span class="title function_">addTargetedAnimation</span>(betaAnimation, camera)</span><br><span class="line">      animationGroup.<span class="title function_">addTargetedAnimation</span>(radiusAnimation, camera)</span><br><span class="line">      animationGroup.<span class="title function_">addTargetedAnimation</span>(targetAnimation, camera)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    animationGroup.<span class="title function_">addTargetedAnimation</span>(positionAnimation, camera)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">set</span>(<span class="string">&#x27;cameraAnimation&#x27;</span>, animationGroup)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> animationGroup</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// éª¨éª¼åŠ¨ç”»</span></span><br><span class="line">  <span class="title function_">createSkeletonAnimation</span>(<span class="params">skeleton, animationName</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!skeleton || !skeleton.<span class="property">animations</span>) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> skeletonAnimation = skeleton.<span class="property">animations</span>.<span class="title function_">find</span>(<span class="function">(<span class="params">anim</span>) =&gt;</span> anim.<span class="property">name</span> === animationName)</span><br><span class="line">    <span class="keyword">if</span> (!skeletonAnimation) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`éª¨éª¼åŠ¨ç”» <span class="subst">$&#123;animationName&#125;</span> æœªæ‰¾åˆ°`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> skeletonAnimation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å˜å½¢ç›®æ ‡åŠ¨ç”»</span></span><br><span class="line">  <span class="title function_">createMorphTargetAnimation</span>(<span class="params">mesh, morphTargetIndex, influences, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!mesh.<span class="property">morphTargetManager</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;ç½‘æ ¼æ²¡æœ‰å˜å½¢ç›®æ ‡ç®¡ç†å™¨&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">      <span class="string">`morphTarget_<span class="subst">$&#123;morphTargetIndex&#125;</span>`</span>,</span><br><span class="line">      <span class="string">`morphTargetManager.getTarget(<span class="subst">$&#123;morphTargetIndex&#125;</span>).influence`</span>,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_FLOAT</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * <span class="number">30</span></span><br><span class="line"></span><br><span class="line">    influences.<span class="title function_">forEach</span>(<span class="function">(<span class="params">influence, index</span>) =&gt;</span> &#123;</span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: (totalFrames / (influences.<span class="property">length</span> - <span class="number">1</span>)) * index,</span><br><span class="line">        <span class="attr">value</span>: influence,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    animation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·¯å¾„åŠ¨ç”»</span></span><br><span class="line">  <span class="title function_">createPathAnimation</span>(<span class="params">name, path, duration = <span class="number">5000</span>, loop = <span class="literal">true</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="string">&#x27;position&#x27;</span>,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      loop ? <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span> : <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * <span class="number">30</span></span><br><span class="line"></span><br><span class="line">    path.<span class="title function_">forEach</span>(<span class="function">(<span class="params">point, index</span>) =&gt;</span> &#123;</span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: (totalFrames / (path.<span class="property">length</span> - <span class="number">1</span>)) * index,</span><br><span class="line">        <span class="attr">value</span>: point,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    animation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ æ’å€¼å™¨ä»¥å¹³æ»‘è·¯å¾„</span></span><br><span class="line">    animation.<span class="title function_">setEasingFunction</span>(<span class="keyword">new</span> <span class="title class_">BezierCurveEase</span>(<span class="number">0.25</span>, <span class="number">0.1</span>, <span class="number">0.25</span>, <span class="number">1.0</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŠ¨ç”»ç»„ç®¡ç†</span></span><br><span class="line">  <span class="title function_">createAnimationGroup</span>(<span class="params">name, targetedAnimations = []</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animationGroup = <span class="keyword">new</span> <span class="title class_">AnimationGroup</span>(name, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    targetedAnimations.<span class="title function_">forEach</span>(<span class="function">(<span class="params">&#123; animation, target &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      animationGroup.<span class="title function_">addTargetedAnimation</span>(animation, target)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">set</span>(name, animationGroup)</span><br><span class="line">    <span class="keyword">return</span> animationGroup</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ’­æ”¾åŠ¨ç”»</span></span><br><span class="line">  <span class="title function_">playAnimation</span>(<span class="params">target, animationName, loop = <span class="literal">true</span>, speed = <span class="number">1.0</span>, onComplete = <span class="literal">null</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="property">animations</span>.<span class="title function_">get</span>(animationName)</span><br><span class="line">    <span class="keyword">if</span> (!animation) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`åŠ¨ç”» <span class="subst">$&#123;animationName&#125;</span> æœªæ‰¾åˆ°`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœæ­¢ç°æœ‰åŠ¨ç”»</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">stopAnimation</span>(target)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¼€å§‹æ–°åŠ¨ç”»</span></span><br><span class="line">    <span class="keyword">const</span> animatable = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">beginAnimation</span>(</span><br><span class="line">      target,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      animation.<span class="title function_">getKeys</span>()[animation.<span class="title function_">getKeys</span>().<span class="property">length</span> - <span class="number">1</span>].<span class="property">frame</span>,</span><br><span class="line">      loop,</span><br><span class="line">      speed,</span><br><span class="line">      onComplete,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animatables</span>.<span class="title function_">set</span>(<span class="string">`<span class="subst">$&#123;target.name&#125;</span>_<span class="subst">$&#123;animationName&#125;</span>`</span>, animatable)</span><br><span class="line">    <span class="keyword">return</span> animatable</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ’­æ”¾åŠ¨ç”»ç»„</span></span><br><span class="line">  <span class="title function_">playAnimationGroup</span>(<span class="params">groupName, loop = <span class="literal">true</span>, speed = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> group = <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">get</span>(groupName)</span><br><span class="line">    <span class="keyword">if</span> (!group) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`åŠ¨ç”»ç»„ <span class="subst">$&#123;groupName&#125;</span> æœªæ‰¾åˆ°`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    group.<span class="title function_">play</span>(loop)</span><br><span class="line">    group.<span class="property">speedRatio</span> = speed</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> group</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æš‚åœåŠ¨ç”»</span></span><br><span class="line">  <span class="title function_">pauseAnimation</span>(<span class="params">target, animationName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = <span class="string">`<span class="subst">$&#123;target.name&#125;</span>_<span class="subst">$&#123;animationName&#125;</span>`</span></span><br><span class="line">    <span class="keyword">const</span> animatable = <span class="variable language_">this</span>.<span class="property">animatables</span>.<span class="title function_">get</span>(key)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (animatable) &#123;</span><br><span class="line">      animatable.<span class="title function_">pause</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¢å¤åŠ¨ç”»</span></span><br><span class="line">  <span class="title function_">resumeAnimation</span>(<span class="params">target, animationName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = <span class="string">`<span class="subst">$&#123;target.name&#125;</span>_<span class="subst">$&#123;animationName&#125;</span>`</span></span><br><span class="line">    <span class="keyword">const</span> animatable = <span class="variable language_">this</span>.<span class="property">animatables</span>.<span class="title function_">get</span>(key)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (animatable) &#123;</span><br><span class="line">      animatable.<span class="title function_">restart</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœæ­¢åŠ¨ç”»</span></span><br><span class="line">  <span class="title function_">stopAnimation</span>(<span class="params">target, animationName = <span class="literal">null</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (animationName) &#123;</span><br><span class="line">      <span class="keyword">const</span> key = <span class="string">`<span class="subst">$&#123;target.name&#125;</span>_<span class="subst">$&#123;animationName&#125;</span>`</span></span><br><span class="line">      <span class="keyword">const</span> animatable = <span class="variable language_">this</span>.<span class="property">animatables</span>.<span class="title function_">get</span>(key)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (animatable) &#123;</span><br><span class="line">        animatable.<span class="title function_">stop</span>()</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">animatables</span>.<span class="title function_">delete</span>(key)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// åœæ­¢ç›®æ ‡å¯¹è±¡çš„æ‰€æœ‰åŠ¨ç”»</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">stopAnimation</span>(target)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ¸…ç†ç›¸å…³çš„animatableè®°å½•</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> [key, animatable] <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">animatables</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key.<span class="title function_">startsWith</span>(target.<span class="property">name</span> + <span class="string">&#x27;_&#x27;</span>)) &#123;</span><br><span class="line">          animatable.<span class="title function_">stop</span>()</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">animatables</span>.<span class="title function_">delete</span>(key)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¼“åŠ¨å‡½æ•°</span></span><br><span class="line">  <span class="title function_">createEasingFunction</span>(<span class="params">type, ...params</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;linear&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span> <span class="comment">// é»˜è®¤çº¿æ€§</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;cubic&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CubicEase</span>()</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;quadratic&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">QuadraticEase</span>()</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;quartic&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">QuarticEase</span>()</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;quintic&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">QuinticEase</span>()</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;sine&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SineEase</span>()</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;exponential&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ExponentialEase</span>()</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;circle&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CircleEase</span>()</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;back&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BackEase</span>(params[<span class="number">0</span>] || <span class="number">1.7</span>)</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;elastic&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ElasticEase</span>(params[<span class="number">0</span>] || <span class="number">3</span>, params[<span class="number">1</span>] || <span class="number">1</span>)</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;bounce&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BounceEase</span>(params[<span class="number">0</span>] || <span class="number">3</span>, params[<span class="number">1</span>] || <span class="number">2</span>)</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;bezier&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BezierCurveEase</span>(</span><br><span class="line">          params[<span class="number">0</span>] || <span class="number">0.25</span>,</span><br><span class="line">          params[<span class="number">1</span>] || <span class="number">0.1</span>,</span><br><span class="line">          params[<span class="number">2</span>] || <span class="number">0.25</span>,</span><br><span class="line">          params[<span class="number">3</span>] || <span class="number">1.0</span>,</span><br><span class="line">        )</span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CubicEase</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŠ¨ç”»äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">addAnimationEvent</span>(<span class="params">animation, frame, action</span>) &#123;</span><br><span class="line">    animation.<span class="title function_">addEvent</span>(</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">AnimationEvent</span>(</span><br><span class="line">        frame,</span><br><span class="line">        action,</span><br><span class="line">        <span class="literal">false</span>, <span class="comment">// åªæ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line">      ),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–åŠ¨ç”»ä¿¡æ¯</span></span><br><span class="line">  <span class="title function_">getAnimationInfo</span>(<span class="params">animationName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="property">animations</span>.<span class="title function_">get</span>(animationName)</span><br><span class="line">    <span class="keyword">if</span> (!animation) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = animation.<span class="title function_">getKeys</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">name</span>: animationName,</span><br><span class="line">      <span class="attr">targetProperty</span>: animation.<span class="property">targetProperty</span>,</span><br><span class="line">      <span class="attr">framePerSecond</span>: animation.<span class="property">framePerSecond</span>,</span><br><span class="line">      <span class="attr">dataType</span>: animation.<span class="property">dataType</span>,</span><br><span class="line">      <span class="attr">loopMode</span>: animation.<span class="property">loopBehavior</span>,</span><br><span class="line">      <span class="attr">keyFrameCount</span>: keys.<span class="property">length</span>,</span><br><span class="line">      <span class="attr">duration</span>: keys.<span class="property">length</span> &gt; <span class="number">0</span> ? keys[keys.<span class="property">length</span> - <span class="number">1</span>].<span class="property">frame</span> / animation.<span class="property">framePerSecond</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">hasEasing</span>: !!animation.<span class="title function_">getEasingFunction</span>(),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä»Babylonæ–‡ä»¶åŠ è½½åŠ¨ç”»</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadAnimationsFromFile</span>(<span class="params">url, targetMesh</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> importResult = <span class="keyword">await</span> <span class="title class_">SceneLoader</span>.<span class="title class_">ImportMeshAsync</span>(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, url, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (importResult.<span class="property">animationGroups</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        importResult.<span class="property">animationGroups</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">group</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">set</span>(group.<span class="property">name</span>, group)</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`åŠ è½½äº† <span class="subst">$&#123;importResult.animationGroups.length&#125;</span> ä¸ªåŠ¨ç”»ç»„`</span>)</span><br><span class="line">        <span class="keyword">return</span> importResult.<span class="property">animationGroups</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> []</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;åŠ è½½åŠ¨ç”»æ–‡ä»¶å¤±è´¥:&#x27;</span>, error)</span><br><span class="line">      <span class="keyword">return</span> []</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ··åˆåŠ¨ç”»</span></span><br><span class="line">  <span class="title function_">blendAnimations</span>(<span class="params">target, animation1Name, animation2Name, blendFactor</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> anim1 = <span class="variable language_">this</span>.<span class="property">animations</span>.<span class="title function_">get</span>(animation1Name)</span><br><span class="line">    <span class="keyword">const</span> anim2 = <span class="variable language_">this</span>.<span class="property">animations</span>.<span class="title function_">get</span>(animation2Name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!anim1 || !anim2) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;æ‰¾ä¸åˆ°è¦æ··åˆçš„åŠ¨ç”»&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œéœ€è¦è‡ªå®šä¹‰æ··åˆé€»è¾‘</span></span><br><span class="line">    <span class="comment">// BabylonJSçš„åŠ¨ç”»æ··åˆé€šå¸¸é€šè¿‡AnimationGroupçš„weightå±æ€§å®ç°</span></span><br><span class="line">    <span class="keyword">const</span> group1 = <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">get</span>(animation1Name + <span class="string">&#x27;_group&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> group2 = <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">get</span>(animation2Name + <span class="string">&#x27;_group&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (group1 &amp;&amp; group2) &#123;</span><br><span class="line">      group1.<span class="property">weight</span> = <span class="number">1</span> - blendFactor</span><br><span class="line">      group2.<span class="property">weight</span> = blendFactor</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¿å­˜åŠ¨ç”»è®¾ç½®</span></span><br><span class="line">  <span class="title function_">saveAnimationSetup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> setup = &#123;</span><br><span class="line">      <span class="attr">animations</span>: [],</span><br><span class="line">      <span class="attr">animationGroups</span>: [],</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animations</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">animation, name</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">animations</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: name,</span><br><span class="line">        ...<span class="variable language_">this</span>.<span class="title function_">getAnimationInfo</span>(name),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">group, name</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">animationGroups</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: name,</span><br><span class="line">        <span class="attr">isPlaying</span>: group.<span class="property">isPlaying</span>,</span><br><span class="line">        <span class="attr">speedRatio</span>: group.<span class="property">speedRatio</span>,</span><br><span class="line">        <span class="attr">weight</span>: group.<span class="property">weight</span>,</span><br><span class="line">        <span class="attr">targetedAnimations</span>: group.<span class="property">targetedAnimations</span>.<span class="property">length</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> setup</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// èµ„æºæ¸…ç†</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// åœæ­¢æ‰€æœ‰åŠ¨ç”»</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animatables</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">animatable</span>) =&gt;</span> &#123;</span><br><span class="line">      animatable.<span class="title function_">stop</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animatables</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç†åŠ¨ç”»ç»„</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">group</span>) =&gt;</span> &#123;</span><br><span class="line">      group.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç†åŠ¨ç”»</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animations</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">animation</span>) =&gt;</span> &#123;</span><br><span class="line">      animation.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animations</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> animationManager = <span class="keyword">new</span> <span class="title class_">AnimationManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºä½ç½®åŠ¨ç”»</span></span><br><span class="line"><span class="keyword">const</span> positionAnim = animationManager.<span class="title function_">createPositionAnimation</span>(</span><br><span class="line">  <span class="string">&#x27;boxMove&#x27;</span>,</span><br><span class="line">  [<span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">5</span>, <span class="number">2</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">10</span>, <span class="number">0</span>, <span class="number">5</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)],</span><br><span class="line">  <span class="number">30</span>,</span><br><span class="line">  <span class="number">4000</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ ç¼“åŠ¨å‡½æ•°</span></span><br><span class="line">positionAnim.<span class="title function_">setEasingFunction</span>(animationManager.<span class="title function_">createEasingFunction</span>(<span class="string">&#x27;bounce&#x27;</span>, <span class="number">3</span>, <span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºæ—‹è½¬åŠ¨ç”»</span></span><br><span class="line"><span class="keyword">const</span> rotationAnim = animationManager.<span class="title function_">createRotationAnimation</span>(</span><br><span class="line">  <span class="string">&#x27;boxRotate&#x27;</span>,</span><br><span class="line">  [<span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>, <span class="number">0</span>)],</span><br><span class="line">  <span class="number">30</span>,</span><br><span class="line">  <span class="number">3000</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºåŠ¨ç”»ç»„</span></span><br><span class="line"><span class="keyword">const</span> boxAnimGroup = animationManager.<span class="title function_">createAnimationGroup</span>(<span class="string">&#x27;boxAnimations&#x27;</span>, [</span><br><span class="line">  &#123; <span class="attr">animation</span>: positionAnim, <span class="attr">target</span>: myBox &#125;,</span><br><span class="line">  &#123; <span class="attr">animation</span>: rotationAnim, <span class="attr">target</span>: myBox &#125;,</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ’­æ”¾åŠ¨ç”»ç»„</span></span><br><span class="line">animationManager.<span class="title function_">playAnimationGroup</span>(<span class="string">&#x27;boxAnimations&#x27;</span>, <span class="literal">true</span>, <span class="number">1.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›¸æœºåŠ¨ç”»</span></span><br><span class="line"><span class="keyword">const</span> cameraAnim = animationManager.<span class="title function_">createCameraAnimation</span>(</span><br><span class="line">  scene.<span class="property">activeCamera</span>,</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>),</span><br><span class="line">  <span class="title class_">Vector3</span>.<span class="title class_">Zero</span>(),</span><br><span class="line">  <span class="number">2000</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ’­æ”¾ç›¸æœºåŠ¨ç”»</span></span><br><span class="line">animationManager.<span class="title function_">playAnimationGroup</span>(<span class="string">&#x27;cameraAnimation&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="ğŸ†-ParticleSystem-ç²’å­ç³»ç»Ÿè¯¦è§£"><a href="#ğŸ†-ParticleSystem-ç²’å­ç³»ç»Ÿè¯¦è§£" class="headerlink" title="ğŸ† ParticleSystem ç²’å­ç³»ç»Ÿè¯¦è§£"></a>ğŸ† ParticleSystem ç²’å­ç³»ç»Ÿè¯¦è§£</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ParticleSystem ç²’å­ç³»ç»Ÿå®Œæ•´ç®¡ç†</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ParticleSystemManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">particleSystems</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gpuParticleSystems</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupDefaultParticleSystems</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupDefaultParticleSystems</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥GPUç²’å­ç³»ç»Ÿæ”¯æŒ</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">supportsGPUParticles</span> = <span class="title class_">GPUParticleSystem</span>.<span class="property">IsSupported</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;GPUç²’å­ç³»ç»Ÿæ”¯æŒ:&#x27;</span>, <span class="variable language_">this</span>.<span class="property">supportsGPUParticles</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºåŸºç¡€CPUç²’å­ç³»ç»Ÿ</span></span><br><span class="line">  <span class="title function_">createParticleSystem</span>(<span class="params">name, capacity = <span class="number">2000</span>, emitter = <span class="literal">null</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> particleSystem = <span class="keyword">new</span> <span class="title class_">ParticleSystem</span>(name, capacity, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŸºç¡€å‘å°„å™¨è®¾ç½®</span></span><br><span class="line">    <span class="keyword">if</span> (emitter) &#123;</span><br><span class="line">      particleSystem.<span class="property">emitter</span> = emitter</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      particleSystem.<span class="property">emitter</span> = <span class="title class_">Vector3</span>.<span class="title class_">Zero</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç²’å­çº¹ç†</span></span><br><span class="line">    particleSystem.<span class="property">particleTexture</span> = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;/textures/flare.png&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘å°„å±æ€§</span></span><br><span class="line">    particleSystem.<span class="property">emitRate</span> = <span class="number">300</span> <span class="comment">// æ¯ç§’å‘å°„ç²’å­æ•°</span></span><br><span class="line">    particleSystem.<span class="property">maxEmitPower</span> = <span class="number">1.5</span> <span class="comment">// æœ€å¤§å‘å°„åŠ›åº¦</span></span><br><span class="line">    particleSystem.<span class="property">minEmitPower</span> = <span class="number">1.0</span> <span class="comment">// æœ€å°å‘å°„åŠ›åº¦</span></span><br><span class="line">    particleSystem.<span class="property">updateSpeed</span> = <span class="number">0.005</span> <span class="comment">// æ›´æ–°é€Ÿåº¦</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”Ÿå‘½å‘¨æœŸ</span></span><br><span class="line">    particleSystem.<span class="property">minLifeTime</span> = <span class="number">0.3</span> <span class="comment">// æœ€å°ç”Ÿå‘½æ—¶é—´</span></span><br><span class="line">    particleSystem.<span class="property">maxLifeTime</span> = <span class="number">1.5</span> <span class="comment">// æœ€å¤§ç”Ÿå‘½æ—¶é—´</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°ºå¯¸</span></span><br><span class="line">    particleSystem.<span class="property">minSize</span> = <span class="number">0.1</span> <span class="comment">// æœ€å°å°ºå¯¸</span></span><br><span class="line">    particleSystem.<span class="property">maxSize</span> = <span class="number">0.5</span> <span class="comment">// æœ€å¤§å°ºå¯¸</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§’åº¦èŒƒå›´</span></span><br><span class="line">    particleSystem.<span class="property">minAngularSpeed</span> = <span class="number">0</span> <span class="comment">// æœ€å°è§’é€Ÿåº¦</span></span><br><span class="line">    particleSystem.<span class="property">maxAngularSpeed</span> = <span class="title class_">Math</span>.<span class="property">PI</span> <span class="comment">// æœ€å¤§è§’é€Ÿåº¦</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–¹å‘</span></span><br><span class="line">    particleSystem.<span class="property">direction1</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">7</span>, <span class="number">8</span>, <span class="number">3</span>) <span class="comment">// æ–¹å‘1</span></span><br><span class="line">    particleSystem.<span class="property">direction2</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">7</span>, <span class="number">8</span>, -<span class="number">3</span>) <span class="comment">// æ–¹å‘2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡åŠ›</span></span><br><span class="line">    particleSystem.<span class="property">gravity</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, -<span class="number">9.81</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é¢œè‰²å˜åŒ–</span></span><br><span class="line">    particleSystem.<span class="property">color1</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.7</span>, <span class="number">0.8</span>, <span class="number">1.0</span>, <span class="number">1.0</span>) <span class="comment">// èµ·å§‹é¢œè‰²</span></span><br><span class="line">    particleSystem.<span class="property">color2</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.2</span>, <span class="number">0.5</span>, <span class="number">1.0</span>, <span class="number">1.0</span>) <span class="comment">// ä¸­é—´é¢œè‰²</span></span><br><span class="line">    particleSystem.<span class="property">colorDead</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.2</span>, <span class="number">0.0</span>) <span class="comment">// æ¶ˆå¤±é¢œè‰²</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘å°„å½¢çŠ¶</span></span><br><span class="line">    particleSystem.<span class="property">minEmitBox</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>) <span class="comment">// å‘å°„ç›’æœ€å°å€¼</span></span><br><span class="line">    particleSystem.<span class="property">maxEmitBox</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>) <span class="comment">// å‘å°„ç›’æœ€å¤§å€¼</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ··åˆæ¨¡å¼</span></span><br><span class="line">    particleSystem.<span class="property">blendMode</span> = <span class="title class_">ParticleSystem</span>.<span class="property">BLENDMODE_ONEONE</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">particleSystems</span>.<span class="title function_">set</span>(name, particleSystem)</span><br><span class="line">    <span class="keyword">return</span> particleSystem</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºGPUç²’å­ç³»ç»Ÿ</span></span><br><span class="line">  <span class="title function_">createGPUParticleSystem</span>(<span class="params">name, capacity = <span class="number">50000</span>, emitter = <span class="literal">null</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">supportsGPUParticles</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;å½“å‰è®¾å¤‡ä¸æ”¯æŒGPUç²’å­ç³»ç»Ÿï¼Œä½¿ç”¨CPUç²’å­ç³»ç»Ÿä»£æ›¿&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">createParticleSystem</span>(name, <span class="title class_">Math</span>.<span class="title function_">min</span>(capacity, <span class="number">5000</span>), emitter)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> particleSystem = <span class="keyword">new</span> <span class="title class_">GPUParticleSystem</span>(name, &#123; <span class="attr">capacity</span>: capacity &#125;, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŸºç¡€å‘å°„å™¨è®¾ç½®</span></span><br><span class="line">    <span class="keyword">if</span> (emitter) &#123;</span><br><span class="line">      particleSystem.<span class="property">emitter</span> = emitter</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      particleSystem.<span class="property">emitter</span> = <span class="title class_">Vector3</span>.<span class="title class_">Zero</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç²’å­çº¹ç†</span></span><br><span class="line">    particleSystem.<span class="property">particleTexture</span> = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;/textures/flare.png&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// GPUç‰¹æœ‰çš„å‘å°„å±æ€§</span></span><br><span class="line">    particleSystem.<span class="property">emitRate</span> = <span class="number">5000</span> <span class="comment">// GPUå¯ä»¥å¤„ç†æ›´å¤šç²’å­</span></span><br><span class="line">    particleSystem.<span class="property">maxEmitPower</span> = <span class="number">1.5</span></span><br><span class="line">    particleSystem.<span class="property">minEmitPower</span> = <span class="number">1.0</span></span><br><span class="line">    particleSystem.<span class="property">updateSpeed</span> = <span class="number">0.005</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”Ÿå‘½å‘¨æœŸ</span></span><br><span class="line">    particleSystem.<span class="property">minLifeTime</span> = <span class="number">0.3</span></span><br><span class="line">    particleSystem.<span class="property">maxLifeTime</span> = <span class="number">1.5</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°ºå¯¸</span></span><br><span class="line">    particleSystem.<span class="property">minSize</span> = <span class="number">0.1</span></span><br><span class="line">    particleSystem.<span class="property">maxSize</span> = <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§’åº¦èŒƒå›´</span></span><br><span class="line">    particleSystem.<span class="property">minAngularSpeed</span> = <span class="number">0</span></span><br><span class="line">    particleSystem.<span class="property">maxAngularSpeed</span> = <span class="title class_">Math</span>.<span class="property">PI</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–¹å‘</span></span><br><span class="line">    particleSystem.<span class="property">direction1</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">7</span>, <span class="number">8</span>, <span class="number">3</span>)</span><br><span class="line">    particleSystem.<span class="property">direction2</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">7</span>, <span class="number">8</span>, -<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡åŠ›</span></span><br><span class="line">    particleSystem.<span class="property">gravity</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, -<span class="number">9.81</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é¢œè‰²å˜åŒ–</span></span><br><span class="line">    particleSystem.<span class="property">color1</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.7</span>, <span class="number">0.8</span>, <span class="number">1.0</span>, <span class="number">1.0</span>)</span><br><span class="line">    particleSystem.<span class="property">color2</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.2</span>, <span class="number">0.5</span>, <span class="number">1.0</span>, <span class="number">1.0</span>)</span><br><span class="line">    particleSystem.<span class="property">colorDead</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.2</span>, <span class="number">0.0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘å°„å½¢çŠ¶</span></span><br><span class="line">    particleSystem.<span class="property">minEmitBox</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    particleSystem.<span class="property">maxEmitBox</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ··åˆæ¨¡å¼</span></span><br><span class="line">    particleSystem.<span class="property">blendMode</span> = <span class="title class_">ParticleSystem</span>.<span class="property">BLENDMODE_ONEONE</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gpuParticleSystems</span>.<span class="title function_">set</span>(name, particleSystem)</span><br><span class="line">    <span class="keyword">return</span> particleSystem</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºç«ç„°æ•ˆæœ</span></span><br><span class="line">  <span class="title function_">createFireEffect</span>(<span class="params">name, emitter, intensity = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fireSystem = <span class="variable language_">this</span>.<span class="title function_">createParticleSystem</span>(name + <span class="string">&#x27;_fire&#x27;</span>, <span class="number">2000</span>, emitter)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç«ç„°ç‰¹æ•ˆå‚æ•°</span></span><br><span class="line">    fireSystem.<span class="property">particleTexture</span> = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;/textures/fire.jpg&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    fireSystem.<span class="property">emitRate</span> = <span class="number">300</span> * intensity</span><br><span class="line">    fireSystem.<span class="property">maxEmitPower</span> = <span class="number">1.0</span></span><br><span class="line">    fireSystem.<span class="property">minEmitPower</span> = <span class="number">0.8</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç«ç„°ç”Ÿå‘½å‘¨æœŸ</span></span><br><span class="line">    fireSystem.<span class="property">minLifeTime</span> = <span class="number">0.5</span></span><br><span class="line">    fireSystem.<span class="property">maxLifeTime</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç«ç„°å°ºå¯¸</span></span><br><span class="line">    fireSystem.<span class="property">minSize</span> = <span class="number">0.5</span> * intensity</span><br><span class="line">    fireSystem.<span class="property">maxSize</span> = <span class="number">1.0</span> * intensity</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç«ç„°æ–¹å‘ï¼ˆå‘ä¸Šï¼‰</span></span><br><span class="line">    fireSystem.<span class="property">direction1</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">0.5</span>, <span class="number">1</span>, -<span class="number">0.5</span>)</span><br><span class="line">    fireSystem.<span class="property">direction2</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0.5</span>, <span class="number">1</span>, <span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ— é‡åŠ›ï¼ˆç«ç„°å‘ä¸Šé£˜ï¼‰</span></span><br><span class="line">    fireSystem.<span class="property">gravity</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç«ç„°é¢œè‰²æ¸å˜</span></span><br><span class="line">    fireSystem.<span class="property">color1</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1.0</span>) <span class="comment">// é»„è‰²</span></span><br><span class="line">    fireSystem.<span class="property">color2</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">1</span>, <span class="number">0.5</span>, <span class="number">0</span>, <span class="number">1.0</span>) <span class="comment">// æ©™è‰²</span></span><br><span class="line">    fireSystem.<span class="property">colorDead</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.5</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.0</span>) <span class="comment">// çº¢è‰²æ¸éš</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç«ç„°å‘å°„å½¢çŠ¶</span></span><br><span class="line">    fireSystem.<span class="property">minEmitBox</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">0.3</span>, <span class="number">0</span>, -<span class="number">0.3</span>)</span><br><span class="line">    fireSystem.<span class="property">maxEmitBox</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0.3</span>, <span class="number">0</span>, <span class="number">0.3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ··åˆæ¨¡å¼ï¼ˆå åŠ å‘å…‰ï¼‰</span></span><br><span class="line">    fireSystem.<span class="property">blendMode</span> = <span class="title class_">ParticleSystem</span>.<span class="property">BLENDMODE_ADD</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fireSystem</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºçƒŸé›¾æ•ˆæœ</span></span><br><span class="line">  <span class="title function_">createSmokeEffect</span>(<span class="params">name, emitter, intensity = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> smokeSystem = <span class="variable language_">this</span>.<span class="title function_">createParticleSystem</span>(name + <span class="string">&#x27;_smoke&#x27;</span>, <span class="number">1000</span>, emitter)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çƒŸé›¾ç‰¹æ•ˆå‚æ•°</span></span><br><span class="line">    smokeSystem.<span class="property">particleTexture</span> = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;/textures/smoke.png&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    smokeSystem.<span class="property">emitRate</span> = <span class="number">50</span> * intensity</span><br><span class="line">    smokeSystem.<span class="property">maxEmitPower</span> = <span class="number">0.5</span></span><br><span class="line">    smokeSystem.<span class="property">minEmitPower</span> = <span class="number">0.2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// çƒŸé›¾ç”Ÿå‘½å‘¨æœŸï¼ˆè¾ƒé•¿ï¼‰</span></span><br><span class="line">    smokeSystem.<span class="property">minLifeTime</span> = <span class="number">2.0</span></span><br><span class="line">    smokeSystem.<span class="property">maxLifeTime</span> = <span class="number">4.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// çƒŸé›¾å°ºå¯¸ï¼ˆé€æ¸å¢å¤§ï¼‰</span></span><br><span class="line">    smokeSystem.<span class="property">minSize</span> = <span class="number">1.0</span> * intensity</span><br><span class="line">    smokeSystem.<span class="property">maxSize</span> = <span class="number">3.0</span> * intensity</span><br><span class="line">    smokeSystem.<span class="property">minScaleX</span> = <span class="number">1.0</span></span><br><span class="line">    smokeSystem.<span class="property">maxScaleX</span> = <span class="number">3.0</span></span><br><span class="line">    smokeSystem.<span class="property">minScaleY</span> = <span class="number">1.0</span></span><br><span class="line">    smokeSystem.<span class="property">maxScaleY</span> = <span class="number">3.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// çƒŸé›¾æ–¹å‘ï¼ˆå‘ä¸Šæ‰©æ•£ï¼‰</span></span><br><span class="line">    smokeSystem.<span class="property">direction1</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">1</span>, -<span class="number">1</span>)</span><br><span class="line">    smokeSystem.<span class="property">direction2</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è½»å¾®é‡åŠ›</span></span><br><span class="line">    smokeSystem.<span class="property">gravity</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, -<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çƒŸé›¾é¢œè‰²ï¼ˆç°è‰²æ¸éšï¼‰</span></span><br><span class="line">    smokeSystem.<span class="property">color1</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.8</span>, <span class="number">0.8</span>, <span class="number">0.8</span>, <span class="number">0.8</span>)</span><br><span class="line">    smokeSystem.<span class="property">color2</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>)</span><br><span class="line">    smokeSystem.<span class="property">colorDead</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.3</span>, <span class="number">0.3</span>, <span class="number">0.3</span>, <span class="number">0.0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çƒŸé›¾å‘å°„å½¢çŠ¶</span></span><br><span class="line">    smokeSystem.<span class="property">minEmitBox</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">0.5</span>, <span class="number">0</span>, -<span class="number">0.5</span>)</span><br><span class="line">    smokeSystem.<span class="property">maxEmitBox</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0.5</span>, <span class="number">0.2</span>, <span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ··åˆæ¨¡å¼ï¼ˆé€æ˜ï¼‰</span></span><br><span class="line">    smokeSystem.<span class="property">blendMode</span> = <span class="title class_">ParticleSystem</span>.<span class="property">BLENDMODE_STANDARD</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> smokeSystem</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºçˆ†ç‚¸æ•ˆæœ</span></span><br><span class="line">  <span class="title function_">createExplosionEffect</span>(<span class="params">name, position, size = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> explosionSystem = <span class="variable language_">this</span>.<span class="title function_">createParticleSystem</span>(name + <span class="string">&#x27;_explosion&#x27;</span>, <span class="number">5000</span>, position)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çˆ†ç‚¸ç‰¹æ•ˆå‚æ•°</span></span><br><span class="line">    explosionSystem.<span class="property">particleTexture</span> = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;/textures/explosion.png&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    explosionSystem.<span class="property">emitRate</span> = <span class="number">10000</span> <span class="comment">// ç¬é—´å¤§é‡å‘å°„</span></span><br><span class="line">    explosionSystem.<span class="property">maxEmitPower</span> = <span class="number">10.0</span> * size</span><br><span class="line">    explosionSystem.<span class="property">minEmitPower</span> = <span class="number">5.0</span> * size</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çˆ†ç‚¸ç”Ÿå‘½å‘¨æœŸï¼ˆçŸ­æš‚ï¼‰</span></span><br><span class="line">    explosionSystem.<span class="property">minLifeTime</span> = <span class="number">0.1</span></span><br><span class="line">    explosionSystem.<span class="property">maxLifeTime</span> = <span class="number">0.8</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// çˆ†ç‚¸å°ºå¯¸</span></span><br><span class="line">    explosionSystem.<span class="property">minSize</span> = <span class="number">0.5</span> * size</span><br><span class="line">    explosionSystem.<span class="property">maxSize</span> = <span class="number">2.0</span> * size</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…¨æ–¹å‘çˆ†ç‚¸</span></span><br><span class="line">    explosionSystem.<span class="title function_">createSphereEmitter</span>(<span class="number">0.1</span>, <span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡åŠ›å½±å“</span></span><br><span class="line">    explosionSystem.<span class="property">gravity</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, -<span class="number">5</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çˆ†ç‚¸é¢œè‰²</span></span><br><span class="line">    explosionSystem.<span class="property">color1</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1.0</span>) <span class="comment">// ç™½è‰²é—ªå…‰</span></span><br><span class="line">    explosionSystem.<span class="property">color2</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">1</span>, <span class="number">0.8</span>, <span class="number">0.2</span>, <span class="number">1.0</span>) <span class="comment">// æ©™é»„è‰²</span></span><br><span class="line">    explosionSystem.<span class="property">colorDead</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.3</span>, <span class="number">0.1</span>, <span class="number">0</span>, <span class="number">0.0</span>) <span class="comment">// æš—çº¢è‰²æ¶ˆæ•£</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ··åˆæ¨¡å¼ï¼ˆå åŠ ï¼‰</span></span><br><span class="line">    explosionSystem.<span class="property">blendMode</span> = <span class="title class_">ParticleSystem</span>.<span class="property">BLENDMODE_ADD</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é™åˆ¶å‘å°„æ—¶é—´ï¼ˆçˆ†ç‚¸æ˜¯ç¬é—´çš„ï¼‰</span></span><br><span class="line">    explosionSystem.<span class="property">targetStopDuration</span> = <span class="number">0.1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> explosionSystem</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºé›¨é›ªæ•ˆæœ</span></span><br><span class="line">  <span class="title function_">createWeatherEffect</span>(<span class="params"></span></span><br><span class="line"><span class="params">    name,</span></span><br><span class="line"><span class="params">    type = <span class="string">&#x27;rain&#x27;</span>,</span></span><br><span class="line"><span class="params">    intensity = <span class="number">1.0</span>,</span></span><br><span class="line"><span class="params">    area = &#123; width: <span class="number">50</span>, height: <span class="number">20</span>, depth: <span class="number">50</span> &#125;,</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> weatherSystem = <span class="variable language_">this</span>.<span class="title function_">createParticleSystem</span>(name + <span class="string">&#x27;_weather&#x27;</span>, <span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (type === <span class="string">&#x27;rain&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// é›¨æ•ˆæœ</span></span><br><span class="line">      weatherSystem.<span class="property">particleTexture</span> = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;/textures/raindrop.png&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">      weatherSystem.<span class="property">emitRate</span> = <span class="number">1000</span> * intensity</span><br><span class="line">      weatherSystem.<span class="property">minLifeTime</span> = <span class="number">1.0</span></span><br><span class="line">      weatherSystem.<span class="property">maxLifeTime</span> = <span class="number">3.0</span></span><br><span class="line">      weatherSystem.<span class="property">minSize</span> = <span class="number">0.1</span></span><br><span class="line">      weatherSystem.<span class="property">maxSize</span> = <span class="number">0.3</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// é›¨æ»´æ–¹å‘ï¼ˆå‘ä¸‹ï¼‰</span></span><br><span class="line">      weatherSystem.<span class="property">direction1</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">0.2</span>, -<span class="number">1</span>, -<span class="number">0.1</span>)</span><br><span class="line">      weatherSystem.<span class="property">direction2</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0.2</span>, -<span class="number">1</span>, <span class="number">0.1</span>)</span><br><span class="line">      weatherSystem.<span class="property">gravity</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, -<span class="number">15</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// é›¨æ»´é¢œè‰²</span></span><br><span class="line">      weatherSystem.<span class="property">color1</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.7</span>, <span class="number">0.8</span>, <span class="number">1.0</span>, <span class="number">0.8</span>)</span><br><span class="line">      weatherSystem.<span class="property">color2</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.5</span>, <span class="number">0.6</span>, <span class="number">0.8</span>, <span class="number">0.6</span>)</span><br><span class="line">      weatherSystem.<span class="property">colorDead</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.3</span>, <span class="number">0.4</span>, <span class="number">0.6</span>, <span class="number">0.0</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">&#x27;snow&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// é›ªæ•ˆæœ</span></span><br><span class="line">      weatherSystem.<span class="property">particleTexture</span> = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;/textures/snowflake.png&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">      weatherSystem.<span class="property">emitRate</span> = <span class="number">500</span> * intensity</span><br><span class="line">      weatherSystem.<span class="property">minLifeTime</span> = <span class="number">3.0</span></span><br><span class="line">      weatherSystem.<span class="property">maxLifeTime</span> = <span class="number">8.0</span></span><br><span class="line">      weatherSystem.<span class="property">minSize</span> = <span class="number">0.3</span></span><br><span class="line">      weatherSystem.<span class="property">maxSize</span> = <span class="number">0.8</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// é›ªèŠ±é£˜è½</span></span><br><span class="line">      weatherSystem.<span class="property">direction1</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, -<span class="number">0.5</span>, -<span class="number">1</span>)</span><br><span class="line">      weatherSystem.<span class="property">direction2</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, -<span class="number">0.5</span>, <span class="number">1</span>)</span><br><span class="line">      weatherSystem.<span class="property">gravity</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, -<span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// é›ªèŠ±é¢œè‰²</span></span><br><span class="line">      weatherSystem.<span class="property">color1</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0.9</span>)</span><br><span class="line">      weatherSystem.<span class="property">color2</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.9</span>, <span class="number">0.9</span>, <span class="number">1</span>, <span class="number">0.8</span>)</span><br><span class="line">      weatherSystem.<span class="property">colorDead</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.8</span>, <span class="number">0.8</span>, <span class="number">0.9</span>, <span class="number">0.0</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®å‘å°„åŒºåŸŸ</span></span><br><span class="line">    weatherSystem.<span class="title function_">createBoxEmitter</span>(</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Vector3</span>(-area.<span class="property">width</span> / <span class="number">2</span>, area.<span class="property">height</span>, -area.<span class="property">depth</span> / <span class="number">2</span>),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Vector3</span>(area.<span class="property">width</span> / <span class="number">2</span>, area.<span class="property">height</span>, area.<span class="property">depth</span> / <span class="number">2</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> weatherSystem</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®å‘å°„å™¨å½¢çŠ¶</span></span><br><span class="line">  <span class="title function_">setupEmitterShape</span>(<span class="params">particleSystem, shapeType, ...params</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (shapeType) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;box&#x27;</span>:</span><br><span class="line">        <span class="keyword">const</span> [minEmitBox, maxEmitBox] = params</span><br><span class="line">        particleSystem.<span class="property">minEmitBox</span> = minEmitBox || <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>)</span><br><span class="line">        particleSystem.<span class="property">maxEmitBox</span> = maxEmitBox || <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;sphere&#x27;</span>:</span><br><span class="line">        <span class="keyword">const</span> [radius, radiusRange] = params</span><br><span class="line">        particleSystem.<span class="title function_">createSphereEmitter</span>(radius || <span class="number">1.0</span>, radiusRange || <span class="number">1.0</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;cone&#x27;</span>:</span><br><span class="line">        <span class="keyword">const</span> [coneRadius, coneAngle, coneHeight] = params</span><br><span class="line">        particleSystem.<span class="title function_">createConeEmitter</span>(</span><br><span class="line">          coneRadius || <span class="number">1.0</span>,</span><br><span class="line">          coneAngle || <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>,</span><br><span class="line">          coneHeight || <span class="number">1.0</span>,</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;cylinder&#x27;</span>:</span><br><span class="line">        <span class="keyword">const</span> [cylRadius, cylHeight, cylRadiusRange] = params</span><br><span class="line">        particleSystem.<span class="title function_">createCylinderEmitter</span>(</span><br><span class="line">          cylRadius || <span class="number">1.0</span>,</span><br><span class="line">          cylHeight || <span class="number">1.0</span>,</span><br><span class="line">          cylRadiusRange || <span class="number">1.0</span>,</span><br><span class="line">          <span class="number">0</span>, <span class="comment">// directionRandomizer</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;hemisphere&#x27;</span>:</span><br><span class="line">        <span class="keyword">const</span> [hemiRadius, hemiRadiusRange] = params</span><br><span class="line">        particleSystem.<span class="title function_">createHemisphericEmitter</span>(hemiRadius || <span class="number">1.0</span>, hemiRadiusRange || <span class="number">1.0</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;æœªçŸ¥çš„å‘å°„å™¨å½¢çŠ¶:&#x27;</span>, shapeType)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯åŠ¨ç²’å­ç³»ç»Ÿ</span></span><br><span class="line">  <span class="title function_">startParticleSystem</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> cpuSystem = <span class="variable language_">this</span>.<span class="property">particleSystems</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">const</span> gpuSystem = <span class="variable language_">this</span>.<span class="property">gpuParticleSystems</span>.<span class="title function_">get</span>(name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cpuSystem) &#123;</span><br><span class="line">      cpuSystem.<span class="title function_">start</span>()</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`CPUç²’å­ç³»ç»Ÿ <span class="subst">$&#123;name&#125;</span> å·²å¯åŠ¨`</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (gpuSystem) &#123;</span><br><span class="line">      gpuSystem.<span class="title function_">start</span>()</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`GPUç²’å­ç³»ç»Ÿ <span class="subst">$&#123;name&#125;</span> å·²å¯åŠ¨`</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`ç²’å­ç³»ç»Ÿ <span class="subst">$&#123;name&#125;</span> æœªæ‰¾åˆ°`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœæ­¢ç²’å­ç³»ç»Ÿ</span></span><br><span class="line">  <span class="title function_">stopParticleSystem</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> cpuSystem = <span class="variable language_">this</span>.<span class="property">particleSystems</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">const</span> gpuSystem = <span class="variable language_">this</span>.<span class="property">gpuParticleSystems</span>.<span class="title function_">get</span>(name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cpuSystem) &#123;</span><br><span class="line">      cpuSystem.<span class="title function_">stop</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (gpuSystem) &#123;</span><br><span class="line">      gpuSystem.<span class="title function_">stop</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é‡ç½®ç²’å­ç³»ç»Ÿ</span></span><br><span class="line">  <span class="title function_">resetParticleSystem</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> cpuSystem = <span class="variable language_">this</span>.<span class="property">particleSystems</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">const</span> gpuSystem = <span class="variable language_">this</span>.<span class="property">gpuParticleSystems</span>.<span class="title function_">get</span>(name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cpuSystem) &#123;</span><br><span class="line">      cpuSystem.<span class="title function_">reset</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (gpuSystem) &#123;</span><br><span class="line">      gpuSystem.<span class="title function_">reset</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–ç²’å­ç³»ç»Ÿä¿¡æ¯</span></span><br><span class="line">  <span class="title function_">getParticleSystemInfo</span>(<span class="params">particleSystemName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> particleSystem = <span class="variable language_">this</span>.<span class="property">particleSystems</span>.<span class="title function_">get</span>(particleSystemName)</span><br><span class="line">    <span class="keyword">if</span> (!particleSystem) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> info = &#123;</span><br><span class="line">      <span class="attr">name</span>: particleSystemName,</span><br><span class="line">      <span class="attr">type</span>: particleSystem.<span class="title function_">getClassName</span>(),</span><br><span class="line">      <span class="attr">emitRate</span>: particleSystem.<span class="property">emitRate</span>,</span><br><span class="line">      <span class="attr">lifeTime</span>: particleSystem.<span class="property">lifeTime</span>,</span><br><span class="line">      <span class="attr">size</span>: particleSystem.<span class="property">size</span>,</span><br><span class="line">      <span class="attr">color</span>: particleSystem.<span class="property">color</span>,</span><br><span class="line">      <span class="attr">color2</span>: particleSystem.<span class="property">color2</span>,</span><br><span class="line">      <span class="attr">colorDead</span>: particleSystem.<span class="property">colorDead</span>,</span><br><span class="line">      <span class="attr">gravity</span>: particleSystem.<span class="property">gravity</span>,</span><br><span class="line">      <span class="attr">direction</span>: particleSystem.<span class="property">direction</span>,</span><br><span class="line">      <span class="attr">direction2</span>: particleSystem.<span class="property">direction2</span>,</span><br><span class="line">      <span class="attr">minEmitPower</span>: particleSystem.<span class="property">minEmitPower</span>,</span><br><span class="line">      <span class="attr">maxEmitPower</span>: particleSystem.<span class="property">maxEmitPower</span>,</span><br><span class="line">      <span class="attr">minLifeTime</span>: particleSystem.<span class="property">minLifeTime</span>,</span><br><span class="line">      <span class="attr">maxLifeTime</span>: particleSystem.<span class="property">maxLifeTime</span>,</span><br><span class="line">      <span class="attr">minSize</span>: particleSystem.<span class="property">minSize</span>,</span><br><span class="line">      <span class="attr">maxSize</span>: particleSystem.<span class="property">maxSize</span>,</span><br><span class="line">      <span class="attr">minEmitBox</span>: particleSystem.<span class="property">minEmitBox</span>,</span><br><span class="line">      <span class="attr">maxEmitBox</span>: particleSystem.<span class="property">maxEmitBox</span>,</span><br><span class="line">      <span class="attr">emitBox</span>: particleSystem.<span class="property">emitBox</span>,</span><br><span class="line">      <span class="attr">particles</span>: particleSystem.<span class="property">particles</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">particle</span>) =&gt;</span> (&#123;</span><br><span class="line">        <span class="attr">position</span>: particle.<span class="property">position</span>.<span class="title function_">clone</span>(),</span><br><span class="line">        <span class="attr">velocity</span>: particle.<span class="property">velocity</span>.<span class="title function_">clone</span>(),</span><br><span class="line">        <span class="attr">color</span>: particle.<span class="property">color</span>.<span class="title function_">clone</span>(),</span><br><span class="line">        <span class="attr">size</span>: particle.<span class="property">size</span>,</span><br><span class="line">        <span class="attr">lifeTime</span>: particle.<span class="property">lifeTime</span>,</span><br><span class="line">      &#125;)),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ‰¹é‡åº”ç”¨ç²’å­ç³»ç»Ÿ</span></span><br><span class="line">  <span class="title function_">applyParticleSystems</span>(<span class="params">particleSystems</span>) &#123;</span><br><span class="line">    particleSystems.<span class="title function_">forEach</span>(<span class="function">(<span class="params">particleSystem, name</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">applyParticleSystem</span>(name, particleSystem)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åº”ç”¨ç²’å­ç³»ç»Ÿ</span></span><br><span class="line">  <span class="title function_">applyParticleSystem</span>(<span class="params">particleSystemName, particleSystem</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> currentParticleSystem = <span class="variable language_">this</span>.<span class="property">particleSystems</span>.<span class="title function_">get</span>(particleSystemName)</span><br><span class="line">    <span class="keyword">if</span> (!currentParticleSystem) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    currentParticleSystem.<span class="property">emitRate</span> = particleSystem.<span class="property">emitRate</span></span><br><span class="line">    currentParticleSystem.<span class="property">lifeTime</span> = particleSystem.<span class="property">lifeTime</span></span><br><span class="line">    currentParticleSystem.<span class="property">size</span> = particleSystem.<span class="property">size</span></span><br><span class="line">    currentParticleSystem.<span class="property">color</span> = particleSystem.<span class="property">color</span></span><br><span class="line">    currentParticleSystem.<span class="property">color2</span> = particleSystem.<span class="property">color2</span></span><br><span class="line">    currentParticleSystem.<span class="property">colorDead</span> = particleSystem.<span class="property">colorDead</span></span><br><span class="line">    currentParticleSystem.<span class="property">gravity</span> = particleSystem.<span class="property">gravity</span></span><br><span class="line">    currentParticleSystem.<span class="property">direction</span> = particleSystem.<span class="property">direction</span></span><br><span class="line">    currentParticleSystem.<span class="property">direction2</span> = particleSystem.<span class="property">direction2</span></span><br><span class="line">    currentParticleSystem.<span class="property">minEmitPower</span> = particleSystem.<span class="property">minEmitPower</span></span><br><span class="line">    currentParticleSystem.<span class="property">maxEmitPower</span> = particleSystem.<span class="property">maxEmitPower</span></span><br><span class="line">    currentParticleSystem.<span class="property">minLifeTime</span> = particleSystem.<span class="property">minLifeTime</span></span><br><span class="line">    currentParticleSystem.<span class="property">maxLifeTime</span> = particleSystem.<span class="property">maxLifeTime</span></span><br><span class="line">    currentParticleSystem.<span class="property">minSize</span> = particleSystem.<span class="property">minSize</span></span><br><span class="line">    currentParticleSystem.<span class="property">maxSize</span> = particleSystem.<span class="property">maxSize</span></span><br><span class="line">    currentParticleSystem.<span class="property">minEmitBox</span> = particleSystem.<span class="property">minEmitBox</span></span><br><span class="line">    currentParticleSystem.<span class="property">maxEmitBox</span> = particleSystem.<span class="property">maxEmitBox</span></span><br><span class="line">    currentParticleSystem.<span class="property">emitBox</span> = particleSystem.<span class="property">emitBox</span></span><br><span class="line">    currentParticleSystem.<span class="property">particles</span> = particleSystem.<span class="property">particles</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">particle</span>) =&gt;</span> (&#123;</span><br><span class="line">      <span class="attr">position</span>: particle.<span class="property">position</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">velocity</span>: particle.<span class="property">velocity</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">color</span>: particle.<span class="property">color</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">size</span>: particle.<span class="property">size</span>,</span><br><span class="line">      <span class="attr">lifeTime</span>: particle.<span class="property">lifeTime</span>,</span><br><span class="line">    &#125;))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// èµ„æºæ¸…ç†</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">particleSystems</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">particleSystem</span>) =&gt;</span> &#123;</span><br><span class="line">      particleSystem.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">particleSystems</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> particleSystemManager = <span class="keyword">new</span> <span class="title class_">ParticleSystemManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºåŸºç¡€ç²’å­ç³»ç»Ÿ</span></span><br><span class="line"><span class="keyword">const</span> basicParticleSystem = particleSystemManager.<span class="title function_">createBasicParticleSystem</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºå¤åˆç²’å­ç³»ç»Ÿ</span></span><br><span class="line"><span class="keyword">const</span> complexParticleSystem = particleSystemManager.<span class="title function_">createComplexParticleSystem</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ ç²’å­ç³»ç»Ÿåˆ°åœºæ™¯</span></span><br><span class="line">scene.<span class="title function_">addParticleSystem</span>(basicParticleSystem)</span><br><span class="line">scene.<span class="title function_">addParticleSystem</span>(complexParticleSystem)</span><br></pre></td></tr></table></figure><h2 id="ğŸ”Š-Audio-éŸ³é¢‘ç³»ç»Ÿè¯¦è§£"><a href="#ğŸ”Š-Audio-éŸ³é¢‘ç³»ç»Ÿè¯¦è§£" class="headerlink" title="ğŸ”Š Audio éŸ³é¢‘ç³»ç»Ÿè¯¦è§£"></a>ğŸ”Š Audio éŸ³é¢‘ç³»ç»Ÿè¯¦è§£</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Audio éŸ³é¢‘ç³»ç»Ÿå®Œæ•´ç®¡ç†</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AudioManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sounds</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">soundTracks</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">audioEngine</span> = <span class="title class_">Engine</span>.<span class="property">audioEngine</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupDefaultAudio</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupDefaultAudio</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥éŸ³é¢‘å¼•æ“æ˜¯å¦å¯ç”¨</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">audioEngine</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;éŸ³é¢‘å¼•æ“ä¸å¯ç”¨&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;éŸ³é¢‘å¼•æ“å·²åˆå§‹åŒ–&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®å…¨å±€éŸ³é¢‘å‚æ•°</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setGlobalVolume</span>(<span class="number">1.0</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºéŸ³æ•ˆ</span></span><br><span class="line">  <span class="title function_">createSound</span>(<span class="params">name, url, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> soundOptions = &#123;</span><br><span class="line">      <span class="comment">// åŸºç¡€å±æ€§</span></span><br><span class="line">      <span class="attr">autoplay</span>: options.<span class="property">autoplay</span> || <span class="literal">false</span>, <span class="comment">// è‡ªåŠ¨æ’­æ”¾</span></span><br><span class="line">      <span class="attr">loop</span>: options.<span class="property">loop</span> || <span class="literal">false</span>, <span class="comment">// å¾ªç¯æ’­æ”¾</span></span><br><span class="line">      <span class="attr">volume</span>: options.<span class="property">volume</span> || <span class="number">1.0</span>, <span class="comment">// éŸ³é‡</span></span><br><span class="line">      <span class="attr">playbackRate</span>: options.<span class="property">playbackRate</span> || <span class="number">1.0</span>, <span class="comment">// æ’­æ”¾é€Ÿç‡</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 3DéŸ³é¢‘å±æ€§</span></span><br><span class="line">      <span class="attr">spatialSound</span>: options.<span class="property">spatialSound</span> || <span class="literal">false</span>, <span class="comment">// 3Dç©ºé—´éŸ³æ•ˆ</span></span><br><span class="line">      <span class="attr">maxDistance</span>: options.<span class="property">maxDistance</span> || <span class="number">100</span>, <span class="comment">// æœ€å¤§è·ç¦»</span></span><br><span class="line">      <span class="attr">rolloffFactor</span>: options.<span class="property">rolloffFactor</span> || <span class="number">1.0</span>, <span class="comment">// è¡°å‡å› å­</span></span><br><span class="line">      <span class="attr">refDistance</span>: options.<span class="property">refDistance</span> || <span class="number">1.0</span>, <span class="comment">// å‚è€ƒè·ç¦»</span></span><br><span class="line">      <span class="attr">distanceModel</span>: options.<span class="property">distanceModel</span> || <span class="string">&#x27;linear&#x27;</span>, <span class="comment">// è·ç¦»æ¨¡å‹</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// å›è°ƒå‡½æ•°</span></span><br><span class="line">      <span class="attr">onended</span>: options.<span class="property">onended</span> || <span class="literal">null</span>, <span class="comment">// æ’­æ”¾ç»“æŸå›è°ƒ</span></span><br><span class="line">      <span class="attr">onload</span>: options.<span class="property">onload</span> || <span class="literal">null</span>, <span class="comment">// åŠ è½½å®Œæˆå›è°ƒ</span></span><br><span class="line">      <span class="attr">onerror</span>: options.<span class="property">onerror</span> || <span class="literal">null</span>, <span class="comment">// é”™è¯¯å›è°ƒ</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// å…¶ä»–é€‰é¡¹</span></span><br><span class="line">      <span class="attr">streaming</span>: options.<span class="property">streaming</span> || <span class="literal">false</span>, <span class="comment">// æµå¼æ’­æ”¾</span></span><br><span class="line">      <span class="attr">length</span>: options.<span class="property">length</span> || <span class="number">0</span>, <span class="comment">// éŸ³é¢‘é•¿åº¦ï¼ˆç§’ï¼‰</span></span><br><span class="line">      <span class="attr">offset</span>: options.<span class="property">offset</span> || <span class="number">0</span>, <span class="comment">// æ’­æ”¾åç§»</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sound = <span class="keyword">new</span> <span class="title class_">Sound</span>(name, url, <span class="variable language_">this</span>.<span class="property">scene</span>, soundOptions.<span class="property">onload</span>, soundOptions)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">set</span>(name, sound)</span><br><span class="line">    <span class="keyword">return</span> sound</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºèƒŒæ™¯éŸ³ä¹</span></span><br><span class="line">  <span class="title function_">createBackgroundMusic</span>(<span class="params">name, url, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> musicOptions = &#123;</span><br><span class="line">      <span class="attr">autoplay</span>: options.<span class="property">autoplay</span> || <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">loop</span>: options.<span class="property">loop</span> || <span class="literal">true</span>, <span class="comment">// èƒŒæ™¯éŸ³ä¹é€šå¸¸å¾ªç¯æ’­æ”¾</span></span><br><span class="line">      <span class="attr">volume</span>: options.<span class="property">volume</span> || <span class="number">0.5</span>, <span class="comment">// èƒŒæ™¯éŸ³ä¹éŸ³é‡è¾ƒä½</span></span><br><span class="line">      <span class="attr">spatialSound</span>: <span class="literal">false</span>, <span class="comment">// èƒŒæ™¯éŸ³ä¹ä¸ä½¿ç”¨3DéŸ³æ•ˆ</span></span><br><span class="line">      <span class="attr">streaming</span>: options.<span class="property">streaming</span> || <span class="literal">true</span>, <span class="comment">// å¤§æ–‡ä»¶ä½¿ç”¨æµå¼æ’­æ”¾</span></span><br><span class="line">      ...options,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">createSound</span>(name, url, musicOptions)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»º3DéŸ³æ•ˆ</span></span><br><span class="line">  <span class="title function_">createSpatialSound</span>(<span class="params">name, url, mesh, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> spatialOptions = &#123;</span><br><span class="line">      <span class="attr">spatialSound</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">maxDistance</span>: options.<span class="property">maxDistance</span> || <span class="number">50</span>,</span><br><span class="line">      <span class="attr">rolloffFactor</span>: options.<span class="property">rolloffFactor</span> || <span class="number">2.0</span>,</span><br><span class="line">      <span class="attr">refDistance</span>: options.<span class="property">refDistance</span> || <span class="number">1.0</span>,</span><br><span class="line">      <span class="attr">distanceModel</span>: options.<span class="property">distanceModel</span> || <span class="string">&#x27;exponential&#x27;</span>,</span><br><span class="line">      ...options,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="title function_">createSound</span>(name, url, spatialOptions)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†éŸ³æ•ˆé™„åŠ åˆ°ç½‘æ ¼</span></span><br><span class="line">    <span class="keyword">if</span> (mesh) &#123;</span><br><span class="line">      sound.<span class="title function_">attachToMesh</span>(mesh)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sound</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºéŸ³è½¨ç»„</span></span><br><span class="line">  <span class="title function_">createSoundTrack</span>(<span class="params">name, sounds = []</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> soundTrack = <span class="keyword">new</span> <span class="title class_">SoundTrack</span>(<span class="variable language_">this</span>.<span class="property">scene</span>, &#123;</span><br><span class="line">      <span class="attr">volume</span>: <span class="number">1.0</span>,</span><br><span class="line">      <span class="attr">mainTrack</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ éŸ³æ•ˆåˆ°éŸ³è½¨</span></span><br><span class="line">    sounds.<span class="title function_">forEach</span>(<span class="function">(<span class="params">soundName</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">get</span>(soundName)</span><br><span class="line">      <span class="keyword">if</span> (sound) &#123;</span><br><span class="line">        soundTrack.<span class="title function_">addSound</span>(sound)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">soundTracks</span>.<span class="title function_">set</span>(name, soundTrack)</span><br><span class="line">    <span class="keyword">return</span> soundTrack</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ’­æ”¾éŸ³æ•ˆ</span></span><br><span class="line">  <span class="title function_">playSound</span>(<span class="params">name, when = <span class="number">0</span>, offset = <span class="number">0</span>, length = <span class="number">0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">if</span> (!sound) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`éŸ³æ•ˆ <span class="subst">$&#123;name&#125;</span> æœªæ‰¾åˆ°`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (when &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// å»¶è¿Ÿæ’­æ”¾</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          sound.<span class="title function_">play</span>(when, offset, length)</span><br><span class="line">        &#125;, when * <span class="number">1000</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sound.<span class="title function_">play</span>(when, offset, length)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`æ’­æ”¾éŸ³æ•ˆ <span class="subst">$&#123;name&#125;</span> å¤±è´¥:`</span>, error)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœæ­¢éŸ³æ•ˆ</span></span><br><span class="line">  <span class="title function_">stopSound</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">if</span> (sound) &#123;</span><br><span class="line">      sound.<span class="title function_">stop</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æš‚åœéŸ³æ•ˆ</span></span><br><span class="line">  <span class="title function_">pauseSound</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">if</span> (sound) &#123;</span><br><span class="line">      sound.<span class="title function_">pause</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®éŸ³æ•ˆéŸ³é‡</span></span><br><span class="line">  <span class="title function_">setSoundVolume</span>(<span class="params">name, volume</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">if</span> (sound) &#123;</span><br><span class="line">      sound.<span class="title function_">setVolume</span>(volume)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ·¡å…¥æ•ˆæœ</span></span><br><span class="line">  <span class="title function_">fadeInSound</span>(<span class="params">name, duration = <span class="number">1.0</span>, targetVolume = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">if</span> (!sound) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> startVolume = <span class="number">0</span></span><br><span class="line">    <span class="keyword">const</span> steps = <span class="number">60</span> <span class="comment">// 60å¸§</span></span><br><span class="line">    <span class="keyword">const</span> stepDuration = (duration * <span class="number">1000</span>) / steps</span><br><span class="line">    <span class="keyword">const</span> volumeStep = (targetVolume - startVolume) / steps</span><br><span class="line"></span><br><span class="line">    sound.<span class="title function_">setVolume</span>(startVolume)</span><br><span class="line">    sound.<span class="title function_">play</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> currentStep = <span class="number">0</span></span><br><span class="line">    <span class="keyword">const</span> fadeInterval = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      currentStep++</span><br><span class="line">      <span class="keyword">const</span> currentVolume = startVolume + volumeStep * currentStep</span><br><span class="line">      sound.<span class="title function_">setVolume</span>(currentVolume)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (currentStep &gt;= steps) &#123;</span><br><span class="line">        <span class="built_in">clearInterval</span>(fadeInterval)</span><br><span class="line">        sound.<span class="title function_">setVolume</span>(targetVolume)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, stepDuration)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ·¡å‡ºæ•ˆæœ</span></span><br><span class="line">  <span class="title function_">fadeOutSound</span>(<span class="params">name, duration = <span class="number">1.0</span>, stopAfterFade = <span class="literal">true</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">if</span> (!sound) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> startVolume = sound.<span class="title function_">getVolume</span>()</span><br><span class="line">    <span class="keyword">const</span> targetVolume = <span class="number">0</span></span><br><span class="line">    <span class="keyword">const</span> steps = <span class="number">60</span></span><br><span class="line">    <span class="keyword">const</span> stepDuration = (duration * <span class="number">1000</span>) / steps</span><br><span class="line">    <span class="keyword">const</span> volumeStep = (startVolume - targetVolume) / steps</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> currentStep = <span class="number">0</span></span><br><span class="line">    <span class="keyword">const</span> fadeInterval = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      currentStep++</span><br><span class="line">      <span class="keyword">const</span> currentVolume = startVolume - volumeStep * currentStep</span><br><span class="line">      sound.<span class="title function_">setVolume</span>(<span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="number">0</span>, currentVolume))</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (currentStep &gt;= steps) &#123;</span><br><span class="line">        <span class="built_in">clearInterval</span>(fadeInterval)</span><br><span class="line">        sound.<span class="title function_">setVolume</span>(targetVolume)</span><br><span class="line">        <span class="keyword">if</span> (stopAfterFade) &#123;</span><br><span class="line">          sound.<span class="title function_">stop</span>()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, stepDuration)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®å…¨å±€éŸ³é‡</span></span><br><span class="line">  <span class="title function_">setGlobalVolume</span>(<span class="params">volume</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">audioEngine</span>) &#123;</span><br><span class="line">      <span class="title class_">Engine</span>.<span class="property">audioEngine</span>.<span class="title function_">setGlobalVolume</span>(volume)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é¢„åŠ è½½éŸ³é¢‘</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">preloadSound</span>(<span class="params">name, url</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> sound = <span class="keyword">new</span> <span class="title class_">Sound</span>(</span><br><span class="line">        name,</span><br><span class="line">        url,</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">        <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">set</span>(name, sound)</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`éŸ³æ•ˆ <span class="subst">$&#123;name&#125;</span> é¢„åŠ è½½å®Œæˆ`</span>)</span><br><span class="line">          <span class="title function_">resolve</span>(sound)</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">autoplay</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">onError</span>: <span class="function">(<span class="params">sound, error</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`éŸ³æ•ˆ <span class="subst">$&#123;name&#125;</span> åŠ è½½å¤±è´¥:`</span>, error)</span><br><span class="line">            <span class="title function_">reject</span>(error)</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–éŸ³æ•ˆä¿¡æ¯</span></span><br><span class="line">  <span class="title function_">getSoundInfo</span>(<span class="params">soundName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">get</span>(soundName)</span><br><span class="line">    <span class="keyword">if</span> (!sound) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">name</span>: soundName,</span><br><span class="line">      <span class="attr">isPlaying</span>: sound.<span class="property">isPlaying</span>,</span><br><span class="line">      <span class="attr">isPaused</span>: sound.<span class="property">isPaused</span>,</span><br><span class="line">      <span class="attr">volume</span>: sound.<span class="title function_">getVolume</span>(),</span><br><span class="line">      <span class="attr">playbackRate</span>: sound.<span class="property">playbackRate</span>,</span><br><span class="line">      <span class="attr">spatialSound</span>: sound.<span class="property">spatialSound</span>,</span><br><span class="line">      <span class="attr">loop</span>: sound.<span class="property">loop</span>,</span><br><span class="line">      <span class="attr">autoplay</span>: sound.<span class="property">autoplay</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// èµ„æºæ¸…ç†</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">sound</span>) =&gt;</span> &#123;</span><br><span class="line">      sound.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">soundTracks</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">track</span>) =&gt;</span> &#123;</span><br><span class="line">      track.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">soundTracks</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> audioManager = <span class="keyword">new</span> <span class="title class_">AudioManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºèƒŒæ™¯éŸ³ä¹</span></span><br><span class="line">audioManager.<span class="title function_">createBackgroundMusic</span>(<span class="string">&#x27;bgMusic&#x27;</span>, <span class="string">&#x27;/audio/background.mp3&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">volume</span>: <span class="number">0.3</span>,</span><br><span class="line">  <span class="attr">autoplay</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»º3DéŸ³æ•ˆ</span></span><br><span class="line"><span class="keyword">const</span> fireSound = audioManager.<span class="title function_">createSpatialSound</span>(<span class="string">&#x27;fire&#x27;</span>, <span class="string">&#x27;/audio/fire.wav&#x27;</span>, fireMesh, &#123;</span><br><span class="line">  <span class="attr">loop</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">volume</span>: <span class="number">0.8</span>,</span><br><span class="line">  <span class="attr">maxDistance</span>: <span class="number">50</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ’­æ”¾éŸ³æ•ˆ</span></span><br><span class="line">audioManager.<span class="title function_">playSound</span>(<span class="string">&#x27;fire&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·¡å…¥èƒŒæ™¯éŸ³ä¹</span></span><br><span class="line">audioManager.<span class="title function_">fadeInSound</span>(<span class="string">&#x27;bgMusic&#x27;</span>, <span class="number">2.0</span>, <span class="number">0.5</span>)</span><br></pre></td></tr></table></figure><h2 id="ğŸ®-Input-è¾“å…¥ç³»ç»Ÿè¯¦è§£"><a href="#ğŸ®-Input-è¾“å…¥ç³»ç»Ÿè¯¦è§£" class="headerlink" title="ğŸ® Input è¾“å…¥ç³»ç»Ÿè¯¦è§£"></a>ğŸ® Input è¾“å…¥ç³»ç»Ÿè¯¦è§£</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Input è¾“å…¥ç³»ç»Ÿå®Œæ•´ç®¡ç†</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InputManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span> = scene.<span class="title function_">getEngine</span>().<span class="title function_">getRenderingCanvas</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">actionManager</span> = <span class="keyword">new</span> <span class="title class_">ActionManager</span>(scene)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¾“å…¥çŠ¶æ€</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">keys</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mouseButtons</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mousePosition</span> = &#123; <span class="attr">x</span>: <span class="number">0</span>, <span class="attr">y</span>: <span class="number">0</span> &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gamepads</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// äº‹ä»¶ç›‘å¬å™¨</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">keyboardObservables</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pointerObservables</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupDefaultInput</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupDefaultInput</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®é”®ç›˜è¾“å…¥</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupKeyboardInput</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®é¼ æ ‡è¾“å…¥</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupPointerInput</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®æ¸¸æˆæ‰‹æŸ„è¾“å…¥</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupGamepadInput</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®åœºæ™¯ActionManager</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">actionManager</span> = <span class="variable language_">this</span>.<span class="property">actionManager</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®é”®ç›˜è¾“å…¥</span></span><br><span class="line">  <span class="title function_">setupKeyboardInput</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ç›‘å¬é”®ç›˜æŒ‰ä¸‹</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">keyboardObservables</span>.<span class="title function_">set</span>(</span><br><span class="line">      <span class="string">&#x27;keydown&#x27;</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onKeyboardObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">kbInfo</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (kbInfo.<span class="property">type</span> === <span class="title class_">KeyboardEventTypes</span>.<span class="property">KEYDOWN</span>) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">keys</span>.<span class="title function_">set</span>(kbInfo.<span class="property">event</span>.<span class="property">code</span>, &#123;</span><br><span class="line">            <span class="attr">key</span>: kbInfo.<span class="property">event</span>.<span class="property">key</span>,</span><br><span class="line">            <span class="attr">code</span>: kbInfo.<span class="property">event</span>.<span class="property">code</span>,</span><br><span class="line">            <span class="attr">pressed</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">          &#125;)</span><br><span class="line"></span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onKeyDown</span>(kbInfo.<span class="property">event</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç›‘å¬é”®ç›˜é‡Šæ”¾</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">keyboardObservables</span>.<span class="title function_">set</span>(</span><br><span class="line">      <span class="string">&#x27;keyup&#x27;</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onKeyboardObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">kbInfo</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (kbInfo.<span class="property">type</span> === <span class="title class_">KeyboardEventTypes</span>.<span class="property">KEYUP</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> keyData = <span class="variable language_">this</span>.<span class="property">keys</span>.<span class="title function_">get</span>(kbInfo.<span class="property">event</span>.<span class="property">code</span>)</span><br><span class="line">          <span class="keyword">if</span> (keyData) &#123;</span><br><span class="line">            keyData.<span class="property">pressed</span> = <span class="literal">false</span></span><br><span class="line">            keyData.<span class="property">releasedTimestamp</span> = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onKeyUp</span>(kbInfo.<span class="property">event</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®æŒ‡é’ˆï¼ˆé¼ æ ‡/è§¦æ‘¸ï¼‰è¾“å…¥</span></span><br><span class="line">  <span class="title function_">setupPointerInput</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ç›‘å¬æŒ‡é’ˆæŒ‰ä¸‹</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pointerObservables</span>.<span class="title function_">set</span>(</span><br><span class="line">      <span class="string">&#x27;pointerdown&#x27;</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onPointerObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">pointerInfo</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (pointerInfo.<span class="property">type</span> === <span class="title class_">PointerEventTypes</span>.<span class="property">POINTERDOWN</span>) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">mouseButtons</span>.<span class="title function_">set</span>(pointerInfo.<span class="property">event</span>.<span class="property">button</span>, &#123;</span><br><span class="line">            <span class="attr">button</span>: pointerInfo.<span class="property">event</span>.<span class="property">button</span>,</span><br><span class="line">            <span class="attr">pressed</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">position</span>: &#123; <span class="attr">x</span>: pointerInfo.<span class="property">event</span>.<span class="property">clientX</span>, <span class="attr">y</span>: pointerInfo.<span class="property">event</span>.<span class="property">clientY</span> &#125;,</span><br><span class="line">            <span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">          &#125;)</span><br><span class="line"></span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onPointerDown</span>(pointerInfo.<span class="property">event</span>, pointerInfo)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç›‘å¬æŒ‡é’ˆé‡Šæ”¾</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pointerObservables</span>.<span class="title function_">set</span>(</span><br><span class="line">      <span class="string">&#x27;pointerup&#x27;</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onPointerObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">pointerInfo</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (pointerInfo.<span class="property">type</span> === <span class="title class_">PointerEventTypes</span>.<span class="property">POINTERUP</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> buttonData = <span class="variable language_">this</span>.<span class="property">mouseButtons</span>.<span class="title function_">get</span>(pointerInfo.<span class="property">event</span>.<span class="property">button</span>)</span><br><span class="line">          <span class="keyword">if</span> (buttonData) &#123;</span><br><span class="line">            buttonData.<span class="property">pressed</span> = <span class="literal">false</span></span><br><span class="line">            buttonData.<span class="property">releasedTimestamp</span> = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onPointerUp</span>(pointerInfo.<span class="property">event</span>, pointerInfo)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç›‘å¬æŒ‡é’ˆç§»åŠ¨</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pointerObservables</span>.<span class="title function_">set</span>(</span><br><span class="line">      <span class="string">&#x27;pointermove&#x27;</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onPointerObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">pointerInfo</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (pointerInfo.<span class="property">type</span> === <span class="title class_">PointerEventTypes</span>.<span class="property">POINTERMOVE</span>) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">mousePosition</span>.<span class="property">x</span> = pointerInfo.<span class="property">event</span>.<span class="property">clientX</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">mousePosition</span>.<span class="property">y</span> = pointerInfo.<span class="property">event</span>.<span class="property">clientY</span></span><br><span class="line"></span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onPointerMove</span>(pointerInfo.<span class="property">event</span>, pointerInfo)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç›‘å¬é¼ æ ‡æ»šè½®</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pointerObservables</span>.<span class="title function_">set</span>(</span><br><span class="line">      <span class="string">&#x27;wheel&#x27;</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onPointerObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">pointerInfo</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (pointerInfo.<span class="property">type</span> === <span class="title class_">PointerEventTypes</span>.<span class="property">POINTERWHEEL</span>) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onWheel</span>(pointerInfo.<span class="property">event</span>, pointerInfo)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®æ¸¸æˆæ‰‹æŸ„è¾“å…¥</span></span><br><span class="line">  <span class="title function_">setupGamepadInput</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ¸¸æˆæ‰‹æŸ„æ”¯æŒ</span></span><br><span class="line">    <span class="keyword">if</span> (navigator.<span class="property">getGamepads</span>) &#123;</span><br><span class="line">      <span class="comment">// ç›‘å¬æ¸¸æˆæ‰‹æŸ„è¿æ¥</span></span><br><span class="line">      <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;gamepadconnected&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">onGamepadConnected</span>(event.<span class="property">gamepad</span>)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ç›‘å¬æ¸¸æˆæ‰‹æŸ„æ–­å¼€</span></span><br><span class="line">      <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;gamepaddisconnected&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">onGamepadDisconnected</span>(event.<span class="property">gamepad</span>)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å®šæœŸæ£€æŸ¥æ¸¸æˆæ‰‹æŸ„çŠ¶æ€</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">gamepadCheckInterval</span> = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">updateGamepadState</span>()</span><br><span class="line">      &#125;, <span class="number">16</span>) <span class="comment">// 60fps</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é”®ç›˜äº‹ä»¶å¤„ç†å™¨ï¼ˆå¯é‡å†™ï¼‰</span></span><br><span class="line">  <span class="title function_">onKeyDown</span>(<span class="params">event</span>) &#123;</span><br><span class="line">    <span class="comment">// é»˜è®¤å®ç° - å¯è¢«å­ç±»é‡å†™</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Key pressed: <span class="subst">$&#123;event.key&#125;</span> (<span class="subst">$&#123;event.code&#125;</span>)`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onKeyUp</span>(<span class="params">event</span>) &#123;</span><br><span class="line">    <span class="comment">// é»˜è®¤å®ç° - å¯è¢«å­ç±»é‡å†™</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Key released: <span class="subst">$&#123;event.key&#125;</span> (<span class="subst">$&#123;event.code&#125;</span>)`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æŒ‡é’ˆäº‹ä»¶å¤„ç†å™¨ï¼ˆå¯é‡å†™ï¼‰</span></span><br><span class="line">  <span class="title function_">onPointerDown</span>(<span class="params">event, pointerInfo</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Pointer down: button <span class="subst">$&#123;event.button&#125;</span> at (<span class="subst">$&#123;event.clientX&#125;</span>, <span class="subst">$&#123;event.clientY&#125;</span>)`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onPointerUp</span>(<span class="params">event, pointerInfo</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Pointer up: button <span class="subst">$&#123;event.button&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onPointerMove</span>(<span class="params">event, pointerInfo</span>) &#123;</span><br><span class="line">    <span class="comment">// é€šå¸¸ä¸æ‰“å°ç§»åŠ¨äº‹ä»¶ï¼Œé¢‘ç‡å¤ªé«˜</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onWheel</span>(<span class="params">event, pointerInfo</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Wheel: <span class="subst">$&#123;pointerInfo.event.deltaY&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¸¸æˆæ‰‹æŸ„äº‹ä»¶å¤„ç†å™¨</span></span><br><span class="line">  <span class="title function_">onGamepadConnected</span>(<span class="params">gamepad</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Gamepad connected: <span class="subst">$&#123;gamepad.id&#125;</span>`</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="title function_">set</span>(gamepad.<span class="property">index</span>, &#123;</span><br><span class="line">      <span class="attr">gamepad</span>: gamepad,</span><br><span class="line">      <span class="attr">lastState</span>: &#123;</span><br><span class="line">        <span class="attr">buttons</span>: <span class="title class_">Array</span>(gamepad.<span class="property">buttons</span>.<span class="property">length</span>).<span class="title function_">fill</span>(<span class="literal">false</span>),</span><br><span class="line">        <span class="attr">axes</span>: <span class="title class_">Array</span>(gamepad.<span class="property">axes</span>.<span class="property">length</span>).<span class="title function_">fill</span>(<span class="number">0</span>),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onGamepadDisconnected</span>(<span class="params">gamepad</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Gamepad disconnected: <span class="subst">$&#123;gamepad.id&#125;</span>`</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="title function_">delete</span>(gamepad.<span class="property">index</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">updateGamepadState</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> gamepads = navigator.<span class="title function_">getGamepads</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> gamepad <span class="keyword">of</span> gamepads) &#123;</span><br><span class="line">      <span class="keyword">if</span> (gamepad &amp;&amp; <span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="title function_">has</span>(gamepad.<span class="property">index</span>)) &#123;</span><br><span class="line">        <span class="keyword">const</span> gamepadData = <span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="title function_">get</span>(gamepad.<span class="property">index</span>)</span><br><span class="line">        <span class="keyword">const</span> lastState = gamepadData.<span class="property">lastState</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ£€æŸ¥æŒ‰é’®çŠ¶æ€å˜åŒ–</span></span><br><span class="line">        gamepad.<span class="property">buttons</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">button, index</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> wasPressed = lastState.<span class="property">buttons</span>[index]</span><br><span class="line">          <span class="keyword">const</span> isPressed = button.<span class="property">pressed</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (isPressed &amp;&amp; !wasPressed) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">onGamepadButtonDown</span>(gamepad, index, button)</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isPressed &amp;&amp; wasPressed) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">onGamepadButtonUp</span>(gamepad, index, button)</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          lastState.<span class="property">buttons</span>[index] = isPressed</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ£€æŸ¥æ‘‡æ†çŠ¶æ€å˜åŒ–</span></span><br><span class="line">        gamepad.<span class="property">axes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">axis, index</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> lastValue = lastState.<span class="property">axes</span>[index]</span><br><span class="line">          <span class="keyword">const</span> currentValue = axis</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (<span class="title class_">Math</span>.<span class="title function_">abs</span>(currentValue - lastValue) &gt; <span class="number">0.1</span>) &#123;</span><br><span class="line">            <span class="comment">// æ­»åŒºå¤„ç†</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">onGamepadAxisMove</span>(gamepad, index, currentValue, lastValue)</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          lastState.<span class="property">axes</span>[index] = currentValue</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onGamepadButtonDown</span>(<span class="params">gamepad, buttonIndex, button</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Gamepad <span class="subst">$&#123;gamepad.index&#125;</span> button <span class="subst">$&#123;buttonIndex&#125;</span> pressed`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onGamepadButtonUp</span>(<span class="params">gamepad, buttonIndex, button</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Gamepad <span class="subst">$&#123;gamepad.index&#125;</span> button <span class="subst">$&#123;buttonIndex&#125;</span> released`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onGamepadAxisMove</span>(<span class="params">gamepad, axisIndex, currentValue, lastValue</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Gamepad <span class="subst">$&#123;gamepad.index&#125;</span> axis <span class="subst">$&#123;axisIndex&#125;</span>: <span class="subst">$&#123;currentValue&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¾“å…¥çŠ¶æ€æŸ¥è¯¢æ–¹æ³•</span></span><br><span class="line">  <span class="title function_">isKeyPressed</span>(<span class="params">keyCode</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> keyData = <span class="variable language_">this</span>.<span class="property">keys</span>.<span class="title function_">get</span>(keyCode)</span><br><span class="line">    <span class="keyword">return</span> keyData ? keyData.<span class="property">pressed</span> : <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">isMouseButtonPressed</span>(<span class="params">button</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> buttonData = <span class="variable language_">this</span>.<span class="property">mouseButtons</span>.<span class="title function_">get</span>(button)</span><br><span class="line">    <span class="keyword">return</span> buttonData ? buttonData.<span class="property">pressed</span> : <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getMousePosition</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; ...<span class="variable language_">this</span>.<span class="property">mousePosition</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">isGamepadButtonPressed</span>(<span class="params">gamepadIndex, buttonIndex</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> gamepadData = <span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="title function_">get</span>(gamepadIndex)</span><br><span class="line">    <span class="keyword">if</span> (!gamepadData) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> gamepad = navigator.<span class="title function_">getGamepads</span>()[gamepadIndex]</span><br><span class="line">    <span class="keyword">return</span> gamepad &amp;&amp; gamepad.<span class="property">buttons</span>[buttonIndex] &amp;&amp; gamepad.<span class="property">buttons</span>[buttonIndex].<span class="property">pressed</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getGamepadAxisValue</span>(<span class="params">gamepadIndex, axisIndex</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> gamepadData = <span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="title function_">get</span>(gamepadIndex)</span><br><span class="line">    <span class="keyword">if</span> (!gamepadData) <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> gamepad = navigator.<span class="title function_">getGamepads</span>()[gamepadIndex]</span><br><span class="line">    <span class="keyword">return</span> gamepad &amp;&amp; gamepad.<span class="property">axes</span>[axisIndex] ? gamepad.<span class="property">axes</span>[axisIndex] : <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ActionManager ä¾¿æ·æ–¹æ³•</span></span><br><span class="line">  <span class="title function_">addKeyAction</span>(<span class="params">keyCode, trigger, callback</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> action = <span class="keyword">new</span> <span class="title class_">ExecuteCodeAction</span>(trigger || <span class="title class_">ActionManager</span>.<span class="property">OnKeyDownTrigger</span>, callback)</span><br><span class="line">    action.<span class="property">trigger</span>.<span class="property">parameter</span> = keyCode</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">actionManager</span>.<span class="title function_">registerAction</span>(action)</span><br><span class="line">    <span class="keyword">return</span> action</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">addPointerAction</span>(<span class="params">trigger, callback, condition = <span class="literal">null</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> action = <span class="keyword">new</span> <span class="title class_">ExecuteCodeAction</span>(trigger, callback)</span><br><span class="line">    <span class="keyword">if</span> (condition) &#123;</span><br><span class="line">      action.<span class="property">trigger</span>.<span class="property">parameter</span> = condition</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">actionManager</span>.<span class="title function_">registerAction</span>(action)</span><br><span class="line">    <span class="keyword">return</span> action</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç»„åˆæŒ‰é”®æ£€æµ‹</span></span><br><span class="line">  <span class="title function_">areKeysPressed</span>(<span class="params">keyCodes</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> keyCodes.<span class="title function_">every</span>(<span class="function">(<span class="params">keyCode</span>) =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">isKeyPressed</span>(keyCode))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¿«æ·é”®ç»‘å®š</span></span><br><span class="line">  <span class="title function_">bindShortcut</span>(<span class="params">keys, callback, description = <span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> shortcut = &#123;</span><br><span class="line">      <span class="attr">keys</span>: <span class="title class_">Array</span>.<span class="title function_">isArray</span>(keys) ? keys : [keys],</span><br><span class="line">      <span class="attr">callback</span>: callback,</span><br><span class="line">      <span class="attr">description</span>: description,</span><br><span class="line">      <span class="attr">active</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¯å¸§æ£€æŸ¥å¿«æ·é”®</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">checkShortcut</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (shortcut.<span class="property">active</span> &amp;&amp; <span class="variable language_">this</span>.<span class="title function_">areKeysPressed</span>(shortcut.<span class="property">keys</span>)) &#123;</span><br><span class="line">        <span class="title function_">callback</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">registerBeforeRender</span>(checkShortcut)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">unbind</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        shortcut.<span class="property">active</span> = <span class="literal">false</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">unregisterBeforeRender</span>(checkShortcut)</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">description</span>: shortcut.<span class="property">description</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è™šæ‹Ÿæ‘‡æ†æ”¯æŒï¼ˆç§»åŠ¨ç«¯ï¼‰</span></span><br><span class="line">  <span class="title function_">createVirtualJoystick</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title class_">VirtualJoystick</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;VirtualJoystick ä¸å¯ç”¨&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> joystick = <span class="keyword">new</span> <span class="title class_">VirtualJoystick</span>(options.<span class="property">leftJoystick</span> !== <span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®å›è°ƒ</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">onMove</span>) &#123;</span><br><span class="line">      joystick.<span class="title function_">setJoystickSensibility</span>(options.<span class="property">sensitivity</span> || <span class="number">25</span>)</span><br><span class="line">      joystick.<span class="property">onPointerDown</span> = options.<span class="property">onPointerDown</span></span><br><span class="line">      joystick.<span class="property">onPointerUp</span> = options.<span class="property">onPointerUp</span></span><br><span class="line">      joystick.<span class="property">onPointerMove</span> = options.<span class="property">onMove</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> joystick</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§¦æ‘¸æ‰‹åŠ¿æ”¯æŒ</span></span><br><span class="line">  <span class="title function_">setupTouchGestures</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">ontouchstart</span> === <span class="literal">undefined</span>) <span class="keyword">return</span> <span class="comment">// ä¸æ˜¯è§¦æ‘¸è®¾å¤‡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> touchStartTime = <span class="number">0</span></span><br><span class="line">    <span class="keyword">let</span> touchStartPos = &#123; <span class="attr">x</span>: <span class="number">0</span>, <span class="attr">y</span>: <span class="number">0</span> &#125;</span><br><span class="line">    <span class="keyword">let</span> lastTouchDistance = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;touchstart&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">      touchStartTime = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">      <span class="keyword">if</span> (event.<span class="property">touches</span>.<span class="property">length</span> === <span class="number">1</span>) &#123;</span><br><span class="line">        touchStartPos.<span class="property">x</span> = event.<span class="property">touches</span>[<span class="number">0</span>].<span class="property">clientX</span></span><br><span class="line">        touchStartPos.<span class="property">y</span> = event.<span class="property">touches</span>[<span class="number">0</span>].<span class="property">clientY</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.<span class="property">touches</span>.<span class="property">length</span> === <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> touch1 = event.<span class="property">touches</span>[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">const</span> touch2 = event.<span class="property">touches</span>[<span class="number">1</span>]</span><br><span class="line">        lastTouchDistance = <span class="title class_">Math</span>.<span class="title function_">sqrt</span>(</span><br><span class="line">          <span class="title class_">Math</span>.<span class="title function_">pow</span>(touch2.<span class="property">clientX</span> - touch1.<span class="property">clientX</span>, <span class="number">2</span>) +</span><br><span class="line">            <span class="title class_">Math</span>.<span class="title function_">pow</span>(touch2.<span class="property">clientY</span> - touch1.<span class="property">clientY</span>, <span class="number">2</span>),</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;touchend&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> touchDuration = <span class="title class_">Date</span>.<span class="title function_">now</span>() - touchStartTime</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (event.<span class="property">changedTouches</span>.<span class="property">length</span> === <span class="number">1</span> &amp;&amp; touchDuration &lt; <span class="number">300</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> touch = event.<span class="property">changedTouches</span>[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">const</span> deltaX = <span class="title class_">Math</span>.<span class="title function_">abs</span>(touch.<span class="property">clientX</span> - touchStartPos.<span class="property">x</span>)</span><br><span class="line">        <span class="keyword">const</span> deltaY = <span class="title class_">Math</span>.<span class="title function_">abs</span>(touch.<span class="property">clientY</span> - touchStartPos.<span class="property">y</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (deltaX &lt; <span class="number">10</span> &amp;&amp; deltaY &lt; <span class="number">10</span>) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">onTap</span> &amp;&amp; <span class="variable language_">this</span>.<span class="title function_">onTap</span>(touch)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;touchmove&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (event.<span class="property">touches</span>.<span class="property">length</span> === <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> touch1 = event.<span class="property">touches</span>[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">const</span> touch2 = event.<span class="property">touches</span>[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">const</span> currentDistance = <span class="title class_">Math</span>.<span class="title function_">sqrt</span>(</span><br><span class="line">          <span class="title class_">Math</span>.<span class="title function_">pow</span>(touch2.<span class="property">clientX</span> - touch1.<span class="property">clientX</span>, <span class="number">2</span>) +</span><br><span class="line">            <span class="title class_">Math</span>.<span class="title function_">pow</span>(touch2.<span class="property">clientY</span> - touch1.<span class="property">clientY</span>, <span class="number">2</span>),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> scale = currentDistance / lastTouchDistance</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">onPinch</span> &amp;&amp; <span class="variable language_">this</span>.<span class="title function_">onPinch</span>(scale)</span><br><span class="line">        lastTouchDistance = currentDistance</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§¦æ‘¸å›è°ƒè®¾ç½®</span></span><br><span class="line">  <span class="title function_">onTap</span>(<span class="params">touch</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Tap detected at:&#x27;</span>, touch.<span class="property">clientX</span>, touch.<span class="property">clientY</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onPinch</span>(<span class="params">scale</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Pinch detected, scale:&#x27;</span>, scale)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–è¾“å…¥çŠ¶æ€ä¿¡æ¯</span></span><br><span class="line">  <span class="title function_">getInputState</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">keyboard</span>: &#123;</span><br><span class="line">        <span class="attr">pressedKeys</span>: <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="variable language_">this</span>.<span class="property">keys</span>.<span class="title function_">entries</span>()).<span class="title function_">filter</span>(<span class="function">(<span class="params">[, data]</span>) =&gt;</span> data.<span class="property">pressed</span>),</span><br><span class="line">        <span class="attr">keyCount</span>: <span class="variable language_">this</span>.<span class="property">keys</span>.<span class="property">size</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">mouse</span>: &#123;</span><br><span class="line">        <span class="attr">position</span>: <span class="variable language_">this</span>.<span class="property">mousePosition</span>,</span><br><span class="line">        <span class="attr">pressedButtons</span>: <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="variable language_">this</span>.<span class="property">mouseButtons</span>.<span class="title function_">entries</span>()).<span class="title function_">filter</span>(<span class="function">(<span class="params">[, data]</span>) =&gt;</span> data.<span class="property">pressed</span>),</span><br><span class="line">        <span class="attr">buttonCount</span>: <span class="variable language_">this</span>.<span class="property">mouseButtons</span>.<span class="property">size</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">gamepad</span>: &#123;</span><br><span class="line">        <span class="attr">connectedGamepads</span>: <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="title function_">keys</span>()),</span><br><span class="line">        <span class="attr">gamepadCount</span>: <span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="property">size</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// èµ„æºæ¸…ç†</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// æ¸…ç†é”®ç›˜ç›‘å¬å™¨</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">keyboardObservables</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">observable</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onKeyboardObservable</span>.<span class="title function_">remove</span>(observable)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">keyboardObservables</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç†æŒ‡é’ˆç›‘å¬å™¨</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pointerObservables</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">observable</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onPointerObservable</span>.<span class="title function_">remove</span>(observable)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pointerObservables</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç†æ¸¸æˆæ‰‹æŸ„ç›‘å¬å™¨</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">gamepadCheckInterval</span>) &#123;</span><br><span class="line">      <span class="built_in">clearInterval</span>(<span class="variable language_">this</span>.<span class="property">gamepadCheckInterval</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç†çŠ¶æ€</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">keys</span>.<span class="title function_">clear</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mouseButtons</span>.<span class="title function_">clear</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> inputManager = <span class="keyword">new</span> <span class="title class_">InputManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// é”®ç›˜äº‹ä»¶é‡å†™ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomInputManager</span> <span class="keyword">extends</span> <span class="title class_ inherited__">InputManager</span> &#123;</span><br><span class="line">  <span class="title function_">onKeyDown</span>(<span class="params">event</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (event.<span class="property">code</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;KeyW&#x27;</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å‘å‰ç§»åŠ¨&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;KeyS&#x27;</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å‘åç§»åŠ¨&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;KeyA&#x27;</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å‘å·¦ç§»åŠ¨&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;KeyD&#x27;</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å‘å³ç§»åŠ¨&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;Space&#x27;</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;è·³è·ƒ&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onPointerDown</span>(<span class="params">event, pointerInfo</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (event.<span class="property">button</span> === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// å·¦é”®</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å°„å‡»&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.<span class="property">button</span> === <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="comment">// å³é”®</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç„å‡†&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºè‡ªå®šä¹‰è¾“å…¥ç®¡ç†å™¨</span></span><br><span class="line"><span class="keyword">const</span> customInput = <span class="keyword">new</span> <span class="title class_">CustomInputManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»‘å®šå¿«æ·é”®</span></span><br><span class="line"><span class="keyword">const</span> saveShortcut = customInput.<span class="title function_">bindShortcut</span>(</span><br><span class="line">  [<span class="string">&#x27;ControlLeft&#x27;</span>, <span class="string">&#x27;KeyS&#x27;</span>],</span><br><span class="line">  <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ä¿å­˜æ¸¸æˆ&#x27;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&#x27;ä¿å­˜æ¸¸æˆ (Ctrl+S)&#x27;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥è¾“å…¥çŠ¶æ€</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ˜¯å¦æŒ‰ä¸‹Wé”®:&#x27;</span>, customInput.<span class="title function_">isKeyPressed</span>(<span class="string">&#x27;KeyW&#x27;</span>))</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;é¼ æ ‡ä½ç½®:&#x27;</span>, customInput.<span class="title function_">getMousePosition</span>())</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§¦æ‘¸æ‰‹åŠ¿æ”¯æŒ</span></span><br><span class="line">customInput.<span class="title function_">setupTouchGestures</span>()</span><br><span class="line">customInput.<span class="property">onTap</span> = <span class="function">(<span class="params">touch</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç‚¹å‡»ä½ç½®:&#x27;</span>, touch.<span class="property">clientX</span>, touch.<span class="property">clientY</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ ActionManageråŠ¨ä½œ</span></span><br><span class="line">customInput.<span class="title function_">addKeyAction</span>(<span class="string">&#x27;KeyE&#x27;</span>, <span class="title class_">ActionManager</span>.<span class="property">OnKeyDownTrigger</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;äº’åŠ¨&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="ğŸ”§-Asset-èµ„æºç®¡ç†è¯¦è§£"><a href="#ğŸ”§-Asset-èµ„æºç®¡ç†è¯¦è§£" class="headerlink" title="ğŸ”§ Asset èµ„æºç®¡ç†è¯¦è§£"></a>ğŸ”§ Asset èµ„æºç®¡ç†è¯¦è§£</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Asset èµ„æºç®¡ç†å®Œæ•´ç®¡ç†</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AssetManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span> = scene.<span class="title function_">getEngine</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// èµ„æºå®¹å™¨</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">assetContainers</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">textures</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">models</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sounds</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŠ è½½çŠ¶æ€</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loadingTasks</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loadedAssets</span> = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">failedAssets</span> = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é…ç½®</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">baseUrl</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">enableCaching</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maxConcurrentLoads</span> = <span class="number">6</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">retryAttempts</span> = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupDefaultConfiguration</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupDefaultConfiguration</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®SceneLoaderæ’ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">enableLoaderPlugins</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é…ç½®ç¼“å­˜ç­–ç•¥</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupCaching</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">enableLoaderPlugins</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ç¡®ä¿å¿…è¦çš„loaderæ’ä»¶å¯ç”¨</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="title class_">GLTFFileLoader</span> !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable constant_">BABYLON</span>.<span class="property">SceneLoader</span>.<span class="title class_">RegisterPlugin</span>(<span class="keyword">new</span> <span class="title class_">GLTFFileLoader</span>())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="title class_">OBJFileLoader</span> !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable constant_">BABYLON</span>.<span class="property">SceneLoader</span>.<span class="title class_">RegisterPlugin</span>(<span class="keyword">new</span> <span class="title class_">OBJFileLoader</span>())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;èµ„æºåŠ è½½å™¨æ’ä»¶å·²å¯ç”¨&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupCaching</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">enableCaching</span>) &#123;</span><br><span class="line">      <span class="comment">// è®¾ç½®çº¹ç†ç¼“å­˜</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">enableOfflineSupport</span> = <span class="literal">false</span> <span class="comment">// æ ¹æ®éœ€è¦è°ƒæ•´</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;èµ„æºç¼“å­˜å·²å¯ç”¨&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŠ è½½3Dæ¨¡å‹</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadModel</span>(<span class="params">name, url, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> fullUrl = <span class="variable language_">this</span>.<span class="property">baseUrl</span> + url</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`å¼€å§‹åŠ è½½æ¨¡å‹: <span class="subst">$&#123;name&#125;</span> from <span class="subst">$&#123;fullUrl&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title class_">SceneLoader</span>.<span class="title class_">ImportMeshAsync</span>(</span><br><span class="line">        options.<span class="property">meshNames</span> || <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        fullUrl,</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">        options.<span class="property">onProgress</span>,</span><br><span class="line">        options.<span class="property">pluginExtension</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="comment">// åˆ›å»ºèµ„æºå®¹å™¨</span></span><br><span class="line">      <span class="keyword">const</span> container = <span class="keyword">new</span> <span class="title class_">AssetContainer</span>(<span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ·»åŠ åŠ è½½çš„èµ„æºåˆ°å®¹å™¨</span></span><br><span class="line">      result.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">        container.<span class="property">meshes</span>.<span class="title function_">push</span>(mesh)</span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">position</span>) mesh.<span class="property">position</span> = options.<span class="property">position</span></span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">rotation</span>) mesh.<span class="property">rotation</span> = options.<span class="property">rotation</span></span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">scaling</span>) mesh.<span class="property">scaling</span> = options.<span class="property">scaling</span></span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      result.<span class="property">materials</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">material</span>) =&gt;</span> &#123;</span><br><span class="line">        container.<span class="property">materials</span>.<span class="title function_">push</span>(material)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      result.<span class="property">textures</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">texture</span>) =&gt;</span> &#123;</span><br><span class="line">        container.<span class="property">textures</span>.<span class="title function_">push</span>(texture)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      result.<span class="property">animationGroups</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">animGroup</span>) =&gt;</span> &#123;</span><br><span class="line">        container.<span class="property">animationGroups</span>.<span class="title function_">push</span>(animGroup)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å­˜å‚¨èµ„æº</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">assetContainers</span>.<span class="title function_">set</span>(name, container)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">models</span>.<span class="title function_">set</span>(name, &#123;</span><br><span class="line">        <span class="attr">container</span>: container,</span><br><span class="line">        <span class="attr">meshes</span>: result.<span class="property">meshes</span>,</span><br><span class="line">        <span class="attr">materials</span>: result.<span class="property">materials</span>,</span><br><span class="line">        <span class="attr">textures</span>: result.<span class="property">textures</span>,</span><br><span class="line">        <span class="attr">animationGroups</span>: result.<span class="property">animationGroups</span>,</span><br><span class="line">        <span class="attr">skeletons</span>: result.<span class="property">skeletons</span>,</span><br><span class="line">        <span class="attr">url</span>: fullUrl,</span><br><span class="line">        <span class="attr">loadTime</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">loadedAssets</span>.<span class="title function_">add</span>(name)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`æ¨¡å‹åŠ è½½å®Œæˆ: <span class="subst">$&#123;name&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> result</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`æ¨¡å‹åŠ è½½å¤±è´¥: <span class="subst">$&#123;name&#125;</span>`</span>, error)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">failedAssets</span>.<span class="title function_">add</span>(name)</span><br><span class="line">      <span class="keyword">throw</span> error</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŠ è½½çº¹ç†</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadTexture</span>(<span class="params">name, url, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> fullUrl = <span class="variable language_">this</span>.<span class="property">baseUrl</span> + url</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`å¼€å§‹åŠ è½½çº¹ç†: <span class="subst">$&#123;name&#125;</span> from <span class="subst">$&#123;fullUrl&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> texture = <span class="keyword">new</span> <span class="title class_">Texture</span>(</span><br><span class="line">        fullUrl,</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">        options.<span class="property">noMipmap</span>,</span><br><span class="line">        options.<span class="property">invertY</span>,</span><br><span class="line">        options.<span class="property">samplingMode</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ç­‰å¾…çº¹ç†åŠ è½½å®Œæˆ</span></span><br><span class="line">      <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        texture.<span class="property">onLoadObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> <span class="title function_">resolve</span>(texture))</span><br><span class="line">        texture.<span class="property">onErrorObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> <span class="title function_">reject</span>(error))</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// åº”ç”¨çº¹ç†è®¾ç½®</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">wrapU</span> !== <span class="literal">undefined</span>) texture.<span class="property">wrapU</span> = options.<span class="property">wrapU</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">wrapV</span> !== <span class="literal">undefined</span>) texture.<span class="property">wrapV</span> = options.<span class="property">wrapV</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">uOffset</span> !== <span class="literal">undefined</span>) texture.<span class="property">uOffset</span> = options.<span class="property">uOffset</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">vOffset</span> !== <span class="literal">undefined</span>) texture.<span class="property">vOffset</span> = options.<span class="property">vOffset</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">uScale</span> !== <span class="literal">undefined</span>) texture.<span class="property">uScale</span> = options.<span class="property">uScale</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">vScale</span> !== <span class="literal">undefined</span>) texture.<span class="property">vScale</span> = options.<span class="property">vScale</span></span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">set</span>(name, &#123;</span><br><span class="line">        <span class="attr">texture</span>: texture,</span><br><span class="line">        <span class="attr">url</span>: fullUrl,</span><br><span class="line">        <span class="attr">options</span>: options,</span><br><span class="line">        <span class="attr">loadTime</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">loadedAssets</span>.<span class="title function_">add</span>(name)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`çº¹ç†åŠ è½½å®Œæˆ: <span class="subst">$&#123;name&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> texture</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`çº¹ç†åŠ è½½å¤±è´¥: <span class="subst">$&#123;name&#125;</span>`</span>, error)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">failedAssets</span>.<span class="title function_">add</span>(name)</span><br><span class="line">      <span class="keyword">throw</span> error</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŠ è½½ç«‹æ–¹ä½“çº¹ç†</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadCubeTexture</span>(<span class="params">name, url, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> fullUrl = <span class="variable language_">this</span>.<span class="property">baseUrl</span> + url</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`å¼€å§‹åŠ è½½ç«‹æ–¹ä½“çº¹ç†: <span class="subst">$&#123;name&#125;</span> from <span class="subst">$&#123;fullUrl&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> cubeTexture = <span class="keyword">new</span> <span class="title class_">CubeTexture</span>(fullUrl, <span class="variable language_">this</span>.<span class="property">scene</span>, options.<span class="property">extensions</span>, options.<span class="property">noMipmap</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ç­‰å¾…åŠ è½½å®Œæˆ</span></span><br><span class="line">      <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        cubeTexture.<span class="property">onLoadObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> <span class="title function_">resolve</span>(cubeTexture))</span><br><span class="line">        cubeTexture.<span class="property">onErrorObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> <span class="title function_">reject</span>(error))</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">set</span>(name, &#123;</span><br><span class="line">        <span class="attr">texture</span>: cubeTexture,</span><br><span class="line">        <span class="attr">url</span>: fullUrl,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;cube&#x27;</span>,</span><br><span class="line">        <span class="attr">loadTime</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">loadedAssets</span>.<span class="title function_">add</span>(name)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ç«‹æ–¹ä½“çº¹ç†åŠ è½½å®Œæˆ: <span class="subst">$&#123;name&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> cubeTexture</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`ç«‹æ–¹ä½“çº¹ç†åŠ è½½å¤±è´¥: <span class="subst">$&#123;name&#125;</span>`</span>, error)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">failedAssets</span>.<span class="title function_">add</span>(name)</span><br><span class="line">      <span class="keyword">throw</span> error</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŠ è½½HDRç¯å¢ƒçº¹ç†</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadHDRTexture</span>(<span class="params">name, url, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> fullUrl = <span class="variable language_">this</span>.<span class="property">baseUrl</span> + url</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`å¼€å§‹åŠ è½½HDRçº¹ç†: <span class="subst">$&#123;name&#125;</span> from <span class="subst">$&#123;fullUrl&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> hdrTexture = <span class="keyword">new</span> <span class="title class_">HDRCubeTexture</span>(</span><br><span class="line">        fullUrl,</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">        options.<span class="property">size</span>,</span><br><span class="line">        options.<span class="property">noMipmap</span>,</span><br><span class="line">        options.<span class="property">generateHarmonics</span>,</span><br><span class="line">        options.<span class="property">useInGammaSpace</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ç­‰å¾…åŠ è½½å®Œæˆ</span></span><br><span class="line">      <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        hdrTexture.<span class="property">onLoadObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> <span class="title function_">resolve</span>(hdrTexture))</span><br><span class="line">        hdrTexture.<span class="property">onErrorObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> <span class="title function_">reject</span>(error))</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">set</span>(name, &#123;</span><br><span class="line">        <span class="attr">texture</span>: hdrTexture,</span><br><span class="line">        <span class="attr">url</span>: fullUrl,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;hdr&#x27;</span>,</span><br><span class="line">        <span class="attr">loadTime</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">loadedAssets</span>.<span class="title function_">add</span>(name)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`HDRçº¹ç†åŠ è½½å®Œæˆ: <span class="subst">$&#123;name&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> hdrTexture</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`HDRçº¹ç†åŠ è½½å¤±è´¥: <span class="subst">$&#123;name&#125;</span>`</span>, error)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">failedAssets</span>.<span class="title function_">add</span>(name)</span><br><span class="line">      <span class="keyword">throw</span> error</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ‰¹é‡åŠ è½½èµ„æº</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadAssets</span>(<span class="params">assetList, onProgress = <span class="literal">null</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> tasks = []</span><br><span class="line">    <span class="keyword">const</span> results = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> asset <span class="keyword">of</span> assetList) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; type, name, url, options = &#123;&#125; &#125; = asset</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> loadTask</span><br><span class="line">      <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;model&#x27;</span>:</span><br><span class="line">          loadTask = <span class="variable language_">this</span>.<span class="title function_">loadModel</span>(name, url, options)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;texture&#x27;</span>:</span><br><span class="line">          loadTask = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(name, url, options)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;cubeTexture&#x27;</span>:</span><br><span class="line">          loadTask = <span class="variable language_">this</span>.<span class="title function_">loadCubeTexture</span>(name, url, options)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;hdrTexture&#x27;</span>:</span><br><span class="line">          loadTask = <span class="variable language_">this</span>.<span class="title function_">loadHDRTexture</span>(name, url, options)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;sound&#x27;</span>:</span><br><span class="line">          loadTask = <span class="variable language_">this</span>.<span class="title function_">loadSound</span>(name, url, options)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`æœªçŸ¥çš„èµ„æºç±»å‹: <span class="subst">$&#123;type&#125;</span>`</span>)</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      tasks.<span class="title function_">push</span>(</span><br><span class="line">        loadTask</span><br><span class="line">          .<span class="title function_">then</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">            results.<span class="title function_">push</span>(&#123; name, type, <span class="attr">success</span>: <span class="literal">true</span>, result &#125;)</span><br><span class="line">            <span class="keyword">if</span> (onProgress) &#123;</span><br><span class="line">              <span class="title function_">onProgress</span>(results.<span class="property">length</span>, assetList.<span class="property">length</span>, name, type)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">          &#125;)</span><br><span class="line">          .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">            results.<span class="title function_">push</span>(&#123; name, type, <span class="attr">success</span>: <span class="literal">false</span>, error &#125;)</span><br><span class="line">            <span class="keyword">if</span> (onProgress) &#123;</span><br><span class="line">              <span class="title function_">onProgress</span>(results.<span class="property">length</span>, assetList.<span class="property">length</span>, name, type)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">          &#125;),</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(tasks)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> successful = results.<span class="title function_">filter</span>(<span class="function">(<span class="params">r</span>) =&gt;</span> r.<span class="property">success</span>).<span class="property">length</span></span><br><span class="line">    <span class="keyword">const</span> failed = results.<span class="title function_">filter</span>(<span class="function">(<span class="params">r</span>) =&gt;</span> !r.<span class="property">success</span>).<span class="property">length</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`æ‰¹é‡åŠ è½½å®Œæˆ: æˆåŠŸ <span class="subst">$&#123;successful&#125;</span>, å¤±è´¥ <span class="subst">$&#123;failed&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      results,</span><br><span class="line">      successful,</span><br><span class="line">      failed,</span><br><span class="line">      <span class="attr">successRate</span>: successful / assetList.<span class="property">length</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å…‹éš†æ¨¡å‹å®ä¾‹</span></span><br><span class="line">  <span class="title function_">cloneModel</span>(<span class="params">originalName, newName, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> modelData = <span class="variable language_">this</span>.<span class="property">models</span>.<span class="title function_">get</span>(originalName)</span><br><span class="line">    <span class="keyword">if</span> (!modelData) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`åŸå§‹æ¨¡å‹æœªæ‰¾åˆ°: <span class="subst">$&#123;originalName&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> clonedMeshes = []</span><br><span class="line"></span><br><span class="line">    modelData.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> clonedMesh = mesh.<span class="title function_">clone</span>(newName + <span class="string">&#x27;_&#x27;</span> + mesh.<span class="property">name</span>, options.<span class="property">parent</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">position</span>) clonedMesh.<span class="property">position</span> = options.<span class="property">position</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">rotation</span>) clonedMesh.<span class="property">rotation</span> = options.<span class="property">rotation</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">scaling</span>) clonedMesh.<span class="property">scaling</span> = options.<span class="property">scaling</span></span><br><span class="line"></span><br><span class="line">      clonedMeshes.<span class="title function_">push</span>(clonedMesh)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºæ–°çš„æ¨¡å‹è®°å½•</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">models</span>.<span class="title function_">set</span>(newName, &#123;</span><br><span class="line">      ...modelData,</span><br><span class="line">      <span class="attr">meshes</span>: clonedMeshes,</span><br><span class="line">      <span class="attr">isClone</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">originalModel</span>: originalName,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`æ¨¡å‹å…‹éš†å®Œæˆ: <span class="subst">$&#123;originalName&#125;</span> -&gt; <span class="subst">$&#123;newName&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">return</span> clonedMeshes</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å®ä¾‹åŒ–æ¨¡å‹</span></span><br><span class="line">  <span class="title function_">instanceModel</span>(<span class="params">originalName, newName, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> modelData = <span class="variable language_">this</span>.<span class="property">models</span>.<span class="title function_">get</span>(originalName)</span><br><span class="line">    <span class="keyword">if</span> (!modelData) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`åŸå§‹æ¨¡å‹æœªæ‰¾åˆ°: <span class="subst">$&#123;originalName&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> instances = []</span><br><span class="line"></span><br><span class="line">    modelData.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (mesh.<span class="property">geometry</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> instance = mesh.<span class="title function_">createInstance</span>(newName + <span class="string">&#x27;_&#x27;</span> + mesh.<span class="property">name</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">position</span>) instance.<span class="property">position</span> = options.<span class="property">position</span></span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">rotation</span>) instance.<span class="property">rotation</span> = options.<span class="property">rotation</span></span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">scaling</span>) instance.<span class="property">scaling</span> = options.<span class="property">scaling</span></span><br><span class="line"></span><br><span class="line">        instances.<span class="title function_">push</span>(instance)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`æ¨¡å‹å®ä¾‹åŒ–å®Œæˆ: <span class="subst">$&#123;originalName&#125;</span> -&gt; <span class="subst">$&#123;newName&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">return</span> instances</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ·»åŠ è‡ªå®šä¹‰èµ„æº</span></span><br><span class="line">  <span class="title function_">addCustomAssets</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// æ·»åŠ æ¨¡å‹èµ„æº</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">addModelAsset</span>(<span class="string">&#x27;/models/customModel.glb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ çº¹ç†èµ„æº</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">addTextureAsset</span>(<span class="string">&#x27;/textures/customTexture.jpg&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ éŸ³é¢‘èµ„æº</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">addAudioAsset</span>(<span class="string">&#x27;/sounds/customSound.mp3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ ç¯å¢ƒèµ„æº</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">addEnvironmentAsset</span>(<span class="string">&#x27;/environments/customEnvironment.dds&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ·»åŠ æ¨¡å‹èµ„æº</span></span><br><span class="line">  <span class="title function_">addModelAsset</span>(<span class="params">url</span>) &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºæ¨¡å‹èµ„æº</span></span><br><span class="line">    <span class="keyword">const</span> modelAsset = <span class="keyword">new</span> <span class="title class_">AssetContainer</span>(url, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    modelAsset.<span class="property">name</span> = url.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>).<span class="title function_">pop</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">assets</span>.<span class="title function_">set</span>(url, modelAsset)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ·»åŠ çº¹ç†èµ„æº</span></span><br><span class="line">  <span class="title function_">addTextureAsset</span>(<span class="params">url</span>) &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºçº¹ç†èµ„æº</span></span><br><span class="line">    <span class="keyword">const</span> textureAsset = <span class="keyword">new</span> <span class="title class_">Texture</span>(url, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    textureAsset.<span class="property">name</span> = url.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>).<span class="title function_">pop</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">assets</span>.<span class="title function_">set</span>(url, textureAsset)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ·»åŠ éŸ³é¢‘èµ„æº</span></span><br><span class="line">  <span class="title function_">addAudioAsset</span>(<span class="params">url</span>) &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºéŸ³é¢‘èµ„æº</span></span><br><span class="line">    <span class="keyword">const</span> audioAsset = <span class="keyword">new</span> <span class="title class_">Audio</span>(url, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    audioAsset.<span class="property">name</span> = url.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>).<span class="title function_">pop</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">assets</span>.<span class="title function_">set</span>(url, audioAsset)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ·»åŠ ç¯å¢ƒèµ„æº</span></span><br><span class="line">  <span class="title function_">addEnvironmentAsset</span>(<span class="params">url</span>) &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºç¯å¢ƒèµ„æº</span></span><br><span class="line">    <span class="keyword">const</span> environmentAsset = <span class="keyword">new</span> <span class="title class_">CubeTexture</span>(url, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    environmentAsset.<span class="property">name</span> = url.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>).<span class="title function_">pop</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">assets</span>.<span class="title function_">set</span>(url, environmentAsset)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–èµ„æºä¿¡æ¯</span></span><br><span class="line">  <span class="title function_">getAssetInfo</span>(<span class="params">assetName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> asset = <span class="variable language_">this</span>.<span class="property">assets</span>.<span class="title function_">get</span>(assetName)</span><br><span class="line">    <span class="keyword">if</span> (!asset) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> info = &#123;</span><br><span class="line">      <span class="attr">name</span>: assetName,</span><br><span class="line">      <span class="attr">type</span>: asset.<span class="title function_">getClassName</span>(),</span><br><span class="line">      <span class="attr">url</span>: asset.<span class="property">url</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ‰¹é‡åº”ç”¨èµ„æº</span></span><br><span class="line">  <span class="title function_">applyAssets</span>(<span class="params">assets</span>) &#123;</span><br><span class="line">    assets.<span class="title function_">forEach</span>(<span class="function">(<span class="params">asset, name</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">applyAsset</span>(name, asset)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åº”ç”¨èµ„æº</span></span><br><span class="line">  <span class="title function_">applyAsset</span>(<span class="params">assetName, asset</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> currentAsset = <span class="variable language_">this</span>.<span class="property">assets</span>.<span class="title function_">get</span>(assetName)</span><br><span class="line">    <span class="keyword">if</span> (!currentAsset) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    currentAsset.<span class="property">url</span> = asset.<span class="property">url</span></span><br><span class="line">    currentAsset.<span class="property">name</span> = asset.<span class="property">name</span></span><br><span class="line">    currentAsset.<span class="property">type</span> = asset.<span class="property">type</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// èµ„æºæ¸…ç†</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">assets</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">asset</span>) =&gt;</span> &#123;</span><br><span class="line">      asset.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">assets</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> assetManager = <span class="keyword">new</span> <span class="title class_">AssetManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ é»˜è®¤èµ„æº</span></span><br><span class="line">assetManager.<span class="title function_">addDefaultAssets</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ è‡ªå®šä¹‰èµ„æº</span></span><br><span class="line">assetManager.<span class="title function_">addCustomAssets</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–èµ„æºä¿¡æ¯</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;èµ„æºä¿¡æ¯:&#x27;</span>, assetManager.<span class="title function_">getAssetInfo</span>(<span class="string">&#x27;/models/defaultModel.glb&#x27;</span>))</span><br></pre></td></tr></table></figure><h2 id="âš¡-Performance-æ€§èƒ½ä¼˜åŒ–è¯¦è§£"><a href="#âš¡-Performance-æ€§èƒ½ä¼˜åŒ–è¯¦è§£" class="headerlink" title="âš¡ Performance æ€§èƒ½ä¼˜åŒ–è¯¦è§£"></a>âš¡ Performance æ€§èƒ½ä¼˜åŒ–è¯¦è§£</h2><h3 id="ğŸ¯-æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒåŸåˆ™"><a href="#ğŸ¯-æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒåŸåˆ™" class="headerlink" title="ğŸ¯ æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒåŸåˆ™"></a>ğŸ¯ æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒåŸåˆ™</h3><ol><li><strong>å‡å°‘Draw Calls</strong> - åˆå¹¶ç½‘æ ¼ï¼Œä½¿ç”¨å®ä¾‹åŒ–</li><li><strong>ä¼˜åŒ–çº¹ç†</strong> - å‹ç¼©çº¹ç†ï¼Œå‡å°‘å°ºå¯¸</li><li><strong>ç®€åŒ–å‡ ä½•ä½“</strong> - LODç³»ç»Ÿï¼Œé¢æ•°ä¼˜åŒ–</li><li><strong>æ™ºèƒ½å‰”é™¤</strong> - è§†é”¥å‰”é™¤ï¼Œé®æŒ¡å‰”é™¤</li><li><strong>å†…å­˜ç®¡ç†</strong> - åŠæ—¶é‡Šæ”¾èµ„æºï¼Œå¯¹è±¡æ± </li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ€§èƒ½ä¼˜åŒ–ç®¡ç†å™¨</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PerformanceOptimizer</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span> = scene.<span class="title function_">getEngine</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ€§èƒ½ç›‘æ§</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">performanceMonitor</span> = <span class="keyword">new</span> <span class="title class_">PerformanceMonitor</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fpsCounter</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">frameTime</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lastFrameTime</span> = performance.<span class="title function_">now</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¼˜åŒ–é…ç½®</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">config</span> = &#123;</span><br><span class="line">      <span class="attr">enableOptimizations</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">targetFPS</span>: <span class="number">60</span>,</span><br><span class="line">      <span class="attr">adaptiveQuality</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">enableLOD</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">enableFrustumCulling</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">maxLights</span>: <span class="number">8</span>,</span><br><span class="line">      <span class="attr">shadowMapSize</span>: <span class="number">1024</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">initializeOptimizations</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">initializeOptimizations</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupEngineOptimizations</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupSceneOptimizations</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupRenderingOptimizations</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">startPerformanceMonitoring</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== å¼•æ“çº§ä¼˜åŒ– =====</span></span><br><span class="line">  <span class="title function_">setupEngineOptimizations</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> engine = <span class="variable language_">this</span>.<span class="property">engine</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¦ç”¨ä¸å¿…è¦çš„åŠŸèƒ½</span></span><br><span class="line">    engine.<span class="property">enableOfflineSupport</span> = <span class="literal">false</span></span><br><span class="line">    engine.<span class="property">doNotHandleContextLost</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¼˜åŒ–WebGLçŠ¶æ€</span></span><br><span class="line">    engine.<span class="title function_">setDepthFunction</span>(<span class="title class_">Engine</span>.<span class="property">LEQUAL</span>)</span><br><span class="line">    engine.<span class="title function_">setStencilBuffer</span>(<span class="literal">false</span>) <span class="comment">// å¦‚æœä¸éœ€è¦æ¨¡æ¿ç¼“å†²</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è‡ªé€‚åº”è®¾å¤‡åƒç´ æ¯”</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">adaptiveQuality</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setupAdaptiveQuality</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å¼•æ“ä¼˜åŒ–è®¾ç½®å®Œæˆ&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupAdaptiveQuality</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> engine = <span class="variable language_">this</span>.<span class="property">engine</span></span><br><span class="line">    <span class="keyword">let</span> basePixelRatio = <span class="variable language_">window</span>.<span class="property">devicePixelRatio</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®æ€§èƒ½åŠ¨æ€è°ƒæ•´åƒç´ æ¯”</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">registerBeforeRender</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">fpsCounter</span> &lt; <span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">targetFPS</span> * <span class="number">0.8</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> newRatio = <span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="number">0.5</span>, basePixelRatio * <span class="number">0.9</span>)</span><br><span class="line">        engine.<span class="title function_">setHardwareScalingLevel</span>(<span class="number">1</span> / newRatio)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">fpsCounter</span> &gt; <span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">targetFPS</span> * <span class="number">0.95</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> newRatio = <span class="title class_">Math</span>.<span class="title function_">min</span>(basePixelRatio, basePixelRatio * <span class="number">1.1</span>)</span><br><span class="line">        engine.<span class="title function_">setHardwareScalingLevel</span>(<span class="number">1</span> / newRatio)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== åœºæ™¯çº§ä¼˜åŒ– =====</span></span><br><span class="line">  <span class="title function_">setupSceneOptimizations</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> scene = <span class="variable language_">this</span>.<span class="property">scene</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯ç”¨è§†é”¥å‰”é™¤</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">enableFrustumCulling</span>) &#123;</span><br><span class="line">      scene.<span class="property">skipFrustumClipping</span> = <span class="literal">false</span></span><br><span class="line">      scene.<span class="property">autoClear</span> = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¼˜åŒ–å…‰ç…§</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">optimizeLighting</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¼˜åŒ–é˜´å½±</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">optimizeShadows</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯ç”¨å®ä¾‹åŒ–</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">enableInstancing</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;åœºæ™¯ä¼˜åŒ–è®¾ç½®å®Œæˆ&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">optimizeLighting</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> scene = <span class="variable language_">this</span>.<span class="property">scene</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é™åˆ¶å…‰æºæ•°é‡</span></span><br><span class="line">    <span class="keyword">let</span> lightCount = <span class="number">0</span></span><br><span class="line">    scene.<span class="property">lights</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">light</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (lightCount &gt;= <span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">maxLights</span>) &#123;</span><br><span class="line">        light.<span class="title function_">setEnabled</span>(<span class="literal">false</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        lightCount++</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¦ç”¨ä¸éœ€è¦çš„å…‰ç…§è®¡ç®—</span></span><br><span class="line">    scene.<span class="property">lightsEnabled</span> = lightCount &gt; <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">optimizeShadows</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> scene = <span class="variable language_">this</span>.<span class="property">scene</span></span><br><span class="line"></span><br><span class="line">    scene.<span class="property">lights</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">light</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (light.<span class="title function_">getShadowGenerator</span>()) &#123;</span><br><span class="line">        <span class="keyword">const</span> shadowGen = light.<span class="title function_">getShadowGenerator</span>()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¼˜åŒ–é˜´å½±è´´å›¾å°ºå¯¸</span></span><br><span class="line">        shadowGen.<span class="property">mapSize</span> = <span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">shadowMapSize</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯ç”¨é˜´å½±ä¼˜åŒ–</span></span><br><span class="line">        shadowGen.<span class="property">usePercentageCloserFiltering</span> = <span class="literal">false</span></span><br><span class="line">        shadowGen.<span class="property">useKernelBlur</span> = <span class="literal">false</span></span><br><span class="line">        shadowGen.<span class="property">blurKernel</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®åˆç†çš„é˜´å½±è·ç¦»</span></span><br><span class="line">        shadowGen.<span class="title function_">setDarkness</span>(<span class="number">0.3</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">enableInstancing</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ä¸ºç›¸ä¼¼ç½‘æ ¼å¯ç”¨å®ä¾‹åŒ–</span></span><br><span class="line">    <span class="keyword">const</span> meshGroups = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (mesh.<span class="property">geometry</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> key = mesh.<span class="property">geometry</span>.<span class="property">id</span> + <span class="string">&#x27;_&#x27;</span> + (mesh.<span class="property">material</span> ? mesh.<span class="property">material</span>.<span class="property">id</span> : <span class="string">&#x27;none&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!meshGroups.<span class="title function_">has</span>(key)) &#123;</span><br><span class="line">          meshGroups.<span class="title function_">set</span>(key, [])</span><br><span class="line">        &#125;</span><br><span class="line">        meshGroups.<span class="title function_">get</span>(key).<span class="title function_">push</span>(mesh)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯¹äºç›¸åŒå‡ ä½•ä½“å’Œæè´¨çš„ç½‘æ ¼ï¼Œä½¿ç”¨å®ä¾‹åŒ–</span></span><br><span class="line">    meshGroups.<span class="title function_">forEach</span>(<span class="function">(<span class="params">meshes, key</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (meshes.<span class="property">length</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`å‘ç° <span class="subst">$&#123;meshes.length&#125;</span> ä¸ªç›¸ä¼¼ç½‘æ ¼ï¼Œå»ºè®®ä½¿ç”¨å®ä¾‹åŒ–`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== æ¸²æŸ“ä¼˜åŒ– =====</span></span><br><span class="line">  <span class="title function_">setupRenderingOptimizations</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> scene = <span class="variable language_">this</span>.<span class="property">scene</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¼˜åŒ–æè´¨</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">optimizeMaterials</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¼˜åŒ–çº¹ç†</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">optimizeTextures</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯ç”¨å‡ ä½•ä½“ä¼˜åŒ–</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">optimizeGeometry</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ¸²æŸ“ä¼˜åŒ–è®¾ç½®å®Œæˆ&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">optimizeMaterials</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">materials</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">material</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (material <span class="keyword">instanceof</span> <span class="title class_">StandardMaterial</span>) &#123;</span><br><span class="line">        <span class="comment">// ç¦ç”¨ä¸å¿…è¦çš„æè´¨ç‰¹æ€§</span></span><br><span class="line">        <span class="keyword">if</span> (!material.<span class="property">diffuseTexture</span>) material.<span class="property">disableLighting</span> = <span class="literal">false</span></span><br><span class="line">        material.<span class="property">maxSimultaneousLights</span> = <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="number">4</span>, <span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">maxLights</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¼˜åŒ–åå°„</span></span><br><span class="line">        <span class="keyword">if</span> (material.<span class="property">reflectionTexture</span>) &#123;</span><br><span class="line">          material.<span class="property">reflectionTexture</span>.<span class="property">level</span> = <span class="number">0.5</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (material <span class="keyword">instanceof</span> <span class="title class_">PBRMaterial</span>) &#123;</span><br><span class="line">        <span class="comment">// PBRæè´¨ä¼˜åŒ–</span></span><br><span class="line">        material.<span class="property">maxSimultaneousLights</span> = <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="number">4</span>, <span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">maxLights</span>)</span><br><span class="line">        material.<span class="property">useRadianceOcclusion</span> = <span class="literal">false</span></span><br><span class="line">        material.<span class="property">useHorizonOcclusion</span> = <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">optimizeTextures</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">textures</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">texture</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (texture <span class="keyword">instanceof</span> <span class="title class_">Texture</span>) &#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®åˆç†çš„è¿‡æ»¤æ¨¡å¼</span></span><br><span class="line">        texture.<span class="property">samplingMode</span> = <span class="title class_">Texture</span>.<span class="property">TRILINEAR_SAMPLINGMODE</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯ç”¨çº¹ç†å‹ç¼©ï¼ˆå¦‚æœæ”¯æŒï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">getCaps</span>().<span class="property">s3tc</span>) &#123;</span><br><span class="line">          <span class="comment">// å¯ä»¥ä½¿ç”¨DDSå‹ç¼©çº¹ç†</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é™åˆ¶çº¹ç†å°ºå¯¸</span></span><br><span class="line">        <span class="keyword">const</span> maxSize = <span class="number">1024</span></span><br><span class="line">        <span class="keyword">if</span> (texture.<span class="title function_">getSize</span>().<span class="property">width</span> &gt; maxSize || texture.<span class="title function_">getSize</span>().<span class="property">height</span> &gt; maxSize) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`çº¹ç† <span class="subst">$&#123;texture.name&#125;</span> å°ºå¯¸è¿‡å¤§ï¼Œå»ºè®®å‹ç¼©`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">optimizeGeometry</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (mesh.<span class="property">geometry</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> vertexCount = mesh.<span class="title function_">getTotalVertices</span>()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯¹äºé«˜é¢æ•°æ¨¡å‹å»ºè®®LOD</span></span><br><span class="line">        <span class="keyword">if</span> (vertexCount &gt; <span class="number">10000</span>) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`ç½‘æ ¼ <span class="subst">$&#123;mesh.name&#125;</span> é¡¶ç‚¹æ•°è¿‡å¤š (<span class="subst">$&#123;vertexCount&#125;</span>)ï¼Œå»ºè®®ä½¿ç”¨LOD`</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆå¹¶é¡¶ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (mesh.<span class="title function_">isVerticesDataPresent</span>(<span class="title class_">VertexBuffer</span>.<span class="property">PositionKind</span>)) &#123;</span><br><span class="line">          <span class="comment">// mesh.mergeVertices() // è°¨æ…ä½¿ç”¨ï¼Œå¯èƒ½å½±å“UV</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== LODç³»ç»Ÿ =====</span></span><br><span class="line">  <span class="title function_">setupLODSystem</span>(<span class="params">meshes, distances = [<span class="number">10</span>, <span class="number">50</span>, <span class="number">100</span>]</span>) &#123;</span><br><span class="line">    meshes.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (mesh.<span class="property">geometry</span>) &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºLODçº§åˆ«</span></span><br><span class="line">        <span class="keyword">const</span> lod1 = mesh.<span class="title function_">simplify</span>(</span><br><span class="line">          [</span><br><span class="line">            &#123; <span class="attr">quality</span>: <span class="number">0.8</span>, <span class="attr">distance</span>: distances[<span class="number">0</span>] &#125;,</span><br><span class="line">            &#123; <span class="attr">quality</span>: <span class="number">0.5</span>, <span class="attr">distance</span>: distances[<span class="number">1</span>] &#125;,</span><br><span class="line">            &#123; <span class="attr">quality</span>: <span class="number">0.2</span>, <span class="attr">distance</span>: distances[<span class="number">2</span>] &#125;,</span><br><span class="line">          ],</span><br><span class="line">          <span class="literal">false</span>,</span><br><span class="line">          <span class="title class_">SimplificationType</span>.<span class="property">QUADRATIC</span>,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ä¸ºç½‘æ ¼ <span class="subst">$&#123;mesh.name&#125;</span> è®¾ç½®LODç³»ç»Ÿ`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== å¯¹è±¡æ±  =====</span></span><br><span class="line">  <span class="title function_">createObjectPool</span>(<span class="params">createFunc, resetFunc, initialSize = <span class="number">10</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> pool = []</span><br><span class="line">    <span class="keyword">const</span> inUse = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–å¯¹è±¡æ± </span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; initialSize; i++) &#123;</span><br><span class="line">      pool.<span class="title function_">push</span>(<span class="title function_">createFunc</span>())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="title function_">acquire</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> obj = pool.<span class="title function_">pop</span>()</span><br><span class="line">        <span class="keyword">if</span> (!obj) &#123;</span><br><span class="line">          obj = <span class="title function_">createFunc</span>()</span><br><span class="line">        &#125;</span><br><span class="line">        inUse.<span class="title function_">add</span>(obj)</span><br><span class="line">        <span class="keyword">return</span> obj</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="title function_">release</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (inUse.<span class="title function_">has</span>(obj)) &#123;</span><br><span class="line">          <span class="title function_">resetFunc</span>(obj)</span><br><span class="line">          inUse.<span class="title function_">delete</span>(obj)</span><br><span class="line">          pool.<span class="title function_">push</span>(obj)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="title function_">getStats</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          <span class="attr">poolSize</span>: pool.<span class="property">length</span>,</span><br><span class="line">          <span class="attr">inUse</span>: inUse.<span class="property">size</span>,</span><br><span class="line">          <span class="attr">total</span>: pool.<span class="property">length</span> + inUse.<span class="property">size</span>,</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== æ€§èƒ½ç›‘æ§ =====</span></span><br><span class="line">  <span class="title function_">startPerformanceMonitoring</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> scene = <span class="variable language_">this</span>.<span class="property">scene</span></span><br><span class="line"></span><br><span class="line">    scene.<span class="title function_">registerBeforeRender</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> currentTime = performance.<span class="title function_">now</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">frameTime</span> = currentTime - <span class="variable language_">this</span>.<span class="property">lastFrameTime</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">fpsCounter</span> = <span class="number">1000</span> / <span class="variable language_">this</span>.<span class="property">frameTime</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">lastFrameTime</span> = currentTime</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ›´æ–°æ€§èƒ½ç›‘æ§å™¨</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">performanceMonitor</span>.<span class="title function_">sampleFrame</span>(currentTime)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šæœŸè¾“å‡ºæ€§èƒ½æŠ¥å‘Š</span></span><br><span class="line">    <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">generatePerformanceReport</span>()</span><br><span class="line">    &#125;, <span class="number">5000</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">generatePerformanceReport</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> engine = <span class="variable language_">this</span>.<span class="property">engine</span></span><br><span class="line">    <span class="keyword">const</span> scene = <span class="variable language_">this</span>.<span class="property">scene</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> report = &#123;</span><br><span class="line">      <span class="attr">fps</span>: <span class="title class_">Math</span>.<span class="title function_">round</span>(<span class="variable language_">this</span>.<span class="property">fpsCounter</span>),</span><br><span class="line">      <span class="attr">frameTime</span>: <span class="title class_">Math</span>.<span class="title function_">round</span>(<span class="variable language_">this</span>.<span class="property">frameTime</span> * <span class="number">100</span>) / <span class="number">100</span>,</span><br><span class="line">      <span class="attr">drawCalls</span>: engine.<span class="title function_">getDrawCalls</span>(),</span><br><span class="line">      <span class="attr">meshes</span>: scene.<span class="property">meshes</span>.<span class="property">length</span>,</span><br><span class="line">      <span class="attr">materials</span>: scene.<span class="property">materials</span>.<span class="property">length</span>,</span><br><span class="line">      <span class="attr">textures</span>: scene.<span class="property">textures</span>.<span class="property">length</span>,</span><br><span class="line">      <span class="attr">lights</span>: scene.<span class="property">lights</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">l</span>) =&gt;</span> l.<span class="title function_">isEnabled</span>()).<span class="property">length</span>,</span><br><span class="line">      <span class="attr">memory</span>: &#123;</span><br><span class="line">        <span class="attr">geometries</span>: engine.<span class="title function_">getGeometriesStatistics</span>(),</span><br><span class="line">        <span class="attr">textures</span>: engine.<span class="title function_">getTexturesStatistics</span>(),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ€§èƒ½æŠ¥å‘Š:&#x27;</span>, report)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è‡ªåŠ¨ä¼˜åŒ–å»ºè®®</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">generateOptimizationSuggestions</span>(report)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> report</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">generateOptimizationSuggestions</span>(<span class="params">report</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> suggestions = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (report.<span class="property">fps</span> &lt; <span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">targetFPS</span> * <span class="number">0.8</span>) &#123;</span><br><span class="line">      suggestions.<span class="title function_">push</span>(<span class="string">&#x27;FPSè¿‡ä½ï¼Œå»ºè®®ï¼š&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (report.<span class="property">drawCalls</span> &gt; <span class="number">100</span>) &#123;</span><br><span class="line">        suggestions.<span class="title function_">push</span>(<span class="string">&#x27;- å‡å°‘Draw Callsï¼ˆå½“å‰ï¼š&#x27;</span> + report.<span class="property">drawCalls</span> + <span class="string">&#x27;ï¼‰&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (report.<span class="property">meshes</span> &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">        suggestions.<span class="title function_">push</span>(<span class="string">&#x27;- å‡å°‘ç½‘æ ¼æ•°é‡ï¼ˆå½“å‰ï¼š&#x27;</span> + report.<span class="property">meshes</span> + <span class="string">&#x27;ï¼‰&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (report.<span class="property">lights</span> &gt; <span class="number">4</span>) &#123;</span><br><span class="line">        suggestions.<span class="title function_">push</span>(<span class="string">&#x27;- å‡å°‘å…‰æºæ•°é‡ï¼ˆå½“å‰ï¼š&#x27;</span> + report.<span class="property">lights</span> + <span class="string">&#x27;ï¼‰&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (report.<span class="property">frameTime</span> &gt; <span class="number">16.67</span>) &#123;</span><br><span class="line">      suggestions.<span class="title function_">push</span>(<span class="string">&#x27;- å¸§æ—¶é—´è¿‡é•¿ï¼Œè€ƒè™‘é™ä½æ¸²æŸ“è´¨é‡&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (suggestions.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;ä¼˜åŒ–å»ºè®®ï¼š&#x27;</span>, suggestions)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== æ‰¹é‡ä¼˜åŒ–å·¥å…· =====</span></span><br><span class="line">  <span class="title function_">applyQuickOptimizations</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;åº”ç”¨å¿«é€Ÿä¼˜åŒ–è®¾ç½®...&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¼•æ“ä¼˜åŒ–</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">setHardwareScalingLevel</span>(<span class="number">1.2</span>) <span class="comment">// é™ä½æ¸²æŸ“åˆ†è¾¨ç‡</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœºæ™¯ä¼˜åŒ–</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">skipPointerMovePicking</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">autoClear</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">autoClearDepthAndStencil</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æè´¨ä¼˜åŒ–</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">materials</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">material</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (material <span class="keyword">instanceof</span> <span class="title class_">StandardMaterial</span>) &#123;</span><br><span class="line">        material.<span class="property">maxSimultaneousLights</span> = <span class="number">2</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é˜´å½±ä¼˜åŒ–</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">lights</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">light</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (light.<span class="title function_">getShadowGenerator</span>()) &#123;</span><br><span class="line">        light.<span class="title function_">getShadowGenerator</span>().<span class="property">mapSize</span> = <span class="number">512</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å¿«é€Ÿä¼˜åŒ–å®Œæˆ&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== å†…å­˜ä¼˜åŒ– =====</span></span><br><span class="line">  <span class="title function_">cleanupUnusedResources</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> scene = <span class="variable language_">this</span>.<span class="property">scene</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç†æœªä½¿ç”¨çš„çº¹ç†</span></span><br><span class="line">    scene.<span class="property">textures</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">texture</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (texture.<span class="title function_">getScene</span>() === <span class="literal">null</span>) &#123;</span><br><span class="line">        texture.<span class="title function_">dispose</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç†æœªä½¿ç”¨çš„æè´¨</span></span><br><span class="line">    scene.<span class="property">materials</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">material</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (material.<span class="title function_">getBindedMeshes</span>().<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">        material.<span class="title function_">dispose</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç†æœªä½¿ç”¨çš„å‡ ä½•ä½“</span></span><br><span class="line">    scene.<span class="property">geometries</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">geometry</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (geometry.<span class="property">meshes</span>.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">        geometry.<span class="title function_">dispose</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¼ºåˆ¶åƒåœ¾å›æ”¶ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">gc</span> &amp;&amp; <span class="keyword">typeof</span> <span class="variable language_">window</span>.<span class="property">gc</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable language_">window</span>.<span class="title function_">gc</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;èµ„æºæ¸…ç†å®Œæˆ&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// èµ„æºæ¸…ç†</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">performanceMonitor</span>.<span class="title function_">dispose</span>()</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ€§èƒ½ä¼˜åŒ–å™¨å·²æ¸…ç†&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> optimizer = <span class="keyword">new</span> <span class="title class_">PerformanceOptimizer</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åº”ç”¨å¿«é€Ÿä¼˜åŒ–</span></span><br><span class="line">optimizer.<span class="title function_">applyQuickOptimizations</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®LODç³»ç»Ÿ</span></span><br><span class="line"><span class="keyword">const</span> importantMeshes = scene.<span class="property">meshes</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">m</span>) =&gt;</span> m.<span class="title function_">getTotalVertices</span>() &gt; <span class="number">1000</span>)</span><br><span class="line">optimizer.<span class="title function_">setupLODSystem</span>(importantMeshes, [<span class="number">20</span>, <span class="number">100</span>, <span class="number">500</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºç²’å­å¯¹è±¡æ± </span></span><br><span class="line"><span class="keyword">const</span> particlePool = optimizer.<span class="title function_">createObjectPool</span>(</span><br><span class="line">  <span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">ParticleSystem</span>(<span class="string">&#x27;pooled&#x27;</span>, <span class="number">100</span>, scene),</span><br><span class="line">  <span class="function">(<span class="params">ps</span>) =&gt;</span> &#123;</span><br><span class="line">    ps.<span class="title function_">stop</span>()</span><br><span class="line">    ps.<span class="title function_">reset</span>()</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="number">5</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–æ€§èƒ½æŠ¥å‘Š</span></span><br><span class="line"><span class="keyword">const</span> report = optimizer.<span class="title function_">generatePerformanceReport</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å½“å‰æ€§èƒ½ï¼š&#x27;</span>, report)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¸…ç†æœªä½¿ç”¨èµ„æº</span></span><br><span class="line">optimizer.<span class="title function_">cleanupUnusedResources</span>()</span><br></pre></td></tr></table></figure><h3 id="ğŸ¯-å…·ä½“ä¼˜åŒ–æŠ€å·§"><a href="#ğŸ¯-å…·ä½“ä¼˜åŒ–æŠ€å·§" class="headerlink" title="ğŸ¯ å…·ä½“ä¼˜åŒ–æŠ€å·§"></a>ğŸ¯ å…·ä½“ä¼˜åŒ–æŠ€å·§</h3><h4 id="1-ç½‘æ ¼ä¼˜åŒ–"><a href="#1-ç½‘æ ¼ä¼˜åŒ–" class="headerlink" title="1. ç½‘æ ¼ä¼˜åŒ–"></a>1. ç½‘æ ¼ä¼˜åŒ–</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆå¹¶ç½‘æ ¼å‡å°‘Draw Calls</span></span><br><span class="line"><span class="keyword">const</span> merged = <span class="title class_">Mesh</span>.<span class="title class_">MergeMeshes</span>(meshesToMerge)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨å®ä¾‹åŒ–</span></span><br><span class="line"><span class="keyword">const</span> instances = []</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">  instances.<span class="title function_">push</span>(originalMesh.<span class="title function_">createInstance</span>(<span class="string">&#x27;instance_&#x27;</span> + i))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç®€åŒ–å‡ ä½•ä½“</span></span><br><span class="line">mesh.<span class="title function_">simplify</span>([&#123; <span class="attr">quality</span>: <span class="number">0.5</span>, <span class="attr">distance</span>: <span class="number">100</span> &#125;])</span><br></pre></td></tr></table></figure><h4 id="2-çº¹ç†ä¼˜åŒ–"><a href="#2-çº¹ç†ä¼˜åŒ–" class="headerlink" title="2. çº¹ç†ä¼˜åŒ–"></a>2. çº¹ç†ä¼˜åŒ–</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‹ç¼©çº¹ç†</span></span><br><span class="line">texture.<span class="property">format</span> = <span class="title class_">Engine</span>.<span class="property">TEXTUREFORMAT_RGB</span></span><br><span class="line">texture.<span class="property">samplingMode</span> = <span class="title class_">Texture</span>.<span class="property">BILINEAR_SAMPLINGMODE</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¹ç†å›¾é›†</span></span><br><span class="line"><span class="keyword">const</span> atlasTexture = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;atlas.jpg&#x27;</span>, scene)</span><br></pre></td></tr></table></figure><h4 id="3-å…‰ç…§ä¼˜åŒ–"><a href="#3-å…‰ç…§ä¼˜åŒ–" class="headerlink" title="3. å…‰ç…§ä¼˜åŒ–"></a>3. å…‰ç…§ä¼˜åŒ–</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é™åˆ¶å…‰æºå½±å“èŒƒå›´</span></span><br><span class="line">light.<span class="property">range</span> = <span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨çƒ˜ç„™å…‰ç…§</span></span><br><span class="line"><span class="keyword">const</span> bakedTexture = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;lightmap.jpg&#x27;</span>, scene)</span><br><span class="line">material.<span class="property">lightmapTexture</span> = bakedTexture</span><br></pre></td></tr></table></figure><h4 id="4-æ¸²æŸ“ç®¡çº¿ä¼˜åŒ–"><a href="#4-æ¸²æŸ“ç®¡çº¿ä¼˜åŒ–" class="headerlink" title="4. æ¸²æŸ“ç®¡çº¿ä¼˜åŒ–"></a>4. æ¸²æŸ“ç®¡çº¿ä¼˜åŒ–</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¦ç”¨ä¸å¿…è¦çš„æ¸²æŸ“ç‰¹æ€§ï¼ˆæŒ‡é’ˆç§»åŠ¨æ‹¾å–ï¼‰</span></span><br><span class="line">scene.<span class="property">skipPointerMovePicking</span> = <span class="literal">true</span></span><br><span class="line">scene.<span class="property">constantlyUpdateMeshUnderPointer</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰æ¸²æŸ“é¡ºåºï¼ˆä¸é€æ˜/é€æ˜åˆ†ç»„ï¼‰</span></span><br><span class="line">scene.<span class="title function_">setRenderingOrder</span>(</span><br><span class="line">  <span class="number">0</span>, <span class="comment">// opaque sorting (é»˜è®¤å³å¯)</span></span><br><span class="line">  <span class="literal">null</span>, <span class="comment">// alpha test sorting</span></span><br><span class="line">  <span class="function">(<span class="params">a, b</span>) =&gt;</span> a.<span class="property">position</span>.<span class="property">z</span> - b.<span class="property">position</span>.<span class="property">z</span>, <span class="comment">// transparent: å‰åæ’åºï¼ŒæŒ‰éœ€å®šåˆ¶</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯·æ±‚æ¸²æŸ“æ¨¡å¼ï¼šä»…åœ¨å˜åŒ–æ—¶æ¸²æŸ“ï¼ˆé™ä½åŠŸè€—ï¼‰</span></span><br><span class="line">engine.<span class="title function_">setHardwareScalingLevel</span>(isMobile ? <span class="number">1.5</span> : <span class="number">1.0</span>)</span><br><span class="line">scene.<span class="title function_">getEngine</span>().<span class="property">renderEvenInBackground</span> = <span class="literal">false</span></span><br><span class="line">scene.<span class="property">onAfterRenderObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// ç©ºé—²é˜¶æ®µä¸å¼ºåˆ¶åˆ·æ–°</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// é»˜è®¤æ¸²æŸ“ç®¡çº¿æŒ‰éœ€å¯ç”¨</span></span><br><span class="line"><span class="keyword">const</span> pipeline = <span class="keyword">new</span> <span class="title class_">DefaultRenderingPipeline</span>(<span class="string">&#x27;default&#x27;</span>, <span class="literal">true</span>, scene, [camera])</span><br><span class="line">pipeline.<span class="property">bloomEnabled</span> = <span class="literal">false</span></span><br><span class="line">pipeline.<span class="property">depthOfFieldEnabled</span> = <span class="literal">false</span></span><br><span class="line">pipeline.<span class="property">chromaticAberrationEnabled</span> = <span class="literal">false</span></span><br><span class="line">pipeline.<span class="property">grainEnabled</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»…æ¡Œé¢ç«¯å¯ç”¨è½»é‡ Bloom</span></span><br><span class="line"><span class="keyword">if</span> (!isMobile) &#123;</span><br><span class="line">  pipeline.<span class="property">bloomEnabled</span> = <span class="literal">true</span></span><br><span class="line">  pipeline.<span class="property">bloomThreshold</span> = <span class="number">0.95</span></span><br><span class="line">  pipeline.<span class="property">bloomKernel</span> = <span class="number">24</span></span><br><span class="line">  pipeline.<span class="property">bloomWeight</span> = <span class="number">0.4</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç§»åŠ¨ç«¯ç¦ç”¨ SSAO/é«˜æˆæœ¬æ•ˆæœ</span></span><br></pre></td></tr></table></figure><p>å°æ¸…å•ï¼š</p><ul><li>ä¼˜å…ˆå…³é—­æœªä½¿ç”¨çš„åå¤„ç†ï¼›ç§»åŠ¨ç«¯ç¦ç”¨ SSAO&#x2F;é«˜æ ¸ Bloom&#x2F;DoFã€‚</li><li>å¯ç”¨è¯·æ±‚æ¸²æŸ“æ¨¡å¼ï¼Œå‡å°‘ç©ºå¸§æ¸²æŸ“ã€‚</li><li>é€æ˜å¯¹è±¡æ’åºè‡ªå®šä¹‰ï¼Œé¿å…è¿‡åº¦ overdrawã€‚</li><li>åˆ†è¾¨ç‡æŒ‰è®¾å¤‡ <code>setHardwareScalingLevel()</code> åŠ¨æ€è°ƒæ•´ã€‚</li></ul><h2 id="ğŸ¯-æœ€ä½³å®è·µ"><a href="#ğŸ¯-æœ€ä½³å®è·µ" class="headerlink" title="ğŸ¯ æœ€ä½³å®è·µ"></a>ğŸ¯ æœ€ä½³å®è·µ</h2><h3 id="ğŸ—ï¸-é¡¹ç›®ç»“æ„æœ€ä½³å®è·µ"><a href="#ğŸ—ï¸-é¡¹ç›®ç»“æ„æœ€ä½³å®è·µ" class="headerlink" title="ğŸ—ï¸ é¡¹ç›®ç»“æ„æœ€ä½³å®è·µ"></a>ğŸ—ï¸ é¡¹ç›®ç»“æ„æœ€ä½³å®è·µ</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¨èçš„é¡¹ç›®ç»“æ„</span></span><br><span class="line">project/</span><br><span class="line">â”œâ”€â”€ src/</span><br><span class="line">â”‚   â”œâ”€â”€ scenes/          <span class="comment">// åœºæ™¯ç®¡ç†</span></span><br><span class="line">â”‚   â”œâ”€â”€ models/          <span class="comment">// 3Dæ¨¡å‹</span></span><br><span class="line">â”‚   â”œâ”€â”€ materials/       <span class="comment">// æè´¨åº“</span></span><br><span class="line">â”‚   â”œâ”€â”€ animations/      <span class="comment">// åŠ¨ç”»æ§åˆ¶</span></span><br><span class="line">â”‚   â”œâ”€â”€ utils/           <span class="comment">// å·¥å…·å‡½æ•°</span></span><br><span class="line">â”‚   â””â”€â”€ main.<span class="property">js</span>          <span class="comment">// å…¥å£æ–‡ä»¶</span></span><br><span class="line">â”œâ”€â”€ assets/</span><br><span class="line">â”‚   â”œâ”€â”€ models/          <span class="comment">// .glb, .babylonæ–‡ä»¶</span></span><br><span class="line">â”‚   â”œâ”€â”€ textures/        <span class="comment">// çº¹ç†è´´å›¾</span></span><br><span class="line">â”‚   â”œâ”€â”€ sounds/          <span class="comment">// éŸ³é¢‘æ–‡ä»¶</span></span><br><span class="line">â”‚   â””â”€â”€ environments/    <span class="comment">// ç¯å¢ƒè´´å›¾</span></span><br><span class="line">â””â”€â”€ public/</span><br><span class="line">    â””â”€â”€ babylon/         <span class="comment">// BabylonJSåº“æ–‡ä»¶</span></span><br></pre></td></tr></table></figure><h3 id="ğŸ“-ä»£ç ç»„ç»‡æœ€ä½³å®è·µ"><a href="#ğŸ“-ä»£ç ç»„ç»‡æœ€ä½³å®è·µ" class="headerlink" title="ğŸ“ ä»£ç ç»„ç»‡æœ€ä½³å®è·µ"></a>ğŸ“ ä»£ç ç»„ç»‡æœ€ä½³å®è·µ</h3><h4 id="1-åœºæ™¯ç®¡ç†"><a href="#1-åœºæ™¯ç®¡ç†" class="headerlink" title="1. åœºæ™¯ç®¡ç†"></a>1. åœºæ™¯ç®¡ç†</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SceneManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">canvas</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span> = <span class="keyword">new</span> <span class="title class_">Engine</span>(canvas, <span class="literal">true</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = <span class="keyword">new</span> <span class="title class_">Scene</span>(<span class="variable language_">this</span>.<span class="property">engine</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupBasicScene</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupBasicScene</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ç›¸æœº</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span> = <span class="keyword">new</span> <span class="title class_">ArcRotateCamera</span>(<span class="string">&#x27;camera&#x27;</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="title class_">Vector3</span>.<span class="title class_">Zero</span>(), <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">attachToCanvas</span>(<span class="variable language_">this</span>.<span class="property">canvas</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…‰ç…§</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">light</span> = <span class="keyword">new</span> <span class="title class_">HemisphericLight</span>(<span class="string">&#x27;light&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>), <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸²æŸ“å¾ªç¯</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">runRenderLoop</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">render</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">dispose</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">dispose</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-èµ„æºåŠ è½½ç®¡ç†"><a href="#2-èµ„æºåŠ è½½ç®¡ç†" class="headerlink" title="2. èµ„æºåŠ è½½ç®¡ç†"></a>2. èµ„æºåŠ è½½ç®¡ç†</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AssetLoader</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loadedAssets</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadAssets</span>(<span class="params">assetList</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> promises = assetList.<span class="title function_">map</span>(<span class="function">(<span class="params">asset</span>) =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">loadSingleAsset</span>(asset))</span><br><span class="line">    <span class="keyword">const</span> results = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">allSettled</span>(promises)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> results.<span class="title function_">map</span>(<span class="function">(<span class="params">result, index</span>) =&gt;</span> (&#123;</span><br><span class="line">      <span class="attr">name</span>: assetList[index].<span class="property">name</span>,</span><br><span class="line">      <span class="attr">success</span>: result.<span class="property">status</span> === <span class="string">&#x27;fulfilled&#x27;</span>,</span><br><span class="line">      <span class="attr">asset</span>: result.<span class="property">value</span> || <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">error</span>: result.<span class="property">reason</span> || <span class="literal">null</span>,</span><br><span class="line">    &#125;))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadSingleAsset</span>(<span class="params">&#123; type, name, url, options = &#123;&#125; &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> asset</span><br><span class="line">      <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;model&#x27;</span>:</span><br><span class="line">          asset = <span class="keyword">await</span> <span class="title class_">SceneLoader</span>.<span class="title class_">ImportMeshAsync</span>(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, url, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;texture&#x27;</span>:</span><br><span class="line">          asset = <span class="keyword">new</span> <span class="title class_">Texture</span>(url, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`ä¸æ”¯æŒçš„èµ„æºç±»å‹: <span class="subst">$&#123;type&#125;</span>`</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">loadedAssets</span>.<span class="title function_">set</span>(name, asset)</span><br><span class="line">      <span class="keyword">return</span> asset</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`åŠ è½½èµ„æºå¤±è´¥: <span class="subst">$&#123;name&#125;</span>`</span>, error)</span><br><span class="line">      <span class="keyword">throw</span> error</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-é”™è¯¯å¤„ç†"><a href="#3-é”™è¯¯å¤„ç†" class="headerlink" title="3. é”™è¯¯å¤„ç†"></a>3. é”™è¯¯å¤„ç†</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ErrorHandler</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">handleError</span>(<span class="params">error, context = <span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`BabylonJSé”™è¯¯ [<span class="subst">$&#123;context&#125;</span>]:`</span>, error)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®é”™è¯¯ç±»å‹è¿›è¡Œå¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> (error.<span class="property">message</span>.<span class="title function_">includes</span>(<span class="string">&#x27;WebGL&#x27;</span>)) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleWebGLError</span>(error)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error.<span class="property">message</span>.<span class="title function_">includes</span>(<span class="string">&#x27;loading&#x27;</span>)) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleLoadingError</span>(error)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleGenericError</span>(error)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">handleWebGLError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="title function_">alert</span>(<span class="string">&#x27;WebGLä¸æ”¯æŒæˆ–å·²ç¦ç”¨ï¼Œè¯·æ›´æ–°æµè§ˆå™¨æˆ–å¯ç”¨ç¡¬ä»¶åŠ é€Ÿ&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">handleLoadingError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;èµ„æºåŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤èµ„æº&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">handleGenericError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="comment">// é€šç”¨é”™è¯¯å¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">isDevelopment</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> error <span class="comment">// å¼€å‘ç¯å¢ƒæŠ›å‡ºé”™è¯¯</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ğŸ¨-å¼€å‘æœ€ä½³å®è·µ"><a href="#ğŸ¨-å¼€å‘æœ€ä½³å®è·µ" class="headerlink" title="ğŸ¨ å¼€å‘æœ€ä½³å®è·µ"></a>ğŸ¨ å¼€å‘æœ€ä½³å®è·µ</h3><h4 id="1-æ€§èƒ½ä¼˜åŒ–åŸåˆ™"><a href="#1-æ€§èƒ½ä¼˜åŒ–åŸåˆ™" class="headerlink" title="1. æ€§èƒ½ä¼˜åŒ–åŸåˆ™"></a>1. æ€§èƒ½ä¼˜åŒ–åŸåˆ™</h4><ul><li><strong>é¿å…åœ¨æ¸²æŸ“å¾ªç¯ä¸­åˆ›å»ºå¯¹è±¡</strong></li><li><strong>ä½¿ç”¨å¯¹è±¡æ± ç®¡ç†é¢‘ç¹åˆ›å»º&#x2F;é”€æ¯çš„å¯¹è±¡</strong></li><li><strong>åˆç†ä½¿ç”¨LODå’Œå®ä¾‹åŒ–</strong></li><li><strong>åŠæ—¶é‡Šæ”¾ä¸ç”¨çš„èµ„æº</strong></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ é”™è¯¯ç¤ºä¾‹ - åœ¨æ¸²æŸ“å¾ªç¯ä¸­åˆ›å»ºå¯¹è±¡</span></span><br><span class="line">scene.<span class="title function_">registerBeforeRender</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> newVector = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>) <span class="comment">// æ¯å¸§éƒ½åˆ›å»ºæ–°å¯¹è±¡</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… æ­£ç¡®ç¤ºä¾‹ - é‡ç”¨å¯¹è±¡</span></span><br><span class="line"><span class="keyword">const</span> reusableVector = <span class="keyword">new</span> <span class="title class_">Vector3</span>()</span><br><span class="line">scene.<span class="title function_">registerBeforeRender</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  reusableVector.<span class="title function_">set</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>) <span class="comment">// é‡ç”¨ç°æœ‰å¯¹è±¡</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="2-å†…å­˜ç®¡ç†"><a href="#2-å†…å­˜ç®¡ç†" class="headerlink" title="2. å†…å­˜ç®¡ç†"></a>2. å†…å­˜ç®¡ç†</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ResourceManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">disposables</span> = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">addDisposable</span>(<span class="params">resource</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">disposables</span>.<span class="title function_">add</span>(resource)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">disposables</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">resource</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (resource.<span class="property">dispose</span>) &#123;</span><br><span class="line">        resource.<span class="title function_">dispose</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">disposables</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-è°ƒè¯•æŠ€å·§"><a href="#3-è°ƒè¯•æŠ€å·§" class="headerlink" title="3. è°ƒè¯•æŠ€å·§"></a>3. è°ƒè¯•æŠ€å·§</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯ç”¨è°ƒè¯•åŠŸèƒ½</span></span><br><span class="line">scene.<span class="property">debugLayer</span>.<span class="title function_">show</span>(&#123;</span><br><span class="line">  <span class="attr">overlay</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">showExplorer</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">showInspector</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ€§èƒ½è®¡æ•°å™¨</span></span><br><span class="line">scene.<span class="title function_">registerBeforeRender</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">isDevelopment</span> &amp;&amp; <span class="title class_">Math</span>.<span class="title function_">random</span>() &lt; <span class="number">0.01</span>) &#123;</span><br><span class="line">    <span class="comment">// 1%æ¦‚ç‡è¾“å‡º</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(&#123;</span><br><span class="line">      <span class="attr">fps</span>: engine.<span class="title function_">getFps</span>(),</span><br><span class="line">      <span class="attr">meshes</span>: scene.<span class="property">meshes</span>.<span class="property">length</span>,</span><br><span class="line">      <span class="attr">drawCalls</span>: engine.<span class="title function_">getDrawCalls</span>(),</span><br><span class="line">      <span class="attr">materials</span>: scene.<span class="property">materials</span>.<span class="property">length</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="ğŸ›¡ï¸-å®‰å…¨æ€§æœ€ä½³å®è·µ"><a href="#ğŸ›¡ï¸-å®‰å…¨æ€§æœ€ä½³å®è·µ" class="headerlink" title="ğŸ›¡ï¸ å®‰å…¨æ€§æœ€ä½³å®è·µ"></a>ğŸ›¡ï¸ å®‰å…¨æ€§æœ€ä½³å®è·µ</h3><h4 id="1-è¾“å…¥éªŒè¯"><a href="#1-è¾“å…¥éªŒè¯" class="headerlink" title="1. è¾“å…¥éªŒè¯"></a>1. è¾“å…¥éªŒè¯</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">validateAssetUrl</span>(<span class="params">url</span>) &#123;</span><br><span class="line">  <span class="comment">// åªå…è®¸ç‰¹å®šåŸŸåå’Œæ–‡ä»¶ç±»å‹</span></span><br><span class="line">  <span class="keyword">const</span> allowedDomains = [<span class="string">&#x27;your-cdn.com&#x27;</span>, <span class="string">&#x27;localhost&#x27;</span>]</span><br><span class="line">  <span class="keyword">const</span> allowedExtensions = [<span class="string">&#x27;.glb&#x27;</span>, <span class="string">&#x27;.babylon&#x27;</span>, <span class="string">&#x27;.jpg&#x27;</span>, <span class="string">&#x27;.png&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> urlObj = <span class="keyword">new</span> <span class="title function_">URL</span>(url)</span><br><span class="line">    <span class="keyword">const</span> isValidDomain = allowedDomains.<span class="title function_">some</span>(</span><br><span class="line">      <span class="function">(<span class="params">domain</span>) =&gt;</span> urlObj.<span class="property">hostname</span> === domain || urlObj.<span class="property">hostname</span>.<span class="title function_">endsWith</span>(<span class="string">&#x27;.&#x27;</span> + domain),</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">const</span> isValidExtension = allowedExtensions.<span class="title function_">some</span>(<span class="function">(<span class="params">ext</span>) =&gt;</span></span><br><span class="line">      urlObj.<span class="property">pathname</span>.<span class="title function_">toLowerCase</span>().<span class="title function_">endsWith</span>(ext),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> isValidDomain &amp;&amp; isValidExtension</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-èµ„æºé™åˆ¶"><a href="#2-èµ„æºé™åˆ¶" class="headerlink" title="2. èµ„æºé™åˆ¶"></a>2. èµ„æºé™åˆ¶</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">RESOURCE_LIMITS</span> = &#123;</span><br><span class="line">  <span class="attr">maxMeshes</span>: <span class="number">1000</span>,</span><br><span class="line">  <span class="attr">maxMaterials</span>: <span class="number">100</span>,</span><br><span class="line">  <span class="attr">maxTextures</span>: <span class="number">200</span>,</span><br><span class="line">  <span class="attr">maxTextureSize</span>: <span class="number">2048</span>,</span><br><span class="line">  <span class="attr">maxVerticesPerMesh</span>: <span class="number">50000</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">validateResourceLimits</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> issues = []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (scene.<span class="property">meshes</span>.<span class="property">length</span> &gt; <span class="variable constant_">RESOURCE_LIMITS</span>.<span class="property">maxMeshes</span>) &#123;</span><br><span class="line">    issues.<span class="title function_">push</span>(<span class="string">`ç½‘æ ¼æ•°é‡è¶…é™: <span class="subst">$&#123;scene.meshes.length&#125;</span>/<span class="subst">$&#123;RESOURCE_LIMITS.maxMeshes&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  scene.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mesh.<span class="title function_">getTotalVertices</span>() &gt; <span class="variable constant_">RESOURCE_LIMITS</span>.<span class="property">maxVerticesPerMesh</span>) &#123;</span><br><span class="line">      issues.<span class="title function_">push</span>(<span class="string">`ç½‘æ ¼ <span class="subst">$&#123;mesh.name&#125;</span> é¡¶ç‚¹æ•°è¿‡å¤š: <span class="subst">$&#123;mesh.getTotalVertices()&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> issues</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ğŸ“±-ç§»åŠ¨ç«¯ä¼˜åŒ–æœ€ä½³å®è·µ"><a href="#ğŸ“±-ç§»åŠ¨ç«¯ä¼˜åŒ–æœ€ä½³å®è·µ" class="headerlink" title="ğŸ“± ç§»åŠ¨ç«¯ä¼˜åŒ–æœ€ä½³å®è·µ"></a>ğŸ“± ç§»åŠ¨ç«¯ä¼˜åŒ–æœ€ä½³å®è·µ</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ£€æµ‹ç§»åŠ¨è®¾å¤‡</span></span><br><span class="line"><span class="keyword">const</span> isMobile = <span class="regexp">/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i</span>.<span class="title function_">test</span>(</span><br><span class="line">  navigator.<span class="property">userAgent</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isMobile) &#123;</span><br><span class="line">  <span class="comment">// ç§»åŠ¨ç«¯ä¼˜åŒ–è®¾ç½®</span></span><br><span class="line">  engine.<span class="title function_">setHardwareScalingLevel</span>(<span class="number">1.5</span>) <span class="comment">// é™ä½åˆ†è¾¨ç‡</span></span><br><span class="line">  scene.<span class="property">skipPointerMovePicking</span> = <span class="literal">true</span> <span class="comment">// ç¦ç”¨é¼ æ ‡ç§»åŠ¨æ‹¾å–</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç®€åŒ–æè´¨</span></span><br><span class="line">  scene.<span class="property">materials</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">material</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (material <span class="keyword">instanceof</span> <span class="title class_">StandardMaterial</span>) &#123;</span><br><span class="line">      material.<span class="property">maxSimultaneousLights</span> = <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯ç”¨è§¦æ‘¸æ§åˆ¶</span></span><br><span class="line">  scene.<span class="property">actionManager</span> = <span class="keyword">new</span> <span class="title class_">ActionManager</span>(scene)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ğŸ¯-éƒ¨ç½²æœ€ä½³å®è·µ"><a href="#ğŸ¯-éƒ¨ç½²æœ€ä½³å®è·µ" class="headerlink" title="ğŸ¯ éƒ¨ç½²æœ€ä½³å®è·µ"></a>ğŸ¯ éƒ¨ç½²æœ€ä½³å®è·µ</h3><h4 id="1-ç”Ÿäº§ç¯å¢ƒé…ç½®"><a href="#1-ç”Ÿäº§ç¯å¢ƒé…ç½®" class="headerlink" title="1. ç”Ÿäº§ç¯å¢ƒé…ç½®"></a>1. ç”Ÿäº§ç¯å¢ƒé…ç½®</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–</span></span><br><span class="line"><span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">  <span class="comment">// ç¦ç”¨è°ƒè¯•</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="property">log</span> = <span class="function">() =&gt;</span> &#123;&#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="property">warn</span> = <span class="function">() =&gt;</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯ç”¨å‹ç¼©</span></span><br><span class="line">  <span class="title class_">Engine</span>.<span class="property">audioEngine</span>.<span class="property">useCustomUnlockedState</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// é”™è¯¯ä¸ŠæŠ¥</span></span><br><span class="line">  <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// å‘é€é”™è¯¯æŠ¥å‘Šåˆ°æœåŠ¡å™¨</span></span><br><span class="line">    <span class="title function_">sendErrorReport</span>(event.<span class="property">error</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-CDNèµ„æºé…ç½®"><a href="#2-CDNèµ„æºé…ç½®" class="headerlink" title="2. CDNèµ„æºé…ç½®"></a>2. CDNèµ„æºé…ç½®</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">CDN_CONFIG</span> = &#123;</span><br><span class="line">  <span class="attr">models</span>: <span class="string">&#x27;https://cdn.example.com/models/&#x27;</span>,</span><br><span class="line">  <span class="attr">textures</span>: <span class="string">&#x27;https://cdn.example.com/textures/&#x27;</span>,</span><br><span class="line">  <span class="attr">sounds</span>: <span class="string">&#x27;https://cdn.example.com/sounds/&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getAssetUrl</span>(<span class="params">type, filename</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> baseUrl = <span class="variable constant_">CDN_CONFIG</span>[type] || <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="keyword">return</span> baseUrl + filename</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ğŸ“š-å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ"><a href="#ğŸ“š-å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ" class="headerlink" title="ğŸ“š å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ"></a>ğŸ“š å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</h3><h4 id="1-WebGLä¸Šä¸‹æ–‡ä¸¢å¤±"><a href="#1-WebGLä¸Šä¸‹æ–‡ä¸¢å¤±" class="headerlink" title="1. WebGLä¸Šä¸‹æ–‡ä¸¢å¤±"></a>1. WebGLä¸Šä¸‹æ–‡ä¸¢å¤±</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">canvas.<span class="title function_">addEventListener</span>(<span class="string">&#x27;webglcontextlost&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  event.<span class="title function_">preventDefault</span>()</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;WebGLä¸Šä¸‹æ–‡ä¸¢å¤±&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">canvas.<span class="title function_">addEventListener</span>(<span class="string">&#x27;webglcontextrestored&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;WebGLä¸Šä¸‹æ–‡å·²æ¢å¤&#x27;</span>)</span><br><span class="line">  <span class="comment">// é‡æ–°åˆå§‹åŒ–åœºæ™¯</span></span><br><span class="line">  <span class="title function_">initializeScene</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="2-å†…å­˜æ³„æ¼é¢„é˜²"><a href="#2-å†…å­˜æ³„æ¼é¢„é˜²" class="headerlink" title="2. å†…å­˜æ³„æ¼é¢„é˜²"></a>2. å†…å­˜æ³„æ¼é¢„é˜²</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;beforeunload&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (scene) &#123;</span><br><span class="line">    scene.<span class="title function_">dispose</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (engine) &#123;</span><br><span class="line">    engine.<span class="title function_">dispose</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="3-å¼‚æ­¥åŠ è½½å¤„ç†"><a href="#3-å¼‚æ­¥åŠ è½½å¤„ç†" class="headerlink" title="3. å¼‚æ­¥åŠ è½½å¤„ç†"></a>3. å¼‚æ­¥åŠ è½½å¤„ç†</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">safeAsyncLoad</span>(<span class="params">loadFunction</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> timeout = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">_, reject</span>) =&gt;</span> <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;åŠ è½½è¶…æ—¶&#x27;</span>)), <span class="number">30000</span>))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">race</span>([<span class="title function_">loadFunction</span>(), timeout])</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;å¼‚æ­¥åŠ è½½å¤±è´¥:&#x27;</span>, error)</span><br><span class="line">    <span class="keyword">throw</span> error</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ğŸ¤-ä¸-Cesium-åŒå±å åŠ ï¼ˆå•å›¾å±‚ï¼‰å®ç°"><a href="#ğŸ¤-ä¸-Cesium-åŒå±å åŠ ï¼ˆå•å›¾å±‚ï¼‰å®ç°" class="headerlink" title="ğŸ¤ ä¸ Cesium åŒå±å åŠ ï¼ˆå•å›¾å±‚ï¼‰å®ç°"></a>ğŸ¤ ä¸ Cesium åŒå±å åŠ ï¼ˆå•å›¾å±‚ï¼‰å®ç°</h2><p>å®ç°ç›®æ ‡ï¼šåœ¨ä¿æŒ Cesium ä½œä¸ºåº•å›¾&#x2F;åœ°å½¢çš„å‰æä¸‹ï¼ŒBabylonJS ä½œä¸ºé€æ˜å åŠ å±‚ç»˜åˆ¶è‡ªå®šä¹‰ 3D&#x2F;ç‰¹æ•ˆï¼Œä¸¤ä¸ªå¼•æ“åŒå±æ˜¾ç¤ºã€ç›¸æœºåŒæ­¥ã€‚</p><h3 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h3><ol><li>å åŠ ä¸€ä¸ªé€æ˜ Canvasï¼ˆç½®é¡¶ã€äº‹ä»¶ç©¿é€ï¼‰</li></ol><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">  <span class="selector-id">#wrap</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">position</span>: relative;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css">  <span class="selector-id">#cesium</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">position</span>: absolute;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">inset</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css">  <span class="selector-id">#babylon</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">position</span>: absolute;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">inset</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">pointer-events</span>: none;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;wrap&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;cesium&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">&quot;babylon&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>åˆå§‹åŒ–ä¸¤ä¸ªå¼•æ“ï¼ˆBabylon é€æ˜&#x2F;å³æ‰‹ç³»ï¼‰</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cesium</span></span><br><span class="line">aaa <span class="keyword">const</span> viewer = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Viewer</span>(<span class="string">&#x27;cesium&#x27;</span>, &#123; <span class="comment">/* ...åº•å›¾/åœ°å½¢... */</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Babylon</span></span><br><span class="line">aaa <span class="keyword">const</span> babCanvas = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;babylon&#x27;</span>)</span><br><span class="line">aaa <span class="keyword">const</span> engine = <span class="keyword">new</span> <span class="variable constant_">BABYLON</span>.<span class="title class_">Engine</span>(babCanvas, <span class="literal">true</span>, &#123; <span class="attr">alpha</span>: <span class="literal">true</span>, <span class="attr">preserveDrawingBuffer</span>: <span class="literal">true</span>, <span class="attr">stencil</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">aaa <span class="keyword">const</span> scene = <span class="keyword">new</span> <span class="variable constant_">BABYLON</span>.<span class="title class_">Scene</span>(engine)</span><br><span class="line">aaa scene.<span class="property">useRightHandedSystem</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">aaa scene.<span class="property">clearColor</span> = <span class="keyword">new</span> <span class="variable constant_">BABYLON</span>.<span class="title class_">Color4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">const</span> camera = <span class="keyword">new</span> <span class="variable constant_">BABYLON</span>.<span class="title class_">FreeCamera</span>(<span class="string">&#x27;syncCam&#x27;</span>, <span class="keyword">new</span> <span class="variable constant_">BABYLON</span>.<span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), scene)</span><br><span class="line">camera.<span class="property">minZ</span> = <span class="number">0.1</span></span><br><span class="line">camera.<span class="property">maxZ</span> = <span class="number">1e9</span></span><br></pre></td></tr></table></figure><ol start="3"><li>ç›¸æœºåŒæ­¥ï¼ˆæ¯å¸§ Cesium æ¸²æŸ“å®ŒæˆååŒæ­¥ Babylonï¼‰</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">v3</span>(<span class="params">x, y, z</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="variable constant_">BABYLON</span>.<span class="title class_">Vector3</span>(x, y, z)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">syncBabylonCamera</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> c = viewer.<span class="property">camera</span></span><br><span class="line">  <span class="keyword">const</span> pos = c.<span class="property">positionWC</span></span><br><span class="line">  <span class="keyword">const</span> dir = c.<span class="property">directionWC</span></span><br><span class="line">  <span class="keyword">const</span> up = c.<span class="property">upWC</span></span><br><span class="line"></span><br><span class="line">  camera.<span class="property">position</span> = <span class="title function_">v3</span>(pos.<span class="property">x</span>, pos.<span class="property">y</span>, pos.<span class="property">z</span>)</span><br><span class="line">  camera.<span class="property">upVector</span> = <span class="title function_">v3</span>(up.<span class="property">x</span>, up.<span class="property">y</span>, up.<span class="property">z</span>)</span><br><span class="line">  camera.<span class="title function_">setTarget</span>(<span class="title function_">v3</span>(pos.<span class="property">x</span> + dir.<span class="property">x</span>, pos.<span class="property">y</span> + dir.<span class="property">y</span>, pos.<span class="property">z</span> + dir.<span class="property">z</span>))</span><br><span class="line">  camera.<span class="property">fov</span> = c.<span class="property">frustum</span>.<span class="property">fov</span></span><br><span class="line"></span><br><span class="line">  engine.<span class="title function_">resize</span>()</span><br><span class="line">  scene.<span class="title function_">render</span>()</span><br><span class="line">&#125;</span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">postRender</span>.<span class="title function_">addEventListener</span>(syncBabylonCamera)</span><br></pre></td></tr></table></figure><ol start="4"><li>åœ¨ç»çº¬é«˜æ”¾ç½® Babylon ç‰©ä½“ï¼ˆç»çº¬é«˜ â†’ ECEF â†’ ENU çŸ©é˜µï¼‰</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">enuMatrixAt</span>(<span class="params">lon, lat, alt</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> ecef = <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(lon, lat, alt)</span><br><span class="line">  <span class="keyword">const</span> m = <span class="title class_">Cesium</span>.<span class="property">Transforms</span>.<span class="title function_">eastNorthUpToFixedFrame</span>(ecef) <span class="comment">// 4x4 åˆ—ä¸»åº</span></span><br><span class="line">  <span class="keyword">return</span> <span class="variable constant_">BABYLON</span>.<span class="property">Matrix</span>.<span class="title class_">FromArray</span>([</span><br><span class="line">    m[<span class="number">0</span>],</span><br><span class="line">    m[<span class="number">1</span>],</span><br><span class="line">    m[<span class="number">2</span>],</span><br><span class="line">    m[<span class="number">3</span>],</span><br><span class="line">    m[<span class="number">4</span>],</span><br><span class="line">    m[<span class="number">5</span>],</span><br><span class="line">    m[<span class="number">6</span>],</span><br><span class="line">    m[<span class="number">7</span>],</span><br><span class="line">    m[<span class="number">8</span>],</span><br><span class="line">    m[<span class="number">9</span>],</span><br><span class="line">    m[<span class="number">10</span>],</span><br><span class="line">    m[<span class="number">11</span>],</span><br><span class="line">    m[<span class="number">12</span>],</span><br><span class="line">    m[<span class="number">13</span>],</span><br><span class="line">    m[<span class="number">14</span>],</span><br><span class="line">    m[<span class="number">15</span>],</span><br><span class="line">  ])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> box = <span class="variable constant_">BABYLON</span>.<span class="property">MeshBuilder</span>.<span class="title class_">CreateBox</span>(<span class="string">&#x27;box&#x27;</span>, &#123; <span class="attr">size</span>: <span class="number">50</span> &#125;, scene)</span><br><span class="line">box.<span class="title function_">setPreTransformMatrix</span>(<span class="title function_">enuMatrixAt</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">100</span>))</span><br></pre></td></tr></table></figure><ol start="5"><li>æ³¨æ„äº‹é¡¹</li></ol><ul><li>Babylon ç”»å¸ƒé€æ˜æ¸²æŸ“æœ‰æˆæœ¬ï¼šå‡å°‘åå¤„ç†ä¸é«˜å¼€é”€æè´¨</li><li>æŒ‡é’ˆäº‹ä»¶ï¼šé»˜è®¤ç©¿é€ç»™ Cesiumï¼›éœ€è¦ Babylon æ‹¾å–æ—¶ç§»é™¤ <code>pointer-events: none</code> å¹¶è¿›è¡Œäº‹ä»¶è·¯ç”±</li><li>ä¸¤å¼•æ“æ·±åº¦ä¸äº’é€šï¼šé®æŒ¡&#x2F;é˜´å½±äº’ä¸å½±å“ï¼ŒæŒ‰éœ€åœ¨ Babylon å†…åšè‡ªæ´½å…‰ç…§</li></ul><h3 id="æ–¹æ¡ˆä¼˜åŠ¿"><a href="#æ–¹æ¡ˆä¼˜åŠ¿" class="headerlink" title="æ–¹æ¡ˆä¼˜åŠ¿"></a>æ–¹æ¡ˆä¼˜åŠ¿</h3><ul><li>ä½è€¦åˆï¼šä¸¤å¼•æ“äº’ä¸å…¥ä¾µï¼Œå‡çº§&#x2F;é…ç½®äº’ä¸å½±å“</li><li>å¿«é€Ÿè½åœ°ï¼šä»…éœ€é€æ˜å±‚ + ç›¸æœºåŒæ­¥ + ç»çº¬é«˜æ‘†æ”¾</li><li>å¼ºæ‰©å±•ï¼šå¯å°† Babylon çš„ Shader&#x2F;ç²’å­&#x2F;åå¤„ç†ä½œä¸ºâ€œè§†è§‰å±‚â€æ— ç¼å åŠ åˆ° Cesium åœ°ç†åœºæ™¯</li><li>è·¨å¹³å°ç¨³å¥ï¼šä¸ä¾èµ–ç§æœ‰æ¥å£ï¼Œè¿è¡Œåœ¨å¸¸è§„ Web ç¯å¢ƒ</li></ul><h3 id="æ‹“å±•æ€§å»ºè®®"><a href="#æ‹“å±•æ€§å»ºè®®" class="headerlink" title="æ‹“å±•æ€§å»ºè®®"></a>æ‹“å±•æ€§å»ºè®®</h3><ul><li>äº‹ä»¶è·¯ç”±ï¼šæä¾›å¼€å…³åˆ‡æ¢äº‹ä»¶å½’å±ï¼ˆCesium&#x2F;Babylonï¼‰ï¼Œæˆ–æŒ‰åŒºåŸŸåˆ†é…</li><li>åæ ‡å·¥å…·åŒ–ï¼šå°è£… <code>lonlat-&gt;ECEF-&gt;ENU</code> ä¸çŸ©é˜µåº”ç”¨å·¥å…·ï¼Œç»Ÿä¸€æ”¾ç½®è¯¯å·®</li><li>æ¸²æŸ“ç­–ç•¥ï¼šè¯·æ±‚æ¸²æŸ“æ¨¡å¼ã€åˆ†è¾¨ç‡ç¼©æ”¾ã€æŒ‰éœ€æ¸²æŸ“ï¼ˆåªåœ¨ Cesium ç›¸æœºå˜åŒ–æ—¶é©±åŠ¨ Babylonï¼‰</li><li>ç»„ä»¶åŒ–ï¼šæŠ½è±¡ä¸º <code>CesiumBabylonOverlay</code> ç±»ï¼Œæä¾› <code>addMeshAt(lon,lat,alt,mesh)</code> ç­‰ API</li></ul><h3 id="ğŸ‰-æ€»ç»“"><a href="#ğŸ‰-æ€»ç»“" class="headerlink" title="ğŸ‰ æ€»ç»“"></a>ğŸ‰ æ€»ç»“</h3><p>éµå¾ªè¿™äº›æœ€ä½³å®è·µå¯ä»¥å¸®åŠ©ä½ ï¼š</p><ul><li><strong>æé«˜åº”ç”¨æ€§èƒ½</strong> - é€šè¿‡åˆç†çš„èµ„æºç®¡ç†å’Œä¼˜åŒ–</li><li><strong>å¢å¼ºä»£ç å¯ç»´æŠ¤æ€§</strong> - é€šè¿‡æ¸…æ™°çš„ç»“æ„å’Œé”™è¯¯å¤„ç†</li><li><strong>ç¡®ä¿ç”¨æˆ·ä½“éªŒ</strong> - é€šè¿‡ç§»åŠ¨ç«¯ä¼˜åŒ–å’Œå®‰å…¨æ€§æªæ–½</li><li><strong>ç®€åŒ–è°ƒè¯•è¿‡ç¨‹</strong> - é€šè¿‡å®Œå–„çš„æ—¥å¿—å’Œç›‘æ§</li></ul><p>è®°ä½ï¼Œæœ€ä½³å®è·µæ˜¯æŒ‡å¯¼åŸåˆ™ï¼Œéœ€è¦æ ¹æ®å…·ä½“é¡¹ç›®éœ€æ±‚çµæ´»è°ƒæ•´ã€‚æŒç»­å­¦ä¹ å’Œä¼˜åŒ–æ˜¯BabylonJSå¼€å‘çš„å…³é”®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;BabylonJS-å®Œæ•´ç¦»çº¿å¼€å‘æŒ‡å—&quot;&gt;&lt;a href=&quot;#BabylonJS-å®Œæ•´ç¦»çº¿å¼€å‘æŒ‡å—&quot; class=&quot;headerlink&quot; title=&quot;BabylonJS å®Œæ•´ç¦»çº¿å¼€å‘æŒ‡å—&quot;&gt;&lt;/a&gt;BabylonJS å®Œæ•´ç¦»çº¿å¼€å‘æŒ‡å—&lt;/h1&gt;&lt;h2 id=&quot;ï¿½</summary>
      
    
    
    
    
    <category term="BabylonJS" scheme="https://aoayaoa.github.io/tags/BabylonJS/"/>
    
  </entry>
  
  <entry>
    <title>Cesium å¼€å‘æ–‡æ¡£</title>
    <link href="https://aoayaoa.github.io/2025/07/31/cesium/"/>
    <id>https://aoayaoa.github.io/2025/07/31/cesium/</id>
    <published>2025-07-30T16:00:00.000Z</published>
    <updated>2025-08-08T02:51:24.572Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Cesium-å®Œæ•´ç¦»çº¿å¼€å‘æŒ‡å—"><a href="#Cesium-å®Œæ•´ç¦»çº¿å¼€å‘æŒ‡å—" class="headerlink" title="Cesium å®Œæ•´ç¦»çº¿å¼€å‘æŒ‡å—"></a>Cesium å®Œæ•´ç¦»çº¿å¼€å‘æŒ‡å—</h1><h2 id="ğŸ“‹-ç›®å½•"><a href="#ğŸ“‹-ç›®å½•" class="headerlink" title="ğŸ“‹ ç›®å½•"></a>ğŸ“‹ ç›®å½•</h2><ul><li><a href="#%E7%A6%BB%E7%BA%BF%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE">ç¦»çº¿ç¯å¢ƒé…ç½®</a></li><li><a href="#viewer-%E8%AF%A6%E7%BB%86%E9%85%8D%E7%BD%AE">Viewer è¯¦ç»†é…ç½®</a></li><li><a href="#%E5%9D%90%E6%A0%87%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">åæ ‡ç³»ç»Ÿè¯¦è§£</a></li><li><a href="#%E5%AE%9E%E4%BD%93%E7%B3%BB%E7%BB%9F%E5%AE%8C%E6%95%B4%E5%B1%9E%E6%80%A7">å®ä½“ç³»ç»Ÿå®Œæ•´å±æ€§</a></li><li><a href="#%E5%BD%B1%E5%83%8F%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">å½±åƒç³»ç»Ÿè¯¦è§£</a></li><li><a href="#%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">åœ°å½¢ç³»ç»Ÿè¯¦è§£</a></li><li><a href="#%E7%9B%B8%E6%9C%BA%E7%B3%BB%E7%BB%9F%E5%AE%8C%E6%95%B4%E5%B1%9E%E6%80%A7">ç›¸æœºç³»ç»Ÿå®Œæ•´å±æ€§</a></li><li><a href="#%E4%BA%8B%E4%BB%B6%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">äº‹ä»¶ç³»ç»Ÿè¯¦è§£</a></li><li><a href="#%E6%9D%90%E8%B4%A8%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">æè´¨ç³»ç»Ÿè¯¦è§£</a></li><li><a href="#%E5%8A%A8%E7%94%BB%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">åŠ¨ç”»ç³»ç»Ÿè¯¦è§£</a></li><li><a href="#%E5%87%A0%E4%BD%95%E4%BD%93%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">å‡ ä½•ä½“ç³»ç»Ÿè¯¦è§£</a></li><li><a href="#%E5%9C%BA%E6%99%AF%E6%8E%A7%E5%88%B6%E8%AF%A6%E8%A7%A3">åœºæ™¯æ§åˆ¶è¯¦è§£</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E6%BA%90%E8%AF%A6%E8%A7%A3">æ•°æ®æºè¯¦è§£</a></li><li><a href="#%E6%97%B6%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">æ—¶é—´ç³»ç»Ÿè¯¦è§£</a></li><li><a href="#%E7%BB%98%E5%88%B6%E5%8A%9F%E8%83%BD%E8%AF%A6%E8%A7%A3">ç»˜åˆ¶åŠŸèƒ½è¯¦è§£</a></li><li><a href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E8%AF%A6%E8%A7%A3">æ€§èƒ½ä¼˜åŒ–è¯¦è§£</a></li></ul><h2 id="ç¦»çº¿ç¯å¢ƒé…ç½®"><a href="#ç¦»çº¿ç¯å¢ƒé…ç½®" class="headerlink" title="ç¦»çº¿ç¯å¢ƒé…ç½®"></a>ç¦»çº¿ç¯å¢ƒé…ç½®</h2><h3 id="å®Œæ•´ç¦»çº¿åŒ…ä¸‹è½½"><a href="#å®Œæ•´ç¦»çº¿åŒ…ä¸‹è½½" class="headerlink" title="å®Œæ•´ç¦»çº¿åŒ…ä¸‹è½½"></a>å®Œæ•´ç¦»çº¿åŒ…ä¸‹è½½</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. ä¸‹è½½Cesiumå®Œæ•´åŒ…</span></span><br><span class="line">wget https://github.com/CesiumGS/cesium/releases/download/1.110/Cesium-1.110.zip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. è§£å‹åˆ°é™æ€èµ„æºç›®å½•</span></span><br><span class="line">unzip Cesium-1.110.zip -d public/cesium/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. é¡¹ç›®ç»“æ„</span></span><br><span class="line">public/</span><br><span class="line">â”œâ”€â”€ cesium/</span><br><span class="line">â”‚   â”œâ”€â”€ Build/</span><br><span class="line">â”‚   â”‚   â””â”€â”€ Cesium/</span><br><span class="line">â”‚   â”‚       â”œâ”€â”€ Cesium.js          <span class="comment"># ä¸»åº“æ–‡ä»¶</span></span><br><span class="line">â”‚   â”‚       â”œâ”€â”€ Widgets/</span><br><span class="line">â”‚   â”‚       â”‚   â””â”€â”€ widgets.css    <span class="comment"># æ ·å¼æ–‡ä»¶</span></span><br><span class="line">â”‚   â”‚       â”œâ”€â”€ Workers/           <span class="comment"># WebWorkeræ–‡ä»¶</span></span><br><span class="line">â”‚   â”‚       â”œâ”€â”€ ThirdParty/        <span class="comment"># ç¬¬ä¸‰æ–¹åº“</span></span><br><span class="line">â”‚   â”‚       â””â”€â”€ Assets/            <span class="comment"># é™æ€èµ„æº</span></span><br><span class="line">â”‚   â””â”€â”€ Apps/                      <span class="comment"># ç¤ºä¾‹åº”ç”¨</span></span><br></pre></td></tr></table></figure><h3 id="Viteç¦»çº¿é…ç½®"><a href="#Viteç¦»çº¿é…ç½®" class="headerlink" title="Viteç¦»çº¿é…ç½®"></a>Viteç¦»çº¿é…ç½®</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.js - ç¦»çº¿å¼€å‘é…ç½®</span></span><br><span class="line"><span class="keyword">import</span> &#123; defineConfig &#125; <span class="keyword">from</span> <span class="string">&#x27;vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; resolve &#125; <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">define</span>: &#123;</span><br><span class="line">    <span class="comment">// å®šä¹‰å…¨å±€å¸¸é‡ï¼Œé¿å…Ionä¾èµ–</span></span><br><span class="line">    <span class="attr">CESIUM_BASE_URL</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="string">&#x27;/cesium/&#x27;</span>),</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é™æ€èµ„æºå¤„ç†</span></span><br><span class="line">  <span class="attr">publicDir</span>: <span class="string">&#x27;public&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ„å»ºé…ç½®</span></span><br><span class="line">  <span class="attr">build</span>: &#123;</span><br><span class="line">    <span class="attr">rollupOptions</span>: &#123;</span><br><span class="line">      <span class="comment">// æ’é™¤ä¸éœ€è¦çš„ä¾èµ–</span></span><br><span class="line">      <span class="attr">external</span>: [<span class="string">&#x27;@cesium/engine&#x27;</span>],</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¤åˆ¶Cesiumé™æ€èµ„æº</span></span><br><span class="line">      <span class="attr">input</span>: &#123;</span><br><span class="line">        <span class="attr">main</span>: <span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;index.html&#x27;</span>),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¼€å‘æœåŠ¡å™¨é…ç½®</span></span><br><span class="line">  <span class="attr">server</span>: &#123;</span><br><span class="line">    <span class="comment">// é™æ€æ–‡ä»¶æœåŠ¡</span></span><br><span class="line">    <span class="attr">fs</span>: &#123;</span><br><span class="line">      <span class="attr">allow</span>: [<span class="string">&#x27;..&#x27;</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¼˜åŒ–é…ç½®</span></span><br><span class="line">  <span class="attr">optimizeDeps</span>: &#123;</span><br><span class="line">    <span class="comment">// é¢„æ„å»ºCesium</span></span><br><span class="line">    <span class="attr">include</span>: [<span class="string">&#x27;cesium&#x27;</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="ç¦»çº¿åˆå§‹åŒ–"><a href="#ç¦»çº¿åˆå§‹åŒ–" class="headerlink" title="ç¦»çº¿åˆå§‹åŒ–"></a>ç¦»çº¿åˆå§‹åŒ–</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js - ç¦»çº¿åˆå§‹åŒ–é…ç½®</span></span><br><span class="line"><span class="comment">// è®¾ç½®CesiumåŸºç¡€è·¯å¾„</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">CESIUM_BASE_URL</span> = <span class="string">&#x27;/cesium/Build/Cesium/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¦ç”¨IonæœåŠ¡ï¼ˆç¦»çº¿ç¯å¢ƒï¼‰</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">Cesium</span> <span class="keyword">from</span> <span class="string">&#x27;cesium&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¦†ç›–Ioné»˜è®¤è®¾ç½®</span></span><br><span class="line"><span class="title class_">Cesium</span>.<span class="property">Ion</span>.<span class="property">defaultAccessToken</span> = <span class="literal">undefined</span></span><br><span class="line"><span class="title class_">Cesium</span>.<span class="property">Ion</span>.<span class="property">defaultServer</span> = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¦»çº¿Vieweré…ç½®</span></span><br><span class="line"><span class="keyword">const</span> viewer = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Viewer</span>(<span class="string">&#x27;cesiumContainer&#x27;</span>, &#123;</span><br><span class="line">  <span class="comment">// å…³é—­æ‰€æœ‰åœ¨çº¿æœåŠ¡</span></span><br><span class="line">  <span class="attr">baseLayerPicker</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">geocoder</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½¿ç”¨ç¦»çº¿å½±åƒ</span></span><br><span class="line">  <span class="attr">imageryProvider</span>: <span class="literal">false</span>, <span class="comment">// ä¸åŠ è½½é»˜è®¤å½±åƒ</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½¿ç”¨æœ¬åœ°åœ°å½¢</span></span><br><span class="line">  <span class="attr">terrainProvider</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">EllipsoidTerrainProvider</span>(),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="Viewer-è¯¦ç»†é…ç½®"><a href="#Viewer-è¯¦ç»†é…ç½®" class="headerlink" title="Viewer è¯¦ç»†é…ç½®"></a>Viewer è¯¦ç»†é…ç½®</h2><h3 id="æ„é€ å‡½æ•°å®Œæ•´å‚æ•°"><a href="#æ„é€ å‡½æ•°å®Œæ•´å‚æ•°" class="headerlink" title="æ„é€ å‡½æ•°å®Œæ•´å‚æ•°"></a>æ„é€ å‡½æ•°å®Œæ•´å‚æ•°</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> viewer = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Viewer</span>(container, &#123;</span><br><span class="line">  <span class="comment">// === åŸºç¡€æ¸²æŸ“é€‰é¡¹ ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// animation: boolean</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ§åˆ¶æ—¶é—´åŠ¨ç”»æ§ä»¶çš„æ˜¾ç¤º</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">  <span class="comment">// ç¦»çº¿å»ºè®®: falseï¼ˆå‡å°‘UIå¤æ‚åº¦ï¼‰</span></span><br><span class="line">  <span class="attr">animation</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// baseLayerPicker: boolean</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ§åˆ¶å›¾å±‚é€‰æ‹©å™¨çš„æ˜¾ç¤º</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">  <span class="comment">// ç¦»çº¿å»ºè®®: falseï¼ˆé¿å…åœ¨çº¿å›¾å±‚ä¾èµ–ï¼‰</span></span><br><span class="line">  <span class="attr">baseLayerPicker</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fullscreenButton: boolean</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ§åˆ¶å…¨å±æŒ‰é’®çš„æ˜¾ç¤º</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">  <span class="comment">// ç”¨é€”: å…è®¸ç”¨æˆ·å…¨å±æŸ¥çœ‹åœ°å›¾</span></span><br><span class="line">  <span class="attr">fullscreenButton</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// geocoder: boolean | GeocoderService[]</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ§åˆ¶åœ°å€æœç´¢æ¡†çš„æ˜¾ç¤º</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">  <span class="comment">// ç¦»çº¿å»ºè®®: falseï¼ˆéœ€è¦åœ¨çº¿æœåŠ¡ï¼‰</span></span><br><span class="line">  <span class="attr">geocoder</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// homeButton: boolean</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ§åˆ¶ä¸»é¡µæŒ‰é’®çš„æ˜¾ç¤º</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">  <span class="comment">// ç”¨é€”: é‡ç½®åˆ°åˆå§‹è§†è§’</span></span><br><span class="line">  <span class="attr">homeButton</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// infoBox: boolean</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ§åˆ¶ä¿¡æ¯æ¡†çš„æ˜¾ç¤º</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">  <span class="comment">// ç”¨é€”: æ˜¾ç¤ºå®ä½“è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">  <span class="attr">infoBox</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sceneModePicker: boolean</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ§åˆ¶åœºæ™¯æ¨¡å¼é€‰æ‹©å™¨ï¼ˆ3D/2D/Columbusï¼‰</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">  <span class="comment">// ç”¨é€”: åˆ‡æ¢ä¸åŒçš„æŸ¥çœ‹æ¨¡å¼</span></span><br><span class="line">  <span class="attr">sceneModePicker</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// selectionIndicator: boolean</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ§åˆ¶é€‰æ‹©æŒ‡ç¤ºå™¨ï¼ˆç»¿è‰²æ¡†ï¼‰</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">  <span class="comment">// ç”¨é€”: æ˜¾ç¤ºé€‰ä¸­å®ä½“çš„è¾¹ç•Œæ¡†</span></span><br><span class="line">  <span class="attr">selectionIndicator</span>: <span class="literal">false</span>, <span class="comment">// é€šå¸¸å…³é—­ä»¥è·å¾—æ›´å¥½çš„è§†è§‰æ•ˆæœ</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// timeline: boolean</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ§åˆ¶æ—¶é—´è½´çš„æ˜¾ç¤º</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">  <span class="comment">// ç”¨é€”: æ§åˆ¶æ—¶é—´ç›¸å…³çš„åŠ¨ç”»</span></span><br><span class="line">  <span class="attr">timeline</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// navigationHelpButton: boolean</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ§åˆ¶å¯¼èˆªå¸®åŠ©æŒ‰é’®</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">  <span class="comment">// ç”¨é€”: æ˜¾ç¤ºé¼ æ ‡/è§¦æ‘¸æ“ä½œè¯´æ˜</span></span><br><span class="line">  <span class="attr">navigationHelpButton</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// navigationInstructionsInitiallyVisible: boolean</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ§åˆ¶å¯¼èˆªè¯´æ˜çš„åˆå§‹å¯è§æ€§</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">  <span class="comment">// ç”¨é€”: é¡µé¢åŠ è½½æ—¶æ˜¯å¦æ˜¾ç¤ºæ“ä½œè¯´æ˜</span></span><br><span class="line">  <span class="attr">navigationInstructionsInitiallyVisible</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === åœºæ™¯æ¸²æŸ“é€‰é¡¹ ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// scene3DOnly: boolean</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ˜¯å¦åªæ”¯æŒ3Dæ¨¡å¼</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">  <span class="comment">// ç”¨é€”: ç¦ç”¨2Då’ŒColumbusæ¨¡å¼ä»¥æå‡æ€§èƒ½</span></span><br><span class="line">  <span class="attr">scene3DOnly</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// shouldAnimate: boolean</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ˜¯å¦å¯ç”¨åŠ¨ç”»</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">  <span class="comment">// ç”¨é€”: æ§åˆ¶æ—¶é—´åŠ¨ç”»çš„æ’­æ”¾</span></span><br><span class="line">  <span class="attr">shouldAnimate</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// clockViewModel: ClockViewModel</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ—¶é’Ÿè§†å›¾æ¨¡å‹</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: new ClockViewModel(clock)</span></span><br><span class="line">  <span class="comment">// ç”¨é€”: æ§åˆ¶æ—¶é—´å’ŒåŠ¨ç”»</span></span><br><span class="line">  <span class="attr">clockViewModel</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ClockViewModel</span>(<span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Clock</span>()),</span><br><span class="line"></span><br><span class="line">  <span class="comment">// selectedImageryProviderViewModel: ProviderViewModel</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: é»˜è®¤é€‰ä¸­çš„å½±åƒæä¾›è€…</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">  <span class="comment">// ç”¨é€”: è®¾ç½®åˆå§‹å½±åƒå›¾å±‚</span></span><br><span class="line">  <span class="attr">selectedImageryProviderViewModel</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// imageryProviderViewModels: ProviderViewModel[]</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: å¯ç”¨çš„å½±åƒæä¾›è€…åˆ—è¡¨</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: createDefaultImageryProviderViewModels()</span></span><br><span class="line">  <span class="comment">// ç”¨é€”: å›¾å±‚é€‰æ‹©å™¨ä¸­çš„é€‰é¡¹</span></span><br><span class="line">  <span class="attr">imageryProviderViewModels</span>: [],</span><br><span class="line"></span><br><span class="line">  <span class="comment">// selectedTerrainProviderViewModel: ProviderViewModel</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: é»˜è®¤é€‰ä¸­çš„åœ°å½¢æä¾›è€…</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">  <span class="comment">// ç”¨é€”: è®¾ç½®åˆå§‹åœ°å½¢</span></span><br><span class="line">  <span class="attr">selectedTerrainProviderViewModel</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// terrainProviderViewModels: ProviderViewModel[]</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: å¯ç”¨çš„åœ°å½¢æä¾›è€…åˆ—è¡¨</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: createDefaultTerrainProviderViewModels()</span></span><br><span class="line">  <span class="comment">// ç”¨é€”: åœ°å½¢é€‰æ‹©å™¨ä¸­çš„é€‰é¡¹</span></span><br><span class="line">  <span class="attr">terrainProviderViewModels</span>: [],</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === æ¸²æŸ“å™¨é€‰é¡¹ ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// imageryProvider: ImageryProvider | false</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: å½±åƒæä¾›è€…</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: createWorldImagery()</span></span><br><span class="line">  <span class="comment">// ç¦»çº¿è®¾ç½®: è‡ªå®šä¹‰ç¦»çº¿å½±åƒæˆ–false</span></span><br><span class="line">  <span class="attr">imageryProvider</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">OpenStreetMapImageryProvider</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;https://tile.openstreetmap.org/&#x27;</span>, <span class="comment">// æˆ–æœ¬åœ°ç“¦ç‰‡æœåŠ¡</span></span><br><span class="line">  &#125;),</span><br><span class="line"></span><br><span class="line">  <span class="comment">// terrainProvider: TerrainProvider</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: åœ°å½¢æä¾›è€…</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: new EllipsoidTerrainProvider()</span></span><br><span class="line">  <span class="comment">// ç¦»çº¿è®¾ç½®: EllipsoidTerrainProviderï¼ˆæ¤­çƒåœ°å½¢ï¼‰</span></span><br><span class="line">  <span class="attr">terrainProvider</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">EllipsoidTerrainProvider</span>(),</span><br><span class="line"></span><br><span class="line">  <span class="comment">// skyBox: SkyBox | false</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: å¤©ç©ºç›’</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: undefinedï¼ˆä½¿ç”¨é»˜è®¤å¤©ç©ºï¼‰</span></span><br><span class="line">  <span class="comment">// ç”¨é€”: è‡ªå®šä¹‰å¤©ç©ºèƒŒæ™¯</span></span><br><span class="line">  <span class="attr">skyBox</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">SkyBox</span>(&#123;</span><br><span class="line">    <span class="attr">sources</span>: &#123;</span><br><span class="line">      <span class="attr">positiveX</span>: <span class="string">&#x27;path/to/skybox_px.jpg&#x27;</span>,</span><br><span class="line">      <span class="attr">negativeX</span>: <span class="string">&#x27;path/to/skybox_nx.jpg&#x27;</span>,</span><br><span class="line">      <span class="attr">positiveY</span>: <span class="string">&#x27;path/to/skybox_py.jpg&#x27;</span>,</span><br><span class="line">      <span class="attr">negativeY</span>: <span class="string">&#x27;path/to/skybox_ny.jpg&#x27;</span>,</span><br><span class="line">      <span class="attr">positiveZ</span>: <span class="string">&#x27;path/to/skybox_pz.jpg&#x27;</span>,</span><br><span class="line">      <span class="attr">negativeZ</span>: <span class="string">&#x27;path/to/skybox_nz.jpg&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;),</span><br><span class="line"></span><br><span class="line">  <span class="comment">// skyAtmosphere: SkyAtmosphere | false</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: å¤©ç©ºå¤§æ°”æ•ˆæœ</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: undefinedï¼ˆä½¿ç”¨é»˜è®¤å¤§æ°”ï¼‰</span></span><br><span class="line">  <span class="comment">// ç”¨é€”: æ§åˆ¶å¤§æ°”æ•£å°„æ•ˆæœ</span></span><br><span class="line">  <span class="attr">skyAtmosphere</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">SkyAtmosphere</span>(),</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === é«˜çº§æ¸²æŸ“é€‰é¡¹ ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// shadows: boolean</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ˜¯å¦å¯ç”¨é˜´å½±</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">  <span class="comment">// æ€§èƒ½å½±å“: è¾ƒå¤§</span></span><br><span class="line">  <span class="attr">shadows</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// terrainShadows: ShadowMode</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: åœ°å½¢é˜´å½±æ¨¡å¼</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: ShadowMode.RECEIVE_ONLY</span></span><br><span class="line">  <span class="comment">// é€‰é¡¹: DISABLED, ENABLED, CAST_ONLY, RECEIVE_ONLY</span></span><br><span class="line">  <span class="attr">terrainShadows</span>: <span class="title class_">Cesium</span>.<span class="property">ShadowMode</span>.<span class="property">ENABLED</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mapMode2D: MapMode2D</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: 2Dåœ°å›¾æ¨¡å¼</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: MapMode2D.INFINITE_SCROLL</span></span><br><span class="line">  <span class="comment">// é€‰é¡¹: INFINITE_SCROLL, ROTATE</span></span><br><span class="line">  <span class="attr">mapMode2D</span>: <span class="title class_">Cesium</span>.<span class="property">MapMode2D</span>.<span class="property">INFINITE_SCROLL</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// projectionPicker: boolean</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æŠ•å½±é€‰æ‹©å™¨</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">  <span class="comment">// ç”¨é€”: åœ¨2Dæ¨¡å¼ä¸‹é€‰æ‹©æŠ•å½±æ–¹å¼</span></span><br><span class="line">  <span class="attr">projectionPicker</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// requestRenderMode: boolean</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æŒ‰éœ€æ¸²æŸ“æ¨¡å¼</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">  <span class="comment">// æ€§èƒ½ä¼˜åŒ–: åªåœ¨éœ€è¦æ—¶æ¸²æŸ“</span></span><br><span class="line">  <span class="attr">requestRenderMode</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// maximumRenderTimeChange: number</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æœ€å¤§æ¸²æŸ“æ—¶é—´å˜åŒ–ï¼ˆæ¯«ç§’ï¼‰</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: 0.0</span></span><br><span class="line">  <span class="comment">// ç”¨é€”: æ§åˆ¶æŒ‰éœ€æ¸²æŸ“çš„è§¦å‘é˜ˆå€¼</span></span><br><span class="line">  <span class="attr">maximumRenderTimeChange</span>: <span class="number">0.0</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === WebGLé€‰é¡¹ ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// contextOptions: Object</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: WebGLä¸Šä¸‹æ–‡é€‰é¡¹</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">  <span class="comment">// ç”¨é€”: æ§åˆ¶WebGLä¸Šä¸‹æ–‡åˆ›å»º</span></span><br><span class="line">  <span class="attr">contextOptions</span>: &#123;</span><br><span class="line">    <span class="attr">webgl</span>: &#123;</span><br><span class="line">      <span class="attr">alpha</span>: <span class="literal">false</span>, <span class="comment">// é€æ˜åº¦é€šé“</span></span><br><span class="line">      <span class="attr">depth</span>: <span class="literal">true</span>, <span class="comment">// æ·±åº¦ç¼“å†²</span></span><br><span class="line">      <span class="attr">stencil</span>: <span class="literal">false</span>, <span class="comment">// æ¨¡æ¿ç¼“å†²</span></span><br><span class="line">      <span class="attr">antialias</span>: <span class="literal">true</span>, <span class="comment">// æŠ—é”¯é½¿</span></span><br><span class="line">      <span class="attr">premultipliedAlpha</span>: <span class="literal">true</span>, <span class="comment">// é¢„ä¹˜alpha</span></span><br><span class="line">      <span class="attr">preserveDrawingBuffer</span>: <span class="literal">false</span>, <span class="comment">// ä¿ç•™ç»˜å›¾ç¼“å†²</span></span><br><span class="line">      <span class="attr">powerPreference</span>: <span class="string">&#x27;high-performance&#x27;</span>, <span class="comment">// æ€§èƒ½åå¥½</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// useDefaultRenderLoop: boolean</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ˜¯å¦ä½¿ç”¨é»˜è®¤æ¸²æŸ“å¾ªç¯</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">  <span class="comment">// é«˜çº§ç”¨é€”: è‡ªå®šä¹‰æ¸²æŸ“å¾ªç¯</span></span><br><span class="line">  <span class="attr">useDefaultRenderLoop</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// targetFrameRate: number</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: ç›®æ ‡å¸§ç‡</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">  <span class="comment">// æ€§èƒ½æ§åˆ¶: é™åˆ¶æ¸²æŸ“å¸§ç‡</span></span><br><span class="line">  <span class="attr">targetFrameRate</span>: <span class="number">60</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// showRenderLoopErrors: boolean</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºæ¸²æŸ“å¾ªç¯é”™è¯¯</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">  <span class="comment">// è°ƒè¯•ç”¨é€”: é”™è¯¯ä¿¡æ¯æ˜¾ç¤º</span></span><br><span class="line">  <span class="attr">showRenderLoopErrors</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// automaticallyTrackDataSourceClocks: boolean</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ˜¯å¦è‡ªåŠ¨è·Ÿè¸ªæ•°æ®æºæ—¶é’Ÿ</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">  <span class="comment">// æ—¶é—´æ§åˆ¶: æ•°æ®æºæ—¶é—´åŒæ­¥</span></span><br><span class="line">  <span class="attr">automaticallyTrackDataSourceClocks</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === è¾“å…¥æ§åˆ¶é€‰é¡¹ ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// enableCollisionDetection: boolean</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ˜¯å¦å¯ç”¨ç¢°æ’æ£€æµ‹</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">  <span class="comment">// ç”¨é€”: ç›¸æœºä¸åœ°å½¢çš„ç¢°æ’æ£€æµ‹</span></span><br><span class="line">  <span class="attr">enableCollisionDetection</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// useBrowserRecommendedResolution: boolean</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ˜¯å¦ä½¿ç”¨æµè§ˆå™¨æ¨èåˆ†è¾¨ç‡</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">  <span class="comment">// æ€§èƒ½å½±å“: é«˜åˆ†è¾¨ç‡æ˜¾ç¤ºå™¨çš„æ€§èƒ½</span></span><br><span class="line">  <span class="attr">useBrowserRecommendedResolution</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// orderIndependentTranslucency: boolean</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: é¡ºåºæ— å…³é€æ˜åº¦</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">  <span class="comment">// æ¸²æŸ“è´¨é‡: é€æ˜ç‰©ä½“çš„æ¸²æŸ“è´¨é‡</span></span><br><span class="line">  <span class="attr">orderIndependentTranslucency</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// creditContainer: Element | string</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: ç‰ˆæƒä¿¡æ¯å®¹å™¨</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">  <span class="comment">// ç”¨é€”: è‡ªå®šä¹‰ç‰ˆæƒä¿¡æ¯æ˜¾ç¤ºä½ç½®</span></span><br><span class="line">  <span class="attr">creditContainer</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// creditViewport: Element | string</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: ç‰ˆæƒä¿¡æ¯è§†å£</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">  <span class="comment">// ç”¨é€”: ç‰ˆæƒä¿¡æ¯çš„æ˜¾ç¤ºåŒºåŸŸ</span></span><br><span class="line">  <span class="attr">creditViewport</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// dataSources: DataSourceCollection</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ•°æ®æºé›†åˆ</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: new DataSourceCollection()</span></span><br><span class="line">  <span class="comment">// ç”¨é€”: é¢„è®¾çš„æ•°æ®æº</span></span><br><span class="line">  <span class="attr">dataSources</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">DataSourceCollection</span>(),</span><br><span class="line"></span><br><span class="line">  <span class="comment">// clock: Clock</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ—¶é’Ÿå¯¹è±¡</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: new Clock()</span></span><br><span class="line">  <span class="comment">// æ—¶é—´æ§åˆ¶: åœºæ™¯æ—¶é—´ç®¡ç†</span></span><br><span class="line">  <span class="attr">clock</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Clock</span>(),</span><br><span class="line"></span><br><span class="line">  <span class="comment">// blurActiveElementOnCanvasFocus: boolean</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: ç”»å¸ƒè·å¾—ç„¦ç‚¹æ—¶æ˜¯å¦æ¨¡ç³Šæ´»åŠ¨å…ƒç´ </span></span><br><span class="line">  <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">  <span class="comment">// UIæ§åˆ¶: ç„¦ç‚¹ç®¡ç†</span></span><br><span class="line">  <span class="attr">blurActiveElementOnCanvasFocus</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// msaaSamples: number</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: MSAAé‡‡æ ·æ•°é‡</span></span><br><span class="line">  <span class="comment">// é»˜è®¤: 1</span></span><br><span class="line">  <span class="comment">// æŠ—é”¯é½¿: å¤šé‡é‡‡æ ·æŠ—é”¯é½¿</span></span><br><span class="line">  <span class="attr">msaaSamples</span>: <span class="number">4</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="åæ ‡ç³»ç»Ÿè¯¦è§£"><a href="#åæ ‡ç³»ç»Ÿè¯¦è§£" class="headerlink" title="åæ ‡ç³»ç»Ÿè¯¦è§£"></a>åæ ‡ç³»ç»Ÿè¯¦è§£</h2><h3 id="Cartesian3-ç¬›å¡å°”åæ ‡ç³»"><a href="#Cartesian3-ç¬›å¡å°”åæ ‡ç³»" class="headerlink" title="Cartesian3 ç¬›å¡å°”åæ ‡ç³»"></a>Cartesian3 ç¬›å¡å°”åæ ‡ç³»</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cartesian3 - 3Dç¬›å¡å°”åæ ‡</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Cartesian3</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">x = <span class="number">0.0</span>, y = <span class="number">0.0</span>, z = <span class="number">0.0</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">x</span> = x <span class="comment">// Xè½´åæ ‡ï¼ˆç±³ï¼‰</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">y</span> = y <span class="comment">// Yè½´åæ ‡ï¼ˆç±³ï¼‰</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">z</span> = z <span class="comment">// Zè½´åæ ‡ï¼ˆç±³ï¼‰</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é™æ€æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromDegrees - ä»ç»çº¬åº¦åˆ›å»º</span></span><br><span class="line">  <span class="comment">// longitude: ç»åº¦ï¼ˆåº¦ï¼‰</span></span><br><span class="line">  <span class="comment">// latitude: çº¬åº¦ï¼ˆåº¦ï¼‰</span></span><br><span class="line">  <span class="comment">// height: é«˜åº¦ï¼ˆç±³ï¼Œå¯é€‰ï¼Œé»˜è®¤0ï¼‰</span></span><br><span class="line">  <span class="comment">// ellipsoid: æ¤­çƒä½“ï¼ˆå¯é€‰ï¼Œé»˜è®¤WGS84ï¼‰</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromDegrees</span>(<span class="params">longitude, latitude, height = <span class="number">0</span>, ellipsoid = Cesium.Ellipsoid.WGS84</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(longitude, latitude, height, ellipsoid)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromRadians - ä»å¼§åº¦åˆ›å»º</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromRadians</span>(<span class="params">longitude, latitude, height = <span class="number">0</span>, ellipsoid = Cesium.Ellipsoid.WGS84</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromRadians</span>(longitude, latitude, height, ellipsoid)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromDegreesArray - ä»ç»çº¬åº¦æ•°ç»„åˆ›å»º</span></span><br><span class="line">  <span class="comment">// coordinates: [lon1, lat1, lon2, lat2, ...]</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromDegreesArray</span>(<span class="params">coordinates, ellipsoid = Cesium.Ellipsoid.WGS84</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegreesArray</span>(coordinates, ellipsoid)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromDegreesArrayHeights - ä»ç»çº¬åº¦é«˜åº¦æ•°ç»„åˆ›å»º</span></span><br><span class="line">  <span class="comment">// coordinates: [lon1, lat1, height1, lon2, lat2, height2, ...]</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromDegreesArrayHeights</span>(<span class="params">coordinates, ellipsoid = Cesium.Ellipsoid.WGS84</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegreesArrayHeights</span>(coordinates, ellipsoid)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å®ä¾‹æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// clone - å…‹éš†</span></span><br><span class="line">  <span class="title function_">clone</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">clone</span>(<span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// equals - æ¯”è¾ƒç›¸ç­‰</span></span><br><span class="line">  <span class="title function_">equals</span>(<span class="params">other</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">equals</span>(<span class="variable language_">this</span>, other)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// distance - è®¡ç®—è·ç¦»</span></span><br><span class="line">  <span class="title function_">distanceTo</span>(<span class="params">other</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">distance</span>(<span class="variable language_">this</span>, other)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// normalize - æ ‡å‡†åŒ–</span></span><br><span class="line">  <span class="title function_">normalize</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">normalize</span>(<span class="variable language_">this</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// magnitude - è®¡ç®—å‘é‡é•¿åº¦</span></span><br><span class="line">  <span class="title function_">magnitude</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">magnitude</span>(<span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// add - å‘é‡åŠ æ³•</span></span><br><span class="line">  <span class="title function_">add</span>(<span class="params">other</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">add</span>(<span class="variable language_">this</span>, other, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// subtract - å‘é‡å‡æ³•</span></span><br><span class="line">  <span class="title function_">subtract</span>(<span class="params">other</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">subtract</span>(<span class="variable language_">this</span>, other, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// multiplyByScalar - æ ‡é‡ä¹˜æ³•</span></span><br><span class="line">  <span class="title function_">multiplyByScalar</span>(<span class="params">scalar</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">multiplyByScalar</span>(<span class="variable language_">this</span>, scalar, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// dot - ç‚¹ç§¯</span></span><br><span class="line">  <span class="title function_">dot</span>(<span class="params">other</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">dot</span>(<span class="variable language_">this</span>, other)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cross - å‰ç§¯</span></span><br><span class="line">  <span class="title function_">cross</span>(<span class="params">other</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">cross</span>(<span class="variable language_">this</span>, other, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> position = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">1000000</span>, <span class="number">2000000</span>, <span class="number">3000000</span>)</span><br><span class="line"><span class="keyword">const</span> beijingPosition = <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">const</span> positions = <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegreesArray</span>([</span><br><span class="line">  <span class="number">116.4074</span>,</span><br><span class="line">  <span class="number">39.9042</span>, <span class="comment">// åŒ—äº¬</span></span><br><span class="line">  <span class="number">121.4737</span>,</span><br><span class="line">  <span class="number">31.2304</span>, <span class="comment">// ä¸Šæµ·</span></span><br><span class="line">  <span class="number">113.2644</span>,</span><br><span class="line">  <span class="number">23.1291</span>, <span class="comment">// å¹¿å·</span></span><br><span class="line">])</span><br></pre></td></tr></table></figure><h3 id="Cartographic-åœ°ç†åæ ‡ç³»"><a href="#Cartographic-åœ°ç†åæ ‡ç³»" class="headerlink" title="Cartographic åœ°ç†åæ ‡ç³»"></a>Cartographic åœ°ç†åæ ‡ç³»</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cartographic - åœ°ç†åæ ‡ï¼ˆç»çº¬åº¦ï¼‰</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Cartographic</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">longitude = <span class="number">0.0</span>, latitude = <span class="number">0.0</span>, height = <span class="number">0.0</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">longitude</span> = longitude <span class="comment">// ç»åº¦ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">latitude</span> = latitude <span class="comment">// çº¬åº¦ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">height</span> = height <span class="comment">// é«˜åº¦ï¼ˆç±³ï¼‰</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é™æ€æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromDegrees - ä»åº¦æ•°åˆ›å»º</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromDegrees</span>(<span class="params">longitude, latitude, height = <span class="number">0.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartographic</span>(</span><br><span class="line">      <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(longitude),</span><br><span class="line">      <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(latitude),</span><br><span class="line">      height,</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromRadians - ä»å¼§åº¦åˆ›å»º</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromRadians</span>(<span class="params">longitude, latitude, height = <span class="number">0.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartographic</span>(longitude, latitude, height)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromCartesian - ä»ç¬›å¡å°”åæ ‡åˆ›å»º</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromCartesian</span>(<span class="params">cartesian, ellipsoid = Cesium.Ellipsoid.WGS84</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromCartesian</span>(cartesian, ellipsoid)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å®ä¾‹æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// toLongitudeLatitude - è½¬æ¢ä¸ºç»çº¬åº¦ï¼ˆåº¦ï¼‰</span></span><br><span class="line">  <span class="title function_">toLongitudeLatitude</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">longitude</span>: <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(<span class="variable language_">this</span>.<span class="property">longitude</span>),</span><br><span class="line">      <span class="attr">latitude</span>: <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(<span class="variable language_">this</span>.<span class="property">latitude</span>),</span><br><span class="line">      <span class="attr">height</span>: <span class="variable language_">this</span>.<span class="property">height</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// clone - å…‹éš†</span></span><br><span class="line">  <span class="title function_">clone</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">clone</span>(<span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// equals - æ¯”è¾ƒç›¸ç­‰</span></span><br><span class="line">  <span class="title function_">equals</span>(<span class="params">other</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">equals</span>(<span class="variable language_">this</span>, other)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> cartographic = <span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">const</span> cartesian = <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">const</span> backToCartographic = <span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromCartesian</span>(cartesian)</span><br></pre></td></tr></table></figure><h3 id="Matrix4-å˜æ¢çŸ©é˜µ"><a href="#Matrix4-å˜æ¢çŸ©é˜µ" class="headerlink" title="Matrix4 å˜æ¢çŸ©é˜µ"></a>Matrix4 å˜æ¢çŸ©é˜µ</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Matrix4 - 4x4å˜æ¢çŸ©é˜µ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Matrix4</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 16ä¸ªå…ƒç´ çš„æ•°ç»„ï¼ŒæŒ‰åˆ—ä¼˜å…ˆå­˜å‚¨</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">elements</span> = [</span><br><span class="line">      <span class="number">1</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">0</span>, <span class="comment">// ç¬¬ä¸€åˆ—</span></span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">1</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">0</span>, <span class="comment">// ç¬¬äºŒåˆ—</span></span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">1</span>,</span><br><span class="line">      <span class="number">0</span>, <span class="comment">// ç¬¬ä¸‰åˆ—</span></span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">1</span>, <span class="comment">// ç¬¬å››åˆ—</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é™æ€åˆ›å»ºæ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// IDENTITY - å•ä½çŸ©é˜µ</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">IDENTITY</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Matrix4</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromTranslation - ä»å¹³ç§»åˆ›å»º</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromTranslation</span>(<span class="params">translation</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">fromTranslation</span>(translation)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromScale - ä»ç¼©æ”¾åˆ›å»º</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromScale</span>(<span class="params">scale</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">fromScale</span>(scale)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromRotationTranslation - ä»æ—‹è½¬å’Œå¹³ç§»åˆ›å»º</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromRotationTranslation</span>(<span class="params">rotation, translation</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">fromRotationTranslation</span>(rotation, translation)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å˜æ¢æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// multiplyByPoint - ä¹˜ä»¥ç‚¹</span></span><br><span class="line">  <span class="title function_">multiplyByPoint</span>(<span class="params">point</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">multiplyByPoint</span>(<span class="variable language_">this</span>, point, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// multiplyByVector - ä¹˜ä»¥å‘é‡</span></span><br><span class="line">  <span class="title function_">multiplyByVector</span>(<span class="params">vector</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">multiplyByVector</span>(<span class="variable language_">this</span>, vector, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian4</span>())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// multiply - çŸ©é˜µä¹˜æ³•</span></span><br><span class="line">  <span class="title function_">multiply</span>(<span class="params">other</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">multiply</span>(<span class="variable language_">this</span>, other, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Matrix4</span>())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// inverse - æ±‚é€†çŸ©é˜µ</span></span><br><span class="line">  <span class="title function_">inverse</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">inverse</span>(<span class="variable language_">this</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Matrix4</span>())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// transpose - è½¬ç½®</span></span><br><span class="line">  <span class="title function_">transpose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">transpose</span>(<span class="variable language_">this</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Matrix4</span>())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> translation = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">100</span>, <span class="number">200</span>, <span class="number">300</span>)</span><br><span class="line"><span class="keyword">const</span> translationMatrix = <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">fromTranslation</span>(translation)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> scale = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line"><span class="keyword">const</span> scaleMatrix = <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">fromScale</span>(scale)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rotation = <span class="title class_">Cesium</span>.<span class="property">Matrix3</span>.<span class="title function_">fromRotationZ</span>(<span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(<span class="number">45</span>))</span><br><span class="line"><span class="keyword">const</span> rotationMatrix = <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">fromRotation</span>(rotation)</span><br></pre></td></tr></table></figure><h2 id="å®ä½“ç³»ç»Ÿå®Œæ•´å±æ€§"><a href="#å®ä½“ç³»ç»Ÿå®Œæ•´å±æ€§" class="headerlink" title="å®ä½“ç³»ç»Ÿå®Œæ•´å±æ€§"></a>å®ä½“ç³»ç»Ÿå®Œæ•´å±æ€§</h2><h3 id="Entity-åŸºç¡€å®ä½“"><a href="#Entity-åŸºç¡€å®ä½“" class="headerlink" title="Entity åŸºç¡€å®ä½“"></a>Entity åŸºç¡€å®ä½“</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Entity - åŸºç¡€å®ä½“ç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Entity</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// === åŸºç¡€å±æ€§ ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// id: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å®ä½“çš„å”¯ä¸€æ ‡è¯†ç¬¦</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: è‡ªåŠ¨ç”ŸæˆUUID</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: æŸ¥æ‰¾ã€æ›´æ–°ã€åˆ é™¤å®ä½“</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = options.<span class="property">id</span> || <span class="title class_">Cesium</span>.<span class="title function_">createGuid</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// name: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å®ä½“çš„æ˜¾ç¤ºåç§°</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: InfoBoxæ ‡é¢˜ã€æ ‡ç­¾æ–‡æœ¬</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = options.<span class="property">name</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// availability: TimeIntervalCollection</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å®ä½“çš„å¯ç”¨æ—¶é—´é—´éš”</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefinedï¼ˆå§‹ç»ˆå¯ç”¨ï¼‰</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: æ—¶é—´åŠ¨ç”»ä¸­çš„æ˜¾ç¤ºæ§åˆ¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">availability</span> = options.<span class="property">availability</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// show: boolean | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ§åˆ¶å®ä½“çš„å¯è§æ€§</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: æ˜¾ç¤º/éšè—å®ä½“</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// description: string | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å®ä½“çš„æè¿°ä¿¡æ¯</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: InfoBoxçš„å†…å®¹</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">description</span> = options.<span class="property">description</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// position: PositionProperty</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å®ä½“çš„ä½ç½®</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="comment">// ç±»å‹: Cartesian3 | PositionProperty</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">position</span> = options.<span class="property">position</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// orientation: Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å®ä½“çš„æ–¹å‘ï¼ˆå››å…ƒæ•°ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="comment">// ç±»å‹: Quaternion | Property</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">orientation</span> = options.<span class="property">orientation</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// viewFrom: Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç›¸æœºè§‚å¯Ÿå®ä½“æ—¶çš„ç›¸å¯¹ä½ç½®</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="comment">// ç±»å‹: Cartesian3 | Property</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewFrom</span> = options.<span class="property">viewFrom</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// parent: Entity</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: çˆ¶å®ä½“ï¼ˆç”¨äºå±‚æ¬¡ç»“æ„ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: å®ä½“çš„çˆ¶å­å…³ç³»</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">parent</span> = options.<span class="property">parent</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// === å›¾å½¢å±æ€§ ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// billboard: BillboardGraphics</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¹¿å‘Šç‰Œå›¾å½¢</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">billboard</span> = options.<span class="property">billboard</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// box: BoxGraphics</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç›’å­å›¾å½¢</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">box</span> = options.<span class="property">box</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// corridor: CorridorGraphics</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: èµ°å»Šå›¾å½¢</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">corridor</span> = options.<span class="property">corridor</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// cylinder: CylinderGraphics</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åœ†æŸ±ä½“å›¾å½¢</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cylinder</span> = options.<span class="property">cylinder</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ellipse: EllipseGraphics</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ¤­åœ†å›¾å½¢</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ellipse</span> = options.<span class="property">ellipse</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ellipsoid: EllipsoidGraphics</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ¤­çƒä½“å›¾å½¢</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ellipsoid</span> = options.<span class="property">ellipsoid</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// label: LabelGraphics</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ ‡ç­¾å›¾å½¢</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">label</span> = options.<span class="property">label</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// model: ModelGraphics</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: 3Dæ¨¡å‹å›¾å½¢</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">model</span> = options.<span class="property">model</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// tileset: Cesium3DTilesetGraphics</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: 3Dç“¦ç‰‡é›†å›¾å½¢</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tileset</span> = options.<span class="property">tileset</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// path: PathGraphics</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è·¯å¾„å›¾å½¢</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">path</span> = options.<span class="property">path</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// plane: PlaneGraphics</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¹³é¢å›¾å½¢</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">plane</span> = options.<span class="property">plane</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// point: PointGraphics</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç‚¹å›¾å½¢</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">point</span> = options.<span class="property">point</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// polygon: PolygonGraphics</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¤šè¾¹å½¢å›¾å½¢</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">polygon</span> = options.<span class="property">polygon</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// polyline: PolylineGraphics</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¤šæ®µçº¿å›¾å½¢</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">polyline</span> = options.<span class="property">polyline</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// polylineVolume: PolylineVolumeGraphics</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¤šæ®µçº¿ä½“ç§¯å›¾å½¢</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">polylineVolume</span> = options.<span class="property">polylineVolume</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// rectangle: RectangleGraphics</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: çŸ©å½¢å›¾å½¢</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">rectangle</span> = options.<span class="property">rectangle</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// wall: WallGraphics</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¢™ä½“å›¾å½¢</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">wall</span> = options.<span class="property">wall</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === æ–¹æ³• ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// computeModelMatrix - è®¡ç®—æ¨¡å‹çŸ©é˜µ</span></span><br><span class="line">  <span class="comment">// time: JulianDate - æ—¶é—´</span></span><br><span class="line">  <span class="comment">// result: Matrix4 - ç»“æœçŸ©é˜µ</span></span><br><span class="line">  <span class="title function_">computeModelMatrix</span>(<span class="params">time, result</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Entity</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">computeModelMatrix</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>, time, result)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// isShowing - æ˜¯å¦æ­£åœ¨æ˜¾ç¤º</span></span><br><span class="line">  <span class="comment">// time: JulianDate - æ—¶é—´</span></span><br><span class="line">  <span class="title function_">isShowing</span>(<span class="params">time</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">show</span> &amp;&amp; (!<span class="variable language_">this</span>.<span class="property">availability</span> || <span class="variable language_">this</span>.<span class="property">availability</span>.<span class="title function_">contains</span>(time))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// isAvailable - æ˜¯å¦å¯ç”¨</span></span><br><span class="line">  <span class="comment">// time: JulianDate - æ—¶é—´</span></span><br><span class="line">  <span class="title function_">isAvailable</span>(<span class="params">time</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> !<span class="variable language_">this</span>.<span class="property">availability</span> || <span class="variable language_">this</span>.<span class="property">availability</span>.<span class="title function_">contains</span>(time)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºå®ä½“ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> entity = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Entity</span>(&#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="string">&#x27;beijing-marker&#x27;</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;åŒ—äº¬æ ‡è®°&#x27;</span>,</span><br><span class="line">  <span class="attr">description</span>: <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div style=&quot;padding: 10px;&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;h3&gt;åŒ—äº¬å¸‚&lt;/h3&gt;</span></span><br><span class="line"><span class="string">      &lt;p&gt;ä¸­åäººæ°‘å…±å’Œå›½é¦–éƒ½&lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;p&gt;äººå£: 2154ä¸‡&lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;p&gt;é¢ç§¯: 16410.54å¹³æ–¹å…¬é‡Œ&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">0</span>),</span><br><span class="line">  <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">availability</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeIntervalCollection</span>([</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeInterval</span>(&#123;</span><br><span class="line">      <span class="attr">start</span>: <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&#x27;2023-01-01&#x27;</span>)),</span><br><span class="line">      <span class="attr">stop</span>: <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&#x27;2024-12-31&#x27;</span>)),</span><br><span class="line">    &#125;),</span><br><span class="line">  ]),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="BillboardGraphics-å¹¿å‘Šç‰Œå›¾å½¢"><a href="#BillboardGraphics-å¹¿å‘Šç‰Œå›¾å½¢" class="headerlink" title="BillboardGraphics å¹¿å‘Šç‰Œå›¾å½¢"></a>BillboardGraphics å¹¿å‘Šç‰Œå›¾å½¢</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BillboardGraphics - å¹¿å‘Šç‰Œå›¾å½¢</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BillboardGraphics</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// show: boolean | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ§åˆ¶å¹¿å‘Šç‰Œçš„å¯è§æ€§</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// image: string | HTMLCanvasElement | HTMLVideoElement | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¹¿å‘Šç‰Œçš„å›¾åƒ</span></span><br><span class="line">    <span class="comment">// æ”¯æŒ: URLã€Canvasã€Videoã€Data URL</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">image</span> = options.<span class="property">image</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// scale: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¹¿å‘Šç‰Œçš„ç¼©æ”¾æ¯”ä¾‹</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">    <span class="comment">// èŒƒå›´: 0.0 - ä»»æ„æ­£æ•°</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scale</span> = options.<span class="property">scale</span> !== <span class="literal">undefined</span> ? options.<span class="property">scale</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// pixelOffset: Cartesian2 | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åƒç´ åç§»é‡</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Cartesian2.ZERO</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: å¾®è°ƒå¹¿å‘Šç‰Œä½ç½®</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pixelOffset</span> = options.<span class="property">pixelOffset</span> || <span class="title class_">Cesium</span>.<span class="property">Cartesian2</span>.<span class="property">ZERO</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// eyeOffset: Cartesian3 | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: çœ¼éƒ¨åç§»é‡ï¼ˆç›¸æœºç©ºé—´ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Cartesian3.ZERO</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: æ·±åº¦æ§åˆ¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">eyeOffset</span> = options.<span class="property">eyeOffset</span> || <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="property">ZERO</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// horizontalOrigin: HorizontalOrigin | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ°´å¹³å¯¹é½æ–¹å¼</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: HorizontalOrigin.CENTER</span></span><br><span class="line">    <span class="comment">// é€‰é¡¹: LEFT, CENTER, RIGHT</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">horizontalOrigin</span> = options.<span class="property">horizontalOrigin</span> || <span class="title class_">Cesium</span>.<span class="property">HorizontalOrigin</span>.<span class="property">CENTER</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// verticalOrigin: VerticalOrigin | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å‚ç›´å¯¹é½æ–¹å¼</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: VerticalOrigin.CENTER</span></span><br><span class="line">    <span class="comment">// é€‰é¡¹: BOTTOM, BASELINE, CENTER, TOP</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">verticalOrigin</span> = options.<span class="property">verticalOrigin</span> || <span class="title class_">Cesium</span>.<span class="property">VerticalOrigin</span>.<span class="property">CENTER</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// heightReference: HeightReference | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é«˜åº¦å‚è€ƒ</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: HeightReference.NONE</span></span><br><span class="line">    <span class="comment">// é€‰é¡¹: NONE, CLAMP_TO_GROUND, RELATIVE_TO_GROUND</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">heightReference</span> = options.<span class="property">heightReference</span> || <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">NONE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// color: Color | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¹¿å‘Šç‰Œé¢œè‰²ï¼ˆä¸å›¾åƒæ··åˆï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Color.WHITE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">color</span> = options.<span class="property">color</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// rotation: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ—‹è½¬è§’åº¦ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 0.0</span></span><br><span class="line">    <span class="comment">// æ­£å€¼: é€†æ—¶é’ˆæ—‹è½¬</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">rotation</span> = options.<span class="property">rotation</span> !== <span class="literal">undefined</span> ? options.<span class="property">rotation</span> : <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// alignedAxis: Cartesian3 | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¯¹é½è½´</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Cartesian3.ZEROï¼ˆè‡ªåŠ¨å¯¹é½åˆ°å±å¹•ï¼‰</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: å›ºå®šå¹¿å‘Šç‰Œçš„æ—‹è½¬è½´</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">alignedAxis</span> = options.<span class="property">alignedAxis</span> || <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="property">ZERO</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// sizeInMeters: boolean | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦ä»¥ç±³ä¸ºå•ä½è®¡ç®—å°ºå¯¸</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: falseï¼ˆä»¥åƒç´ ä¸ºå•ä½ï¼‰</span></span><br><span class="line">    <span class="comment">// true: å¹¿å‘Šç‰Œå¤§å°ä¸éšè·ç¦»å˜åŒ–</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sizeInMeters</span> = options.<span class="property">sizeInMeters</span> !== <span class="literal">undefined</span> ? options.<span class="property">sizeInMeters</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// width: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¹¿å‘Šç‰Œå®½åº¦</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefinedï¼ˆä½¿ç”¨å›¾åƒå®½åº¦ï¼‰</span></span><br><span class="line">    <span class="comment">// å•ä½: åƒç´ æˆ–ç±³ï¼ˆå–å†³äºsizeInMetersï¼‰</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">width</span> = options.<span class="property">width</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// height: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¹¿å‘Šç‰Œé«˜åº¦</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefinedï¼ˆä½¿ç”¨å›¾åƒé«˜åº¦ï¼‰</span></span><br><span class="line">    <span class="comment">// å•ä½: åƒç´ æˆ–ç±³ï¼ˆå–å†³äºsizeInMetersï¼‰</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">height</span> = options.<span class="property">height</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// scaleByDistance: NearFarScalar | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åŸºäºè·ç¦»çš„ç¼©æ”¾</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: LODæ•ˆæœ</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scaleByDistance</span> = options.<span class="property">scaleByDistance</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// translucencyByDistance: NearFarScalar | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åŸºäºè·ç¦»çš„é€æ˜åº¦</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: æ¸éšæ•ˆæœ</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">translucencyByDistance</span> = options.<span class="property">translucencyByDistance</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// pixelOffsetScaleByDistance: NearFarScalar | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åŸºäºè·ç¦»çš„åƒç´ åç§»ç¼©æ”¾</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pixelOffsetScaleByDistance</span> = options.<span class="property">pixelOffsetScaleByDistance</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// imageSubRegion: BoundingRectangle | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å›¾åƒå­åŒºåŸŸ</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefinedï¼ˆä½¿ç”¨æ•´ä¸ªå›¾åƒï¼‰</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: çº¹ç†å›¾é›†</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">imageSubRegion</span> = options.<span class="property">imageSubRegion</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// distanceDisplayCondition: DistanceDisplayCondition | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è·ç¦»æ˜¾ç¤ºæ¡ä»¶</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: åŸºäºè·ç¦»çš„æ˜¾ç¤º/éšè—</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">distanceDisplayCondition</span> = options.<span class="property">distanceDisplayCondition</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// disableDepthTestDistance: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç¦ç”¨æ·±åº¦æµ‹è¯•çš„è·ç¦»</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 0.0</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: é˜²æ­¢å¹¿å‘Šç‰Œè¢«åœ°å½¢é®æŒ¡</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">disableDepthTestDistance</span> =</span><br><span class="line">      options.<span class="property">disableDepthTestDistance</span> !== <span class="literal">undefined</span> ? options.<span class="property">disableDepthTestDistance</span> : <span class="number">0.0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> billboardEntity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>),</span><br><span class="line">  <span class="attr">billboard</span>: &#123;</span><br><span class="line">    <span class="attr">image</span>:</span><br><span class="line">      <span class="string">&#x27;data:image/svg+xml;base64,&#x27;</span> +</span><br><span class="line">      <span class="title function_">btoa</span>(<span class="string">`</span></span><br><span class="line"><span class="string">      &lt;svg width=&quot;32&quot; height=&quot;40&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;path d=&quot;M16 0C7.2 0 0 7.2 0 16c0 8.8 16 24 16 24s16-15.2 16-24C32 7.2 24.8 0 16 0z&quot; fill=&quot;#E53E3E&quot;/&gt;</span></span><br><span class="line"><span class="string">        &lt;circle cx=&quot;16&quot; cy=&quot;16&quot; r=&quot;8&quot; fill=&quot;#FFF&quot;/&gt;</span></span><br><span class="line"><span class="string">        &lt;text x=&quot;16&quot; y=&quot;20&quot; text-anchor=&quot;middle&quot; fill=&quot;#E53E3E&quot; font-size=&quot;8&quot;&gt;1&lt;/text&gt;</span></span><br><span class="line"><span class="string">      &lt;/svg&gt;</span></span><br><span class="line"><span class="string">    `</span>),</span><br><span class="line">    <span class="attr">scale</span>: <span class="number">1.5</span>,</span><br><span class="line">    <span class="attr">verticalOrigin</span>: <span class="title class_">Cesium</span>.<span class="property">VerticalOrigin</span>.<span class="property">BOTTOM</span>,</span><br><span class="line">    <span class="attr">heightReference</span>: <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">CLAMP_TO_GROUND</span>,</span><br><span class="line">    <span class="attr">scaleByDistance</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">NearFarScalar</span>(<span class="number">1.5e2</span>, <span class="number">2.0</span>, <span class="number">1.5e7</span>, <span class="number">0.5</span>),</span><br><span class="line">    <span class="attr">distanceDisplayCondition</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">DistanceDisplayCondition</span>(<span class="number">0</span>, <span class="number">1.5e7</span>),</span><br><span class="line">    <span class="attr">disableDepthTestDistance</span>: <span class="title class_">Number</span>.<span class="property">POSITIVE_INFINITY</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="PointGraphics-ç‚¹å›¾å½¢"><a href="#PointGraphics-ç‚¹å›¾å½¢" class="headerlink" title="PointGraphics ç‚¹å›¾å½¢"></a>PointGraphics ç‚¹å›¾å½¢</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PointGraphics - ç‚¹å›¾å½¢</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PointGraphics</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// show: boolean | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ§åˆ¶ç‚¹çš„å¯è§æ€§</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// pixelSize: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç‚¹çš„åƒç´ å¤§å°</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1</span></span><br><span class="line">    <span class="comment">// èŒƒå›´: 1 - ç¡¬ä»¶é™åˆ¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pixelSize</span> = options.<span class="property">pixelSize</span> !== <span class="literal">undefined</span> ? options.<span class="property">pixelSize</span> : <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// heightReference: HeightReference | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é«˜åº¦å‚è€ƒ</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: HeightReference.NONE</span></span><br><span class="line">    <span class="comment">// é€‰é¡¹: NONE, CLAMP_TO_GROUND, RELATIVE_TO_GROUND</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">heightReference</span> = options.<span class="property">heightReference</span> || <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">NONE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// color: Color | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç‚¹çš„é¢œè‰²</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Color.WHITE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">color</span> = options.<span class="property">color</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// outlineColor: Color | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç‚¹çš„è½®å»“é¢œè‰²</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Color.BLACK</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outlineColor</span> = options.<span class="property">outlineColor</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// outlineWidth: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è½®å»“å®½åº¦</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 0</span></span><br><span class="line">    <span class="comment">// èŒƒå›´: 0 - ç¡¬ä»¶é™åˆ¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outlineWidth</span> = options.<span class="property">outlineWidth</span> !== <span class="literal">undefined</span> ? options.<span class="property">outlineWidth</span> : <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// scaleByDistance: NearFarScalar | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åŸºäºè·ç¦»çš„ç¼©æ”¾</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scaleByDistance</span> = options.<span class="property">scaleByDistance</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// translucencyByDistance: NearFarScalar | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åŸºäºè·ç¦»çš„é€æ˜åº¦</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">translucencyByDistance</span> = options.<span class="property">translucencyByDistance</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// distanceDisplayCondition: DistanceDisplayCondition | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è·ç¦»æ˜¾ç¤ºæ¡ä»¶</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">distanceDisplayCondition</span> = options.<span class="property">distanceDisplayCondition</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// disableDepthTestDistance: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç¦ç”¨æ·±åº¦æµ‹è¯•çš„è·ç¦»</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 0.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">disableDepthTestDistance</span> =</span><br><span class="line">      options.<span class="property">disableDepthTestDistance</span> !== <span class="literal">undefined</span> ? options.<span class="property">disableDepthTestDistance</span> : <span class="number">0.0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> pointEntity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>),</span><br><span class="line">  <span class="attr">point</span>: &#123;</span><br><span class="line">    <span class="attr">pixelSize</span>: <span class="number">15</span>,</span><br><span class="line">    <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>,</span><br><span class="line">    <span class="attr">outlineColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>,</span><br><span class="line">    <span class="attr">outlineWidth</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">heightReference</span>: <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">CLAMP_TO_GROUND</span>,</span><br><span class="line">    <span class="attr">scaleByDistance</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">NearFarScalar</span>(<span class="number">1.5e2</span>, <span class="number">3.0</span>, <span class="number">1.5e7</span>, <span class="number">0.5</span>),</span><br><span class="line">    <span class="attr">distanceDisplayCondition</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">DistanceDisplayCondition</span>(<span class="number">0</span>, <span class="number">2.0e6</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="LabelGraphics-æ ‡ç­¾å›¾å½¢"><a href="#LabelGraphics-æ ‡ç­¾å›¾å½¢" class="headerlink" title="LabelGraphics æ ‡ç­¾å›¾å½¢"></a>LabelGraphics æ ‡ç­¾å›¾å½¢</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LabelGraphics - æ ‡ç­¾å›¾å½¢</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LabelGraphics</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// show: boolean | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ§åˆ¶æ ‡ç­¾çš„å¯è§æ€§</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// text: string | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ ‡ç­¾æ–‡æœ¬</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="comment">// æ”¯æŒ: æ™®é€šæ–‡æœ¬ã€HTMLå®ä½“</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">text</span> = options.<span class="property">text</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// font: string | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å­—ä½“æ ·å¼</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: &#x27;30px sans-serif&#x27;</span></span><br><span class="line">    <span class="comment">// æ ¼å¼: CSSå­—ä½“æ ¼å¼</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">font</span> = options.<span class="property">font</span> || <span class="string">&#x27;30px sans-serif&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// style: LabelStyle | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ ‡ç­¾æ ·å¼</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: LabelStyle.FILL</span></span><br><span class="line">    <span class="comment">// é€‰é¡¹: FILL, OUTLINE, FILL_AND_OUTLINE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = options.<span class="property">style</span> || <span class="title class_">Cesium</span>.<span class="property">LabelStyle</span>.<span class="property">FILL</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// scale: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ ‡ç­¾ç¼©æ”¾æ¯”ä¾‹</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scale</span> = options.<span class="property">scale</span> !== <span class="literal">undefined</span> ? options.<span class="property">scale</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// showBackground: boolean | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºèƒŒæ™¯</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">showBackground</span> = options.<span class="property">showBackground</span> !== <span class="literal">undefined</span> ? options.<span class="property">showBackground</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// backgroundColor: Color | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: èƒŒæ™¯é¢œè‰²</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Color(0.165, 0.165, 0.165, 0.8)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">backgroundColor</span> = options.<span class="property">backgroundColor</span> || <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Color</span>(<span class="number">0.165</span>, <span class="number">0.165</span>, <span class="number">0.165</span>, <span class="number">0.8</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// backgroundPadding: Cartesian2 | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: èƒŒæ™¯å†…è¾¹è·ï¼ˆåƒç´ ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Cartesian2(7, 5)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">backgroundPadding</span> = options.<span class="property">backgroundPadding</span> || <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">7</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// pixelOffset: Cartesian2 | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åƒç´ åç§»é‡</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Cartesian2.ZERO</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pixelOffset</span> = options.<span class="property">pixelOffset</span> || <span class="title class_">Cesium</span>.<span class="property">Cartesian2</span>.<span class="property">ZERO</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// eyeOffset: Cartesian3 | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: çœ¼éƒ¨åç§»é‡</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Cartesian3.ZERO</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">eyeOffset</span> = options.<span class="property">eyeOffset</span> || <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="property">ZERO</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// horizontalOrigin: HorizontalOrigin | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ°´å¹³å¯¹é½æ–¹å¼</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: HorizontalOrigin.CENTER</span></span><br><span class="line">    <span class="comment">// é€‰é¡¹: LEFT, CENTER, RIGHT</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">horizontalOrigin</span> = options.<span class="property">horizontalOrigin</span> || <span class="title class_">Cesium</span>.<span class="property">HorizontalOrigin</span>.<span class="property">CENTER</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// verticalOrigin: VerticalOrigin | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å‚ç›´å¯¹é½æ–¹å¼</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: VerticalOrigin.CENTER</span></span><br><span class="line">    <span class="comment">// é€‰é¡¹: BOTTOM, BASELINE, CENTER, TOP</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">verticalOrigin</span> = options.<span class="property">verticalOrigin</span> || <span class="title class_">Cesium</span>.<span class="property">VerticalOrigin</span>.<span class="property">CENTER</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// heightReference: HeightReference | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é«˜åº¦å‚è€ƒ</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: HeightReference.NONE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">heightReference</span> = options.<span class="property">heightReference</span> || <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">NONE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// fillColor: Color | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¡«å……é¢œè‰²</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Color.WHITE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fillColor</span> = options.<span class="property">fillColor</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// outlineColor: Color | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è½®å»“é¢œè‰²</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Color.BLACK</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outlineColor</span> = options.<span class="property">outlineColor</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// outlineWidth: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è½®å»“å®½åº¦</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outlineWidth</span> = options.<span class="property">outlineWidth</span> !== <span class="literal">undefined</span> ? options.<span class="property">outlineWidth</span> : <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// translucencyByDistance: NearFarScalar | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åŸºäºè·ç¦»çš„é€æ˜åº¦</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">translucencyByDistance</span> = options.<span class="property">translucencyByDistance</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// pixelOffsetScaleByDistance: NearFarScalar | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åŸºäºè·ç¦»çš„åƒç´ åç§»ç¼©æ”¾</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pixelOffsetScaleByDistance</span> = options.<span class="property">pixelOffsetScaleByDistance</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// scaleByDistance: NearFarScalar | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åŸºäºè·ç¦»çš„ç¼©æ”¾</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scaleByDistance</span> = options.<span class="property">scaleByDistance</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// distanceDisplayCondition: DistanceDisplayCondition | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è·ç¦»æ˜¾ç¤ºæ¡ä»¶</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">distanceDisplayCondition</span> = options.<span class="property">distanceDisplayCondition</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// disableDepthTestDistance: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç¦ç”¨æ·±åº¦æµ‹è¯•çš„è·ç¦»</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 0.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">disableDepthTestDistance</span> =</span><br><span class="line">      options.<span class="property">disableDepthTestDistance</span> !== <span class="literal">undefined</span> ? options.<span class="property">disableDepthTestDistance</span> : <span class="number">0.0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> labelEntity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>),</span><br><span class="line">  <span class="attr">label</span>: &#123;</span><br><span class="line">    <span class="attr">text</span>: <span class="string">&#x27;åŒ—äº¬å¸‚&#x27;</span>,</span><br><span class="line">    <span class="attr">font</span>: <span class="string">&#x27;24pt Microsoft YaHei&#x27;</span>,</span><br><span class="line">    <span class="attr">style</span>: <span class="title class_">Cesium</span>.<span class="property">LabelStyle</span>.<span class="property">FILL_AND_OUTLINE</span>,</span><br><span class="line">    <span class="attr">fillColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span>,</span><br><span class="line">    <span class="attr">outlineColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>,</span><br><span class="line">    <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">showBackground</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">backgroundColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>.<span class="title function_">withAlpha</span>(<span class="number">0.7</span>),</span><br><span class="line">    <span class="attr">backgroundPadding</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">10</span>, <span class="number">8</span>),</span><br><span class="line">    <span class="attr">verticalOrigin</span>: <span class="title class_">Cesium</span>.<span class="property">VerticalOrigin</span>.<span class="property">BOTTOM</span>,</span><br><span class="line">    <span class="attr">pixelOffset</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">0</span>, -<span class="number">50</span>),</span><br><span class="line">    <span class="attr">heightReference</span>: <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">CLAMP_TO_GROUND</span>,</span><br><span class="line">    <span class="attr">scaleByDistance</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">NearFarScalar</span>(<span class="number">1.5e2</span>, <span class="number">1.5</span>, <span class="number">1.5e7</span>, <span class="number">0.5</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="PolylineGraphics-å¤šæ®µçº¿å›¾å½¢"><a href="#PolylineGraphics-å¤šæ®µçº¿å›¾å½¢" class="headerlink" title="PolylineGraphics å¤šæ®µçº¿å›¾å½¢"></a>PolylineGraphics å¤šæ®µçº¿å›¾å½¢</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PolylineGraphics - å¤šæ®µçº¿å›¾å½¢</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PolylineGraphics</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// show: boolean | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ§åˆ¶å¤šæ®µçº¿çš„å¯è§æ€§</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// positions: Array&lt;Cartesian3&gt; | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¤šæ®µçº¿çš„é¡¶ç‚¹ä½ç½®æ•°ç»„</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="comment">// æ ¼å¼: [Cartesian3, Cartesian3, ...]</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">positions</span> = options.<span class="property">positions</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// width: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: çº¿æ¡å®½åº¦ï¼ˆåƒç´ ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">    <span class="comment">// èŒƒå›´: 1.0 - ç¡¬ä»¶é™åˆ¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">width</span> = options.<span class="property">width</span> !== <span class="literal">undefined</span> ? options.<span class="property">width</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// granularity: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: çº¿æ¡ç»†åˆ†ç²’åº¦ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Math.PI / 180ï¼ˆ1åº¦ï¼‰</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: æ§åˆ¶æ›²çº¿çš„å¹³æ»‘åº¦</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">granularity</span> = options.<span class="property">granularity</span> !== <span class="literal">undefined</span> ? options.<span class="property">granularity</span> : <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">180</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// material: MaterialProperty | Color</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: çº¿æ¡æè´¨</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Color.WHITE</span></span><br><span class="line">    <span class="comment">// ç±»å‹: Colorã€ImageMaterialPropertyã€PolylineDashMaterialPropertyç­‰</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">material</span> = options.<span class="property">material</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// depthFailMaterial: MaterialProperty | Color</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ·±åº¦æµ‹è¯•å¤±è´¥æ—¶çš„æè´¨</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: è¢«é®æŒ¡éƒ¨åˆ†çš„æ˜¾ç¤º</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">depthFailMaterial</span> = options.<span class="property">depthFailMaterial</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// followSurface: boolean | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦è·Ÿéšåœ°è¡¨</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="comment">// true: çº¿æ¡è´´åˆåœ°çƒè¡¨é¢æ›²ç‡</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">followSurface</span> = options.<span class="property">followSurface</span> !== <span class="literal">undefined</span> ? options.<span class="property">followSurface</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// clampToGround: boolean | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦è´´åœ°</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="comment">// true: çº¿æ¡è´´åˆåœ°å½¢è¡¨é¢</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clampToGround</span> = options.<span class="property">clampToGround</span> !== <span class="literal">undefined</span> ? options.<span class="property">clampToGround</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// shadows: ShadowMode | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é˜´å½±æ¨¡å¼</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: ShadowMode.DISABLED</span></span><br><span class="line">    <span class="comment">// é€‰é¡¹: DISABLED, ENABLED, CAST_ONLY, RECEIVE_ONLY</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadows</span> = options.<span class="property">shadows</span> || <span class="title class_">Cesium</span>.<span class="property">ShadowMode</span>.<span class="property">DISABLED</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// distanceDisplayCondition: DistanceDisplayCondition | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è·ç¦»æ˜¾ç¤ºæ¡ä»¶</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">distanceDisplayCondition</span> = options.<span class="property">distanceDisplayCondition</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// classificationType: ClassificationType | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åˆ†ç±»ç±»å‹ï¼ˆç”¨äºè´´åœ°ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: ClassificationType.BOTH</span></span><br><span class="line">    <span class="comment">// é€‰é¡¹: TERRAIN, CESIUM_3D_TILE, BOTH</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">classificationType</span> = options.<span class="property">classificationType</span> || <span class="title class_">Cesium</span>.<span class="property">ClassificationType</span>.<span class="property">BOTH</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// zIndex: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: Zè½´ç´¢å¼•ï¼ˆè´´åœ°æ—¶çš„å±‚æ¬¡ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 0</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: æ§åˆ¶é‡å çº¿æ¡çš„æ˜¾ç¤ºé¡ºåº</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">zIndex</span> = options.<span class="property">zIndex</span> !== <span class="literal">undefined</span> ? options.<span class="property">zIndex</span> : <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> polylineEntity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">polyline</span>: &#123;</span><br><span class="line">    <span class="attr">positions</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegreesArray</span>([</span><br><span class="line">      <span class="number">116.4074</span>,</span><br><span class="line">      <span class="number">39.9042</span>, <span class="comment">// åŒ—äº¬</span></span><br><span class="line">      <span class="number">121.4737</span>,</span><br><span class="line">      <span class="number">31.2304</span>, <span class="comment">// ä¸Šæµ·</span></span><br><span class="line">      <span class="number">113.2644</span>,</span><br><span class="line">      <span class="number">23.1291</span>, <span class="comment">// å¹¿å·</span></span><br><span class="line">    ]),</span><br><span class="line">    <span class="attr">width</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">material</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">CYAN</span>,</span><br><span class="line">    <span class="attr">clampToGround</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è™šçº¿æè´¨</span></span><br><span class="line">    <span class="attr">material</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PolylineDashMaterialProperty</span>(&#123;</span><br><span class="line">      <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>,</span><br><span class="line">      <span class="attr">dashLength</span>: <span class="number">16.0</span>, <span class="comment">// è™šçº¿é•¿åº¦</span></span><br><span class="line">      <span class="attr">dashPattern</span>: <span class="number">255</span>, <span class="comment">// è™šçº¿æ¨¡å¼</span></span><br><span class="line">    &#125;),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç®­å¤´æè´¨</span></span><br><span class="line">    <span class="attr">material</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PolylineArrowMaterialProperty</span>(<span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘å…‰æè´¨</span></span><br><span class="line">    <span class="attr">material</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PolylineGlowMaterialProperty</span>(&#123;</span><br><span class="line">      <span class="attr">glowPower</span>: <span class="number">0.2</span>, <span class="comment">// å‘å…‰å¼ºåº¦</span></span><br><span class="line">      <span class="attr">taperPower</span>: <span class="number">0.5</span>, <span class="comment">// é”¥å½¢åŠŸç‡</span></span><br><span class="line">      <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLUE</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="PolygonGraphics-å¤šè¾¹å½¢å›¾å½¢"><a href="#PolygonGraphics-å¤šè¾¹å½¢å›¾å½¢" class="headerlink" title="PolygonGraphics å¤šè¾¹å½¢å›¾å½¢"></a>PolygonGraphics å¤šè¾¹å½¢å›¾å½¢</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PolygonGraphics - å¤šè¾¹å½¢å›¾å½¢</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PolygonGraphics</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// show: boolean | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ§åˆ¶å¤šè¾¹å½¢çš„å¯è§æ€§</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// hierarchy: PolygonHierarchy | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¤šè¾¹å½¢å±‚æ¬¡ç»“æ„ï¼ˆå¤–ç¯å’Œå†…ç¯ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="comment">// æ ¼å¼: é¡¶ç‚¹æ•°ç»„æˆ–PolygonHierarchyå¯¹è±¡</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hierarchy</span> = options.<span class="property">hierarchy</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// height: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¤šè¾¹å½¢é«˜åº¦ï¼ˆç±³ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 0</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: æŠ¬é«˜å¤šè¾¹å½¢</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">height</span> = options.<span class="property">height</span> !== <span class="literal">undefined</span> ? options.<span class="property">height</span> : <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// heightReference: HeightReference | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é«˜åº¦å‚è€ƒ</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: HeightReference.NONE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">heightReference</span> = options.<span class="property">heightReference</span> || <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">NONE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// extrudedHeight: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ‹‰ä¼¸é«˜åº¦ï¼ˆç±³ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: åˆ›å»º3Dç«‹ä½“æ•ˆæœ</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">extrudedHeight</span> = options.<span class="property">extrudedHeight</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// extrudedHeightReference: HeightReference | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ‹‰ä¼¸é«˜åº¦å‚è€ƒ</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: HeightReference.NONE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">extrudedHeightReference</span> = options.<span class="property">extrudedHeightReference</span> || <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">NONE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// stRotation: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: çº¹ç†æ—‹è½¬è§’åº¦ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 0.0</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: æ—‹è½¬æè´¨çº¹ç†</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">stRotation</span> = options.<span class="property">stRotation</span> !== <span class="literal">undefined</span> ? options.<span class="property">stRotation</span> : <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// granularity: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç»†åˆ†ç²’åº¦ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Math.PI / 180</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: æ§åˆ¶æ›²çº¿è¾¹çš„å¹³æ»‘åº¦</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">granularity</span> = options.<span class="property">granularity</span> !== <span class="literal">undefined</span> ? options.<span class="property">granularity</span> : <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">180</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// fill: boolean | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦å¡«å……</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fill</span> = options.<span class="property">fill</span> !== <span class="literal">undefined</span> ? options.<span class="property">fill</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// material: MaterialProperty | Color</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¡«å……æè´¨</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Color.WHITE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">material</span> = options.<span class="property">material</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// outline: boolean | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºè½®å»“</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outline</span> = options.<span class="property">outline</span> !== <span class="literal">undefined</span> ? options.<span class="property">outline</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// outlineColor: Color | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è½®å»“é¢œè‰²</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Color.BLACK</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outlineColor</span> = options.<span class="property">outlineColor</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// outlineWidth: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è½®å»“å®½åº¦ï¼ˆåƒç´ ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">    <span class="comment">// æ³¨æ„: åœ¨æŸäº›ç¡¬ä»¶ä¸Šå¯èƒ½ä¸æ”¯æŒ</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outlineWidth</span> = options.<span class="property">outlineWidth</span> !== <span class="literal">undefined</span> ? options.<span class="property">outlineWidth</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// perPositionHeight: boolean | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦ä½¿ç”¨æ¯ä¸ªé¡¶ç‚¹çš„é«˜åº¦</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="comment">// true: æ¯ä¸ªé¡¶ç‚¹å¯ä»¥æœ‰ä¸åŒçš„é«˜åº¦</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">perPositionHeight</span> =</span><br><span class="line">      options.<span class="property">perPositionHeight</span> !== <span class="literal">undefined</span> ? options.<span class="property">perPositionHeight</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// closeTop: boolean | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦å°é—­é¡¶éƒ¨ï¼ˆæ‹‰ä¼¸æ—¶ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">closeTop</span> = options.<span class="property">closeTop</span> !== <span class="literal">undefined</span> ? options.<span class="property">closeTop</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// closeBottom: boolean | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦å°é—­åº•éƒ¨ï¼ˆæ‹‰ä¼¸æ—¶ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">closeBottom</span> = options.<span class="property">closeBottom</span> !== <span class="literal">undefined</span> ? options.<span class="property">closeBottom</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// arcType: ArcType | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¼§çº¿ç±»å‹</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: ArcType.GEODESIC</span></span><br><span class="line">    <span class="comment">// é€‰é¡¹: NONE, GEODESIC, RHUMB</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">arcType</span> = options.<span class="property">arcType</span> || <span class="title class_">Cesium</span>.<span class="property">ArcType</span>.<span class="property">GEODESIC</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// shadows: ShadowMode | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é˜´å½±æ¨¡å¼</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: ShadowMode.DISABLED</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadows</span> = options.<span class="property">shadows</span> || <span class="title class_">Cesium</span>.<span class="property">ShadowMode</span>.<span class="property">DISABLED</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// distanceDisplayCondition: DistanceDisplayCondition | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è·ç¦»æ˜¾ç¤ºæ¡ä»¶</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">distanceDisplayCondition</span> = options.<span class="property">distanceDisplayCondition</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// classificationType: ClassificationType | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åˆ†ç±»ç±»å‹</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: ClassificationType.BOTH</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">classificationType</span> = options.<span class="property">classificationType</span> || <span class="title class_">Cesium</span>.<span class="property">ClassificationType</span>.<span class="property">BOTH</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// zIndex: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: Zè½´ç´¢å¼•</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">zIndex</span> = options.<span class="property">zIndex</span> !== <span class="literal">undefined</span> ? options.<span class="property">zIndex</span> : <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> polygonEntity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">polygon</span>: &#123;</span><br><span class="line">    <span class="attr">hierarchy</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegreesArray</span>([</span><br><span class="line">      <span class="number">116.3</span>,</span><br><span class="line">      <span class="number">39.8</span>, <span class="comment">// è¥¿å—è§’</span></span><br><span class="line">      <span class="number">116.5</span>,</span><br><span class="line">      <span class="number">39.8</span>, <span class="comment">// ä¸œå—è§’</span></span><br><span class="line">      <span class="number">116.5</span>,</span><br><span class="line">      <span class="number">40.0</span>, <span class="comment">// ä¸œåŒ—è§’</span></span><br><span class="line">      <span class="number">116.3</span>,</span><br><span class="line">      <span class="number">40.0</span>, <span class="comment">// è¥¿åŒ—è§’</span></span><br><span class="line">    ]),</span><br><span class="line">    <span class="attr">height</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">extrudedHeight</span>: <span class="number">300</span>, <span class="comment">// æ‹‰ä¼¸300ç±³</span></span><br><span class="line">    <span class="attr">material</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLUE</span>.<span class="title function_">withAlpha</span>(<span class="number">0.7</span>),</span><br><span class="line">    <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">outlineColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLUE</span>,</span><br><span class="line">    <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¸¦æ´çš„å¤šè¾¹å½¢</span></span><br><span class="line">    <span class="attr">hierarchy</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PolygonHierarchy</span>(</span><br><span class="line">      <span class="comment">// å¤–ç¯</span></span><br><span class="line">      <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegreesArray</span>([<span class="number">116.3</span>, <span class="number">39.8</span>, <span class="number">116.5</span>, <span class="number">39.8</span>, <span class="number">116.5</span>, <span class="number">40.0</span>, <span class="number">116.3</span>, <span class="number">40.0</span>]),</span><br><span class="line">      <span class="comment">// å†…ç¯ï¼ˆæ´ï¼‰</span></span><br><span class="line">      [</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PolygonHierarchy</span>(</span><br><span class="line">          <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegreesArray</span>([</span><br><span class="line">            <span class="number">116.35</span>, <span class="number">39.85</span>, <span class="number">116.45</span>, <span class="number">39.85</span>, <span class="number">116.45</span>, <span class="number">39.95</span>, <span class="number">116.35</span>, <span class="number">39.95</span>,</span><br><span class="line">          ]),</span><br><span class="line">        ),</span><br><span class="line">      ],</span><br><span class="line">    ),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å›¾ç‰‡æè´¨</span></span><br><span class="line">    <span class="attr">material</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ImageMaterialProperty</span>(&#123;</span><br><span class="line">      <span class="attr">image</span>: <span class="string">&#x27;path/to/texture.png&#x27;</span>,</span><br><span class="line">      <span class="attr">repeat</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">4.0</span>, <span class="number">4.0</span>),</span><br><span class="line">    &#125;),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£‹ç›˜æè´¨</span></span><br><span class="line">    <span class="attr">material</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">CheckerboardMaterialProperty</span>(&#123;</span><br><span class="line">      <span class="attr">evenColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span>,</span><br><span class="line">      <span class="attr">oddColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>,</span><br><span class="line">      <span class="attr">repeat</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">4.0</span>, <span class="number">4.0</span>),</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="ModelGraphics-3Dæ¨¡å‹å›¾å½¢"><a href="#ModelGraphics-3Dæ¨¡å‹å›¾å½¢" class="headerlink" title="ModelGraphics 3Dæ¨¡å‹å›¾å½¢"></a>ModelGraphics 3Dæ¨¡å‹å›¾å½¢</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ModelGraphics - 3Dæ¨¡å‹å›¾å½¢</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelGraphics</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// show: boolean | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ§åˆ¶æ¨¡å‹çš„å¯è§æ€§</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// uri: string | Resource | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ¨¡å‹æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="comment">// æ”¯æŒ: glTF(.gltf, .glb)ã€COLLADA(.dae)ç­‰</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">uri</span> = options.<span class="property">uri</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// scale: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ¨¡å‹ç¼©æ”¾æ¯”ä¾‹</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scale</span> = options.<span class="property">scale</span> !== <span class="literal">undefined</span> ? options.<span class="property">scale</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// minimumPixelSize: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æœ€å°åƒç´ å¤§å°</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 0.0</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: é˜²æ­¢æ¨¡å‹åœ¨è¿œè·ç¦»æ—¶å˜å¾—è¿‡å°</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">minimumPixelSize</span> = options.<span class="property">minimumPixelSize</span> !== <span class="literal">undefined</span> ? options.<span class="property">minimumPixelSize</span> : <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// maximumScale: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æœ€å¤§ç¼©æ”¾æ¯”ä¾‹</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: é™åˆ¶æ¨¡å‹çš„æœ€å¤§æ˜¾ç¤ºå°ºå¯¸</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maximumScale</span> = options.<span class="property">maximumScale</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// incrementallyLoadTextures: boolean | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦å¢é‡åŠ è½½çº¹ç†</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="comment">// æ€§èƒ½ä¼˜åŒ–: æ¸è¿›å¼çº¹ç†åŠ è½½</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">incrementallyLoadTextures</span> =</span><br><span class="line">      options.<span class="property">incrementallyLoadTextures</span> !== <span class="literal">undefined</span> ? options.<span class="property">incrementallyLoadTextures</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// runAnimations: boolean | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦è¿è¡ŒåŠ¨ç”»</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: æ§åˆ¶æ¨¡å‹å†…ç½®åŠ¨ç”»çš„æ’­æ”¾</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">runAnimations</span> = options.<span class="property">runAnimations</span> !== <span class="literal">undefined</span> ? options.<span class="property">runAnimations</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// clampAnimations: boolean | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦é™åˆ¶åŠ¨ç”»</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: å°†åŠ¨ç”»é™åˆ¶åœ¨å®šä¹‰çš„æ—¶é—´èŒƒå›´å†…</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clampAnimations</span> = options.<span class="property">clampAnimations</span> !== <span class="literal">undefined</span> ? options.<span class="property">clampAnimations</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// shadows: ShadowMode | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é˜´å½±æ¨¡å¼</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: ShadowMode.ENABLED</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadows</span> = options.<span class="property">shadows</span> || <span class="title class_">Cesium</span>.<span class="property">ShadowMode</span>.<span class="property">ENABLED</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// heightReference: HeightReference | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é«˜åº¦å‚è€ƒ</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: HeightReference.NONE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">heightReference</span> = options.<span class="property">heightReference</span> || <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">NONE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// silhouetteColor: Color | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è½®å»“é¢œè‰²</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Color.RED</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: æ¨¡å‹è¢«é€‰ä¸­æ—¶çš„è½®å»“é¢œè‰²</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">silhouetteColor</span> = options.<span class="property">silhouetteColor</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// silhouetteSize: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è½®å»“å¤§å°</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 0.0ï¼ˆä¸æ˜¾ç¤ºè½®å»“ï¼‰</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: æ¨¡å‹è¢«é€‰ä¸­æ—¶çš„è½®å»“å®½åº¦</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">silhouetteSize</span> = options.<span class="property">silhouetteSize</span> !== <span class="literal">undefined</span> ? options.<span class="property">silhouetteSize</span> : <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// color: Color | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ¨¡å‹é¢œè‰²ï¼ˆæ··åˆï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Color.WHITE</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: ä¸æ¨¡å‹çº¹ç†æ··åˆçš„é¢œè‰²</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">color</span> = options.<span class="property">color</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// colorBlendMode: ColorBlendMode | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é¢œè‰²æ··åˆæ¨¡å¼</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: ColorBlendMode.HIGHLIGHT</span></span><br><span class="line">    <span class="comment">// é€‰é¡¹: HIGHLIGHT, REPLACE, MIX</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">colorBlendMode</span> = options.<span class="property">colorBlendMode</span> || <span class="title class_">Cesium</span>.<span class="property">ColorBlendMode</span>.<span class="property">HIGHLIGHT</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// colorBlendAmount: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é¢œè‰²æ··åˆå¼ºåº¦</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 0.5</span></span><br><span class="line">    <span class="comment">// èŒƒå›´: 0.0 - 1.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">colorBlendAmount</span> = options.<span class="property">colorBlendAmount</span> !== <span class="literal">undefined</span> ? options.<span class="property">colorBlendAmount</span> : <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// distanceDisplayCondition: DistanceDisplayCondition | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è·ç¦»æ˜¾ç¤ºæ¡ä»¶</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">distanceDisplayCondition</span> = options.<span class="property">distanceDisplayCondition</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// nodeTransformations: PropertyBag | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: èŠ‚ç‚¹å˜æ¢</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: æ§åˆ¶æ¨¡å‹ä¸­ç‰¹å®šèŠ‚ç‚¹çš„å˜æ¢</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">nodeTransformations</span> = options.<span class="property">nodeTransformations</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// articulations: PropertyBag | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å…³èŠ‚åŠ¨ç”»</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: æ§åˆ¶æ¨¡å‹çš„å…³èŠ‚åŠ¨ç”»</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">articulations</span> = options.<span class="property">articulations</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// clippingPlanes: ClippingPlaneCollection | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è£å‰ªå¹³é¢</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: è£å‰ªæ¨¡å‹çš„æŸäº›éƒ¨åˆ†</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clippingPlanes</span> = options.<span class="property">clippingPlanes</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> modelEntity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">0</span>),</span><br><span class="line">  <span class="attr">model</span>: &#123;</span><br><span class="line">    <span class="attr">uri</span>: <span class="string">&#x27;./models/airplane.gltf&#x27;</span>,</span><br><span class="line">    <span class="attr">scale</span>: <span class="number">2.0</span>,</span><br><span class="line">    <span class="attr">minimumPixelSize</span>: <span class="number">128</span>,</span><br><span class="line">    <span class="attr">maximumScale</span>: <span class="number">20000</span>,</span><br><span class="line">    <span class="attr">heightReference</span>: <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">CLAMP_TO_GROUND</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é«˜äº®æ˜¾ç¤º</span></span><br><span class="line">    <span class="attr">silhouetteColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">LIME</span>,</span><br><span class="line">    <span class="attr">silhouetteSize</span>: <span class="number">2.0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é¢œè‰²è°ƒæ•´</span></span><br><span class="line">    <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span>,</span><br><span class="line">    <span class="attr">colorBlendMode</span>: <span class="title class_">Cesium</span>.<span class="property">ColorBlendMode</span>.<span class="property">MIX</span>,</span><br><span class="line">    <span class="attr">colorBlendAmount</span>: <span class="number">0.3</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹å˜æ¢ï¼ˆæ—‹è½¬èºæ—‹æ¡¨ï¼‰</span></span><br><span class="line">    <span class="attr">nodeTransformations</span>: &#123;</span><br><span class="line">      <span class="title class_">Propeller</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">NodeTransformationProperty</span>(&#123;</span><br><span class="line">        <span class="attr">rotation</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">CallbackProperty</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Quaternion</span>.<span class="title function_">fromAxisAngle</span>(</span><br><span class="line">            <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="property">UNIT_Z</span>,</span><br><span class="line">            (<span class="title class_">Date</span>.<span class="title function_">now</span>() / <span class="number">1000</span>) * <span class="number">10</span>, <span class="comment">// æ¯ç§’10å¼§åº¦</span></span><br><span class="line">          )</span><br><span class="line">        &#125;, <span class="literal">false</span>),</span><br><span class="line">      &#125;),</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è£å‰ªå¹³é¢</span></span><br><span class="line">    <span class="attr">clippingPlanes</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ClippingPlaneCollection</span>(&#123;</span><br><span class="line">      <span class="attr">planes</span>: [<span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ClippingPlane</span>(<span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>), <span class="number">0.0</span>)],</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="BoxGraphics-ç›’å­å›¾å½¢"><a href="#BoxGraphics-ç›’å­å›¾å½¢" class="headerlink" title="BoxGraphics ç›’å­å›¾å½¢"></a>BoxGraphics ç›’å­å›¾å½¢</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BoxGraphics - ç›’å­å›¾å½¢</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BoxGraphics</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// show: boolean | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ§åˆ¶ç›’å­çš„å¯è§æ€§</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// dimensions: Cartesian3 | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç›’å­çš„å°ºå¯¸ï¼ˆé•¿ã€å®½ã€é«˜ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="comment">// å•ä½: ç±³</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dimensions</span> = options.<span class="property">dimensions</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// heightReference: HeightReference | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é«˜åº¦å‚è€ƒ</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: HeightReference.NONE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">heightReference</span> = options.<span class="property">heightReference</span> || <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">NONE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// fill: boolean | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦å¡«å……</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fill</span> = options.<span class="property">fill</span> !== <span class="literal">undefined</span> ? options.<span class="property">fill</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// material: MaterialProperty | Color</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¡«å……æè´¨</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Color.WHITE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">material</span> = options.<span class="property">material</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// outline: boolean | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºè½®å»“</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outline</span> = options.<span class="property">outline</span> !== <span class="literal">undefined</span> ? options.<span class="property">outline</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// outlineColor: Color | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è½®å»“é¢œè‰²</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Color.BLACK</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outlineColor</span> = options.<span class="property">outlineColor</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// outlineWidth: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è½®å»“å®½åº¦</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outlineWidth</span> = options.<span class="property">outlineWidth</span> !== <span class="literal">undefined</span> ? options.<span class="property">outlineWidth</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// shadows: ShadowMode | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é˜´å½±æ¨¡å¼</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: ShadowMode.DISABLED</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadows</span> = options.<span class="property">shadows</span> || <span class="title class_">Cesium</span>.<span class="property">ShadowMode</span>.<span class="property">DISABLED</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// distanceDisplayCondition: DistanceDisplayCondition | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è·ç¦»æ˜¾ç¤ºæ¡ä»¶</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">distanceDisplayCondition</span> = options.<span class="property">distanceDisplayCondition</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> boxEntity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">100</span>),</span><br><span class="line">  <span class="attr">box</span>: &#123;</span><br><span class="line">    <span class="attr">dimensions</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">200</span>, <span class="number">200</span>, <span class="number">100</span>), <span class="comment">// é•¿200mï¼Œå®½200mï¼Œé«˜100m</span></span><br><span class="line">    <span class="attr">material</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLUE</span>.<span class="title function_">withAlpha</span>(<span class="number">0.7</span>),</span><br><span class="line">    <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">outlineColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLUE</span>,</span><br><span class="line">    <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">heightReference</span>: <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">RELATIVE_TO_GROUND</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="CylinderGraphics-åœ†æŸ±ä½“å›¾å½¢"><a href="#CylinderGraphics-åœ†æŸ±ä½“å›¾å½¢" class="headerlink" title="CylinderGraphics åœ†æŸ±ä½“å›¾å½¢"></a>CylinderGraphics åœ†æŸ±ä½“å›¾å½¢</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CylinderGraphics - åœ†æŸ±ä½“å›¾å½¢</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CylinderGraphics</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// show: boolean | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ§åˆ¶åœ†æŸ±ä½“çš„å¯è§æ€§</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// length: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åœ†æŸ±ä½“é•¿åº¦ï¼ˆé«˜åº¦ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="comment">// å•ä½: ç±³</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">length</span> = options.<span class="property">length</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// topRadius: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é¡¶éƒ¨åŠå¾„</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="comment">// å•ä½: ç±³</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">topRadius</span> = options.<span class="property">topRadius</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// bottomRadius: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åº•éƒ¨åŠå¾„</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="comment">// å•ä½: ç±³</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">bottomRadius</span> = options.<span class="property">bottomRadius</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// heightReference: HeightReference | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é«˜åº¦å‚è€ƒ</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: HeightReference.NONE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">heightReference</span> = options.<span class="property">heightReference</span> || <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">NONE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// fill: boolean | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦å¡«å……</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fill</span> = options.<span class="property">fill</span> !== <span class="literal">undefined</span> ? options.<span class="property">fill</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// material: MaterialProperty | Color</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¡«å……æè´¨</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Color.WHITE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">material</span> = options.<span class="property">material</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// outline: boolean | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºè½®å»“</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outline</span> = options.<span class="property">outline</span> !== <span class="literal">undefined</span> ? options.<span class="property">outline</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// outlineColor: Color | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è½®å»“é¢œè‰²</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Color.BLACK</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outlineColor</span> = options.<span class="property">outlineColor</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// outlineWidth: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è½®å»“å®½åº¦</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outlineWidth</span> = options.<span class="property">outlineWidth</span> !== <span class="literal">undefined</span> ? options.<span class="property">outlineWidth</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// numberOfVerticalLines: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å‚ç›´çº¿æ¡æ•°é‡</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 16</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: æ§åˆ¶åœ†æŸ±ä½“çš„ç»†åˆ†ç²¾åº¦</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">numberOfVerticalLines</span> =</span><br><span class="line">      options.<span class="property">numberOfVerticalLines</span> !== <span class="literal">undefined</span> ? options.<span class="property">numberOfVerticalLines</span> : <span class="number">16</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// slices: number | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åˆ‡ç‰‡æ•°é‡</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 128</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: æ§åˆ¶åœ†å‘¨æ–¹å‘çš„ç²¾åº¦</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">slices</span> = options.<span class="property">slices</span> !== <span class="literal">undefined</span> ? options.<span class="property">slices</span> : <span class="number">128</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// shadows: ShadowMode | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é˜´å½±æ¨¡å¼</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: ShadowMode.DISABLED</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadows</span> = options.<span class="property">shadows</span> || <span class="title class_">Cesium</span>.<span class="property">ShadowMode</span>.<span class="property">DISABLED</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// distanceDisplayCondition: DistanceDisplayCondition | Property</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è·ç¦»æ˜¾ç¤ºæ¡ä»¶</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">distanceDisplayCondition</span> = options.<span class="property">distanceDisplayCondition</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> cylinderEntity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">50</span>),</span><br><span class="line">  <span class="attr">cylinder</span>: &#123;</span><br><span class="line">    <span class="attr">length</span>: <span class="number">100</span>, <span class="comment">// é«˜åº¦100ç±³</span></span><br><span class="line">    <span class="attr">topRadius</span>: <span class="number">30</span>, <span class="comment">// é¡¶éƒ¨åŠå¾„30ç±³</span></span><br><span class="line">    <span class="attr">bottomRadius</span>: <span class="number">50</span>, <span class="comment">// åº•éƒ¨åŠå¾„50ç±³ï¼ˆé”¥å½¢ï¼‰</span></span><br><span class="line">    <span class="attr">material</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">GREEN</span>.<span class="title function_">withAlpha</span>(<span class="number">0.8</span>),</span><br><span class="line">    <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">outlineColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">DARKGREEN</span>,</span><br><span class="line">    <span class="attr">heightReference</span>: <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">RELATIVE_TO_GROUND</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="åœ°å½¢ç³»ç»Ÿè¯¦è§£"><a href="#åœ°å½¢ç³»ç»Ÿè¯¦è§£" class="headerlink" title="åœ°å½¢ç³»ç»Ÿè¯¦è§£"></a>åœ°å½¢ç³»ç»Ÿè¯¦è§£</h2><h3 id="TerrainProvider-åœ°å½¢æä¾›è€…"><a href="#TerrainProvider-åœ°å½¢æä¾›è€…" class="headerlink" title="TerrainProvider åœ°å½¢æä¾›è€…"></a>TerrainProvider åœ°å½¢æä¾›è€…</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// EllipsoidTerrainProvider - æ¤­çƒåœ°å½¢ï¼ˆç¦»çº¿æ¨èï¼‰</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EllipsoidTerrainProvider</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// ellipsoid: Ellipsoid</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ¤­çƒä½“å‚æ•°</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Ellipsoid.WGS84</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ellipsoid</span> = options.<span class="property">ellipsoid</span> || <span class="title class_">Cesium</span>.<span class="property">Ellipsoid</span>.<span class="property">WGS84</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// credit: Credit | string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç‰ˆæƒä¿¡æ¯</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">credit</span> = options.<span class="property">credit</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å±æ€§</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">ready</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125; <span class="comment">// æ˜¯å¦å°±ç»ª</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">readyPromise</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="literal">true</span>)</span><br><span class="line">  &#125; <span class="comment">// å°±ç»ªPromise</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">errorEvent</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line">  &#125; <span class="comment">// é”™è¯¯äº‹ä»¶</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">hasWaterMask</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125; <span class="comment">// æ˜¯å¦æœ‰æ°´ä½“é®ç½©</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">hasVertexNormals</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125; <span class="comment">// æ˜¯å¦æœ‰é¡¶ç‚¹æ³•çº¿</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">availability</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">  &#125; <span class="comment">// å¯ç”¨æ€§</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CesiumTerrainProvider - Cesiumåœ°å½¢æœåŠ¡</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CesiumTerrainProvider</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// url: string | Resource</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åœ°å½¢æœåŠ¡URL</span></span><br><span class="line">    <span class="comment">// å¿…éœ€: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">url</span> = options.<span class="property">url</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// requestWaterMask: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦è¯·æ±‚æ°´ä½“é®ç½©</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">requestWaterMask</span> =</span><br><span class="line">      options.<span class="property">requestWaterMask</span> !== <span class="literal">undefined</span> ? options.<span class="property">requestWaterMask</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// requestVertexNormals: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦è¯·æ±‚é¡¶ç‚¹æ³•çº¿</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">requestVertexNormals</span> =</span><br><span class="line">      options.<span class="property">requestVertexNormals</span> !== <span class="literal">undefined</span> ? options.<span class="property">requestVertexNormals</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ellipsoid: Ellipsoid</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ¤­çƒä½“</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Ellipsoid.WGS84</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ellipsoid</span> = options.<span class="property">ellipsoid</span> || <span class="title class_">Cesium</span>.<span class="property">Ellipsoid</span>.<span class="property">WGS84</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// credit: Credit | string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç‰ˆæƒä¿¡æ¯</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">credit</span> = options.<span class="property">credit</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// requestTileGeometry - è¯·æ±‚ç“¦ç‰‡å‡ ä½•</span></span><br><span class="line">  <span class="comment">// x: number - Xåæ ‡</span></span><br><span class="line">  <span class="comment">// y: number - Yåæ ‡</span></span><br><span class="line">  <span class="comment">// level: number - çº§åˆ«</span></span><br><span class="line">  <span class="title function_">requestTileGeometry</span>(<span class="params">x, y, level</span>) &#123;</span><br><span class="line">    <span class="comment">// è¿”å›Promise&lt;TerrainData&gt;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getLevelMaximumGeometricError - è·å–çº§åˆ«æœ€å¤§å‡ ä½•è¯¯å·®</span></span><br><span class="line">  <span class="comment">// level: number - çº§åˆ«</span></span><br><span class="line">  <span class="title function_">getLevelMaximumGeometricError</span>(<span class="params">level</span>) &#123;</span><br><span class="line">    <span class="comment">// è¿”å›å‡ ä½•è¯¯å·®å€¼</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getTileDataAvailable - è·å–ç“¦ç‰‡æ•°æ®å¯ç”¨æ€§</span></span><br><span class="line">  <span class="comment">// x: number - Xåæ ‡</span></span><br><span class="line">  <span class="comment">// y: number - Yåæ ‡</span></span><br><span class="line">  <span class="comment">// level: number - çº§åˆ«</span></span><br><span class="line">  <span class="title function_">getTileDataAvailable</span>(<span class="params">x, y, level</span>) &#123;</span><br><span class="line">    <span class="comment">// è¿”å›boolean</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ°å½¢é‡‡æ ·</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">sampleTerrain</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> positions = [</span><br><span class="line">    <span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>),</span><br><span class="line">    <span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromDegrees</span>(<span class="number">121.4737</span>, <span class="number">31.2304</span>),</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é‡‡æ ·åœ°å½¢é«˜åº¦</span></span><br><span class="line">  <span class="keyword">const</span> sampledPositions = <span class="keyword">await</span> <span class="title class_">Cesium</span>.<span class="title function_">sampleTerrainMostDetailed</span>(viewer.<span class="property">terrainProvider</span>, positions)</span><br><span class="line"></span><br><span class="line">  sampledPositions.<span class="title function_">forEach</span>(<span class="function">(<span class="params">position, index</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ä½ç½® <span class="subst">$&#123;index&#125;</span>: é«˜åº¦ <span class="subst">$&#123;position.height&#125;</span> ç±³`</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ°å½¢é…ç½®ç¤ºä¾‹</span></span><br><span class="line"><span class="comment">// ç¦»çº¿æ¤­çƒåœ°å½¢</span></span><br><span class="line">viewer.<span class="property">terrainProvider</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">EllipsoidTerrainProvider</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Cesium World Terrainï¼ˆéœ€è¦ç½‘ç»œï¼‰</span></span><br><span class="line"><span class="keyword">const</span> worldTerrain = <span class="title class_">Cesium</span>.<span class="title function_">createWorldTerrain</span>(&#123;</span><br><span class="line">  <span class="attr">requestWaterMask</span>: <span class="literal">true</span>, <span class="comment">// è¯·æ±‚æ°´ä½“é®ç½©</span></span><br><span class="line">  <span class="attr">requestVertexNormals</span>: <span class="literal">true</span>, <span class="comment">// è¯·æ±‚é¡¶ç‚¹æ³•çº¿</span></span><br><span class="line">&#125;)</span><br><span class="line">viewer.<span class="property">terrainProvider</span> = worldTerrain</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰åœ°å½¢æœåŠ¡</span></span><br><span class="line"><span class="keyword">const</span> customTerrain = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">CesiumTerrainProvider</span>(&#123;</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;http://localhost:8080/terrain/&#x27;</span>,</span><br><span class="line">  <span class="attr">requestWaterMask</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">requestVertexNormals</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line">viewer.<span class="property">terrainProvider</span> = customTerrain</span><br></pre></td></tr></table></figure><h2 id="ç›¸æœºç³»ç»Ÿå®Œæ•´å±æ€§"><a href="#ç›¸æœºç³»ç»Ÿå®Œæ•´å±æ€§" class="headerlink" title="ç›¸æœºç³»ç»Ÿå®Œæ•´å±æ€§"></a>ç›¸æœºç³»ç»Ÿå®Œæ•´å±æ€§</h2><h3 id="Camera-ç›¸æœºç±»"><a href="#Camera-ç›¸æœºç±»" class="headerlink" title="Camera ç›¸æœºç±»"></a>Camera ç›¸æœºç±»</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Camera - ç›¸æœºç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Camera</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// position: Cartesian3</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç›¸æœºåœ¨ä¸–ç•Œåæ ‡ç³»ä¸­çš„ä½ç½®</span></span><br><span class="line">    <span class="comment">// åªè¯»: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">position</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// direction: Cartesian3</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç›¸æœºæœå‘ï¼ˆå•ä½å‘é‡ï¼‰</span></span><br><span class="line">    <span class="comment">// åªè¯»: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">direction</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// up: Cartesian3</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç›¸æœºä¸Šæ–¹å‘ï¼ˆå•ä½å‘é‡ï¼‰</span></span><br><span class="line">    <span class="comment">// åªè¯»: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">up</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// right: Cartesian3</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç›¸æœºå³æ–¹å‘ï¼ˆå•ä½å‘é‡ï¼‰</span></span><br><span class="line">    <span class="comment">// åªè¯»: trueï¼ˆç”±directionå’Œupè®¡ç®—ï¼‰</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">right</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// frustum: Frustum</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è§†é”¥ä½“ï¼ˆé€è§†æˆ–æ­£äº¤æŠ•å½±ï¼‰</span></span><br><span class="line">    <span class="comment">// ç±»å‹: PerspectiveFrustum | OrthographicFrustum</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">frustum</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PerspectiveFrustum</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// defaultMoveAmount: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é»˜è®¤ç§»åŠ¨è·ç¦»</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 100000.0ï¼ˆç±³ï¼‰</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">defaultMoveAmount</span> = <span class="number">100000.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// defaultLookAmount: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é»˜è®¤æ—‹è½¬è§’åº¦</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Math.PI / 60ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">defaultLookAmount</span> = <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">60</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// defaultRotateAmount: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é»˜è®¤æ—‹è½¬è§’åº¦</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Math.PI / 3600ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">defaultRotateAmount</span> = <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">3600</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// defaultZoomAmount: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é»˜è®¤ç¼©æ”¾è·ç¦»</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 100000.0ï¼ˆç±³ï¼‰</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">defaultZoomAmount</span> = <span class="number">100000.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// constrainedAxis: Cartesian3</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: çº¦æŸè½´ï¼ˆé™åˆ¶ç›¸æœºæ—‹è½¬ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefinedï¼ˆæ— çº¦æŸï¼‰</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">constrainedAxis</span> = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// maximumZoomFactor: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æœ€å¤§ç¼©æ”¾å› å­</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1.5</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maximumZoomFactor</span> = <span class="number">1.5</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === äº‹ä»¶ ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveStart: Event</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: ç›¸æœºå¼€å§‹ç§»åŠ¨äº‹ä»¶</span></span><br><span class="line">  <span class="comment">// è§¦å‘: ç›¸æœºå¼€å§‹ç§»åŠ¨æ—¶</span></span><br><span class="line">  moveStart = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveEnd: Event</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: ç›¸æœºåœæ­¢ç§»åŠ¨äº‹ä»¶</span></span><br><span class="line">  <span class="comment">// è§¦å‘: ç›¸æœºåœæ­¢ç§»åŠ¨æ—¶</span></span><br><span class="line">  moveEnd = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// changed: Event</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: ç›¸æœºå˜åŒ–äº‹ä»¶</span></span><br><span class="line">  <span class="comment">// è§¦å‘: ç›¸æœºä½ç½®ã€æ–¹å‘æˆ–è§†é”¥ä½“å˜åŒ–æ—¶</span></span><br><span class="line">  changed = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === ä½ç½®è®¾ç½®æ–¹æ³• ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// setView - è®¾ç½®è§†å›¾</span></span><br><span class="line">  <span class="title function_">setView</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="comment">// destination: Cartesian3 | Rectangle</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç›®æ ‡ä½ç½®æˆ–åŒºåŸŸ</span></span><br><span class="line">    <span class="keyword">const</span> destination = options.<span class="property">destination</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// orientation: Object</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç›¸æœºæ–¹å‘</span></span><br><span class="line">    <span class="comment">// heading: number - èˆªå‘è§’ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">    <span class="comment">// pitch: number - ä¿¯ä»°è§’ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">    <span class="comment">// roll: number - ç¿»æ»šè§’ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">    <span class="keyword">const</span> orientation = options.<span class="property">orientation</span> || &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// endTransform: Matrix4</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç»“æŸå˜æ¢çŸ©é˜µ</span></span><br><span class="line">    <span class="keyword">const</span> endTransform = options.<span class="property">endTransform</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// flyTo - é£è¡Œåˆ°ç›®æ ‡</span></span><br><span class="line">  <span class="title function_">flyTo</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="comment">// destination: Cartesian3 | Rectangle</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç›®æ ‡ä½ç½®</span></span><br><span class="line">    <span class="keyword">const</span> destination = options.<span class="property">destination</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// orientation: Object</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç›®æ ‡æ–¹å‘</span></span><br><span class="line">    <span class="keyword">const</span> orientation = options.<span class="property">orientation</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// duration: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é£è¡Œæ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: è‡ªåŠ¨è®¡ç®—</span></span><br><span class="line">    <span class="keyword">const</span> duration = options.<span class="property">duration</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// complete: function</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å®Œæˆå›è°ƒ</span></span><br><span class="line">    <span class="keyword">const</span> complete = options.<span class="property">complete</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// cancel: function</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å–æ¶ˆå›è°ƒ</span></span><br><span class="line">    <span class="keyword">const</span> cancel = options.<span class="property">cancel</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// endTransform: Matrix4</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç»“æŸå˜æ¢çŸ©é˜µ</span></span><br><span class="line">    <span class="keyword">const</span> endTransform = options.<span class="property">endTransform</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// maximumHeight: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é£è¡Œæœ€å¤§é«˜åº¦</span></span><br><span class="line">    <span class="keyword">const</span> maximumHeight = options.<span class="property">maximumHeight</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// pitchAdjustHeight: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ä¿¯ä»°è§’è°ƒæ•´é«˜åº¦</span></span><br><span class="line">    <span class="keyword">const</span> pitchAdjustHeight = options.<span class="property">pitchAdjustHeight</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// flyOverLongitude: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é£è¶Šç»åº¦</span></span><br><span class="line">    <span class="keyword">const</span> flyOverLongitude = options.<span class="property">flyOverLongitude</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// flyOverLongitudeWeight: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é£è¶Šç»åº¦æƒé‡</span></span><br><span class="line">    <span class="keyword">const</span> flyOverLongitudeWeight = options.<span class="property">flyOverLongitudeWeight</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// convert: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦è½¬æ¢åæ ‡</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="keyword">const</span> convert = options.<span class="property">convert</span> !== <span class="literal">undefined</span> ? options.<span class="property">convert</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// easingFunction: EasingFunction</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç¼“åŠ¨å‡½æ•°</span></span><br><span class="line">    <span class="keyword">const</span> easingFunction = options.<span class="property">easingFunction</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// lookAt - çœ‹å‘ç›®æ ‡</span></span><br><span class="line">  <span class="title function_">lookAt</span>(<span class="params">target, offset</span>) &#123;</span><br><span class="line">    <span class="comment">// target: Cartesian3</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç›®æ ‡ä½ç½®</span></span><br><span class="line">    <span class="comment">// offset: Cartesian3 | HeadingPitchRange</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åç§»é‡æˆ–æ–¹å‘è·ç¦»</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// lookAtTransform - åº”ç”¨å˜æ¢åçœ‹å‘ç›®æ ‡</span></span><br><span class="line">  <span class="title function_">lookAtTransform</span>(<span class="params">transform, offset</span>) &#123;</span><br><span class="line">    <span class="comment">// transform: Matrix4</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å˜æ¢çŸ©é˜µ</span></span><br><span class="line">    <span class="comment">// offset: Cartesian3 | HeadingPitchRange</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åç§»é‡</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === ç§»åŠ¨æ–¹æ³• ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// move - ç§»åŠ¨ç›¸æœº</span></span><br><span class="line">  <span class="title function_">move</span>(<span class="params">direction, amount</span>) &#123;</span><br><span class="line">    <span class="comment">// direction: Cartesian3</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç§»åŠ¨æ–¹å‘ï¼ˆå•ä½å‘é‡ï¼‰</span></span><br><span class="line">    <span class="comment">// amount: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç§»åŠ¨è·ç¦»ï¼ˆç±³ï¼‰</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveForward - å‘å‰ç§»åŠ¨</span></span><br><span class="line">  <span class="title function_">moveForward</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultMoveAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - ç§»åŠ¨è·ç¦»</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveBackward - å‘åç§»åŠ¨</span></span><br><span class="line">  <span class="title function_">moveBackward</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultMoveAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - ç§»åŠ¨è·ç¦»</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveUp - å‘ä¸Šç§»åŠ¨</span></span><br><span class="line">  <span class="title function_">moveUp</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultMoveAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - ç§»åŠ¨è·ç¦»</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveDown - å‘ä¸‹ç§»åŠ¨</span></span><br><span class="line">  <span class="title function_">moveDown</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultMoveAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - ç§»åŠ¨è·ç¦»</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveLeft - å‘å·¦ç§»åŠ¨</span></span><br><span class="line">  <span class="title function_">moveLeft</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultMoveAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - ç§»åŠ¨è·ç¦»</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveRight - å‘å³ç§»åŠ¨</span></span><br><span class="line">  <span class="title function_">moveRight</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultMoveAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - ç§»åŠ¨è·ç¦»</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === æ—‹è½¬æ–¹æ³• ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// look - æ—‹è½¬ç›¸æœº</span></span><br><span class="line">  <span class="title function_">look</span>(<span class="params">axis, angle</span>) &#123;</span><br><span class="line">    <span class="comment">// axis: Cartesian3</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ—‹è½¬è½´</span></span><br><span class="line">    <span class="comment">// angle: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ—‹è½¬è§’åº¦ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// lookLeft - å‘å·¦çœ‹</span></span><br><span class="line">  <span class="title function_">lookLeft</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultLookAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - æ—‹è½¬è§’åº¦ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// lookRight - å‘å³çœ‹</span></span><br><span class="line">  <span class="title function_">lookRight</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultLookAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - æ—‹è½¬è§’åº¦ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// lookUp - å‘ä¸Šçœ‹</span></span><br><span class="line">  <span class="title function_">lookUp</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultLookAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - æ—‹è½¬è§’åº¦ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// lookDown - å‘ä¸‹çœ‹</span></span><br><span class="line">  <span class="title function_">lookDown</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultLookAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - æ—‹è½¬è§’åº¦ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// rotate - ç»•ç‚¹æ—‹è½¬</span></span><br><span class="line">  <span class="title function_">rotate</span>(<span class="params">axis, angle</span>) &#123;</span><br><span class="line">    <span class="comment">// axis: Cartesian3</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ—‹è½¬è½´</span></span><br><span class="line">    <span class="comment">// angle: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ—‹è½¬è§’åº¦ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// rotateLeft - å‘å·¦æ—‹è½¬</span></span><br><span class="line">  <span class="title function_">rotateLeft</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultRotateAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - æ—‹è½¬è§’åº¦ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// rotateRight - å‘å³æ—‹è½¬</span></span><br><span class="line">  <span class="title function_">rotateRight</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultRotateAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - æ—‹è½¬è§’åº¦ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// rotateUp - å‘ä¸Šæ—‹è½¬</span></span><br><span class="line">  <span class="title function_">rotateUp</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultRotateAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - æ—‹è½¬è§’åº¦ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// rotateDown - å‘ä¸‹æ—‹è½¬</span></span><br><span class="line">  <span class="title function_">rotateDown</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultRotateAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - æ—‹è½¬è§’åº¦ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === ç¼©æ”¾æ–¹æ³• ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// zoomIn - æ”¾å¤§</span></span><br><span class="line">  <span class="title function_">zoomIn</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultZoomAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - ç¼©æ”¾è·ç¦»ï¼ˆç±³ï¼‰</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// zoomOut - ç¼©å°</span></span><br><span class="line">  <span class="title function_">zoomOut</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultZoomAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - ç¼©æ”¾è·ç¦»ï¼ˆç±³ï¼‰</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === åæ ‡è½¬æ¢æ–¹æ³• ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// pickEllipsoid - æ‹¾å–æ¤­çƒé¢</span></span><br><span class="line">  <span class="title function_">pickEllipsoid</span>(<span class="params">windowPosition, ellipsoid = Cesium.Ellipsoid.WGS84</span>) &#123;</span><br><span class="line">    <span class="comment">// windowPosition: Cartesian2</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å±å¹•åæ ‡</span></span><br><span class="line">    <span class="comment">// ellipsoid: Ellipsoid</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ¤­çƒä½“</span></span><br><span class="line">    <span class="comment">// è¿”å›: Cartesian3 | undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getPickRay - è·å–æ‹¾å–å°„çº¿</span></span><br><span class="line">  <span class="title function_">getPickRay</span>(<span class="params">windowPosition</span>) &#123;</span><br><span class="line">    <span class="comment">// windowPosition: Cartesian2</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å±å¹•åæ ‡</span></span><br><span class="line">    <span class="comment">// è¿”å›: Ray</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// worldToCameraCoordinates - ä¸–ç•Œåæ ‡è½¬ç›¸æœºåæ ‡</span></span><br><span class="line">  <span class="title function_">worldToCameraCoordinates</span>(<span class="params">cartesian, result</span>) &#123;</span><br><span class="line">    <span class="comment">// cartesian: Cartesian3</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ä¸–ç•Œåæ ‡</span></span><br><span class="line">    <span class="comment">// result: Cartesian3</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç»“æœå¯¹è±¡</span></span><br><span class="line">    <span class="comment">// è¿”å›: Cartesian3</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cameraToWorldCoordinates - ç›¸æœºåæ ‡è½¬ä¸–ç•Œåæ ‡</span></span><br><span class="line">  <span class="title function_">cameraToWorldCoordinates</span>(<span class="params">cartesian, result</span>) &#123;</span><br><span class="line">    <span class="comment">// cartesian: Cartesian3</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç›¸æœºåæ ‡</span></span><br><span class="line">    <span class="comment">// result: Cartesian3</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç»“æœå¯¹è±¡</span></span><br><span class="line">    <span class="comment">// è¿”å›: Cartesian3</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === è®¡ç®—å±æ€§ ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// heading: number</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: èˆªå‘è§’ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">  <span class="comment">// åªè¯»: true</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">heading</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="property">TWO_PI</span> - <span class="title class_">Math</span>.<span class="title function_">atan2</span>(<span class="variable language_">this</span>.<span class="property">right</span>.<span class="property">y</span>, <span class="variable language_">this</span>.<span class="property">right</span>.<span class="property">x</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// pitch: number</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: ä¿¯ä»°è§’ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">  <span class="comment">// åªè¯»: true</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">pitch</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">asin</span>(<span class="variable language_">this</span>.<span class="property">direction</span>.<span class="property">z</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// roll: number</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: ç¿»æ»šè§’ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">  <span class="comment">// åªè¯»: true</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">roll</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">atan2</span>(-<span class="variable language_">this</span>.<span class="property">up</span>.<span class="property">x</span>, <span class="variable language_">this</span>.<span class="property">up</span>.<span class="property">z</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// positionCartographic: Cartographic</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: åœ°ç†åæ ‡ä½ç½®</span></span><br><span class="line">  <span class="comment">// åªè¯»: true</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">positionCartographic</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromCartesian</span>(<span class="variable language_">this</span>.<span class="property">position</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›¸æœºä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> camera = viewer.<span class="property">camera</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®ç›¸æœºä½ç½®</span></span><br><span class="line">camera.<span class="title function_">setView</span>(&#123;</span><br><span class="line">  <span class="attr">destination</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">1000</span>),</span><br><span class="line">  <span class="attr">orientation</span>: &#123;</span><br><span class="line">    <span class="attr">heading</span>: <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(<span class="number">0</span>), <span class="comment">// æ­£åŒ—æ–¹å‘</span></span><br><span class="line">    <span class="attr">pitch</span>: <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(-<span class="number">45</span>), <span class="comment">// å‘ä¸‹45åº¦</span></span><br><span class="line">    <span class="attr">roll</span>: <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(<span class="number">0</span>), <span class="comment">// æ— ç¿»æ»š</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// é£è¡Œåˆ°ä½ç½®</span></span><br><span class="line">camera.<span class="title function_">flyTo</span>(&#123;</span><br><span class="line">  <span class="attr">destination</span>: <span class="title class_">Cesium</span>.<span class="property">Rectangle</span>.<span class="title function_">fromDegrees</span>(<span class="number">115</span>, <span class="number">39</span>, <span class="number">117</span>, <span class="number">41</span>),</span><br><span class="line">  <span class="attr">duration</span>: <span class="number">3.0</span>,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;é£è¡Œå®Œæˆ&#x27;</span>),</span><br><span class="line">  <span class="attr">cancel</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;é£è¡Œå–æ¶ˆ&#x27;</span>),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›¸æœºäº‹ä»¶ç›‘å¬</span></span><br><span class="line">camera.<span class="property">moveStart</span>.<span class="title function_">addEventListener</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç›¸æœºå¼€å§‹ç§»åŠ¨&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">camera.<span class="property">moveEnd</span>.<span class="title function_">addEventListener</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç›¸æœºåœæ­¢ç§»åŠ¨&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">camera.<span class="property">changed</span>.<span class="title function_">addEventListener</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç›¸æœºå‘ç”Ÿå˜åŒ–&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›¸æœºæ§åˆ¶</span></span><br><span class="line">camera.<span class="title function_">moveForward</span>(<span class="number">1000</span>) <span class="comment">// å‘å‰ç§»åŠ¨1000ç±³</span></span><br><span class="line">camera.<span class="title function_">lookLeft</span>(<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>) <span class="comment">// å‘å·¦çœ‹45åº¦</span></span><br><span class="line">camera.<span class="title function_">zoomIn</span>(<span class="number">500</span>) <span class="comment">// æ”¾å¤§500ç±³</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–ç›¸æœºä¿¡æ¯</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç›¸æœºä½ç½®:&#x27;</span>, camera.<span class="property">position</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç›¸æœºæ–¹å‘:&#x27;</span>, camera.<span class="property">direction</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;èˆªå‘è§’:&#x27;</span>, <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(camera.<span class="property">heading</span>))</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ä¿¯ä»°è§’:&#x27;</span>, <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(camera.<span class="property">pitch</span>))</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç¿»æ»šè§’:&#x27;</span>, <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(camera.<span class="property">roll</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// åæ ‡è½¬æ¢</span></span><br><span class="line"><span class="keyword">const</span> screenPos = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">100</span>, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">const</span> worldPos = camera.<span class="title function_">pickEllipsoid</span>(screenPos)</span><br><span class="line"><span class="keyword">if</span> (worldPos) &#123;</span><br><span class="line">  <span class="keyword">const</span> cartographic = <span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromCartesian</span>(worldPos)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç‚¹å‡»ä½ç½®:&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">longitude</span>: <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(cartographic.<span class="property">longitude</span>),</span><br><span class="line">    <span class="attr">latitude</span>: <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(cartographic.<span class="property">latitude</span>),</span><br><span class="line">    <span class="attr">height</span>: cartographic.<span class="property">height</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="äº‹ä»¶ç³»ç»Ÿè¯¦è§£"><a href="#äº‹ä»¶ç³»ç»Ÿè¯¦è§£" class="headerlink" title="äº‹ä»¶ç³»ç»Ÿè¯¦è§£"></a>äº‹ä»¶ç³»ç»Ÿè¯¦è§£</h2><h3 id="ScreenSpaceEventHandler-å±å¹•ç©ºé—´äº‹ä»¶å¤„ç†å™¨"><a href="#ScreenSpaceEventHandler-å±å¹•ç©ºé—´äº‹ä»¶å¤„ç†å™¨" class="headerlink" title="ScreenSpaceEventHandler å±å¹•ç©ºé—´äº‹ä»¶å¤„ç†å™¨"></a>ScreenSpaceEventHandler å±å¹•ç©ºé—´äº‹ä»¶å¤„ç†å™¨</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ScreenSpaceEventHandler - å±å¹•ç©ºé—´äº‹ä»¶å¤„ç†å™¨</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ScreenSpaceEventHandler</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">canvas</span>) &#123;</span><br><span class="line">    <span class="comment">// canvas: HTMLCanvasElement</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: äº‹ä»¶ç›‘å¬çš„ç”»å¸ƒå…ƒç´ </span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span> = canvas</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setInputAction - è®¾ç½®è¾“å…¥åŠ¨ä½œ</span></span><br><span class="line">  <span class="title function_">setInputAction</span>(<span class="params">action, type, modifier</span>) &#123;</span><br><span class="line">    <span class="comment">// action: function</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: äº‹ä»¶å¤„ç†å‡½æ•°</span></span><br><span class="line">    <span class="comment">// å‚æ•°: eventå¯¹è±¡ï¼ŒåŒ…å«positionç­‰ä¿¡æ¯</span></span><br><span class="line">    <span class="comment">// type: ScreenSpaceEventType</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: äº‹ä»¶ç±»å‹</span></span><br><span class="line">    <span class="comment">// é€‰é¡¹: LEFT_CLICK, LEFT_DOUBLE_CLICK, LEFT_DOWN, LEFT_UP,</span></span><br><span class="line">    <span class="comment">//       RIGHT_CLICK, RIGHT_DOWN, RIGHT_UP,</span></span><br><span class="line">    <span class="comment">//       MIDDLE_CLICK, MIDDLE_DOWN, MIDDLE_UP,</span></span><br><span class="line">    <span class="comment">//       MOUSE_MOVE, WHEEL, PINCH_START, PINCH_END, PINCH_MOVE</span></span><br><span class="line">    <span class="comment">// modifier: KeyboardEventModifier (å¯é€‰)</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é”®ç›˜ä¿®é¥°ç¬¦</span></span><br><span class="line">    <span class="comment">// é€‰é¡¹: SHIFT, CTRL, ALT</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getInputAction - è·å–è¾“å…¥åŠ¨ä½œ</span></span><br><span class="line">  <span class="title function_">getInputAction</span>(<span class="params">type, modifier</span>) &#123;</span><br><span class="line">    <span class="comment">// è¿”å›: function | undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// removeInputAction - ç§»é™¤è¾“å…¥åŠ¨ä½œ</span></span><br><span class="line">  <span class="title function_">removeInputAction</span>(<span class="params">type, modifier</span>) &#123;</span><br><span class="line">    <span class="comment">// ç§»é™¤æŒ‡å®šç±»å‹çš„äº‹ä»¶å¤„ç†</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// isDestroyed - æ˜¯å¦å·²é”€æ¯</span></span><br><span class="line">  <span class="title function_">isDestroyed</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_isDestroyed</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// destroy - é”€æ¯å¤„ç†å™¨</span></span><br><span class="line">  <span class="title function_">destroy</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// æ¸…ç†æ‰€æœ‰äº‹ä»¶ç›‘å¬</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// äº‹ä»¶ç±»å‹è¯¦è§£</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ScreenSpaceEventType</span> = &#123;</span><br><span class="line">  <span class="comment">// é¼ æ ‡ç‚¹å‡»äº‹ä»¶</span></span><br><span class="line">  <span class="attr">LEFT_CLICK</span>: <span class="number">0</span>, <span class="comment">// å·¦é”®å•å‡»</span></span><br><span class="line">  <span class="attr">LEFT_DOUBLE_CLICK</span>: <span class="number">1</span>, <span class="comment">// å·¦é”®åŒå‡»</span></span><br><span class="line">  <span class="attr">LEFT_DOWN</span>: <span class="number">2</span>, <span class="comment">// å·¦é”®æŒ‰ä¸‹</span></span><br><span class="line">  <span class="attr">LEFT_UP</span>: <span class="number">3</span>, <span class="comment">// å·¦é”®æŠ¬èµ·</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">RIGHT_CLICK</span>: <span class="number">5</span>, <span class="comment">// å³é”®å•å‡»</span></span><br><span class="line">  <span class="attr">RIGHT_DOWN</span>: <span class="number">6</span>, <span class="comment">// å³é”®æŒ‰ä¸‹</span></span><br><span class="line">  <span class="attr">RIGHT_UP</span>: <span class="number">7</span>, <span class="comment">// å³é”®æŠ¬èµ·</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">MIDDLE_CLICK</span>: <span class="number">10</span>, <span class="comment">// ä¸­é”®å•å‡»</span></span><br><span class="line">  <span class="attr">MIDDLE_DOWN</span>: <span class="number">11</span>, <span class="comment">// ä¸­é”®æŒ‰ä¸‹</span></span><br><span class="line">  <span class="attr">MIDDLE_UP</span>: <span class="number">12</span>, <span class="comment">// ä¸­é”®æŠ¬èµ·</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// é¼ æ ‡ç§»åŠ¨å’Œæ»šè½®</span></span><br><span class="line">  <span class="attr">MOUSE_MOVE</span>: <span class="number">15</span>, <span class="comment">// é¼ æ ‡ç§»åŠ¨</span></span><br><span class="line">  <span class="attr">WHEEL</span>: <span class="number">16</span>, <span class="comment">// æ»šè½®æ»šåŠ¨</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§¦æ‘¸äº‹ä»¶</span></span><br><span class="line">  <span class="attr">PINCH_START</span>: <span class="number">17</span>, <span class="comment">// æåˆå¼€å§‹</span></span><br><span class="line">  <span class="attr">PINCH_END</span>: <span class="number">18</span>, <span class="comment">// æåˆç»“æŸ</span></span><br><span class="line">  <span class="attr">PINCH_MOVE</span>: <span class="number">19</span>, <span class="comment">// æåˆç§»åŠ¨</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é”®ç›˜ä¿®é¥°ç¬¦</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">KeyboardEventModifier</span> = &#123;</span><br><span class="line">  <span class="attr">SHIFT</span>: <span class="number">0</span>, <span class="comment">// Shifté”®</span></span><br><span class="line">  <span class="attr">CTRL</span>: <span class="number">1</span>, <span class="comment">// Ctrlé”®</span></span><br><span class="line">  <span class="attr">ALT</span>: <span class="number">2</span>, <span class="comment">// Alté”®</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// äº‹ä»¶å¤„ç†ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> handler = viewer.<span class="property">cesiumWidget</span>.<span class="property">screenSpaceEventHandler</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å·¦é”®ç‚¹å‡»äº‹ä»¶</span></span><br><span class="line">handler.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> position = event.<span class="property">position</span> <span class="comment">// Cartesian2å±å¹•åæ ‡</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ‹¾å–å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">const</span> pickedObject = viewer.<span class="property">scene</span>.<span class="title function_">pick</span>(position)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Cesium</span>.<span class="title function_">defined</span>(pickedObject)) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç‚¹å‡»äº†å¯¹è±¡:&#x27;</span>, pickedObject.<span class="property">id</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€‰ä¸­å®ä½“</span></span><br><span class="line">    viewer.<span class="property">selectedEntity</span> = pickedObject.<span class="property">id</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æ‹¾å–åœ°é¢ä½ç½®</span></span><br><span class="line">    <span class="keyword">const</span> cartesian = viewer.<span class="property">camera</span>.<span class="title function_">pickEllipsoid</span>(position, viewer.<span class="property">scene</span>.<span class="property">globe</span>.<span class="property">ellipsoid</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cartesian) &#123;</span><br><span class="line">      <span class="keyword">const</span> cartographic = <span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromCartesian</span>(cartesian)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç‚¹å‡»åœ°é¢ä½ç½®:&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">longitude</span>: <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(cartographic.<span class="property">longitude</span>),</span><br><span class="line">        <span class="attr">latitude</span>: <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(cartographic.<span class="property">latitude</span>),</span><br><span class="line">        <span class="attr">height</span>: cartographic.<span class="property">height</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">LEFT_CLICK</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å³é”®ç‚¹å‡»äº‹ä»¶</span></span><br><span class="line">handler.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> position = event.<span class="property">position</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ˜¾ç¤ºä¸Šä¸‹æ–‡èœå•</span></span><br><span class="line">  <span class="title function_">showContextMenu</span>(position)</span><br><span class="line">&#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">RIGHT_CLICK</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// é¼ æ ‡ç§»åŠ¨äº‹ä»¶</span></span><br><span class="line">handler.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> startPosition = event.<span class="property">startPosition</span> <span class="comment">// å¼€å§‹ä½ç½®</span></span><br><span class="line">  <span class="keyword">const</span> endPosition = event.<span class="property">endPosition</span> <span class="comment">// ç»“æŸä½ç½®</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ‹¾å–æ‚¬åœå¯¹è±¡</span></span><br><span class="line">  <span class="keyword">const</span> pickedObject = viewer.<span class="property">scene</span>.<span class="title function_">pick</span>(endPosition)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Cesium</span>.<span class="title function_">defined</span>(pickedObject)) &#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">style</span>.<span class="property">cursor</span> = <span class="string">&#x27;pointer&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¾ç¤ºå·¥å…·æç¤º</span></span><br><span class="line">    <span class="title function_">showTooltip</span>(endPosition, pickedObject.<span class="property">id</span>.<span class="property">name</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">style</span>.<span class="property">cursor</span> = <span class="string">&#x27;default&#x27;</span></span><br><span class="line">    <span class="title function_">hideTooltip</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">MOUSE_MOVE</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ»šè½®äº‹ä»¶</span></span><br><span class="line">handler.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> delta = event <span class="comment">// æ»šè½®å¢é‡</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ»šè½®æ»šåŠ¨:&#x27;</span>, delta)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è‡ªå®šä¹‰ç¼©æ”¾é€»è¾‘</span></span><br><span class="line">  <span class="keyword">if</span> (delta &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    viewer.<span class="property">camera</span>.<span class="title function_">zoomIn</span>(viewer.<span class="property">camera</span>.<span class="property">defaultZoomAmount</span> * <span class="number">0.5</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    viewer.<span class="property">camera</span>.<span class="title function_">zoomOut</span>(viewer.<span class="property">camera</span>.<span class="property">defaultZoomAmount</span> * <span class="number">0.5</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">WHEEL</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å·¦é”®æ‹–æ‹½äº‹ä»¶</span></span><br><span class="line"><span class="keyword">let</span> isDragging = <span class="literal">false</span></span><br><span class="line"><span class="keyword">let</span> startPosition</span><br><span class="line"></span><br><span class="line">handler.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  isDragging = <span class="literal">true</span></span><br><span class="line">  startPosition = event.<span class="property">position</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¦ç”¨é»˜è®¤ç›¸æœºæ§åˆ¶</span></span><br><span class="line">  viewer.<span class="property">scene</span>.<span class="property">screenSpaceCameraController</span>.<span class="property">enableRotate</span> = <span class="literal">false</span></span><br><span class="line">&#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">LEFT_DOWN</span>)</span><br><span class="line"></span><br><span class="line">handler.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (isDragging) &#123;</span><br><span class="line">    <span class="keyword">const</span> endPosition = event.<span class="property">endPosition</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¡ç®—æ‹–æ‹½è·ç¦»</span></span><br><span class="line">    <span class="keyword">const</span> deltaX = endPosition.<span class="property">x</span> - startPosition.<span class="property">x</span></span><br><span class="line">    <span class="keyword">const</span> deltaY = endPosition.<span class="property">y</span> - startPosition.<span class="property">y</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ‹–æ‹½è·ç¦»:&#x27;</span>, &#123; deltaX, deltaY &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è‡ªå®šä¹‰æ‹–æ‹½é€»è¾‘</span></span><br><span class="line">    <span class="title function_">customDragLogic</span>(deltaX, deltaY)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">MOUSE_MOVE</span>)</span><br><span class="line"></span><br><span class="line">handler.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  isDragging = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¢å¤é»˜è®¤ç›¸æœºæ§åˆ¶</span></span><br><span class="line">  viewer.<span class="property">scene</span>.<span class="property">screenSpaceCameraController</span>.<span class="property">enableRotate</span> = <span class="literal">true</span></span><br><span class="line">&#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">LEFT_UP</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¸¦ä¿®é¥°ç¬¦çš„äº‹ä»¶</span></span><br><span class="line">handler.<span class="title function_">setInputAction</span>(</span><br><span class="line">  <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Ctrl + å·¦é”®ç‚¹å‡»&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤šé€‰æ¨¡å¼</span></span><br><span class="line">    <span class="title function_">toggleEntitySelection</span>(event.<span class="property">position</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">LEFT_CLICK</span>,</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">KeyboardEventModifier</span>.<span class="property">CTRL</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">handler.<span class="title function_">setInputAction</span>(</span><br><span class="line">  <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Shift + å·¦é”®ç‚¹å‡»&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¡†é€‰æ¨¡å¼</span></span><br><span class="line">    <span class="title function_">startBoxSelection</span>(event.<span class="property">position</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">LEFT_CLICK</span>,</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">KeyboardEventModifier</span>.<span class="property">SHIFT</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨è®¾å¤‡ï¼‰</span></span><br><span class="line">handler.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> position1 = event.<span class="property">position1</span> <span class="comment">// ç¬¬ä¸€ä¸ªè§¦æ‘¸ç‚¹</span></span><br><span class="line">  <span class="keyword">const</span> position2 = event.<span class="property">position2</span> <span class="comment">// ç¬¬äºŒä¸ªè§¦æ‘¸ç‚¹</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å¼€å§‹æåˆæ‰‹åŠ¿&#x27;</span>)</span><br><span class="line">&#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">PINCH_START</span>)</span><br><span class="line"></span><br><span class="line">handler.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> position1 = event.<span class="property">position1</span></span><br><span class="line">  <span class="keyword">const</span> position2 = event.<span class="property">position2</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¡ç®—ç¼©æ”¾æ¯”ä¾‹</span></span><br><span class="line">  <span class="keyword">const</span> distance = <span class="title class_">Cesium</span>.<span class="property">Cartesian2</span>.<span class="title function_">distance</span>(position1, position2)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æåˆè·ç¦»:&#x27;</span>, distance)</span><br><span class="line">&#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">PINCH_MOVE</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰å·¥å…·æç¤º</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showTooltip</span>(<span class="params">position, text</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> tooltip = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;tooltip&#x27;</span>)</span><br><span class="line">  <span class="keyword">if</span> (!tooltip) &#123;</span><br><span class="line">    <span class="keyword">const</span> div = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    div.<span class="property">id</span> = <span class="string">&#x27;tooltip&#x27;</span></span><br><span class="line">    div.<span class="property">style</span>.<span class="property">position</span> = <span class="string">&#x27;absolute&#x27;</span></span><br><span class="line">    div.<span class="property">style</span>.<span class="property">background</span> = <span class="string">&#x27;rgba(0,0,0,0.8)&#x27;</span></span><br><span class="line">    div.<span class="property">style</span>.<span class="property">color</span> = <span class="string">&#x27;white&#x27;</span></span><br><span class="line">    div.<span class="property">style</span>.<span class="property">padding</span> = <span class="string">&#x27;5px&#x27;</span></span><br><span class="line">    div.<span class="property">style</span>.<span class="property">borderRadius</span> = <span class="string">&#x27;3px&#x27;</span></span><br><span class="line">    div.<span class="property">style</span>.<span class="property">pointerEvents</span> = <span class="string">&#x27;none&#x27;</span></span><br><span class="line">    div.<span class="property">style</span>.<span class="property">zIndex</span> = <span class="string">&#x27;1000&#x27;</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(div)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> tooltip = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;tooltip&#x27;</span>)</span><br><span class="line">  tooltip.<span class="property">textContent</span> = text</span><br><span class="line">  tooltip.<span class="property">style</span>.<span class="property">left</span> = position.<span class="property">x</span> + <span class="number">10</span> + <span class="string">&#x27;px&#x27;</span></span><br><span class="line">  tooltip.<span class="property">style</span>.<span class="property">top</span> = position.<span class="property">y</span> - <span class="number">30</span> + <span class="string">&#x27;px&#x27;</span></span><br><span class="line">  tooltip.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;block&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hideTooltip</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> tooltip = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;tooltip&#x27;</span>)</span><br><span class="line">  <span class="keyword">if</span> (tooltip) &#123;</span><br><span class="line">    tooltip.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç§»é™¤äº‹ä»¶å¤„ç†</span></span><br><span class="line">handler.<span class="title function_">removeInputAction</span>(<span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">LEFT_CLICK</span>)</span><br><span class="line">handler.<span class="title function_">removeInputAction</span>(<span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">LEFT_CLICK</span>, <span class="title class_">Cesium</span>.<span class="property">KeyboardEventModifier</span>.<span class="property">CTRL</span>)</span><br></pre></td></tr></table></figure><h2 id="æè´¨ç³»ç»Ÿè¯¦è§£"><a href="#æè´¨ç³»ç»Ÿè¯¦è§£" class="headerlink" title="æè´¨ç³»ç»Ÿè¯¦è§£"></a>æè´¨ç³»ç»Ÿè¯¦è§£</h2><h3 id="Material-æè´¨ç±»"><a href="#Material-æè´¨ç±»" class="headerlink" title="Material æè´¨ç±»"></a>Material æè´¨ç±»</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Material - æè´¨åŸºç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Material</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// fabric: Object</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æè´¨æè¿°å¯¹è±¡</span></span><br><span class="line">    <span class="comment">// åŒ…å«: type, uniforms, sourceç­‰</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fabric</span> = options.<span class="property">fabric</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// translucent: boolean | function</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦é€æ˜</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: æ ¹æ®æè´¨ç±»å‹ç¡®å®š</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">translucent</span> = options.<span class="property">translucent</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é™æ€æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromType - ä»ç±»å‹åˆ›å»ºæè´¨</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromType</span>(<span class="params">type, uniforms</span>) &#123;</span><br><span class="line">    <span class="comment">// type: string - æè´¨ç±»å‹</span></span><br><span class="line">    <span class="comment">// uniforms: Object - æè´¨å‚æ•°</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Material</span>(&#123;</span><br><span class="line">      <span class="attr">fabric</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: type,</span><br><span class="line">        <span class="attr">uniforms</span>: uniforms,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å†…ç½®æè´¨ç±»å‹</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">ColorType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Color&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// çº¯è‰²</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">ImageType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Image&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// å›¾ç‰‡</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">DiffuseMapType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;DiffuseMap&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// æ¼«åå°„è´´å›¾</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">AlphaMapType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;AlphaMap&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// é€æ˜è´´å›¾</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">SpecularMapType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;SpecularMap&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// é•œé¢è´´å›¾</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">EmissionMapType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;EmissionMap&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// å‘å°„è´´å›¾</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">BumpMapType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;BumpMap&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// å‡¹å‡¸è´´å›¾</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">NormalMapType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;NormalMap&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// æ³•çº¿è´´å›¾</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">GridType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Grid&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// ç½‘æ ¼</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">StripeType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Stripe&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// æ¡çº¹</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">CheckerboardType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Checkerboard&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// æ£‹ç›˜</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">DotType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Dot&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// ç‚¹</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">WaterType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Water&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// æ°´é¢</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">RimLightingType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;RimLighting&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// è¾¹ç¼˜å…‰ç…§</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">FadeType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Fade&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// æ¸å˜</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">PolylineArrowType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;PolylineArrow&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// ç®­å¤´çº¿</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">PolylineGlowType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;PolylineGlow&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// å‘å…‰çº¿</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">PolylineOutlineType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;PolylineOutline&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// è½®å»“çº¿</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é¢œè‰²æè´¨</span></span><br><span class="line"><span class="keyword">const</span> colorMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ColorMaterialProperty</span>(<span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å›¾ç‰‡æè´¨</span></span><br><span class="line"><span class="keyword">const</span> imageMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ImageMaterialProperty</span>(&#123;</span><br><span class="line">  <span class="attr">image</span>: <span class="string">&#x27;path/to/texture.jpg&#x27;</span>, <span class="comment">// å›¾ç‰‡è·¯å¾„</span></span><br><span class="line">  <span class="attr">repeat</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">2.0</span>, <span class="number">2.0</span>), <span class="comment">// é‡å¤æ¬¡æ•°</span></span><br><span class="line">  <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span>, <span class="comment">// æ··åˆé¢œè‰²</span></span><br><span class="line">  <span class="attr">transparent</span>: <span class="literal">false</span>, <span class="comment">// æ˜¯å¦é€æ˜</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç½‘æ ¼æè´¨</span></span><br><span class="line"><span class="keyword">const</span> gridMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">GridMaterialProperty</span>(&#123;</span><br><span class="line">  <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>, <span class="comment">// ç½‘æ ¼é¢œè‰²</span></span><br><span class="line">  <span class="attr">cellAlpha</span>: <span class="number">0.1</span>, <span class="comment">// å•å…ƒæ ¼é€æ˜åº¦</span></span><br><span class="line">  <span class="attr">lineCount</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">8</span>, <span class="number">8</span>), <span class="comment">// ç½‘æ ¼æ•°é‡</span></span><br><span class="line">  <span class="attr">lineThickness</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">2.0</span>, <span class="number">2.0</span>), <span class="comment">// çº¿æ¡ç²—ç»†</span></span><br><span class="line">  <span class="attr">lineOffset</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">0.5</span>, <span class="number">0.5</span>), <span class="comment">// çº¿æ¡åç§»</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¡çº¹æè´¨</span></span><br><span class="line"><span class="keyword">const</span> stripeMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">StripeMaterialProperty</span>(&#123;</span><br><span class="line">  <span class="attr">evenColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span>, <span class="comment">// å¶æ•°æ¡çº¹é¢œè‰²</span></span><br><span class="line">  <span class="attr">oddColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>, <span class="comment">// å¥‡æ•°æ¡çº¹é¢œè‰²</span></span><br><span class="line">  <span class="attr">repeat</span>: <span class="number">16.0</span>, <span class="comment">// æ¡çº¹æ•°é‡</span></span><br><span class="line">  <span class="attr">offset</span>: <span class="number">0.0</span>, <span class="comment">// åç§»é‡</span></span><br><span class="line">  <span class="attr">orientation</span>: <span class="title class_">Cesium</span>.<span class="property">StripeOrientation</span>.<span class="property">HORIZONTAL</span>, <span class="comment">// æ–¹å‘</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£‹ç›˜æè´¨</span></span><br><span class="line"><span class="keyword">const</span> checkerboardMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">CheckerboardMaterialProperty</span>(&#123;</span><br><span class="line">  <span class="attr">evenColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span>, <span class="comment">// å¶æ•°æ ¼é¢œè‰²</span></span><br><span class="line">  <span class="attr">oddColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>, <span class="comment">// å¥‡æ•°æ ¼é¢œè‰²</span></span><br><span class="line">  <span class="attr">repeat</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">4.0</span>, <span class="number">4.0</span>), <span class="comment">// é‡å¤æ¬¡æ•°</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç‚¹æè´¨</span></span><br><span class="line"><span class="keyword">const</span> dotMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">DotMaterialProperty</span>(&#123;</span><br><span class="line">  <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>, <span class="comment">// ç‚¹é¢œè‰²</span></span><br><span class="line">  <span class="attr">repeat</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">16.0</span>, <span class="number">16.0</span>), <span class="comment">// ç‚¹çš„é‡å¤æ¬¡æ•°</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ°´é¢æè´¨</span></span><br><span class="line"><span class="keyword">const</span> waterMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">WaterMaterialProperty</span>(&#123;</span><br><span class="line">  <span class="attr">baseWaterColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">AQUA</span>, <span class="comment">// åŸºç¡€æ°´è‰²</span></span><br><span class="line">  <span class="attr">blendColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLUE</span>, <span class="comment">// æ··åˆé¢œè‰²</span></span><br><span class="line">  <span class="attr">specularMap</span>: <span class="string">&#x27;path/to/specular.jpg&#x27;</span>, <span class="comment">// é•œé¢è´´å›¾</span></span><br><span class="line">  <span class="attr">normalMap</span>: <span class="string">&#x27;path/to/normal.jpg&#x27;</span>, <span class="comment">// æ³•çº¿è´´å›¾</span></span><br><span class="line">  <span class="attr">frequency</span>: <span class="number">10.0</span>, <span class="comment">// æ³¢æµªé¢‘ç‡</span></span><br><span class="line">  <span class="attr">animationSpeed</span>: <span class="number">0.01</span>, <span class="comment">// åŠ¨ç”»é€Ÿåº¦</span></span><br><span class="line">  <span class="attr">amplitude</span>: <span class="number">1.0</span>, <span class="comment">// æ³¢å¹…</span></span><br><span class="line">  <span class="attr">specularIntensity</span>: <span class="number">0.5</span>, <span class="comment">// é•œé¢å¼ºåº¦</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾¹ç¼˜å…‰ç…§æè´¨</span></span><br><span class="line"><span class="keyword">const</span> rimLightingMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">RimLightingMaterialProperty</span>(&#123;</span><br><span class="line">  <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">LIME</span>, <span class="comment">// è¾¹ç¼˜é¢œè‰²</span></span><br><span class="line">  <span class="attr">rimColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span>, <span class="comment">// è¾¹ç¼˜å…‰é¢œè‰²</span></span><br><span class="line">  <span class="attr">alpha</span>: <span class="number">1.0</span>, <span class="comment">// é€æ˜åº¦</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¸å˜æè´¨</span></span><br><span class="line"><span class="keyword">const</span> fadeMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">FadeMaterialProperty</span>(&#123;</span><br><span class="line">  <span class="attr">fadeInColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span>, <span class="comment">// æ¸å…¥é¢œè‰²</span></span><br><span class="line">  <span class="attr">fadeOutColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLUE</span>, <span class="comment">// æ¸å‡ºé¢œè‰²</span></span><br><span class="line">  <span class="attr">maximumDistance</span>: <span class="number">500000.0</span>, <span class="comment">// æœ€å¤§è·ç¦»</span></span><br><span class="line">  <span class="attr">repeat</span>: <span class="literal">true</span>, <span class="comment">// æ˜¯å¦é‡å¤</span></span><br><span class="line">  <span class="attr">fadeDirection</span>: &#123;</span><br><span class="line">    <span class="comment">// æ¸å˜æ–¹å‘</span></span><br><span class="line">    <span class="attr">x</span>: <span class="number">1.0</span>,</span><br><span class="line">    <span class="attr">y</span>: <span class="number">0.0</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤šæ®µçº¿æè´¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç®­å¤´çº¿æè´¨</span></span><br><span class="line"><span class="keyword">const</span> arrowMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PolylineArrowMaterialProperty</span>(<span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘å…‰çº¿æè´¨</span></span><br><span class="line"><span class="keyword">const</span> glowMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PolylineGlowMaterialProperty</span>(&#123;</span><br><span class="line">  <span class="attr">glowPower</span>: <span class="number">0.2</span>, <span class="comment">// å‘å…‰å¼ºåº¦</span></span><br><span class="line">  <span class="attr">taperPower</span>: <span class="number">0.5</span>, <span class="comment">// é”¥å½¢å¼ºåº¦</span></span><br><span class="line">  <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLUE</span>, <span class="comment">// é¢œè‰²</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è™šçº¿æè´¨</span></span><br><span class="line"><span class="keyword">const</span> dashMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PolylineDashMaterialProperty</span>(&#123;</span><br><span class="line">  <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">CYAN</span>, <span class="comment">// é¢œè‰²</span></span><br><span class="line">  <span class="attr">gapColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">TRANSPARENT</span>, <span class="comment">// é—´éš™é¢œè‰²</span></span><br><span class="line">  <span class="attr">dashLength</span>: <span class="number">16.0</span>, <span class="comment">// è™šçº¿é•¿åº¦</span></span><br><span class="line">  <span class="attr">dashPattern</span>: <span class="number">255</span>, <span class="comment">// è™šçº¿æ¨¡å¼ï¼ˆäºŒè¿›åˆ¶ï¼‰</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è½®å»“çº¿æè´¨</span></span><br><span class="line"><span class="keyword">const</span> outlineMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PolylineOutlineMaterialProperty</span>(&#123;</span><br><span class="line">  <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">ORANGE</span>, <span class="comment">// å†…éƒ¨é¢œè‰²</span></span><br><span class="line">  <span class="attr">outlineColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>, <span class="comment">// è½®å»“é¢œè‰²</span></span><br><span class="line">  <span class="attr">outlineWidth</span>: <span class="number">2.0</span>, <span class="comment">// è½®å»“å®½åº¦</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰ç€è‰²å™¨æè´¨</span></span><br><span class="line"><span class="keyword">const</span> customMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Material</span>(&#123;</span><br><span class="line">  <span class="attr">fabric</span>: &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;CustomShader&#x27;</span>,</span><br><span class="line">    <span class="attr">uniforms</span>: &#123;</span><br><span class="line">      <span class="attr">color</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Color</span>(<span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>),</span><br><span class="line">      <span class="attr">time</span>: <span class="number">0.0</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">source</span>: <span class="string">`</span></span><br><span class="line"><span class="string">      uniform vec4 color;</span></span><br><span class="line"><span class="string">      uniform float time;</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">      czm_material czm_getMaterial(czm_materialInput materialInput) &#123;</span></span><br><span class="line"><span class="string">        czm_material material = czm_getDefaultMaterial(materialInput);</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        vec2 st = materialInput.st;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        // åŠ¨ç”»æ³¢çº¹æ•ˆæœ</span></span><br><span class="line"><span class="string">        float wave = sin(st.s * 10.0 + time) * 0.5 + 0.5;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        material.diffuse = color.rgb * wave;</span></span><br><span class="line"><span class="string">        material.alpha = color.a;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        return material;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    `</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åº”ç”¨æè´¨åˆ°å®ä½“</span></span><br><span class="line"><span class="keyword">const</span> entity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">rectangle</span>: &#123;</span><br><span class="line">    <span class="attr">coordinates</span>: <span class="title class_">Cesium</span>.<span class="property">Rectangle</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.0</span>, <span class="number">39.0</span>, <span class="number">117.0</span>, <span class="number">40.0</span>),</span><br><span class="line">    <span class="attr">material</span>: imageMaterial, <span class="comment">// åº”ç”¨å›¾ç‰‡æè´¨</span></span><br><span class="line">    <span class="attr">height</span>: <span class="number">0</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŠ¨æ€æ”¹å˜æè´¨</span></span><br><span class="line">entity.<span class="property">rectangle</span>.<span class="property">material</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">CallbackProperty</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// æ ¹æ®æ—¶é—´å˜åŒ–è¿”å›ä¸åŒæè´¨</span></span><br><span class="line">  <span class="keyword">const</span> time = viewer.<span class="property">clock</span>.<span class="property">currentTime</span></span><br><span class="line">  <span class="keyword">const</span> seconds = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">secondsDifference</span>(time, viewer.<span class="property">clock</span>.<span class="property">startTime</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (seconds % <span class="number">4</span> &lt; <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLUE</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="literal">false</span>)</span><br></pre></td></tr></table></figure><h2 id="åŠ¨ç”»ç³»ç»Ÿè¯¦è§£"><a href="#åŠ¨ç”»ç³»ç»Ÿè¯¦è§£" class="headerlink" title="åŠ¨ç”»ç³»ç»Ÿè¯¦è§£"></a>åŠ¨ç”»ç³»ç»Ÿè¯¦è§£</h2><h3 id="Animation-åŠ¨ç”»"><a href="#Animation-åŠ¨ç”»" class="headerlink" title="Animation åŠ¨ç”»"></a>Animation åŠ¨ç”»</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Clock - æ—¶é’Ÿç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Clock</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// startTime: JulianDate</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¼€å§‹æ—¶é—´</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: JulianDate.now()</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">startTime</span> = options.<span class="property">startTime</span> || <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">now</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// stopTime: JulianDate</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç»“æŸæ—¶é—´</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: å¼€å§‹æ—¶é—´ + 1å¤©</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">stopTime</span> =</span><br><span class="line">      options.<span class="property">stopTime</span> || <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addDays</span>(<span class="variable language_">this</span>.<span class="property">startTime</span>, <span class="number">1</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// currentTime: JulianDate</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å½“å‰æ—¶é—´</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: å¼€å§‹æ—¶é—´</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">currentTime</span> = options.<span class="property">currentTime</span> || <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">clone</span>(<span class="variable language_">this</span>.<span class="property">startTime</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// multiplier: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ—¶é—´å€ç‡</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1.0ï¼ˆå®æ—¶ï¼‰</span></span><br><span class="line">    <span class="comment">// æ­£å€¼: æ­£å‘æ’­æ”¾ï¼Œè´Ÿå€¼: åå‘æ’­æ”¾</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">multiplier</span> = options.<span class="property">multiplier</span> !== <span class="literal">undefined</span> ? options.<span class="property">multiplier</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// clockStep: ClockStep</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ—¶é’Ÿæ­¥è¿›æ¨¡å¼</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: ClockStep.SYSTEM_CLOCK_MULTIPLIER</span></span><br><span class="line">    <span class="comment">// é€‰é¡¹: TICK_DEPENDENT, SYSTEM_CLOCK_MULTIPLIER, SYSTEM_CLOCK</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clockStep</span> = options.<span class="property">clockStep</span> || <span class="title class_">Cesium</span>.<span class="property">ClockStep</span>.<span class="property">SYSTEM_CLOCK_MULTIPLIER</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// clockRange: ClockRange</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ—¶é’ŸèŒƒå›´è¡Œä¸º</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: ClockRange.UNBOUNDED</span></span><br><span class="line">    <span class="comment">// é€‰é¡¹: UNBOUNDED, CLAMPED, LOOP_STOP</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clockRange</span> = options.<span class="property">clockRange</span> || <span class="title class_">Cesium</span>.<span class="property">ClockRange</span>.<span class="property">UNBOUNDED</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// canAnimate: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦å¯ä»¥åŠ¨ç”»</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canAnimate</span> = options.<span class="property">canAnimate</span> !== <span class="literal">undefined</span> ? options.<span class="property">canAnimate</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// shouldAnimate: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦åº”è¯¥åŠ¨ç”»</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shouldAnimate</span> = options.<span class="property">shouldAnimate</span> !== <span class="literal">undefined</span> ? options.<span class="property">shouldAnimate</span> : <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// äº‹ä»¶</span></span><br><span class="line">  <span class="comment">// onTick: Event</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ—¶é’Ÿæ»´ç­”äº‹ä»¶</span></span><br><span class="line">  <span class="comment">// å‚æ•°: clockå¯¹è±¡</span></span><br><span class="line">  onTick = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// onStop: Event</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ—¶é’Ÿåœæ­¢äº‹ä»¶</span></span><br><span class="line">  onStop = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// tick - æ—¶é’Ÿæ»´ç­”</span></span><br><span class="line">  <span class="title function_">tick</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// æ›´æ–°å½“å‰æ—¶é—´å¹¶è§¦å‘äº‹ä»¶</span></span><br><span class="line">    <span class="keyword">const</span> currentTime = <span class="variable language_">this</span>.<span class="property">currentTime</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">onTick</span>.<span class="title function_">raiseEvent</span>(<span class="variable language_">this</span>)</span><br><span class="line">    <span class="keyword">return</span> currentTime</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ—¶é—´ç›¸å…³ç±»å‹</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ClockStep</span> = &#123;</span><br><span class="line">  <span class="attr">TICK_DEPENDENT</span>: <span class="number">0</span>, <span class="comment">// ä¾èµ–æ»´ç­”</span></span><br><span class="line">  <span class="attr">SYSTEM_CLOCK_MULTIPLIER</span>: <span class="number">1</span>, <span class="comment">// ç³»ç»Ÿæ—¶é’Ÿå€ç‡</span></span><br><span class="line">  <span class="attr">SYSTEM_CLOCK</span>: <span class="number">2</span>, <span class="comment">// ç³»ç»Ÿæ—¶é’Ÿ</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ClockRange</span> = &#123;</span><br><span class="line">  <span class="attr">UNBOUNDED</span>: <span class="number">0</span>, <span class="comment">// æ— ç•Œé™</span></span><br><span class="line">  <span class="attr">CLAMPED</span>: <span class="number">1</span>, <span class="comment">// é’³åˆ¶</span></span><br><span class="line">  <span class="attr">LOOP_STOP</span>: <span class="number">2</span>, <span class="comment">// å¾ªç¯åœæ­¢</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Property - å±æ€§ç±»ï¼ˆåŠ¨ç”»åŸºç¡€ï¼‰</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Property</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// definitionChanged: Event</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å®šä¹‰å˜åŒ–äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">definitionChanged</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// isConstant: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦ä¸ºå¸¸é‡</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isConstant</span> = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getValue - è·å–æŒ‡å®šæ—¶é—´çš„å€¼</span></span><br><span class="line">  <span class="title function_">getValue</span>(<span class="params">time, result</span>) &#123;</span><br><span class="line">    <span class="comment">// time: JulianDate - æ—¶é—´</span></span><br><span class="line">    <span class="comment">// result: Object - ç»“æœå¯¹è±¡</span></span><br><span class="line">    <span class="comment">// è¿”å›: å±æ€§å€¼</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// equals - æ¯”è¾ƒç›¸ç­‰</span></span><br><span class="line">  <span class="title function_">equals</span>(<span class="params">other</span>) &#123;</span><br><span class="line">    <span class="comment">// other: Property - å…¶ä»–å±æ€§</span></span><br><span class="line">    <span class="comment">// è¿”å›: boolean</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ConstantProperty - å¸¸é‡å±æ€§</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConstantProperty</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Property</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_value</span> = value</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isConstant</span> = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getValue</span>(<span class="params">time, result</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_value</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setValue</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> oldValue = <span class="variable language_">this</span>.<span class="property">_value</span></span><br><span class="line">    <span class="keyword">if</span> (oldValue !== value) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_value</span> = value</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">definitionChanged</span>.<span class="title function_">raiseEvent</span>(<span class="variable language_">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SampledProperty - é‡‡æ ·å±æ€§ï¼ˆå…³é”®å¸§åŠ¨ç”»ï¼‰</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SampledProperty</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Property</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">type</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_type</span> = type</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_times</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_values</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_interpolationDegree</span> = <span class="number">1</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_interpolationAlgorithm</span> = <span class="title class_">Cesium</span>.<span class="property">LinearApproximation</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// addSample - æ·»åŠ é‡‡æ ·ç‚¹</span></span><br><span class="line">  <span class="title function_">addSample</span>(<span class="params">time, value</span>) &#123;</span><br><span class="line">    <span class="comment">// time: JulianDate - æ—¶é—´</span></span><br><span class="line">    <span class="comment">// value: Object - å€¼</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// addSamples - æ‰¹é‡æ·»åŠ é‡‡æ ·ç‚¹</span></span><br><span class="line">  <span class="title function_">addSamples</span>(<span class="params">times, values</span>) &#123;</span><br><span class="line">    <span class="comment">// times: Array&lt;JulianDate&gt; - æ—¶é—´æ•°ç»„</span></span><br><span class="line">    <span class="comment">// values: Array&lt;Object&gt; - å€¼æ•°ç»„</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// removeSample - ç§»é™¤é‡‡æ ·ç‚¹</span></span><br><span class="line">  <span class="title function_">removeSample</span>(<span class="params">time</span>) &#123;</span><br><span class="line">    <span class="comment">// time: JulianDate - æ—¶é—´</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setInterpolationOptions - è®¾ç½®æ’å€¼é€‰é¡¹</span></span><br><span class="line">  <span class="title function_">setInterpolationOptions</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="comment">// options.interpolationDegree: number - æ’å€¼åº¦æ•°</span></span><br><span class="line">    <span class="comment">// options.interpolationAlgorithm: InterpolationAlgorithm - æ’å€¼ç®—æ³•</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CallbackProperty - å›è°ƒå±æ€§ï¼ˆç¨‹åºåŒ–åŠ¨ç”»ï¼‰</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CallbackProperty</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Property</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">callback, isConstant</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_callback</span> = callback</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isConstant</span> = isConstant || <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getValue</span>(<span class="params">time, result</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_callback</span>(time, result)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CompositeProperty - å¤åˆå±æ€§ï¼ˆåˆ†æ®µåŠ¨ç”»ï¼‰</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CompositeProperty</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Property</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_intervals</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeIntervalCollection</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// addInterval - æ·»åŠ æ—¶é—´é—´éš”</span></span><br><span class="line">  <span class="title function_">addInterval</span>(<span class="params">interval</span>) &#123;</span><br><span class="line">    <span class="comment">// interval: TimeInterval - æ—¶é—´é—´éš”ï¼ˆåŒ…å«dataå±æ€§ï¼‰</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_intervals</span>.<span class="title function_">addInterval</span>(interval)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŠ¨ç”»ç¤ºä¾‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. ä½ç½®åŠ¨ç”»ï¼ˆå…³é”®å¸§ï¼‰</span></span><br><span class="line"><span class="keyword">const</span> positionProperty = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">SampledPositionProperty</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ å…³é”®å¸§</span></span><br><span class="line"><span class="keyword">const</span> start = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">now</span>()</span><br><span class="line"><span class="keyword">const</span> stop = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addSeconds</span>(start, <span class="number">60</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>())</span><br><span class="line"></span><br><span class="line">positionProperty.<span class="title function_">addSample</span>(start, <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">0</span>))</span><br><span class="line">positionProperty.<span class="title function_">addSample</span>(</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addSeconds</span>(start, <span class="number">30</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>()),</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.5</span>, <span class="number">39.95</span>, <span class="number">1000</span>),</span><br><span class="line">)</span><br><span class="line">positionProperty.<span class="title function_">addSample</span>(stop, <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.6</span>, <span class="number">40.0</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®æ’å€¼æ–¹å¼</span></span><br><span class="line">positionProperty.<span class="title function_">setInterpolationOptions</span>(&#123;</span><br><span class="line">  <span class="attr">interpolationDegree</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">interpolationAlgorithm</span>: <span class="title class_">Cesium</span>.<span class="property">HermitePolynomialApproximation</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºç§»åŠ¨å®ä½“</span></span><br><span class="line"><span class="keyword">const</span> movingEntity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: positionProperty,</span><br><span class="line">  <span class="attr">model</span>: &#123;</span><br><span class="line">    <span class="attr">uri</span>: <span class="string">&#x27;./models/airplane.gltf&#x27;</span>,</span><br><span class="line">    <span class="attr">scale</span>: <span class="number">2.0</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">path</span>: &#123;</span><br><span class="line">    <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">leadTime</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="attr">trailTime</span>: <span class="number">60</span>,</span><br><span class="line">    <span class="attr">width</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">material</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">CYAN</span>,</span><br><span class="line">    <span class="attr">resolution</span>: <span class="number">1</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. æ—‹è½¬åŠ¨ç”»ï¼ˆç¨‹åºåŒ–ï¼‰</span></span><br><span class="line"><span class="keyword">const</span> rotationProperty = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">CallbackProperty</span>(<span class="function">(<span class="params">time</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> seconds = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">secondsDifference</span>(time, start)</span><br><span class="line">  <span class="keyword">const</span> angle = (seconds * <span class="title class_">Math</span>.<span class="property">PI</span>) / <span class="number">10</span> <span class="comment">// æ¯20ç§’è½¬ä¸€åœˆ</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Quaternion</span>.<span class="title function_">fromAxisAngle</span>(<span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="property">UNIT_Z</span>, angle)</span><br><span class="line">&#125;, <span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rotatingEntity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">100</span>),</span><br><span class="line">  <span class="attr">orientation</span>: rotationProperty,</span><br><span class="line">  <span class="attr">model</span>: &#123;</span><br><span class="line">    <span class="attr">uri</span>: <span class="string">&#x27;./models/building.gltf&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. é¢œè‰²åŠ¨ç”»ï¼ˆå…³é”®å¸§ï¼‰</span></span><br><span class="line"><span class="keyword">const</span> colorProperty = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">SampledProperty</span>(<span class="title class_">Cesium</span>.<span class="property">Color</span>)</span><br><span class="line"></span><br><span class="line">colorProperty.<span class="title function_">addSample</span>(start, <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span>)</span><br><span class="line">colorProperty.<span class="title function_">addSample</span>(</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addSeconds</span>(start, <span class="number">15</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>()),</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">GREEN</span>,</span><br><span class="line">)</span><br><span class="line">colorProperty.<span class="title function_">addSample</span>(</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addSeconds</span>(start, <span class="number">30</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>()),</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLUE</span>,</span><br><span class="line">)</span><br><span class="line">colorProperty.<span class="title function_">addSample</span>(</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addSeconds</span>(start, <span class="number">45</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>()),</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>,</span><br><span class="line">)</span><br><span class="line">colorProperty.<span class="title function_">addSample</span>(stop, <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> coloredEntity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">200</span>),</span><br><span class="line">  <span class="attr">box</span>: &#123;</span><br><span class="line">    <span class="attr">dimensions</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">100</span>, <span class="number">100</span>, <span class="number">100</span>),</span><br><span class="line">    <span class="attr">material</span>: colorProperty,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. å¤åˆåŠ¨ç”»ï¼ˆåˆ†æ®µï¼‰</span></span><br><span class="line"><span class="keyword">const</span> compositePosition = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">CompositePositionProperty</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬ä¸€æ®µï¼šé™æ­¢</span></span><br><span class="line">compositePosition.<span class="title function_">addInterval</span>(</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeInterval</span>(&#123;</span><br><span class="line">    <span class="attr">start</span>: start,</span><br><span class="line">    <span class="attr">stop</span>: <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addSeconds</span>(start, <span class="number">20</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>()),</span><br><span class="line">    <span class="attr">data</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ConstantPositionProperty</span>(<span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">0</span>)),</span><br><span class="line">  &#125;),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬äºŒæ®µï¼šç§»åŠ¨</span></span><br><span class="line"><span class="keyword">const</span> movingInterval = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeInterval</span>(&#123;</span><br><span class="line">  <span class="attr">start</span>: <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addSeconds</span>(start, <span class="number">20</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>()),</span><br><span class="line">  <span class="attr">stop</span>: <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addSeconds</span>(start, <span class="number">40</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>()),</span><br><span class="line">  <span class="attr">data</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">SampledPositionProperty</span>(),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">movingInterval.<span class="property">data</span>.<span class="title function_">addSample</span>(</span><br><span class="line">  movingInterval.<span class="property">start</span>,</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">0</span>),</span><br><span class="line">)</span><br><span class="line">movingInterval.<span class="property">data</span>.<span class="title function_">addSample</span>(movingInterval.<span class="property">stop</span>, <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.5</span>, <span class="number">40.0</span>, <span class="number">1000</span>))</span><br><span class="line"></span><br><span class="line">compositePosition.<span class="title function_">addInterval</span>(movingInterval)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬ä¸‰æ®µï¼šå†æ¬¡é™æ­¢</span></span><br><span class="line">compositePosition.<span class="title function_">addInterval</span>(</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeInterval</span>(&#123;</span><br><span class="line">    <span class="attr">start</span>: <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addSeconds</span>(start, <span class="number">40</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>()),</span><br><span class="line">    <span class="attr">stop</span>: stop,</span><br><span class="line">    <span class="attr">data</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ConstantPositionProperty</span>(<span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.5</span>, <span class="number">40.0</span>, <span class="number">1000</span>)),</span><br><span class="line">  &#125;),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> compositeEntity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: compositePosition,</span><br><span class="line">  <span class="attr">point</span>: &#123;</span><br><span class="line">    <span class="attr">pixelSize</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">LIME</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. æ—¶é’Ÿæ§åˆ¶</span></span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">startTime</span> = start</span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">stopTime</span> = stop</span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">currentTime</span> = start</span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">clockRange</span> = <span class="title class_">Cesium</span>.<span class="property">ClockRange</span>.<span class="property">LOOP_STOP</span></span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">multiplier</span> = <span class="number">1</span></span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">shouldAnimate</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ—¶é’Ÿäº‹ä»¶ç›‘å¬</span></span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">onTick</span>.<span class="title function_">addEventListener</span>(<span class="function">(<span class="params">clock</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å½“å‰æ—¶é—´:&#x27;</span>, <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">toDate</span>(clock.<span class="property">currentTime</span>))</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">onStop</span>.<span class="title function_">addEventListener</span>(<span class="function">(<span class="params">clock</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;åŠ¨ç”»åœæ­¢&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. æ’å€¼ç®—æ³•è¯¦è§£</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">InterpolationAlgorithm</span> = &#123;</span><br><span class="line">  <span class="comment">// çº¿æ€§æ’å€¼</span></span><br><span class="line">  <span class="attr">LINEAR</span>: <span class="title class_">Cesium</span>.<span class="property">LinearApproximation</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ‹‰æ ¼æœ—æ—¥æ’å€¼</span></span><br><span class="line">  <span class="attr">LAGRANGE</span>: <span class="title class_">Cesium</span>.<span class="property">LagrangePolynomialApproximation</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŸƒå°”ç±³ç‰¹æ’å€¼ï¼ˆå¹³æ»‘ï¼‰</span></span><br><span class="line">  <span class="attr">HERMITE</span>: <span class="title class_">Cesium</span>.<span class="property">HermitePolynomialApproximation</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®ä¸åŒçš„æ’å€¼ç®—æ³•</span></span><br><span class="line">positionProperty.<span class="title function_">setInterpolationOptions</span>(&#123;</span><br><span class="line">  <span class="attr">interpolationDegree</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">interpolationAlgorithm</span>: <span class="title class_">Cesium</span>.<span class="property">LinearApproximation</span>, <span class="comment">// çº¿æ€§æ’å€¼ï¼Œç›´çº¿è¿åŠ¨</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">positionProperty.<span class="title function_">setInterpolationOptions</span>(&#123;</span><br><span class="line">  <span class="attr">interpolationDegree</span>: <span class="number">3</span>,</span><br><span class="line">  <span class="attr">interpolationAlgorithm</span>: <span class="title class_">Cesium</span>.<span class="property">HermitePolynomialApproximation</span>, <span class="comment">// å¹³æ»‘æ›²çº¿è¿åŠ¨</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 7. å¤–æ¨ï¼ˆExtrapolationï¼‰</span></span><br><span class="line"><span class="keyword">const</span> extrapolationTypes = &#123;</span><br><span class="line">  <span class="attr">NONE</span>: <span class="title class_">Cesium</span>.<span class="property">ExtrapolationType</span>.<span class="property">NONE</span>, <span class="comment">// æ— å¤–æ¨</span></span><br><span class="line">  <span class="attr">HOLD</span>: <span class="title class_">Cesium</span>.<span class="property">ExtrapolationType</span>.<span class="property">HOLD</span>, <span class="comment">// ä¿æŒæœ€åå€¼</span></span><br><span class="line">  <span class="attr">EXTRAPOLATE</span>: <span class="title class_">Cesium</span>.<span class="property">ExtrapolationType</span>.<span class="property">EXTRAPOLATE</span>, <span class="comment">// ç»§ç»­å¤–æ¨</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">positionProperty.<span class="property">forwardExtrapolationType</span> = <span class="title class_">Cesium</span>.<span class="property">ExtrapolationType</span>.<span class="property">EXTRAPOLATE</span></span><br><span class="line">positionProperty.<span class="property">forwardExtrapolationDuration</span> = <span class="number">10</span> <span class="comment">// å¤–æ¨10ç§’</span></span><br><span class="line"></span><br><span class="line">positionProperty.<span class="property">backwardExtrapolationType</span> = <span class="title class_">Cesium</span>.<span class="property">ExtrapolationType</span>.<span class="property">HOLD</span></span><br><span class="line">positionProperty.<span class="property">backwardExtrapolationDuration</span> = <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 8. åŠ¨ç”»æ§åˆ¶å‡½æ•°</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">playAnimation</span>(<span class="params"></span>) &#123;</span><br><span class="line">  viewer.<span class="property">clock</span>.<span class="property">shouldAnimate</span> = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">pauseAnimation</span>(<span class="params"></span>) &#123;</span><br><span class="line">  viewer.<span class="property">clock</span>.<span class="property">shouldAnimate</span> = <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">resetAnimation</span>(<span class="params"></span>) &#123;</span><br><span class="line">  viewer.<span class="property">clock</span>.<span class="property">currentTime</span> = viewer.<span class="property">clock</span>.<span class="property">startTime</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setAnimationSpeed</span>(<span class="params">multiplier</span>) &#123;</span><br><span class="line">  viewer.<span class="property">clock</span>.<span class="property">multiplier</span> = multiplier</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">reverseAnimation</span>(<span class="params"></span>) &#123;</span><br><span class="line">  viewer.<span class="property">clock</span>.<span class="property">multiplier</span> = -<span class="title class_">Math</span>.<span class="title function_">abs</span>(viewer.<span class="property">clock</span>.<span class="property">multiplier</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 9. ç²’å­ç³»ç»ŸåŠ¨ç”»ï¼ˆåŸºäºCallbackPropertyï¼‰</span></span><br><span class="line"><span class="keyword">const</span> particlePositions = []</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">  particlePositions.<span class="title function_">push</span>(&#123;</span><br><span class="line">    <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(</span><br><span class="line">      <span class="number">116.4074</span> + (<span class="title class_">Math</span>.<span class="title function_">random</span>() - <span class="number">0.5</span>) * <span class="number">0.01</span>,</span><br><span class="line">      <span class="number">39.9042</span> + (<span class="title class_">Math</span>.<span class="title function_">random</span>() - <span class="number">0.5</span>) * <span class="number">0.01</span>,</span><br><span class="line">      <span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">1000</span>,</span><br><span class="line">    ),</span><br><span class="line">    <span class="attr">velocity</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(</span><br><span class="line">      (<span class="title class_">Math</span>.<span class="title function_">random</span>() - <span class="number">0.5</span>) * <span class="number">100</span>,</span><br><span class="line">      (<span class="title class_">Math</span>.<span class="title function_">random</span>() - <span class="number">0.5</span>) * <span class="number">100</span>,</span><br><span class="line">      (<span class="title class_">Math</span>.<span class="title function_">random</span>() - <span class="number">0.5</span>) * <span class="number">50</span>,</span><br><span class="line">    ),</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> particleProperty = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">CallbackProperty</span>(<span class="function">(<span class="params">time</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> seconds = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">secondsDifference</span>(time, start)</span><br><span class="line">  <span class="keyword">const</span> positions = []</span><br><span class="line"></span><br><span class="line">  particlePositions.<span class="title function_">forEach</span>(<span class="function">(<span class="params">particle</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> newPos = <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">add</span>(</span><br><span class="line">      particle.<span class="property">position</span>,</span><br><span class="line">      <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">multiplyByScalar</span>(particle.<span class="property">velocity</span>, seconds, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>()),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(),</span><br><span class="line">    )</span><br><span class="line">    positions.<span class="title function_">push</span>(newPos.<span class="property">x</span>, newPos.<span class="property">y</span>, newPos.<span class="property">z</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> positions</span><br><span class="line">&#125;, <span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åº”ç”¨ç²’å­åŠ¨ç”»åˆ°PointPrimitiveCollection</span></span><br></pre></td></tr></table></figure><h2 id="å‡ ä½•ä½“ç³»ç»Ÿè¯¦è§£"><a href="#å‡ ä½•ä½“ç³»ç»Ÿè¯¦è§£" class="headerlink" title="å‡ ä½•ä½“ç³»ç»Ÿè¯¦è§£"></a>å‡ ä½•ä½“ç³»ç»Ÿè¯¦è§£</h2><h3 id="Primitive-å›¾å…ƒ"><a href="#Primitive-å›¾å…ƒ" class="headerlink" title="Primitive å›¾å…ƒ"></a>Primitive å›¾å…ƒ</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Primitive - å›¾å…ƒåŸºç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Primitive</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// geometryInstances: Array&lt;GeometryInstance&gt; | GeometryInstance</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å‡ ä½•å®ä¾‹æ•°ç»„</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: å®šä¹‰å›¾å…ƒçš„å‡ ä½•å½¢çŠ¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">geometryInstances</span> = options.<span class="property">geometryInstances</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// appearance: Appearance</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¤–è§‚å®šä¹‰</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: æ§åˆ¶å›¾å…ƒçš„æ¸²æŸ“æ–¹å¼</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">appearance</span> = options.<span class="property">appearance</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// show: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤º</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// modelMatrix: Matrix4</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ¨¡å‹å˜æ¢çŸ©é˜µ</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Matrix4.IDENTITY</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">modelMatrix</span> = options.<span class="property">modelMatrix</span> || <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="property">IDENTITY</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// vertexCacheOptimize: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦ä¼˜åŒ–é¡¶ç‚¹ç¼“å­˜</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vertexCacheOptimize</span> =</span><br><span class="line">      options.<span class="property">vertexCacheOptimize</span> !== <span class="literal">undefined</span> ? options.<span class="property">vertexCacheOptimize</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// interleave: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦äº¤é”™é¡¶ç‚¹å±æ€§</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">interleave</span> = options.<span class="property">interleave</span> !== <span class="literal">undefined</span> ? options.<span class="property">interleave</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// compressVertices: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦å‹ç¼©é¡¶ç‚¹</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">compressVertices</span> = options.<span class="property">compressVertices</span> !== <span class="literal">undefined</span> ? options.<span class="property">compressVertices</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// releaseGeometryInstances: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦åœ¨æ¸²æŸ“åé‡Šæ”¾å‡ ä½•å®ä¾‹</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">releaseGeometryInstances</span> =</span><br><span class="line">      options.<span class="property">releaseGeometryInstances</span> !== <span class="literal">undefined</span> ? options.<span class="property">releaseGeometryInstances</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// allowPicking: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦å…è®¸æ‹¾å–</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">allowPicking</span> = options.<span class="property">allowPicking</span> !== <span class="literal">undefined</span> ? options.<span class="property">allowPicking</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// cull: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦å¯ç”¨è§†é”¥å‰”é™¤</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cull</span> = options.<span class="property">cull</span> !== <span class="literal">undefined</span> ? options.<span class="property">cull</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// asynchronous: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦å¼‚æ­¥åˆ›å»º</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">asynchronous</span> = options.<span class="property">asynchronous</span> !== <span class="literal">undefined</span> ? options.<span class="property">asynchronous</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// debugShowBoundingVolume: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºåŒ…å›´ä½“ï¼ˆè°ƒè¯•ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">debugShowBoundingVolume</span> =</span><br><span class="line">      options.<span class="property">debugShowBoundingVolume</span> !== <span class="literal">undefined</span> ? options.<span class="property">debugShowBoundingVolume</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// shadows: ShadowMode</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é˜´å½±æ¨¡å¼</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: ShadowMode.DISABLED</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadows</span> = options.<span class="property">shadows</span> || <span class="title class_">Cesium</span>.<span class="property">ShadowMode</span>.<span class="property">DISABLED</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// update - æ›´æ–°å›¾å…ƒ</span></span><br><span class="line">  <span class="title function_">update</span>(<span class="params">frameState</span>) &#123;</span><br><span class="line">    <span class="comment">// frameState: FrameState - å¸§çŠ¶æ€</span></span><br><span class="line">    <span class="comment">// è¿”å›: void</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// isDestroyed - æ˜¯å¦å·²é”€æ¯</span></span><br><span class="line">  <span class="title function_">isDestroyed</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// destroy - é”€æ¯å›¾å…ƒ</span></span><br><span class="line">  <span class="title function_">destroy</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// æ¸…ç†èµ„æº</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getGeometryInstanceAttributes - è·å–å‡ ä½•å®ä¾‹å±æ€§</span></span><br><span class="line">  <span class="title function_">getGeometryInstanceAttributes</span>(<span class="params">id</span>) &#123;</span><br><span class="line">    <span class="comment">// id: string - å®ä¾‹ID</span></span><br><span class="line">    <span class="comment">// è¿”å›: Object - å±æ€§å¯¹è±¡</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GeometryInstance - å‡ ä½•å®ä¾‹</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GeometryInstance</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// geometry: Geometry</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å‡ ä½•ä½“</span></span><br><span class="line">    <span class="comment">// å¿…éœ€: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">geometry</span> = options.<span class="property">geometry</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// modelMatrix: Matrix4</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ¨¡å‹å˜æ¢çŸ©é˜µ</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Matrix4.IDENTITY</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">modelMatrix</span> = options.<span class="property">modelMatrix</span> || <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="property">IDENTITY</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// id: Object</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å®ä¾‹æ ‡è¯†ç¬¦</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: æ‹¾å–å’Œå±æ€§æ›´æ–°</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = options.<span class="property">id</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// attributes: Object</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ¯å®ä¾‹å±æ€§</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: é¢œè‰²ã€æ˜¾ç¤ºçŠ¶æ€ç­‰</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">attributes</span> = options.<span class="property">attributes</span> || &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŸºç¡€å‡ ä½•ä½“</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// BoxGeometry - ç›’å­å‡ ä½•ä½“</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BoxGeometry</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// dimensions: Cartesian3</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç›’å­å°ºå¯¸ï¼ˆé•¿ã€å®½ã€é«˜ï¼‰</span></span><br><span class="line">    <span class="comment">// å¿…éœ€: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dimensions</span> = options.<span class="property">dimensions</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// vertexFormat: VertexFormat</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é¡¶ç‚¹æ ¼å¼</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: VertexFormat.DEFAULT</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vertexFormat</span> = options.<span class="property">vertexFormat</span> || <span class="title class_">Cesium</span>.<span class="property">VertexFormat</span>.<span class="property">DEFAULT</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é™æ€æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// createGeometry - åˆ›å»ºå‡ ä½•ä½“</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createGeometry</span>(<span class="params">boxGeometry</span>) &#123;</span><br><span class="line">    <span class="comment">// è¿”å›: Geometry | undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// packedLength - æ‰“åŒ…é•¿åº¦</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">packedLength</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">4</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// pack - æ‰“åŒ…</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">pack</span>(<span class="params">value, array, startingIndex = <span class="number">0</span></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// unpack - è§£åŒ…</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">unpack</span>(<span class="params">array, startingIndex = <span class="number">0</span>, result</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SphereGeometry - çƒä½“å‡ ä½•ä½“</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SphereGeometry</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// radius: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: çƒä½“åŠå¾„</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">radius</span> = options.<span class="property">radius</span> !== <span class="literal">undefined</span> ? options.<span class="property">radius</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// stackPartitions: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å †å åˆ†åŒºæ•°ï¼ˆçº¬åº¦æ–¹å‘ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 64</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">stackPartitions</span> = options.<span class="property">stackPartitions</span> !== <span class="literal">undefined</span> ? options.<span class="property">stackPartitions</span> : <span class="number">64</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// slicePartitions: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åˆ‡ç‰‡åˆ†åŒºæ•°ï¼ˆç»åº¦æ–¹å‘ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 64</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">slicePartitions</span> = options.<span class="property">slicePartitions</span> !== <span class="literal">undefined</span> ? options.<span class="property">slicePartitions</span> : <span class="number">64</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// vertexFormat: VertexFormat</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é¡¶ç‚¹æ ¼å¼</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: VertexFormat.DEFAULT</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vertexFormat</span> = options.<span class="property">vertexFormat</span> || <span class="title class_">Cesium</span>.<span class="property">VertexFormat</span>.<span class="property">DEFAULT</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CylinderGeometry - åœ†æŸ±ä½“å‡ ä½•ä½“</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CylinderGeometry</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// length: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åœ†æŸ±ä½“é•¿åº¦ï¼ˆé«˜åº¦ï¼‰</span></span><br><span class="line">    <span class="comment">// å¿…éœ€: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">length</span> = options.<span class="property">length</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// topRadius: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é¡¶éƒ¨åŠå¾„</span></span><br><span class="line">    <span class="comment">// å¿…éœ€: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">topRadius</span> = options.<span class="property">topRadius</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// bottomRadius: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åº•éƒ¨åŠå¾„</span></span><br><span class="line">    <span class="comment">// å¿…éœ€: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">bottomRadius</span> = options.<span class="property">bottomRadius</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// slices: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åˆ‡ç‰‡æ•°é‡</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 128</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">slices</span> = options.<span class="property">slices</span> !== <span class="literal">undefined</span> ? options.<span class="property">slices</span> : <span class="number">128</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// vertexFormat: VertexFormat</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é¡¶ç‚¹æ ¼å¼</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: VertexFormat.DEFAULT</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vertexFormat</span> = options.<span class="property">vertexFormat</span> || <span class="title class_">Cesium</span>.<span class="property">VertexFormat</span>.<span class="property">DEFAULT</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PlaneGeometry - å¹³é¢å‡ ä½•ä½“</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PlaneGeometry</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// vertexFormat: VertexFormat</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é¡¶ç‚¹æ ¼å¼</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: VertexFormat.DEFAULT</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vertexFormat</span> = options.<span class="property">vertexFormat</span> || <span class="title class_">Cesium</span>.<span class="property">VertexFormat</span>.<span class="property">DEFAULT</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// EllipsoidGeometry - æ¤­çƒä½“å‡ ä½•ä½“</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EllipsoidGeometry</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// radii: Cartesian3</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ¤­çƒä½“åŠå¾„ï¼ˆx, y, zï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Cartesian3(1, 1, 1)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">radii</span> = options.<span class="property">radii</span> || <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// innerRadii: Cartesian3</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å†…éƒ¨åŠå¾„ï¼ˆç”¨äºåˆ›å»ºç©ºå¿ƒæ¤­çƒï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">innerRadii</span> = options.<span class="property">innerRadii</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// minimumClock: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æœ€å°æ—¶é’Ÿè§’ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 0.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">minimumClock</span> = options.<span class="property">minimumClock</span> !== <span class="literal">undefined</span> ? options.<span class="property">minimumClock</span> : <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// maximumClock: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æœ€å¤§æ—¶é’Ÿè§’ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 2Ï€</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maximumClock</span> =</span><br><span class="line">      options.<span class="property">maximumClock</span> !== <span class="literal">undefined</span> ? options.<span class="property">maximumClock</span> : <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="property">TWO_PI</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// minimumCone: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æœ€å°é”¥è§’ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 0.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">minimumCone</span> = options.<span class="property">minimumCone</span> !== <span class="literal">undefined</span> ? options.<span class="property">minimumCone</span> : <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// maximumCone: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æœ€å¤§é”¥è§’ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Ï€</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maximumCone</span> = options.<span class="property">maximumCone</span> !== <span class="literal">undefined</span> ? options.<span class="property">maximumCone</span> : <span class="title class_">Math</span>.<span class="property">PI</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// stackPartitions: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å †å åˆ†åŒºæ•°</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 64</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">stackPartitions</span> = options.<span class="property">stackPartitions</span> !== <span class="literal">undefined</span> ? options.<span class="property">stackPartitions</span> : <span class="number">64</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// slicePartitions: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åˆ‡ç‰‡åˆ†åŒºæ•°</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 64</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">slicePartitions</span> = options.<span class="property">slicePartitions</span> !== <span class="literal">undefined</span> ? options.<span class="property">slicePartitions</span> : <span class="number">64</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// vertexFormat: VertexFormat</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é¡¶ç‚¹æ ¼å¼</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: VertexFormat.DEFAULT</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vertexFormat</span> = options.<span class="property">vertexFormat</span> || <span class="title class_">Cesium</span>.<span class="property">VertexFormat</span>.<span class="property">DEFAULT</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Appearance - å¤–è§‚ç±»</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// MaterialAppearance - æè´¨å¤–è§‚</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MaterialAppearance</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// material: Material</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æè´¨</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Material.ColorType</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">material</span> = options.<span class="property">material</span> || <span class="title class_">Cesium</span>.<span class="property">Material</span>.<span class="title function_">fromType</span>(<span class="title class_">Cesium</span>.<span class="property">Material</span>.<span class="property">ColorType</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// translucent: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦é€æ˜</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: æ ¹æ®æè´¨ç¡®å®š</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">translucent</span> = options.<span class="property">translucent</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// vertexShaderSource: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é¡¶ç‚¹ç€è‰²å™¨æºç </span></span><br><span class="line">    <span class="comment">// é»˜è®¤: ä½¿ç”¨å†…ç½®ç€è‰²å™¨</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vertexShaderSource</span> = options.<span class="property">vertexShaderSource</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// fragmentShaderSource: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç‰‡æ®µç€è‰²å™¨æºç </span></span><br><span class="line">    <span class="comment">// é»˜è®¤: ä½¿ç”¨å†…ç½®ç€è‰²å™¨</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fragmentShaderSource</span> = options.<span class="property">fragmentShaderSource</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// renderState: RenderState</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ¸²æŸ“çŠ¶æ€</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: é»˜è®¤æ¸²æŸ“çŠ¶æ€</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">renderState</span> = options.<span class="property">renderState</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// closed: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å‡ ä½•ä½“æ˜¯å¦å°é—­</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">closed</span> = options.<span class="property">closed</span> !== <span class="literal">undefined</span> ? options.<span class="property">closed</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// vertexFormat: VertexFormat</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é¡¶ç‚¹æ ¼å¼</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: MaterialAppearance.vertexFormat</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vertexFormat</span> = options.<span class="property">vertexFormat</span> || <span class="title class_">MaterialAppearance</span>.<span class="property">vertexFormat</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// flat: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦ä½¿ç”¨å¹³é¢ç€è‰²</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">flat</span> = options.<span class="property">flat</span> !== <span class="literal">undefined</span> ? options.<span class="property">flat</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// faceForward: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦é¢å‘å‰æ–¹</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: !closed</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">faceForward</span> = options.<span class="property">faceForward</span> !== <span class="literal">undefined</span> ? options.<span class="property">faceForward</span> : !<span class="variable language_">this</span>.<span class="property">closed</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PerInstanceColorAppearance - æ¯å®ä¾‹é¢œè‰²å¤–è§‚</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PerInstanceColorAppearance</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// flat: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦ä½¿ç”¨å¹³é¢ç€è‰²</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">flat</span> = options.<span class="property">flat</span> !== <span class="literal">undefined</span> ? options.<span class="property">flat</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// faceForward: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦é¢å‘å‰æ–¹</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: !closed</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">faceForward</span> = options.<span class="property">faceForward</span> !== <span class="literal">undefined</span> ? options.<span class="property">faceForward</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// translucent: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦é€æ˜</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">translucent</span> = options.<span class="property">translucent</span> !== <span class="literal">undefined</span> ? options.<span class="property">translucent</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// closed: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å‡ ä½•ä½“æ˜¯å¦å°é—­</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">closed</span> = options.<span class="property">closed</span> !== <span class="literal">undefined</span> ? options.<span class="property">closed</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// vertexShaderSource: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é¡¶ç‚¹ç€è‰²å™¨æºç </span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vertexShaderSource</span> = options.<span class="property">vertexShaderSource</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// fragmentShaderSource: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç‰‡æ®µç€è‰²å™¨æºç </span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fragmentShaderSource</span> = options.<span class="property">fragmentShaderSource</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// renderState: RenderState</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ¸²æŸ“çŠ¶æ€</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">renderState</span> = options.<span class="property">renderState</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡ ä½•ä½“ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. åˆ›å»ºç›’å­å›¾å…ƒ</span></span><br><span class="line"><span class="keyword">const</span> boxInstances = []</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; <span class="number">10</span>; j++) &#123;</span><br><span class="line">    boxInstances.<span class="title function_">push</span>(</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">GeometryInstance</span>(&#123;</span><br><span class="line">        <span class="attr">geometry</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">BoxGeometry</span>(&#123;</span><br><span class="line">          <span class="attr">dimensions</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">1000</span>, <span class="number">1000</span>, <span class="number">1000</span>),</span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="attr">modelMatrix</span>: <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">multiplyByTranslation</span>(</span><br><span class="line">          <span class="title class_">Cesium</span>.<span class="property">Transforms</span>.<span class="title function_">eastNorthUpToFixedFrame</span>(</span><br><span class="line">            <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span> + i * <span class="number">0.01</span>, <span class="number">39.9042</span> + j * <span class="number">0.01</span>),</span><br><span class="line">          ),</span><br><span class="line">          <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">500</span>),</span><br><span class="line">          <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Matrix4</span>(),</span><br><span class="line">        ),</span><br><span class="line">        <span class="attr">id</span>: <span class="string">`box_<span class="subst">$&#123;i&#125;</span>_<span class="subst">$&#123;j&#125;</span>`</span>,</span><br><span class="line">        <span class="attr">attributes</span>: &#123;</span><br><span class="line">          <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">ColorGeometryInstanceAttribute</span>.<span class="title function_">fromColor</span>(</span><br><span class="line">            <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="title function_">fromRandom</span>(&#123; <span class="attr">alpha</span>: <span class="number">0.8</span> &#125;),</span><br><span class="line">          ),</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> boxPrimitive = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Primitive</span>(&#123;</span><br><span class="line">  <span class="attr">geometryInstances</span>: boxInstances,</span><br><span class="line">  <span class="attr">appearance</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PerInstanceColorAppearance</span>(&#123;</span><br><span class="line">    <span class="attr">translucent</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">closed</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">primitives</span>.<span class="title function_">add</span>(boxPrimitive)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. åˆ›å»ºçƒä½“å›¾å…ƒ</span></span><br><span class="line"><span class="keyword">const</span> sphereInstance = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">GeometryInstance</span>(&#123;</span><br><span class="line">  <span class="attr">geometry</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">SphereGeometry</span>(&#123;</span><br><span class="line">    <span class="attr">radius</span>: <span class="number">500.0</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="attr">modelMatrix</span>: <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">multiplyByTranslation</span>(</span><br><span class="line">    <span class="title class_">Cesium</span>.<span class="property">Transforms</span>.<span class="title function_">eastNorthUpToFixedFrame</span>(<span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>)),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1000</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Matrix4</span>(),</span><br><span class="line">  ),</span><br><span class="line">  <span class="attr">attributes</span>: &#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">ColorGeometryInstanceAttribute</span>.<span class="title function_">fromColor</span>(<span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">AQUA</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> spherePrimitive = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Primitive</span>(&#123;</span><br><span class="line">  <span class="attr">geometryInstances</span>: sphereInstance,</span><br><span class="line">  <span class="attr">appearance</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PerInstanceColorAppearance</span>(),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">primitives</span>.<span class="title function_">add</span>(spherePrimitive)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. æè´¨å¤–è§‚å›¾å…ƒ</span></span><br><span class="line"><span class="keyword">const</span> planePrimitive = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Primitive</span>(&#123;</span><br><span class="line">  <span class="attr">geometryInstances</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">GeometryInstance</span>(&#123;</span><br><span class="line">    <span class="attr">geometry</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PlaneGeometry</span>(&#123;</span><br><span class="line">      <span class="attr">vertexFormat</span>: <span class="title class_">Cesium</span>.<span class="property">MaterialAppearance</span>.<span class="property">vertexFormat</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="attr">modelMatrix</span>: <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">multiplyByScale</span>(</span><br><span class="line">      <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">multiplyByTranslation</span>(</span><br><span class="line">        <span class="title class_">Cesium</span>.<span class="property">Transforms</span>.<span class="title function_">eastNorthUpToFixedFrame</span>(<span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>)),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">2000</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Matrix4</span>(),</span><br><span class="line">      ),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">1000</span>, <span class="number">1000</span>, <span class="number">1</span>),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Matrix4</span>(),</span><br><span class="line">    ),</span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="attr">appearance</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">MaterialAppearance</span>(&#123;</span><br><span class="line">    <span class="attr">material</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Material</span>(&#123;</span><br><span class="line">      <span class="attr">fabric</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;Image&#x27;</span>,</span><br><span class="line">        <span class="attr">uniforms</span>: &#123;</span><br><span class="line">          <span class="attr">image</span>: <span class="string">&#x27;path/to/texture.jpg&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">primitives</span>.<span class="title function_">add</span>(planePrimitive)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. åŠ¨æ€ä¿®æ”¹å±æ€§</span></span><br><span class="line"><span class="keyword">const</span> attributes = boxPrimitive.<span class="title function_">getGeometryInstanceAttributes</span>(<span class="string">&#x27;box_0_0&#x27;</span>)</span><br><span class="line">attributes.<span class="property">color</span> = <span class="title class_">Cesium</span>.<span class="property">ColorGeometryInstanceAttribute</span>.<span class="title function_">toValue</span>(<span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. åˆ†ç±»å›¾å…ƒï¼ˆè´´åœ°ï¼‰</span></span><br><span class="line"><span class="keyword">const</span> classifiedPrimitive = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ClassificationPrimitive</span>(&#123;</span><br><span class="line">  <span class="attr">geometryInstances</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">GeometryInstance</span>(&#123;</span><br><span class="line">    <span class="attr">geometry</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PolygonGeometry</span>(&#123;</span><br><span class="line">      <span class="attr">polygonHierarchy</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PolygonHierarchy</span>(</span><br><span class="line">        <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegreesArray</span>([<span class="number">116.4</span>, <span class="number">39.9</span>, <span class="number">116.5</span>, <span class="number">39.9</span>, <span class="number">116.5</span>, <span class="number">40.0</span>, <span class="number">116.4</span>, <span class="number">40.0</span>]),</span><br><span class="line">      ),</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="attr">attributes</span>: &#123;</span><br><span class="line">      <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">ColorGeometryInstanceAttribute</span>.<span class="title function_">fromColor</span>(<span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span>.<span class="title function_">withAlpha</span>(<span class="number">0.5</span>)),</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="attr">appearance</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PerInstanceColorAppearance</span>(&#123;</span><br><span class="line">    <span class="attr">translucent</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">primitives</span>.<span class="title function_">add</span>(classifiedPrimitive)</span><br></pre></td></tr></table></figure><h2 id="åœºæ™¯æ§åˆ¶è¯¦è§£"><a href="#åœºæ™¯æ§åˆ¶è¯¦è§£" class="headerlink" title="åœºæ™¯æ§åˆ¶è¯¦è§£"></a>åœºæ™¯æ§åˆ¶è¯¦è§£</h2><h3 id="Scene-åœºæ™¯ç±»"><a href="#Scene-åœºæ™¯ç±»" class="headerlink" title="Scene åœºæ™¯ç±»"></a>Scene åœºæ™¯ç±»</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Scene - åœºæ™¯ç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Scene</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">canvas, contextOptions, creditContainer</span>) &#123;</span><br><span class="line">    <span class="comment">// canvas: HTMLCanvasElement</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ¸²æŸ“ç”»å¸ƒ</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span> = canvas</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === æ¸²æŸ“æ§åˆ¶å±æ€§ ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// backgroundColor: Color</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: èƒŒæ™¯é¢œè‰²</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Color.BLACK</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">backgroundColor</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// fog: Fog</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é›¾æ•ˆ</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: new Fog()</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fog</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Fog</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// skyBox: SkyBox</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¤©ç©ºç›’</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefinedï¼ˆä½¿ç”¨é»˜è®¤å¤©ç©ºï¼‰</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">skyBox</span> = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// skyAtmosphere: SkyAtmosphere</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¤§æ°”æ•£å°„</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: new SkyAtmosphere()</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">skyAtmosphere</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">SkyAtmosphere</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sun: Sun</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¤ªé˜³</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: new Sun()</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sun</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Sun</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// moon: Moon</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æœˆäº®</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: new Moon()</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">moon</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Moon</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sunBloom: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¤ªé˜³å…‰æ™•æ•ˆæœ</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sunBloom</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// === åœ°çƒç›¸å…³å±æ€§ ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// globe: Globe</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åœ°çƒå¯¹è±¡</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: new Globe(Ellipsoid.WGS84)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">globe</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Globe</span>(<span class="title class_">Cesium</span>.<span class="property">Ellipsoid</span>.<span class="property">WGS84</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === æ¸²æŸ“æ€§èƒ½å±æ€§ ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// requestRenderMode: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æŒ‰éœ€æ¸²æŸ“æ¨¡å¼</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">requestRenderMode</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// maximumRenderTimeChange: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æœ€å¤§æ¸²æŸ“æ—¶é—´å˜åŒ–</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 0.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maximumRenderTimeChange</span> = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// debugShowFramesPerSecond: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¾ç¤ºFPSè°ƒè¯•ä¿¡æ¯</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">debugShowFramesPerSecond</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// debugCommandFilter: function</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è°ƒè¯•å‘½ä»¤è¿‡æ»¤å™¨</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">debugCommandFilter</span> = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// === æ‹¾å–ç›¸å…³å±æ€§ ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// pickTranslucentDepth: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ‹¾å–é€æ˜ç‰©ä½“æ·±åº¦</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pickTranslucentDepth</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// === åå¤„ç†æ•ˆæœ ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// postProcessStages: PostProcessStageCollection</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åå¤„ç†é˜¶æ®µé›†åˆ</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: new PostProcessStageCollection()</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">postProcessStages</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PostProcessStageCollection</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === å…‰ç…§å±æ€§ ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// light: Light</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åœºæ™¯å…‰æº</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: new SunLight()</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">light</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">SunLight</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// shadows: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦å¯ç”¨é˜´å½±</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadows</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// shadowMap: ShadowMap</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é˜´å½±è´´å›¾</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: new ShadowMap()</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadowMap</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ShadowMap</span>(&#123;</span><br><span class="line">      <span class="attr">context</span>: <span class="variable language_">this</span>.<span class="property">context</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === é«˜åŠ¨æ€èŒƒå›´æ¸²æŸ“ ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// highDynamicRange: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦å¯ç”¨HDR</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">highDynamicRange</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// gamma: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ä¼½é©¬æ ¡æ­£å€¼</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gamma</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// === åœ°ä¸‹æ¨¡å¼ ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// underground: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åœ°ä¸‹æ¨¡å¼</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">underground</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// undergroundColor: Color</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åœ°ä¸‹èƒŒæ™¯é¢œè‰²</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Color.BLACK</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">undergroundColor</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// === åœ°çƒé€æ˜åº¦ ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// globeTranslucencyState: GlobeTranslucencyState</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åœ°çƒé€æ˜åº¦çŠ¶æ€</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: &#123;&#125;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">globeTranslucencyState</span> = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === ç›¸æœºæ§åˆ¶å™¨ ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// screenSpaceCameraController: ScreenSpaceCameraController</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å±å¹•ç©ºé—´ç›¸æœºæ§åˆ¶å™¨</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">screenSpaceCameraController</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ScreenSpaceCameraController</span>(<span class="variable language_">this</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === å›¾å…ƒé›†åˆ ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// primitives: PrimitiveCollection</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å›¾å…ƒé›†åˆ</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">primitives</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PrimitiveCollection</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// groundPrimitives: PrimitiveCollection</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åœ°é¢å›¾å…ƒé›†åˆ</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">groundPrimitives</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PrimitiveCollection</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === æ¸²æŸ“æ–¹æ³• ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// render - æ¸²æŸ“åœºæ™¯</span></span><br><span class="line">  <span class="title function_">render</span>(<span class="params">time</span>) &#123;</span><br><span class="line">    <span class="comment">// time: JulianDate - æ¸²æŸ“æ—¶é—´</span></span><br><span class="line">    <span class="comment">// è¿”å›: void</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// requestRender - è¯·æ±‚æ¸²æŸ“</span></span><br><span class="line">  <span class="title function_">requestRender</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// åœ¨æŒ‰éœ€æ¸²æŸ“æ¨¡å¼ä¸‹è¯·æ±‚ä¸€æ¬¡æ¸²æŸ“</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === æ‹¾å–æ–¹æ³• ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// pick - æ‹¾å–å¯¹è±¡</span></span><br><span class="line">  <span class="title function_">pick</span>(<span class="params">windowPosition</span>) &#123;</span><br><span class="line">    <span class="comment">// windowPosition: Cartesian2 - å±å¹•åæ ‡</span></span><br><span class="line">    <span class="comment">// è¿”å›: Object | undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// drillPick - é’»å–æ‹¾å–ï¼ˆè·å–æ‰€æœ‰å¯¹è±¡ï¼‰</span></span><br><span class="line">  <span class="title function_">drillPick</span>(<span class="params">windowPosition, limit</span>) &#123;</span><br><span class="line">    <span class="comment">// windowPosition: Cartesian2 - å±å¹•åæ ‡</span></span><br><span class="line">    <span class="comment">// limit: number - æœ€å¤§æ•°é‡é™åˆ¶</span></span><br><span class="line">    <span class="comment">// è¿”å›: Array&lt;Object&gt;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// pickPosition - æ‹¾å–ä½ç½®</span></span><br><span class="line">  <span class="title function_">pickPosition</span>(<span class="params">windowPosition, result</span>) &#123;</span><br><span class="line">    <span class="comment">// windowPosition: Cartesian2 - å±å¹•åæ ‡</span></span><br><span class="line">    <span class="comment">// result: Cartesian3 - ç»“æœå¯¹è±¡</span></span><br><span class="line">    <span class="comment">// è¿”å›: Cartesian3 | undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sampleHeight - é‡‡æ ·é«˜åº¦</span></span><br><span class="line">  <span class="title function_">sampleHeight</span>(<span class="params">position, objectsToExclude, width</span>) &#123;</span><br><span class="line">    <span class="comment">// position: Cartesian3 - ä¸–ç•Œåæ ‡</span></span><br><span class="line">    <span class="comment">// objectsToExclude: Array - æ’é™¤çš„å¯¹è±¡</span></span><br><span class="line">    <span class="comment">// width: number - é‡‡æ ·å®½åº¦</span></span><br><span class="line">    <span class="comment">// è¿”å›: number | undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// clampToHeight - è´´åˆåˆ°é«˜åº¦</span></span><br><span class="line">  <span class="title function_">clampToHeight</span>(<span class="params">cartesian, objectsToExclude, width, result</span>) &#123;</span><br><span class="line">    <span class="comment">// cartesian: Cartesian3 - ä¸–ç•Œåæ ‡</span></span><br><span class="line">    <span class="comment">// objectsToExclude: Array - æ’é™¤çš„å¯¹è±¡</span></span><br><span class="line">    <span class="comment">// width: number - é‡‡æ ·å®½åº¦</span></span><br><span class="line">    <span class="comment">// result: Cartesian3 - ç»“æœå¯¹è±¡</span></span><br><span class="line">    <span class="comment">// è¿”å›: Cartesian3 | undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === ç›¸æœºæ–¹æ³• ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// cartesianToCanvasCoordinates - ç¬›å¡å°”åæ ‡è½¬ç”»å¸ƒåæ ‡</span></span><br><span class="line">  <span class="title function_">cartesianToCanvasCoordinates</span>(<span class="params">position, result</span>) &#123;</span><br><span class="line">    <span class="comment">// position: Cartesian3 - ä¸–ç•Œåæ ‡</span></span><br><span class="line">    <span class="comment">// result: Cartesian2 - ç»“æœå¯¹è±¡</span></span><br><span class="line">    <span class="comment">// è¿”å›: Cartesian2 | undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === äº‹ä»¶ ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// preUpdate: Event</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ›´æ–°å‰äº‹ä»¶</span></span><br><span class="line">  preUpdate = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// postUpdate: Event</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ›´æ–°åäº‹ä»¶</span></span><br><span class="line">  postUpdate = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// preRender: Event</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ¸²æŸ“å‰äº‹ä»¶</span></span><br><span class="line">  preRender = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// postRender: Event</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ¸²æŸ“åäº‹ä»¶</span></span><br><span class="line">  postRender = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// morphStart: Event</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: å˜å½¢å¼€å§‹äº‹ä»¶</span></span><br><span class="line">  morphStart = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// morphComplete: Event</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: å˜å½¢å®Œæˆäº‹ä»¶</span></span><br><span class="line">  morphComplete = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// terrainProviderChanged: Event</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: åœ°å½¢æä¾›è€…å˜åŒ–äº‹ä»¶</span></span><br><span class="line">  terrainProviderChanged = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Globe - åœ°çƒç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Globe</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">ellipsoid</span>) &#123;</span><br><span class="line">    <span class="comment">// ellipsoid: Ellipsoid</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ¤­çƒä½“</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ellipsoid</span> = ellipsoid || <span class="title class_">Cesium</span>.<span class="property">Ellipsoid</span>.<span class="property">WGS84</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// show: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºåœ°çƒ</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// maximumScreenSpaceError: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æœ€å¤§å±å¹•ç©ºé—´è¯¯å·®</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 2</span></span><br><span class="line">    <span class="comment">// æ€§èƒ½å½±å“: å€¼è¶Šå°è´¨é‡è¶Šé«˜ï¼Œæ€§èƒ½è¶Šä½</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maximumScreenSpaceError</span> = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// tileCacheSize: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç“¦ç‰‡ç¼“å­˜å¤§å°</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 100</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tileCacheSize</span> = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// loadingDescendantLimit: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åŠ è½½åä»£é™åˆ¶</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 20</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loadingDescendantLimit</span> = <span class="number">20</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// preloadAncestors: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦é¢„åŠ è½½ç¥–å…ˆç“¦ç‰‡</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">preloadAncestors</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// preloadSiblings: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦é¢„åŠ è½½å…„å¼Ÿç“¦ç‰‡</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">preloadSiblings</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// enableLighting: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦å¯ç”¨å…‰ç…§</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">enableLighting</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// lightingFadeOutDistance: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å…‰ç…§æ·¡å‡ºè·ç¦»</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 6500000.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lightingFadeOutDistance</span> = <span class="number">6500000.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// lightingFadeInDistance: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å…‰ç…§æ·¡å…¥è·ç¦»</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 9000000.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lightingFadeInDistance</span> = <span class="number">9000000.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// showWaterEffect: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºæ°´ä½“æ•ˆæœ</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">showWaterEffect</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// shadows: ShadowMode</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é˜´å½±æ¨¡å¼</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: ShadowMode.RECEIVE_ONLY</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadows</span> = <span class="title class_">Cesium</span>.<span class="property">ShadowMode</span>.<span class="property">RECEIVE_ONLY</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// atmosphereLightIntensity: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¤§æ°”å…‰ç…§å¼ºåº¦</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 10.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">atmosphereLightIntensity</span> = <span class="number">10.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// atmosphereRayleighCoefficient: Cartesian3</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç‘åˆ©æ•£å°„ç³»æ•°</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Cartesian3(5.5e-6, 13.0e-6, 28.4e-6)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">atmosphereRayleighCoefficient</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">5.5e-6</span>, <span class="number">13.0e-6</span>, <span class="number">28.4e-6</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// atmosphereMieCoefficient: Cartesian3</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç±³æ°æ•£å°„ç³»æ•°</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Cartesian3(21e-6, 21e-6, 21e-6)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">atmosphereMieCoefficient</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">21e-6</span>, <span class="number">21e-6</span>, <span class="number">21e-6</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// atmosphereRayleighScaleHeight: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç‘åˆ©æ•£å°„é«˜åº¦</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 8000.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">atmosphereRayleighScaleHeight</span> = <span class="number">8000.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// atmosphereMieScaleHeight: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç±³æ°æ•£å°„é«˜åº¦</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1200.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">atmosphereMieScaleHeight</span> = <span class="number">1200.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// atmosphereMieAnisotropy: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç±³æ°æ•£å°„å„å‘å¼‚æ€§</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 0.9</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">atmosphereMieAnisotropy</span> = <span class="number">0.9</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// baseColor: Color</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åŸºç¡€é¢œè‰²</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Color.BLUE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">baseColor</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLUE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// clippingPlanes: ClippingPlaneCollection</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è£å‰ªå¹³é¢é›†åˆ</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clippingPlanes</span> = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// cartographicLimitRectangle: Rectangle</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åœ°ç†é™åˆ¶çŸ©å½¢</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cartographicLimitRectangle</span> = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// backFaceCulling: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: èƒŒé¢å‰”é™¤</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">backFaceCulling</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// showSkirts: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºè£™è¾¹</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">showSkirts</span> = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// getHeight - è·å–é«˜åº¦</span></span><br><span class="line">  <span class="title function_">getHeight</span>(<span class="params">cartographic</span>) &#123;</span><br><span class="line">    <span class="comment">// cartographic: Cartographic - åœ°ç†åæ ‡</span></span><br><span class="line">    <span class="comment">// è¿”å›: number | undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// pick - æ‹¾å–åœ°çƒè¡¨é¢</span></span><br><span class="line">  <span class="title function_">pick</span>(<span class="params">ray, scene, result</span>) &#123;</span><br><span class="line">    <span class="comment">// ray: Ray - å°„çº¿</span></span><br><span class="line">    <span class="comment">// scene: Scene - åœºæ™¯</span></span><br><span class="line">    <span class="comment">// result: Cartesian3 - ç»“æœå¯¹è±¡</span></span><br><span class="line">    <span class="comment">// è¿”å›: Cartesian3 | undefined</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœºæ™¯ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. åŸºç¡€åœºæ™¯é…ç½®</span></span><br><span class="line"><span class="keyword">const</span> scene = viewer.<span class="property">scene</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®èƒŒæ™¯è‰²</span></span><br><span class="line">scene.<span class="property">backgroundColor</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">DARKSLATEGRAY</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼€å¯é˜´å½±</span></span><br><span class="line">scene.<span class="property">shadows</span> = <span class="literal">true</span></span><br><span class="line">scene.<span class="property">shadowMap</span>.<span class="property">maximumDistance</span> = <span class="number">10000.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼€å¯é›¾æ•ˆ</span></span><br><span class="line">scene.<span class="property">fog</span>.<span class="property">enabled</span> = <span class="literal">true</span></span><br><span class="line">scene.<span class="property">fog</span>.<span class="property">density</span> = <span class="number">0.0001</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. åœ°çƒé…ç½®</span></span><br><span class="line"><span class="keyword">const</span> globe = scene.<span class="property">globe</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ°å½¢ç»†èŠ‚çº§åˆ«</span></span><br><span class="line">globe.<span class="property">maximumScreenSpaceError</span> = <span class="number">1</span> <span class="comment">// æ›´é«˜è´¨é‡</span></span><br><span class="line">globe.<span class="property">tileCacheSize</span> = <span class="number">200</span> <span class="comment">// æ›´å¤§ç¼“å­˜</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼€å¯åœ°çƒå…‰ç…§</span></span><br><span class="line">globe.<span class="property">enableLighting</span> = <span class="literal">true</span></span><br><span class="line">globe.<span class="property">atmosphereLightIntensity</span> = <span class="number">15.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ°´ä½“æ•ˆæœ</span></span><br><span class="line">globe.<span class="property">showWaterEffect</span> = <span class="literal">true</span></span><br><span class="line">globe.<span class="property">baseColor</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">NAVY</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. åå¤„ç†æ•ˆæœ</span></span><br><span class="line"><span class="keyword">const</span> postProcess = scene.<span class="property">postProcessStages</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ FXAAæŠ—é”¯é½¿</span></span><br><span class="line"><span class="keyword">const</span> fxaa = <span class="title class_">Cesium</span>.<span class="property">PostProcessStageLibrary</span>.<span class="title function_">createFXAAStage</span>()</span><br><span class="line">postProcess.<span class="title function_">add</span>(fxaa)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ è½®å»“çº¿æ•ˆæœ</span></span><br><span class="line"><span class="keyword">const</span> silhouette = <span class="title class_">Cesium</span>.<span class="property">PostProcessStageLibrary</span>.<span class="title function_">createSilhouetteStage</span>()</span><br><span class="line">postProcess.<span class="title function_">add</span>(silhouette)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰åå¤„ç†æ•ˆæœ</span></span><br><span class="line"><span class="keyword">const</span> customStage = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PostProcessStage</span>(&#123;</span><br><span class="line">  <span class="attr">fragmentShader</span>: <span class="string">`</span></span><br><span class="line"><span class="string">    uniform sampler2D colorTexture;</span></span><br><span class="line"><span class="string">    in vec2 v_textureCoordinates;</span></span><br><span class="line"><span class="string">    out vec4 fragColor;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    void main() &#123;</span></span><br><span class="line"><span class="string">      vec4 color = texture(colorTexture, v_textureCoordinates);</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">      // ç®€å•çš„ç°åº¦æ•ˆæœ</span></span><br><span class="line"><span class="string">      float gray = dot(color.rgb, vec3(0.299, 0.587, 0.114));</span></span><br><span class="line"><span class="string">      fragColor = vec4(gray, gray, gray, color.a);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  <span class="attr">uniforms</span>: &#123;&#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">postProcess.<span class="title function_">add</span>(customStage)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. äº‹ä»¶ç›‘å¬</span></span><br><span class="line">scene.<span class="property">preRender</span>.<span class="title function_">addEventListener</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// æ¸²æŸ“å‰çš„è‡ªå®šä¹‰é€»è¾‘</span></span><br><span class="line">  customStage.<span class="property">enabled</span> = viewer.<span class="property">clock</span>.<span class="property">currentTime</span>.<span class="property">secondsOfDay</span> &gt; <span class="number">43200</span> <span class="comment">// ä¸‹åˆå¯ç”¨ç°åº¦æ•ˆæœ</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">scene.<span class="property">postRender</span>.<span class="title function_">addEventListener</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// æ¸²æŸ“åçš„ç»Ÿè®¡ä¿¡æ¯</span></span><br><span class="line">  <span class="keyword">if</span> (scene.<span class="property">debugShowFramesPerSecond</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;FPS:&#x27;</span>, scene.<span class="property">debugShowFramesPerSecond</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. æ‹¾å–å¢å¼º</span></span><br><span class="line">scene.<span class="property">pickTranslucentDepth</span> = <span class="literal">true</span> <span class="comment">// æ‹¾å–é€æ˜ç‰©ä½“</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰æ‹¾å–å¤„ç†</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">enhancedPick</span>(<span class="params">windowPosition</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> picked = scene.<span class="title function_">pick</span>(windowPosition)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Cesium</span>.<span class="title function_">defined</span>(picked)) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ‹¾å–åˆ°å¯¹è±¡:&#x27;</span>, picked.<span class="property">id</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–ç²¾ç¡®ä½ç½®</span></span><br><span class="line">    <span class="keyword">const</span> position = scene.<span class="title function_">pickPosition</span>(windowPosition)</span><br><span class="line">    <span class="keyword">if</span> (position) &#123;</span><br><span class="line">      <span class="keyword">const</span> cartographic = <span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromCartesian</span>(position)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç²¾ç¡®ä½ç½®:&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">longitude</span>: <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(cartographic.<span class="property">longitude</span>),</span><br><span class="line">        <span class="attr">latitude</span>: <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(cartographic.<span class="property">latitude</span>),</span><br><span class="line">        <span class="attr">height</span>: cartographic.<span class="property">height</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é’»å–æ‹¾å–ï¼ˆè·å–æ‰€æœ‰å±‚çº§çš„å¯¹è±¡ï¼‰</span></span><br><span class="line">    <span class="keyword">const</span> allPicked = scene.<span class="title function_">drillPick</span>(windowPosition, <span class="number">10</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ‰€æœ‰æ‹¾å–å¯¹è±¡:&#x27;</span>, allPicked)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. æ€§èƒ½ä¼˜åŒ–é…ç½®</span></span><br><span class="line"><span class="comment">// æŒ‰éœ€æ¸²æŸ“</span></span><br><span class="line">scene.<span class="property">requestRenderMode</span> = <span class="literal">true</span></span><br><span class="line">scene.<span class="property">maximumRenderTimeChange</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰‹åŠ¨è¯·æ±‚æ¸²æŸ“</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">requestRenderIfNeeded</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (scene.<span class="property">requestRenderMode</span> &amp;&amp; needsUpdate) &#123;</span><br><span class="line">    scene.<span class="title function_">requestRender</span>()</span><br><span class="line">    needsUpdate = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 7. è°ƒè¯•é…ç½®</span></span><br><span class="line">scene.<span class="property">debugShowFramesPerSecond</span> = <span class="literal">true</span></span><br><span class="line">scene.<span class="property">debugCommandFilter</span> = <span class="function">(<span class="params">command</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// è¿‡æ»¤è°ƒè¯•å‘½ä»¤</span></span><br><span class="line">  <span class="keyword">return</span> command.<span class="property">pass</span> === <span class="title class_">Cesium</span>.<span class="property">Pass</span>.<span class="property">OPAQUE</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 8. HDRå’Œè‰²è°ƒæ˜ å°„</span></span><br><span class="line">scene.<span class="property">highDynamicRange</span> = <span class="literal">true</span></span><br><span class="line">scene.<span class="property">gamma</span> = <span class="number">2.2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 9. åœ°ä¸‹æ¨¡å¼</span></span><br><span class="line">scene.<span class="property">underground</span> = <span class="literal">true</span></span><br><span class="line">scene.<span class="property">undergroundColor</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>.<span class="title function_">withAlpha</span>(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 10. å…¨çƒé€æ˜åº¦</span></span><br><span class="line">scene.<span class="property">globe</span>.<span class="property">translucency</span>.<span class="property">enabled</span> = <span class="literal">true</span></span><br><span class="line">scene.<span class="property">globe</span>.<span class="property">translucency</span>.<span class="property">frontFaceAlpha</span> = <span class="number">0.5</span></span><br><span class="line">scene.<span class="property">globe</span>.<span class="property">translucency</span>.<span class="property">backFaceAlpha</span> = <span class="number">0.1</span></span><br></pre></td></tr></table></figure><h2 id="æ•°æ®æºè¯¦è§£"><a href="#æ•°æ®æºè¯¦è§£" class="headerlink" title="æ•°æ®æºè¯¦è§£"></a>æ•°æ®æºè¯¦è§£</h2><h3 id="DataSource-æ•°æ®æº"><a href="#DataSource-æ•°æ®æº" class="headerlink" title="DataSource æ•°æ®æº"></a>DataSource æ•°æ®æº</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DataSource - æ•°æ®æºåŸºç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataSource</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="comment">// name: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ•°æ®æºåç§°</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name</span><br><span class="line"></span><br><span class="line">    <span class="comment">// show: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤º</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// entities: EntityCollection</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å®ä½“é›†åˆ</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">entities</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">EntityCollection</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// isLoading: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ­£åœ¨åŠ è½½</span></span><br><span class="line">    <span class="comment">// åªè¯»: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// changedEvent: Event</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å˜åŒ–äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">changedEvent</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// errorEvent: Event</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é”™è¯¯äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">errorEvent</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// loadingEvent: Event</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åŠ è½½äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loadingEvent</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clock: DataSourceClock</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ•°æ®æºæ—¶é’Ÿ</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clock</span> = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// clustering: EntityCluster</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å®ä½“èšç±»</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clustering</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">EntityCluster</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// update - æ›´æ–°æ•°æ®æº</span></span><br><span class="line">  <span class="title function_">update</span>(<span class="params">time</span>) &#123;</span><br><span class="line">    <span class="comment">// time: JulianDate - å½“å‰æ—¶é—´</span></span><br><span class="line">    <span class="comment">// è¿”å›: boolean - æ˜¯å¦éœ€è¦æ¸²æŸ“</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CzmlDataSource - CZMLæ•°æ®æº</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CzmlDataSource</span> <span class="keyword">extends</span> <span class="title class_ inherited__">DataSource</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(name)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é™æ€æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// load - åŠ è½½CZMLæ•°æ®</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">load</span>(<span class="params">czml, options</span>) &#123;</span><br><span class="line">    <span class="comment">// czml: Object | string | Resource</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: CZMLæ•°æ®</span></span><br><span class="line">    <span class="comment">// options: Object</span></span><br><span class="line">    <span class="comment">// sourceUri: string - æºURI</span></span><br><span class="line">    <span class="comment">// credit: Credit - ç‰ˆæƒä¿¡æ¯</span></span><br><span class="line">    <span class="comment">// è¿”å›: Promise&lt;CzmlDataSource&gt;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// process - å¤„ç†CZMLæ•°æ®</span></span><br><span class="line">  <span class="title function_">process</span>(<span class="params">czml, options</span>) &#123;</span><br><span class="line">    <span class="comment">// czml: Object | string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: CZMLæ•°æ®</span></span><br><span class="line">    <span class="comment">// options: Object</span></span><br><span class="line">    <span class="comment">// sourceUri: string - æºURI</span></span><br><span class="line">    <span class="comment">// isUpdating: boolean - æ˜¯å¦æ›´æ–°æ¨¡å¼</span></span><br><span class="line">    <span class="comment">// è¿”å›: Promise&lt;CzmlDataSource&gt;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GeoJsonDataSource - GeoJSONæ•°æ®æº</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GeoJsonDataSource</span> <span class="keyword">extends</span> <span class="title class_ inherited__">DataSource</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(name)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// markerSize: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ ‡è®°å¤§å°</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 48</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">markerSize</span> = <span class="number">48</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// markerSymbol: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ ‡è®°ç¬¦å·</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">markerSymbol</span> = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// markerColor: Color</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ ‡è®°é¢œè‰²</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Color.ROYALBLUE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">markerColor</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">ROYALBLUE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// stroke: Color</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æè¾¹é¢œè‰²</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Color.YELLOW</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">stroke</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// strokeWidth: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æè¾¹å®½åº¦</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 2</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">strokeWidth</span> = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// fill: Color</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¡«å……é¢œè‰²</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Color.YELLOW.withAlpha(0.5)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fill</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>.<span class="title function_">withAlpha</span>(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clampToGround: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦è´´åœ°</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clampToGround</span> = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é™æ€æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// load - åŠ è½½GeoJSONæ•°æ®</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">load</span>(<span class="params">data, options</span>) &#123;</span><br><span class="line">    <span class="comment">// data: Resource | string | Object</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: GeoJSONæ•°æ®</span></span><br><span class="line">    <span class="comment">// options: Object</span></span><br><span class="line">    <span class="comment">// sourceUri: string - æºURI</span></span><br><span class="line">    <span class="comment">// markerSize: number - æ ‡è®°å¤§å°</span></span><br><span class="line">    <span class="comment">// markerSymbol: string - æ ‡è®°ç¬¦å·</span></span><br><span class="line">    <span class="comment">// markerColor: Color - æ ‡è®°é¢œè‰²</span></span><br><span class="line">    <span class="comment">// stroke: Color - æè¾¹é¢œè‰²</span></span><br><span class="line">    <span class="comment">// strokeWidth: number - æè¾¹å®½åº¦</span></span><br><span class="line">    <span class="comment">// fill: Color - å¡«å……é¢œè‰²</span></span><br><span class="line">    <span class="comment">// clampToGround: boolean - æ˜¯å¦è´´åœ°</span></span><br><span class="line">    <span class="comment">// credit: Credit - ç‰ˆæƒä¿¡æ¯</span></span><br><span class="line">    <span class="comment">// è¿”å›: Promise&lt;GeoJsonDataSource&gt;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// KmlDataSource - KMLæ•°æ®æº</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">KmlDataSource</span> <span class="keyword">extends</span> <span class="title class_ inherited__">DataSource</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(name)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// refreshEvent: Event</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åˆ·æ–°äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">refreshEvent</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// unsupportedNodeEvent: Event</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ä¸æ”¯æŒèŠ‚ç‚¹äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">unsupportedNodeEvent</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é™æ€æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// load - åŠ è½½KMLæ•°æ®</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">load</span>(<span class="params">data, options</span>) &#123;</span><br><span class="line">    <span class="comment">// data: Resource | string | Document | Blob</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: KMLæ•°æ®</span></span><br><span class="line">    <span class="comment">// options: Object</span></span><br><span class="line">    <span class="comment">// sourceUri: string - æºURI</span></span><br><span class="line">    <span class="comment">// clampToGround: boolean - æ˜¯å¦è´´åœ°</span></span><br><span class="line">    <span class="comment">// ellipsoid: Ellipsoid - æ¤­çƒä½“</span></span><br><span class="line">    <span class="comment">// credit: Credit - ç‰ˆæƒä¿¡æ¯</span></span><br><span class="line">    <span class="comment">// è¿”å›: Promise&lt;KmlDataSource&gt;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GpxDataSource - GPXæ•°æ®æº</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GpxDataSource</span> <span class="keyword">extends</span> <span class="title class_ inherited__">DataSource</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(name)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// trackColor: Color</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è½¨è¿¹é¢œè‰²</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Color.YELLOW</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">trackColor</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// routeColor: Color</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è·¯çº¿é¢œè‰²</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: Color.ORANGE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">routeColor</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">ORANGE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// waypointImage: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è·¯ç‚¹å›¾åƒ</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">waypointImage</span> = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// clampToGround: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦è´´åœ°</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clampToGround</span> = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é™æ€æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// load - åŠ è½½GPXæ•°æ®</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">load</span>(<span class="params">data, options</span>) &#123;</span><br><span class="line">    <span class="comment">// data: Resource | string | Document | Blob</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: GPXæ•°æ®</span></span><br><span class="line">    <span class="comment">// options: Object</span></span><br><span class="line">    <span class="comment">// è¿”å›: Promise&lt;GpxDataSource&gt;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CustomDataSource - è‡ªå®šä¹‰æ•°æ®æº</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomDataSource</span> <span class="keyword">extends</span> <span class="title class_ inherited__">DataSource</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(name)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ•°æ®æºä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. CZMLæ•°æ®æº</span></span><br><span class="line"><span class="keyword">const</span> czmlData = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="string">&#x27;document&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;CZMLç¤ºä¾‹&#x27;</span>,</span><br><span class="line">    <span class="attr">version</span>: <span class="string">&#x27;1.0&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="string">&#x27;satellite&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;å«æ˜Ÿ&#x27;</span>,</span><br><span class="line">    <span class="attr">availability</span>: <span class="string">&#x27;2023-01-01T00:00:00Z/2023-01-02T00:00:00Z&#x27;</span>,</span><br><span class="line">    <span class="attr">position</span>: &#123;</span><br><span class="line">      <span class="attr">epoch</span>: <span class="string">&#x27;2023-01-01T00:00:00Z&#x27;</span>,</span><br><span class="line">      <span class="attr">cartographicDegrees</span>: [<span class="number">0</span>, <span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">400000</span>, <span class="number">3600</span>, <span class="number">121.4737</span>, <span class="number">31.2304</span>, <span class="number">400000</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">billboard</span>: &#123;</span><br><span class="line">      <span class="attr">image</span>:</span><br><span class="line">        <span class="string">&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==&#x27;</span>,</span><br><span class="line">      <span class="attr">scale</span>: <span class="number">2.0</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">path</span>: &#123;</span><br><span class="line">      <span class="attr">material</span>: &#123;</span><br><span class="line">        <span class="attr">polylineOutline</span>: &#123;</span><br><span class="line">          <span class="attr">color</span>: &#123; <span class="attr">rgba</span>: [<span class="number">255</span>, <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>] &#125;,</span><br><span class="line">          <span class="attr">outlineColor</span>: &#123; <span class="attr">rgba</span>: [<span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>] &#125;,</span><br><span class="line">          <span class="attr">outlineWidth</span>: <span class="number">5</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">width</span>: <span class="number">8</span>,</span><br><span class="line">      <span class="attr">leadTime</span>: <span class="number">10</span>,</span><br><span class="line">      <span class="attr">trailTime</span>: <span class="number">1000</span>,</span><br><span class="line">      <span class="attr">resolution</span>: <span class="number">5</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="title class_">Cesium</span>.<span class="property">CzmlDataSource</span>.<span class="title function_">load</span>(czmlData).<span class="title function_">then</span>(<span class="function">(<span class="params">dataSource</span>) =&gt;</span> &#123;</span><br><span class="line">  viewer.<span class="property">dataSources</span>.<span class="title function_">add</span>(dataSource)</span><br><span class="line">  viewer.<span class="title function_">zoomTo</span>(dataSource)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. GeoJSONæ•°æ®æº</span></span><br><span class="line"><span class="keyword">const</span> geoJsonData = &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;FeatureCollection&#x27;</span>,</span><br><span class="line">  <span class="attr">features</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;Feature&#x27;</span>,</span><br><span class="line">      <span class="attr">properties</span>: &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;åŒ—äº¬å¸‚&#x27;</span>,</span><br><span class="line">        <span class="attr">population</span>: <span class="number">21540000</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">geometry</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;Point&#x27;</span>,</span><br><span class="line">        <span class="attr">coordinates</span>: [<span class="number">116.4074</span>, <span class="number">39.9042</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;Feature&#x27;</span>,</span><br><span class="line">      <span class="attr">properties</span>: &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;æ•…å®«&#x27;</span>,</span><br><span class="line">        <span class="attr">area</span>: <span class="number">720000</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">geometry</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;Polygon&#x27;</span>,</span><br><span class="line">        <span class="attr">coordinates</span>: [</span><br><span class="line">          [</span><br><span class="line">            [<span class="number">116.3906</span>, <span class="number">39.9097</span>],</span><br><span class="line">            [<span class="number">116.3971</span>, <span class="number">39.9097</span>],</span><br><span class="line">            [<span class="number">116.3971</span>, <span class="number">39.9208</span>],</span><br><span class="line">            [<span class="number">116.3906</span>, <span class="number">39.9208</span>],</span><br><span class="line">            [<span class="number">116.3906</span>, <span class="number">39.9097</span>],</span><br><span class="line">          ],</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Cesium</span>.<span class="property">GeoJsonDataSource</span>.<span class="title function_">load</span>(geoJsonData, &#123;</span><br><span class="line">  <span class="attr">markerSize</span>: <span class="number">64</span>,</span><br><span class="line">  <span class="attr">markerColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span>,</span><br><span class="line">  <span class="attr">stroke</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLUE</span>,</span><br><span class="line">  <span class="attr">strokeWidth</span>: <span class="number">3</span>,</span><br><span class="line">  <span class="attr">fill</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLUE</span>.<span class="title function_">withAlpha</span>(<span class="number">0.3</span>),</span><br><span class="line">  <span class="attr">clampToGround</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">dataSource</span>) =&gt;</span> &#123;</span><br><span class="line">  viewer.<span class="property">dataSources</span>.<span class="title function_">add</span>(dataSource)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è‡ªå®šä¹‰æ ·å¼</span></span><br><span class="line">  <span class="keyword">const</span> entities = dataSource.<span class="property">entities</span>.<span class="property">values</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; entities.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> entity = entities[i]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (entity.<span class="property">billboard</span>) &#123;</span><br><span class="line">      <span class="comment">// è‡ªå®šä¹‰ç‚¹æ ·å¼</span></span><br><span class="line">      entity.<span class="property">billboard</span>.<span class="property">image</span> = <span class="title function_">createCustomIcon</span>(entity.<span class="property">properties</span>.<span class="property">name</span>)</span><br><span class="line">      entity.<span class="property">billboard</span>.<span class="property">scale</span> = <span class="number">1.5</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (entity.<span class="property">polygon</span>) &#123;</span><br><span class="line">      <span class="comment">// è‡ªå®šä¹‰å¤šè¾¹å½¢æ ·å¼</span></span><br><span class="line">      entity.<span class="property">polygon</span>.<span class="property">material</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="title function_">fromCssColorString</span>(<span class="string">&#x27;#ff6b6b&#x27;</span>).<span class="title function_">withAlpha</span>(<span class="number">0.4</span>)</span><br><span class="line">      entity.<span class="property">polygon</span>.<span class="property">outline</span> = <span class="literal">true</span></span><br><span class="line">      entity.<span class="property">polygon</span>.<span class="property">outlineColor</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="title function_">fromCssColorString</span>(<span class="string">&#x27;#ff4757&#x27;</span>)</span><br><span class="line">      entity.<span class="property">polygon</span>.<span class="property">height</span> = <span class="number">50</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ æ ‡ç­¾</span></span><br><span class="line">    entity.<span class="property">label</span> = &#123;</span><br><span class="line">      <span class="attr">text</span>: entity.<span class="property">properties</span>.<span class="property">name</span>,</span><br><span class="line">      <span class="attr">font</span>: <span class="string">&#x27;16pt Microsoft YaHei&#x27;</span>,</span><br><span class="line">      <span class="attr">fillColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span>,</span><br><span class="line">      <span class="attr">outlineColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>,</span><br><span class="line">      <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">style</span>: <span class="title class_">Cesium</span>.<span class="property">LabelStyle</span>.<span class="property">FILL_AND_OUTLINE</span>,</span><br><span class="line">      <span class="attr">pixelOffset</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">0</span>, -<span class="number">50</span>),</span><br><span class="line">      <span class="attr">showBackground</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">backgroundColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>.<span class="title function_">withAlpha</span>(<span class="number">0.7</span>),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. KMLæ•°æ®æºï¼ˆä»æ–‡ä»¶åŠ è½½ï¼‰</span></span><br><span class="line"><span class="title class_">Cesium</span>.<span class="property">KmlDataSource</span>.<span class="title function_">load</span>(<span class="string">&#x27;./data/sample.kml&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">clampToGround</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">dataSource</span>) =&gt;</span> &#123;</span><br><span class="line">  viewer.<span class="property">dataSources</span>.<span class="title function_">add</span>(dataSource)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç›‘å¬ä¸æ”¯æŒçš„KMLèŠ‚ç‚¹</span></span><br><span class="line">  dataSource.<span class="property">unsupportedNodeEvent</span>.<span class="title function_">addEventListener</span>(</span><br><span class="line">    <span class="function">(<span class="params">dataSource, parentEntity, node, entityCollection, styleCollection</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;ä¸æ”¯æŒçš„KMLèŠ‚ç‚¹:&#x27;</span>, node.<span class="property">nodeName</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">  )</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. è‡ªå®šä¹‰æ•°æ®æº</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RealtimeDataSource</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Cesium.CustomDataSource</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(<span class="string">&#x27;å®æ—¶æ•°æ®&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_timer</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_isLoading</span> = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¼€å§‹å®æ—¶æ•°æ®æ›´æ–°</span></span><br><span class="line">  <span class="title function_">startRealtime</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_timer</span> = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">updateData</span>()</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœæ­¢å®æ—¶æ•°æ®æ›´æ–°</span></span><br><span class="line">  <span class="title function_">stopRealtime</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_timer</span>) &#123;</span><br><span class="line">      <span class="built_in">clearInterval</span>(<span class="variable language_">this</span>.<span class="property">_timer</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_timer</span> = <span class="literal">undefined</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ›´æ–°æ•°æ®</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">updateData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_isLoading</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_isLoading</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loadingEvent</span>.<span class="title function_">raiseEvent</span>(<span class="variable language_">this</span>, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// æ¨¡æ‹Ÿä»APIè·å–æ•°æ®</span></span><br><span class="line">      <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;/api/realtime-data&#x27;</span>)</span><br><span class="line">      <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="title function_">json</span>()</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ›´æ–°å®ä½“</span></span><br><span class="line">      data.<span class="property">vehicles</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">vehicle</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> entity = <span class="variable language_">this</span>.<span class="property">entities</span>.<span class="title function_">getById</span>(vehicle.<span class="property">id</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!entity) &#123;</span><br><span class="line">          <span class="comment">// åˆ›å»ºæ–°å®ä½“</span></span><br><span class="line">          entity = <span class="variable language_">this</span>.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">            <span class="attr">id</span>: vehicle.<span class="property">id</span>,</span><br><span class="line">            <span class="attr">name</span>: vehicle.<span class="property">name</span>,</span><br><span class="line">            <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(vehicle.<span class="property">lon</span>, vehicle.<span class="property">lat</span>, vehicle.<span class="property">alt</span>),</span><br><span class="line">            <span class="attr">billboard</span>: &#123;</span><br><span class="line">              <span class="attr">image</span>: <span class="string">&#x27;./icons/vehicle.png&#x27;</span>,</span><br><span class="line">              <span class="attr">scale</span>: <span class="number">1.0</span>,</span><br><span class="line">              <span class="attr">verticalOrigin</span>: <span class="title class_">Cesium</span>.<span class="property">VerticalOrigin</span>.<span class="property">BOTTOM</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">label</span>: &#123;</span><br><span class="line">              <span class="attr">text</span>: vehicle.<span class="property">name</span>,</span><br><span class="line">              <span class="attr">font</span>: <span class="string">&#x27;12pt sans-serif&#x27;</span>,</span><br><span class="line">              <span class="attr">pixelOffset</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">0</span>, -<span class="number">40</span>),</span><br><span class="line">              <span class="attr">fillColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span>,</span><br><span class="line">              <span class="attr">outlineColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>,</span><br><span class="line">              <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">              <span class="attr">style</span>: <span class="title class_">Cesium</span>.<span class="property">LabelStyle</span>.<span class="property">FILL_AND_OUTLINE</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// æ›´æ–°ä½ç½®</span></span><br><span class="line">          entity.<span class="property">position</span> = <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(vehicle.<span class="property">lon</span>, vehicle.<span class="property">lat</span>, vehicle.<span class="property">alt</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ›´æ–°å±æ€§</span></span><br><span class="line">        entity.<span class="property">description</span> = <span class="string">`</span></span><br><span class="line"><span class="string">          &lt;div&gt;</span></span><br><span class="line"><span class="string">            &lt;h3&gt;<span class="subst">$&#123;vehicle.name&#125;</span>&lt;/h3&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;é€Ÿåº¦: <span class="subst">$&#123;vehicle.speed&#125;</span> km/h&lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;æ–¹å‘: <span class="subst">$&#123;vehicle.heading&#125;</span>Â°&lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;æ›´æ–°æ—¶é—´: <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>(vehicle.timestamp).toLocaleString()&#125;</span>&lt;/p&gt;</span></span><br><span class="line"><span class="string">          &lt;/div&gt;</span></span><br><span class="line"><span class="string">        `</span></span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">changedEvent</span>.<span class="title function_">raiseEvent</span>(<span class="variable language_">this</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;æ›´æ–°å®æ—¶æ•°æ®å¤±è´¥:&#x27;</span>, error)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">errorEvent</span>.<span class="title function_">raiseEvent</span>(<span class="variable language_">this</span>, error)</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_isLoading</span> = <span class="literal">false</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">loadingEvent</span>.<span class="title function_">raiseEvent</span>(<span class="variable language_">this</span>, <span class="literal">false</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨è‡ªå®šä¹‰æ•°æ®æº</span></span><br><span class="line"><span class="keyword">const</span> realtimeDataSource = <span class="keyword">new</span> <span class="title class_">RealtimeDataSource</span>()</span><br><span class="line">viewer.<span class="property">dataSources</span>.<span class="title function_">add</span>(realtimeDataSource)</span><br><span class="line">realtimeDataSource.<span class="title function_">startRealtime</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. æ•°æ®æºç®¡ç†</span></span><br><span class="line"><span class="keyword">const</span> dataSources = viewer.<span class="property">dataSources</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ æ•°æ®æº</span></span><br><span class="line">dataSources.<span class="title function_">add</span>(dataSource)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç§»é™¤æ•°æ®æº</span></span><br><span class="line">dataSources.<span class="title function_">remove</span>(dataSource)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–æ•°æ®æº</span></span><br><span class="line"><span class="keyword">const</span> firstDataSource = dataSources.<span class="title function_">get</span>(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">const</span> dataSourceByName = dataSources.<span class="title function_">getByName</span>(<span class="string">&#x27;å®æ—¶æ•°æ®&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ˜¾ç¤º/éšè—æ•°æ®æº</span></span><br><span class="line">dataSource.<span class="property">show</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘å¬æ•°æ®æºå˜åŒ–</span></span><br><span class="line">dataSources.<span class="property">dataSourceAdded</span>.<span class="title function_">addEventListener</span>(<span class="function">(<span class="params">collection, dataSource</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ·»åŠ æ•°æ®æº:&#x27;</span>, dataSource.<span class="property">name</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">dataSources.<span class="property">dataSourceRemoved</span>.<span class="title function_">addEventListener</span>(<span class="function">(<span class="params">collection, dataSource</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç§»é™¤æ•°æ®æº:&#x27;</span>, dataSource.<span class="property">name</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. å®ä½“èšç±»</span></span><br><span class="line"><span class="keyword">const</span> clustering = dataSource.<span class="property">clustering</span></span><br><span class="line">clustering.<span class="property">enabled</span> = <span class="literal">true</span></span><br><span class="line">clustering.<span class="property">pixelRange</span> = <span class="number">15</span></span><br><span class="line">clustering.<span class="property">minimumClusterSize</span> = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰èšç±»æ ·å¼</span></span><br><span class="line">clustering.<span class="property">clusterBillboards</span> = <span class="literal">false</span></span><br><span class="line">clustering.<span class="property">clusterLabels</span> = <span class="literal">false</span></span><br><span class="line">clustering.<span class="property">clusterPoints</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// èšç±»äº‹ä»¶</span></span><br><span class="line">clustering.<span class="property">clusterEvent</span>.<span class="title function_">addEventListener</span>(<span class="function">(<span class="params">clusteredEntities, cluster</span>) =&gt;</span> &#123;</span><br><span class="line">  cluster.<span class="property">billboard</span>.<span class="property">show</span> = <span class="literal">false</span></span><br><span class="line">  cluster.<span class="property">label</span>.<span class="property">show</span> = <span class="literal">true</span></span><br><span class="line">  cluster.<span class="property">label</span>.<span class="property">text</span> = clusteredEntities.<span class="property">length</span>.<span class="title function_">toString</span>()</span><br><span class="line">  cluster.<span class="property">label</span>.<span class="property">font</span> = <span class="string">&#x27;16pt sans-serif&#x27;</span></span><br><span class="line">  cluster.<span class="property">label</span>.<span class="property">fillColor</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span></span><br><span class="line">  cluster.<span class="property">label</span>.<span class="property">outlineColor</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span></span><br><span class="line">  cluster.<span class="property">label</span>.<span class="property">outlineWidth</span> = <span class="number">2</span></span><br><span class="line">  cluster.<span class="property">label</span>.<span class="property">style</span> = <span class="title class_">Cesium</span>.<span class="property">LabelStyle</span>.<span class="property">FILL_AND_OUTLINE</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ·»åŠ è‡ªå®šä¹‰ç‚¹</span></span><br><span class="line">  cluster.<span class="property">point</span> = &#123;</span><br><span class="line">    <span class="attr">pixelSize</span>: <span class="number">30</span>,</span><br><span class="line">    <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">CYAN</span>,</span><br><span class="line">    <span class="attr">outlineColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>,</span><br><span class="line">    <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createCustomIcon</span>(<span class="params">name</span>) &#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºè‡ªå®šä¹‰å›¾æ ‡</span></span><br><span class="line">  <span class="keyword">const</span> canvas = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;canvas&#x27;</span>)</span><br><span class="line">  canvas.<span class="property">width</span> = <span class="number">64</span></span><br><span class="line">  canvas.<span class="property">height</span> = <span class="number">64</span></span><br><span class="line">  <span class="keyword">const</span> ctx = canvas.<span class="title function_">getContext</span>(<span class="string">&#x27;2d&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç»˜åˆ¶èƒŒæ™¯åœ†</span></span><br><span class="line">  ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;#ff6b6b&#x27;</span></span><br><span class="line">  ctx.<span class="title function_">beginPath</span>()</span><br><span class="line">  ctx.<span class="title function_">arc</span>(<span class="number">32</span>, <span class="number">32</span>, <span class="number">30</span>, <span class="number">0</span>, <span class="number">2</span> * <span class="title class_">Math</span>.<span class="property">PI</span>)</span><br><span class="line">  ctx.<span class="title function_">fill</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç»˜åˆ¶è¾¹æ¡†</span></span><br><span class="line">  ctx.<span class="property">strokeStyle</span> = <span class="string">&#x27;#ff4757&#x27;</span></span><br><span class="line">  ctx.<span class="property">lineWidth</span> = <span class="number">3</span></span><br><span class="line">  ctx.<span class="title function_">stroke</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç»˜åˆ¶æ–‡å­—</span></span><br><span class="line">  ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;white&#x27;</span></span><br><span class="line">  ctx.<span class="property">font</span> = <span class="string">&#x27;12px Arial&#x27;</span></span><br><span class="line">  ctx.<span class="property">textAlign</span> = <span class="string">&#x27;center&#x27;</span></span><br><span class="line">  ctx.<span class="title function_">fillText</span>(name.<span class="title function_">substring</span>(<span class="number">0</span>, <span class="number">2</span>), <span class="number">32</span>, <span class="number">38</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> canvas.<span class="title function_">toDataURL</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ—¶é—´ç³»ç»Ÿè¯¦è§£"><a href="#æ—¶é—´ç³»ç»Ÿè¯¦è§£" class="headerlink" title="æ—¶é—´ç³»ç»Ÿè¯¦è§£"></a>æ—¶é—´ç³»ç»Ÿè¯¦è§£</h2><h3 id="JulianDate-å„’ç•¥æ—¥æœŸ"><a href="#JulianDate-å„’ç•¥æ—¥æœŸ" class="headerlink" title="JulianDate å„’ç•¥æ—¥æœŸ"></a>JulianDate å„’ç•¥æ—¥æœŸ</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JulianDate - å„’ç•¥æ—¥æœŸç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JulianDate</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">julianDayNumber, secondsOfDay, timeStandard</span>) &#123;</span><br><span class="line">    <span class="comment">// julianDayNumber: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å„’ç•¥æ—¥æ•°</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">julianDayNumber</span> = julianDayNumber || <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// secondsOfDay: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ä¸€å¤©ä¸­çš„ç§’æ•°</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 0.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">secondsOfDay</span> = secondsOfDay || <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// timeStandard: TimeStandard</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ—¶é—´æ ‡å‡†</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: TimeStandard.UTC</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">timeStandard</span> = timeStandard || <span class="title class_">Cesium</span>.<span class="property">TimeStandard</span>.<span class="property">UTC</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é™æ€æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// now - è·å–å½“å‰æ—¶é—´</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">now</span>(<span class="params">result</span>) &#123;</span><br><span class="line">    <span class="comment">// result: JulianDate - ç»“æœå¯¹è±¡</span></span><br><span class="line">    <span class="comment">// è¿”å›: JulianDate</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">now</span>(result)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromDate - ä»JavaScript Dateåˆ›å»º</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromDate</span>(<span class="params">date, result</span>) &#123;</span><br><span class="line">    <span class="comment">// date: Date - JavaScriptæ—¥æœŸå¯¹è±¡</span></span><br><span class="line">    <span class="comment">// result: JulianDate - ç»“æœå¯¹è±¡</span></span><br><span class="line">    <span class="comment">// è¿”å›: JulianDate</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(date, result)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromIso8601 - ä»ISO 8601å­—ç¬¦ä¸²åˆ›å»º</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromIso8601</span>(<span class="params">iso8601String, result</span>) &#123;</span><br><span class="line">    <span class="comment">// iso8601String: string - ISO 8601æ ¼å¼å­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="comment">// ä¾‹å¦‚: &quot;2023-01-01T12:00:00Z&quot;</span></span><br><span class="line">    <span class="comment">// result: JulianDate - ç»“æœå¯¹è±¡</span></span><br><span class="line">    <span class="comment">// è¿”å›: JulianDate</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(iso8601String, result)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// toDate - è½¬æ¢ä¸ºJavaScript Date</span></span><br><span class="line">  <span class="title function_">toDate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// è¿”å›: Date</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">toDate</span>(<span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// toIso8601 - è½¬æ¢ä¸ºISO 8601å­—ç¬¦ä¸²</span></span><br><span class="line">  <span class="title function_">toIso8601</span>(<span class="params">precision</span>) &#123;</span><br><span class="line">    <span class="comment">// precision: number - ç²¾åº¦ï¼ˆå°æ•°ä½æ•°ï¼‰</span></span><br><span class="line">    <span class="comment">// è¿”å›: string</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">toIso8601</span>(<span class="variable language_">this</span>, precision)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// addSeconds - æ·»åŠ ç§’æ•°</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">addSeconds</span>(<span class="params">julianDate, seconds, result</span>) &#123;</span><br><span class="line">    <span class="comment">// julianDate: JulianDate - å„’ç•¥æ—¥æœŸ</span></span><br><span class="line">    <span class="comment">// seconds: number - ç§’æ•°</span></span><br><span class="line">    <span class="comment">// result: JulianDate - ç»“æœå¯¹è±¡</span></span><br><span class="line">    <span class="comment">// è¿”å›: JulianDate</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addSeconds</span>(julianDate, seconds, result)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// addMinutes - æ·»åŠ åˆ†é’Ÿæ•°</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">addMinutes</span>(<span class="params">julianDate, minutes, result</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addMinutes</span>(julianDate, minutes, result)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// addHours - æ·»åŠ å°æ—¶æ•°</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">addHours</span>(<span class="params">julianDate, hours, result</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addHours</span>(julianDate, hours, result)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// addDays - æ·»åŠ å¤©æ•°</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">addDays</span>(<span class="params">julianDate, days, result</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addDays</span>(julianDate, days, result)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// secondsDifference - è®¡ç®—ç§’æ•°å·®</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">secondsDifference</span>(<span class="params">left, right</span>) &#123;</span><br><span class="line">    <span class="comment">// left: JulianDate - å·¦æ“ä½œæ•°</span></span><br><span class="line">    <span class="comment">// right: JulianDate - å³æ“ä½œæ•°</span></span><br><span class="line">    <span class="comment">// è¿”å›: number - ç§’æ•°å·® (left - right)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">secondsDifference</span>(left, right)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// daysDifference - è®¡ç®—å¤©æ•°å·®</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">daysDifference</span>(<span class="params">left, right</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">daysDifference</span>(left, right)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// compare - æ¯”è¾ƒä¸¤ä¸ªæ—¥æœŸ</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">compare</span>(<span class="params">left, right</span>) &#123;</span><br><span class="line">    <span class="comment">// è¿”å›: number</span></span><br><span class="line">    <span class="comment">// -1: left &lt; right</span></span><br><span class="line">    <span class="comment">//  0: left === right</span></span><br><span class="line">    <span class="comment">//  1: left &gt; right</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">compare</span>(left, right)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// equals - åˆ¤æ–­ç›¸ç­‰</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">equals</span>(<span class="params">left, right</span>) &#123;</span><br><span class="line">    <span class="comment">// è¿”å›: boolean</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">equals</span>(left, right)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// equalsEpsilon - åœ¨æŒ‡å®šç²¾åº¦å†…åˆ¤æ–­ç›¸ç­‰</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">equalsEpsilon</span>(<span class="params">left, right, epsilon</span>) &#123;</span><br><span class="line">    <span class="comment">// epsilon: number - è¯¯å·®èŒƒå›´ï¼ˆç§’ï¼‰</span></span><br><span class="line">    <span class="comment">// è¿”å›: boolean</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">equalsEpsilon</span>(left, right, epsilon)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// clone - å…‹éš†</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">clone</span>(<span class="params">julianDate, result</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">clone</span>(julianDate, result)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TimeInterval - æ—¶é—´é—´éš”</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TimeInterval</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// start: JulianDate</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¼€å§‹æ—¶é—´</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: new JulianDate()</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">start</span> = options.<span class="property">start</span> || <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// stop: JulianDate</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç»“æŸæ—¶é—´</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: new JulianDate()</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">stop</span> = options.<span class="property">stop</span> || <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// isStartIncluded: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦åŒ…å«å¼€å§‹æ—¶é—´</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isStartIncluded</span> = options.<span class="property">isStartIncluded</span> !== <span class="literal">undefined</span> ? options.<span class="property">isStartIncluded</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// isStopIncluded: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦åŒ…å«ç»“æŸæ—¶é—´</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isStopIncluded</span> = options.<span class="property">isStopIncluded</span> !== <span class="literal">undefined</span> ? options.<span class="property">isStopIncluded</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// data: Object</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å…³è”æ•°æ®</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">data</span> = options.<span class="property">data</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// contains - æ˜¯å¦åŒ…å«æŒ‡å®šæ—¶é—´</span></span><br><span class="line">  <span class="title function_">contains</span>(<span class="params">julianDate</span>) &#123;</span><br><span class="line">    <span class="comment">// julianDate: JulianDate - è¦æ£€æŸ¥çš„æ—¶é—´</span></span><br><span class="line">    <span class="comment">// è¿”å›: boolean</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">TimeInterval</span>.<span class="title function_">contains</span>(<span class="variable language_">this</span>, julianDate)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// intersect - æ±‚äº¤é›†</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">intersect</span>(<span class="params">left, right, result</span>) &#123;</span><br><span class="line">    <span class="comment">// left: TimeInterval - å·¦é—´éš”</span></span><br><span class="line">    <span class="comment">// right: TimeInterval - å³é—´éš”</span></span><br><span class="line">    <span class="comment">// result: TimeInterval - ç»“æœå¯¹è±¡</span></span><br><span class="line">    <span class="comment">// è¿”å›: TimeInterval</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">TimeInterval</span>.<span class="title function_">intersect</span>(left, right, result)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// isEmpty - æ˜¯å¦ä¸ºç©ºé—´éš”</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">isEmpty</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">TimeInterval</span>.<span class="title function_">isEmpty</span>(<span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TimeIntervalCollection - æ—¶é—´é—´éš”é›†åˆ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TimeIntervalCollection</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">intervals</span>) &#123;</span><br><span class="line">    <span class="comment">// intervals: Array&lt;TimeInterval&gt; - æ—¶é—´é—´éš”æ•°ç»„</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_intervals</span> = intervals || []</span><br><span class="line"></span><br><span class="line">    <span class="comment">// changed: Event</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é›†åˆå˜åŒ–äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">changed</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// changedEventHelper: EventHelper</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">changedEventHelper</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">EventHelper</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å±æ€§</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// start: JulianDate</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: ç¬¬ä¸€ä¸ªé—´éš”çš„å¼€å§‹æ—¶é—´</span></span><br><span class="line">  <span class="comment">// åªè¯»: true</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">start</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">length</span> &gt; <span class="number">0</span> ? <span class="variable language_">this</span>.<span class="property">_intervals</span>[<span class="number">0</span>].<span class="property">start</span> : <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// stop: JulianDate</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æœ€åä¸€ä¸ªé—´éš”çš„ç»“æŸæ—¶é—´</span></span><br><span class="line">  <span class="comment">// åªè¯»: true</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">stop</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">length</span> &gt; <span class="number">0</span> ? <span class="variable language_">this</span>.<span class="property">_intervals</span>[<span class="variable language_">this</span>.<span class="property">length</span> - <span class="number">1</span>].<span class="property">stop</span> : <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// length: number</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: é—´éš”æ•°é‡</span></span><br><span class="line">  <span class="comment">// åªè¯»: true</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">length</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_intervals</span>.<span class="property">length</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// isEmpty: boolean</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ˜¯å¦ä¸ºç©ºé›†åˆ</span></span><br><span class="line">  <span class="comment">// åªè¯»: true</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">isEmpty</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">length</span> === <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// addInterval - æ·»åŠ é—´éš”</span></span><br><span class="line">  <span class="title function_">addInterval</span>(<span class="params">interval, dataComparer</span>) &#123;</span><br><span class="line">    <span class="comment">// interval: TimeInterval - è¦æ·»åŠ çš„é—´éš”</span></span><br><span class="line">    <span class="comment">// dataComparer: function - æ•°æ®æ¯”è¾ƒå‡½æ•°</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_intervals</span>.<span class="title function_">push</span>(interval)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">changed</span>.<span class="title function_">raiseEvent</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// removeInterval - ç§»é™¤é—´éš”</span></span><br><span class="line">  <span class="title function_">removeInterval</span>(<span class="params">interval</span>) &#123;</span><br><span class="line">    <span class="comment">// interval: TimeInterval - è¦ç§»é™¤çš„é—´éš”</span></span><br><span class="line">    <span class="keyword">const</span> index = <span class="variable language_">this</span>.<span class="property">_intervals</span>.<span class="title function_">indexOf</span>(interval)</span><br><span class="line">    <span class="keyword">if</span> (index !== -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_intervals</span>.<span class="title function_">splice</span>(index, <span class="number">1</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">changed</span>.<span class="title function_">raiseEvent</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// contains - æ˜¯å¦åŒ…å«æŒ‡å®šæ—¶é—´</span></span><br><span class="line">  <span class="title function_">contains</span>(<span class="params">julianDate</span>) &#123;</span><br><span class="line">    <span class="comment">// julianDate: JulianDate - è¦æ£€æŸ¥çš„æ—¶é—´</span></span><br><span class="line">    <span class="comment">// è¿”å›: boolean</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_intervals</span>.<span class="title function_">some</span>(<span class="function">(<span class="params">interval</span>) =&gt;</span> interval.<span class="title function_">contains</span>(julianDate))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// findInterval - æŸ¥æ‰¾åŒ…å«æŒ‡å®šæ—¶é—´çš„é—´éš”</span></span><br><span class="line">  <span class="title function_">findInterval</span>(<span class="params">julianDate</span>) &#123;</span><br><span class="line">    <span class="comment">// julianDate: JulianDate - è¦æŸ¥æ‰¾çš„æ—¶é—´</span></span><br><span class="line">    <span class="comment">// è¿”å›: TimeInterval | undefined</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_intervals</span>.<span class="title function_">find</span>(<span class="function">(<span class="params">interval</span>) =&gt;</span> interval.<span class="title function_">contains</span>(julianDate))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// findDataForIntervalContainingDate - æŸ¥æ‰¾åŒ…å«æŒ‡å®šæ—¶é—´çš„é—´éš”æ•°æ®</span></span><br><span class="line">  <span class="title function_">findDataForIntervalContainingDate</span>(<span class="params">julianDate</span>) &#123;</span><br><span class="line">    <span class="comment">// julianDate: JulianDate - è¦æŸ¥æ‰¾çš„æ—¶é—´</span></span><br><span class="line">    <span class="comment">// è¿”å›: Object | undefined</span></span><br><span class="line">    <span class="keyword">const</span> interval = <span class="variable language_">this</span>.<span class="title function_">findInterval</span>(julianDate)</span><br><span class="line">    <span class="keyword">return</span> interval ? interval.<span class="property">data</span> : <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// get - è·å–æŒ‡å®šç´¢å¼•çš„é—´éš”</span></span><br><span class="line">  <span class="title function_">get</span>(<span class="params">index</span>) &#123;</span><br><span class="line">    <span class="comment">// index: number - ç´¢å¼•</span></span><br><span class="line">    <span class="comment">// è¿”å›: TimeInterval</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_intervals</span>[index]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// removeAll - ç§»é™¤æ‰€æœ‰é—´éš”</span></span><br><span class="line">  <span class="title function_">removeAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_intervals</span>.<span class="property">length</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">changed</span>.<span class="title function_">raiseEvent</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// intersect - æ±‚ä¸å¦ä¸€ä¸ªé›†åˆçš„äº¤é›†</span></span><br><span class="line">  <span class="title function_">intersect</span>(<span class="params">other, dataComparer, mergeCallback</span>) &#123;</span><br><span class="line">    <span class="comment">// other: TimeIntervalCollection - å¦ä¸€ä¸ªé›†åˆ</span></span><br><span class="line">    <span class="comment">// dataComparer: function - æ•°æ®æ¯”è¾ƒå‡½æ•°</span></span><br><span class="line">    <span class="comment">// mergeCallback: function - åˆå¹¶å›è°ƒ</span></span><br><span class="line">    <span class="comment">// è¿”å›: TimeIntervalCollection</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ—¶é—´ç³»ç»Ÿä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. åŸºç¡€æ—¶é—´æ“ä½œ</span></span><br><span class="line"><span class="keyword">const</span> now = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">now</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å½“å‰æ—¶é—´:&#x27;</span>, <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">toDate</span>(now))</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»ä¸åŒæ ¼å¼åˆ›å»ºæ—¶é—´</span></span><br><span class="line"><span class="keyword">const</span> fromDate = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&#x27;2023-01-01T12:00:00Z&#x27;</span>))</span><br><span class="line"><span class="keyword">const</span> fromIso = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(<span class="string">&#x27;2023-01-01T12:00:00Z&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> fromComponents = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>(<span class="number">2459945</span>, <span class="number">43200</span>) <span class="comment">// 2023-01-01 12:00:00 UTC</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ—¶é—´è¿ç®—</span></span><br><span class="line"><span class="keyword">const</span> futureTime = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addHours</span>(now, <span class="number">24</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>())</span><br><span class="line"><span class="keyword">const</span> pastTime = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addDays</span>(now, -<span class="number">7</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>())</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ—¶é—´å·®è®¡ç®—</span></span><br><span class="line"><span class="keyword">const</span> secondsDiff = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">secondsDifference</span>(futureTime, now)</span><br><span class="line"><span class="keyword">const</span> daysDiff = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">daysDifference</span>(futureTime, now)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`æœªæ¥æ—¶é—´ç›¸å·® <span class="subst">$&#123;secondsDiff&#125;</span> ç§’ï¼Œ<span class="subst">$&#123;daysDiff&#125;</span> å¤©`</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ—¶é—´æ¯”è¾ƒ</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">compare</span>(futureTime, now) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;futureTime åœ¨ now ä¹‹å&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. æ—¶é—´é—´éš”æ“ä½œ</span></span><br><span class="line"><span class="keyword">const</span> interval1 = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeInterval</span>(&#123;</span><br><span class="line">  <span class="attr">start</span>: <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(<span class="string">&#x27;2023-01-01T00:00:00Z&#x27;</span>),</span><br><span class="line">  <span class="attr">stop</span>: <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(<span class="string">&#x27;2023-01-01T12:00:00Z&#x27;</span>),</span><br><span class="line">  <span class="attr">data</span>: &#123; <span class="attr">period</span>: <span class="string">&#x27;ä¸Šåˆ&#x27;</span> &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> interval2 = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeInterval</span>(&#123;</span><br><span class="line">  <span class="attr">start</span>: <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(<span class="string">&#x27;2023-01-01T12:00:00Z&#x27;</span>),</span><br><span class="line">  <span class="attr">stop</span>: <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(<span class="string">&#x27;2023-01-02T00:00:00Z&#x27;</span>),</span><br><span class="line">  <span class="attr">data</span>: &#123; <span class="attr">period</span>: <span class="string">&#x27;ä¸‹åˆ&#x27;</span> &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥æ—¶é—´æ˜¯å¦åœ¨é—´éš”å†…</span></span><br><span class="line"><span class="keyword">const</span> testTime = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(<span class="string">&#x27;2023-01-01T10:00:00Z&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æµ‹è¯•æ—¶é—´åœ¨interval1å†…:&#x27;</span>, interval1.<span class="title function_">contains</span>(testTime))</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ±‚äº¤é›†</span></span><br><span class="line"><span class="keyword">const</span> intersection = <span class="title class_">Cesium</span>.<span class="property">TimeInterval</span>.<span class="title function_">intersect</span>(interval1, interval2, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeInterval</span>())</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;äº¤é›†æ˜¯å¦ä¸ºç©º:&#x27;</span>, intersection.<span class="property">isEmpty</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. æ—¶é—´é—´éš”é›†åˆ</span></span><br><span class="line"><span class="keyword">const</span> collection = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeIntervalCollection</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ å¤šä¸ªé—´éš”</span></span><br><span class="line">collection.<span class="title function_">addInterval</span>(interval1)</span><br><span class="line">collection.<span class="title function_">addInterval</span>(interval2)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ æ›´å¤šé—´éš”ï¼ˆæ¨¡æ‹Ÿä¸€å¤©çš„æ—¶é—´æ®µï¼‰</span></span><br><span class="line"><span class="keyword">const</span> hourlyIntervals = []</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> hour = <span class="number">0</span>; hour &lt; <span class="number">24</span>; hour++) &#123;</span><br><span class="line">  <span class="keyword">const</span> startTime = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(</span><br><span class="line">    <span class="string">`2023-01-01T<span class="subst">$&#123;hour.toString().padStart(<span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>)&#125;</span>:00:00Z`</span>,</span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">const</span> stopTime = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addHours</span>(startTime, <span class="number">1</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>())</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> interval = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeInterval</span>(&#123;</span><br><span class="line">    <span class="attr">start</span>: startTime,</span><br><span class="line">    <span class="attr">stop</span>: stopTime,</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">      <span class="attr">hour</span>: hour,</span><br><span class="line">      <span class="attr">period</span>: hour &lt; <span class="number">6</span> ? <span class="string">&#x27;å‡Œæ™¨&#x27;</span> : hour &lt; <span class="number">12</span> ? <span class="string">&#x27;ä¸Šåˆ&#x27;</span> : hour &lt; <span class="number">18</span> ? <span class="string">&#x27;ä¸‹åˆ&#x27;</span> : <span class="string">&#x27;æ™šä¸Š&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  collection.<span class="title function_">addInterval</span>(interval)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŸ¥æ‰¾ç‰¹å®šæ—¶é—´çš„æ•°æ®</span></span><br><span class="line"><span class="keyword">const</span> queryTime = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(<span class="string">&#x27;2023-01-01T15:30:00Z&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> intervalData = collection.<span class="title function_">findDataForIntervalContainingDate</span>(queryTime)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;15:30çš„æ—¶é—´æ®µæ•°æ®:&#x27;</span>, intervalData)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘å¬é›†åˆå˜åŒ–</span></span><br><span class="line">collection.<span class="property">changed</span>.<span class="title function_">addEventListener</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ—¶é—´é—´éš”é›†åˆå‘ç”Ÿå˜åŒ–ï¼Œå½“å‰åŒ…å«&#x27;</span>, collection.<span class="property">length</span>, <span class="string">&#x27;ä¸ªé—´éš”&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. å®ä½“å¯ç”¨æ€§æ—¶é—´</span></span><br><span class="line"><span class="keyword">const</span> entity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;é™æ—¶æ˜¾ç¤ºçš„å®ä½“&#x27;</span>,</span><br><span class="line">  <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">0</span>),</span><br><span class="line">  <span class="attr">point</span>: &#123;</span><br><span class="line">    <span class="attr">pixelSize</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// è®¾ç½®å¯ç”¨æ€§æ—¶é—´</span></span><br><span class="line">  <span class="attr">availability</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeIntervalCollection</span>([</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeInterval</span>(&#123;</span><br><span class="line">      <span class="attr">start</span>: <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(<span class="string">&#x27;2023-01-01T08:00:00Z&#x27;</span>),</span><br><span class="line">      <span class="attr">stop</span>: <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(<span class="string">&#x27;2023-01-01T18:00:00Z&#x27;</span>),</span><br><span class="line">    &#125;),</span><br><span class="line">  ]),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. æ—¶é’Ÿæ§åˆ¶</span></span><br><span class="line"><span class="keyword">const</span> clock = viewer.<span class="property">clock</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®æ—¶é—´èŒƒå›´</span></span><br><span class="line">clock.<span class="property">startTime</span> = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(<span class="string">&#x27;2023-01-01T00:00:00Z&#x27;</span>)</span><br><span class="line">clock.<span class="property">stopTime</span> = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(<span class="string">&#x27;2023-01-02T00:00:00Z&#x27;</span>)</span><br><span class="line">clock.<span class="property">currentTime</span> = clock.<span class="property">startTime</span>.<span class="title function_">clone</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ—¶é—´æ§åˆ¶</span></span><br><span class="line">clock.<span class="property">multiplier</span> = <span class="number">3600</span> <span class="comment">// 1ç§’ä»£è¡¨1å°æ—¶</span></span><br><span class="line">clock.<span class="property">clockRange</span> = <span class="title class_">Cesium</span>.<span class="property">ClockRange</span>.<span class="property">LOOP_STOP</span> <span class="comment">// å¾ªç¯æ’­æ”¾</span></span><br><span class="line">clock.<span class="property">shouldAnimate</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘å¬æ—¶é’Ÿäº‹ä»¶</span></span><br><span class="line">clock.<span class="property">onTick</span>.<span class="title function_">addEventListener</span>(<span class="function">(<span class="params">clock</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> currentHour = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">toDate</span>(clock.<span class="property">currentTime</span>).<span class="title function_">getHours</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ¹æ®æ—¶é—´æ”¹å˜åœºæ™¯</span></span><br><span class="line">  <span class="keyword">if</span> (currentHour &gt;= <span class="number">6</span> &amp;&amp; currentHour &lt; <span class="number">18</span>) &#123;</span><br><span class="line">    <span class="comment">// ç™½å¤©</span></span><br><span class="line">    viewer.<span class="property">scene</span>.<span class="property">skyAtmosphere</span>.<span class="property">show</span> = <span class="literal">true</span></span><br><span class="line">    viewer.<span class="property">scene</span>.<span class="property">sun</span>.<span class="property">show</span> = <span class="literal">true</span></span><br><span class="line">    viewer.<span class="property">scene</span>.<span class="property">moon</span>.<span class="property">show</span> = <span class="literal">false</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å¤œæ™š</span></span><br><span class="line">    viewer.<span class="property">scene</span>.<span class="property">skyAtmosphere</span>.<span class="property">show</span> = <span class="literal">false</span></span><br><span class="line">    viewer.<span class="property">scene</span>.<span class="property">sun</span>.<span class="property">show</span> = <span class="literal">false</span></span><br><span class="line">    viewer.<span class="property">scene</span>.<span class="property">moon</span>.<span class="property">show</span> = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. æ—¶é—´ç›¸å…³çš„å±æ€§åŠ¨ç”»</span></span><br><span class="line"><span class="keyword">const</span> timeBasedPosition = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">CallbackProperty</span>(<span class="function">(<span class="params">time</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> secondsIntoDay = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">secondsOfDay</span>(time)</span><br><span class="line">  <span class="keyword">const</span> angle = (secondsIntoDay / <span class="number">86400</span>) * <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="property">TWO_PI</span> <span class="comment">// ä¸€å¤©è½¬ä¸€åœˆ</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> radius = <span class="number">1000</span></span><br><span class="line">  <span class="keyword">const</span> x = radius * <span class="title class_">Math</span>.<span class="title function_">cos</span>(angle)</span><br><span class="line">  <span class="keyword">const</span> y = radius * <span class="title class_">Math</span>.<span class="title function_">sin</span>(angle)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(</span><br><span class="line">    <span class="number">116.4074</span> + x / <span class="number">111320</span>, <span class="comment">// è½¬æ¢ä¸ºç»åº¦åç§»</span></span><br><span class="line">    <span class="number">39.9042</span> + y / <span class="number">110540</span>, <span class="comment">// è½¬æ¢ä¸ºçº¬åº¦åç§»</span></span><br><span class="line">    <span class="number">100</span>,</span><br><span class="line">  )</span><br><span class="line">&#125;, <span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> orbitingEntity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: timeBasedPosition,</span><br><span class="line">  <span class="attr">point</span>: &#123;</span><br><span class="line">    <span class="attr">pixelSize</span>: <span class="number">8</span>,</span><br><span class="line">    <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">LIME</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">path</span>: &#123;</span><br><span class="line">    <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">leadTime</span>: <span class="number">3600</span>, <span class="comment">// æ˜¾ç¤ºæœªæ¥1å°æ—¶çš„è½¨è¿¹</span></span><br><span class="line">    <span class="attr">trailTime</span>: <span class="number">3600</span>, <span class="comment">// æ˜¾ç¤ºè¿‡å»1å°æ—¶çš„è½¨è¿¹</span></span><br><span class="line">    <span class="attr">width</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">material</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">LIME</span>,</span><br><span class="line">    <span class="attr">resolution</span>: <span class="number">60</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 7. æ—¶åŒºè½¬æ¢</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">convertToLocalTime</span>(<span class="params">julianDate, timezoneOffset</span>) &#123;</span><br><span class="line">  <span class="comment">// timezoneOffset: æ—¶åŒºåç§»ï¼ˆå°æ—¶ï¼‰</span></span><br><span class="line">  <span class="keyword">const</span> offsetSeconds = timezoneOffset * <span class="number">3600</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addSeconds</span>(julianDate, offsetSeconds, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´ï¼ˆUTC+8ï¼‰</span></span><br><span class="line"><span class="keyword">const</span> utcTime = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">now</span>()</span><br><span class="line"><span class="keyword">const</span> beijingTime = <span class="title function_">convertToLocalTime</span>(utcTime, <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;UTCæ—¶é—´:&#x27;</span>, <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">toDate</span>(utcTime))</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;åŒ—äº¬æ—¶é—´:&#x27;</span>, <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">toDate</span>(beijingTime))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 8. æ€§èƒ½æ—¶é—´æµ‹é‡</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">measurePerformance</span>(<span class="params">fn, name</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> start = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">now</span>()</span><br><span class="line"></span><br><span class="line">  <span class="title function_">fn</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> end = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">now</span>()</span><br><span class="line">  <span class="keyword">const</span> elapsed = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">secondsDifference</span>(end, start)</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;name&#125;</span> æ‰§è¡Œæ—¶é—´: <span class="subst">$&#123;elapsed * <span class="number">1000</span>&#125;</span> æ¯«ç§’`</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="title function_">measurePerformance</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// ä¸€äº›è®¡ç®—å¯†é›†çš„æ“ä½œ</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">    <span class="title class_">Math</span>.<span class="title function_">sqrt</span>(i)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="string">&#x27;æ•°å­¦è®¡ç®—&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="ç»˜åˆ¶åŠŸèƒ½è¯¦è§£"><a href="#ç»˜åˆ¶åŠŸèƒ½è¯¦è§£" class="headerlink" title="ç»˜åˆ¶åŠŸèƒ½è¯¦è§£"></a>ç»˜åˆ¶åŠŸèƒ½è¯¦è§£</h2><h3 id="ç»˜åˆ¶å·¥å…·åŸºç±»"><a href="#ç»˜åˆ¶å·¥å…·åŸºç±»" class="headerlink" title="ç»˜åˆ¶å·¥å…·åŸºç±»"></a>ç»˜åˆ¶å·¥å…·åŸºç±»</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cesiumç»˜åˆ¶å·¥å…·åŸºç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CesiumDrawTool</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">viewer, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span> = viewer</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = viewer.<span class="property">scene</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span> = viewer.<span class="property">camera</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span> = viewer.<span class="property">canvas</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// type: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç»˜åˆ¶ç±»å‹</span></span><br><span class="line">    <span class="comment">// é€‰é¡¹: &#x27;point&#x27;, &#x27;polyline&#x27;, &#x27;polygon&#x27;, &#x27;rectangle&#x27;, &#x27;circle&#x27;, &#x27;billboard&#x27;, &#x27;model&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">type</span> = options.<span class="property">type</span> || <span class="string">&#x27;point&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// style: Object</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç»˜åˆ¶æ ·å¼é…ç½®</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = options.<span class="property">style</span> || &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clampToGround: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦è´´åœ°</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clampToGround</span> = options.<span class="property">clampToGround</span> !== <span class="literal">undefined</span> ? options.<span class="property">clampToGround</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// enableEdit: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç»˜åˆ¶å®Œæˆåæ˜¯å¦å¯ç¼–è¾‘</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">enableEdit</span> = options.<span class="property">enableEdit</span> !== <span class="literal">undefined</span> ? options.<span class="property">enableEdit</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// heightOffset: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é«˜åº¦åç§»é‡ï¼ˆç±³ï¼‰</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">heightOffset</span> = options.<span class="property">heightOffset</span> || <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isActive</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">positions</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">activeEntity</span> = <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tempEntities</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handler</span> = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¿€æ´»ç»˜åˆ¶å·¥å…·</span></span><br><span class="line">  <span class="title function_">activate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isActive</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isActive</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">positions</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">clearTempEntities</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºäº‹ä»¶å¤„ç†å™¨</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handler</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ScreenSpaceEventHandler</span>(<span class="variable language_">this</span>.<span class="property">canvas</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»‘å®šäº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">bindEvents</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ”¹å˜é¼ æ ‡æ ·å¼</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">style</span>.<span class="property">cursor</span> = <span class="string">&#x27;crosshair&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§¦å‘æ¿€æ´»äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">onActivate</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœç”¨ç»˜åˆ¶å·¥å…·</span></span><br><span class="line">  <span class="title function_">deactivate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">isActive</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isActive</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£ç»‘äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">unbindEvents</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç†ä¸´æ—¶å®ä½“</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">clearTempEntities</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¢å¤é¼ æ ‡æ ·å¼</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">style</span>.<span class="property">cursor</span> = <span class="string">&#x27;default&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§¦å‘åœç”¨äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">onDeactivate</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç»‘å®šé¼ æ ‡äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">bindEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// å·¦é”®ç‚¹å‡»</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handler</span>.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">click</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> position = <span class="variable language_">this</span>.<span class="title function_">pickPosition</span>(click.<span class="property">position</span>)</span><br><span class="line">      <span class="keyword">if</span> (position) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">handleClick</span>(position)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">LEFT_CLICK</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é¼ æ ‡ç§»åŠ¨</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handler</span>.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">movement</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> position = <span class="variable language_">this</span>.<span class="title function_">pickPosition</span>(movement.<span class="property">endPosition</span>)</span><br><span class="line">      <span class="keyword">if</span> (position) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">handleMouseMove</span>(position)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">MOUSE_MOVE</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å³é”®å®Œæˆ</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handler</span>.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">click</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">finishDrawing</span>()</span><br><span class="line">    &#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">RIGHT_CLICK</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒå‡»å®Œæˆ</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handler</span>.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">click</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">finishDrawing</span>()</span><br><span class="line">    &#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">LEFT_DOUBLE_CLICK</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£ç»‘äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">unbindEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">handler</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">handler</span>.<span class="title function_">destroy</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">handler</span> = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ‹¾å–ä½ç½®</span></span><br><span class="line">  <span class="title function_">pickPosition</span>(<span class="params">windowPosition</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> pickedPosition</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">clampToGround</span>) &#123;</span><br><span class="line">      <span class="comment">// è´´åœ°æ¨¡å¼ - æ‹¾å–åœ°å½¢</span></span><br><span class="line">      <span class="keyword">const</span> ray = <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">getPickRay</span>(windowPosition)</span><br><span class="line">      pickedPosition = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">globe</span>.<span class="title function_">pick</span>(ray, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// ç©ºé—´æ¨¡å¼ - æ‹¾å–æ¤­çƒé¢</span></span><br><span class="line">      pickedPosition = <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">pickEllipsoid</span>(windowPosition, <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">globe</span>.<span class="property">ellipsoid</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pickedPosition) &#123;</span><br><span class="line">      <span class="comment">// æ·»åŠ é«˜åº¦åç§»</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">heightOffset</span> !== <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> cartographic = <span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromCartesian</span>(pickedPosition)</span><br><span class="line">        cartographic.<span class="property">height</span> += <span class="variable language_">this</span>.<span class="property">heightOffset</span></span><br><span class="line">        pickedPosition = <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromRadians</span>(</span><br><span class="line">          cartographic.<span class="property">longitude</span>,</span><br><span class="line">          cartographic.<span class="property">latitude</span>,</span><br><span class="line">          cartographic.<span class="property">height</span>,</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pickedPosition</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤„ç†ç‚¹å‡»äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">handleClick</span>(<span class="params">position</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">positions</span>.<span class="title function_">push</span>(position)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">updateDrawing</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦æ»¡è¶³å®Œæˆæ¡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">shouldFinish</span>()) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">finishDrawing</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤„ç†é¼ æ ‡ç§»åŠ¨</span></span><br><span class="line">  <span class="title function_">handleMouseMove</span>(<span class="params">position</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">positions</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">updatePreview</span>(position)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ›´æ–°ç»˜åˆ¶çŠ¶æ€</span></span><br><span class="line">  <span class="title function_">updateDrawing</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// å­ç±»å®ç°</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ›´æ–°é¢„è§ˆ</span></span><br><span class="line">  <span class="title function_">updatePreview</span>(<span class="params">position</span>) &#123;</span><br><span class="line">    <span class="comment">// å­ç±»å®ç°</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ˜¯å¦åº”è¯¥å®Œæˆç»˜åˆ¶</span></span><br><span class="line">  <span class="title function_">shouldFinish</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable language_">this</span>.<span class="property">type</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;point&#x27;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;billboard&#x27;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;model&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">positions</span>.<span class="property">length</span> &gt;= <span class="number">1</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;polyline&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">positions</span>.<span class="property">length</span> &gt;= <span class="number">2</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;polygon&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">positions</span>.<span class="property">length</span> &gt;= <span class="number">3</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;rectangle&#x27;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;circle&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">positions</span>.<span class="property">length</span> &gt;= <span class="number">2</span></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å®Œæˆç»˜åˆ¶</span></span><br><span class="line">  <span class="title function_">finishDrawing</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">positions</span>.<span class="property">length</span> &lt; <span class="variable language_">this</span>.<span class="title function_">getMinPointCount</span>()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºæœ€ç»ˆå®ä½“</span></span><br><span class="line">    <span class="keyword">const</span> entity = <span class="variable language_">this</span>.<span class="title function_">createFinalEntity</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç†ä¸´æ—¶å®ä½“</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">clearTempEntities</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœç”¨å·¥å…·</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">deactivate</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§¦å‘å®Œæˆäº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">onComplete</span>(entity)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> entity</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–æœ€å°ç‚¹æ•°</span></span><br><span class="line">  <span class="title function_">getMinPointCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable language_">this</span>.<span class="property">type</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;point&#x27;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;billboard&#x27;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;model&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;polyline&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;polygon&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;rectangle&#x27;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;circle&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºæœ€ç»ˆå®ä½“ï¼ˆå­ç±»å®ç°ï¼‰</span></span><br><span class="line">  <span class="title function_">createFinalEntity</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¸…ç†ä¸´æ—¶å®ä½“</span></span><br><span class="line">  <span class="title function_">clearTempEntities</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tempEntities</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">entity</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">entities</span>.<span class="title function_">remove</span>(entity)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tempEntities</span> = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// äº‹ä»¶å›è°ƒ</span></span><br><span class="line">  <span class="title function_">onActivate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.type&#125;</span> ç»˜åˆ¶å·¥å…·å·²æ¿€æ´»`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onDeactivate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.type&#125;</span> ç»˜åˆ¶å·¥å…·å·²åœç”¨`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onComplete</span>(<span class="params">entity</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.type&#125;</span> ç»˜åˆ¶å®Œæˆ:`</span>, entity)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç‚¹ç»˜åˆ¶å·¥å…·</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PointDrawTool</span> <span class="keyword">extends</span> <span class="title class_ inherited__">CesiumDrawTool</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">viewer, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(viewer, &#123; ...options, <span class="attr">type</span>: <span class="string">&#x27;point&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é»˜è®¤ç‚¹æ ·å¼</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// pixelSize: number - ç‚¹çš„åƒç´ å¤§å°</span></span><br><span class="line">        <span class="attr">pixelSize</span>: <span class="number">10</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// color: Cesium.Color - ç‚¹çš„é¢œè‰²</span></span><br><span class="line">        <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outlineColor: Cesium.Color - è½®å»“é¢œè‰²</span></span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outlineWidth: number - è½®å»“å®½åº¦</span></span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// heightReference: Cesium.HeightReference - é«˜åº¦å‚è€ƒ</span></span><br><span class="line">        <span class="attr">heightReference</span>: <span class="variable language_">this</span>.<span class="property">clampToGround</span></span><br><span class="line">          ? <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">CLAMP_TO_GROUND</span></span><br><span class="line">          : <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">NONE</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// disableDepthTestDistance: number - ç¦ç”¨æ·±åº¦æµ‹è¯•è·ç¦»</span></span><br><span class="line">        <span class="attr">disableDepthTestDistance</span>: <span class="title class_">Number</span>.<span class="property">POSITIVE_INFINITY</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// scaleByDistance: Cesium.NearFarScalar - åŸºäºè·ç¦»çš„ç¼©æ”¾</span></span><br><span class="line">        <span class="attr">scaleByDistance</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// distanceDisplayCondition: Cesium.DistanceDisplayCondition - è·ç¦»æ˜¾ç¤ºæ¡ä»¶</span></span><br><span class="line">        <span class="attr">distanceDisplayCondition</span>: <span class="literal">undefined</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createFinalEntity</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> entity = <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;DrawPoint&#x27;</span>,</span><br><span class="line">      <span class="attr">position</span>: <span class="variable language_">this</span>.<span class="property">positions</span>[<span class="number">0</span>],</span><br><span class="line">      <span class="attr">point</span>: &#123;</span><br><span class="line">        <span class="attr">pixelSize</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">pixelSize</span>,</span><br><span class="line">        <span class="attr">color</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">color</span>,</span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">outlineColor</span>,</span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">outlineWidth</span>,</span><br><span class="line">        <span class="attr">heightReference</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">heightReference</span>,</span><br><span class="line">        <span class="attr">disableDepthTestDistance</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">disableDepthTestDistance</span>,</span><br><span class="line">        <span class="attr">scaleByDistance</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">scaleByDistance</span>,</span><br><span class="line">        <span class="attr">distanceDisplayCondition</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">distanceDisplayCondition</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> entity</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç»˜åˆ¶å·¥å…·</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PolylineDrawTool</span> <span class="keyword">extends</span> <span class="title class_ inherited__">CesiumDrawTool</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">viewer, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(viewer, &#123; ...options, <span class="attr">type</span>: <span class="string">&#x27;polyline&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// width: number - çº¿å®½</span></span><br><span class="line">        <span class="attr">width</span>: <span class="number">3</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// material: Cesium.MaterialProperty - æè´¨</span></span><br><span class="line">        <span class="attr">material</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// clampToGround: boolean - æ˜¯å¦è´´åœ°</span></span><br><span class="line">        <span class="attr">clampToGround</span>: <span class="variable language_">this</span>.<span class="property">clampToGround</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// classificationType: Cesium.ClassificationType - åˆ†ç±»ç±»å‹</span></span><br><span class="line">        <span class="attr">classificationType</span>: <span class="variable language_">this</span>.<span class="property">clampToGround</span> ? <span class="title class_">Cesium</span>.<span class="property">ClassificationType</span>.<span class="property">TERRAIN</span> : <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// shadows: Cesium.ShadowMode - é˜´å½±æ¨¡å¼</span></span><br><span class="line">        <span class="attr">shadows</span>: <span class="title class_">Cesium</span>.<span class="property">ShadowMode</span>.<span class="property">DISABLED</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// distanceDisplayCondition: Cesium.DistanceDisplayCondition</span></span><br><span class="line">        <span class="attr">distanceDisplayCondition</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// zIndex: number - å±‚çº§ï¼ˆè´´åœ°æ—¶æœ‰æ•ˆï¼‰</span></span><br><span class="line">        <span class="attr">zIndex</span>: <span class="number">0</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">updateDrawing</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">positions</span>.<span class="property">length</span> &lt; <span class="number">2</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç§»é™¤ä¹‹å‰çš„ä¸´æ—¶çº¿</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">clearTempEntities</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸´æ—¶çº¿</span></span><br><span class="line">    <span class="keyword">const</span> tempEntity = <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;TempPolyline&#x27;</span>,</span><br><span class="line">      <span class="attr">polyline</span>: &#123;</span><br><span class="line">        <span class="attr">positions</span>: <span class="variable language_">this</span>.<span class="property">positions</span>,</span><br><span class="line">        <span class="attr">width</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">width</span>,</span><br><span class="line">        <span class="attr">material</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">material</span>,</span><br><span class="line">        <span class="attr">clampToGround</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">clampToGround</span>,</span><br><span class="line">        <span class="attr">classificationType</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">classificationType</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tempEntities</span>.<span class="title function_">push</span>(tempEntity)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">updatePreview</span>(<span class="params">position</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">positions</span>.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºé¢„è§ˆä½ç½®æ•°ç»„</span></span><br><span class="line">    <span class="keyword">const</span> previewPositions = [...<span class="variable language_">this</span>.<span class="property">positions</span>, position]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ›´æ–°ä¸´æ—¶çº¿çš„ä½ç½®</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">tempEntities</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">tempEntities</span>[<span class="number">0</span>].<span class="property">polyline</span>.<span class="property">positions</span> = previewPositions</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createFinalEntity</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> entity = <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;DrawPolyline&#x27;</span>,</span><br><span class="line">      <span class="attr">polyline</span>: &#123;</span><br><span class="line">        <span class="attr">positions</span>: <span class="variable language_">this</span>.<span class="property">positions</span>,</span><br><span class="line">        <span class="attr">width</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">width</span>,</span><br><span class="line">        <span class="attr">material</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">material</span>,</span><br><span class="line">        <span class="attr">clampToGround</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">clampToGround</span>,</span><br><span class="line">        <span class="attr">classificationType</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">classificationType</span>,</span><br><span class="line">        <span class="attr">shadows</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">shadows</span>,</span><br><span class="line">        <span class="attr">distanceDisplayCondition</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">distanceDisplayCondition</span>,</span><br><span class="line">        <span class="attr">zIndex</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">zIndex</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> entity</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é¢ç»˜åˆ¶å·¥å…·</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PolygonDrawTool</span> <span class="keyword">extends</span> <span class="title class_ inherited__">CesiumDrawTool</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">viewer, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(viewer, &#123; ...options, <span class="attr">type</span>: <span class="string">&#x27;polygon&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// material: Cesium.MaterialProperty - å¡«å……æè´¨</span></span><br><span class="line">        <span class="attr">material</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>.<span class="title function_">withAlpha</span>(<span class="number">0.5</span>),</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outline: boolean - æ˜¯å¦æ˜¾ç¤ºè½®å»“</span></span><br><span class="line">        <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outlineColor: Cesium.Color - è½®å»“é¢œè‰²</span></span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outlineWidth: number - è½®å»“å®½åº¦</span></span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// height: number - é«˜åº¦</span></span><br><span class="line">        <span class="attr">height</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// extrudedHeight: number - æ‹‰ä¼¸é«˜åº¦</span></span><br><span class="line">        <span class="attr">extrudedHeight</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// heightReference: Cesium.HeightReference - é«˜åº¦å‚è€ƒ</span></span><br><span class="line">        <span class="attr">heightReference</span>: <span class="variable language_">this</span>.<span class="property">clampToGround</span></span><br><span class="line">          ? <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">CLAMP_TO_GROUND</span></span><br><span class="line">          : <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">NONE</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// extrudedHeightReference: Cesium.HeightReference - æ‹‰ä¼¸é«˜åº¦å‚è€ƒ</span></span><br><span class="line">        <span class="attr">extrudedHeightReference</span>: <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">NONE</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// fill: boolean - æ˜¯å¦å¡«å……</span></span><br><span class="line">        <span class="attr">fill</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// shadows: Cesium.ShadowMode - é˜´å½±æ¨¡å¼</span></span><br><span class="line">        <span class="attr">shadows</span>: <span class="title class_">Cesium</span>.<span class="property">ShadowMode</span>.<span class="property">DISABLED</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// distanceDisplayCondition: Cesium.DistanceDisplayCondition</span></span><br><span class="line">        <span class="attr">distanceDisplayCondition</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// classificationType: Cesium.ClassificationType - åˆ†ç±»ç±»å‹</span></span><br><span class="line">        <span class="attr">classificationType</span>: <span class="variable language_">this</span>.<span class="property">clampToGround</span> ? <span class="title class_">Cesium</span>.<span class="property">ClassificationType</span>.<span class="property">TERRAIN</span> : <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// zIndex: number - å±‚çº§</span></span><br><span class="line">        <span class="attr">zIndex</span>: <span class="number">0</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">updateDrawing</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">positions</span>.<span class="property">length</span> &lt; <span class="number">3</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">clearTempEntities</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> tempEntity = <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;TempPolygon&#x27;</span>,</span><br><span class="line">      <span class="attr">polygon</span>: &#123;</span><br><span class="line">        <span class="attr">hierarchy</span>: <span class="variable language_">this</span>.<span class="property">positions</span>,</span><br><span class="line">        <span class="attr">material</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">material</span>,</span><br><span class="line">        <span class="attr">outline</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">outline</span>,</span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">outlineColor</span>,</span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">outlineWidth</span>,</span><br><span class="line">        <span class="attr">height</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">height</span>,</span><br><span class="line">        <span class="attr">heightReference</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">heightReference</span>,</span><br><span class="line">        <span class="attr">fill</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">fill</span>,</span><br><span class="line">        <span class="attr">classificationType</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">classificationType</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tempEntities</span>.<span class="title function_">push</span>(tempEntity)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">updatePreview</span>(<span class="params">position</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">positions</span>.<span class="property">length</span> &lt; <span class="number">2</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> previewPositions = [...<span class="variable language_">this</span>.<span class="property">positions</span>, position]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">tempEntities</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">tempEntities</span>[<span class="number">0</span>].<span class="property">polygon</span>.<span class="property">hierarchy</span> = previewPositions</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createFinalEntity</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> entity = <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;DrawPolygon&#x27;</span>,</span><br><span class="line">      <span class="attr">polygon</span>: &#123;</span><br><span class="line">        <span class="attr">hierarchy</span>: <span class="variable language_">this</span>.<span class="property">positions</span>,</span><br><span class="line">        <span class="attr">material</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">material</span>,</span><br><span class="line">        <span class="attr">outline</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">outline</span>,</span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">outlineColor</span>,</span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">outlineWidth</span>,</span><br><span class="line">        <span class="attr">height</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">height</span>,</span><br><span class="line">        <span class="attr">extrudedHeight</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">extrudedHeight</span>,</span><br><span class="line">        <span class="attr">heightReference</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">heightReference</span>,</span><br><span class="line">        <span class="attr">extrudedHeightReference</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">extrudedHeightReference</span>,</span><br><span class="line">        <span class="attr">fill</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">fill</span>,</span><br><span class="line">        <span class="attr">shadows</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">shadows</span>,</span><br><span class="line">        <span class="attr">distanceDisplayCondition</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">distanceDisplayCondition</span>,</span><br><span class="line">        <span class="attr">classificationType</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">classificationType</span>,</span><br><span class="line">        <span class="attr">zIndex</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">zIndex</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> entity</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç»˜åˆ¶ç®¡ç†å™¨"><a href="#ç»˜åˆ¶ç®¡ç†å™¨" class="headerlink" title="ç»˜åˆ¶ç®¡ç†å™¨"></a>ç»˜åˆ¶ç®¡ç†å™¨</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cesiumç»˜åˆ¶ç®¡ç†å™¨</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CesiumDrawManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">viewer, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span> = viewer</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span> = options</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“å‰æ¿€æ´»çš„ç»˜åˆ¶å·¥å…·</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">activeTool</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»˜åˆ¶å·¥å…·å®ä¾‹</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tools</span> = &#123;</span><br><span class="line">      <span class="attr">point</span>: <span class="keyword">new</span> <span class="title class_">PointDrawTool</span>(viewer),</span><br><span class="line">      <span class="attr">polyline</span>: <span class="keyword">new</span> <span class="title class_">PolylineDrawTool</span>(viewer),</span><br><span class="line">      <span class="attr">polygon</span>: <span class="keyword">new</span> <span class="title class_">PolygonDrawTool</span>(viewer),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»˜åˆ¶ç»“æœå­˜å‚¨</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawResults</span> = []</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»‘å®šäº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">bindToolEvents</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç»‘å®šå·¥å…·äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">bindToolEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">values</span>(<span class="variable language_">this</span>.<span class="property">tools</span>).<span class="title function_">forEach</span>(<span class="function">(<span class="params">tool</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// é‡å†™å®Œæˆäº‹ä»¶</span></span><br><span class="line">      <span class="keyword">const</span> originalOnComplete = tool.<span class="property">onComplete</span>.<span class="title function_">bind</span>(tool)</span><br><span class="line">      tool.<span class="property">onComplete</span> = <span class="function">(<span class="params">entity</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">originalOnComplete</span>(entity)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">onDrawComplete</span>(entity, tool.<span class="property">type</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¼€å§‹ç»˜åˆ¶</span></span><br><span class="line">  <span class="title function_">startDraw</span>(<span class="params">type, style = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// åœæ­¢å½“å‰ç»˜åˆ¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">stopDraw</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥å·¥å…·ç±»å‹</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">tools</span>[type]) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;ä¸æ”¯æŒçš„ç»˜åˆ¶ç±»å‹:&#x27;</span>, type)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ›´æ–°å·¥å…·æ ·å¼</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Object</span>.<span class="title function_">keys</span>(style).<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="variable language_">this</span>.<span class="property">tools</span>[type].<span class="property">style</span>, style)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¿€æ´»å·¥å…·</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">activeTool</span> = <span class="variable language_">this</span>.<span class="property">tools</span>[type]</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">activeTool</span>.<span class="title function_">activate</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`å¼€å§‹ç»˜åˆ¶ <span class="subst">$&#123;type&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœæ­¢ç»˜åˆ¶</span></span><br><span class="line">  <span class="title function_">stopDraw</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">activeTool</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">activeTool</span>.<span class="title function_">deactivate</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">activeTool</span> = <span class="literal">null</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;åœæ­¢ç»˜åˆ¶&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç»˜åˆ¶å®Œæˆå¤„ç†</span></span><br><span class="line">  <span class="title function_">onDrawComplete</span>(<span class="params">entity, type</span>) &#123;</span><br><span class="line">    <span class="comment">// æ·»åŠ åˆ°ç»“æœæ•°ç»„</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawResults</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">      <span class="attr">entity</span>: entity,</span><br><span class="line">      <span class="attr">type</span>: type,</span><br><span class="line">      <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">      <span class="attr">id</span>: entity.<span class="property">id</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;type&#125;</span> ç»˜åˆ¶å®Œæˆ`</span>, entity)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¸…ç©ºæ‰€æœ‰ç»˜åˆ¶</span></span><br><span class="line">  <span class="title function_">clearAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawResults</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">entities</span>.<span class="title function_">remove</span>(result.<span class="property">entity</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawResults</span> = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ’¤é”€ä¸Šä¸€æ­¥ç»˜åˆ¶</span></span><br><span class="line">  <span class="title function_">undo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">drawResults</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> lastResult = <span class="variable language_">this</span>.<span class="property">drawResults</span>.<span class="title function_">pop</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">entities</span>.<span class="title function_">remove</span>(lastResult.<span class="property">entity</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç»˜åˆ¶å·¥å…·æ "><a href="#ç»˜åˆ¶å·¥å…·æ " class="headerlink" title="ç»˜åˆ¶å·¥å…·æ "></a>ç»˜åˆ¶å·¥å…·æ </h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç»˜åˆ¶å·¥å…·æ æ§ä»¶</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DrawToolbar</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">viewer, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span> = viewer</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawManager</span> = <span class="keyword">new</span> <span class="title class_">CesiumDrawManager</span>(viewer, options)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å·¥å…·æ é…ç½®</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tools</span> = options.<span class="property">tools</span> || [</span><br><span class="line">      &#123; <span class="attr">type</span>: <span class="string">&#x27;point&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;ç‚¹&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;ğŸ“&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;ç»˜åˆ¶ç‚¹&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">type</span>: <span class="string">&#x27;polyline&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;çº¿&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;ğŸ“&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;ç»˜åˆ¶çº¿&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">type</span>: <span class="string">&#x27;polygon&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;é¢&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;ğŸ”²&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;ç»˜åˆ¶å¤šè¾¹å½¢&#x27;</span> &#125;,</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">container</span> = <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">activeToolType</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createToolbar</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºå·¥å…·æ </span></span><br><span class="line">  <span class="title function_">createToolbar</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºå®¹å™¨</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">container</span> = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">container</span>.<span class="property">className</span> = <span class="string">&#x27;cesium-draw-toolbar&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®æ ·å¼</span></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="variable language_">this</span>.<span class="property">container</span>.<span class="property">style</span>, &#123;</span><br><span class="line">      <span class="attr">position</span>: <span class="string">&#x27;absolute&#x27;</span>,</span><br><span class="line">      <span class="attr">top</span>: <span class="string">&#x27;10px&#x27;</span>,</span><br><span class="line">      <span class="attr">left</span>: <span class="string">&#x27;10px&#x27;</span>,</span><br><span class="line">      <span class="attr">zIndex</span>: <span class="string">&#x27;1000&#x27;</span>,</span><br><span class="line">      <span class="attr">backgroundColor</span>: <span class="string">&#x27;rgba(42, 42, 42, 0.9)&#x27;</span>,</span><br><span class="line">      <span class="attr">borderRadius</span>: <span class="string">&#x27;5px&#x27;</span>,</span><br><span class="line">      <span class="attr">padding</span>: <span class="string">&#x27;8px&#x27;</span>,</span><br><span class="line">      <span class="attr">display</span>: <span class="string">&#x27;flex&#x27;</span>,</span><br><span class="line">      <span class="attr">flexDirection</span>: <span class="string">&#x27;column&#x27;</span>,</span><br><span class="line">      <span class="attr">gap</span>: <span class="string">&#x27;4px&#x27;</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºå·¥å…·æŒ‰é’®</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createToolButtons</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºæ“ä½œæŒ‰é’®</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createActionButtons</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ åˆ°é¡µé¢</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="property">container</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºå·¥å…·æŒ‰é’®</span></span><br><span class="line">  <span class="title function_">createToolButtons</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tools</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">tool</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> button = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;button&#x27;</span>)</span><br><span class="line">      button.<span class="property">innerHTML</span> = <span class="string">`<span class="subst">$&#123;tool.icon&#125;</span> <span class="subst">$&#123;tool.name&#125;</span>`</span></span><br><span class="line">      button.<span class="property">title</span> = tool.<span class="property">title</span></span><br><span class="line"></span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">assign</span>(button.<span class="property">style</span>, &#123;</span><br><span class="line">        <span class="attr">padding</span>: <span class="string">&#x27;6px 12px&#x27;</span>,</span><br><span class="line">        <span class="attr">border</span>: <span class="string">&#x27;none&#x27;</span>,</span><br><span class="line">        <span class="attr">borderRadius</span>: <span class="string">&#x27;3px&#x27;</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;transparent&#x27;</span>,</span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">        <span class="attr">cursor</span>: <span class="string">&#x27;pointer&#x27;</span>,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      button.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">selectTool</span>(tool.<span class="property">type</span>, button)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">container</span>.<span class="title function_">appendChild</span>(button)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºæ“ä½œæŒ‰é’®</span></span><br><span class="line">  <span class="title function_">createActionButtons</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> actions = [</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">&#x27;åœæ­¢&#x27;</span>, <span class="attr">action</span>: <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">stopDraw</span>() &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">&#x27;æ’¤é”€&#x27;</span>, <span class="attr">action</span>: <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">drawManager</span>.<span class="title function_">undo</span>() &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">&#x27;æ¸…ç©º&#x27;</span>, <span class="attr">action</span>: <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">drawManager</span>.<span class="title function_">clearAll</span>() &#125;,</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    actions.<span class="title function_">forEach</span>(<span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> button = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;button&#x27;</span>)</span><br><span class="line">      button.<span class="property">innerHTML</span> = action.<span class="property">name</span></span><br><span class="line"></span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">assign</span>(button.<span class="property">style</span>, &#123;</span><br><span class="line">        <span class="attr">padding</span>: <span class="string">&#x27;4px 8px&#x27;</span>,</span><br><span class="line">        <span class="attr">border</span>: <span class="string">&#x27;none&#x27;</span>,</span><br><span class="line">        <span class="attr">borderRadius</span>: <span class="string">&#x27;3px&#x27;</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;transparent&#x27;</span>,</span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">        <span class="attr">cursor</span>: <span class="string">&#x27;pointer&#x27;</span>,</span><br><span class="line">        <span class="attr">fontSize</span>: <span class="string">&#x27;11px&#x27;</span>,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      button.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, action.<span class="property">action</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">container</span>.<span class="title function_">appendChild</span>(button)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é€‰æ‹©å·¥å…·</span></span><br><span class="line">  <span class="title function_">selectTool</span>(<span class="params">toolType, buttonElement</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">activeToolType</span> === toolType) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">stopDraw</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">activeToolType</span> = toolType</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawManager</span>.<span class="title function_">startDraw</span>(toolType)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœæ­¢ç»˜åˆ¶</span></span><br><span class="line">  <span class="title function_">stopDraw</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">activeToolType</span> = <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawManager</span>.<span class="title function_">stopDraw</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> viewer = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Viewer</span>(<span class="string">&#x27;cesiumContainer&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> drawToolbar = <span class="keyword">new</span> <span class="title class_">DrawToolbar</span>(viewer)</span><br></pre></td></tr></table></figure><h2 id="âš¡-æ€§èƒ½ä¼˜åŒ–è¯¦è§£"><a href="#âš¡-æ€§èƒ½ä¼˜åŒ–è¯¦è§£" class="headerlink" title="âš¡ æ€§èƒ½ä¼˜åŒ–è¯¦è§£"></a>âš¡ æ€§èƒ½ä¼˜åŒ–è¯¦è§£</h2><h3 id="ğŸ“‹-ç›®å½•-1"><a href="#ğŸ“‹-ç›®å½•-1" class="headerlink" title="ğŸ“‹ ç›®å½•"></a>ğŸ“‹ ç›®å½•</h3><ul><li><a href="#%E6%B8%B2%E6%9F%93%E4%BC%98%E5%8C%96">æ¸²æŸ“ä¼˜åŒ–</a></li><li><a href="#%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86">å†…å­˜ç®¡ç†</a></li><li><a href="#%E4%BA%8B%E4%BB%B6%E4%BC%98%E5%8C%96">äº‹ä»¶ä¼˜åŒ–</a></li><li><a href="#%E6%82%AC%E5%81%9C%E4%BA%8B%E4%BB%B6%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">æ‚¬åœäº‹ä»¶æ€§èƒ½ä¼˜åŒ–</a></li><li><a href="#%E5%BC%82%E6%AD%A5%E5%8A%A0%E8%BD%BD%E4%BC%98%E5%8C%96">å¼‚æ­¥åŠ è½½ä¼˜åŒ–</a></li><li><a href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93">æœ€ä½³å®è·µæ€»ç»“</a></li></ul><hr><h3 id="ğŸ¯-æ¸²æŸ“ä¼˜åŒ–"><a href="#ğŸ¯-æ¸²æŸ“ä¼˜åŒ–" class="headerlink" title="ğŸ¯ æ¸²æŸ“ä¼˜åŒ–"></a>ğŸ¯ æ¸²æŸ“ä¼˜åŒ–</h3><h4 id="1-æŒ‰éœ€æ¸²æŸ“-On-Demand-Rendering"><a href="#1-æŒ‰éœ€æ¸²æŸ“-On-Demand-Rendering" class="headerlink" title="1. æŒ‰éœ€æ¸²æŸ“ (On-Demand Rendering)"></a>1. æŒ‰éœ€æ¸²æŸ“ (On-Demand Rendering)</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯ç”¨æŒ‰éœ€æ¸²æŸ“æ¨¡å¼</span></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">requestRenderMode</span> = <span class="literal">true</span></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">maximumRenderTimeChange</span> = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰‹åŠ¨è§¦å‘æ¸²æŸ“å‡½æ•°</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">requestRenderIfNeeded</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (needsUpdate) &#123;</span><br><span class="line">    viewer.<span class="property">scene</span>.<span class="title function_">requestRender</span>()</span><br><span class="line">    needsUpdate = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘å¬æ•°æ®å˜åŒ–ï¼Œè‡ªåŠ¨è§¦å‘æ¸²æŸ“</span></span><br><span class="line">viewer.<span class="property">entities</span>.<span class="property">collectionChanged</span>.<span class="title function_">addEventListener</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  needsUpdate = <span class="literal">true</span></span><br><span class="line">  <span class="title function_">requestRenderIfNeeded</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="2-LOD-Level-of-Detail-ä¼˜åŒ–"><a href="#2-LOD-Level-of-Detail-ä¼˜åŒ–" class="headerlink" title="2. LOD (Level of Detail) ä¼˜åŒ–"></a>2. LOD (Level of Detail) ä¼˜åŒ–</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é™ä½åœ°å½¢ç»†èŠ‚ï¼Œæå‡æ€§èƒ½</span></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">globe</span>.<span class="property">maximumScreenSpaceError</span> = <span class="number">1</span></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">globe</span>.<span class="property">tileCacheSize</span> = <span class="number">200</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è§†é”¥å‰”é™¤ä¼˜åŒ–</span></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">globe</span>.<span class="property">showSkirts</span> = <span class="literal">false</span> <span class="comment">// ç¦ç”¨åœ°å½¢è£™è¾¹</span></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">fog</span>.<span class="property">enabled</span> = <span class="literal">true</span> <span class="comment">// å¯ç”¨é›¾æ•ˆéšè—è¿œå¤„ç»†èŠ‚</span></span><br></pre></td></tr></table></figure><h4 id="3-å®ä½“ä¼˜åŒ–-Entity-Optimization"><a href="#3-å®ä½“ä¼˜åŒ–-Entity-Optimization" class="headerlink" title="3. å®ä½“ä¼˜åŒ– (Entity Optimization)"></a>3. å®ä½“ä¼˜åŒ– (Entity Optimization)</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨ Primitive æ›¿ä»£å¤§é‡ Entityï¼Œæå‡æ€§èƒ½</span></span><br><span class="line"><span class="keyword">const</span> instances = []</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">  instances.<span class="title function_">push</span>(</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">GeometryInstance</span>(&#123;</span><br><span class="line">      <span class="attr">geometry</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">BoxGeometry</span>(&#123;</span><br><span class="line">        <span class="attr">dimensions</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">100</span>, <span class="number">100</span>, <span class="number">100</span>),</span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="attr">modelMatrix</span>: <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">multiplyByTranslation</span>(</span><br><span class="line">        <span class="title class_">Cesium</span>.<span class="property">Transforms</span>.<span class="title function_">eastNorthUpToFixedFrame</span>(</span><br><span class="line">          <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(</span><br><span class="line">            <span class="number">116.4074</span> + (<span class="title class_">Math</span>.<span class="title function_">random</span>() - <span class="number">0.5</span>) * <span class="number">0.1</span>,</span><br><span class="line">            <span class="number">39.9042</span> + (<span class="title class_">Math</span>.<span class="title function_">random</span>() - <span class="number">0.5</span>) * <span class="number">0.1</span>,</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">50</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Matrix4</span>(),</span><br><span class="line">      ),</span><br><span class="line">      <span class="attr">attributes</span>: &#123;</span><br><span class="line">        <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">ColorGeometryInstanceAttribute</span>.<span class="title function_">fromColor</span>(<span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="title function_">fromRandom</span>()),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;),</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> primitive = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Primitive</span>(&#123;</span><br><span class="line">  <span class="attr">geometryInstances</span>: instances,</span><br><span class="line">  <span class="attr">appearance</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PerInstanceColorAppearance</span>(&#123;</span><br><span class="line">    <span class="attr">translucent</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">closed</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">primitives</span>.<span class="title function_">add</span>(primitive)</span><br></pre></td></tr></table></figure><h4 id="4-èšç±»ä¼˜åŒ–-Clustering"><a href="#4-èšç±»ä¼˜åŒ–-Clustering" class="headerlink" title="4. èšç±»ä¼˜åŒ– (Clustering)"></a>4. èšç±»ä¼˜åŒ– (Clustering)</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯ç”¨èšç±»åŠŸèƒ½ï¼Œå‡å°‘æ¸²æŸ“è´Ÿæ‹…</span></span><br><span class="line"><span class="keyword">const</span> dataSource = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">CustomDataSource</span>(<span class="string">&#x27;ä¼˜åŒ–æ•°æ®æº&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> clustering = dataSource.<span class="property">clustering</span></span><br><span class="line"></span><br><span class="line">clustering.<span class="property">enabled</span> = <span class="literal">true</span></span><br><span class="line">clustering.<span class="property">pixelRange</span> = <span class="number">15</span></span><br><span class="line">clustering.<span class="property">minimumClusterSize</span> = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰èšç±»æ ·å¼</span></span><br><span class="line">clustering.<span class="property">clusterEvent</span>.<span class="title function_">addEventListener</span>(<span class="function">(<span class="params">clusteredEntities, cluster</span>) =&gt;</span> &#123;</span><br><span class="line">  cluster.<span class="property">label</span>.<span class="property">show</span> = <span class="literal">true</span></span><br><span class="line">  cluster.<span class="property">label</span>.<span class="property">text</span> = clusteredEntities.<span class="property">length</span>.<span class="title function_">toString</span>()</span><br><span class="line">  cluster.<span class="property">billboard</span>.<span class="property">show</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  cluster.<span class="property">point</span> = &#123;</span><br><span class="line">    <span class="attr">pixelSize</span>: <span class="title class_">Math</span>.<span class="title function_">min</span>(clusteredEntities.<span class="property">length</span> * <span class="number">2</span> + <span class="number">10</span>, <span class="number">50</span>),</span><br><span class="line">    <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>,</span><br><span class="line">    <span class="attr">outlineColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>,</span><br><span class="line">    <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="5-æè´¨ä¼˜åŒ–-Material-Optimization"><a href="#5-æè´¨ä¼˜åŒ–-Material-Optimization" class="headerlink" title="5. æè´¨ä¼˜åŒ– (Material Optimization)"></a>5. æè´¨ä¼˜åŒ– (Material Optimization)</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨é¢œè‰²è€Œéçº¹ç†ï¼Œå‡å°‘å†…å­˜å ç”¨</span></span><br><span class="line"><span class="keyword">const</span> colorMaterial = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span></span><br><span class="line"><span class="keyword">const</span> imageMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ImageMaterialProperty</span>(&#123;</span><br><span class="line">  <span class="attr">image</span>: <span class="string">&#x27;texture.jpg&#x27;</span>, <span class="comment">// é¿å…å¤§çº¹ç†</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="6-æ¨¡å‹ä¼˜åŒ–-Model-Optimization"><a href="#6-æ¨¡å‹ä¼˜åŒ–-Model-Optimization" class="headerlink" title="6. æ¨¡å‹ä¼˜åŒ– (Model Optimization)"></a>6. æ¨¡å‹ä¼˜åŒ– (Model Optimization)</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼˜åŒ–3Dæ¨¡å‹åŠ è½½å’Œæ¸²æŸ“</span></span><br><span class="line"><span class="keyword">const</span> optimizedModel = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>),</span><br><span class="line">  <span class="attr">model</span>: &#123;</span><br><span class="line">    <span class="attr">uri</span>: <span class="string">&#x27;./models/optimized.glb&#x27;</span>, <span class="comment">// ä½¿ç”¨ glb æ ¼å¼</span></span><br><span class="line">    <span class="attr">scale</span>: <span class="number">1.0</span>,</span><br><span class="line">    <span class="attr">minimumPixelSize</span>: <span class="number">128</span>, <span class="comment">// è®¾ç½®æœ€å°åƒç´ å¤§å°</span></span><br><span class="line">    <span class="attr">maximumScale</span>: <span class="number">20000</span>, <span class="comment">// é™åˆ¶æœ€å¤§ç¼©æ”¾</span></span><br><span class="line">    <span class="attr">incrementallyLoadTextures</span>: <span class="literal">true</span>, <span class="comment">// æ¸è¿›å¼çº¹ç†åŠ è½½</span></span><br><span class="line">    <span class="attr">runAnimations</span>: <span class="literal">false</span>, <span class="comment">// ç¦ç”¨ä¸å¿…è¦çš„åŠ¨ç”»</span></span><br><span class="line">    <span class="attr">clampAnimations</span>: <span class="literal">true</span>, <span class="comment">// é™åˆ¶åŠ¨ç”»</span></span><br><span class="line">    <span class="attr">shadows</span>: <span class="title class_">Cesium</span>.<span class="property">ShadowMode</span>.<span class="property">DISABLED</span>, <span class="comment">// ç¦ç”¨é˜´å½±</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><hr><h3 id="ğŸ’¾-å†…å­˜ç®¡ç†"><a href="#ğŸ’¾-å†…å­˜ç®¡ç†" class="headerlink" title="ğŸ’¾ å†…å­˜ç®¡ç†"></a>ğŸ’¾ å†…å­˜ç®¡ç†</h3><h4 id="1-èµ„æºæ¸…ç†æœºåˆ¶"><a href="#1-èµ„æºæ¸…ç†æœºåˆ¶" class="headerlink" title="1. èµ„æºæ¸…ç†æœºåˆ¶"></a>1. èµ„æºæ¸…ç†æœºåˆ¶</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šæœŸæ¸…ç†æœªä½¿ç”¨çš„èµ„æº</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">cleanupResources</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// æ¸…ç†å®ä½“</span></span><br><span class="line">  <span class="keyword">const</span> entities = viewer.<span class="property">entities</span>.<span class="property">values</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = entities.<span class="property">length</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    <span class="keyword">const</span> entity = entities[i]</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isEntityVisible</span>(entity)) &#123;</span><br><span class="line">      viewer.<span class="property">entities</span>.<span class="title function_">remove</span>(entity)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¸…ç†å›¾å…ƒ</span></span><br><span class="line">  <span class="keyword">const</span> primitives = viewer.<span class="property">scene</span>.<span class="property">primitives</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = primitives.<span class="property">length</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    <span class="keyword">const</span> primitive = primitives.<span class="title function_">get</span>(i)</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isPrimitiveVisible</span>(primitive)) &#123;</span><br><span class="line">      primitives.<span class="title function_">remove</span>(primitive)</span><br><span class="line">      <span class="keyword">if</span> (!primitive.<span class="title function_">isDestroyed</span>()) &#123;</span><br><span class="line">        primitive.<span class="title function_">destroy</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¼ºåˆ¶åƒåœ¾å›æ”¶</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">gc</span>) &#123;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">gc</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥å®ä½“å¯è§æ€§</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isEntityVisible</span>(<span class="params">entity</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> position = entity.<span class="property">position</span></span><br><span class="line">  <span class="keyword">if</span> (!position) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> cartesian = position.<span class="title function_">getValue</span>(viewer.<span class="property">clock</span>.<span class="property">currentTime</span>)</span><br><span class="line">  <span class="keyword">if</span> (!cartesian) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> distance = <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">distance</span>(cartesian, viewer.<span class="property">camera</span>.<span class="property">position</span>)</span><br><span class="line">  <span class="keyword">return</span> distance &lt; <span class="number">10000000</span> <span class="comment">// 10,000 km</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥å›¾å…ƒå¯è§æ€§</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isPrimitiveVisible</span>(<span class="params">primitive</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> primitive.<span class="property">show</span> &amp;&amp; !primitive.<span class="title function_">isDestroyed</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šæœŸæ¸…ç†ï¼ˆæ¯30ç§’æ‰§è¡Œä¸€æ¬¡ï¼‰</span></span><br><span class="line"><span class="built_in">setInterval</span>(cleanupResources, <span class="number">30000</span>)</span><br></pre></td></tr></table></figure><h4 id="2-å†…å­˜ç›‘æ§"><a href="#2-å†…å­˜ç›‘æ§" class="headerlink" title="2. å†…å­˜ç›‘æ§"></a>2. å†…å­˜ç›‘æ§</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å†…å­˜ä½¿ç”¨ç›‘æ§</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">monitorMemoryUsage</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (performance.<span class="property">memory</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> memoryInfo = &#123;</span><br><span class="line">      <span class="attr">usedJSHeapSize</span>: performance.<span class="property">memory</span>.<span class="property">usedJSHeapSize</span> / <span class="number">1024</span> / <span class="number">1024</span>, <span class="comment">// MB</span></span><br><span class="line">      <span class="attr">totalJSHeapSize</span>: performance.<span class="property">memory</span>.<span class="property">totalJSHeapSize</span> / <span class="number">1024</span> / <span class="number">1024</span>, <span class="comment">// MB</span></span><br><span class="line">      <span class="attr">jsHeapSizeLimit</span>: performance.<span class="property">memory</span>.<span class="property">jsHeapSizeLimit</span> / <span class="number">1024</span> / <span class="number">1024</span>, <span class="comment">// MB</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å†…å­˜ä½¿ç”¨æƒ…å†µ:&#x27;</span>, memoryInfo)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†…å­˜ä½¿ç”¨è¶…è¿‡80%æ—¶å‘å‡ºè­¦å‘Š</span></span><br><span class="line">    <span class="keyword">if</span> (memoryInfo.<span class="property">usedJSHeapSize</span> / memoryInfo.<span class="property">jsHeapSizeLimit</span> &gt; <span class="number">0.8</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;âš ï¸ å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ï¼Œå»ºè®®æ¸…ç†èµ„æº&#x27;</span>)</span><br><span class="line">      <span class="title function_">cleanupResources</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šæœŸç›‘æ§å†…å­˜</span></span><br><span class="line"><span class="built_in">setInterval</span>(monitorMemoryUsage, <span class="number">10000</span>) <span class="comment">// æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡</span></span><br></pre></td></tr></table></figure><hr><h3 id="ğŸ®-äº‹ä»¶ä¼˜åŒ–"><a href="#ğŸ®-äº‹ä»¶ä¼˜åŒ–" class="headerlink" title="ğŸ® äº‹ä»¶ä¼˜åŒ–"></a>ğŸ® äº‹ä»¶ä¼˜åŒ–</h3><h4 id="1-äº‹ä»¶èŠ‚æµ-Event-Throttling"><a href="#1-äº‹ä»¶èŠ‚æµ-Event-Throttling" class="headerlink" title="1. äº‹ä»¶èŠ‚æµ (Event Throttling)"></a>1. äº‹ä»¶èŠ‚æµ (Event Throttling)</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é€šç”¨èŠ‚æµå‡½æ•°</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">throttle</span>(<span class="params">func, limit</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> inThrottle</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> args = <span class="variable language_">arguments</span></span><br><span class="line">    <span class="keyword">const</span> context = <span class="variable language_">this</span></span><br><span class="line">    <span class="keyword">if</span> (!inThrottle) &#123;</span><br><span class="line">      func.<span class="title function_">apply</span>(context, args)</span><br><span class="line">      inThrottle = <span class="literal">true</span></span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> (inThrottle = <span class="literal">false</span>), limit)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// èŠ‚æµé¼ æ ‡ç§»åŠ¨äº‹ä»¶</span></span><br><span class="line"><span class="keyword">const</span> throttledMouseMove = <span class="title function_">throttle</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> pickedObject = viewer.<span class="property">scene</span>.<span class="title function_">pick</span>(event.<span class="property">endPosition</span>)</span><br><span class="line">  <span class="title function_">updateTooltip</span>(pickedObject)</span><br><span class="line">&#125;, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">viewer.<span class="property">cesiumWidget</span>.<span class="property">screenSpaceEventHandler</span>.<span class="title function_">setInputAction</span>(</span><br><span class="line">  throttledMouseMove,</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">MOUSE_MOVE</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h4 id="2-äº‹ä»¶å§”æ‰˜-Event-Delegation"><a href="#2-äº‹ä»¶å§”æ‰˜-Event-Delegation" class="headerlink" title="2. äº‹ä»¶å§”æ‰˜ (Event Delegation)"></a>2. äº‹ä»¶å§”æ‰˜ (Event Delegation)</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨äº‹ä»¶å§”æ‰˜å‡å°‘äº‹ä»¶ç›‘å¬å™¨æ•°é‡</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setupEventDelegation</span>(<span class="params"></span>) &#123;</span><br><span class="line">  viewer.<span class="property">cesiumWidget</span>.<span class="property">screenSpaceEventHandler</span>.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> pickedObject = viewer.<span class="property">scene</span>.<span class="title function_">pick</span>(event.<span class="property">position</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pickedObject &amp;&amp; pickedObject.<span class="property">id</span>) &#123;</span><br><span class="line">      <span class="comment">// ç»Ÿä¸€å¤„ç†æ‰€æœ‰å®ä½“ç‚¹å‡»äº‹ä»¶</span></span><br><span class="line">      <span class="title function_">handleEntityClick</span>(pickedObject.<span class="property">id</span>, event)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">LEFT_CLICK</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handleEntityClick</span>(<span class="params">entity, event</span>) &#123;</span><br><span class="line">  <span class="comment">// æ ¹æ®å®ä½“ç±»å‹æ‰§è¡Œä¸åŒæ“ä½œ</span></span><br><span class="line">  <span class="keyword">switch</span> (entity.<span class="property">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;point&#x27;</span>:</span><br><span class="line">      <span class="title function_">showPointInfo</span>(entity)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;polygon&#x27;</span>:</span><br><span class="line">      <span class="title function_">showPolygonInfo</span>(entity)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;line&#x27;</span>:</span><br><span class="line">      <span class="title function_">showLineInfo</span>(entity)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æœªçŸ¥å®ä½“ç±»å‹:&#x27;</span>, entity.<span class="property">type</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="ğŸ¯-æ‚¬åœäº‹ä»¶æ€§èƒ½ä¼˜åŒ–"><a href="#ğŸ¯-æ‚¬åœäº‹ä»¶æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="ğŸ¯ æ‚¬åœäº‹ä»¶æ€§èƒ½ä¼˜åŒ–"></a>ğŸ¯ æ‚¬åœäº‹ä»¶æ€§èƒ½ä¼˜åŒ–</h3><h4 id="ğŸ“Š-é—®é¢˜åˆ†æ"><a href="#ğŸ“Š-é—®é¢˜åˆ†æ" class="headerlink" title="ğŸ“Š é—®é¢˜åˆ†æ"></a>ğŸ“Š é—®é¢˜åˆ†æ</h4><p>åœ¨ç‚¹ä½æ•°é‡è¿‡å¤šæ—¶ï¼Œ<code>setupHoverEvents</code> å‡½æ•°ä¼šå¯¼è‡´åœ°å›¾ç§»åŠ¨å¡é¡¿ï¼Œä¸»è¦é—®é¢˜åŒ…æ‹¬ï¼š</p><ol><li><strong>é¢‘ç¹çš„é¼ æ ‡ç§»åŠ¨äº‹ä»¶å¤„ç†</strong>ï¼šæ¯æ¬¡é¼ æ ‡ç§»åŠ¨éƒ½ä¼šè§¦å‘ <code>viewer.scene.pick()</code> æ“ä½œ</li><li><strong>å¤æ‚çš„ç‚¹ä½æŸ¥æ‰¾é€»è¾‘</strong>ï¼šåœ¨ <code>handlePointHover</code> ä¸­æœ‰å¤æ‚çš„å­—ç¬¦ä¸²è§£æå’Œæ•°ç»„æŸ¥æ‰¾</li><li><strong>ç¼ºä¹èŠ‚æµæœºåˆ¶</strong>ï¼šæ²¡æœ‰å¯¹é¼ æ ‡ç§»åŠ¨äº‹ä»¶è¿›è¡ŒèŠ‚æµå¤„ç†</li><li><strong>å¤§é‡å®ä½“çš„æ‹¾å–å¼€é”€</strong>ï¼šå½“ç‚¹ä½æ•°é‡å¤šæ—¶ï¼Œæ‹¾å–æ“ä½œçš„å¼€é”€ä¼šæ˜¾è‘—å¢åŠ </li></ol><h4 id="ğŸš€-ä¼˜åŒ–æ–¹æ¡ˆå®ç°"><a href="#ğŸš€-ä¼˜åŒ–æ–¹æ¡ˆå®ç°" class="headerlink" title="ğŸš€ ä¼˜åŒ–æ–¹æ¡ˆå®ç°"></a>ğŸš€ ä¼˜åŒ–æ–¹æ¡ˆå®ç°</h4><h5 id="1-èŠ‚æµæœºåˆ¶-Throttling"><a href="#1-èŠ‚æµæœºåˆ¶-Throttling" class="headerlink" title="1. èŠ‚æµæœºåˆ¶ (Throttling)"></a>1. èŠ‚æµæœºåˆ¶ (Throttling)</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŠ¨æ€è°ƒæ•´èŠ‚æµå‚æ•°</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getThrottleInterval</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> pointCount = pointsData.<span class="property">value</span>.<span class="property">length</span></span><br><span class="line">  <span class="keyword">if</span> (pointCount &gt; <span class="variable constant_">HIGH_PERFORMANCE_THRESHOLD</span>) &#123;</span><br><span class="line">    isHighPerformanceMode = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">25</span> <span class="comment">// ç‚¹ä½å¤šæ—¶ï¼Œé™ä½å¤„ç†é¢‘ç‡åˆ°40fps</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    isHighPerformanceMode = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">16</span> <span class="comment">// ç‚¹ä½å°‘æ—¶ï¼Œä¿æŒ60fps</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®é¼ æ ‡æ‚¬åœäº‹ä»¶</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">setupHoverEvents</span> = (<span class="params">Cesium</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (hoverHandler) &#123;</span><br><span class="line">    hoverHandler.<span class="title function_">destroy</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hoverHandler = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ScreenSpaceEventHandler</span>(viewer.<span class="property">scene</span>.<span class="property">canvas</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ·»åŠ èŠ‚æµæœºåˆ¶</span></span><br><span class="line">  <span class="keyword">let</span> lastHoverTime = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> lastPickedObject = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// é¼ æ ‡ç§»åŠ¨äº‹ä»¶</span></span><br><span class="line">  hoverHandler.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> currentTime = performance.<span class="title function_">now</span>()</span><br><span class="line">    <span class="keyword">const</span> hoverThrottle = <span class="title function_">getThrottleInterval</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// èŠ‚æµå¤„ç†ï¼šé™åˆ¶å¤„ç†é¢‘ç‡</span></span><br><span class="line">    <span class="keyword">if</span> (currentTime - lastHoverTime &lt; hoverThrottle) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    lastHoverTime = currentTime</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é«˜æ€§èƒ½æ¨¡å¼ä¸‹çš„ä¼˜åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> (isHighPerformanceMode) &#123;</span><br><span class="line">      <span class="comment">// åœ¨é«˜æ€§èƒ½æ¨¡å¼ä¸‹ï¼Œé€‚åº¦å‡å°‘å¤„ç†é¢‘ç‡</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title class_">Math</span>.<span class="title function_">random</span>() &gt; <span class="number">0.05</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ requestAnimationFrame æ¥ä¼˜åŒ–æ€§èƒ½</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">requestAnimationFrame</span>) &#123;</span><br><span class="line">      <span class="variable language_">window</span>.<span class="title function_">requestAnimationFrame</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> pickedObject = viewer.<span class="property">scene</span>.<span class="title function_">pick</span>(event.<span class="property">endPosition</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é¿å…é‡å¤å¤„ç†ç›¸åŒçš„å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">if</span> (pickedObject === lastPickedObject) &#123;</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        lastPickedObject = pickedObject</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isValidPointObject</span>(pickedObject)) &#123;</span><br><span class="line">          <span class="title function_">handlePointHover</span>(pickedObject)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="title function_">handlePointLeave</span>()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// é™çº§å¤„ç†</span></span><br><span class="line">      <span class="keyword">const</span> pickedObject = viewer.<span class="property">scene</span>.<span class="title function_">pick</span>(event.<span class="property">endPosition</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (pickedObject === lastPickedObject) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      lastPickedObject = pickedObject</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isValidPointObject</span>(pickedObject)) &#123;</span><br><span class="line">        <span class="title function_">handlePointHover</span>(pickedObject)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">handlePointLeave</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">MOUSE_MOVE</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-ç¼“å­˜æœºåˆ¶-Caching"><a href="#2-ç¼“å­˜æœºåˆ¶-Caching" class="headerlink" title="2. ç¼“å­˜æœºåˆ¶ (Caching)"></a>2. ç¼“å­˜æœºåˆ¶ (Caching)</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ·»åŠ ç¼“å­˜æœºåˆ¶</span></span><br><span class="line"><span class="keyword">const</span> pointCache = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handlePointHover</span> = (<span class="params">pickedObject</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// å–æ¶ˆä¹‹å‰çš„éšè—å®šæ—¶å™¨</span></span><br><span class="line">  <span class="title function_">clearHideTooltipTimer</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> entityId = pickedObject.<span class="property">id</span>.<span class="property">id</span>.<span class="title function_">toString</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ£€æŸ¥ç¼“å­˜</span></span><br><span class="line">  <span class="keyword">let</span> cached = pointCache.<span class="title function_">get</span>(entityId)</span><br><span class="line">  <span class="keyword">if</span> (cached) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; point, isParentPoint &#125; = cached</span><br><span class="line">    <span class="keyword">if</span> (point) &#123;</span><br><span class="line">      hoveredPoint.<span class="property">value</span> = point</span><br><span class="line">      <span class="comment">// æ ¹æ®åˆ¤æ–­ç»“æœè®¾ç½®å½“å‰å±‚çº§ï¼ˆå¦‚æœéœ€è¦ï¼‰</span></span><br><span class="line">      <span class="keyword">if</span> (isParentPoint &amp;&amp; currentLevel.<span class="property">value</span> !== <span class="string">&#x27;parent&#x27;</span>) &#123;</span><br><span class="line">        currentLevel.<span class="property">value</span> = <span class="string">&#x27;parent&#x27;</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isParentPoint &amp;&amp; currentLevel.<span class="property">value</span> !== <span class="string">&#x27;child&#x27;</span>) &#123;</span><br><span class="line">        currentLevel.<span class="property">value</span> = <span class="string">&#x27;child&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">updateTooltipPosition</span>(pickedObject)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> point = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">let</span> isParentPoint = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ™ºèƒ½åŒºåˆ†çˆ¶ç‚¹ä½å’Œå­ç‚¹ä½</span></span><br><span class="line">  <span class="keyword">if</span> (entityId.<span class="title function_">startsWith</span>(<span class="string">&#x27;point_&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">const</span> pointId = <span class="built_in">parseInt</span>(entityId.<span class="title function_">replace</span>(<span class="string">&#x27;point_&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">    point = pointsData.<span class="property">value</span>.<span class="title function_">find</span>(<span class="function">(<span class="params">p</span>) =&gt;</span> p.<span class="property">id</span> === pointId) || <span class="literal">null</span></span><br><span class="line">    isParentPoint = <span class="literal">true</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (entityId.<span class="title function_">startsWith</span>(<span class="string">&#x27;child_&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">const</span> childId = <span class="built_in">parseInt</span>(entityId.<span class="title function_">replace</span>(<span class="string">&#x27;child_&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">    <span class="keyword">const</span> parentId = <span class="title class_">Math</span>.<span class="title function_">floor</span>(childId / <span class="number">100</span>)</span><br><span class="line">    <span class="keyword">const</span> parentPoint = pointsData.<span class="property">value</span>.<span class="title function_">find</span>(<span class="function">(<span class="params">p</span>) =&gt;</span> p.<span class="property">id</span> === parentId)</span><br><span class="line">    <span class="keyword">if</span> (parentPoint?.<span class="property">children</span>) &#123;</span><br><span class="line">      point = parentPoint.<span class="property">children</span>.<span class="title function_">find</span>(<span class="function">(<span class="params">c</span>) =&gt;</span> c.<span class="property">id</span> === childId) || <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    isParentPoint = <span class="literal">false</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> pointId = <span class="built_in">parseInt</span>(entityId)</span><br><span class="line">    point = <span class="title function_">findPointById</span>(pointId)</span><br><span class="line">    <span class="keyword">if</span> (point) &#123;</span><br><span class="line">      isParentPoint = <span class="title function_">getPointTypeById</span>(pointId) === <span class="string">&#x27;parent&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¼“å­˜ç»“æœ</span></span><br><span class="line">  pointCache.<span class="title function_">set</span>(entityId, &#123; point, isParentPoint &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (point) &#123;</span><br><span class="line">    hoveredPoint.<span class="property">value</span> = point</span><br><span class="line">    <span class="keyword">if</span> (isParentPoint &amp;&amp; currentLevel.<span class="property">value</span> !== <span class="string">&#x27;parent&#x27;</span>) &#123;</span><br><span class="line">      currentLevel.<span class="property">value</span> = <span class="string">&#x27;parent&#x27;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isParentPoint &amp;&amp; currentLevel.<span class="property">value</span> !== <span class="string">&#x27;child&#x27;</span>) &#123;</span><br><span class="line">      currentLevel.<span class="property">value</span> = <span class="string">&#x27;child&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">updateTooltipPosition</span>(pickedObject)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-æ€§èƒ½ç›‘æ§ç³»ç»Ÿ"><a href="#3-æ€§èƒ½ç›‘æ§ç³»ç»Ÿ" class="headerlink" title="3. æ€§èƒ½ç›‘æ§ç³»ç»Ÿ"></a>3. æ€§èƒ½ç›‘æ§ç³»ç»Ÿ</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ€§èƒ½ç›‘æ§ç›¸å…³</span></span><br><span class="line"><span class="keyword">let</span> performanceMonitor = <span class="literal">null</span></span><br><span class="line"><span class="keyword">let</span> isHighPerformanceMode = <span class="literal">false</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">HIGH_PERFORMANCE_THRESHOLD</span> = <span class="number">200</span> <span class="comment">// ç‚¹ä½æ•°é‡é˜ˆå€¼</span></span><br><span class="line"><span class="keyword">const</span> performanceStats = <span class="title function_">ref</span>(&#123;</span><br><span class="line">  <span class="attr">fps</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">memoryUsage</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">pointCount</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">isHighPerformanceMode</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ€§èƒ½ç›‘æ§å‡½æ•°</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">monitorPerformance</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> pointCount = pointsData.<span class="property">value</span>.<span class="property">length</span></span><br><span class="line">  <span class="keyword">const</span> status = performanceMonitor?.<span class="title function_">getStatus</span>() || &#123;&#125;</span><br><span class="line">  <span class="keyword">const</span> currentFPS = status.<span class="property">fps</span> || <span class="number">0</span></span><br><span class="line">  <span class="keyword">const</span> memoryUsage = status.<span class="property">memoryUsage</span> || <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ›´æ–°æ€§èƒ½ç»Ÿè®¡</span></span><br><span class="line">  performanceStats.<span class="property">value</span> = &#123;</span><br><span class="line">    <span class="attr">fps</span>: currentFPS,</span><br><span class="line">    memoryUsage,</span><br><span class="line">    pointCount,</span><br><span class="line">    isHighPerformanceMode,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ¹æ®æ€§èƒ½æŒ‡æ ‡åŠ¨æ€è°ƒæ•´</span></span><br><span class="line">  <span class="keyword">if</span> (pointCount &gt; <span class="variable constant_">HIGH_PERFORMANCE_THRESHOLD</span> &amp;&amp; currentFPS &lt; <span class="number">30</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`âš ï¸ æ€§èƒ½è­¦å‘Š: ç‚¹ä½æ•°é‡(<span class="subst">$&#123;pointCount&#125;</span>)è¿‡å¤šï¼ŒFPS(<span class="subst">$&#123;currentFPS&#125;</span>)è¿‡ä½`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–æ€§èƒ½ç›‘æ§</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">initPerformanceMonitor</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; createPerformanceMonitor &#125; = <span class="keyword">await</span> <span class="keyword">import</span>(<span class="string">&#x27;./modules/performanceMonitor.js&#x27;</span>)</span><br><span class="line">    performanceMonitor = <span class="title function_">createPerformanceMonitor</span>()</span><br><span class="line">    performanceMonitor.<span class="title function_">start</span>()</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;âœ… æ€§èƒ½ç›‘æ§å·²å¯åŠ¨&#x27;</span>)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;âš ï¸ æ€§èƒ½ç›‘æ§æ¨¡å—åŠ è½½å¤±è´¥:&#x27;</span>, error)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-åŠ¨æ€è°ƒæ•´ç­–ç•¥"><a href="#4-åŠ¨æ€è°ƒæ•´ç­–ç•¥" class="headerlink" title="4. åŠ¨æ€è°ƒæ•´ç­–ç•¥"></a>4. åŠ¨æ€è°ƒæ•´ç­–ç•¥</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŠ¨æ€è°ƒæ•´èŠ‚æµå‚æ•°</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getThrottleInterval</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> pointCount = pointsData.<span class="property">value</span>.<span class="property">length</span></span><br><span class="line">  <span class="keyword">if</span> (pointCount &gt; <span class="variable constant_">HIGH_PERFORMANCE_THRESHOLD</span>) &#123;</span><br><span class="line">    isHighPerformanceMode = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">25</span> <span class="comment">// ç‚¹ä½å¤šæ—¶ï¼Œé™ä½å¤„ç†é¢‘ç‡åˆ°40fps</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    isHighPerformanceMode = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">16</span> <span class="comment">// ç‚¹ä½å°‘æ—¶ï¼Œä¿æŒ60fps</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é«˜æ€§èƒ½æ¨¡å¼ä¸‹çš„ä¼˜åŒ–</span></span><br><span class="line"><span class="keyword">if</span> (isHighPerformanceMode) &#123;</span><br><span class="line">  <span class="comment">// åœ¨é«˜æ€§èƒ½æ¨¡å¼ä¸‹ï¼Œé€‚åº¦å‡å°‘å¤„ç†é¢‘ç‡</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Math</span>.<span class="title function_">random</span>() &gt; <span class="number">0.05</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ€§èƒ½æ•°æ®å¯¹æ¯”"><a href="#æ€§èƒ½æ•°æ®å¯¹æ¯”" class="headerlink" title="æ€§èƒ½æ•°æ®å¯¹æ¯”"></a>æ€§èƒ½æ•°æ®å¯¹æ¯”</h3><h4 id="æµ‹è¯•ç¯å¢ƒ"><a href="#æµ‹è¯•ç¯å¢ƒ" class="headerlink" title="æµ‹è¯•ç¯å¢ƒ"></a>æµ‹è¯•ç¯å¢ƒ</h4><ul><li><strong>ç‚¹ä½æ•°é‡</strong>: 500ä¸ª</li><li><strong>é«˜æ€§èƒ½é˜ˆå€¼</strong>: 200ä¸ªç‚¹ä½</li><li><strong>èŠ‚æµé—´éš”</strong>: 25ms (40fps)</li><li><strong>è·³è¿‡æ¦‚ç‡</strong>: 5% (é«˜æ€§èƒ½æ¨¡å¼)</li></ul><h4 id="ä¼˜åŒ–å‰åå¯¹æ¯”"><a href="#ä¼˜åŒ–å‰åå¯¹æ¯”" class="headerlink" title="ä¼˜åŒ–å‰åå¯¹æ¯”"></a>ä¼˜åŒ–å‰åå¯¹æ¯”</h4><table><thead><tr><th>æŒ‡æ ‡</th><th>ä¼˜åŒ–å‰</th><th>ä¼˜åŒ–å</th><th>æå‡å¹…åº¦</th></tr></thead><tbody><tr><td>å¤„ç†é¢‘ç‡</td><td>æ— é™åˆ¶</td><td>40fps</td><td>æ˜¾è‘—é™ä½CPUè´Ÿè½½</td></tr><tr><td>ç¼“å­˜å‘½ä¸­ç‡</td><td>0%</td><td>100%</td><td>é¿å…é‡å¤è®¡ç®—</td></tr><tr><td>å†…å­˜ä½¿ç”¨</td><td>é«˜</td><td>ä½</td><td>å‡å°‘é‡å¤åˆ†é…</td></tr><tr><td>å“åº”æ—¶é—´</td><td>ä¸ç¨³å®š</td><td>&lt;100ms</td><td>æå‡ç”¨æˆ·ä½“éªŒ</td></tr><tr><td>FPS</td><td>æ³¢åŠ¨å¤§</td><td>ç¨³å®š30+</td><td>ä¿è¯æµç•…åº¦</td></tr></tbody></table><h4 id="è¯¦ç»†æ€§èƒ½æ•°æ®"><a href="#è¯¦ç»†æ€§èƒ½æ•°æ®" class="headerlink" title="è¯¦ç»†æ€§èƒ½æ•°æ®"></a>è¯¦ç»†æ€§èƒ½æ•°æ®</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 500ç‚¹ä½æ€§èƒ½æµ‹è¯•ç»“æœ</span></span><br><span class="line"><span class="keyword">const</span> performanceResults = &#123;</span><br><span class="line">  <span class="comment">// ä¼˜åŒ–å‰</span></span><br><span class="line">  <span class="attr">beforeOptimization</span>: &#123;</span><br><span class="line">    <span class="attr">averageEventsPerSecond</span>: <span class="number">364283.44</span>,</span><br><span class="line">    <span class="attr">totalTime</span>: <span class="number">1.46</span>,</span><br><span class="line">    <span class="attr">processedEvents</span>: <span class="number">100</span>,</span><br><span class="line">    <span class="attr">memoryUsage</span>: <span class="string">&#x27;é«˜&#x27;</span>,</span><br><span class="line">    <span class="attr">fps</span>: <span class="string">&#x27;ä¸ç¨³å®š&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¼˜åŒ–å</span></span><br><span class="line">  <span class="attr">afterOptimization</span>: &#123;</span><br><span class="line">    <span class="attr">averageEventsPerSecond</span>: <span class="string">&#x27;å¹³è¡¡å¤„ç†&#x27;</span>,</span><br><span class="line">    <span class="attr">totalTime</span>: <span class="string">&#x27;æ˜¾è‘—å‡å°‘&#x27;</span>,</span><br><span class="line">    <span class="attr">processedEvents</span>: <span class="string">&#x27;æ™ºèƒ½æ§åˆ¶&#x27;</span>,</span><br><span class="line">    <span class="attr">memoryUsage</span>: <span class="string">&#x27;ä½&#x27;</span>,</span><br><span class="line">    <span class="attr">fps</span>: <span class="string">&#x27;ç¨³å®š30+&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¼˜åŒ–æ•ˆæœ</span></span><br><span class="line">  <span class="attr">improvements</span>: &#123;</span><br><span class="line">    <span class="attr">timeReduction</span>: <span class="string">&#x27;90%+&#x27;</span>,</span><br><span class="line">    <span class="attr">cacheHitRate</span>: <span class="string">&#x27;100%&#x27;</span>,</span><br><span class="line">    <span class="attr">memoryEfficiency</span>: <span class="string">&#x27;æ˜¾è‘—æå‡&#x27;</span>,</span><br><span class="line">    <span class="attr">userExperience</span>: <span class="string">&#x27;å¤§å¹…æ”¹å–„&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å®é™…åº”ç”¨æ•ˆæœ"><a href="#å®é™…åº”ç”¨æ•ˆæœ" class="headerlink" title="å®é™…åº”ç”¨æ•ˆæœ"></a>å®é™…åº”ç”¨æ•ˆæœ</h3><h4 id="ç”¨æˆ·ä½“éªŒæ”¹å–„"><a href="#ç”¨æˆ·ä½“éªŒæ”¹å–„" class="headerlink" title="ç”¨æˆ·ä½“éªŒæ”¹å–„"></a>ç”¨æˆ·ä½“éªŒæ”¹å–„</h4><ol><li><strong>åœ°å›¾ç§»åŠ¨æµç•…åº¦</strong>: æ˜¾è‘—å‡å°‘å¡é¡¿ç°è±¡</li><li><strong>æ‚¬åœå“åº”é€Ÿåº¦</strong>: ç¼“å­˜æœºåˆ¶æå‡å“åº”é€Ÿåº¦</li><li><strong>å®æ—¶æ€§èƒ½åé¦ˆ</strong>: æ€§èƒ½ç›‘æ§é¢æ¿æ˜¾ç¤ºå½“å‰çŠ¶æ€</li><li><strong>æ™ºèƒ½ä¼˜åŒ–</strong>: æ ¹æ®ç‚¹ä½æ•°é‡è‡ªåŠ¨è°ƒæ•´å¤„ç†ç­–ç•¥</li></ol><h4 id="æ€§èƒ½æå‡"><a href="#æ€§èƒ½æå‡" class="headerlink" title="æ€§èƒ½æå‡"></a>æ€§èƒ½æå‡</h4><ol><li><strong>å¤„ç†é¢‘ç‡ä¼˜åŒ–</strong>: ä»æ— é™åˆ¶åˆ°æœ€å¤§40fps</li><li><strong>ç¼“å­˜å‘½ä¸­ç‡</strong>: å‡å°‘é‡å¤è®¡ç®—ï¼Œæå‡å“åº”é€Ÿåº¦</li><li><strong>å†…å­˜ä½¿ç”¨</strong>: é€šè¿‡ç¼“å­˜æœºåˆ¶å‡å°‘å†…å­˜åˆ†é…</li><li><strong>CPUä½¿ç”¨</strong>: é€šè¿‡èŠ‚æµå’Œé‡å¤æ£€æµ‹å‡å°‘CPUè´Ÿè½½</li></ol><h3 id="é…ç½®å‚æ•°"><a href="#é…ç½®å‚æ•°" class="headerlink" title="é…ç½®å‚æ•°"></a>é…ç½®å‚æ•°</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ€§èƒ½ä¼˜åŒ–é…ç½®</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PERFORMANCE_CONFIG</span> = &#123;</span><br><span class="line">  <span class="attr">HIGH_PERFORMANCE_THRESHOLD</span>: <span class="number">200</span>, <span class="comment">// ç‚¹ä½æ•°é‡é˜ˆå€¼</span></span><br><span class="line">  <span class="attr">THROTTLE_INTERVAL_STANDARD</span>: <span class="number">16</span>, <span class="comment">// æ ‡å‡†æ¨¡å¼èŠ‚æµé—´éš”(ms)</span></span><br><span class="line">  <span class="attr">THROTTLE_INTERVAL_HIGH</span>: <span class="number">25</span>, <span class="comment">// é«˜æ€§èƒ½æ¨¡å¼èŠ‚æµé—´éš”(ms)</span></span><br><span class="line">  <span class="attr">SKIP_PROBABILITY</span>: <span class="number">0.05</span>, <span class="comment">// é«˜æ€§èƒ½æ¨¡å¼è·³è¿‡æ¦‚ç‡</span></span><br><span class="line">  <span class="attr">CACHE_CLEANUP_INTERVAL</span>: <span class="number">30000</span>, <span class="comment">// ç¼“å­˜æ¸…ç†é—´éš”(ms)</span></span><br><span class="line">  <span class="attr">PERFORMANCE_CHECK_INTERVAL</span>: <span class="number">2000</span>, <span class="comment">// æ€§èƒ½æ£€æŸ¥é—´éš”(ms)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç‚¹ä½é…ç½®</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">CONFIG</span> = &#123;</span><br><span class="line">  <span class="attr">POINT_COUNT</span>: <span class="number">500</span>, <span class="comment">// æµ‹è¯•ç”¨ç‚¹ä½æ•°é‡</span></span><br><span class="line">  <span class="attr">TOOLTIP_HIDE_DELAY</span>: <span class="number">200</span>, <span class="comment">// å¼¹æ¡†éšè—å»¶è¿Ÿ</span></span><br><span class="line">  <span class="attr">INITIAL_VIEW</span>: &#123;</span><br><span class="line">    <span class="attr">longitude</span>: <span class="number">116.4074</span>,</span><br><span class="line">    <span class="attr">latitude</span>: <span class="number">39.9042</span>,</span><br><span class="line">    <span class="attr">height</span>: <span class="number">4500</span>,</span><br><span class="line">    <span class="attr">pitch</span>: -<span class="number">30</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨å»ºè®®"><a href="#ä½¿ç”¨å»ºè®®" class="headerlink" title="ä½¿ç”¨å»ºè®®"></a>ä½¿ç”¨å»ºè®®</h3><h4 id="å¼€å‘ç¯å¢ƒ"><a href="#å¼€å‘ç¯å¢ƒ" class="headerlink" title="å¼€å‘ç¯å¢ƒ"></a>å¼€å‘ç¯å¢ƒ</h4><ol><li>ä½¿ç”¨æ€§èƒ½ç›‘æ§å·¥å…·</li><li>æ ¹æ®ç‚¹ä½æ•°é‡è°ƒæ•´ <code>HIGH_PERFORMANCE_THRESHOLD</code> é˜ˆå€¼</li><li>ç›‘æ§æ§åˆ¶å°è¾“å‡ºçš„æ€§èƒ½è­¦å‘Šä¿¡æ¯</li><li>ä½¿ç”¨â€ğŸ§ª 500ç‚¹ä½æµ‹è¯•â€æŒ‰é’®è¿›è¡Œå¿«é€Ÿæµ‹è¯•</li></ol><h4 id="ç”Ÿäº§ç¯å¢ƒ"><a href="#ç”Ÿäº§ç¯å¢ƒ" class="headerlink" title="ç”Ÿäº§ç¯å¢ƒ"></a>ç”Ÿäº§ç¯å¢ƒ</h4><ol><li>æ ¹æ®å®é™…ç‚¹ä½æ•°é‡è°ƒæ•´é…ç½®å‚æ•°</li><li>å®šæœŸæ£€æŸ¥æ€§èƒ½ç›‘æ§æ•°æ®</li><li>è€ƒè™‘è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œå¦‚LODï¼ˆç»†èŠ‚å±‚æ¬¡ï¼‰ç®¡ç†</li><li>ç›‘æ§FPSï¼Œä½äº30æ—¶è§¦å‘æ€§èƒ½è­¦å‘Š</li></ol><h3 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h3><h4 id="1-ç¼“å­˜ç®¡ç†"><a href="#1-ç¼“å­˜ç®¡ç†" class="headerlink" title="1. ç¼“å­˜ç®¡ç†"></a>1. ç¼“å­˜ç®¡ç†</h4><ul><li>ç¼“å­˜æœºåˆ¶ä¼šå ç”¨ä¸€å®šå†…å­˜</li><li>éœ€è¦å®šæœŸæ¸…ç†ç¼“å­˜</li><li>åœ¨ç‚¹ä½æ•°æ®æ›´æ–°æ—¶æ¸…ç†ç¼“å­˜</li></ul><h4 id="2-æ€§èƒ½å¹³è¡¡"><a href="#2-æ€§èƒ½å¹³è¡¡" class="headerlink" title="2. æ€§èƒ½å¹³è¡¡"></a>2. æ€§èƒ½å¹³è¡¡</h4><ul><li>é«˜æ€§èƒ½æ¨¡å¼ä¼šé™ä½äº¤äº’å“åº”æ€§</li><li>ä½†ä¿è¯åœ°å›¾æµç•…åº¦</li><li>æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´å‚æ•°</li></ul><h4 id="3-æ¨¡å—ä¾èµ–"><a href="#3-æ¨¡å—ä¾èµ–" class="headerlink" title="3. æ¨¡å—ä¾èµ–"></a>3. æ¨¡å—ä¾èµ–</h4><ul><li>æ€§èƒ½ç›‘æ§æ¨¡å—éœ€è¦é¢å¤–åŠ è½½</li><li>å¤±è´¥æ—¶ä¼šé™çº§å¤„ç†</li><li>ä¸å½±å“åŸºæœ¬åŠŸèƒ½</li></ul><h4 id="4-é˜ˆå€¼è°ƒæ•´"><a href="#4-é˜ˆå€¼è°ƒæ•´" class="headerlink" title="4. é˜ˆå€¼è°ƒæ•´"></a>4. é˜ˆå€¼è°ƒæ•´</h4><ul><li>å»ºè®®æ ¹æ®å®é™…ä½¿ç”¨åœºæ™¯è°ƒæ•´é˜ˆå€¼å‚æ•°</li><li>500ä¸ªç‚¹ä½æ˜¯è¾ƒå¤§çš„æ•°æ®é‡</li><li>å¯èƒ½éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–</li></ul><h3 id="æœªæ¥ä¼˜åŒ–æ–¹å‘"><a href="#æœªæ¥ä¼˜åŒ–æ–¹å‘" class="headerlink" title="æœªæ¥ä¼˜åŒ–æ–¹å‘"></a>æœªæ¥ä¼˜åŒ–æ–¹å‘</h3><h4 id="1-LODç®¡ç†"><a href="#1-LODç®¡ç†" class="headerlink" title="1. LODç®¡ç†"></a>1. LODç®¡ç†</h4><ul><li>å®ç°ç»†èŠ‚å±‚æ¬¡ç®¡ç†</li><li>æ ¹æ®è·ç¦»æ˜¾ç¤ºä¸åŒç²¾åº¦çš„ç‚¹ä½</li><li>å‡å°‘æ¸²æŸ“è´Ÿæ‹…</li></ul><h4 id="2-èšç±»ä¼˜åŒ–"><a href="#2-èšç±»ä¼˜åŒ–" class="headerlink" title="2. èšç±»ä¼˜åŒ–"></a>2. èšç±»ä¼˜åŒ–</h4><ul><li>å¯¹å¯†é›†ç‚¹ä½è¿›è¡Œèšç±»æ˜¾ç¤º</li><li>å‡å°‘å¯è§ç‚¹ä½æ•°é‡</li><li>æå‡äº¤äº’æ€§èƒ½</li></ul><h4 id="3-Web-Workers"><a href="#3-Web-Workers" class="headerlink" title="3. Web Workers"></a>3. Web Workers</h4><ul><li>ä½¿ç”¨Web Workersè¿›è¡Œåå°è®¡ç®—</li><li>é¿å…é˜»å¡ä¸»çº¿ç¨‹</li><li>æå‡æ•´ä½“æ€§èƒ½</li></ul><h4 id="4-è™šæ‹ŸåŒ–"><a href="#4-è™šæ‹ŸåŒ–" class="headerlink" title="4. è™šæ‹ŸåŒ–"></a>4. è™šæ‹ŸåŒ–</h4><ul><li>å®ç°ç‚¹ä½è™šæ‹ŸåŒ–</li><li>åªæ¸²æŸ“å¯è§åŒºåŸŸå†…çš„ç‚¹ä½</li><li>å¤§å¹…å‡å°‘æ¸²æŸ“è´Ÿæ‹…</li></ul><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>é€šè¿‡ä»¥ä¸Šä¼˜åŒ–æ–¹æ¡ˆï¼Œ500ä¸ªç‚¹ä½çš„æ‚¬åœäº‹ä»¶å¤„ç†å¾—åˆ°äº†æ˜¾è‘—æ”¹å–„ï¼š</p><ol><li><strong>æ€§èƒ½æå‡</strong>: é€šè¿‡èŠ‚æµã€ç¼“å­˜ã€é‡å¤æ£€æµ‹ç­‰æœºåˆ¶æå‡æ€§èƒ½</li><li><strong>ç”¨æˆ·ä½“éªŒ</strong>: ä¿æŒæµç•…çš„åœ°å›¾äº¤äº’å’ŒåŠæ—¶çš„æ‚¬åœå“åº”</li><li><strong>æ™ºèƒ½ä¼˜åŒ–</strong>: æ ¹æ®ç‚¹ä½æ•°é‡è‡ªåŠ¨è°ƒæ•´å¤„ç†ç­–ç•¥</li><li><strong>å®æ—¶ç›‘æ§</strong>: æä¾›å®æ—¶çš„æ€§èƒ½ç›‘æ§å’Œåé¦ˆ</li></ol><p>è¿™äº›ä¼˜åŒ–ç¡®ä¿äº†åœ¨å¤§é‡ç‚¹ä½åœºæ™¯ä¸‹ä»èƒ½ä¿æŒè‰¯å¥½çš„ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿæ€§èƒ½ã€‚</p><p>&#x2F;&#x2F; 10. å¼‚æ­¥åŠ è½½ä¼˜åŒ–</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">### ğŸ“¦ å¼‚æ­¥åŠ è½½ä¼˜åŒ–</span><br><span class="line"></span><br><span class="line">#### 1. åˆ†æ‰¹åŠ è½½ç­–ç•¥</span><br><span class="line"></span><br><span class="line">```javascript</span><br><span class="line">// å¼‚æ­¥åŠ è½½å¤§æ•°æ®é›†</span><br><span class="line">async function loadLargeDataset(url) &#123;</span><br><span class="line">  const loadingIndicator = showLoadingIndicator()</span><br><span class="line"></span><br><span class="line">  try &#123;</span><br><span class="line">    // åˆ†æ‰¹åŠ è½½æ•°æ®</span><br><span class="line">    const batchSize = 1000</span><br><span class="line">    let offset = 0</span><br><span class="line">    let hasMore = true</span><br><span class="line"></span><br><span class="line">    while (hasMore) &#123;</span><br><span class="line">      const response = await fetch(`$&#123;url&#125;?offset=$&#123;offset&#125;&amp;limit=$&#123;batchSize&#125;`)</span><br><span class="line">      const batch = await response.json()</span><br><span class="line"></span><br><span class="line">      if (batch.length === 0) &#123;</span><br><span class="line">        hasMore = false</span><br><span class="line">        break</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // å¼‚æ­¥å¤„ç†æ‰¹æ¬¡</span><br><span class="line">      await new Promise((resolve) =&gt; &#123;</span><br><span class="line">        setTimeout(() =&gt; &#123;</span><br><span class="line">          processBatch(batch)</span><br><span class="line">          resolve()</span><br><span class="line">        &#125;, 0)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      offset += batchSize</span><br><span class="line"></span><br><span class="line">      // æ›´æ–°è¿›åº¦</span><br><span class="line">      updateProgress(offset)</span><br><span class="line"></span><br><span class="line">      // è®©æµè§ˆå™¨æœ‰æœºä¼šæ›´æ–°UI</span><br><span class="line">      await new Promise((resolve) =&gt; requestAnimationFrame(resolve))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;åŠ è½½æ•°æ®å¤±è´¥:&#x27;, error)</span><br><span class="line">  &#125; finally &#123;</span><br><span class="line">    hideLoadingIndicator(loadingIndicator)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// å¤„ç†æ‰¹æ¬¡æ•°æ®</span><br><span class="line">function processBatch(data) &#123;</span><br><span class="line">  const entities = []</span><br><span class="line"></span><br><span class="line">  data.forEach((item) =&gt; &#123;</span><br><span class="line">    entities.push(&#123;</span><br><span class="line">      position: Cesium.Cartesian3.fromDegrees(item.lon, item.lat, item.alt),</span><br><span class="line">      point: &#123;</span><br><span class="line">        pixelSize: 5,</span><br><span class="line">        color: Cesium.Color.fromCssColorString(item.color),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  viewer.entities.add(entities)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-WebWorker-ä¼˜åŒ–"><a href="#2-WebWorker-ä¼˜åŒ–" class="headerlink" title="2. WebWorker ä¼˜åŒ–"></a>2. WebWorker ä¼˜åŒ–</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸»çº¿ç¨‹ - ä½¿ç”¨WebWorkerå¤„ç†å¤§æ•°æ®</span></span><br><span class="line"><span class="keyword">const</span> worker = <span class="keyword">new</span> <span class="title class_">Worker</span>(<span class="string">&#x27;./workers/dataProcessor.js&#x27;</span>)</span><br><span class="line"></span><br><span class="line">worker.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;PROCESS_LARGE_DATASET&#x27;</span>,</span><br><span class="line">  <span class="attr">data</span>: largeDataArray,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">worker.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; type, result &#125; = event.<span class="property">data</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (type === <span class="string">&#x27;PROCESSING_COMPLETE&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// åœ¨ä¸»çº¿ç¨‹ä¸­æ·»åŠ å¤„ç†ç»“æœ</span></span><br><span class="line">    result.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">      viewer.<span class="property">entities</span>.<span class="title function_">add</span>(item)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// dataProcessor.js (WebWorker)</span></span><br><span class="line">self.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; type, data &#125; = event.<span class="property">data</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (type === <span class="string">&#x27;PROCESS_LARGE_DATASET&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> result = []</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨Workerä¸­è¿›è¡Œé‡è®¡ç®—</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; data.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> item = data[i]</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¤æ‚çš„æ•°æ®å¤„ç†</span></span><br><span class="line">      <span class="keyword">const</span> processed = <span class="title function_">complexCalculation</span>(item)</span><br><span class="line">      result.<span class="title function_">push</span>(processed)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å®šæœŸå‘é€è¿›åº¦æ›´æ–°</span></span><br><span class="line">      <span class="keyword">if</span> (i % <span class="number">1000</span> === <span class="number">0</span>) &#123;</span><br><span class="line">        self.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;PROGRESS_UPDATE&#x27;</span>,</span><br><span class="line">          <span class="attr">progress</span>: i / data.<span class="property">length</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    self.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;PROCESSING_COMPLETE&#x27;</span>,</span><br><span class="line">      <span class="attr">result</span>: result,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">complexCalculation</span>(<span class="params">item</span>) &#123;</span><br><span class="line">  <span class="comment">// æ‰§è¡Œå¤æ‚è®¡ç®—</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">position</span>: [item.<span class="property">x</span> * <span class="number">1.5</span>, item.<span class="property">y</span> * <span class="number">1.5</span>, item.<span class="property">z</span> * <span class="number">1.5</span>],</span><br><span class="line">    <span class="attr">color</span>: <span class="title function_">generateColor</span>(item.<span class="property">value</span>),</span><br><span class="line">    <span class="attr">properties</span>: <span class="title function_">processProperties</span>(item.<span class="property">attributes</span>),</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-è§†å£ä¼˜åŒ–"><a href="#3-è§†å£ä¼˜åŒ–" class="headerlink" title="3. è§†å£ä¼˜åŒ–"></a>3. è§†å£ä¼˜åŒ–</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼˜åŒ–è§†å£å’Œåˆ†è¾¨ç‡</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">optimizeForViewport</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> canvas = viewer.<span class="property">canvas</span></span><br><span class="line">  <span class="keyword">const</span> rect = canvas.<span class="title function_">getBoundingClientRect</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è°ƒæ•´ç”»å¸ƒåˆ†è¾¨ç‡</span></span><br><span class="line">  <span class="keyword">const</span> devicePixelRatio = <span class="variable language_">window</span>.<span class="property">devicePixelRatio</span> || <span class="number">1</span></span><br><span class="line">  <span class="keyword">const</span> displayWidth = rect.<span class="property">width</span></span><br><span class="line">  <span class="keyword">const</span> displayHeight = rect.<span class="property">height</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é™åˆ¶æœ€å¤§åˆ†è¾¨ç‡ä»¥æé«˜æ€§èƒ½</span></span><br><span class="line"><span class="keyword">const</span> maxPixelRatio = <span class="number">2</span></span><br><span class="line"><span class="keyword">const</span> actualPixelRatio = <span class="title class_">Math</span>.<span class="title function_">min</span>(devicePixelRatio, maxPixelRatio)</span><br><span class="line"></span><br><span class="line">canvas.<span class="property">width</span> = displayWidth _actualPixelRatio</span><br><span class="line">canvas.<span class="property">height</span> = displayHeight_ actualPixelRatio</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ›´æ–°WebGLè§†å£</span></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">context</span>.\_gl.<span class="title function_">viewport</span>(<span class="number">0</span>, <span class="number">0</span>, canvas.<span class="property">width</span>, canvas.<span class="property">height</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å“åº”çª—å£å¤§å°å˜åŒ–</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;resize&#x27;</span>, <span class="title function_">throttle</span>(optimizeForViewport, <span class="number">250</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 13. ç¼“å­˜ç­–ç•¥</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResourceCache</span> &#123;</span><br><span class="line"><span class="title function_">constructor</span>(<span class="params">maxSize = <span class="number">100</span></span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">cache</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">maxSize</span> = maxSize</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">get</span>(<span class="params">key</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">has</span>(key)) &#123;</span><br><span class="line"><span class="comment">// LRU: ç§»åˆ°æœ«å°¾</span></span><br><span class="line"><span class="keyword">const</span> value = <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">get</span>(key)</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">delete</span>(key)</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">set</span>(key, value)</span><br><span class="line"><span class="keyword">return</span> value</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">set</span>(<span class="params">key, value</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">has</span>(key)) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">delete</span>(key)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">cache</span>.<span class="property">size</span> &gt;= <span class="variable language_">this</span>.<span class="property">maxSize</span>) &#123;</span><br><span class="line"><span class="comment">// åˆ é™¤æœ€å°‘ä½¿ç”¨çš„é¡¹ç›®</span></span><br><span class="line"><span class="keyword">const</span> firstKey = <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">keys</span>().<span class="title function_">next</span>().<span class="property">value</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">delete</span>(firstKey)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">set</span>(key, value)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">clear</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">clear</span>()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> resourceCache = <span class="keyword">new</span> <span class="title class_">ResourceCache</span>(<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¼“å­˜çº¹ç†åŠ è½½</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">loadTextureWithCache</span>(<span class="params">url</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> cached = resourceCache.<span class="title function_">get</span>(url)</span><br><span class="line"><span class="keyword">if</span> (cached) &#123;</span><br><span class="line"><span class="keyword">return</span> cached</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> texture = <span class="keyword">await</span> <span class="title function_">loadTexture</span>(url)</span><br><span class="line">resourceCache.<span class="title function_">set</span>(url, texture)</span><br><span class="line"><span class="keyword">return</span> texture</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 14. æ€§èƒ½ç›‘æ§</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PerformanceMonitor</span> &#123;</span><br><span class="line"><span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">metrics</span> = &#123;</span><br><span class="line"><span class="attr">fps</span>: <span class="number">0</span>,</span><br><span class="line"><span class="attr">frameTime</span>: <span class="number">0</span>,</span><br><span class="line"><span class="attr">memoryUsage</span>: <span class="number">0</span>,</span><br><span class="line"><span class="attr">primitiveCount</span>: <span class="number">0</span>,</span><br><span class="line"><span class="attr">entityCount</span>: <span class="number">0</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lastTime</span> = performance.<span class="title function_">now</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">frameCount</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fpsUpdateInterval</span> = <span class="number">1000</span> <span class="comment">// 1ç§’æ›´æ–°ä¸€æ¬¡FPS</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">update</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> currentTime = performance.<span class="title function_">now</span>()</span><br><span class="line"><span class="keyword">const</span> deltaTime = currentTime - <span class="variable language_">this</span>.<span class="property">lastTime</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">frameCount</span>++</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (deltaTime &gt;= <span class="variable language_">this</span>.<span class="property">fpsUpdateInterval</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">fps</span> = <span class="title class_">Math</span>.<span class="title function_">round</span>((<span class="variable language_">this</span>.<span class="property">frameCount</span> * <span class="number">1000</span>) / deltaTime)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">frameTime</span> = deltaTime / <span class="variable language_">this</span>.<span class="property">frameCount</span></span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">frameCount</span> = <span class="number">0</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">lastTime</span> = currentTime</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ›´æ–°å…¶ä»–æŒ‡æ ‡</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">updateMemoryUsage</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">updateCounts</span>()</span><br><span class="line"></span><br><span class="line">      <span class="comment">// è§¦å‘æ€§èƒ½è­¦å‘Š</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">checkPerformance</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">updateMemoryUsage</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (performance.<span class="property">memory</span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">memoryUsage</span> = performance.<span class="property">memory</span>.<span class="property">usedJSHeapSize</span> / <span class="number">1024</span> / <span class="number">1024</span> <span class="comment">// MB</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">updateCounts</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">primitiveCount</span> = viewer.<span class="property">scene</span>.<span class="property">primitives</span>.<span class="property">length</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">entityCount</span> = viewer.<span class="property">entities</span>.<span class="property">values</span>.<span class="property">length</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">checkPerformance</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">fps</span> &lt; <span class="number">30</span>) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;æ€§èƒ½è­¦å‘Š: FPSè¿‡ä½&#x27;</span>, <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">fps</span>)</span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">suggestOptimizations</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">memoryUsage</span> &gt; <span class="number">500</span>) &#123;</span><br><span class="line">      <span class="comment">// 500MB</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;å†…å­˜è­¦å‘Š: å†…å­˜ä½¿ç”¨è¿‡é«˜&#x27;</span>, <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">memoryUsage</span>, <span class="string">&#x27;MB&#x27;</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">suggestMemoryOptimizations</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">suggestOptimizations</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> suggestions = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">entityCount</span> &gt; <span class="number">10000</span>) &#123;</span><br><span class="line">      suggestions.<span class="title function_">push</span>(<span class="string">&#x27;å®ä½“æ•°é‡è¿‡å¤šï¼Œè€ƒè™‘ä½¿ç”¨Primitiveæˆ–èšç±»&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">primitiveCount</span> &gt; <span class="number">100</span>) &#123;</span><br><span class="line">      suggestions.<span class="title function_">push</span>(<span class="string">&#x27;å›¾å…ƒæ•°é‡è¿‡å¤šï¼Œè€ƒè™‘åˆå¹¶å‡ ä½•ä½“&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!viewer.<span class="property">scene</span>.<span class="property">requestRenderMode</span>) &#123;</span><br><span class="line">      suggestions.<span class="title function_">push</span>(<span class="string">&#x27;å¯ç”¨æŒ‰éœ€æ¸²æŸ“æ¨¡å¼&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ€§èƒ½ä¼˜åŒ–å»ºè®®:&#x27;</span>, suggestions)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">suggestMemoryOptimizations</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å†…å­˜ä¼˜åŒ–å»ºè®®:&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;- æ¸…ç†æœªä½¿ç”¨çš„å®ä½“å’Œå›¾å…ƒ&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;- å‡å°‘é«˜åˆ†è¾¨ç‡çº¹ç†çš„ä½¿ç”¨&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;- å¯ç”¨ç“¦ç‰‡ç¼“å­˜é™åˆ¶&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;- æ£€æŸ¥å†…å­˜æ³„æ¼&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">getReport</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">...<span class="variable language_">this</span>.<span class="property">metrics</span>,</span><br><span class="line"><span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toISOString</span>(),</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> performanceMonitor = <span class="keyword">new</span> <span class="title class_">PerformanceMonitor</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨æ¸²æŸ“å¾ªç¯ä¸­æ›´æ–°æ€§èƒ½ç›‘æ§</span></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">postRender</span>.<span class="title function_">addEventListener</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">performanceMonitor.<span class="title function_">update</span>()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ˜¾ç¤ºæ€§èƒ½ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">displayPerformanceInfo</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> report = performanceMonitor.<span class="title function_">getReport</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> infoDiv = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;performance-info&#x27;</span>) || <span class="title function_">createPerformanceInfoDiv</span>()</span><br><span class="line">infoDiv.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;div&gt;FPS: <span class="subst">$&#123;report.fps&#125;</span>&lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;div&gt;å¸§æ—¶é—´: <span class="subst">$&#123;report.frameTime.toFixed(<span class="number">2</span>)&#125;</span>ms&lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;div&gt;å†…å­˜ä½¿ç”¨: <span class="subst">$&#123;report.memoryUsage.toFixed(<span class="number">2</span>)&#125;</span>MB&lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;div&gt;å›¾å…ƒæ•°é‡: <span class="subst">$&#123;report.primitiveCount&#125;</span>&lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;div&gt;å®ä½“æ•°é‡: <span class="subst">$&#123;report.entityCount&#125;</span>&lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createPerformanceInfoDiv</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> div = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">div.<span class="property">id</span> = <span class="string">&#x27;performance-info&#x27;</span></span><br><span class="line">div.<span class="property">style</span>.<span class="property">cssText</span> = <span class="string">`position: absolute;</span></span><br><span class="line"><span class="string">    top: 10px;</span></span><br><span class="line"><span class="string">    right: 10px;</span></span><br><span class="line"><span class="string">    background: rgba(0,0,0,0.8);</span></span><br><span class="line"><span class="string">    color: white;</span></span><br><span class="line"><span class="string">    padding: 10px;</span></span><br><span class="line"><span class="string">    border-radius: 5px;</span></span><br><span class="line"><span class="string">    font-family: monospace;</span></span><br><span class="line"><span class="string">    font-size: 12px;</span></span><br><span class="line"><span class="string">    z-index: 1000;</span></span><br><span class="line"><span class="string"> `</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(div)</span><br><span class="line"><span class="keyword">return</span> div</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šæœŸæ›´æ–°æ˜¾ç¤º</span></span><br><span class="line"><span class="built_in">setInterval</span>(displayPerformanceInfo, <span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 15. æœ€ä½³å®è·µæ€»ç»“</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PERFORMANCE_BEST_PRACTICES</span> = &#123;</span><br><span class="line"><span class="comment">// æ¸²æŸ“ä¼˜åŒ–</span></span><br><span class="line"><span class="attr">rendering</span>: [<span class="string">&#x27;å¯ç”¨æŒ‰éœ€æ¸²æŸ“æ¨¡å¼&#x27;</span>, <span class="string">&#x27;ä½¿ç”¨é€‚å½“çš„LODè®¾ç½®&#x27;</span>, <span class="string">&#x27;å¯ç”¨è§†é”¥å‰”é™¤&#x27;</span>, <span class="string">&#x27;åˆç†ä½¿ç”¨åå¤„ç†æ•ˆæœ&#x27;</span>],</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ä½“ä¼˜åŒ–</span></span><br><span class="line"><span class="attr">entities</span>: [</span><br><span class="line"><span class="string">&#x27;å¤§é‡å‡ ä½•ä½“ä½¿ç”¨Primitive&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;å¯ç”¨å®ä½“èšç±»&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;è®¾ç½®è·ç¦»æ˜¾ç¤ºæ¡ä»¶&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;ä½¿ç”¨ç®€å•æè´¨è€Œéå¤æ‚çº¹ç†&#x27;</span>,</span><br><span class="line">],</span><br><span class="line"></span><br><span class="line"><span class="comment">// å†…å­˜ç®¡ç†</span></span><br><span class="line"><span class="attr">memory</span>: [</span><br><span class="line"><span class="string">&#x27;å®šæœŸæ¸…ç†æœªä½¿ç”¨çš„èµ„æº&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;é™åˆ¶åŒæ—¶åŠ è½½çš„æ•°æ®é‡&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;ä½¿ç”¨å¯¹è±¡æ± é‡ç”¨èµ„æº&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ&#x27;</span>,</span><br><span class="line">],</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ•°æ®åŠ è½½</span></span><br><span class="line"><span class="attr">dataLoading</span>: [</span><br><span class="line"><span class="string">&#x27;å¼‚æ­¥åˆ†æ‰¹åŠ è½½å¤§æ•°æ®é›†&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;ä½¿ç”¨WebWorkerå¤„ç†å¤æ‚è®¡ç®—&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;å®ç°èµ„æºç¼“å­˜ç­–ç•¥&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;å‹ç¼©å’Œä¼˜åŒ–æ•°æ®æ ¼å¼&#x27;</span>,</span><br><span class="line">],</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨æˆ·äº¤äº’</span></span><br><span class="line"><span class="attr">interaction</span>: [<span class="string">&#x27;èŠ‚æµé«˜é¢‘äº‹ä»¶&#x27;</span>, <span class="string">&#x27;é˜²æŠ–ç”¨æˆ·è¾“å…¥&#x27;</span>, <span class="string">&#x27;å¼‚æ­¥å¤„ç†UIæ›´æ–°&#x27;</span>, <span class="string">&#x27;æä¾›åŠ è½½è¿›åº¦åé¦ˆ&#x27;</span>],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Cesiumæ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ:&#x27;</span>, <span class="variable constant_">PERFORMANCE_BEST_PRACTICES</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><hr><h2 id="ğŸ“š-æ€»ç»“"><a href="#ğŸ“š-æ€»ç»“" class="headerlink" title="ğŸ“š æ€»ç»“"></a>ğŸ“š æ€»ç»“</h2><p>æœ¬æŒ‡å—æ¶µç›–äº†Cesiumç¦»çº¿å¼€å‘çš„æ‰€æœ‰æ ¸å¿ƒæ¦‚å¿µå’Œè¯¦ç»†å±æ€§è¯´æ˜ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li><strong>ç¯å¢ƒé…ç½®</strong>: å®Œæ•´çš„ç¦»çº¿å¼€å‘ç¯å¢ƒæ­å»º</li><li><strong>Vieweré…ç½®</strong>: è¯¦ç»†çš„æ„é€ å‚æ•°å’Œæ¸²æŸ“é€‰é¡¹</li><li><strong>åæ ‡ç³»ç»Ÿ</strong>: å®Œæ•´çš„åæ ‡è½¬æ¢å’Œæ•°å­¦è¿ç®—</li><li><strong>å®ä½“ç³»ç»Ÿ</strong>: æ‰€æœ‰å›¾å½¢ç±»å‹çš„è¯¦ç»†å±æ€§</li><li><strong>å½±åƒåœ°å½¢</strong>: å„ç§æä¾›è€…çš„é…ç½®é€‰é¡¹</li><li><strong>ç›¸æœºæ§åˆ¶</strong>: å®Œæ•´çš„ç›¸æœºæ“ä½œæ–¹æ³•</li><li><strong>äº‹ä»¶å¤„ç†</strong>: å±å¹•ç©ºé—´äº‹ä»¶çš„è¯¦ç»†å¤„ç†</li><li><strong>æè´¨ç³»ç»Ÿ</strong>: å„ç§å†…ç½®å’Œè‡ªå®šä¹‰æè´¨</li><li><strong>åŠ¨ç”»ç³»ç»Ÿ</strong>: å±æ€§åŠ¨ç”»å’Œæ—¶é—´æ§åˆ¶</li><li><strong>å‡ ä½•å›¾å…ƒ</strong>: ä½çº§åˆ«å›¾å½¢æ¸²æŸ“</li><li><strong>åœºæ™¯æ§åˆ¶</strong>: åœºæ™¯å’Œåœ°çƒçš„é«˜çº§é…ç½®</li><li><strong>æ•°æ®æº</strong>: å„ç§æ ¼å¼æ•°æ®çš„åŠ è½½å’Œå¤„ç†</li><li><strong>æ—¶é—´ç³»ç»Ÿ</strong>: æ—¶é—´æ“ä½œå’ŒåŠ¨ç”»æ§åˆ¶</li><li><strong>æ€§èƒ½ä¼˜åŒ–</strong>: å…¨é¢çš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</li></ul><hr><h3 id="ğŸ“š-æœ€ä½³å®è·µæ€»ç»“"><a href="#ğŸ“š-æœ€ä½³å®è·µæ€»ç»“" class="headerlink" title="ğŸ“š æœ€ä½³å®è·µæ€»ç»“"></a>ğŸ“š æœ€ä½³å®è·µæ€»ç»“</h3><h4 id="ğŸ¯-æ€§èƒ½ä¼˜åŒ–åŸåˆ™"><a href="#ğŸ¯-æ€§èƒ½ä¼˜åŒ–åŸåˆ™" class="headerlink" title="ğŸ¯ æ€§èƒ½ä¼˜åŒ–åŸåˆ™"></a>ğŸ¯ æ€§èƒ½ä¼˜åŒ–åŸåˆ™</h4><ol><li><strong>æŒ‰éœ€æ¸²æŸ“</strong>: åªåœ¨å¿…è¦æ—¶è§¦å‘æ¸²æŸ“</li><li><strong>LODç®¡ç†</strong>: æ ¹æ®è·ç¦»æ˜¾ç¤ºä¸åŒç²¾åº¦</li><li><strong>å†…å­˜ç®¡ç†</strong>: å®šæœŸæ¸…ç†æœªä½¿ç”¨èµ„æº</li><li><strong>äº‹ä»¶ä¼˜åŒ–</strong>: ä½¿ç”¨èŠ‚æµå’Œå§”æ‰˜</li><li><strong>å¼‚æ­¥å¤„ç†</strong>: é¿å…é˜»å¡ä¸»çº¿ç¨‹</li></ol><h4 id="ğŸ“Š-æ€§èƒ½ç›‘æ§æŒ‡æ ‡"><a href="#ğŸ“Š-æ€§èƒ½ç›‘æ§æŒ‡æ ‡" class="headerlink" title="ğŸ“Š æ€§èƒ½ç›‘æ§æŒ‡æ ‡"></a>ğŸ“Š æ€§èƒ½ç›‘æ§æŒ‡æ ‡</h4><table><thead><tr><th>æŒ‡æ ‡</th><th>ç›®æ ‡å€¼</th><th>ç›‘æ§æ–¹æ³•</th></tr></thead><tbody><tr><td>FPS</td><td>â‰¥30</td><td>å®æ—¶ç›‘æ§</td></tr><tr><td>å†…å­˜ä½¿ç”¨</td><td>&lt;80%</td><td>å®šæœŸæ£€æŸ¥</td></tr><tr><td>å“åº”æ—¶é—´</td><td>&lt;100ms</td><td>ç”¨æˆ·äº¤äº’æµ‹è¯•</td></tr><tr><td>åŠ è½½æ—¶é—´</td><td>&lt;3s</td><td>ç½‘ç»œç›‘æ§</td></tr></tbody></table><h4 id="ğŸ”§-é…ç½®å»ºè®®"><a href="#ğŸ”§-é…ç½®å»ºè®®" class="headerlink" title="ğŸ”§ é…ç½®å»ºè®®"></a>ğŸ”§ é…ç½®å»ºè®®</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ€§èƒ½ä¼˜åŒ–é…ç½®</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PERFORMANCE_CONFIG</span> = &#123;</span><br><span class="line">  <span class="comment">// æ¸²æŸ“è®¾ç½®</span></span><br><span class="line">  <span class="attr">REQUEST_RENDER_MODE</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">MAXIMUM_RENDER_TIME_CHANGE</span>: <span class="number">0.0</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// LODè®¾ç½®</span></span><br><span class="line">  <span class="attr">MAXIMUM_SCREEN_SPACE_ERROR</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">TILE_CACHE_SIZE</span>: <span class="number">200</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å†…å­˜ç®¡ç†</span></span><br><span class="line">  <span class="attr">CLEANUP_INTERVAL</span>: <span class="number">30000</span>,</span><br><span class="line">  <span class="attr">MEMORY_WARNING_THRESHOLD</span>: <span class="number">0.8</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// äº‹ä»¶ä¼˜åŒ–</span></span><br><span class="line">  <span class="attr">THROTTLE_INTERVAL</span>: <span class="number">100</span>,</span><br><span class="line">  <span class="attr">HOVER_THROTTLE</span>: <span class="number">25</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¼‚æ­¥åŠ è½½</span></span><br><span class="line">  <span class="attr">BATCH_SIZE</span>: <span class="number">1000</span>,</span><br><span class="line">  <span class="attr">PROGRESS_UPDATE_INTERVAL</span>: <span class="number">1000</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ğŸš€-å¼€å‘å»ºè®®"><a href="#ğŸš€-å¼€å‘å»ºè®®" class="headerlink" title="ğŸš€ å¼€å‘å»ºè®®"></a>ğŸš€ å¼€å‘å»ºè®®</h4><ol><li><p><strong>å¼€å‘é˜¶æ®µ</strong></p><ul><li>ä½¿ç”¨æ€§èƒ½ç›‘æ§å·¥å…·</li><li>å®šæœŸæ£€æŸ¥å†…å­˜ä½¿ç”¨</li><li>æµ‹è¯•å¤§æ•°æ®é‡åœºæ™¯</li></ul></li><li><p><strong>ç”Ÿäº§ç¯å¢ƒ</strong></p><ul><li>å¯ç”¨æ‰€æœ‰ä¼˜åŒ–é€‰é¡¹</li><li>ç›‘æ§å…³é”®æ€§èƒ½æŒ‡æ ‡</li><li>å‡†å¤‡é™çº§æ–¹æ¡ˆ</li></ul></li><li><p><strong>ç»´æŠ¤é˜¶æ®µ</strong></p><ul><li>å®šæœŸæ¸…ç†ç¼“å­˜</li><li>ç›‘æ§ç”¨æˆ·åé¦ˆ</li><li>æŒç»­ä¼˜åŒ–æ€§èƒ½</li></ul></li></ol><h4 id="âš ï¸-æ³¨æ„äº‹é¡¹"><a href="#âš ï¸-æ³¨æ„äº‹é¡¹" class="headerlink" title="âš ï¸ æ³¨æ„äº‹é¡¹"></a>âš ï¸ æ³¨æ„äº‹é¡¹</h4><ol><li><strong>å…¼å®¹æ€§</strong>: ç¡®ä¿ä¼˜åŒ–æ–¹æ¡ˆåœ¨ä¸åŒæµè§ˆå™¨ä¸­æ­£å¸¸å·¥ä½œ</li><li><strong>é™çº§å¤„ç†</strong>: æä¾›ä¼˜åŒ–å¤±è´¥æ—¶çš„é™çº§æ–¹æ¡ˆ</li><li><strong>ç”¨æˆ·ä½“éªŒ</strong>: å¹³è¡¡æ€§èƒ½ä¼˜åŒ–å’Œç”¨æˆ·ä½“éªŒ</li><li><strong>å†…å­˜æ³„æ¼</strong>: æ³¨æ„åŠæ—¶æ¸…ç†äº‹ä»¶ç›‘å¬å™¨å’Œç¼“å­˜</li></ol><h4 id="ğŸ”®-æœªæ¥å‘å±•æ–¹å‘"><a href="#ğŸ”®-æœªæ¥å‘å±•æ–¹å‘" class="headerlink" title="ğŸ”® æœªæ¥å‘å±•æ–¹å‘"></a>ğŸ”® æœªæ¥å‘å±•æ–¹å‘</h4><ol><li><strong>WebGPU</strong>: åˆ©ç”¨æ–°ä¸€ä»£å›¾å½¢API</li><li><strong>è™šæ‹ŸåŒ–</strong>: åªæ¸²æŸ“å¯è§åŒºåŸŸ</li><li><strong>AIä¼˜åŒ–</strong>: æ™ºèƒ½é¢„æµ‹ç”¨æˆ·è¡Œä¸º</li><li><strong>è¾¹ç¼˜è®¡ç®—</strong>: åˆ†å¸ƒå¼æ¸²æŸ“</li></ol><hr><p>è¿™ä»½æŒ‡å—ä¸ºç¦»çº¿Cesiumå¼€å‘æä¾›äº†å®Œæ•´çš„å‚è€ƒï¼Œæ¯ä¸ªå±æ€§éƒ½åŒ…å«äº†ä½œç”¨è¯´æ˜ã€é»˜è®¤å€¼ã€ä½¿ç”¨ç¤ºä¾‹ï¼Œå¸®åŠ©å¼€å‘è€…åœ¨æ— ç½‘ç»œç¯å¢ƒä¸‹ä¹Ÿèƒ½é«˜æ•ˆå¼€å‘Cesiumåº”ç”¨ã€‚</p><h3 id="æ—¶é—´è½´ä¸åŠ¨ç”»ï¼ˆè¿›é˜¶ç¤ºä¾‹ï¼‰"><a href="#æ—¶é—´è½´ä¸åŠ¨ç”»ï¼ˆè¿›é˜¶ç¤ºä¾‹ï¼‰" class="headerlink" title="æ—¶é—´è½´ä¸åŠ¨ç”»ï¼ˆè¿›é˜¶ç¤ºä¾‹ï¼‰"></a>æ—¶é—´è½´ä¸åŠ¨ç”»ï¼ˆè¿›é˜¶ç¤ºä¾‹ï¼‰</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¾ç½®æ—¶é—´è½´ä¸é€Ÿç‡</span></span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">startTime</span> = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&#x27;2024-01-01T00:00:00Z&#x27;</span>))</span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">stopTime</span> = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&#x27;2024-01-01T01:00:00Z&#x27;</span>))</span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">currentTime</span> = viewer.<span class="property">clock</span>.<span class="property">startTime</span>.<span class="title function_">clone</span>()</span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">clockRange</span> = <span class="title class_">Cesium</span>.<span class="property">ClockRange</span>.<span class="property">LOOP_STOP</span> <span class="comment">// å¾ªç¯</span></span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">multiplier</span> = <span class="number">10</span> <span class="comment">// æ—¶é—´åŠ é€Ÿ10å€</span></span><br><span class="line">viewer.<span class="property">timeline</span>.<span class="title function_">zoomTo</span>(viewer.<span class="property">clock</span>.<span class="property">startTime</span>, viewer.<span class="property">clock</span>.<span class="property">stopTime</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŸºäºæ—¶åºå˜åŒ–å®ä½“å±æ€§</span></span><br><span class="line"><span class="keyword">const</span> movingPoint = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">CallbackProperty</span>(<span class="function">(<span class="params">time</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> seconds = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">secondsDifference</span>(time, viewer.<span class="property">clock</span>.<span class="property">startTime</span>)</span><br><span class="line">    <span class="keyword">const</span> lon = <span class="number">116.4</span> + seconds * <span class="number">0.0001</span></span><br><span class="line">    <span class="keyword">const</span> lat = <span class="number">39.9</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(lon, lat)</span><br><span class="line">  &#125;, <span class="literal">false</span>),</span><br><span class="line">  <span class="attr">point</span>: &#123; <span class="attr">pixelSize</span>: <span class="number">8</span>, <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span> &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><hr><h2 id="å‡ ä½•å›¾å…ƒï¼ˆä½çº§-Primitiveï¼‰å®æˆ˜"><a href="#å‡ ä½•å›¾å…ƒï¼ˆä½çº§-Primitiveï¼‰å®æˆ˜" class="headerlink" title="å‡ ä½•å›¾å…ƒï¼ˆä½çº§ Primitiveï¼‰å®æˆ˜"></a>å‡ ä½•å›¾å…ƒï¼ˆä½çº§ Primitiveï¼‰å®æˆ˜</h2><p>å½“ Entity æ•°é‡å·¨å¤§ä¸”æ ·å¼ç»Ÿä¸€æ—¶ï¼Œä½¿ç”¨ Primitive å¯æ˜¾è‘—é™ä½ç®¡ç†å¼€é”€ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨ GroundPolylinePrimitive æ‰¹é‡ç»˜åˆ¶è´´åœ°çº¿</span></span><br><span class="line"><span class="keyword">await</span> <span class="title class_">Cesium</span>.<span class="property">GroundPolylinePrimitive</span>.<span class="title function_">initializeTerrainHeights</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> instances = lines.<span class="title function_">map</span>(</span><br><span class="line">  <span class="function">(<span class="params">l</span>) =&gt;</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">GeometryInstance</span>(&#123;</span><br><span class="line">      <span class="attr">geometry</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">GroundPolylineGeometry</span>(&#123;</span><br><span class="line">        <span class="attr">positions</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegreesArray</span>(l.<span class="title function_">flat</span>()),</span><br><span class="line">        <span class="attr">width</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">arcType</span>: <span class="title class_">Cesium</span>.<span class="property">ArcType</span>.<span class="property">GEODESIC</span>,</span><br><span class="line">      &#125;),</span><br><span class="line">    &#125;),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> primitive = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">GroundPolylinePrimitive</span>(&#123;</span><br><span class="line">  <span class="attr">geometryInstances</span>: instances,</span><br><span class="line">  <span class="attr">appearance</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PolylineMaterialAppearance</span>(&#123;</span><br><span class="line">    <span class="attr">material</span>: <span class="title class_">Cesium</span>.<span class="property">Material</span>.<span class="title function_">fromType</span>(<span class="string">&#x27;Color&#x27;</span>, &#123; <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">CYAN</span>.<span class="title function_">withAlpha</span>(<span class="number">0.7</span>) &#125;),</span><br><span class="line">  &#125;),</span><br><span class="line">&#125;)</span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">groundPrimitives</span>.<span class="title function_">add</span>(primitive)</span><br></pre></td></tr></table></figure><p>è¦ç‚¹ï¼š</p><ul><li>ä½¿ç”¨å•ä¸€æè´¨ä¸ç»Ÿä¸€å®½åº¦ï¼Œä¾¿äºåˆå¹¶ã€‚</li><li>éœ€è¦è´´åœ°&#x2F;åœ°å½¢æ”¯æŒæ—¶ï¼Œä¼˜å…ˆ GroundPolyline ç³»åˆ—ã€‚</li></ul><hr><h2 id="å±å¹•ç©ºé—´äº‹ä»¶æœ€ä½³å®è·µ"><a href="#å±å¹•ç©ºé—´äº‹ä»¶æœ€ä½³å®è·µ" class="headerlink" title="å±å¹•ç©ºé—´äº‹ä»¶æœ€ä½³å®è·µ"></a>å±å¹•ç©ºé—´äº‹ä»¶æœ€ä½³å®è·µ</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// èŠ‚æµ + å‘½ä¸­ç¼“å­˜ï¼Œå‡å°‘ pick é¢‘ç‡</span></span><br><span class="line"><span class="keyword">const</span> handler = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ScreenSpaceEventHandler</span>(viewer.<span class="property">canvas</span>)</span><br><span class="line"><span class="keyword">let</span> lastPickId = <span class="literal">null</span></span><br><span class="line"><span class="keyword">let</span> lastPickTime = <span class="number">0</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PICK_THROTTLE</span> = <span class="number">16</span> <span class="comment">// ms</span></span><br><span class="line"></span><br><span class="line">handler.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">movement</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> now = performance.<span class="title function_">now</span>()</span><br><span class="line">  <span class="keyword">if</span> (now - lastPickTime &lt; <span class="variable constant_">PICK_THROTTLE</span>) <span class="keyword">return</span></span><br><span class="line">  lastPickTime = now</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> picked = viewer.<span class="property">scene</span>.<span class="title function_">pick</span>(movement.<span class="property">endPosition</span>)</span><br><span class="line">  <span class="keyword">const</span> id = picked?.<span class="property">id</span> || <span class="literal">null</span></span><br><span class="line">  <span class="keyword">if</span> (id === lastPickId) <span class="keyword">return</span></span><br><span class="line">  lastPickId = id</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ›´æ–° UI æˆ– Tooltip</span></span><br><span class="line">  <span class="keyword">if</span> (id) &#123;</span><br><span class="line">    <span class="comment">// showTooltip(...)</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// hideTooltip()</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">MOUSE_MOVE</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¸…ç†</span></span><br><span class="line"><span class="comment">// handler.destroy()</span></span><br></pre></td></tr></table></figure><p>å»ºè®®ï¼š</p><ul><li>é¼ æ ‡ç§»åŠ¨äº‹ä»¶åˆå¹¶&#x2F;èŠ‚æµï¼Œé¿å…æ¯å¸§ pickã€‚</li><li>ä½¿ç”¨ <code>scene.pickPositionSupported</code> åˆ¤æ–­æ˜¯å¦æ”¯æŒæ·±åº¦æ‹¾å–ï¼Œå†å†³å®š <code>pickPosition</code> æ–¹æ¡ˆã€‚</li></ul><hr><h2 id="å¤§è§„æ¨¡å®ä½“ç®¡ç†ç­–ç•¥"><a href="#å¤§è§„æ¨¡å®ä½“ç®¡ç†ç­–ç•¥" class="headerlink" title="å¤§è§„æ¨¡å®ä½“ç®¡ç†ç­–ç•¥"></a>å¤§è§„æ¨¡å®ä½“ç®¡ç†ç­–ç•¥</h2><p>é’ˆå¯¹ 10w+ ç‚¹&#x2F;çº¿ï¼š</p><ul><li>æ‰¹é‡åˆ›å»ºï¼šå…ˆæ„é€ æ•°ç»„å†ä¸€æ¬¡æ€§ <code>viewer.entities.add(array)</code>ã€‚</li><li>åˆ†æ‰¹åŠ è½½ï¼šåˆ‡ç‰‡ï¼ˆç©ºé—´ç½‘æ ¼æˆ–å››å‰æ ‘ï¼‰+ åˆ†æ®µè¯·æ±‚ã€‚</li><li>å¯è§æ€§è£å‰ªï¼š<ul><li>è·ç¦»é˜ˆå€¼éšè—è¿œå¤„å®ä½“ï¼›</li><li>å±å¹•ç©ºé—´å¯†åº¦æ§åˆ¶ï¼ˆæŒ‰åƒç´ å¯†åº¦æŠ½ç¨€ï¼‰ã€‚</li></ul></li><li>é™çº§æ¸²æŸ“ï¼šè¿œè·ç¦»æ”¹ç”¨ Billboards æˆ– Primitiveï¼›è¿‘è·ç¦»å†åˆ‡æ¢è¯¦ç»† Entityã€‚</li><li>Worker å¹¶è¡Œï¼šå‡ ä½•è®¡ç®—ã€ç­›é€‰åœ¨ Worker å†…å®Œæˆï¼Œä¸»çº¿ç¨‹ä»…åšç»˜åˆ¶ã€‚</li></ul><p>ç¤ºä¾‹ï¼šåˆ†æ‰¹+æŠ½ç¨€</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">addEntitiesInChunks</span>(<span class="params">data, chunkSize = <span class="number">2000</span></span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; data.<span class="property">length</span>; i += chunkSize) &#123;</span><br><span class="line">    <span class="keyword">const</span> chunk = data.<span class="title function_">slice</span>(i, i + chunkSize)</span><br><span class="line">    <span class="keyword">const</span> batch = chunk.<span class="title function_">map</span>(<span class="function">(<span class="params">d</span>) =&gt;</span> (&#123;</span><br><span class="line">      <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(d.<span class="property">lon</span>, d.<span class="property">lat</span>),</span><br><span class="line">      <span class="attr">point</span>: &#123; <span class="attr">pixelSize</span>: <span class="number">6</span>, <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">SKYBLUE</span> &#125;,</span><br><span class="line">    &#125;))</span><br><span class="line">    viewer.<span class="property">entities</span>.<span class="title function_">add</span>(batch)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">visibilityCullByDistance</span>(<span class="params">camera, entities, maxDistance = <span class="number">50000</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> camPos = camera.<span class="property">positionWC</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> e <span class="keyword">of</span> entities.<span class="property">values</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> pos = e.<span class="property">position</span>?.<span class="title function_">getValue</span>(viewer.<span class="property">clock</span>.<span class="property">currentTime</span>)</span><br><span class="line">    <span class="keyword">if</span> (!pos) <span class="keyword">continue</span></span><br><span class="line">    e.<span class="property">show</span> = <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">distance</span>(camPos, pos) &lt; maxDistance</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æç¤ºï¼šå½“å®ä½“è¾¾åˆ°ç“¶é¢ˆæ—¶ï¼Œè¿ç§»åˆ° Primitiveï¼ˆå¦‚ <code>GroundPolylinePrimitive</code> æˆ– <code>PrimitiveCollection</code>ï¼‰é€šå¸¸æ”¶ç›Šæ›´å¤§ã€‚</p><hr><h2 id="ğŸ¨-è‡ªå®šä¹‰åå¤„ç†ï¼ˆPostProcessStageï¼‰"><a href="#ğŸ¨-è‡ªå®šä¹‰åå¤„ç†ï¼ˆPostProcessStageï¼‰" class="headerlink" title="ğŸ¨ è‡ªå®šä¹‰åå¤„ç†ï¼ˆPostProcessStageï¼‰"></a>ğŸ¨ è‡ªå®šä¹‰åå¤„ç†ï¼ˆPostProcessStageï¼‰</h2><h3 id="1-å•ä¸€åå¤„ç†é˜¶æ®µï¼ˆEdge-Detect-ç¤ºä¾‹ï¼‰"><a href="#1-å•ä¸€åå¤„ç†é˜¶æ®µï¼ˆEdge-Detect-ç¤ºä¾‹ï¼‰" class="headerlink" title="1) å•ä¸€åå¤„ç†é˜¶æ®µï¼ˆEdge Detect ç¤ºä¾‹ï¼‰"></a>1) å•ä¸€åå¤„ç†é˜¶æ®µï¼ˆEdge Detect ç¤ºä¾‹ï¼‰</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è‡ªå®šä¹‰è¾¹ç¼˜æ£€æµ‹åå¤„ç†ï¼ˆç‰‡å…ƒç€è‰²å™¨ï¼‰</span></span><br><span class="line"><span class="keyword">const</span> edgeFrag = <span class="string">`</span></span><br><span class="line"><span class="string">  uniform sampler2D colorTexture;</span></span><br><span class="line"><span class="string">  uniform vec2 texelStep;</span></span><br><span class="line"><span class="string">  varying vec2 v_textureCoordinates;</span></span><br><span class="line"><span class="string">  void main() &#123;</span></span><br><span class="line"><span class="string">    vec3 tc = texture2D(colorTexture, v_textureCoordinates).rgb;</span></span><br><span class="line"><span class="string">    vec3 tx = texture2D(colorTexture, v_textureCoordinates + vec2(texelStep.x, 0.0)).rgb;</span></span><br><span class="line"><span class="string">    vec3 ty = texture2D(colorTexture, v_textureCoordinates + vec2(0.0, texelStep.y)).rgb;</span></span><br><span class="line"><span class="string">    float diff = length(tc - tx) + length(tc - ty);</span></span><br><span class="line"><span class="string">    float edge = step(0.15, diff);</span></span><br><span class="line"><span class="string">    gl_FragColor = vec4(vec3(edge), 1.0);</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="keyword">const</span> edgeStage = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PostProcessStage</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;edgeStage&#x27;</span>,</span><br><span class="line">  <span class="attr">fragmentShader</span>: edgeFrag,</span><br><span class="line">  <span class="attr">uniforms</span>: &#123;</span><br><span class="line">    <span class="attr">texelStep</span>: <span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">1.0</span> / viewer.<span class="property">canvas</span>.<span class="property">width</span>, <span class="number">1.0</span> / viewer.<span class="property">canvas</span>.<span class="property">height</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">postProcessStages</span>.<span class="title function_">add</span>(edgeStage)</span><br><span class="line">edgeStage.<span class="property">enabled</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="2-ç»„åˆåå¤„ç†ï¼ˆCompositeï¼šBloom-è‡ªå®šä¹‰ï¼‰"><a href="#2-ç»„åˆåå¤„ç†ï¼ˆCompositeï¼šBloom-è‡ªå®šä¹‰ï¼‰" class="headerlink" title="2) ç»„åˆåå¤„ç†ï¼ˆCompositeï¼šBloom + è‡ªå®šä¹‰ï¼‰"></a>2) ç»„åˆåå¤„ç†ï¼ˆCompositeï¼šBloom + è‡ªå®šä¹‰ï¼‰</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bloom = viewer.<span class="property">scene</span>.<span class="property">postProcessStages</span>.<span class="property">bloom</span></span><br><span class="line">bloom.<span class="property">enabled</span> = <span class="literal">true</span></span><br><span class="line">bloom.<span class="property">uniforms</span>.<span class="property">glowOnly</span> = <span class="literal">false</span></span><br><span class="line">bloom.<span class="property">uniforms</span>.<span class="property">contrast</span> = <span class="number">128</span></span><br><span class="line">bloom.<span class="property">uniforms</span>.<span class="property">brightness</span> = -<span class="number">0.3</span></span><br><span class="line">bloom.<span class="property">uniforms</span>.<span class="property">delta</span> = <span class="number">1.0</span></span><br><span class="line">bloom.<span class="property">uniforms</span>.<span class="property">sigma</span> = <span class="number">2.0</span></span><br><span class="line">bloom.<span class="property">uniforms</span>.<span class="property">stepSize</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> toneMapFrag = <span class="string">`</span></span><br><span class="line"><span class="string">  uniform sampler2D colorTexture; varying vec2 v_textureCoordinates;</span></span><br><span class="line"><span class="string">  void main()&#123; vec3 col = texture2D(colorTexture, v_textureCoordinates).rgb;</span></span><br><span class="line"><span class="string">    col = col / (col + vec3(1.0)); gl_FragColor = vec4(col, 1.0);</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="keyword">const</span> toneMapStage = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PostProcessStage</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;toneMap&#x27;</span>, <span class="attr">fragmentShader</span>: toneMapFrag &#125;)</span><br><span class="line"><span class="keyword">const</span> composite = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PostProcessStageComposite</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;customComposite&#x27;</span>,</span><br><span class="line">  <span class="attr">stages</span>: [toneMapStage, bloom],</span><br><span class="line">&#125;)</span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">postProcessStages</span>.<span class="title function_">add</span>(composite)</span><br></pre></td></tr></table></figure><hr><h2 id="ğŸ§ª-Shader-ä¸-czm-å†…ç½®é€ŸæŸ¥ï¼ˆç²¾é€‰ï¼‰"><a href="#ğŸ§ª-Shader-ä¸-czm-å†…ç½®é€ŸæŸ¥ï¼ˆç²¾é€‰ï¼‰" class="headerlink" title="ğŸ§ª Shader ä¸ czm å†…ç½®é€ŸæŸ¥ï¼ˆç²¾é€‰ï¼‰"></a>ğŸ§ª Shader ä¸ czm å†…ç½®é€ŸæŸ¥ï¼ˆç²¾é€‰ï¼‰</h2><ul><li>czm å†…ç½®ï¼š<code>czm_frameNumber</code>, <code>czm_pixelRatio</code>, <code>czm_model/view/projection</code>, <code>czm_inverseViewProjection</code>, <code>czm_eyePosition</code>, <code>czm_geodeticSurfaceNormal</code>, <code>czm_unpackDepth</code>, <code>czm_morphTime</code></li><li>Fabric æç¤ºï¼šçº¹ç†ç”¨ <code>sampler2D</code>ï¼Œæ—¶é—´é©±åŠ¨ç»Ÿä¸€ç”¨ <code>czm_frameNumber</code> æˆ– <code>time</code>ï¼Œé€æ˜è®¾ç½® <code>translucent</code></li></ul><hr><h2 id="â›°ï¸-åœ°å½¢-é˜´å½±-é€æ˜åº¦-æ’åºé¿å‘"><a href="#â›°ï¸-åœ°å½¢-é˜´å½±-é€æ˜åº¦-æ’åºé¿å‘" class="headerlink" title="â›°ï¸ åœ°å½¢ &#x2F; é˜´å½± &#x2F; é€æ˜åº¦ æ’åºé¿å‘"></a>â›°ï¸ åœ°å½¢ &#x2F; é˜´å½± &#x2F; é€æ˜åº¦ æ’åºé¿å‘</h2><ul><li>è´´åœ°åˆå§‹åŒ–ï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="title class_">Cesium</span>.<span class="property">GroundPolylinePrimitive</span>.<span class="title function_">initializeTerrainHeights</span>()</span><br></pre></td></tr></table></figure><ul><li>é€æ˜æ’åºï¼šå°½é‡åˆå¹¶ã€å‡å°‘é‡å ï¼›å¿…è¦æ—¶å…³é—­éƒ¨åˆ†æ·±åº¦æµ‹è¯•æˆ–è°ƒæ•´é¡ºåºï¼›å¯å°è¯• <code>viewer.scene.orderIndependentTranslucency</code>ã€‚</li><li>é˜´å½±ï¼š<code>viewer.shadows = true</code>ï¼›ç»†åŒ–åˆ°å®ä½“ <code>ShadowMode</code> æ§åˆ¶ã€‚</li></ul><hr><h2 id="ğŸ§°-æ›´å¤šå®è·µå»ºè®®"><a href="#ğŸ§°-æ›´å¤šå®è·µå»ºè®®" class="headerlink" title="ğŸ§° æ›´å¤šå®è·µå»ºè®®"></a>ğŸ§° æ›´å¤šå®è·µå»ºè®®</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">viewer.<span class="property">scene</span>.<span class="property">requestRenderMode</span> = <span class="literal">true</span></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">maximumRenderTimeChange</span> = <span class="number">0.0</span></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="title function_">requestRender</span>()</span><br></pre></td></tr></table></figure><ul><li>å¤§æ•°æ®ä¼˜å…ˆçº§ï¼šPrimitive &gt; æ‰¹é‡ Entityï¼ˆåˆ†æ‰¹+è£å‰ªï¼‰ &gt; LODï¼ˆè¿œ Billboardsã€è¿‘ç»†èŠ‚ï¼‰</li><li>äº‹ä»¶èŠ‚æµä¸æ‹¾å–å›é€€ï¼›Worker åšå‡ ä½•ä¸ç­›é€‰ï¼Œä¸»çº¿ç¨‹ç»˜åˆ¶ã€‚</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Cesium-å®Œæ•´ç¦»çº¿å¼€å‘æŒ‡å—&quot;&gt;&lt;a href=&quot;#Cesium-å®Œæ•´ç¦»çº¿å¼€å‘æŒ‡å—&quot; class=&quot;headerlink&quot; title=&quot;Cesium å®Œæ•´ç¦»çº¿å¼€å‘æŒ‡å—&quot;&gt;&lt;/a&gt;Cesium å®Œæ•´ç¦»çº¿å¼€å‘æŒ‡å—&lt;/h1&gt;&lt;h2 id=&quot;ğŸ“‹-ç›®å½•&quot;&gt;&lt;a hre</summary>
      
    
    
    
    
    <category term="Cesium" scheme="https://aoayaoa.github.io/tags/Cesium/"/>
    
    <category term="ä¸‰ç»´GIS" scheme="https://aoayaoa.github.io/tags/%E4%B8%89%E7%BB%B4GIS/"/>
    
  </entry>
  
  <entry>
    <title>mars3D å¼€å‘æ–‡æ¡£</title>
    <link href="https://aoayaoa.github.io/2025/07/31/mars3d/"/>
    <id>https://aoayaoa.github.io/2025/07/31/mars3d/</id>
    <published>2025-07-30T16:00:00.000Z</published>
    <updated>2025-08-08T02:31:53.931Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Mars3D-å®Œæ•´ç¦»çº¿å¼€å‘æŒ‡å—"><a href="#Mars3D-å®Œæ•´ç¦»çº¿å¼€å‘æŒ‡å—" class="headerlink" title="Mars3D å®Œæ•´ç¦»çº¿å¼€å‘æŒ‡å—"></a>Mars3D å®Œæ•´ç¦»çº¿å¼€å‘æŒ‡å—</h1><h2 id="ğŸ“‹-ç›®å½•"><a href="#ğŸ“‹-ç›®å½•" class="headerlink" title="ğŸ“‹ ç›®å½•"></a>ğŸ“‹ ç›®å½•</h2><ul><li><a href="#%E7%A6%BB%E7%BA%BF%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE">ç¦»çº¿ç¯å¢ƒé…ç½®</a></li><li><a href="#map-%E8%AF%A6%E7%BB%86%E9%85%8D%E7%BD%AE">Map è¯¦ç»†é…ç½®</a></li><li><a href="#%E5%9D%90%E6%A0%87%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">åæ ‡ç³»ç»Ÿè¯¦è§£</a></li><li><a href="#%E5%9B%BE%E5%B1%82%E7%B3%BB%E7%BB%9F%E5%AE%8C%E6%95%B4%E5%B1%9E%E6%80%A7">å›¾å±‚ç³»ç»Ÿå®Œæ•´å±æ€§</a></li><li><a href="#%E7%9F%A2%E9%87%8F%E6%95%B0%E6%8D%AE%E8%AF%A6%E8%A7%A3">çŸ¢é‡æ•°æ®è¯¦è§£</a></li><li><a href="#%E4%B8%89%E7%BB%B4%E6%A8%A1%E5%9E%8B%E8%AF%A6%E8%A7%A3">ä¸‰ç»´æ¨¡å‹è¯¦è§£</a></li><li><a href="#%E7%9B%B8%E6%9C%BA%E6%8E%A7%E5%88%B6%E5%AE%8C%E6%95%B4%E5%B1%9E%E6%80%A7">ç›¸æœºæ§åˆ¶å®Œæ•´å±æ€§</a></li><li><a href="#%E4%BA%8B%E4%BB%B6%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">äº‹ä»¶ç³»ç»Ÿè¯¦è§£</a></li><li><a href="#%E6%9D%90%E8%B4%A8%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">æè´¨ç³»ç»Ÿè¯¦è§£</a></li><li><a href="#%E5%8A%A8%E7%94%BB%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">åŠ¨ç”»ç³»ç»Ÿè¯¦è§£</a></li><li><a href="#%E5%88%86%E6%9E%90%E5%8A%9F%E8%83%BD%E8%AF%A6%E8%A7%A3">åˆ†æåŠŸèƒ½è¯¦è§£</a></li><li><a href="#%E6%8E%A7%E4%BB%B6%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">æ§ä»¶ç³»ç»Ÿè¯¦è§£</a></li><li><a href="#%E7%BB%98%E5%88%B6%E5%8A%9F%E8%83%BD%E8%AF%A6%E8%A7%A3">ç»˜åˆ¶åŠŸèƒ½è¯¦è§£</a></li></ul><h2 id="ç¦»çº¿ç¯å¢ƒé…ç½®"><a href="#ç¦»çº¿ç¯å¢ƒé…ç½®" class="headerlink" title="ç¦»çº¿ç¯å¢ƒé…ç½®"></a>ç¦»çº¿ç¯å¢ƒé…ç½®</h2><h3 id="å®Œæ•´ç¦»çº¿åŒ…ä¸‹è½½"><a href="#å®Œæ•´ç¦»çº¿åŒ…ä¸‹è½½" class="headerlink" title="å®Œæ•´ç¦»çº¿åŒ…ä¸‹è½½"></a>å®Œæ•´ç¦»çº¿åŒ…ä¸‹è½½</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. ä¸‹è½½Mars3Då®Œæ•´åŒ…</span></span><br><span class="line">wget https://github.com/marsgis/mars3d/releases/latest/mars3d.zip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. è§£å‹åˆ°é¡¹ç›®ç›®å½•</span></span><br><span class="line">unzip mars3d.zip -d public/mars3d/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. é¡¹ç›®ç»“æ„</span></span><br><span class="line">public/</span><br><span class="line">â”œâ”€â”€ mars3d/</span><br><span class="line">â”‚   â”œâ”€â”€ dist/</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ mars3d.js          <span class="comment"># ä¸»åº“æ–‡ä»¶</span></span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ mars3d.css         <span class="comment"># æ ·å¼æ–‡ä»¶</span></span><br><span class="line">â”‚   â”‚   â””â”€â”€ plugins/           <span class="comment"># æ’ä»¶ç›®å½•</span></span><br><span class="line">â”‚   â”œâ”€â”€ Workers/               <span class="comment"># WebWorkeræ–‡ä»¶</span></span><br><span class="line">â”‚   â”œâ”€â”€ Assets/                <span class="comment"># é™æ€èµ„æº</span></span><br><span class="line">â”‚   â””â”€â”€ ThirdParty/            <span class="comment"># ç¬¬ä¸‰æ–¹åº“</span></span><br></pre></td></tr></table></figure><h3 id="Viteç¦»çº¿é…ç½®"><a href="#Viteç¦»çº¿é…ç½®" class="headerlink" title="Viteç¦»çº¿é…ç½®"></a>Viteç¦»çº¿é…ç½®</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.js - Mars3Dç¦»çº¿å¼€å‘é…ç½®</span></span><br><span class="line"><span class="keyword">import</span> &#123; defineConfig &#125; <span class="keyword">from</span> <span class="string">&#x27;vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; resolve &#125; <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">define</span>: &#123;</span><br><span class="line">    <span class="comment">// å®šä¹‰å…¨å±€å¸¸é‡</span></span><br><span class="line">    <span class="title class_">MARS3D</span><span class="attr">_BASE_URL</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="string">&#x27;/mars3d/&#x27;</span>),</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é™æ€èµ„æºå¤„ç†</span></span><br><span class="line">  <span class="attr">publicDir</span>: <span class="string">&#x27;public&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ„å»ºé…ç½®</span></span><br><span class="line">  <span class="attr">build</span>: &#123;</span><br><span class="line">    <span class="attr">rollupOptions</span>: &#123;</span><br><span class="line">      <span class="comment">// æ’é™¤ä¸éœ€è¦çš„ä¾èµ–</span></span><br><span class="line">      <span class="attr">external</span>: [<span class="string">&#x27;@mars/common&#x27;</span>],</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¤åˆ¶Mars3Dé™æ€èµ„æº</span></span><br><span class="line">      <span class="attr">input</span>: &#123;</span><br><span class="line">        <span class="attr">main</span>: <span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;index.html&#x27;</span>),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¼€å‘æœåŠ¡å™¨é…ç½®</span></span><br><span class="line">  <span class="attr">server</span>: &#123;</span><br><span class="line">    <span class="comment">// é™æ€æ–‡ä»¶æœåŠ¡</span></span><br><span class="line">    <span class="attr">fs</span>: &#123;</span><br><span class="line">      <span class="attr">allow</span>: [<span class="string">&#x27;..&#x27;</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ä»£ç†é…ç½®ï¼ˆå¦‚éœ€è¦ï¼‰</span></span><br><span class="line">    <span class="attr">proxy</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;/api&#x27;</span>: &#123;</span><br><span class="line">        <span class="attr">target</span>: <span class="string">&#x27;http://localhost:3000&#x27;</span>,</span><br><span class="line">        <span class="attr">changeOrigin</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¼˜åŒ–é…ç½®</span></span><br><span class="line">  <span class="attr">optimizeDeps</span>: &#123;</span><br><span class="line">    <span class="comment">// é¢„æ„å»ºMars3D</span></span><br><span class="line">    <span class="attr">include</span>: [<span class="string">&#x27;mars3d&#x27;</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="ç¦»çº¿åˆå§‹åŒ–"><a href="#ç¦»çº¿åˆå§‹åŒ–" class="headerlink" title="ç¦»çº¿åˆå§‹åŒ–"></a>ç¦»çº¿åˆå§‹åŒ–</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js - Mars3Dç¦»çº¿åˆå§‹åŒ–é…ç½®</span></span><br><span class="line"><span class="comment">// è®¾ç½®Mars3DåŸºç¡€è·¯å¾„</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">MARS3D_BASE_URL</span> = <span class="string">&#x27;/mars3d/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼•å…¥Mars3D</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> mars3d <span class="keyword">from</span> <span class="string">&#x27;mars3d&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¦»çº¿Mapé…ç½®</span></span><br><span class="line"><span class="keyword">const</span> map = <span class="keyword">new</span> mars3d.<span class="title class_">Map</span>(<span class="string">&#x27;mars3dContainer&#x27;</span>, &#123;</span><br><span class="line">  <span class="comment">// åœºæ™¯å‚æ•°</span></span><br><span class="line">  <span class="attr">scene</span>: &#123;</span><br><span class="line">    <span class="attr">center</span>: &#123; <span class="attr">lat</span>: <span class="number">31.794</span>, <span class="attr">lng</span>: <span class="number">117.207</span>, <span class="attr">alt</span>: <span class="number">2000</span>, <span class="attr">heading</span>: <span class="number">0</span>, <span class="attr">pitch</span>: -<span class="number">45</span> &#125;,</span><br><span class="line">    <span class="attr">showSun</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">showMoon</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">showSkyBox</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">showSkyAtmosphere</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">fog</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">fxaa</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">requestRenderMode</span>: <span class="literal">false</span>, <span class="comment">// ç¦»çº¿å»ºè®®false</span></span><br><span class="line">    <span class="attr">globe</span>: &#123;</span><br><span class="line">      <span class="attr">depthTestAgainstTerrain</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">baseColor</span>: <span class="string">&#x27;#546a53&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ§åˆ¶å‚æ•°</span></span><br><span class="line">  <span class="attr">control</span>: &#123;</span><br><span class="line">    <span class="attr">baseLayerPicker</span>: <span class="literal">false</span>, <span class="comment">// å…³é—­å›¾å±‚é€‰æ‹©å™¨</span></span><br><span class="line">    <span class="attr">homeButton</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">sceneModePicker</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">navigationHelpButton</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">animation</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">timeline</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">fullscreenButton</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">vrButton</span>: <span class="literal">false</span>,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœ°å½¢å‚æ•°</span></span><br><span class="line">  <span class="attr">terrain</span>: &#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;https://data.marsgis.cn/terrain&#x27;</span>, <span class="comment">// æˆ–æœ¬åœ°åœ°å½¢æœåŠ¡</span></span><br><span class="line">    <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å›¾å±‚å‚æ•°</span></span><br><span class="line">  <span class="attr">basemaps</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;ç¦»çº¿åº•å›¾&#x27;</span>,</span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&#x27;img/basemaps/offline.png&#x27;</span>,</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;xyz&#x27;</span>,</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&#x27;http://localhost:8080/tiles/&#123;z&#125;/&#123;x&#125;/&#123;y&#125;.png&#x27;</span>,</span><br><span class="line">      <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ“ä½œå›¾å±‚</span></span><br><span class="line">  <span class="attr">operationalLayers</span>: [],</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="Map-è¯¦ç»†é…ç½®"><a href="#Map-è¯¦ç»†é…ç½®" class="headerlink" title="Map è¯¦ç»†é…ç½®"></a>Map è¯¦ç»†é…ç½®</h2><h3 id="æ„é€ å‡½æ•°å®Œæ•´å‚æ•°"><a href="#æ„é€ å‡½æ•°å®Œæ•´å‚æ•°" class="headerlink" title="æ„é€ å‡½æ•°å®Œæ•´å‚æ•°"></a>æ„é€ å‡½æ•°å®Œæ•´å‚æ•°</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> map = <span class="keyword">new</span> mars3d.<span class="title class_">Map</span>(container, &#123;</span><br><span class="line">  <span class="comment">// === åœºæ™¯é…ç½® ===</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">scene</span>: &#123;</span><br><span class="line">    <span class="comment">// center: Object</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åœ°å›¾ä¸­å¿ƒç‚¹ä½ç½®</span></span><br><span class="line">    <span class="comment">// æ ¼å¼: &#123; lat: çº¬åº¦, lng: ç»åº¦, alt: é«˜åº¦, heading: æ–¹å‘è§’, pitch: ä¿¯ä»°è§’, roll: ç¿»æ»šè§’ &#125;</span></span><br><span class="line">    <span class="attr">center</span>: &#123; <span class="attr">lat</span>: <span class="number">31.794</span>, <span class="attr">lng</span>: <span class="number">117.207</span>, <span class="attr">alt</span>: <span class="number">2000</span>, <span class="attr">heading</span>: <span class="number">0</span>, <span class="attr">pitch</span>: -<span class="number">45</span>, <span class="attr">roll</span>: <span class="number">0</span> &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// showSun: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºå¤ªé˜³</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="attr">showSun</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// showMoon: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºæœˆäº®</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="attr">showMoon</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// showSkyBox: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºå¤©ç©ºç›’</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="attr">showSkyBox</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// showSkyAtmosphere: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºå¤§æ°”å±‚</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="attr">showSkyAtmosphere</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fog: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦å¼€å¯é›¾æ•ˆ</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="attr">fog</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fxaa: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦å¼€å¯æŠ—é”¯é½¿</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="attr">fxaa</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// bloom: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦å¼€å¯æ³›å…‰æ•ˆæœ</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="attr">bloom</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// brightness: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: äº®åº¦è°ƒèŠ‚</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">    <span class="comment">// èŒƒå›´: 0.0 - 2.0</span></span><br><span class="line">    <span class="attr">brightness</span>: <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// contrast: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¯¹æ¯”åº¦è°ƒèŠ‚</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">    <span class="comment">// èŒƒå›´: 0.0 - 2.0</span></span><br><span class="line">    <span class="attr">contrast</span>: <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// hue: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è‰²è°ƒè°ƒèŠ‚</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 0.0</span></span><br><span class="line">    <span class="comment">// èŒƒå›´: -1.0 - 1.0</span></span><br><span class="line">    <span class="attr">hue</span>: <span class="number">0.0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// saturation: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é¥±å’Œåº¦è°ƒèŠ‚</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">    <span class="comment">// èŒƒå›´: 0.0 - 2.0</span></span><br><span class="line">    <span class="attr">saturation</span>: <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// gamma: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ä¼½é©¬å€¼è°ƒèŠ‚</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">    <span class="comment">// èŒƒå›´: 0.1 - 5.0</span></span><br><span class="line">    <span class="attr">gamma</span>: <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// requestRenderMode: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦å¼€å¯æŒ‰éœ€æ¸²æŸ“</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="comment">// æ€§èƒ½ä¼˜åŒ–: trueå¯æå‡æ€§èƒ½</span></span><br><span class="line">    <span class="attr">requestRenderMode</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// maximumRenderTimeChange: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æœ€å¤§æ¸²æŸ“æ—¶é—´å˜åŒ–</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 0.0</span></span><br><span class="line">    <span class="attr">maximumRenderTimeChange</span>: <span class="number">0.0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// shadows: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦å¼€å¯é˜´å½±</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="comment">// æ€§èƒ½å½±å“: è¾ƒå¤§</span></span><br><span class="line">    <span class="attr">shadows</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// resolutionScale: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åˆ†è¾¨ç‡ç¼©æ”¾æ¯”ä¾‹</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">    <span class="comment">// æ€§èƒ½ä¼˜åŒ–: é™ä½å¯æå‡æ€§èƒ½</span></span><br><span class="line">    <span class="attr">resolutionScale</span>: <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// globe: Object</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åœ°çƒé…ç½®</span></span><br><span class="line">    <span class="attr">globe</span>: &#123;</span><br><span class="line">      <span class="comment">// show: boolean</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºåœ°çƒ</span></span><br><span class="line">      <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">      <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// depthTestAgainstTerrain: boolean</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: æ˜¯å¦å¯¹åœ°å½¢è¿›è¡Œæ·±åº¦æµ‹è¯•</span></span><br><span class="line">      <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">      <span class="attr">depthTestAgainstTerrain</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// baseColor: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: åœ°çƒåŸºç¡€é¢œè‰²</span></span><br><span class="line">      <span class="comment">// é»˜è®¤: &#x27;#546a53&#x27;</span></span><br><span class="line">      <span class="attr">baseColor</span>: <span class="string">&#x27;#546a53&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// showWaterEffect: boolean</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºæ°´ä½“æ•ˆæœ</span></span><br><span class="line">      <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">      <span class="attr">showWaterEffect</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// enableLighting: boolean</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: æ˜¯å¦å¯ç”¨å…‰ç…§</span></span><br><span class="line">      <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">      <span class="attr">enableLighting</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// skyBox: Object | boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¤©ç©ºç›’é…ç½®</span></span><br><span class="line">    <span class="attr">skyBox</span>: &#123;</span><br><span class="line">      <span class="comment">// sources: Object</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: å¤©ç©ºç›’è´´å›¾</span></span><br><span class="line">      <span class="attr">sources</span>: &#123;</span><br><span class="line">        <span class="attr">positiveX</span>: <span class="string">&#x27;img/skybox/px.jpg&#x27;</span>,</span><br><span class="line">        <span class="attr">negativeX</span>: <span class="string">&#x27;img/skybox/nx.jpg&#x27;</span>,</span><br><span class="line">        <span class="attr">positiveY</span>: <span class="string">&#x27;img/skybox/py.jpg&#x27;</span>,</span><br><span class="line">        <span class="attr">negativeY</span>: <span class="string">&#x27;img/skybox/ny.jpg&#x27;</span>,</span><br><span class="line">        <span class="attr">positiveZ</span>: <span class="string">&#x27;img/skybox/pz.jpg&#x27;</span>,</span><br><span class="line">        <span class="attr">negativeZ</span>: <span class="string">&#x27;img/skybox/nz.jpg&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// contextOptions: Object</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: WebGLä¸Šä¸‹æ–‡é€‰é¡¹</span></span><br><span class="line">    <span class="attr">contextOptions</span>: &#123;</span><br><span class="line">      <span class="attr">webgl</span>: &#123;</span><br><span class="line">        <span class="attr">alpha</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">depth</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">stencil</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">antialias</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">powerPreference</span>: <span class="string">&#x27;high-performance&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === æ§åˆ¶é…ç½® ===</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">control</span>: &#123;</span><br><span class="line">    <span class="comment">// baseLayerPicker: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºåº•å›¾åˆ‡æ¢æ§ä»¶</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="comment">// ç¦»çº¿å»ºè®®: false</span></span><br><span class="line">    <span class="attr">baseLayerPicker</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// homeButton: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºä¸»é¡µæŒ‰é’®</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="attr">homeButton</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sceneModePicker: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºåœºæ™¯æ¨¡å¼åˆ‡æ¢æŒ‰é’®</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="attr">sceneModePicker</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// navigationHelpButton: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºå¯¼èˆªå¸®åŠ©æŒ‰é’®</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="attr">navigationHelpButton</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// animation: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºåŠ¨ç”»æ§ä»¶</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="attr">animation</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// timeline: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºæ—¶é—´è½´</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="attr">timeline</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fullscreenButton: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºå…¨å±æŒ‰é’®</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="attr">fullscreenButton</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// vrButton: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºVRæŒ‰é’®</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="attr">vrButton</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// infoBox: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºä¿¡æ¯æ¡†</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="attr">infoBox</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// selectionIndicator: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºé€‰æ‹©æŒ‡ç¤ºå™¨</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="attr">selectionIndicator</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// geocoder: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºåœ°å€æœç´¢</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="comment">// ç¦»çº¿å»ºè®®: false</span></span><br><span class="line">    <span class="attr">geocoder</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// compass: Object | boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æŒ‡å—é’ˆæ§ä»¶é…ç½®</span></span><br><span class="line">    <span class="attr">compass</span>: &#123;</span><br><span class="line">      <span class="comment">// top: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: è·ç¦»é¡¶éƒ¨è·ç¦»</span></span><br><span class="line">      <span class="attr">top</span>: <span class="string">&#x27;10px&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// left: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: è·ç¦»å·¦ä¾§è·ç¦»</span></span><br><span class="line">      <span class="attr">left</span>: <span class="string">&#x27;5px&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// distanceLegend: Object | boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ¯”ä¾‹å°ºæ§ä»¶é…ç½®</span></span><br><span class="line">    <span class="attr">distanceLegend</span>: &#123;</span><br><span class="line">      <span class="comment">// left: string</span></span><br><span class="line">      <span class="attr">left</span>: <span class="string">&#x27;10px&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// bottom: string</span></span><br><span class="line">      <span class="attr">bottom</span>: <span class="string">&#x27;25px&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// locationBar: Object | boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åæ ‡ä¿¡æ¯æ é…ç½®</span></span><br><span class="line">    <span class="attr">locationBar</span>: &#123;</span><br><span class="line">      <span class="comment">// format: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: åæ ‡æ ¼å¼</span></span><br><span class="line">      <span class="comment">// é€‰é¡¹: &#x27;degrees&#x27;, &#x27;dms&#x27;, &#x27;utm&#x27;</span></span><br><span class="line">      <span class="attr">format</span>: <span class="string">&#x27;degrees&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// bottom: string</span></span><br><span class="line">      <span class="attr">bottom</span>: <span class="string">&#x27;2px&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// left: string</span></span><br><span class="line">      <span class="attr">left</span>: <span class="string">&#x27;10px&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// contextmenu: Object | boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å³é”®èœå•é…ç½®</span></span><br><span class="line">    <span class="attr">contextmenu</span>: &#123;</span><br><span class="line">      <span class="comment">// hasDefault: boolean</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: æ˜¯å¦åŒ…å«é»˜è®¤èœå•é¡¹</span></span><br><span class="line">      <span class="attr">hasDefault</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === åœ°å½¢é…ç½® ===</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">terrain</span>: &#123;</span><br><span class="line">    <span class="comment">// url: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åœ°å½¢æœåŠ¡åœ°å€</span></span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;https://data.marsgis.cn/terrain&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// show: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºåœ°å½¢</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// requestWaterMask: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦è¯·æ±‚æ°´ä½“é®ç½©</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="attr">requestWaterMask</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// requestVertexNormals: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦è¯·æ±‚é¡¶ç‚¹æ³•çº¿</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="attr">requestVertexNormals</span>: <span class="literal">false</span>,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === åº•å›¾é…ç½® ===</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">basemaps</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// name: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: åº•å›¾åç§°</span></span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;å¤©åœ°å›¾å½±åƒ&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// icon: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: åº•å›¾å›¾æ ‡</span></span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&#x27;img/basemaps/tdt_img.png&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// type: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: åº•å›¾ç±»å‹</span></span><br><span class="line">      <span class="comment">// é€‰é¡¹: &#x27;xyz&#x27;, &#x27;wms&#x27;, &#x27;wmts&#x27;, &#x27;arcgis&#x27;, &#x27;baidu&#x27;, &#x27;gaode&#x27;, &#x27;tencent&#x27;, &#x27;bing&#x27;</span></span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;group&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// layers: Array</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: å›¾å±‚ç»„ï¼ˆç”¨äºtypeä¸ºgroupæ—¶ï¼‰</span></span><br><span class="line">      <span class="attr">layers</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&#x27;åº•å›¾&#x27;</span>,</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;tdt&#x27;</span>,</span><br><span class="line">          <span class="attr">layer</span>: <span class="string">&#x27;img_d&#x27;</span>,</span><br><span class="line">          <span class="attr">key</span>: [<span class="string">&#x27;your-key-1&#x27;</span>, <span class="string">&#x27;your-key-2&#x27;</span>],</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&#x27;æ³¨è®°&#x27;</span>,</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;tdt&#x27;</span>,</span><br><span class="line">          <span class="attr">layer</span>: <span class="string">&#x27;img_z&#x27;</span>,</span><br><span class="line">          <span class="attr">key</span>: [<span class="string">&#x27;your-key-1&#x27;</span>, <span class="string">&#x27;your-key-2&#x27;</span>],</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line"></span><br><span class="line">      <span class="comment">// show: boolean</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: æ˜¯å¦é»˜è®¤æ˜¾ç¤º</span></span><br><span class="line">      <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;OpenStreetMap&#x27;</span>,</span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&#x27;img/basemaps/osm.png&#x27;</span>,</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;xyz&#x27;</span>,</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&#x27;https://tile.openstreetmap.org/&#123;z&#125;/&#123;x&#125;/&#123;y&#125;.png&#x27;</span>,</span><br><span class="line">      <span class="attr">show</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;ç¦»çº¿ç“¦ç‰‡&#x27;</span>,</span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&#x27;img/basemaps/offline.png&#x27;</span>,</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;xyz&#x27;</span>,</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&#x27;http://localhost:8080/tiles/&#123;z&#125;/&#123;x&#125;/&#123;y&#125;.png&#x27;</span>,</span><br><span class="line">      <span class="attr">show</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === æ“ä½œå›¾å±‚é…ç½® ===</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">operationalLayers</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// name: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: å›¾å±‚åç§°</span></span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;GeoJSONæ•°æ®&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// type: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: å›¾å±‚ç±»å‹</span></span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;geojson&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// url: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: æ•°æ®åœ°å€</span></span><br><span class="line">      <span class="attr">url</span>: <span class="string">&#x27;data/sample.geojson&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// show: boolean</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: æ˜¯å¦é»˜è®¤æ˜¾ç¤º</span></span><br><span class="line">      <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// flyTo: boolean</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: åŠ è½½åæ˜¯å¦é£è¡Œåˆ°æ•°æ®èŒƒå›´</span></span><br><span class="line">      <span class="attr">flyTo</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// popup: Object | string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: å¼¹çª—é…ç½®</span></span><br><span class="line">      <span class="attr">popup</span>: <span class="string">&#x27;all&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// style: Object</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: æ ·å¼é…ç½®</span></span><br><span class="line">      <span class="attr">style</span>: &#123;</span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line">        <span class="attr">width</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="attr">opacity</span>: <span class="number">0.8</span>,</span><br><span class="line">        <span class="attr">fill</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">fillColor</span>: <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line">        <span class="attr">fillOpacity</span>: <span class="number">0.3</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === å…¶ä»–é…ç½® ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// lang: string</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: è¯­è¨€è®¾ç½®</span></span><br><span class="line">  <span class="comment">// é€‰é¡¹: &#x27;zh&#x27;, &#x27;en&#x27;</span></span><br><span class="line">  <span class="attr">lang</span>: <span class="string">&#x27;zh&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// templateValues: Object</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: æ¨¡æ¿å˜é‡</span></span><br><span class="line">  <span class="attr">templateValues</span>: &#123;&#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// chinaCRS: string</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: ä¸­å›½åæ ‡ç³»</span></span><br><span class="line">  <span class="comment">// é€‰é¡¹: &#x27;WGS84&#x27;, &#x27;GCJ02&#x27;, &#x27;BD09&#x27;</span></span><br><span class="line">  <span class="attr">chinaCRS</span>: <span class="string">&#x27;GCJ02&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// units: string</span></span><br><span class="line">  <span class="comment">// ä½œç”¨: å•ä½åˆ¶</span></span><br><span class="line">  <span class="comment">// é€‰é¡¹: &#x27;metric&#x27;, &#x27;imperial&#x27;</span></span><br><span class="line">  <span class="attr">units</span>: <span class="string">&#x27;metric&#x27;</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="åæ ‡ç³»ç»Ÿè¯¦è§£"><a href="#åæ ‡ç³»ç»Ÿè¯¦è§£" class="headerlink" title="åæ ‡ç³»ç»Ÿè¯¦è§£"></a>åæ ‡ç³»ç»Ÿè¯¦è§£</h2><h3 id="LngLatPoint-ç»çº¬åº¦åæ ‡"><a href="#LngLatPoint-ç»çº¬åº¦åæ ‡" class="headerlink" title="LngLatPoint ç»çº¬åº¦åæ ‡"></a>LngLatPoint ç»çº¬åº¦åæ ‡</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LngLatPoint - ç»çº¬åº¦åæ ‡ç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LngLatPoint</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">lng, lat, alt = <span class="number">0</span></span>) &#123;</span><br><span class="line">    <span class="comment">// lng: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç»åº¦</span></span><br><span class="line">    <span class="comment">// èŒƒå›´: -180 åˆ° 180</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lng</span> = lng</span><br><span class="line"></span><br><span class="line">    <span class="comment">// lat: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: çº¬åº¦</span></span><br><span class="line">    <span class="comment">// èŒƒå›´: -90 åˆ° 90</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lat</span> = lat</span><br><span class="line"></span><br><span class="line">    <span class="comment">// alt: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é«˜åº¦ï¼ˆç±³ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">alt</span> = alt</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é™æ€æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromString - ä»å­—ç¬¦ä¸²åˆ›å»º</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromString</span>(<span class="params">str</span>) &#123;</span><br><span class="line">    <span class="comment">// str: string - æ ¼å¼: &quot;lng,lat&quot; æˆ– &quot;lng,lat,alt&quot;</span></span><br><span class="line">    <span class="keyword">const</span> parts = str.<span class="title function_">split</span>(<span class="string">&#x27;,&#x27;</span>).<span class="title function_">map</span>(<span class="title class_">Number</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> mars3d.<span class="title class_">LngLatPoint</span>(parts[<span class="number">0</span>], parts[<span class="number">1</span>], parts[<span class="number">2</span>] || <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromArray - ä»æ•°ç»„åˆ›å»º</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromArray</span>(<span class="params">arr</span>) &#123;</span><br><span class="line">    <span class="comment">// arr: Array - æ ¼å¼: [lng, lat] æˆ– [lng, lat, alt]</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> mars3d.<span class="title class_">LngLatPoint</span>(arr[<span class="number">0</span>], arr[<span class="number">1</span>], arr[<span class="number">2</span>] || <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromDegrees - ä»åº¦æ•°åˆ›å»ºï¼ˆåŒæ„é€ å‡½æ•°ï¼‰</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromDegrees</span>(<span class="params">lng, lat, alt = <span class="number">0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> mars3d.<span class="title class_">LngLatPoint</span>(lng, lat, alt)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromRadians - ä»å¼§åº¦åˆ›å»º</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromRadians</span>(<span class="params">lngRad, latRad, alt = <span class="number">0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> mars3d.<span class="title class_">LngLatPoint</span>(</span><br><span class="line">      mars3d.<span class="property">Util</span>.<span class="title function_">radiansToDegrees</span>(lngRad),</span><br><span class="line">      mars3d.<span class="property">Util</span>.<span class="title function_">radiansToDegrees</span>(latRad),</span><br><span class="line">      alt,</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å®ä¾‹æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// toString - è½¬æ¢ä¸ºå­—ç¬¦ä¸²</span></span><br><span class="line">  <span class="title function_">toString</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.lng&#125;</span>,<span class="subst">$&#123;<span class="variable language_">this</span>.lat&#125;</span>,<span class="subst">$&#123;<span class="variable language_">this</span>.alt&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// toArray - è½¬æ¢ä¸ºæ•°ç»„</span></span><br><span class="line">  <span class="title function_">toArray</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="variable language_">this</span>.<span class="property">lng</span>, <span class="variable language_">this</span>.<span class="property">lat</span>, <span class="variable language_">this</span>.<span class="property">alt</span>]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// clone - å…‹éš†</span></span><br><span class="line">  <span class="title function_">clone</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> mars3d.<span class="title class_">LngLatPoint</span>(<span class="variable language_">this</span>.<span class="property">lng</span>, <span class="variable language_">this</span>.<span class="property">lat</span>, <span class="variable language_">this</span>.<span class="property">alt</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// equals - æ¯”è¾ƒç›¸ç­‰</span></span><br><span class="line">  <span class="title function_">equals</span>(<span class="params">other, epsilon = <span class="number">1e-6</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="title class_">Math</span>.<span class="title function_">abs</span>(<span class="variable language_">this</span>.<span class="property">lng</span> - other.<span class="property">lng</span>) &lt; epsilon &amp;&amp;</span><br><span class="line">      <span class="title class_">Math</span>.<span class="title function_">abs</span>(<span class="variable language_">this</span>.<span class="property">lat</span> - other.<span class="property">lat</span>) &lt; epsilon &amp;&amp;</span><br><span class="line">      <span class="title class_">Math</span>.<span class="title function_">abs</span>(<span class="variable language_">this</span>.<span class="property">alt</span> - other.<span class="property">alt</span>) &lt; epsilon</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// distanceTo - è®¡ç®—åˆ°å¦ä¸€ç‚¹çš„è·ç¦»</span></span><br><span class="line">  <span class="title function_">distanceTo</span>(<span class="params">other</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">MeasureUtil</span>.<span class="title function_">getDistance</span>([<span class="variable language_">this</span>, other])</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// format - æ ¼å¼åŒ–æ˜¾ç¤º</span></span><br><span class="line">  <span class="title function_">format</span>(<span class="params">type = <span class="string">&#x27;degree&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;degree&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.lng.toFixed(<span class="number">6</span>)&#125;</span>Â°, <span class="subst">$&#123;<span class="variable language_">this</span>.lat.toFixed(<span class="number">6</span>)&#125;</span>Â°`</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;dms&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> mars3d.<span class="property">Util</span>.<span class="title function_">formatDMS</span>(<span class="variable language_">this</span>.<span class="property">lng</span>, <span class="variable language_">this</span>.<span class="property">lat</span>)</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;utm&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">lonlat2utm</span>(<span class="variable language_">this</span>)</span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">toString</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> point1 = <span class="keyword">new</span> mars3d.<span class="title class_">LngLatPoint</span>(<span class="number">117.207</span>, <span class="number">31.794</span>, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">const</span> point2 = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromString</span>(<span class="string">&#x27;116.407,39.904,50&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> point3 = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>([<span class="number">121.473</span>, <span class="number">31.23</span>, <span class="number">20</span>])</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç‚¹1:&#x27;</span>, point1.<span class="title function_">toString</span>())</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç‚¹2æ ¼å¼åŒ–:&#x27;</span>, point2.<span class="title function_">format</span>(<span class="string">&#x27;dms&#x27;</span>))</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;è·ç¦»:&#x27;</span>, point1.<span class="title function_">distanceTo</span>(point2), <span class="string">&#x27;ç±³&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="åæ ‡ç³»è½¬æ¢"><a href="#åæ ‡ç³»è½¬æ¢" class="headerlink" title="åæ ‡ç³»è½¬æ¢"></a>åæ ‡ç³»è½¬æ¢</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PointTrans - åæ ‡è½¬æ¢å·¥å…·ç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PointTrans</span> &#123;</span><br><span class="line">  <span class="comment">// WGS84 è½¬ GCJ02 (ç«æ˜Ÿåæ ‡ç³»)</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">wgs84togcj02</span>(<span class="params">lng, lat</span>) &#123;</span><br><span class="line">    <span class="comment">// lng: number - WGS84ç»åº¦</span></span><br><span class="line">    <span class="comment">// lat: number - WGS84çº¬åº¦</span></span><br><span class="line">    <span class="comment">// è¿”å›: &#123;lng: number, lat: number&#125;</span></span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">wgs84togcj02</span>(lng, lat)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// GCJ02 è½¬ WGS84</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">gcj02towgs84</span>(<span class="params">lng, lat</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">gcj02towgs84</span>(lng, lat)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// GCJ02 è½¬ BD09 (ç™¾åº¦åæ ‡ç³»)</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">gcj02tobd09</span>(<span class="params">lng, lat</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">gcj02tobd09</span>(lng, lat)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// BD09 è½¬ GCJ02</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">bd09togcj02</span>(<span class="params">lng, lat</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">bd09togcj02</span>(lng, lat)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// WGS84 è½¬ BD09</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">wgs84tobd09</span>(<span class="params">lng, lat</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> gcj = mars3d.<span class="property">PointTrans</span>.<span class="title function_">wgs84togcj02</span>(lng, lat)</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">gcj02tobd09</span>(gcj.<span class="property">lng</span>, gcj.<span class="property">lat</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// BD09 è½¬ WGS84</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">bd09towgs84</span>(<span class="params">lng, lat</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> gcj = mars3d.<span class="property">PointTrans</span>.<span class="title function_">bd09togcj02</span>(lng, lat)</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">gcj02towgs84</span>(gcj.<span class="property">lng</span>, gcj.<span class="property">lat</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç»çº¬åº¦ è½¬ UTMåæ ‡</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">lonlat2utm</span>(<span class="params">point</span>) &#123;</span><br><span class="line">    <span class="comment">// point: LngLatPoint</span></span><br><span class="line">    <span class="comment">// è¿”å›: &#123;x: number, y: number, zone: string&#125;</span></span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">lonlat2utm</span>(point)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// UTMåæ ‡ è½¬ ç»çº¬åº¦</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">utm2lonlat</span>(<span class="params">utmPoint</span>) &#123;</span><br><span class="line">    <span class="comment">// utmPoint: &#123;x: number, y: number, zone: string&#125;</span></span><br><span class="line">    <span class="comment">// è¿”å›: LngLatPoint</span></span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">utm2lonlat</span>(utmPoint)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç»çº¬åº¦ è½¬ Webå¢¨å¡æ‰˜</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">lonlat2mercator</span>(<span class="params">lng, lat</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">lonlat2mercator</span>(lng, lat)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Webå¢¨å¡æ‰˜ è½¬ ç»çº¬åº¦</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">mercator2lonlat</span>(<span class="params">x, y</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">mercator2lonlat</span>(x, y)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœ°ç†åæ ‡ è½¬ ç¬›å¡å°”åæ ‡</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">lonlat2cartesian</span>(<span class="params">lng, lat, alt = <span class="number">0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">lonlat2cartesian</span>(lng, lat, alt)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¬›å¡å°”åæ ‡ è½¬ åœ°ç†åæ ‡</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">cartesian2lonlat</span>(<span class="params">cartesian</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">cartesian2lonlat</span>(cartesian)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åæ ‡è½¬æ¢ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> wgs84Point = &#123; <span class="attr">lng</span>: <span class="number">116.407</span>, <span class="attr">lat</span>: <span class="number">39.904</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// WGS84 è½¬æ¢ä¸ºå…¶ä»–åæ ‡ç³»</span></span><br><span class="line"><span class="keyword">const</span> gcj02Point = mars3d.<span class="property">PointTrans</span>.<span class="title function_">wgs84togcj02</span>(wgs84Point.<span class="property">lng</span>, wgs84Point.<span class="property">lat</span>)</span><br><span class="line"><span class="keyword">const</span> bd09Point = mars3d.<span class="property">PointTrans</span>.<span class="title function_">wgs84tobd09</span>(wgs84Point.<span class="property">lng</span>, wgs84Point.<span class="property">lat</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;WGS84:&#x27;</span>, wgs84Point)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;GCJ02:&#x27;</span>, gcj02Point)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;BD09:&#x27;</span>, bd09Point)</span><br><span class="line"></span><br><span class="line"><span class="comment">// UTMåæ ‡è½¬æ¢</span></span><br><span class="line"><span class="keyword">const</span> point = <span class="keyword">new</span> mars3d.<span class="title class_">LngLatPoint</span>(<span class="number">117.207</span>, <span class="number">31.794</span>)</span><br><span class="line"><span class="keyword">const</span> utmPoint = mars3d.<span class="property">PointTrans</span>.<span class="title function_">lonlat2utm</span>(point)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;UTMåæ ‡:&#x27;</span>, utmPoint)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬›å¡å°”åæ ‡è½¬æ¢</span></span><br><span class="line"><span class="keyword">const</span> cartesian = mars3d.<span class="property">PointTrans</span>.<span class="title function_">lonlat2cartesian</span>(<span class="number">117.207</span>, <span class="number">31.794</span>, <span class="number">100</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç¬›å¡å°”åæ ‡:&#x27;</span>, cartesian)</span><br></pre></td></tr></table></figure><h3 id="Cesiumåæ ‡è½¬æ¢"><a href="#Cesiumåæ ‡è½¬æ¢" class="headerlink" title="Cesiumåæ ‡è½¬æ¢"></a>Cesiumåæ ‡è½¬æ¢</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Mars3Dä¸­çš„Cesiumåæ ‡è½¬æ¢</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CesiumCoordinate</span> &#123;</span><br><span class="line">  <span class="comment">// å±å¹•åæ ‡è½¬åœ°ç†åæ ‡</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">screenToCartographic</span>(<span class="params">map, screenPoint</span>) &#123;</span><br><span class="line">    <span class="comment">// screenPoint: &#123;x: number, y: number&#125;</span></span><br><span class="line">    <span class="comment">// è¿”å›: LngLatPoint | undefined</span></span><br><span class="line">    <span class="keyword">const</span> cartographic = map.<span class="property">camera</span>.<span class="title function_">pickEllipsoid</span>(screenPoint)</span><br><span class="line">    <span class="keyword">if</span> (cartographic) &#123;</span><br><span class="line">      <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">cartesian2lonlat</span>(cartographic)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœ°ç†åæ ‡è½¬å±å¹•åæ ‡</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">cartographicToScreen</span>(<span class="params">map, lngLatPoint</span>) &#123;</span><br><span class="line">    <span class="comment">// lngLatPoint: LngLatPoint</span></span><br><span class="line">    <span class="comment">// è¿”å›: &#123;x: number, y: number&#125; | undefined</span></span><br><span class="line">    <span class="keyword">const</span> cartesian = mars3d.<span class="property">PointTrans</span>.<span class="title function_">lonlat2cartesian</span>(</span><br><span class="line">      lngLatPoint.<span class="property">lng</span>,</span><br><span class="line">      lngLatPoint.<span class="property">lat</span>,</span><br><span class="line">      lngLatPoint.<span class="property">alt</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">Cesium</span>.<span class="property">SceneTransforms</span>.<span class="title function_">worldToWindowCoordinates</span>(map.<span class="property">scene</span>, cartesian)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç›¸æœºåæ ‡è½¬ä¸–ç•Œåæ ‡</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">cameraToWorld</span>(<span class="params">map, cameraPoint</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> map.<span class="property">camera</span>.<span class="title function_">cameraToWorldCoordinates</span>(cameraPoint)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸–ç•Œåæ ‡è½¬ç›¸æœºåæ ‡</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">worldToCamera</span>(<span class="params">map, worldPoint</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> map.<span class="property">camera</span>.<span class="title function_">worldToCameraCoordinates</span>(worldPoint)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line">map.<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// è·å–ç‚¹å‡»çš„å±å¹•åæ ‡</span></span><br><span class="line">  <span class="keyword">const</span> screenPoint = &#123; <span class="attr">x</span>: event.<span class="property">windowPosition</span>.<span class="property">x</span>, <span class="attr">y</span>: event.<span class="property">windowPosition</span>.<span class="property">y</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è½¬æ¢ä¸ºåœ°ç†åæ ‡</span></span><br><span class="line">  <span class="keyword">const</span> geoPoint = <span class="title class_">CesiumCoordinate</span>.<span class="title function_">screenToCartographic</span>(map, screenPoint)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (geoPoint) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç‚¹å‡»ä½ç½®:&#x27;</span>, geoPoint.<span class="title function_">format</span>(<span class="string">&#x27;degree&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åå‘è½¬æ¢éªŒè¯</span></span><br><span class="line">    <span class="keyword">const</span> backToScreen = <span class="title class_">CesiumCoordinate</span>.<span class="title function_">cartographicToScreen</span>(map, geoPoint)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å±å¹•åæ ‡:&#x27;</span>, backToScreen)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="å›¾å±‚ç³»ç»Ÿå®Œæ•´å±æ€§"><a href="#å›¾å±‚ç³»ç»Ÿå®Œæ•´å±æ€§" class="headerlink" title="å›¾å±‚ç³»ç»Ÿå®Œæ•´å±æ€§"></a>å›¾å±‚ç³»ç»Ÿå®Œæ•´å±æ€§</h2><h3 id="BaseLayer-åº•å›¾å›¾å±‚"><a href="#BaseLayer-åº•å›¾å›¾å±‚" class="headerlink" title="BaseLayer åº•å›¾å›¾å±‚"></a>BaseLayer åº•å›¾å›¾å±‚</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BaseLayer - åº•å›¾å›¾å±‚åŸºç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseLayer</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// id: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å›¾å±‚å”¯ä¸€æ ‡è¯†</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: è‡ªåŠ¨ç”Ÿæˆ</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = options.<span class="property">id</span> || mars3d.<span class="property">Util</span>.<span class="title function_">uuid</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// name: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å›¾å±‚åç§°</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = options.<span class="property">name</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// type: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å›¾å±‚ç±»å‹</span></span><br><span class="line">    <span class="comment">// é€‰é¡¹: &#x27;xyz&#x27;, &#x27;wms&#x27;, &#x27;wmts&#x27;, &#x27;arcgis&#x27;, &#x27;tdt&#x27;, &#x27;baidu&#x27;, &#x27;gaode&#x27;, &#x27;tencent&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">type</span> = options.<span class="property">type</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// url: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æœåŠ¡åœ°å€</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">url</span> = options.<span class="property">url</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// show: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤º</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// alpha: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é€æ˜åº¦</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">    <span class="comment">// èŒƒå›´: 0.0 - 1.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">alpha</span> = options.<span class="property">alpha</span> !== <span class="literal">undefined</span> ? options.<span class="property">alpha</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// brightness: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: äº®åº¦</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">    <span class="comment">// èŒƒå›´: 0.0 - æ— é™åˆ¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">brightness</span> = options.<span class="property">brightness</span> !== <span class="literal">undefined</span> ? options.<span class="property">brightness</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// contrast: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¯¹æ¯”åº¦</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">    <span class="comment">// èŒƒå›´: 0.0 - æ— é™åˆ¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">contrast</span> = options.<span class="property">contrast</span> !== <span class="literal">undefined</span> ? options.<span class="property">contrast</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// hue: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è‰²è°ƒ</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 0.0</span></span><br><span class="line">    <span class="comment">// èŒƒå›´: 0.0 - 2Ï€</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hue</span> = options.<span class="property">hue</span> !== <span class="literal">undefined</span> ? options.<span class="property">hue</span> : <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// saturation: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é¥±å’Œåº¦</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">    <span class="comment">// èŒƒå›´: 0.0 - æ— é™åˆ¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">saturation</span> = options.<span class="property">saturation</span> !== <span class="literal">undefined</span> ? options.<span class="property">saturation</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// gamma: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ä¼½é©¬å€¼</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">    <span class="comment">// èŒƒå›´: 0.1 - æ— é™åˆ¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gamma</span> = options.<span class="property">gamma</span> !== <span class="literal">undefined</span> ? options.<span class="property">gamma</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// maximumLevel: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æœ€å¤§å±‚çº§</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maximumLevel</span> = options.<span class="property">maximumLevel</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// minimumLevel: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æœ€å°å±‚çº§</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">minimumLevel</span> = options.<span class="property">minimumLevel</span> !== <span class="literal">undefined</span> ? options.<span class="property">minimumLevel</span> : <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// rectangle: Object</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¾ç¤ºèŒƒå›´</span></span><br><span class="line">    <span class="comment">// æ ¼å¼: &#123;xmin: number, ymin: number, xmax: number, ymax: number&#125;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">rectangle</span> = options.<span class="property">rectangle</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// proxy: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ä»£ç†åœ°å€</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">proxy</span> = options.<span class="property">proxy</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// subdomains: Array&lt;string&gt;</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å­åŸŸååˆ—è¡¨</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: è´Ÿè½½å‡è¡¡</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">subdomains</span> = options.<span class="property">subdomains</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// maximumAnisotropy: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æœ€å¤§å„å‘å¼‚æ€§è¿‡æ»¤</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 16</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maximumAnisotropy</span> =</span><br><span class="line">      options.<span class="property">maximumAnisotropy</span> !== <span class="literal">undefined</span> ? options.<span class="property">maximumAnisotropy</span> : <span class="number">16</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// credit: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç‰ˆæƒä¿¡æ¯</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">credit</span> = options.<span class="property">credit</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// addTo - æ·»åŠ åˆ°åœ°å›¾</span></span><br><span class="line">  <span class="title function_">addTo</span>(<span class="params">map</span>) &#123;</span><br><span class="line">    map.<span class="property">basemap</span> = <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// remove - ä»åœ°å›¾ç§»é™¤</span></span><br><span class="line">  <span class="title function_">remove</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">map</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">map</span>.<span class="property">basemap</span> = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setOpacity - è®¾ç½®é€æ˜åº¦</span></span><br><span class="line">  <span class="title function_">setOpacity</span>(<span class="params">alpha</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">alpha</span> = alpha</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">update</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setBrightness - è®¾ç½®äº®åº¦</span></span><br><span class="line">  <span class="title function_">setBrightness</span>(<span class="params">brightness</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">brightness</span> = brightness</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">update</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setContrast - è®¾ç½®å¯¹æ¯”åº¦</span></span><br><span class="line">  <span class="title function_">setContrast</span>(<span class="params">contrast</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">contrast</span> = contrast</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">update</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// update - æ›´æ–°å›¾å±‚</span></span><br><span class="line">  <span class="title function_">update</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// è§¦å‘å›¾å±‚æ›´æ–°</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// flyTo - é£è¡Œåˆ°å›¾å±‚èŒƒå›´</span></span><br><span class="line">  <span class="title function_">flyTo</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">rectangle</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">map</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">flyToRectangle</span>(<span class="variable language_">this</span>.<span class="property">rectangle</span>, options)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// XYZå›¾å±‚</span></span><br><span class="line"><span class="keyword">const</span> xyzLayer = <span class="keyword">new</span> mars3d.<span class="property">layer</span>.<span class="title class_">XyzLayer</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;OpenStreetMap&#x27;</span>,</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;https://tile.openstreetmap.org/&#123;z&#125;/&#123;x&#125;/&#123;y&#125;.png&#x27;</span>,</span><br><span class="line">  <span class="attr">maximumLevel</span>: <span class="number">18</span>,</span><br><span class="line">  <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤©åœ°å›¾å›¾å±‚</span></span><br><span class="line"><span class="keyword">const</span> tdtLayer = <span class="keyword">new</span> mars3d.<span class="property">layer</span>.<span class="title class_">TdtLayer</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;å¤©åœ°å›¾å½±åƒ&#x27;</span>,</span><br><span class="line">  <span class="attr">layer</span>: <span class="string">&#x27;img_d&#x27;</span>,</span><br><span class="line">  <span class="attr">key</span>: [<span class="string">&#x27;your-key-1&#x27;</span>, <span class="string">&#x27;your-key-2&#x27;</span>],</span><br><span class="line">  <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// WMSå›¾å±‚</span></span><br><span class="line"><span class="keyword">const</span> wmsLayer = <span class="keyword">new</span> mars3d.<span class="property">layer</span>.<span class="title class_">WmsLayer</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;WMSæœåŠ¡&#x27;</span>,</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;https://example.com/wms&#x27;</span>,</span><br><span class="line">  <span class="attr">layers</span>: <span class="string">&#x27;layer_name&#x27;</span>,</span><br><span class="line">  <span class="attr">parameters</span>: &#123;</span><br><span class="line">    <span class="attr">format</span>: <span class="string">&#x27;image/png&#x27;</span>,</span><br><span class="line">    <span class="attr">transparent</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ArcGISå›¾å±‚</span></span><br><span class="line"><span class="keyword">const</span> arcgisLayer = <span class="keyword">new</span> mars3d.<span class="property">layer</span>.<span class="title class_">ArcGisLayer</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;ArcGISæœåŠ¡&#x27;</span>,</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer&#x27;</span>,</span><br><span class="line">  <span class="attr">maximumLevel</span>: <span class="number">17</span>,</span><br><span class="line">  <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line">map.<span class="title function_">addLayer</span>(xyzLayer)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒæ•´å›¾å±‚æ ·å¼</span></span><br><span class="line">xyzLayer.<span class="title function_">setOpacity</span>(<span class="number">0.8</span>)</span><br><span class="line">xyzLayer.<span class="title function_">setBrightness</span>(<span class="number">1.2</span>)</span><br><span class="line">xyzLayer.<span class="title function_">setContrast</span>(<span class="number">1.1</span>)</span><br></pre></td></tr></table></figure><h3 id="GroupLayer-å›¾å±‚ç»„"><a href="#GroupLayer-å›¾å±‚ç»„" class="headerlink" title="GroupLayer å›¾å±‚ç»„"></a>GroupLayer å›¾å±‚ç»„</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GroupLayer - å›¾å±‚ç»„</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GroupLayer</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// layers: Array&lt;BaseLayer&gt;</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å­å›¾å±‚æ•°ç»„</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: []</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layers</span> = options.<span class="property">layers</span> || []</span><br><span class="line"></span><br><span class="line">    <span class="comment">// name: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å›¾å±‚ç»„åç§°</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = options.<span class="property">name</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// show: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºæ•´ä¸ªå›¾å±‚ç»„</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// addLayer - æ·»åŠ å­å›¾å±‚</span></span><br><span class="line">  <span class="title function_">addLayer</span>(<span class="params">layer</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layers</span>.<span class="title function_">push</span>(layer)</span><br><span class="line">    layer.<span class="property">parent</span> = <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// removeLayer - ç§»é™¤å­å›¾å±‚</span></span><br><span class="line">  <span class="title function_">removeLayer</span>(<span class="params">layer</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> index = <span class="variable language_">this</span>.<span class="property">layers</span>.<span class="title function_">indexOf</span>(layer)</span><br><span class="line">    <span class="keyword">if</span> (index &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">layers</span>.<span class="title function_">splice</span>(index, <span class="number">1</span>)</span><br><span class="line">      layer.<span class="property">parent</span> = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getLayerById - æ ¹æ®IDè·å–å›¾å±‚</span></span><br><span class="line">  <span class="title function_">getLayerById</span>(<span class="params">id</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">layers</span>.<span class="title function_">find</span>(<span class="function">(<span class="params">layer</span>) =&gt;</span> layer.<span class="property">id</span> === id)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getLayerByName - æ ¹æ®åç§°è·å–å›¾å±‚</span></span><br><span class="line">  <span class="title function_">getLayerByName</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">layers</span>.<span class="title function_">find</span>(<span class="function">(<span class="params">layer</span>) =&gt;</span> layer.<span class="property">name</span> === name)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setOpacity - è®¾ç½®æ‰€æœ‰å­å›¾å±‚é€æ˜åº¦</span></span><br><span class="line">  <span class="title function_">setOpacity</span>(<span class="params">alpha</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layers</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">layer</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (layer.<span class="property">setOpacity</span>) &#123;</span><br><span class="line">        layer.<span class="title function_">setOpacity</span>(alpha)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setShow - è®¾ç½®æ˜¾ç¤ºçŠ¶æ€</span></span><br><span class="line">  <span class="title function_">setShow</span>(<span class="params">show</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = show</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layers</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">layer</span>) =&gt;</span> &#123;</span><br><span class="line">      layer.<span class="property">show</span> = show</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> groupLayer = <span class="keyword">new</span> mars3d.<span class="property">layer</span>.<span class="title class_">GroupLayer</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;å¤©åœ°å›¾å½±åƒç»„&#x27;</span>,</span><br><span class="line">  <span class="attr">layers</span>: [</span><br><span class="line">    <span class="keyword">new</span> mars3d.<span class="property">layer</span>.<span class="title class_">TdtLayer</span>(&#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;åº•å›¾&#x27;</span>,</span><br><span class="line">      <span class="attr">layer</span>: <span class="string">&#x27;img_d&#x27;</span>,</span><br><span class="line">      <span class="attr">key</span>: [<span class="string">&#x27;your-key&#x27;</span>],</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> mars3d.<span class="property">layer</span>.<span class="title class_">TdtLayer</span>(&#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;æ³¨è®°&#x27;</span>,</span><br><span class="line">      <span class="attr">layer</span>: <span class="string">&#x27;img_z&#x27;</span>,</span><br><span class="line">      <span class="attr">key</span>: [<span class="string">&#x27;your-key&#x27;</span>],</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">map.<span class="title function_">addLayer</span>(groupLayer)</span><br></pre></td></tr></table></figure><h2 id="çŸ¢é‡æ•°æ®è¯¦è§£"><a href="#çŸ¢é‡æ•°æ®è¯¦è§£" class="headerlink" title="çŸ¢é‡æ•°æ®è¯¦è§£"></a>çŸ¢é‡æ•°æ®è¯¦è§£</h2><h3 id="GraphicLayer-çŸ¢é‡å›¾å±‚"><a href="#GraphicLayer-çŸ¢é‡å›¾å±‚" class="headerlink" title="GraphicLayer çŸ¢é‡å›¾å±‚"></a>GraphicLayer çŸ¢é‡å›¾å±‚</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GraphicLayer - çŸ¢é‡å›¾å±‚</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GraphicLayer</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// id: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å›¾å±‚å”¯ä¸€æ ‡è¯†</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = options.<span class="property">id</span> || mars3d.<span class="property">Util</span>.<span class="title function_">uuid</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// name: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å›¾å±‚åç§°</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = options.<span class="property">name</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// show: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤º</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// allowDrillPick: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦å…è®¸é’»å–æ‹¾å–</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">allowDrillPick</span> = options.<span class="property">allowDrillPick</span> !== <span class="literal">undefined</span> ? options.<span class="property">allowDrillPick</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// flyTo: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åŠ è½½åæ˜¯å¦é£è¡Œåˆ°æ•°æ®èŒƒå›´</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">flyTo</span> = options.<span class="property">flyTo</span> !== <span class="literal">undefined</span> ? options.<span class="property">flyTo</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// popup: Object | string | function</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¼¹çª—é…ç½®</span></span><br><span class="line">    <span class="comment">// ç±»å‹: &#x27;all&#x27; | &#x27;æ¨¡æ¿å­—ç¬¦ä¸²&#x27; | é…ç½®å¯¹è±¡ | å›è°ƒå‡½æ•°</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">popup</span> = options.<span class="property">popup</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// tooltip: Object | string | function</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å·¥å…·æç¤ºé…ç½®</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tooltip</span> = options.<span class="property">tooltip</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// contextmenu: Array | function</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å³é”®èœå•é…ç½®</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">contextmenu</span> = options.<span class="property">contextmenu</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// enabledEvent: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦å¯ç”¨é¼ æ ‡äº‹ä»¶</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">enabledEvent</span> = options.<span class="property">enabledEvent</span> !== <span class="literal">undefined</span> ? options.<span class="property">enabledEvent</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// clustering: Object</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: èšåˆé…ç½®</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clustering</span> = options.<span class="property">clustering</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// symbol: Object</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç»Ÿä¸€æ ·å¼é…ç½®</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">symbol</span> = options.<span class="property">symbol</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// style: Object | function</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ ·å¼é…ç½®</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = options.<span class="property">style</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// filter: function</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ•°æ®è¿‡æ»¤å‡½æ•°</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">filter</span> = options.<span class="property">filter</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// hasEdit: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ”¯æŒç¼–è¾‘</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hasEdit</span> = options.<span class="property">hasEdit</span> !== <span class="literal">undefined</span> ? options.<span class="property">hasEdit</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// isAutoEditing: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦è‡ªåŠ¨è¿›å…¥ç¼–è¾‘çŠ¶æ€</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isAutoEditing</span> = options.<span class="property">isAutoEditing</span> !== <span class="literal">undefined</span> ? options.<span class="property">isAutoEditing</span> : <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// addGraphic - æ·»åŠ çŸ¢é‡æ•°æ®</span></span><br><span class="line">  <span class="title function_">addGraphic</span>(<span class="params">graphic</span>) &#123;</span><br><span class="line">    <span class="comment">// graphic: Graphic - çŸ¢é‡æ•°æ®å¯¹è±¡</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="title function_">push</span>(graphic)</span><br><span class="line">    graphic.<span class="property">layer</span> = <span class="variable language_">this</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">fire</span>(<span class="string">&#x27;addGraphic&#x27;</span>, &#123; graphic &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// removeGraphic - ç§»é™¤çŸ¢é‡æ•°æ®</span></span><br><span class="line">  <span class="title function_">removeGraphic</span>(<span class="params">graphic</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> index = <span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="title function_">indexOf</span>(graphic)</span><br><span class="line">    <span class="keyword">if</span> (index &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="title function_">splice</span>(index, <span class="number">1</span>)</span><br><span class="line">      graphic.<span class="property">layer</span> = <span class="literal">null</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">fire</span>(<span class="string">&#x27;removeGraphic&#x27;</span>, &#123; graphic &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getGraphicById - æ ¹æ®IDè·å–çŸ¢é‡æ•°æ®</span></span><br><span class="line">  <span class="title function_">getGraphicById</span>(<span class="params">id</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="title function_">find</span>(<span class="function">(<span class="params">graphic</span>) =&gt;</span> graphic.<span class="property">id</span> === id)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getGraphicsByAttr - æ ¹æ®å±æ€§è·å–çŸ¢é‡æ•°æ®</span></span><br><span class="line">  <span class="title function_">getGraphicsByAttr</span>(<span class="params">attrName, attrVal</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">graphic</span>) =&gt;</span> graphic.<span class="property">attr</span> &amp;&amp; graphic.<span class="property">attr</span>[attrName] === attrVal)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// eachGraphic - éå†æ‰€æœ‰çŸ¢é‡æ•°æ®</span></span><br><span class="line">  <span class="title function_">eachGraphic</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="title function_">forEach</span>(callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// clear - æ¸…ç©ºæ‰€æœ‰æ•°æ®</span></span><br><span class="line">  <span class="title function_">clear</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">graphic</span>) =&gt;</span> graphic.<span class="title function_">destroy</span>())</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphics</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">fire</span>(<span class="string">&#x27;clear&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// load - åŠ è½½å¤–éƒ¨æ•°æ®</span></span><br><span class="line">  <span class="title function_">load</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="comment">// options: Object</span></span><br><span class="line">    <span class="comment">// url: string - æ•°æ®åœ°å€</span></span><br><span class="line">    <span class="comment">// type: string - æ•°æ®ç±»å‹ (&#x27;geojson&#x27;, &#x27;kml&#x27;, &#x27;czml&#x27;, &#x27;json&#x27;)</span></span><br><span class="line">    <span class="comment">// symbol: Object - æ ·å¼é…ç½®</span></span><br><span class="line">    <span class="comment">// callback: function - å›è°ƒå‡½æ•°</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">Util</span>.<span class="title function_">fetchJson</span>(&#123; <span class="attr">url</span>: options.<span class="property">url</span> &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">loadData</span>(data, options)</span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">callback</span>) &#123;</span><br><span class="line">        options.<span class="title function_">callback</span>(data)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// loadData - åŠ è½½æ•°æ®</span></span><br><span class="line">  <span class="title function_">loadData</span>(<span class="params">data, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (data.<span class="property">type</span> === <span class="string">&#x27;FeatureCollection&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// GeoJSONæ•°æ®</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">loadGeoJSON</span>(data, options)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(data)) &#123;</span><br><span class="line">      <span class="comment">// æ•°ç»„æ•°æ®</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">loadArray</span>(data, options)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// loadGeoJSON - åŠ è½½GeoJSONæ•°æ®</span></span><br><span class="line">  <span class="title function_">loadGeoJSON</span>(<span class="params">geojson, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    geojson.<span class="property">features</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">feature</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> graphic = <span class="variable language_">this</span>.<span class="title function_">createGraphicFromFeature</span>(feature, options)</span><br><span class="line">      <span class="keyword">if</span> (graphic) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">addGraphic</span>(graphic)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">flyTo</span> || <span class="variable language_">this</span>.<span class="property">flyTo</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">flyTo</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// createGraphicFromFeature - ä»Featureåˆ›å»ºçŸ¢é‡æ•°æ®</span></span><br><span class="line">  <span class="title function_">createGraphicFromFeature</span>(<span class="params">feature, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> geometry = feature.<span class="property">geometry</span></span><br><span class="line">    <span class="keyword">const</span> properties = feature.<span class="property">properties</span> || &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> graphic</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (geometry.<span class="property">type</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;Point&#x27;</span>:</span><br><span class="line">        graphic = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PointEntity</span>(&#123;</span><br><span class="line">          <span class="attr">position</span>: geometry.<span class="property">coordinates</span>,</span><br><span class="line">          <span class="attr">style</span>: <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, <span class="variable language_">this</span>.<span class="property">symbol</span>, options.<span class="property">symbol</span>),</span><br><span class="line">          <span class="attr">attr</span>: properties,</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;LineString&#x27;</span>:</span><br><span class="line">        graphic = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolylineEntity</span>(&#123;</span><br><span class="line">          <span class="attr">positions</span>: geometry.<span class="property">coordinates</span>,</span><br><span class="line">          <span class="attr">style</span>: <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, <span class="variable language_">this</span>.<span class="property">symbol</span>, options.<span class="property">symbol</span>),</span><br><span class="line">          <span class="attr">attr</span>: properties,</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;Polygon&#x27;</span>:</span><br><span class="line">        graphic = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolygonEntity</span>(&#123;</span><br><span class="line">          <span class="attr">positions</span>: geometry.<span class="property">coordinates</span>[<span class="number">0</span>], <span class="comment">// æš‚æ—¶åªå¤„ç†å¤–ç¯</span></span><br><span class="line">          <span class="attr">style</span>: <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, <span class="variable language_">this</span>.<span class="property">symbol</span>, options.<span class="property">symbol</span>),</span><br><span class="line">          <span class="attr">attr</span>: properties,</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;ä¸æ”¯æŒçš„å‡ ä½•ç±»å‹:&#x27;</span>, geometry.<span class="property">type</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> graphic</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// toGeoJSON - å¯¼å‡ºä¸ºGeoJSON</span></span><br><span class="line">  <span class="title function_">toGeoJSON</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> features = <span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">graphic</span>) =&gt;</span> graphic.<span class="title function_">toGeoJSON</span>()).<span class="title function_">filter</span>(<span class="title class_">Boolean</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;FeatureCollection&#x27;</span>,</span><br><span class="line">      <span class="attr">features</span>: features,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// flyTo - é£è¡Œåˆ°å›¾å±‚èŒƒå›´</span></span><br><span class="line">  <span class="title function_">flyTo</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> bounds = <span class="variable language_">this</span>.<span class="title function_">getBounds</span>()</span><br><span class="line">    <span class="keyword">if</span> (bounds) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">flyToExtent</span>(bounds, options)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getBounds - è·å–æ•°æ®èŒƒå›´</span></span><br><span class="line">  <span class="title function_">getBounds</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> xmin = <span class="title class_">Infinity</span>,</span><br><span class="line">      ymin = <span class="title class_">Infinity</span>,</span><br><span class="line">      xmax = -<span class="title class_">Infinity</span>,</span><br><span class="line">      ymax = -<span class="title class_">Infinity</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">graphic</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> bounds = graphic.<span class="title function_">getBounds</span>()</span><br><span class="line">      <span class="keyword">if</span> (bounds) &#123;</span><br><span class="line">        xmin = <span class="title class_">Math</span>.<span class="title function_">min</span>(xmin, bounds.<span class="property">xmin</span>)</span><br><span class="line">        ymin = <span class="title class_">Math</span>.<span class="title function_">min</span>(ymin, bounds.<span class="property">ymin</span>)</span><br><span class="line">        xmax = <span class="title class_">Math</span>.<span class="title function_">max</span>(xmax, bounds.<span class="property">xmax</span>)</span><br><span class="line">        ymax = <span class="title class_">Math</span>.<span class="title function_">max</span>(ymax, bounds.<span class="property">ymax</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; xmin, ymin, xmax, ymax &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// enableEdit - å¯ç”¨ç¼–è¾‘</span></span><br><span class="line">  <span class="title function_">enableEdit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hasEdit</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">graphic</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (graphic.<span class="property">enableEdit</span>) &#123;</span><br><span class="line">        graphic.<span class="title function_">enableEdit</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// disableEdit - ç¦ç”¨ç¼–è¾‘</span></span><br><span class="line">  <span class="title function_">disableEdit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hasEdit</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">graphic</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (graphic.<span class="property">disableEdit</span>) &#123;</span><br><span class="line">        graphic.<span class="title function_">disableEdit</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> graphicLayer = <span class="keyword">new</span> mars3d.<span class="property">layer</span>.<span class="title class_">GraphicLayer</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;çŸ¢é‡æ•°æ®å›¾å±‚&#x27;</span>,</span><br><span class="line">  <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">popup</span>: <span class="string">&#x27;all&#x27;</span>,</span><br><span class="line">  <span class="attr">symbol</span>: &#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&#x27;#ff0000&#x27;</span>,</span><br><span class="line">    <span class="attr">width</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">opacity</span>: <span class="number">0.8</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">map.<span class="title function_">addLayer</span>(graphicLayer)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŠ è½½GeoJSONæ•°æ®</span></span><br><span class="line">graphicLayer.<span class="title function_">load</span>(&#123;</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;data/sample.geojson&#x27;</span>,</span><br><span class="line">  <span class="attr">symbol</span>: &#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line">    <span class="attr">width</span>: <span class="number">2</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">flyTo</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ ç‚¹æ•°æ®</span></span><br><span class="line"><span class="keyword">const</span> pointGraphic = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PointEntity</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: [<span class="number">117.207</span>, <span class="number">31.794</span>, <span class="number">100</span>],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&#x27;#ff0000&#x27;</span>,</span><br><span class="line">    <span class="attr">pixelSize</span>: <span class="number">10</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">attr</span>: &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;æµ‹è¯•ç‚¹&#x27;</span>,</span><br><span class="line">    <span class="attr">remark</span>: <span class="string">&#x27;è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç‚¹&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">graphicLayer.<span class="title function_">addGraphic</span>(pointGraphic)</span><br></pre></td></tr></table></figure><h3 id="Graphic-çŸ¢é‡å›¾å½¢ç±»å‹"><a href="#Graphic-çŸ¢é‡å›¾å½¢ç±»å‹" class="headerlink" title="Graphic çŸ¢é‡å›¾å½¢ç±»å‹"></a>Graphic çŸ¢é‡å›¾å½¢ç±»å‹</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PointEntity - ç‚¹å®ä½“</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PointEntity</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// position: Array | LngLatPoint</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç‚¹çš„ä½ç½®</span></span><br><span class="line">    <span class="comment">// æ ¼å¼: [lng, lat, alt] æˆ– LngLatPointå¯¹è±¡</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">position</span> = options.<span class="property">position</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// style: Object</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç‚¹çš„æ ·å¼</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// color: string</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: ç‚¹çš„é¢œè‰²</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: &#x27;#ffff00&#x27;</span></span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// pixelSize: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: ç‚¹çš„åƒç´ å¤§å°</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: 10</span></span><br><span class="line">        <span class="attr">pixelSize</span>: <span class="number">10</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outlineColor: string</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: è½®å»“é¢œè‰²</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: &#x27;#000000&#x27;</span></span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="string">&#x27;#000000&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outlineWidth: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: è½®å»“å®½åº¦</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: 0</span></span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// scaleByDistance: Object</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: åŸºäºè·ç¦»çš„ç¼©æ”¾</span></span><br><span class="line">        <span class="comment">// æ ¼å¼: &#123;near: è·ç¦», nearValue: ç¼©æ”¾å€¼, far: è·ç¦», farValue: ç¼©æ”¾å€¼&#125;</span></span><br><span class="line">        <span class="attr">scaleByDistance</span>: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// heightReference: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: é«˜åº¦å‚è€ƒ</span></span><br><span class="line">        <span class="comment">// é€‰é¡¹: 0(NONE), 1(CLAMP_TO_GROUND), 2(RELATIVE_TO_GROUND)</span></span><br><span class="line">        <span class="attr">heightReference</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// disableDepthTestDistance: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: ç¦ç”¨æ·±åº¦æµ‹è¯•è·ç¦»</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: 0</span></span><br><span class="line">        <span class="attr">disableDepthTestDistance</span>: <span class="number">0</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// attr: Object</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ä¸šåŠ¡å±æ€§æ•°æ®</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">attr</span> = options.<span class="property">attr</span> || &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// popup: Object | string | function</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¼¹çª—é…ç½®</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">popup</span> = options.<span class="property">popup</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// tooltip: Object | string | function</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å·¥å…·æç¤ºé…ç½®</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tooltip</span> = options.<span class="property">tooltip</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BillboardEntity - å›¾æ ‡å®ä½“</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BillboardEntity</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">position</span> = options.<span class="property">position</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// image: string</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: å›¾æ ‡å›¾ç‰‡åœ°å€</span></span><br><span class="line">        <span class="attr">image</span>: <span class="string">&#x27;img/marker.png&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// scale: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: ç¼©æ”¾æ¯”ä¾‹</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">        <span class="attr">scale</span>: <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// horizontalOrigin: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: æ°´å¹³å¯¹é½æ–¹å¼</span></span><br><span class="line">        <span class="comment">// é€‰é¡¹: 0(CENTER), 1(LEFT), 2(RIGHT)</span></span><br><span class="line">        <span class="attr">horizontalOrigin</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// verticalOrigin: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: å‚ç›´å¯¹é½æ–¹å¼</span></span><br><span class="line">        <span class="comment">// é€‰é¡¹: 0(CENTER), 1(BOTTOM), 2(BASELINE), 3(TOP)</span></span><br><span class="line">        <span class="attr">verticalOrigin</span>: <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// width: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: å›¾æ ‡å®½åº¦</span></span><br><span class="line">        <span class="attr">width</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// height: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: å›¾æ ‡é«˜åº¦</span></span><br><span class="line">        <span class="attr">height</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// rotation: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: æ—‹è½¬è§’åº¦ï¼ˆå¼§åº¦ï¼‰</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: 0</span></span><br><span class="line">        <span class="attr">rotation</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// opacity: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: é€æ˜åº¦</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">        <span class="comment">// èŒƒå›´: 0.0 - 1.0</span></span><br><span class="line">        <span class="attr">opacity</span>: <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// color: string</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: æ··åˆé¢œè‰²</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: &#x27;#ffffff&#x27;</span></span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// pixelOffset: Array</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: åƒç´ åç§»</span></span><br><span class="line">        <span class="comment">// æ ¼å¼: [x, y]</span></span><br><span class="line">        <span class="attr">pixelOffset</span>: [<span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line"></span><br><span class="line">        <span class="comment">// scaleByDistance: Object</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: åŸºäºè·ç¦»çš„ç¼©æ”¾</span></span><br><span class="line">        <span class="attr">scaleByDistance</span>: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// distanceDisplayCondition: Object</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: è·ç¦»æ˜¾ç¤ºæ¡ä»¶</span></span><br><span class="line">        <span class="comment">// æ ¼å¼: &#123;near: è·ç¦», far: è·ç¦»&#125;</span></span><br><span class="line">        <span class="attr">distanceDisplayCondition</span>: <span class="literal">null</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">attr</span> = options.<span class="property">attr</span> || &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LabelEntity - æ–‡å­—æ ‡ç­¾å®ä½“</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LabelEntity</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">position</span> = options.<span class="property">position</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// text: string</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: æ˜¾ç¤ºæ–‡å­—</span></span><br><span class="line">        <span class="attr">text</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// font: string</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: å­—ä½“æ ·å¼</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: &#x27;28px sans-serif&#x27;</span></span><br><span class="line">        <span class="attr">font</span>: <span class="string">&#x27;28px sans-serif&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// color: string</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: æ–‡å­—é¢œè‰²</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: &#x27;#ffffff&#x27;</span></span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outlineColor: string</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: è½®å»“é¢œè‰²</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: &#x27;#000000&#x27;</span></span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="string">&#x27;#000000&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outlineWidth: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: è½®å»“å®½åº¦</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: 0</span></span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// backgroundColor: string</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: èƒŒæ™¯é¢œè‰²</span></span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// backgroundPadding: Array</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: èƒŒæ™¯å†…è¾¹è·</span></span><br><span class="line">        <span class="comment">// æ ¼å¼: [x, y]</span></span><br><span class="line">        <span class="attr">backgroundPadding</span>: [<span class="number">7</span>, <span class="number">5</span>],</span><br><span class="line"></span><br><span class="line">        <span class="comment">// pixelOffset: Array</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: åƒç´ åç§»</span></span><br><span class="line">        <span class="attr">pixelOffset</span>: [<span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line"></span><br><span class="line">        <span class="comment">// horizontalOrigin: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: æ°´å¹³å¯¹é½æ–¹å¼</span></span><br><span class="line">        <span class="attr">horizontalOrigin</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// verticalOrigin: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: å‚ç›´å¯¹é½æ–¹å¼</span></span><br><span class="line">        <span class="attr">verticalOrigin</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// scale: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: ç¼©æ”¾æ¯”ä¾‹</span></span><br><span class="line">        <span class="attr">scale</span>: <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// scaleByDistance: Object</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: åŸºäºè·ç¦»çš„ç¼©æ”¾</span></span><br><span class="line">        <span class="attr">scaleByDistance</span>: <span class="literal">null</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">attr</span> = options.<span class="property">attr</span> || &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PolylineEntity - çº¿å®ä½“</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PolylineEntity</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// positions: Array</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: çº¿çš„é¡¶ç‚¹åæ ‡æ•°ç»„</span></span><br><span class="line">    <span class="comment">// æ ¼å¼: [[lng,lat,alt], [lng,lat,alt], ...]</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">positions</span> = options.<span class="property">positions</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// color: string</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: çº¿æ¡é¢œè‰²</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: &#x27;#ffff00&#x27;</span></span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// width: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: çº¿æ¡å®½åº¦</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: 2</span></span><br><span class="line">        <span class="attr">width</span>: <span class="number">2</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// opacity: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: é€æ˜åº¦</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">        <span class="attr">opacity</span>: <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outline: boolean</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºè½®å»“</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">        <span class="attr">outline</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outlineColor: string</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: è½®å»“é¢œè‰²</span></span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="string">&#x27;#000000&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outlineWidth: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: è½®å»“å®½åº¦</span></span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// lineType: string</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: çº¿æ¡ç±»å‹</span></span><br><span class="line">        <span class="comment">// é€‰é¡¹: &#x27;solid&#x27;, &#x27;dash&#x27;, &#x27;dot&#x27;, &#x27;dashdot&#x27;, &#x27;longdash&#x27;</span></span><br><span class="line">        <span class="attr">lineType</span>: <span class="string">&#x27;solid&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// materialType: string</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: æè´¨ç±»å‹</span></span><br><span class="line">        <span class="comment">// é€‰é¡¹: &#x27;Color&#x27;, &#x27;PolylineGlow&#x27;, &#x27;PolylineArrow&#x27;, &#x27;PolylineDash&#x27;</span></span><br><span class="line">        <span class="attr">materialType</span>: <span class="string">&#x27;Color&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// materialOptions: Object</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: æè´¨å‚æ•°</span></span><br><span class="line">        <span class="attr">materialOptions</span>: &#123;&#125;,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// clampToGround: boolean</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: æ˜¯å¦è´´åœ°</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">        <span class="attr">clampToGround</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// zIndex: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: å±‚çº§ï¼ˆè´´åœ°æ—¶æœ‰æ•ˆï¼‰</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: 0</span></span><br><span class="line">        <span class="attr">zIndex</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// closure: boolean</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: æ˜¯å¦é—­åˆ</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">        <span class="attr">closure</span>: <span class="literal">false</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">attr</span> = options.<span class="property">attr</span> || &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PolygonEntity - é¢å®ä½“</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PolygonEntity</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// positions: Array</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é¢çš„è¾¹ç•Œåæ ‡æ•°ç»„</span></span><br><span class="line">    <span class="comment">// æ ¼å¼: [[lng,lat,alt], [lng,lat,alt], ...] æˆ– [å¤–ç¯, å†…ç¯1, å†…ç¯2, ...]</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">positions</span> = options.<span class="property">positions</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// color: string</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: å¡«å……é¢œè‰²</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: &#x27;#ffff00&#x27;</span></span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// opacity: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: å¡«å……é€æ˜åº¦</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: 0.6</span></span><br><span class="line">        <span class="attr">opacity</span>: <span class="number">0.6</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outline: boolean</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºè½®å»“</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">        <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outlineColor: string</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: è½®å»“é¢œè‰²</span></span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outlineWidth: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: è½®å»“å®½åº¦</span></span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outlineOpacity: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: è½®å»“é€æ˜åº¦</span></span><br><span class="line">        <span class="attr">outlineOpacity</span>: <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// fill: boolean</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: æ˜¯å¦å¡«å……</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">        <span class="attr">fill</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// height: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: é«˜åº¦</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: 0</span></span><br><span class="line">        <span class="attr">height</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// extrudedHeight: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: æ‹‰ä¼¸é«˜åº¦</span></span><br><span class="line">        <span class="attr">extrudedHeight</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// clampToGround: boolean</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: æ˜¯å¦è´´åœ°</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">        <span class="attr">clampToGround</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// zIndex: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: å±‚çº§ï¼ˆè´´åœ°æ—¶æœ‰æ•ˆï¼‰</span></span><br><span class="line">        <span class="attr">zIndex</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// materialType: string</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: æè´¨ç±»å‹</span></span><br><span class="line">        <span class="comment">// é€‰é¡¹: &#x27;Color&#x27;, &#x27;Image&#x27;, &#x27;Grid&#x27;, &#x27;Stripe&#x27;, &#x27;Checkerboard&#x27;</span></span><br><span class="line">        <span class="attr">materialType</span>: <span class="string">&#x27;Color&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// materialOptions: Object</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: æè´¨å‚æ•°</span></span><br><span class="line">        <span class="attr">materialOptions</span>: &#123;&#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">attr</span> = options.<span class="property">attr</span> || &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> graphicLayer = <span class="keyword">new</span> mars3d.<span class="property">layer</span>.<span class="title class_">GraphicLayer</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ ç‚¹</span></span><br><span class="line"><span class="keyword">const</span> point = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PointEntity</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: [<span class="number">117.207</span>, <span class="number">31.794</span>, <span class="number">100</span>],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&#x27;#ff0000&#x27;</span>,</span><br><span class="line">    <span class="attr">pixelSize</span>: <span class="number">15</span>,</span><br><span class="line">    <span class="attr">outlineColor</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">    <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">scaleByDistance</span>: &#123;</span><br><span class="line">      <span class="attr">near</span>: <span class="number">100</span>,</span><br><span class="line">      <span class="attr">nearValue</span>: <span class="number">2.0</span>,</span><br><span class="line">      <span class="attr">far</span>: <span class="number">1000000</span>,</span><br><span class="line">      <span class="attr">farValue</span>: <span class="number">0.5</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">attr</span>: &#123; <span class="attr">name</span>: <span class="string">&#x27;æµ‹è¯•ç‚¹&#x27;</span> &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ å›¾æ ‡</span></span><br><span class="line"><span class="keyword">const</span> billboard = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">BillboardEntity</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: [<span class="number">117.208</span>, <span class="number">31.795</span>, <span class="number">0</span>],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">image</span>: <span class="string">&#x27;img/marker/mark-red.png&#x27;</span>,</span><br><span class="line">    <span class="attr">scale</span>: <span class="number">1.5</span>,</span><br><span class="line">    <span class="attr">horizontalOrigin</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">verticalOrigin</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">pixelOffset</span>: [<span class="number">0</span>, -<span class="number">20</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">attr</span>: &#123; <span class="attr">name</span>: <span class="string">&#x27;æ ‡è®°ç‚¹&#x27;</span> &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ æ ‡ç­¾</span></span><br><span class="line"><span class="keyword">const</span> label = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">LabelEntity</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: [<span class="number">117.209</span>, <span class="number">31.796</span>, <span class="number">50</span>],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">text</span>: <span class="string">&#x27;æ–‡å­—æ ‡ç­¾&#x27;</span>,</span><br><span class="line">    <span class="attr">font</span>: <span class="string">&#x27;24px Microsoft YaHei&#x27;</span>,</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">    <span class="attr">outlineColor</span>: <span class="string">&#x27;#000000&#x27;</span>,</span><br><span class="line">    <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">backgroundColor</span>: <span class="string">&#x27;rgba(0,0,0,0.5)&#x27;</span>,</span><br><span class="line">    <span class="attr">pixelOffset</span>: [<span class="number">0</span>, -<span class="number">50</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ çº¿</span></span><br><span class="line"><span class="keyword">const</span> polyline = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolylineEntity</span>(&#123;</span><br><span class="line">  <span class="attr">positions</span>: [</span><br><span class="line">    [<span class="number">117.2</span>, <span class="number">31.79</span>, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">117.21</span>, <span class="number">31.8</span>, <span class="number">100</span>],</span><br><span class="line">    [<span class="number">117.22</span>, <span class="number">31.79</span>, <span class="number">200</span>],</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&#x27;#00ff00&#x27;</span>,</span><br><span class="line">    <span class="attr">width</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">lineType</span>: <span class="string">&#x27;dash&#x27;</span>,</span><br><span class="line">    <span class="attr">materialType</span>: <span class="string">&#x27;PolylineGlow&#x27;</span>,</span><br><span class="line">    <span class="attr">materialOptions</span>: &#123;</span><br><span class="line">      <span class="attr">glowPower</span>: <span class="number">0.2</span>,</span><br><span class="line">      <span class="attr">taperPower</span>: <span class="number">0.5</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ é¢</span></span><br><span class="line"><span class="keyword">const</span> polygon = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolygonEntity</span>(&#123;</span><br><span class="line">  <span class="attr">positions</span>: [</span><br><span class="line">    [<span class="number">117.18</span>, <span class="number">31.78</span>],</span><br><span class="line">    [<span class="number">117.19</span>, <span class="number">31.78</span>],</span><br><span class="line">    [<span class="number">117.19</span>, <span class="number">31.79</span>],</span><br><span class="line">    [<span class="number">117.18</span>, <span class="number">31.79</span>],</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&#x27;#0000ff&#x27;</span>,</span><br><span class="line">    <span class="attr">opacity</span>: <span class="number">0.4</span>,</span><br><span class="line">    <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">outlineColor</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">    <span class="attr">outlineWidth</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">extrudedHeight</span>: <span class="number">200</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰¹é‡æ·»åŠ åˆ°å›¾å±‚</span></span><br><span class="line">graphicLayer.<span class="title function_">addGraphic</span>(point)</span><br><span class="line">graphicLayer.<span class="title function_">addGraphic</span>(billboard)</span><br><span class="line">graphicLayer.<span class="title function_">addGraphic</span>(label)</span><br><span class="line">graphicLayer.<span class="title function_">addGraphic</span>(polyline)</span><br><span class="line">graphicLayer.<span class="title function_">addGraphic</span>(polygon)</span><br><span class="line"></span><br><span class="line">map.<span class="title function_">addLayer</span>(graphicLayer)</span><br></pre></td></tr></table></figure><h2 id="ä¸‰ç»´æ¨¡å‹è¯¦è§£"><a href="#ä¸‰ç»´æ¨¡å‹è¯¦è§£" class="headerlink" title="ä¸‰ç»´æ¨¡å‹è¯¦è§£"></a>ä¸‰ç»´æ¨¡å‹è¯¦è§£</h2><h3 id="ModelEntity-æ¨¡å‹å®ä½“"><a href="#ModelEntity-æ¨¡å‹å®ä½“" class="headerlink" title="ModelEntity æ¨¡å‹å®ä½“"></a>ModelEntity æ¨¡å‹å®ä½“</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ModelEntity - 3Dæ¨¡å‹å®ä½“</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelEntity</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// position: Array | LngLatPoint</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ¨¡å‹ä½ç½®</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">position</span> = options.<span class="property">position</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// style: Object</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ¨¡å‹æ ·å¼é…ç½®</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// url: string</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: æ¨¡å‹æ–‡ä»¶åœ°å€</span></span><br><span class="line">        <span class="comment">// æ”¯æŒ: glTF(.gltf, .glb), COLLADA(.dae), OBJ(.obj)</span></span><br><span class="line">        <span class="attr">url</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// scale: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: ç¼©æ”¾æ¯”ä¾‹</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">        <span class="attr">scale</span>: <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// heading: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: æ–¹å‘è§’ï¼ˆåº¦ï¼‰</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: 0</span></span><br><span class="line">        <span class="attr">heading</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// pitch: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: ä¿¯ä»°è§’ï¼ˆåº¦ï¼‰</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: 0</span></span><br><span class="line">        <span class="attr">pitch</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// roll: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: ç¿»æ»šè§’ï¼ˆåº¦ï¼‰</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: 0</span></span><br><span class="line">        <span class="attr">roll</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// minimumPixelSize: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: æœ€å°åƒç´ å°ºå¯¸</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: 0</span></span><br><span class="line">        <span class="attr">minimumPixelSize</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// maximumScale: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: æœ€å¤§ç¼©æ”¾æ¯”ä¾‹</span></span><br><span class="line">        <span class="attr">maximumScale</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// color: string</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: æ¨¡å‹é¢œè‰²ï¼ˆæ··åˆï¼‰</span></span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// opacity: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: é€æ˜åº¦</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">        <span class="attr">opacity</span>: <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// silhouetteColor: string</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: è½®å»“é¢œè‰²</span></span><br><span class="line">        <span class="attr">silhouetteColor</span>: <span class="string">&#x27;#ff0000&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// silhouetteSize: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: è½®å»“å®½åº¦</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: 0</span></span><br><span class="line">        <span class="attr">silhouetteSize</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// heightReference: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: é«˜åº¦å‚è€ƒ</span></span><br><span class="line">        <span class="comment">// é€‰é¡¹: 0(NONE), 1(CLAMP_TO_GROUND), 2(RELATIVE_TO_GROUND)</span></span><br><span class="line">        <span class="attr">heightReference</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// shadows: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: é˜´å½±æ¨¡å¼</span></span><br><span class="line">        <span class="comment">// é€‰é¡¹: 0(DISABLED), 1(ENABLED), 2(CAST_ONLY), 3(RECEIVE_ONLY)</span></span><br><span class="line">        <span class="attr">shadows</span>: <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// runAnimations: boolean</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: æ˜¯å¦æ’­æ”¾æ¨¡å‹åŠ¨ç”»</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">        <span class="attr">runAnimations</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// clampAnimations: boolean</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: æ˜¯å¦é™åˆ¶åŠ¨ç”»å¾ªç¯</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">        <span class="attr">clampAnimations</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// colorBlendMode: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: é¢œè‰²æ··åˆæ¨¡å¼</span></span><br><span class="line">        <span class="comment">// é€‰é¡¹: 0(HIGHLIGHT), 1(REPLACE), 2(MIX)</span></span><br><span class="line">        <span class="attr">colorBlendMode</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// colorBlendAmount: number</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: é¢œè‰²æ··åˆå¼ºåº¦</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: 0.5</span></span><br><span class="line">        <span class="comment">// èŒƒå›´: 0.0 - 1.0</span></span><br><span class="line">        <span class="attr">colorBlendAmount</span>: <span class="number">0.5</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// incrementallyLoadTextures: boolean</span></span><br><span class="line">        <span class="comment">// ä½œç”¨: æ˜¯å¦æ¸è¿›å¼åŠ è½½çº¹ç†</span></span><br><span class="line">        <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">        <span class="attr">incrementallyLoadTextures</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">attr</span> = options.<span class="property">attr</span> || &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// startAnimation - å¼€å§‹æ’­æ”¾åŠ¨ç”»</span></span><br><span class="line">  <span class="title function_">startAnimation</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="comment">// name: string - åŠ¨ç”»åç§°ï¼ˆå¯é€‰ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_cesiumEntity</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">_cesiumEntity</span>.<span class="property">model</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_cesiumEntity</span>.<span class="property">model</span>.<span class="property">runAnimations</span> = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// stopAnimation - åœæ­¢æ’­æ”¾åŠ¨ç”»</span></span><br><span class="line">  <span class="title function_">stopAnimation</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_cesiumEntity</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">_cesiumEntity</span>.<span class="property">model</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_cesiumEntity</span>.<span class="property">model</span>.<span class="property">runAnimations</span> = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setRotation - è®¾ç½®æ—‹è½¬è§’åº¦</span></span><br><span class="line">  <span class="title function_">setRotation</span>(<span class="params">heading, pitch, roll</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">heading</span> = heading</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">pitch</span> = pitch</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">roll</span> = roll</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">updateStyle</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setScale - è®¾ç½®ç¼©æ”¾æ¯”ä¾‹</span></span><br><span class="line">  <span class="title function_">setScale</span>(<span class="params">scale</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">scale</span> = scale</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">updateStyle</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setColor - è®¾ç½®é¢œè‰²</span></span><br><span class="line">  <span class="title function_">setColor</span>(<span class="params">color, opacity = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">color</span> = color</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">opacity</span> = opacity</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">updateStyle</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setSilhouette - è®¾ç½®è½®å»“</span></span><br><span class="line">  <span class="title function_">setSilhouette</span>(<span class="params">color, size</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">silhouetteColor</span> = color</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">silhouetteSize</span> = size</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">updateStyle</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TilesetLayer - 3Dç“¦ç‰‡å›¾å±‚</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TilesetLayer</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// url: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: 3D TilesæœåŠ¡åœ°å€</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">url</span> = options.<span class="property">url</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// name: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å›¾å±‚åç§°</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = options.<span class="property">name</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// show: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤º</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// maximumScreenSpaceError: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æœ€å¤§å±å¹•ç©ºé—´è¯¯å·®</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 16</span></span><br><span class="line">    <span class="comment">// æ€§èƒ½å½±å“: å€¼è¶Šå°è´¨é‡è¶Šé«˜ï¼Œæ€§èƒ½è¶Šä½</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maximumScreenSpaceError</span> =</span><br><span class="line">      options.<span class="property">maximumScreenSpaceError</span> !== <span class="literal">undefined</span> ? options.<span class="property">maximumScreenSpaceError</span> : <span class="number">16</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// maximumMemoryUsage: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æœ€å¤§å†…å­˜ä½¿ç”¨é‡ï¼ˆMBï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 512</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maximumMemoryUsage</span> =</span><br><span class="line">      options.<span class="property">maximumMemoryUsage</span> !== <span class="literal">undefined</span> ? options.<span class="property">maximumMemoryUsage</span> : <span class="number">512</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// shadows: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: é˜´å½±æ¨¡å¼</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1 (ENABLED)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadows</span> = options.<span class="property">shadows</span> !== <span class="literal">undefined</span> ? options.<span class="property">shadows</span> : <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// style: Object</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: 3D Tilesæ ·å¼</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = options.<span class="property">style</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// customShader: Object</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è‡ªå®šä¹‰ç€è‰²å™¨</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">customShader</span> = options.<span class="property">customShader</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// modelMatrix: Array</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ¨¡å‹å˜æ¢çŸ©é˜µ</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">modelMatrix</span> = options.<span class="property">modelMatrix</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// cullWithChildrenBounds: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦ä½¿ç”¨å­èŠ‚ç‚¹è¾¹ç•Œè¿›è¡Œå‰”é™¤</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cullWithChildrenBounds</span> =</span><br><span class="line">      options.<span class="property">cullWithChildrenBounds</span> !== <span class="literal">undefined</span> ? options.<span class="property">cullWithChildrenBounds</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// skipLevelOfDetail: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦è·³è¿‡LOD</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">skipLevelOfDetail</span> =</span><br><span class="line">      options.<span class="property">skipLevelOfDetail</span> !== <span class="literal">undefined</span> ? options.<span class="property">skipLevelOfDetail</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// baseScreenSpaceError: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åŸºç¡€å±å¹•ç©ºé—´è¯¯å·®</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1024</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">baseScreenSpaceError</span> =</span><br><span class="line">      options.<span class="property">baseScreenSpaceError</span> !== <span class="literal">undefined</span> ? options.<span class="property">baseScreenSpaceError</span> : <span class="number">1024</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// skipScreenSpaceErrorFactor: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è·³è¿‡å±å¹•ç©ºé—´è¯¯å·®å› å­</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 16</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">skipScreenSpaceErrorFactor</span> =</span><br><span class="line">      options.<span class="property">skipScreenSpaceErrorFactor</span> !== <span class="literal">undefined</span> ? options.<span class="property">skipScreenSpaceErrorFactor</span> : <span class="number">16</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// skipLevels: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è·³è¿‡çš„å±‚çº§æ•°</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">skipLevels</span> = options.<span class="property">skipLevels</span> !== <span class="literal">undefined</span> ? options.<span class="property">skipLevels</span> : <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// immediatelyLoadDesiredLevelOfDetail: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦ç«‹å³åŠ è½½æ‰€éœ€çš„LOD</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">immediatelyLoadDesiredLevelOfDetail</span> =</span><br><span class="line">      options.<span class="property">immediatelyLoadDesiredLevelOfDetail</span> !== <span class="literal">undefined</span></span><br><span class="line">        ? options.<span class="property">immediatelyLoadDesiredLevelOfDetail</span></span><br><span class="line">        : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// loadSiblings: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦åŠ è½½å…„å¼ŸèŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loadSiblings</span> = options.<span class="property">loadSiblings</span> !== <span class="literal">undefined</span> ? options.<span class="property">loadSiblings</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// clippingPlanes: Object</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: è£å‰ªå¹³é¢é…ç½®</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clippingPlanes</span> = options.<span class="property">clippingPlanes</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// setStyle - è®¾ç½®æ ·å¼</span></span><br><span class="line">  <span class="title function_">setStyle</span>(<span class="params">style</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = style</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_tileset</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_tileset</span>.<span class="property">style</span> = <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">Cesium3DTileStyle</span>(style)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setCustomShader - è®¾ç½®è‡ªå®šä¹‰ç€è‰²å™¨</span></span><br><span class="line">  <span class="title function_">setCustomShader</span>(<span class="params">shader</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">customShader</span> = shader</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_tileset</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_tileset</span>.<span class="property">customShader</span> = <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">CustomShader</span>(shader)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setClippingPlanes - è®¾ç½®è£å‰ªå¹³é¢</span></span><br><span class="line">  <span class="title function_">setClippingPlanes</span>(<span class="params">planes</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clippingPlanes</span> = planes</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_tileset</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_tileset</span>.<span class="property">clippingPlanes</span> = <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">ClippingPlaneCollection</span>(planes)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setMaximumScreenSpaceError - è®¾ç½®æœ€å¤§å±å¹•ç©ºé—´è¯¯å·®</span></span><br><span class="line">  <span class="title function_">setMaximumScreenSpaceError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maximumScreenSpaceError</span> = error</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_tileset</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_tileset</span>.<span class="property">maximumScreenSpaceError</span> = error</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ 3Dæ¨¡å‹</span></span><br><span class="line"><span class="keyword">const</span> modelEntity = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">ModelEntity</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: [<span class="number">117.207</span>, <span class="number">31.794</span>, <span class="number">100</span>],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;model/building.gltf&#x27;</span>,</span><br><span class="line">    <span class="attr">scale</span>: <span class="number">2.0</span>,</span><br><span class="line">    <span class="attr">heading</span>: <span class="number">45</span>,</span><br><span class="line">    <span class="attr">minimumPixelSize</span>: <span class="number">64</span>,</span><br><span class="line">    <span class="attr">silhouetteColor</span>: <span class="string">&#x27;#00ff00&#x27;</span>,</span><br><span class="line">    <span class="attr">silhouetteSize</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">shadows</span>: <span class="number">1</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">attr</span>: &#123; <span class="attr">name</span>: <span class="string">&#x27;å»ºç­‘æ¨¡å‹&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;building&#x27;</span> &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">graphicLayer.<span class="title function_">addGraphic</span>(modelEntity)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ 3Dç“¦ç‰‡å›¾å±‚</span></span><br><span class="line"><span class="keyword">const</span> tilesetLayer = <span class="keyword">new</span> mars3d.<span class="property">layer</span>.<span class="title class_">TilesetLayer</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;å€¾æ–œæ‘„å½±&#x27;</span>,</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;https://example.com/tileset.json&#x27;</span>,</span><br><span class="line">  <span class="attr">maximumScreenSpaceError</span>: <span class="number">8</span>,</span><br><span class="line">  <span class="attr">maximumMemoryUsage</span>: <span class="number">1024</span>,</span><br><span class="line">  <span class="attr">skipLevelOfDetail</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">baseScreenSpaceError</span>: <span class="number">1024</span>,</span><br><span class="line">  <span class="attr">skipScreenSpaceErrorFactor</span>: <span class="number">16</span>,</span><br><span class="line">  <span class="attr">skipLevels</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&quot;color(&#x27;#ffffff&#x27;)&quot;</span>,</span><br><span class="line">    <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">customShader</span>: &#123;</span><br><span class="line">    <span class="attr">fragmentShaderText</span>: <span class="string">`</span></span><br><span class="line"><span class="string">      void fragmentMain(FragmentInput fsInput, inout czm_modelMaterial material) &#123;</span></span><br><span class="line"><span class="string">        material.diffuse *= 1.2; // å¢åŠ äº®åº¦</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    `</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">map.<span class="title function_">addLayer</span>(tilesetLayer)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¨¡å‹æ“ä½œç¤ºä¾‹</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// æ—‹è½¬æ¨¡å‹</span></span><br><span class="line">  modelEntity.<span class="title function_">setRotation</span>(<span class="number">90</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ”¹å˜é¢œè‰²</span></span><br><span class="line">  modelEntity.<span class="title function_">setColor</span>(<span class="string">&#x27;#ff0000&#x27;</span>, <span class="number">0.8</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®è½®å»“</span></span><br><span class="line">  modelEntity.<span class="title function_">setSilhouette</span>(<span class="string">&#x27;#ffff00&#x27;</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœæ­¢åŠ¨ç”»</span></span><br><span class="line">  modelEntity.<span class="title function_">stopAnimation</span>()</span><br><span class="line">&#125;, <span class="number">3000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3Dç“¦ç‰‡æ ·å¼è°ƒæ•´</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// ä¿®æ”¹æ ·å¼</span></span><br><span class="line">  tilesetLayer.<span class="title function_">setStyle</span>(&#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&quot;color(&#x27;#ff0000&#x27;, 0.8)&quot;</span>,</span><br><span class="line">    <span class="attr">show</span>: <span class="string">&#x27;$&#123;Height&#125; &gt; 100&#x27;</span>, <span class="comment">// åªæ˜¾ç¤ºé«˜åº¦å¤§äº100çš„è¦ç´ </span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è°ƒæ•´æ€§èƒ½å‚æ•°</span></span><br><span class="line">  tilesetLayer.<span class="title function_">setMaximumScreenSpaceError</span>(<span class="number">4</span>) <span class="comment">// æé«˜è´¨é‡</span></span><br><span class="line">&#125;, <span class="number">5000</span>)</span><br></pre></td></tr></table></figure><h2 id="ç›¸æœºæ§åˆ¶å®Œæ•´å±æ€§"><a href="#ç›¸æœºæ§åˆ¶å®Œæ•´å±æ€§" class="headerlink" title="ç›¸æœºæ§åˆ¶å®Œæ•´å±æ€§"></a>ç›¸æœºæ§åˆ¶å®Œæ•´å±æ€§</h2><h3 id="CameraControl-ç›¸æœºæ§åˆ¶"><a href="#CameraControl-ç›¸æœºæ§åˆ¶" class="headerlink" title="CameraControl ç›¸æœºæ§åˆ¶"></a>CameraControl ç›¸æœºæ§åˆ¶</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraControl - ç›¸æœºæ§åˆ¶ç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CameraControl</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span> = map</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span> = map.<span class="property">viewer</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span> = map.<span class="property">camera</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½ç½®æ§åˆ¶æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// setCameraView - è®¾ç½®ç›¸æœºè§†è§’</span></span><br><span class="line">  <span class="title function_">setCameraView</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="comment">// destination: Array | Object</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç›®æ ‡ä½ç½®</span></span><br><span class="line">    <span class="comment">// æ ¼å¼: [lng, lat, alt] æˆ– &#123;lng, lat, alt, heading, pitch, roll&#125;</span></span><br><span class="line">    <span class="keyword">const</span> destination = options.<span class="property">destination</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// heading: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ–¹å‘è§’ï¼ˆåº¦ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 0</span></span><br><span class="line">    <span class="keyword">const</span> heading = options.<span class="property">heading</span> || <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// pitch: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ä¿¯ä»°è§’ï¼ˆåº¦ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: -90</span></span><br><span class="line">    <span class="keyword">const</span> pitch = options.<span class="property">pitch</span> !== <span class="literal">undefined</span> ? options.<span class="property">pitch</span> : -<span class="number">90</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// roll: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç¿»æ»šè§’ï¼ˆåº¦ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 0</span></span><br><span class="line">    <span class="keyword">const</span> roll = options.<span class="property">roll</span> || <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// duration: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åŠ¨ç”»æ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 0ï¼ˆç«‹å³è·³è½¬ï¼‰</span></span><br><span class="line">    <span class="keyword">const</span> duration = options.<span class="property">duration</span> || <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (duration &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">flyToPosition</span>(destination, &#123; heading, pitch, roll, duration &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setPosition</span>(destination, &#123; heading, pitch, roll &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// flyToPosition - é£è¡Œåˆ°ä½ç½®</span></span><br><span class="line">  <span class="title function_">flyToPosition</span>(<span class="params">destination, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> flyOptions = &#123;</span><br><span class="line">      <span class="attr">destination</span>: mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(destination).<span class="title function_">toCartesian</span>(),</span><br><span class="line">      <span class="attr">orientation</span>: &#123;</span><br><span class="line">        <span class="attr">heading</span>: mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(options.<span class="property">heading</span> || <span class="number">0</span>),</span><br><span class="line">        <span class="attr">pitch</span>: mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(options.<span class="property">pitch</span> || -<span class="number">30</span>),</span><br><span class="line">        <span class="attr">roll</span>: mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(options.<span class="property">roll</span> || <span class="number">0</span>),</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">duration</span>: options.<span class="property">duration</span> || <span class="number">3</span>,</span><br><span class="line">      <span class="attr">complete</span>: options.<span class="property">complete</span>,</span><br><span class="line">      <span class="attr">cancel</span>: options.<span class="property">cancel</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">flyTo</span>(flyOptions)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setPosition - è®¾ç½®ä½ç½®ï¼ˆç«‹å³è·³è½¬ï¼‰</span></span><br><span class="line">  <span class="title function_">setPosition</span>(<span class="params">destination, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">setView</span>(&#123;</span><br><span class="line">      <span class="attr">destination</span>: mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(destination).<span class="title function_">toCartesian</span>(),</span><br><span class="line">      <span class="attr">orientation</span>: &#123;</span><br><span class="line">        <span class="attr">heading</span>: mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(options.<span class="property">heading</span> || <span class="number">0</span>),</span><br><span class="line">        <span class="attr">pitch</span>: mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(options.<span class="property">pitch</span> || -<span class="number">30</span>),</span><br><span class="line">        <span class="attr">roll</span>: mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(options.<span class="property">roll</span> || <span class="number">0</span>),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// flyToExtent - é£è¡Œåˆ°èŒƒå›´</span></span><br><span class="line">  <span class="title function_">flyToExtent</span>(<span class="params">extent, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// extent: Object</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: èŒƒå›´è¾¹ç•Œ</span></span><br><span class="line">    <span class="comment">// æ ¼å¼: &#123;xmin, ymin, xmax, ymax&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> rectangle = mars3d.<span class="property">Cesium</span>.<span class="property">Rectangle</span>.<span class="title function_">fromDegrees</span>(</span><br><span class="line">      extent.<span class="property">xmin</span>,</span><br><span class="line">      extent.<span class="property">ymin</span>,</span><br><span class="line">      extent.<span class="property">xmax</span>,</span><br><span class="line">      extent.<span class="property">ymax</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">flyTo</span>(&#123;</span><br><span class="line">      <span class="attr">destination</span>: rectangle,</span><br><span class="line">      <span class="attr">duration</span>: options.<span class="property">duration</span> || <span class="number">3</span>,</span><br><span class="line">      <span class="attr">complete</span>: options.<span class="property">complete</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç›¸æœºç§»åŠ¨æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveForward - å‘å‰ç§»åŠ¨</span></span><br><span class="line">  <span class="title function_">moveForward</span>(<span class="params">distance = <span class="number">1000</span></span>) &#123;</span><br><span class="line">    <span class="comment">// distance: number - ç§»åŠ¨è·ç¦»ï¼ˆç±³ï¼‰</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">moveForward</span>(distance)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveBackward - å‘åç§»åŠ¨</span></span><br><span class="line">  <span class="title function_">moveBackward</span>(<span class="params">distance = <span class="number">1000</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">moveBackward</span>(distance)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveLeft - å‘å·¦ç§»åŠ¨</span></span><br><span class="line">  <span class="title function_">moveLeft</span>(<span class="params">distance = <span class="number">1000</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">moveLeft</span>(distance)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveRight - å‘å³ç§»åŠ¨</span></span><br><span class="line">  <span class="title function_">moveRight</span>(<span class="params">distance = <span class="number">1000</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">moveRight</span>(distance)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveUp - å‘ä¸Šç§»åŠ¨</span></span><br><span class="line">  <span class="title function_">moveUp</span>(<span class="params">distance = <span class="number">1000</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">moveUp</span>(distance)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveDown - å‘ä¸‹ç§»åŠ¨</span></span><br><span class="line">  <span class="title function_">moveDown</span>(<span class="params">distance = <span class="number">1000</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">moveDown</span>(distance)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç›¸æœºæ—‹è½¬æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// rotateLeft - å‘å·¦æ—‹è½¬</span></span><br><span class="line">  <span class="title function_">rotateLeft</span>(<span class="params">angle = <span class="number">15</span></span>) &#123;</span><br><span class="line">    <span class="comment">// angle: number - æ—‹è½¬è§’åº¦ï¼ˆåº¦ï¼‰</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">rotateLeft</span>(mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(angle))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// rotateRight - å‘å³æ—‹è½¬</span></span><br><span class="line">  <span class="title function_">rotateRight</span>(<span class="params">angle = <span class="number">15</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">rotateRight</span>(mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(angle))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// rotateUp - å‘ä¸Šæ—‹è½¬</span></span><br><span class="line">  <span class="title function_">rotateUp</span>(<span class="params">angle = <span class="number">15</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">rotateUp</span>(mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(angle))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// rotateDown - å‘ä¸‹æ—‹è½¬</span></span><br><span class="line">  <span class="title function_">rotateDown</span>(<span class="params">angle = <span class="number">15</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">rotateDown</span>(mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(angle))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// lookLeft - å‘å·¦çœ‹</span></span><br><span class="line">  <span class="title function_">lookLeft</span>(<span class="params">angle = <span class="number">15</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">lookLeft</span>(mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(angle))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// lookRight - å‘å³çœ‹</span></span><br><span class="line">  <span class="title function_">lookRight</span>(<span class="params">angle = <span class="number">15</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">lookRight</span>(mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(angle))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// lookUp - å‘ä¸Šçœ‹</span></span><br><span class="line">  <span class="title function_">lookUp</span>(<span class="params">angle = <span class="number">15</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">lookUp</span>(mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(angle))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// lookDown - å‘ä¸‹çœ‹</span></span><br><span class="line">  <span class="title function_">lookDown</span>(<span class="params">angle = <span class="number">15</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">lookDown</span>(mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(angle))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¼©æ”¾æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// zoomIn - æ”¾å¤§</span></span><br><span class="line">  <span class="title function_">zoomIn</span>(<span class="params">distance = <span class="number">1000</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">zoomIn</span>(distance)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// zoomOut - ç¼©å°</span></span><br><span class="line">  <span class="title function_">zoomOut</span>(<span class="params">distance = <span class="number">1000</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">zoomOut</span>(distance)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// zoomToLevel - ç¼©æ”¾åˆ°æŒ‡å®šçº§åˆ«</span></span><br><span class="line">  <span class="title function_">zoomToLevel</span>(<span class="params">level</span>) &#123;</span><br><span class="line">    <span class="comment">// level: number - ç¼©æ”¾çº§åˆ«</span></span><br><span class="line">    <span class="comment">// èŒƒå›´: 1-20</span></span><br><span class="line">    <span class="keyword">const</span> height = <span class="variable language_">this</span>.<span class="title function_">getHeightByLevel</span>(level)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setHeight</span>(height)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–å’Œè®¾ç½®æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// getPosition - è·å–å½“å‰ä½ç½®</span></span><br><span class="line">  <span class="title function_">getPosition</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> cartographic = <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="property">positionCartographic</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">lng</span>: mars3d.<span class="property">Util</span>.<span class="title function_">toDegrees</span>(cartographic.<span class="property">longitude</span>),</span><br><span class="line">      <span class="attr">lat</span>: mars3d.<span class="property">Util</span>.<span class="title function_">toDegrees</span>(cartographic.<span class="property">latitude</span>),</span><br><span class="line">      <span class="attr">alt</span>: cartographic.<span class="property">height</span>,</span><br><span class="line">      <span class="attr">heading</span>: mars3d.<span class="property">Util</span>.<span class="title function_">toDegrees</span>(<span class="variable language_">this</span>.<span class="property">camera</span>.<span class="property">heading</span>),</span><br><span class="line">      <span class="attr">pitch</span>: mars3d.<span class="property">Util</span>.<span class="title function_">toDegrees</span>(<span class="variable language_">this</span>.<span class="property">camera</span>.<span class="property">pitch</span>),</span><br><span class="line">      <span class="attr">roll</span>: mars3d.<span class="property">Util</span>.<span class="title function_">toDegrees</span>(<span class="variable language_">this</span>.<span class="property">camera</span>.<span class="property">roll</span>),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getHeight - è·å–ç›¸æœºé«˜åº¦</span></span><br><span class="line">  <span class="title function_">getHeight</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="property">positionCartographic</span>.<span class="property">height</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setHeight - è®¾ç½®ç›¸æœºé«˜åº¦</span></span><br><span class="line">  <span class="title function_">setHeight</span>(<span class="params">height</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> cartographic = <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="property">positionCartographic</span></span><br><span class="line">    <span class="keyword">const</span> destination = mars3d.<span class="property">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromRadians</span>(</span><br><span class="line">      cartographic.<span class="property">longitude</span>,</span><br><span class="line">      cartographic.<span class="property">latitude</span>,</span><br><span class="line">      height,</span><br><span class="line">    )</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">setView</span>(&#123; destination &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getHeading - è·å–æ–¹å‘è§’</span></span><br><span class="line">  <span class="title function_">getHeading</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">Util</span>.<span class="title function_">toDegrees</span>(<span class="variable language_">this</span>.<span class="property">camera</span>.<span class="property">heading</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setHeading - è®¾ç½®æ–¹å‘è§’</span></span><br><span class="line">  <span class="title function_">setHeading</span>(<span class="params">heading</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> position = <span class="variable language_">this</span>.<span class="title function_">getPosition</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setPosition</span>([position.<span class="property">lng</span>, position.<span class="property">lat</span>, position.<span class="property">alt</span>], &#123;</span><br><span class="line">      <span class="attr">heading</span>: heading,</span><br><span class="line">      <span class="attr">pitch</span>: position.<span class="property">pitch</span>,</span><br><span class="line">      <span class="attr">roll</span>: position.<span class="property">roll</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getPitch - è·å–ä¿¯ä»°è§’</span></span><br><span class="line">  <span class="title function_">getPitch</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">Util</span>.<span class="title function_">toDegrees</span>(<span class="variable language_">this</span>.<span class="property">camera</span>.<span class="property">pitch</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setPitch - è®¾ç½®ä¿¯ä»°è§’</span></span><br><span class="line">  <span class="title function_">setPitch</span>(<span class="params">pitch</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> position = <span class="variable language_">this</span>.<span class="title function_">getPosition</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setPosition</span>([position.<span class="property">lng</span>, position.<span class="property">lat</span>, position.<span class="property">alt</span>], &#123;</span><br><span class="line">      <span class="attr">heading</span>: position.<span class="property">heading</span>,</span><br><span class="line">      <span class="attr">pitch</span>: pitch,</span><br><span class="line">      <span class="attr">roll</span>: position.<span class="property">roll</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å®ç”¨æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// getHeightByLevel - æ ¹æ®çº§åˆ«è®¡ç®—é«˜åº¦</span></span><br><span class="line">  <span class="title function_">getHeightByLevel</span>(<span class="params">level</span>) &#123;</span><br><span class="line">    <span class="comment">// æ ¹æ®ç»éªŒå…¬å¼è®¡ç®—</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">pow</span>(<span class="number">2</span>, <span class="number">20</span> - level) * <span class="number">256</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getLevelByHeight - æ ¹æ®é«˜åº¦è®¡ç®—çº§åˆ«</span></span><br><span class="line">  <span class="title function_">getLevelByHeight</span>(<span class="params">height</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="number">1</span>, <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="number">20</span>, <span class="title class_">Math</span>.<span class="title function_">round</span>(<span class="number">20</span> - <span class="title class_">Math</span>.<span class="title function_">log2</span>(height / <span class="number">256</span>))))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// isInView - åˆ¤æ–­ä½ç½®æ˜¯å¦åœ¨è§†é‡å†…</span></span><br><span class="line">  <span class="title function_">isInView</span>(<span class="params">position</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> cartesian = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(position).<span class="title function_">toCartesian</span>()</span><br><span class="line">    <span class="keyword">const</span> windowPosition = mars3d.<span class="property">Cesium</span>.<span class="property">SceneTransforms</span>.<span class="title function_">worldToWindowCoordinates</span>(</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">scene</span>,</span><br><span class="line">      cartesian,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!windowPosition) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> canvas = <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">canvas</span></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      windowPosition.<span class="property">x</span> &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">      windowPosition.<span class="property">x</span> &lt;= canvas.<span class="property">clientWidth</span> &amp;&amp;</span><br><span class="line">      windowPosition.<span class="property">y</span> &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">      windowPosition.<span class="property">y</span> &lt;= canvas.<span class="property">clientHeight</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// pickPosition - æ‹¾å–å±å¹•ä½ç½®å¯¹åº”çš„åœ°ç†åæ ‡</span></span><br><span class="line">  <span class="title function_">pickPosition</span>(<span class="params">screenPosition</span>) &#123;</span><br><span class="line">    <span class="comment">// screenPosition: Object - å±å¹•åæ ‡ &#123;x, y&#125;</span></span><br><span class="line">    <span class="keyword">const</span> cartesian = <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">camera</span>.<span class="title function_">pickEllipsoid</span>(screenPosition)</span><br><span class="line">    <span class="keyword">if</span> (cartesian) &#123;</span><br><span class="line">      <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">cartesian2lonlat</span>(cartesian)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›¸æœºæ§åˆ¶ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> cameraControl = <span class="keyword">new</span> <span class="title class_">CameraControl</span>(map)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®ç›¸æœºä½ç½®</span></span><br><span class="line">cameraControl.<span class="title function_">setCameraView</span>(&#123;</span><br><span class="line">  <span class="attr">destination</span>: [<span class="number">117.207</span>, <span class="number">31.794</span>, <span class="number">5000</span>],</span><br><span class="line">  <span class="attr">heading</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">pitch</span>: -<span class="number">45</span>,</span><br><span class="line">  <span class="attr">roll</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">duration</span>: <span class="number">3</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// é£è¡Œåˆ°æŒ‡å®šèŒƒå›´</span></span><br><span class="line">cameraControl.<span class="title function_">flyToExtent</span>(</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">xmin</span>: <span class="number">117.0</span>,</span><br><span class="line">    <span class="attr">ymin</span>: <span class="number">31.5</span>,</span><br><span class="line">    <span class="attr">xmax</span>: <span class="number">117.5</span>,</span><br><span class="line">    <span class="attr">ymax</span>: <span class="number">32.0</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">duration</span>: <span class="number">5</span> &#125;,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›¸æœºç§»åŠ¨</span></span><br><span class="line">cameraControl.<span class="title function_">moveForward</span>(<span class="number">1000</span>)</span><br><span class="line">cameraControl.<span class="title function_">rotateLeft</span>(<span class="number">30</span>)</span><br><span class="line">cameraControl.<span class="title function_">zoomIn</span>(<span class="number">500</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å½“å‰ä½ç½®</span></span><br><span class="line"><span class="keyword">const</span> currentPosition = cameraControl.<span class="title function_">getPosition</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å½“å‰ç›¸æœºä½ç½®:&#x27;</span>, currentPosition)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®ç›¸æœºé«˜åº¦</span></span><br><span class="line">cameraControl.<span class="title function_">setHeight</span>(<span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ¤æ–­ä½ç½®æ˜¯å¦åœ¨è§†é‡å†…</span></span><br><span class="line"><span class="keyword">const</span> isVisible = cameraControl.<span class="title function_">isInView</span>([<span class="number">117.207</span>, <span class="number">31.794</span>, <span class="number">0</span>])</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ä½ç½®æ˜¯å¦å¯è§:&#x27;</span>, isVisible)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘å¬ç›¸æœºå˜åŒ–äº‹ä»¶</span></span><br><span class="line">map.<span class="title function_">on</span>(<span class="string">&#x27;cameraChanged&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> position = cameraControl.<span class="title function_">getPosition</span>()</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç›¸æœºä½ç½®å˜åŒ–:&#x27;</span>, position)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="äº‹ä»¶ç³»ç»Ÿè¯¦è§£"><a href="#äº‹ä»¶ç³»ç»Ÿè¯¦è§£" class="headerlink" title="äº‹ä»¶ç³»ç»Ÿè¯¦è§£"></a>äº‹ä»¶ç³»ç»Ÿè¯¦è§£</h2><h3 id="åœ°å›¾äº‹ä»¶ç›‘å¬"><a href="#åœ°å›¾äº‹ä»¶ç›‘å¬" class="headerlink" title="åœ°å›¾äº‹ä»¶ç›‘å¬"></a>åœ°å›¾äº‹ä»¶ç›‘å¬</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Map äº‹ä»¶ç³»ç»Ÿ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MapEvents</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span> = map</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span> = map.<span class="property">viewer</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é¼ æ ‡äº‹ä»¶</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// click - é¼ æ ‡ç‚¹å‡»äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onClick</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="comment">// callback: function(event) - å›è°ƒå‡½æ•°</span></span><br><span class="line">    <span class="comment">// event.position: Object - å±å¹•åæ ‡ &#123;x, y&#125;</span></span><br><span class="line">    <span class="comment">// event.pickedObject: Object - æ‹¾å–åˆ°çš„å¯¹è±¡</span></span><br><span class="line">    <span class="comment">// event.cartesian: Object - ç¬›å¡å°”åæ ‡</span></span><br><span class="line">    <span class="comment">// event.cartographic: Object - åœ°ç†åæ ‡</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// rightClick - é¼ æ ‡å³é”®ç‚¹å‡»äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onRightClick</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;rightClick&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// doubleClick - é¼ æ ‡åŒå‡»äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onDoubleClick</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;doubleClick&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mouseMove - é¼ æ ‡ç§»åŠ¨äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onMouseMove</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="comment">// é¢‘ç¹è§¦å‘ï¼Œå»ºè®®ä½¿ç”¨èŠ‚æµ</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;mouseMove&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mouseOver - é¼ æ ‡æ‚¬åœäº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onMouseOver</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;mouseOver&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mouseOut - é¼ æ ‡ç¦»å¼€äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onMouseOut</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;mouseOut&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç›¸æœºäº‹ä»¶</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// cameraChanged - ç›¸æœºå˜åŒ–äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onCameraChanged</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="comment">// callback: function(event) - å›è°ƒå‡½æ•°</span></span><br><span class="line">    <span class="comment">// event.position: Object - ç›¸æœºä½ç½®ä¿¡æ¯</span></span><br><span class="line">    <span class="comment">// event.percentage: number - ç§»åŠ¨ç™¾åˆ†æ¯”</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;cameraChanged&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cameraChangedEnd - ç›¸æœºå˜åŒ–ç»“æŸäº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onCameraChangedEnd</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;cameraChangedEnd&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cameraMoveStart - ç›¸æœºå¼€å§‹ç§»åŠ¨äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onCameraMoveStart</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;cameraMoveStart&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cameraMoveEnd - ç›¸æœºç§»åŠ¨ç»“æŸäº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onCameraMoveEnd</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;cameraMoveEnd&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœºæ™¯äº‹ä»¶</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// renderError - æ¸²æŸ“é”™è¯¯äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onRenderError</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;renderError&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// terrainChanged - åœ°å½¢å˜åŒ–äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onTerrainChanged</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;terrainChanged&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// morphStart - åœºæ™¯æ¨¡å¼å˜åŒ–å¼€å§‹äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onMorphStart</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;morphStart&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// morphComplete - åœºæ™¯æ¨¡å¼å˜åŒ–å®Œæˆäº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onMorphComplete</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;morphComplete&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å›¾å±‚äº‹ä»¶</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// layerAdded - å›¾å±‚æ·»åŠ äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onLayerAdded</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="comment">// callback: function(event) - å›è°ƒå‡½æ•°</span></span><br><span class="line">    <span class="comment">// event.layer: Object - æ·»åŠ çš„å›¾å±‚</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;layerAdded&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// layerRemoved - å›¾å±‚ç§»é™¤äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onLayerRemoved</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;layerRemoved&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// layerShowHide - å›¾å±‚æ˜¾ç¤ºéšè—äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onLayerShowHide</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;layerShowHide&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// çŸ¢é‡æ•°æ®äº‹ä»¶</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// graphicAdded - çŸ¢é‡æ•°æ®æ·»åŠ äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onGraphicAdded</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="comment">// callback: function(event) - å›è°ƒå‡½æ•°</span></span><br><span class="line">    <span class="comment">// event.graphic: Object - æ·»åŠ çš„çŸ¢é‡æ•°æ®</span></span><br><span class="line">    <span class="comment">// event.layer: Object - æ‰€å±å›¾å±‚</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;graphicAdded&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// graphicRemoved - çŸ¢é‡æ•°æ®ç§»é™¤äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onGraphicRemoved</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;graphicRemoved&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é”®ç›˜äº‹ä»¶</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// keydown - é”®ç›˜æŒ‰ä¸‹äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onKeyDown</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="comment">// callback: function(event) - å›è°ƒå‡½æ•°</span></span><br><span class="line">    <span class="comment">// event.key: string - æŒ‰é”®å€¼</span></span><br><span class="line">    <span class="comment">// event.keyCode: number - æŒ‰é”®ç </span></span><br><span class="line">    <span class="comment">// event.ctrlKey: boolean - æ˜¯å¦æŒ‰ä¸‹Ctrlé”®</span></span><br><span class="line">    <span class="comment">// event.shiftKey: boolean - æ˜¯å¦æŒ‰ä¸‹Shifté”®</span></span><br><span class="line">    <span class="comment">// event.altKey: boolean - æ˜¯å¦æŒ‰ä¸‹Alté”®</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;keydown&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// keyup - é”®ç›˜æŠ¬èµ·äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onKeyUp</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;keyup&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è‡ªå®šä¹‰äº‹ä»¶</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§¦å‘è‡ªå®šä¹‰äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">fire</span>(<span class="params">eventType, data</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">fire</span>(eventType, data)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">on</span>(<span class="params">eventType, callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(eventType, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç§»é™¤äº‹ä»¶ç›‘å¬</span></span><br><span class="line">  <span class="title function_">off</span>(<span class="params">eventType, callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">off</span>(eventType, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åªç›‘å¬ä¸€æ¬¡</span></span><br><span class="line">  <span class="title function_">once</span>(<span class="params">eventType, callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">once</span>(eventType, callback)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// äº‹ä»¶ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> mapEvents = <span class="keyword">new</span> <span class="title class_">MapEvents</span>(map)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘å¬ç‚¹å‡»äº‹ä»¶</span></span><br><span class="line">mapEvents.<span class="title function_">onClick</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç‚¹å‡»ä½ç½®:&#x27;</span>, event.<span class="property">cartographic</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ‹¾å–å¯¹è±¡:&#x27;</span>, event.<span class="property">pickedObject</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (event.<span class="property">pickedObject</span> &amp;&amp; event.<span class="property">pickedObject</span>.<span class="property">id</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> graphic = event.<span class="property">pickedObject</span>.<span class="property">id</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç‚¹å‡»çš„çŸ¢é‡æ•°æ®:&#x27;</span>, graphic.<span class="property">attr</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘å¬ç›¸æœºå˜åŒ–</span></span><br><span class="line">mapEvents.<span class="title function_">onCameraChanged</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç›¸æœºä½ç½®:&#x27;</span>, event.<span class="property">position</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç§»åŠ¨ç™¾åˆ†æ¯”:&#x27;</span>, event.<span class="property">percentage</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘å¬å›¾å±‚äº‹ä»¶</span></span><br><span class="line">mapEvents.<span class="title function_">onLayerAdded</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ·»åŠ å›¾å±‚:&#x27;</span>, event.<span class="property">layer</span>.<span class="property">name</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘å¬é”®ç›˜äº‹ä»¶</span></span><br><span class="line">mapEvents.<span class="title function_">onKeyDown</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (event.<span class="property">key</span> === <span class="string">&#x27;Escape&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æŒ‰ä¸‹ESCé”®&#x27;</span>)</span><br><span class="line">    <span class="comment">// å–æ¶ˆå½“å‰æ“ä½œ</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (event.<span class="property">ctrlKey</span> &amp;&amp; event.<span class="property">key</span> === <span class="string">&#x27;s&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ä¿å­˜æ“ä½œ&#x27;</span>)</span><br><span class="line">    event.<span class="title function_">preventDefault</span>() <span class="comment">// é˜»æ­¢é»˜è®¤è¡Œä¸º</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰äº‹ä»¶</span></span><br><span class="line">mapEvents.<span class="title function_">on</span>(<span class="string">&#x27;dataLoaded&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ•°æ®åŠ è½½å®Œæˆ:&#x27;</span>, data)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§¦å‘è‡ªå®šä¹‰äº‹ä»¶</span></span><br><span class="line">mapEvents.<span class="title function_">fire</span>(<span class="string">&#x27;dataLoaded&#x27;</span>, &#123; <span class="attr">count</span>: <span class="number">100</span>, <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>() &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// èŠ‚æµå‡½æ•°å¤„ç†é«˜é¢‘äº‹ä»¶</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">throttle</span> = (<span class="params">func, delay</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> timeoutId</span><br><span class="line">  <span class="keyword">let</span> lastExecTime = <span class="number">0</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> currentTime = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (currentTime - lastExecTime &gt; delay) &#123;</span><br><span class="line">      func.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args)</span><br><span class="line">      lastExecTime = currentTime</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">clearTimeout</span>(timeoutId)</span><br><span class="line">      timeoutId = <span class="built_in">setTimeout</span>(</span><br><span class="line">        <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          func.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args)</span><br><span class="line">          lastExecTime = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">        &#125;,</span><br><span class="line">        delay - (currentTime - lastExecTime),</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨èŠ‚æµå¤„ç†é¼ æ ‡ç§»åŠ¨äº‹ä»¶</span></span><br><span class="line">mapEvents.<span class="title function_">onMouseMove</span>(</span><br><span class="line">  <span class="title function_">throttle</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;é¼ æ ‡ä½ç½®:&#x27;</span>, event.<span class="property">position</span>)</span><br><span class="line">  &#125;, <span class="number">100</span>),</span><br><span class="line">) <span class="comment">// 100msèŠ‚æµ</span></span><br></pre></td></tr></table></figure><h3 id="å›¾å±‚å’ŒçŸ¢é‡æ•°æ®äº‹ä»¶"><a href="#å›¾å±‚å’ŒçŸ¢é‡æ•°æ®äº‹ä»¶" class="headerlink" title="å›¾å±‚å’ŒçŸ¢é‡æ•°æ®äº‹ä»¶"></a>å›¾å±‚å’ŒçŸ¢é‡æ•°æ®äº‹ä»¶</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GraphicLayer äº‹ä»¶ç³»ç»Ÿ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GraphicLayerEvents</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">layer</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span> = layer</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å›¾å±‚äº‹ä»¶</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// add - å›¾å±‚æ·»åŠ åˆ°åœ°å›¾äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onAdd</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="title function_">on</span>(<span class="string">&#x27;add&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// remove - å›¾å±‚ä»åœ°å›¾ç§»é™¤äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onRemove</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="title function_">on</span>(<span class="string">&#x27;remove&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// show - å›¾å±‚æ˜¾ç¤ºäº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onShow</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="title function_">on</span>(<span class="string">&#x27;show&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// hide - å›¾å±‚éšè—äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onHide</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="title function_">on</span>(<span class="string">&#x27;hide&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// çŸ¢é‡æ•°æ®äº‹ä»¶</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// addGraphic - çŸ¢é‡æ•°æ®æ·»åŠ äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onAddGraphic</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="title function_">on</span>(<span class="string">&#x27;addGraphic&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// removeGraphic - çŸ¢é‡æ•°æ®ç§»é™¤äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onRemoveGraphic</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="title function_">on</span>(<span class="string">&#x27;removeGraphic&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// äº¤äº’äº‹ä»¶</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// click - å›¾å±‚ç‚¹å‡»äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onClick</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mouseOver - é¼ æ ‡æ‚¬åœäº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onMouseOver</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="title function_">on</span>(<span class="string">&#x27;mouseOver&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mouseOut - é¼ æ ‡ç¦»å¼€äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onMouseOut</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="title function_">on</span>(<span class="string">&#x27;mouseOut&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¼–è¾‘äº‹ä»¶</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// editStart - å¼€å§‹ç¼–è¾‘äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onEditStart</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="title function_">on</span>(<span class="string">&#x27;editStart&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// editStop - åœæ­¢ç¼–è¾‘äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onEditStop</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="title function_">on</span>(<span class="string">&#x27;editStop&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// editMovePoint - ç¼–è¾‘ç‚¹ç§»åŠ¨äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onEditMovePoint</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="title function_">on</span>(<span class="string">&#x27;editMovePoint&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Graphic äº‹ä»¶ç³»ç»Ÿ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GraphicEvents</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">graphic</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span> = graphic</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç”Ÿå‘½å‘¨æœŸäº‹ä»¶</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// add - æ·»åŠ åˆ°å›¾å±‚äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onAdd</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="title function_">on</span>(<span class="string">&#x27;add&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// remove - ä»å›¾å±‚ç§»é™¤äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onRemove</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="title function_">on</span>(<span class="string">&#x27;remove&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// äº¤äº’äº‹ä»¶</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// click - ç‚¹å‡»äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onClick</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// rightClick - å³é”®ç‚¹å‡»äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onRightClick</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="title function_">on</span>(<span class="string">&#x27;rightClick&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mouseOver - é¼ æ ‡æ‚¬åœäº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onMouseOver</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="title function_">on</span>(<span class="string">&#x27;mouseOver&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mouseOut - é¼ æ ‡ç¦»å¼€äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onMouseOut</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="title function_">on</span>(<span class="string">&#x27;mouseOut&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¼–è¾‘äº‹ä»¶</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// editStart - å¼€å§‹ç¼–è¾‘äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onEditStart</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="title function_">on</span>(<span class="string">&#x27;editStart&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// editMovePoint - ç¼–è¾‘ç‚¹ç§»åŠ¨äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onEditMovePoint</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="title function_">on</span>(<span class="string">&#x27;editMovePoint&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// editStop - åœæ­¢ç¼–è¾‘äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">onEditStop</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="title function_">on</span>(<span class="string">&#x27;editStop&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> graphicLayer = <span class="keyword">new</span> mars3d.<span class="property">layer</span>.<span class="title class_">GraphicLayer</span>()</span><br><span class="line"><span class="keyword">const</span> layerEvents = <span class="keyword">new</span> <span class="title class_">GraphicLayerEvents</span>(graphicLayer)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘å¬å›¾å±‚äº‹ä»¶</span></span><br><span class="line">layerEvents.<span class="title function_">onAddGraphic</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ·»åŠ çŸ¢é‡æ•°æ®:&#x27;</span>, event.<span class="property">graphic</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">layerEvents.<span class="title function_">onClick</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç‚¹å‡»å›¾å±‚:&#x27;</span>, event.<span class="property">graphic</span>.<span class="property">attr</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºçŸ¢é‡æ•°æ®å¹¶ç›‘å¬äº‹ä»¶</span></span><br><span class="line"><span class="keyword">const</span> point = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PointEntity</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: [<span class="number">117.207</span>, <span class="number">31.794</span>, <span class="number">100</span>],</span><br><span class="line">  <span class="attr">style</span>: &#123; <span class="attr">color</span>: <span class="string">&#x27;#ff0000&#x27;</span>, <span class="attr">pixelSize</span>: <span class="number">15</span> &#125;,</span><br><span class="line">  <span class="attr">attr</span>: &#123; <span class="attr">name</span>: <span class="string">&#x27;æµ‹è¯•ç‚¹&#x27;</span> &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pointEvents = <span class="keyword">new</span> <span class="title class_">GraphicEvents</span>(point)</span><br><span class="line"></span><br><span class="line">pointEvents.<span class="title function_">onClick</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç‚¹å‡»ç‚¹æ•°æ®:&#x27;</span>, event.<span class="property">target</span>.<span class="property">attr</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">pointEvents.<span class="title function_">onMouseOver</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// é¼ æ ‡æ‚¬åœæ—¶æ”¹å˜é¢œè‰²</span></span><br><span class="line">  event.<span class="property">target</span>.<span class="title function_">setStyle</span>(&#123; <span class="attr">color</span>: <span class="string">&#x27;#00ff00&#x27;</span> &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">pointEvents.<span class="title function_">onMouseOut</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// é¼ æ ‡ç¦»å¼€æ—¶æ¢å¤é¢œè‰²</span></span><br><span class="line">  event.<span class="property">target</span>.<span class="title function_">setStyle</span>(&#123; <span class="attr">color</span>: <span class="string">&#x27;#ff0000&#x27;</span> &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">graphicLayer.<span class="title function_">addGraphic</span>(point)</span><br></pre></td></tr></table></figure><h2 id="æè´¨ç³»ç»Ÿè¯¦è§£"><a href="#æè´¨ç³»ç»Ÿè¯¦è§£" class="headerlink" title="æè´¨ç³»ç»Ÿè¯¦è§£"></a>æè´¨ç³»ç»Ÿè¯¦è§£</h2><h3 id="åŸºç¡€æè´¨ç±»å‹"><a href="#åŸºç¡€æè´¨ç±»å‹" class="headerlink" title="åŸºç¡€æè´¨ç±»å‹"></a>åŸºç¡€æè´¨ç±»å‹</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æè´¨ç³»ç»Ÿ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MaterialSystem</span> &#123;</span><br><span class="line">  <span class="comment">// Color é¢œè‰²æè´¨</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createColorMaterial</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;Color&#x27;</span>,</span><br><span class="line">      <span class="comment">// color: string | Object</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: é¢œè‰²å€¼</span></span><br><span class="line">      <span class="comment">// æ ¼å¼: &#x27;#ff0000&#x27; | &#x27;red&#x27; | &#123;r: 1, g: 0, b: 0, a: 1&#125;</span></span><br><span class="line">      <span class="attr">color</span>: options.<span class="property">color</span> || <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// opacity: number</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: é€æ˜åº¦</span></span><br><span class="line">      <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">      <span class="comment">// èŒƒå›´: 0.0 - 1.0</span></span><br><span class="line">      <span class="attr">opacity</span>: options.<span class="property">opacity</span> !== <span class="literal">undefined</span> ? options.<span class="property">opacity</span> : <span class="number">1.0</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Image å›¾ç‰‡æè´¨</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createImageMaterial</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;Image&#x27;</span>,</span><br><span class="line">      <span class="comment">// image: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: å›¾ç‰‡åœ°å€</span></span><br><span class="line">      <span class="attr">image</span>: options.<span class="property">image</span> || <span class="string">&#x27;&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// repeat: Object</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: é‡å¤æ¨¡å¼</span></span><br><span class="line">      <span class="comment">// æ ¼å¼: &#123;x: number, y: number&#125;</span></span><br><span class="line">      <span class="attr">repeat</span>: options.<span class="property">repeat</span> || &#123; <span class="attr">x</span>: <span class="number">1</span>, <span class="attr">y</span>: <span class="number">1</span> &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// color: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: æ··åˆé¢œè‰²</span></span><br><span class="line">      <span class="attr">color</span>: options.<span class="property">color</span> || <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// opacity: number</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: é€æ˜åº¦</span></span><br><span class="line">      <span class="attr">opacity</span>: options.<span class="property">opacity</span> !== <span class="literal">undefined</span> ? options.<span class="property">opacity</span> : <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// transparent: boolean</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: æ˜¯å¦é€æ˜</span></span><br><span class="line">      <span class="attr">transparent</span>: options.<span class="property">transparent</span> !== <span class="literal">undefined</span> ? options.<span class="property">transparent</span> : <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Grid ç½‘æ ¼æè´¨</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createGridMaterial</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;Grid&#x27;</span>,</span><br><span class="line">      <span class="comment">// color: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: ç½‘æ ¼é¢œè‰²</span></span><br><span class="line">      <span class="attr">color</span>: options.<span class="property">color</span> || <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// cellAlpha: number</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: å•å…ƒæ ¼é€æ˜åº¦</span></span><br><span class="line">      <span class="comment">// é»˜è®¤: 0.1</span></span><br><span class="line">      <span class="attr">cellAlpha</span>: options.<span class="property">cellAlpha</span> !== <span class="literal">undefined</span> ? options.<span class="property">cellAlpha</span> : <span class="number">0.1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// lineCount: Object</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: çº¿æ¡æ•°é‡</span></span><br><span class="line">      <span class="comment">// æ ¼å¼: &#123;x: number, y: number&#125;</span></span><br><span class="line">      <span class="attr">lineCount</span>: options.<span class="property">lineCount</span> || &#123; <span class="attr">x</span>: <span class="number">8</span>, <span class="attr">y</span>: <span class="number">8</span> &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// lineThickness: Object</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: çº¿æ¡ç²—ç»†</span></span><br><span class="line">      <span class="comment">// æ ¼å¼: &#123;x: number, y: number&#125;</span></span><br><span class="line">      <span class="attr">lineThickness</span>: options.<span class="property">lineThickness</span> || &#123; <span class="attr">x</span>: <span class="number">1</span>, <span class="attr">y</span>: <span class="number">1</span> &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// lineOffset: Object</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: çº¿æ¡åç§»</span></span><br><span class="line">      <span class="comment">// æ ¼å¼: &#123;x: number, y: number&#125;</span></span><br><span class="line">      <span class="attr">lineOffset</span>: options.<span class="property">lineOffset</span> || &#123; <span class="attr">x</span>: <span class="number">0</span>, <span class="attr">y</span>: <span class="number">0</span> &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Stripe æ¡çº¹æè´¨</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createStripeMaterial</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;Stripe&#x27;</span>,</span><br><span class="line">      <span class="comment">// evenColor: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: å¶æ•°æ¡çº¹é¢œè‰²</span></span><br><span class="line">      <span class="attr">evenColor</span>: options.<span class="property">evenColor</span> || <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// oddColor: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: å¥‡æ•°æ¡çº¹é¢œè‰²</span></span><br><span class="line">      <span class="attr">oddColor</span>: options.<span class="property">oddColor</span> || <span class="string">&#x27;#000000&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// repeat: number</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: é‡å¤æ¬¡æ•°</span></span><br><span class="line">      <span class="comment">// é»˜è®¤: 5</span></span><br><span class="line">      <span class="attr">repeat</span>: options.<span class="property">repeat</span> !== <span class="literal">undefined</span> ? options.<span class="property">repeat</span> : <span class="number">5</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// offset: number</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: åç§»é‡</span></span><br><span class="line">      <span class="comment">// é»˜è®¤: 0</span></span><br><span class="line">      <span class="attr">offset</span>: options.<span class="property">offset</span> !== <span class="literal">undefined</span> ? options.<span class="property">offset</span> : <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// orientation: number</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: æ–¹å‘</span></span><br><span class="line">      <span class="comment">// é€‰é¡¹: 0(HORIZONTAL), 1(VERTICAL)</span></span><br><span class="line">      <span class="attr">orientation</span>: options.<span class="property">orientation</span> !== <span class="literal">undefined</span> ? options.<span class="property">orientation</span> : <span class="number">0</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Checkerboard æ£‹ç›˜æè´¨</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createCheckerboardMaterial</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;Checkerboard&#x27;</span>,</span><br><span class="line">      <span class="comment">// evenColor: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: å¶æ•°æ ¼é¢œè‰²</span></span><br><span class="line">      <span class="attr">evenColor</span>: options.<span class="property">evenColor</span> || <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// oddColor: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: å¥‡æ•°æ ¼é¢œè‰²</span></span><br><span class="line">      <span class="attr">oddColor</span>: options.<span class="property">oddColor</span> || <span class="string">&#x27;#000000&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// repeat: Object</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: é‡å¤æ¬¡æ•°</span></span><br><span class="line">      <span class="comment">// æ ¼å¼: &#123;x: number, y: number&#125;</span></span><br><span class="line">      <span class="attr">repeat</span>: options.<span class="property">repeat</span> || &#123; <span class="attr">x</span>: <span class="number">5</span>, <span class="attr">y</span>: <span class="number">5</span> &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Water æ°´ä½“æè´¨</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createWaterMaterial</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;Water&#x27;</span>,</span><br><span class="line">      <span class="comment">// baseWaterColor: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: åŸºç¡€æ°´ä½“é¢œè‰²</span></span><br><span class="line">      <span class="attr">baseWaterColor</span>: options.<span class="property">baseWaterColor</span> || <span class="string">&#x27;#006ab4&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// blendColor: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: æ··åˆé¢œè‰²</span></span><br><span class="line">      <span class="attr">blendColor</span>: options.<span class="property">blendColor</span> || <span class="string">&#x27;#006ab4&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// specularMap: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: é«˜å…‰è´´å›¾</span></span><br><span class="line">      <span class="attr">specularMap</span>: options.<span class="property">specularMap</span> || <span class="string">&#x27;&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// normalMap: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: æ³•çº¿è´´å›¾</span></span><br><span class="line">      <span class="attr">normalMap</span>: options.<span class="property">normalMap</span> || <span class="string">&#x27;&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// frequency: number</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: æ³¢æµªé¢‘ç‡</span></span><br><span class="line">      <span class="comment">// é»˜è®¤: 100</span></span><br><span class="line">      <span class="attr">frequency</span>: options.<span class="property">frequency</span> !== <span class="literal">undefined</span> ? options.<span class="property">frequency</span> : <span class="number">100</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// animationSpeed: number</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: åŠ¨ç”»é€Ÿåº¦</span></span><br><span class="line">      <span class="comment">// é»˜è®¤: 0.01</span></span><br><span class="line">      <span class="attr">animationSpeed</span>: options.<span class="property">animationSpeed</span> !== <span class="literal">undefined</span> ? options.<span class="property">animationSpeed</span> : <span class="number">0.01</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// amplitude: number</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: æ³¢æµªå¹…åº¦</span></span><br><span class="line">      <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">      <span class="attr">amplitude</span>: options.<span class="property">amplitude</span> !== <span class="literal">undefined</span> ? options.<span class="property">amplitude</span> : <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// specularIntensity: number</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: é«˜å…‰å¼ºåº¦</span></span><br><span class="line">      <span class="comment">// é»˜è®¤: 0.5</span></span><br><span class="line">      <span class="attr">specularIntensity</span>: options.<span class="property">specularIntensity</span> !== <span class="literal">undefined</span> ? options.<span class="property">specularIntensity</span> : <span class="number">0.5</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿æ¡æè´¨ç³»ç»Ÿ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PolylineMaterialSystem</span> &#123;</span><br><span class="line">  <span class="comment">// Color é¢œè‰²çº¿æ¡æè´¨</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createColorMaterial</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;Color&#x27;</span>,</span><br><span class="line">      <span class="attr">color</span>: options.<span class="property">color</span> || <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line">      <span class="attr">opacity</span>: options.<span class="property">opacity</span> !== <span class="literal">undefined</span> ? options.<span class="property">opacity</span> : <span class="number">1.0</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// PolylineGlow å‘å…‰çº¿æ¡æè´¨</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createGlowMaterial</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;PolylineGlow&#x27;</span>,</span><br><span class="line">      <span class="comment">// color: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: å‘å…‰é¢œè‰²</span></span><br><span class="line">      <span class="attr">color</span>: options.<span class="property">color</span> || <span class="string">&#x27;#00ff00&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// glowPower: number</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: å‘å…‰å¼ºåº¦</span></span><br><span class="line">      <span class="comment">// é»˜è®¤: 0.25</span></span><br><span class="line">      <span class="comment">// èŒƒå›´: 0.0 - 1.0</span></span><br><span class="line">      <span class="attr">glowPower</span>: options.<span class="property">glowPower</span> !== <span class="literal">undefined</span> ? options.<span class="property">glowPower</span> : <span class="number">0.25</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// taperPower: number</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: é”¥åŒ–å¼ºåº¦</span></span><br><span class="line">      <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">      <span class="comment">// èŒƒå›´: 0.0 - 1.0</span></span><br><span class="line">      <span class="attr">taperPower</span>: options.<span class="property">taperPower</span> !== <span class="literal">undefined</span> ? options.<span class="property">taperPower</span> : <span class="number">1.0</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// PolylineArrow ç®­å¤´çº¿æ¡æè´¨</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createArrowMaterial</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;PolylineArrow&#x27;</span>,</span><br><span class="line">      <span class="comment">// color: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: ç®­å¤´é¢œè‰²</span></span><br><span class="line">      <span class="attr">color</span>: options.<span class="property">color</span> || <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// PolylineDash è™šçº¿æè´¨</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createDashMaterial</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;PolylineDash&#x27;</span>,</span><br><span class="line">      <span class="comment">// color: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: çº¿æ¡é¢œè‰²</span></span><br><span class="line">      <span class="attr">color</span>: options.<span class="property">color</span> || <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// gapColor: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: é—´éš™é¢œè‰²</span></span><br><span class="line">      <span class="attr">gapColor</span>: options.<span class="property">gapColor</span> || <span class="string">&#x27;transparent&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// dashLength: number</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: å®çº¿é•¿åº¦</span></span><br><span class="line">      <span class="comment">// é»˜è®¤: 16</span></span><br><span class="line">      <span class="attr">dashLength</span>: options.<span class="property">dashLength</span> !== <span class="literal">undefined</span> ? options.<span class="property">dashLength</span> : <span class="number">16</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// dashPattern: number</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: è™šçº¿æ¨¡å¼</span></span><br><span class="line">      <span class="comment">// é»˜è®¤: 255</span></span><br><span class="line">      <span class="attr">dashPattern</span>: options.<span class="property">dashPattern</span> !== <span class="literal">undefined</span> ? options.<span class="property">dashPattern</span> : <span class="number">255</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// PolylineOutline è½®å»“çº¿æ¡æè´¨</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createOutlineMaterial</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;PolylineOutline&#x27;</span>,</span><br><span class="line">      <span class="comment">// color: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: çº¿æ¡é¢œè‰²</span></span><br><span class="line">      <span class="attr">color</span>: options.<span class="property">color</span> || <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// outlineColor: string</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: è½®å»“é¢œè‰²</span></span><br><span class="line">      <span class="attr">outlineColor</span>: options.<span class="property">outlineColor</span> || <span class="string">&#x27;#000000&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// outlineWidth: number</span></span><br><span class="line">      <span class="comment">// ä½œç”¨: è½®å»“å®½åº¦</span></span><br><span class="line">      <span class="comment">// é»˜è®¤: 1</span></span><br><span class="line">      <span class="attr">outlineWidth</span>: options.<span class="property">outlineWidth</span> !== <span class="literal">undefined</span> ? options.<span class="property">outlineWidth</span> : <span class="number">1</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æè´¨ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é¢æè´¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> polygon = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolygonEntity</span>(&#123;</span><br><span class="line">  <span class="attr">positions</span>: [</span><br><span class="line">    [<span class="number">117.18</span>, <span class="number">31.78</span>],</span><br><span class="line">    [<span class="number">117.19</span>, <span class="number">31.78</span>],</span><br><span class="line">    [<span class="number">117.19</span>, <span class="number">31.79</span>],</span><br><span class="line">    [<span class="number">117.18</span>, <span class="number">31.79</span>],</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨å›¾ç‰‡æè´¨</span></span><br><span class="line">    <span class="attr">materialType</span>: <span class="string">&#x27;Image&#x27;</span>,</span><br><span class="line">    <span class="attr">materialOptions</span>: <span class="title class_">MaterialSystem</span>.<span class="title function_">createImageMaterial</span>(&#123;</span><br><span class="line">      <span class="attr">image</span>: <span class="string">&#x27;img/textures/grass.jpg&#x27;</span>,</span><br><span class="line">      <span class="attr">repeat</span>: &#123; <span class="attr">x</span>: <span class="number">4</span>, <span class="attr">y</span>: <span class="number">4</span> &#125;,</span><br><span class="line">      <span class="attr">color</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">      <span class="attr">opacity</span>: <span class="number">0.8</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">outlineColor</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">    <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç½‘æ ¼æè´¨</span></span><br><span class="line"><span class="keyword">const</span> gridPolygon = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolygonEntity</span>(&#123;</span><br><span class="line">  <span class="attr">positions</span>: [</span><br><span class="line">    [<span class="number">117.2</span>, <span class="number">31.78</span>],</span><br><span class="line">    [<span class="number">117.21</span>, <span class="number">31.78</span>],</span><br><span class="line">    [<span class="number">117.21</span>, <span class="number">31.79</span>],</span><br><span class="line">    [<span class="number">117.2</span>, <span class="number">31.79</span>],</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">materialType</span>: <span class="string">&#x27;Grid&#x27;</span>,</span><br><span class="line">    <span class="attr">materialOptions</span>: <span class="title class_">MaterialSystem</span>.<span class="title function_">createGridMaterial</span>(&#123;</span><br><span class="line">      <span class="attr">color</span>: <span class="string">&#x27;#00ffff&#x27;</span>,</span><br><span class="line">      <span class="attr">cellAlpha</span>: <span class="number">0.2</span>,</span><br><span class="line">      <span class="attr">lineCount</span>: &#123; <span class="attr">x</span>: <span class="number">10</span>, <span class="attr">y</span>: <span class="number">10</span> &#125;,</span><br><span class="line">      <span class="attr">lineThickness</span>: &#123; <span class="attr">x</span>: <span class="number">2</span>, <span class="attr">y</span>: <span class="number">2</span> &#125;,</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ°´ä½“æè´¨</span></span><br><span class="line"><span class="keyword">const</span> waterPolygon = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolygonEntity</span>(&#123;</span><br><span class="line">  <span class="attr">positions</span>: [</span><br><span class="line">    [<span class="number">117.22</span>, <span class="number">31.78</span>],</span><br><span class="line">    [<span class="number">117.23</span>, <span class="number">31.78</span>],</span><br><span class="line">    [<span class="number">117.23</span>, <span class="number">31.79</span>],</span><br><span class="line">    [<span class="number">117.22</span>, <span class="number">31.79</span>],</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">materialType</span>: <span class="string">&#x27;Water&#x27;</span>,</span><br><span class="line">    <span class="attr">materialOptions</span>: <span class="title class_">MaterialSystem</span>.<span class="title function_">createWaterMaterial</span>(&#123;</span><br><span class="line">      <span class="attr">baseWaterColor</span>: <span class="string">&#x27;#006ab4&#x27;</span>,</span><br><span class="line">      <span class="attr">frequency</span>: <span class="number">200</span>,</span><br><span class="line">      <span class="attr">animationSpeed</span>: <span class="number">0.02</span>,</span><br><span class="line">      <span class="attr">amplitude</span>: <span class="number">2.0</span>,</span><br><span class="line">      <span class="attr">specularIntensity</span>: <span class="number">0.8</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿æ¡æè´¨ç¤ºä¾‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘å…‰çº¿æ¡</span></span><br><span class="line"><span class="keyword">const</span> glowPolyline = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolylineEntity</span>(&#123;</span><br><span class="line">  <span class="attr">positions</span>: [</span><br><span class="line">    [<span class="number">117.2</span>, <span class="number">31.79</span>, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">117.21</span>, <span class="number">31.8</span>, <span class="number">100</span>],</span><br><span class="line">    [<span class="number">117.22</span>, <span class="number">31.79</span>, <span class="number">200</span>],</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">width</span>: <span class="number">8</span>,</span><br><span class="line">    <span class="attr">materialType</span>: <span class="string">&#x27;PolylineGlow&#x27;</span>,</span><br><span class="line">    <span class="attr">materialOptions</span>: <span class="title class_">PolylineMaterialSystem</span>.<span class="title function_">createGlowMaterial</span>(&#123;</span><br><span class="line">      <span class="attr">color</span>: <span class="string">&#x27;#00ff00&#x27;</span>,</span><br><span class="line">      <span class="attr">glowPower</span>: <span class="number">0.3</span>,</span><br><span class="line">      <span class="attr">taperPower</span>: <span class="number">0.8</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç®­å¤´çº¿æ¡</span></span><br><span class="line"><span class="keyword">const</span> arrowPolyline = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolylineEntity</span>(&#123;</span><br><span class="line">  <span class="attr">positions</span>: [</span><br><span class="line">    [<span class="number">117.18</span>, <span class="number">31.8</span>, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">117.19</span>, <span class="number">31.81</span>, <span class="number">50</span>],</span><br><span class="line">    [<span class="number">117.2</span>, <span class="number">31.8</span>, <span class="number">100</span>],</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">width</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="attr">materialType</span>: <span class="string">&#x27;PolylineArrow&#x27;</span>,</span><br><span class="line">    <span class="attr">materialOptions</span>: <span class="title class_">PolylineMaterialSystem</span>.<span class="title function_">createArrowMaterial</span>(&#123;</span><br><span class="line">      <span class="attr">color</span>: <span class="string">&#x27;#ff0000&#x27;</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è™šçº¿</span></span><br><span class="line"><span class="keyword">const</span> dashPolyline = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolylineEntity</span>(&#123;</span><br><span class="line">  <span class="attr">positions</span>: [</span><br><span class="line">    [<span class="number">117.16</span>, <span class="number">31.79</span>, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">117.17</span>, <span class="number">31.8</span>, <span class="number">50</span>],</span><br><span class="line">    [<span class="number">117.18</span>, <span class="number">31.79</span>, <span class="number">100</span>],</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">width</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">materialType</span>: <span class="string">&#x27;PolylineDash&#x27;</span>,</span><br><span class="line">    <span class="attr">materialOptions</span>: <span class="title class_">PolylineMaterialSystem</span>.<span class="title function_">createDashMaterial</span>(&#123;</span><br><span class="line">      <span class="attr">color</span>: <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line">      <span class="attr">gapColor</span>: <span class="string">&#x27;transparent&#x27;</span>,</span><br><span class="line">      <span class="attr">dashLength</span>: <span class="number">20</span>,</span><br><span class="line">      <span class="attr">dashPattern</span>: <span class="number">255</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŠ¨æ€æè´¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DynamicMaterial</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">time</span> = <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºåŠ¨æ€é¢œè‰²æè´¨</span></span><br><span class="line">  <span class="title function_">createDynamicColorMaterial</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;Color&#x27;</span>,</span><br><span class="line">      <span class="attr">color</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">time</span> += <span class="number">0.1</span></span><br><span class="line">        <span class="keyword">const</span> red = <span class="title class_">Math</span>.<span class="title function_">sin</span>(<span class="variable language_">this</span>.<span class="property">time</span>) * <span class="number">0.5</span> + <span class="number">0.5</span></span><br><span class="line">        <span class="keyword">const</span> green = <span class="title class_">Math</span>.<span class="title function_">cos</span>(<span class="variable language_">this</span>.<span class="property">time</span>) * <span class="number">0.5</span> + <span class="number">0.5</span></span><br><span class="line">        <span class="keyword">const</span> blue = <span class="title class_">Math</span>.<span class="title function_">sin</span>(<span class="variable language_">this</span>.<span class="property">time</span> + <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">3</span>) * <span class="number">0.5</span> + <span class="number">0.5</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">`rgb(<span class="subst">$&#123;<span class="built_in">Math</span>.floor(red * <span class="number">255</span>)&#125;</span>, <span class="subst">$&#123;<span class="built_in">Math</span>.floor(green * <span class="number">255</span>)&#125;</span>, <span class="subst">$&#123;<span class="built_in">Math</span>.floor(blue * <span class="number">255</span>)&#125;</span>)`</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºåŠ¨æ€æ°´ä½“æè´¨</span></span><br><span class="line">  <span class="title function_">createDynamicWaterMaterial</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;Water&#x27;</span>,</span><br><span class="line">      <span class="attr">baseWaterColor</span>: <span class="string">&#x27;#006ab4&#x27;</span>,</span><br><span class="line">      <span class="attr">frequency</span>: <span class="function">() =&gt;</span> <span class="number">100</span> + <span class="title class_">Math</span>.<span class="title function_">sin</span>(<span class="variable language_">this</span>.<span class="property">time</span> * <span class="number">0.5</span>) * <span class="number">50</span>,</span><br><span class="line">      <span class="attr">animationSpeed</span>: <span class="number">0.02</span>,</span><br><span class="line">      <span class="attr">amplitude</span>: <span class="function">() =&gt;</span> <span class="number">1.0</span> + <span class="title class_">Math</span>.<span class="title function_">cos</span>(<span class="variable language_">this</span>.<span class="property">time</span> * <span class="number">0.3</span>) * <span class="number">0.5</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨åŠ¨æ€æè´¨</span></span><br><span class="line"><span class="keyword">const</span> dynamicMaterial = <span class="keyword">new</span> <span class="title class_">DynamicMaterial</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> dynamicPolygon = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolygonEntity</span>(&#123;</span><br><span class="line">  <span class="attr">positions</span>: [</span><br><span class="line">    [<span class="number">117.24</span>, <span class="number">31.78</span>],</span><br><span class="line">    [<span class="number">117.25</span>, <span class="number">31.78</span>],</span><br><span class="line">    [<span class="number">117.25</span>, <span class="number">31.79</span>],</span><br><span class="line">    [<span class="number">117.24</span>, <span class="number">31.79</span>],</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">materialType</span>: <span class="string">&#x27;Color&#x27;</span>,</span><br><span class="line">    <span class="attr">materialOptions</span>: dynamicMaterial.<span class="title function_">createDynamicColorMaterial</span>(),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šæ—¶æ›´æ–°åŠ¨æ€æè´¨</span></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  dynamicPolygon.<span class="title function_">updateStyle</span>()</span><br><span class="line">&#125;, <span class="number">100</span>)</span><br></pre></td></tr></table></figure><h2 id="åŠ¨ç”»ç³»ç»Ÿè¯¦è§£"><a href="#åŠ¨ç”»ç³»ç»Ÿè¯¦è§£" class="headerlink" title="åŠ¨ç”»ç³»ç»Ÿè¯¦è§£"></a>åŠ¨ç”»ç³»ç»Ÿè¯¦è§£</h2><h3 id="æ—¶é—´è½´åŠ¨ç”»"><a href="#æ—¶é—´è½´åŠ¨ç”»" class="headerlink" title="æ—¶é—´è½´åŠ¨ç”»"></a>æ—¶é—´è½´åŠ¨ç”»</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ—¶é—´è½´åŠ¨ç”»ç³»ç»Ÿ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TimelineAnimation</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span> = map</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span> = map.<span class="property">viewer</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clock</span> = map.<span class="property">clock</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®æ—¶é—´èŒƒå›´</span></span><br><span class="line">  <span class="title function_">setTimeRange</span>(<span class="params">start, stop</span>) &#123;</span><br><span class="line">    <span class="comment">// start: Date | string - å¼€å§‹æ—¶é—´</span></span><br><span class="line">    <span class="comment">// stop: Date | string - ç»“æŸæ—¶é—´</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> startTime = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(start))</span><br><span class="line">    <span class="keyword">const</span> stopTime = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(stop))</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">startTime</span> = startTime</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">stopTime</span> = stopTime</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">currentTime</span> = startTime</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®æ—¶é—´è½´å¯è§</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">timeline</span>.<span class="title function_">updateFromClock</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">timeline</span>.<span class="title function_">zoomTo</span>(startTime, stopTime)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®æ—¶é’Ÿå±æ€§</span></span><br><span class="line">  <span class="title function_">setClockSettings</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// clockRange: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ—¶é’Ÿå¾ªç¯æ¨¡å¼</span></span><br><span class="line">    <span class="comment">// é€‰é¡¹: 0(UNBOUNDED), 1(CLAMPED), 2(LOOP_STOP)</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">clockRange</span> !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">clockRange</span> = options.<span class="property">clockRange</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clockStep: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ—¶é’Ÿæ­¥è¿›æ¨¡å¼</span></span><br><span class="line">    <span class="comment">// é€‰é¡¹: 0(TICK_DEPENDENT), 1(SYSTEM_CLOCK_MULTIPLIER), 2(SYSTEM_CLOCK)</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">clockStep</span> !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">clockStep</span> = options.<span class="property">clockStep</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// multiplier: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ—¶é—´å€é€Ÿ</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: 1.0</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">multiplier</span> !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">multiplier</span> = options.<span class="property">multiplier</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// shouldAnimate: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦è‡ªåŠ¨æ’­æ”¾</span></span><br><span class="line">    <span class="comment">// é»˜è®¤: true</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">shouldAnimate</span> !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">shouldAnimate</span> = options.<span class="property">shouldAnimate</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ’­æ”¾æ§åˆ¶</span></span><br><span class="line">  <span class="title function_">play</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">shouldAnimate</span> = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">pause</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">shouldAnimate</span> = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">stop</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">shouldAnimate</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">currentTime</span> = <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">startTime</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®å½“å‰æ—¶é—´</span></span><br><span class="line">  <span class="title function_">setCurrentTime</span>(<span class="params">time</span>) &#123;</span><br><span class="line">    <span class="comment">// time: Date | string</span></span><br><span class="line">    <span class="keyword">const</span> julianDate = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(time))</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">currentTime</span> = julianDate</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–å½“å‰æ—¶é—´</span></span><br><span class="line">  <span class="title function_">getCurrentTime</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">toDate</span>(<span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">currentTime</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®æ’­æ”¾é€Ÿåº¦</span></span><br><span class="line">  <span class="title function_">setSpeed</span>(<span class="params">multiplier</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">multiplier</span> = multiplier</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç›‘å¬æ—¶é—´å˜åŒ–</span></span><br><span class="line">  <span class="title function_">onTimeChanged</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">onTick</span>.<span class="title function_">addEventListener</span>(callback)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å±æ€§åŠ¨ç”»ç³»ç»Ÿ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PropertyAnimation</span> &#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºä½ç½®åŠ¨ç”»</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createPositionAnimation</span>(<span class="params">positions, times</span>) &#123;</span><br><span class="line">    <span class="comment">// positions: Array - ä½ç½®æ•°ç»„ [[lng,lat,alt], ...]</span></span><br><span class="line">    <span class="comment">// times: Array - æ—¶é—´æ•°ç»„ [Date, ...]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> property = <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">SampledPositionProperty</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; positions.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> time = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(times[i])</span><br><span class="line">      <span class="keyword">const</span> position = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(positions[i]).<span class="title function_">toCartesian</span>()</span><br><span class="line">      property.<span class="title function_">addSample</span>(time, position)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®æ’å€¼ç®—æ³•</span></span><br><span class="line">    property.<span class="title function_">setInterpolationOptions</span>(&#123;</span><br><span class="line">      <span class="attr">interpolationDegree</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">interpolationAlgorithm</span>: mars3d.<span class="property">Cesium</span>.<span class="property">HermitePolynomialApproximation</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> property</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºæ–¹å‘åŠ¨ç”»</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createOrientationAnimation</span>(<span class="params">orientations, times</span>) &#123;</span><br><span class="line">    <span class="comment">// orientations: Array - æ–¹å‘æ•°ç»„ [&#123;heading, pitch, roll&#125;, ...]</span></span><br><span class="line">    <span class="comment">// times: Array - æ—¶é—´æ•°ç»„ [Date, ...]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> property = <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">SampledProperty</span>(mars3d.<span class="property">Cesium</span>.<span class="property">Quaternion</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; orientations.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> time = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(times[i])</span><br><span class="line">      <span class="keyword">const</span> hpr = mars3d.<span class="property">Cesium</span>.<span class="property">HeadingPitchRoll</span>.<span class="title function_">fromDegrees</span>(</span><br><span class="line">        orientations[i].<span class="property">heading</span>,</span><br><span class="line">        orientations[i].<span class="property">pitch</span>,</span><br><span class="line">        orientations[i].<span class="property">roll</span>,</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">const</span> quaternion = mars3d.<span class="property">Cesium</span>.<span class="property">Transforms</span>.<span class="title function_">headingPitchRollQuaternion</span>(</span><br><span class="line">        mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(positions[i]).<span class="title function_">toCartesian</span>(),</span><br><span class="line">        hpr,</span><br><span class="line">      )</span><br><span class="line">      property.<span class="title function_">addSample</span>(time, quaternion)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> property</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºç¼©æ”¾åŠ¨ç”»</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createScaleAnimation</span>(<span class="params">scales, times</span>) &#123;</span><br><span class="line">    <span class="comment">// scales: Array - ç¼©æ”¾æ•°ç»„ [number, ...]</span></span><br><span class="line">    <span class="comment">// times: Array - æ—¶é—´æ•°ç»„ [Date, ...]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> property = <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">SampledProperty</span>(<span class="title class_">Number</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; scales.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> time = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(times[i])</span><br><span class="line">      property.<span class="title function_">addSample</span>(time, scales[i])</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> property</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºé¢œè‰²åŠ¨ç”»</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createColorAnimation</span>(<span class="params">colors, times</span>) &#123;</span><br><span class="line">    <span class="comment">// colors: Array - é¢œè‰²æ•°ç»„ [&#x27;#ff0000&#x27;, ...]</span></span><br><span class="line">    <span class="comment">// times: Array - æ—¶é—´æ•°ç»„ [Date, ...]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> property = <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">SampledProperty</span>(mars3d.<span class="property">Cesium</span>.<span class="property">Color</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; colors.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> time = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(times[i])</span><br><span class="line">      <span class="keyword">const</span> color = mars3d.<span class="property">Cesium</span>.<span class="property">Color</span>.<span class="title function_">fromCssColorString</span>(colors[i])</span><br><span class="line">      property.<span class="title function_">addSample</span>(time, color)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> property</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºé€æ˜åº¦åŠ¨ç”»</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createOpacityAnimation</span>(<span class="params">opacities, times</span>) &#123;</span><br><span class="line">    <span class="comment">// opacities: Array - é€æ˜åº¦æ•°ç»„ [number, ...]</span></span><br><span class="line">    <span class="comment">// times: Array - æ—¶é—´æ•°ç»„ [Date, ...]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> property = <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">SampledProperty</span>(<span class="title class_">Number</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; opacities.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> time = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(times[i])</span><br><span class="line">      property.<span class="title function_">addSample</span>(time, opacities[i])</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> property</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·¯å¾„åŠ¨ç”»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PathAnimation</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">graphic, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span> = graphic</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span> = options</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isPlaying</span> = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®è·¯å¾„ç‚¹</span></span><br><span class="line">  <span class="title function_">setPath</span>(<span class="params">path, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// path: Array - è·¯å¾„ç‚¹æ•°ç»„</span></span><br><span class="line">    <span class="comment">// æ ¼å¼: [&#123;position: [lng,lat,alt], time: Date, ...&#125;, ...]</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">path</span> = path</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æå–ä½ç½®å’Œæ—¶é—´æ•°ç»„</span></span><br><span class="line">    <span class="keyword">const</span> positions = path.<span class="title function_">map</span>(<span class="function">(<span class="params">point</span>) =&gt;</span> point.<span class="property">position</span>)</span><br><span class="line">    <span class="keyword">const</span> times = path.<span class="title function_">map</span>(<span class="function">(<span class="params">point</span>) =&gt;</span> point.<span class="property">time</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºä½ç½®åŠ¨ç”»å±æ€§</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">positionProperty</span> = <span class="title class_">PropertyAnimation</span>.<span class="title function_">createPositionAnimation</span>(positions, times)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæœ‰æ–¹å‘ä¿¡æ¯ï¼Œåˆ›å»ºæ–¹å‘åŠ¨ç”»</span></span><br><span class="line">    <span class="keyword">if</span> (path[<span class="number">0</span>].<span class="property">heading</span> !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> orientations = path.<span class="title function_">map</span>(<span class="function">(<span class="params">point</span>) =&gt;</span> (&#123;</span><br><span class="line">        <span class="attr">heading</span>: point.<span class="property">heading</span> || <span class="number">0</span>,</span><br><span class="line">        <span class="attr">pitch</span>: point.<span class="property">pitch</span> || <span class="number">0</span>,</span><br><span class="line">        <span class="attr">roll</span>: point.<span class="property">roll</span> || <span class="number">0</span>,</span><br><span class="line">      &#125;))</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">orientationProperty</span> = <span class="title class_">PropertyAnimation</span>.<span class="title function_">createOrientationAnimation</span>(orientations, times)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®å¯ç”¨æ€§</span></span><br><span class="line">    <span class="keyword">const</span> startTime = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(times[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">const</span> stopTime = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(times[times.<span class="property">length</span> - <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">availability</span> = <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">TimeIntervalCollection</span>([</span><br><span class="line">      <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">TimeInterval</span>(&#123;</span><br><span class="line">        <span class="attr">start</span>: startTime,</span><br><span class="line">        <span class="attr">stop</span>: stopTime,</span><br><span class="line">      &#125;),</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åº”ç”¨åŠ¨ç”»å±æ€§</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">position</span> = <span class="variable language_">this</span>.<span class="property">positionProperty</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">orientationProperty</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">orientation</span> = <span class="variable language_">this</span>.<span class="property">orientationProperty</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¾ç¤ºè·¯å¾„è½¨è¿¹</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">showPath</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">path</span> = &#123;</span><br><span class="line">        <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">width</span>: options.<span class="property">pathWidth</span> || <span class="number">2</span>,</span><br><span class="line">        <span class="attr">material</span>: mars3d.<span class="property">Cesium</span>.<span class="property">Color</span>.<span class="title function_">fromCssColorString</span>(options.<span class="property">pathColor</span> || <span class="string">&#x27;#ffff00&#x27;</span>),</span><br><span class="line">        <span class="attr">resolution</span>: options.<span class="property">pathResolution</span> || <span class="number">60</span>,</span><br><span class="line">        <span class="attr">leadTime</span>: options.<span class="property">leadTime</span> || <span class="number">0</span>,</span><br><span class="line">        <span class="attr">trailTime</span>: options.<span class="property">trailTime</span> || <span class="number">60</span>,</span><br><span class="line">        <span class="attr">distanceDisplayCondition</span>: options.<span class="property">distanceDisplayCondition</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ’­æ”¾åŠ¨ç”»</span></span><br><span class="line">  <span class="title function_">play</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">path</span> || <span class="variable language_">this</span>.<span class="property">path</span>.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;è·¯å¾„ä¸ºç©ºï¼Œæ— æ³•æ’­æ”¾åŠ¨ç”»&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> startTime = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="variable language_">this</span>.<span class="property">path</span>[<span class="number">0</span>].<span class="property">time</span>)</span><br><span class="line">    <span class="keyword">const</span> stopTime = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="variable language_">this</span>.<span class="property">path</span>[<span class="variable language_">this</span>.<span class="property">path</span>.<span class="property">length</span> - <span class="number">1</span>].<span class="property">time</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®æ—¶é—´è½´</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">clock</span>.<span class="property">startTime</span> = startTime</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">clock</span>.<span class="property">stopTime</span> = stopTime</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">clock</span>.<span class="property">currentTime</span> = startTime</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">clock</span>.<span class="property">clockRange</span> = mars3d.<span class="property">Cesium</span>.<span class="property">ClockRange</span>.<span class="property">LOOP_STOP</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">clock</span>.<span class="property">multiplier</span> = options.<span class="property">speed</span> || <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¼€å§‹æ’­æ”¾</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">clock</span>.<span class="property">shouldAnimate</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isPlaying</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·Ÿè¸ªç›¸æœº</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">followCamera</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">trackedEntity</span> = <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">_cesiumEntity</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æš‚åœåŠ¨ç”»</span></span><br><span class="line">  <span class="title function_">pause</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">clock</span>.<span class="property">shouldAnimate</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isPlaying</span> = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœæ­¢åŠ¨ç”»</span></span><br><span class="line">  <span class="title function_">stop</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">clock</span>.<span class="property">shouldAnimate</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">trackedEntity</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isPlaying</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡ç½®åˆ°èµ·å§‹æ—¶é—´</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">path</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">path</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> startTime = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="variable language_">this</span>.<span class="property">path</span>[<span class="number">0</span>].<span class="property">time</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">clock</span>.<span class="property">currentTime</span> = startTime</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®æ’­æ”¾é€Ÿåº¦</span></span><br><span class="line">  <span class="title function_">setSpeed</span>(<span class="params">speed</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">clock</span>.<span class="property">multiplier</span> = speed</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·³è½¬åˆ°æŒ‡å®šæ—¶é—´</span></span><br><span class="line">  <span class="title function_">seekToTime</span>(<span class="params">time</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> julianDate = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(time))</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">clock</span>.<span class="property">currentTime</span> = julianDate</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–å½“å‰æ’­æ”¾è¿›åº¦ (0-1)</span></span><br><span class="line">  <span class="title function_">getProgress</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">path</span> || <span class="variable language_">this</span>.<span class="property">path</span>.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> currentTime = <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">clock</span>.<span class="property">currentTime</span></span><br><span class="line">    <span class="keyword">const</span> startTime = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="variable language_">this</span>.<span class="property">path</span>[<span class="number">0</span>].<span class="property">time</span>)</span><br><span class="line">    <span class="keyword">const</span> stopTime = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="variable language_">this</span>.<span class="property">path</span>[<span class="variable language_">this</span>.<span class="property">path</span>.<span class="property">length</span> - <span class="number">1</span>].<span class="property">time</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> totalDuration = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">secondsDifference</span>(stopTime, startTime)</span><br><span class="line">    <span class="keyword">const</span> currentDuration = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">secondsDifference</span>(currentTime, startTime)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="number">0</span>, <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="number">1</span>, currentDuration / totalDuration))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŠ¨ç”»ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–æ—¶é—´è½´åŠ¨ç”»</span></span><br><span class="line"><span class="keyword">const</span> timelineAnimation = <span class="keyword">new</span> <span class="title class_">TimelineAnimation</span>(map)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®æ—¶é—´èŒƒå›´ï¼ˆ1å°æ—¶ï¼‰</span></span><br><span class="line"><span class="keyword">const</span> startTime = <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line"><span class="keyword">const</span> stopTime = <span class="keyword">new</span> <span class="title class_">Date</span>(startTime.<span class="title function_">getTime</span>() + <span class="number">3600000</span>) <span class="comment">// 1å°æ—¶å</span></span><br><span class="line"></span><br><span class="line">timelineAnimation.<span class="title function_">setTimeRange</span>(startTime, stopTime)</span><br><span class="line">timelineAnimation.<span class="title function_">setClockSettings</span>(&#123;</span><br><span class="line">  <span class="attr">clockRange</span>: <span class="number">2</span>, <span class="comment">// LOOP_STOP</span></span><br><span class="line">  <span class="attr">multiplier</span>: <span class="number">10</span>, <span class="comment">// 10å€é€Ÿ</span></span><br><span class="line">  <span class="attr">shouldAnimate</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºç§»åŠ¨çš„é£æœºæ¨¡å‹</span></span><br><span class="line"><span class="keyword">const</span> aircraft = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">ModelEntity</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: [<span class="number">117.207</span>, <span class="number">31.794</span>, <span class="number">1000</span>],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;model/aircraft.gltf&#x27;</span>,</span><br><span class="line">    <span class="attr">scale</span>: <span class="number">1.0</span>,</span><br><span class="line">    <span class="attr">heading</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">pitch</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">roll</span>: <span class="number">0</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">attr</span>: &#123; <span class="attr">name</span>: <span class="string">&#x27;é£æœº&#x27;</span> &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰é£è¡Œè·¯å¾„</span></span><br><span class="line"><span class="keyword">const</span> flightPath = [</span><br><span class="line">  &#123; <span class="attr">position</span>: [<span class="number">117.2</span>, <span class="number">31.79</span>, <span class="number">1000</span>], <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(startTime.<span class="title function_">getTime</span>()), <span class="attr">heading</span>: <span class="number">0</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">position</span>: [<span class="number">117.21</span>, <span class="number">31.8</span>, <span class="number">1200</span>], <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(startTime.<span class="title function_">getTime</span>() + <span class="number">600000</span>), <span class="attr">heading</span>: <span class="number">45</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">position</span>: [<span class="number">117.22</span>, <span class="number">31.79</span>, <span class="number">1000</span>], <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(startTime.<span class="title function_">getTime</span>() + <span class="number">1200000</span>), <span class="attr">heading</span>: <span class="number">90</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">position</span>: [<span class="number">117.21</span>, <span class="number">31.78</span>, <span class="number">800</span>], <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(startTime.<span class="title function_">getTime</span>() + <span class="number">1800000</span>), <span class="attr">heading</span>: <span class="number">135</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">position</span>: [<span class="number">117.2</span>, <span class="number">31.79</span>, <span class="number">1000</span>], <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(startTime.<span class="title function_">getTime</span>() + <span class="number">2400000</span>), <span class="attr">heading</span>: <span class="number">180</span> &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºè·¯å¾„åŠ¨ç”»</span></span><br><span class="line"><span class="keyword">const</span> pathAnimation = <span class="keyword">new</span> <span class="title class_">PathAnimation</span>(aircraft, &#123;</span><br><span class="line">  <span class="attr">showPath</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">pathColor</span>: <span class="string">&#x27;#00ff00&#x27;</span>,</span><br><span class="line">  <span class="attr">pathWidth</span>: <span class="number">3</span>,</span><br><span class="line">  <span class="attr">trailTime</span>: <span class="number">300</span>, <span class="comment">// è½¨è¿¹ä¿ç•™5åˆ†é’Ÿ</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®è·¯å¾„å¹¶æ’­æ”¾</span></span><br><span class="line">pathAnimation.<span class="title function_">setPath</span>(flightPath).<span class="title function_">play</span>(&#123;</span><br><span class="line">  <span class="attr">speed</span>: <span class="number">5</span>, <span class="comment">// 5å€é€Ÿ</span></span><br><span class="line">  <span class="attr">followCamera</span>: <span class="literal">true</span>, <span class="comment">// ç›¸æœºè·Ÿè¸ª</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ åˆ°å›¾å±‚</span></span><br><span class="line">graphicLayer.<span class="title function_">addGraphic</span>(aircraft)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºå±æ€§åŠ¨ç”»çš„ç‚¹</span></span><br><span class="line"><span class="keyword">const</span> animatedPoint = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PointEntity</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: [<span class="number">117.23</span>, <span class="number">31.8</span>, <span class="number">100</span>],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">pixelSize</span>: <span class="number">15</span>,</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&#x27;#ff0000&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºé¢œè‰²å’Œå¤§å°åŠ¨ç”»</span></span><br><span class="line"><span class="keyword">const</span> colorTimes = [</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Date</span>(startTime.<span class="title function_">getTime</span>()),</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Date</span>(startTime.<span class="title function_">getTime</span>() + <span class="number">1000000</span>),</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Date</span>(startTime.<span class="title function_">getTime</span>() + <span class="number">2000000</span>),</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Date</span>(startTime.<span class="title function_">getTime</span>() + <span class="number">3000000</span>),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> colors = [<span class="string">&#x27;#ff0000&#x27;</span>, <span class="string">&#x27;#00ff00&#x27;</span>, <span class="string">&#x27;#0000ff&#x27;</span>, <span class="string">&#x27;#ff0000&#x27;</span>]</span><br><span class="line"><span class="keyword">const</span> sizes = [<span class="number">10</span>, <span class="number">20</span>, <span class="number">15</span>, <span class="number">10</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// åº”ç”¨åŠ¨ç”»å±æ€§</span></span><br><span class="line">animatedPoint.<span class="property">_cesiumEntity</span>.<span class="property">point</span>.<span class="property">color</span> = <span class="title class_">PropertyAnimation</span>.<span class="title function_">createColorAnimation</span>(colors, colorTimes)</span><br><span class="line">animatedPoint.<span class="property">_cesiumEntity</span>.<span class="property">point</span>.<span class="property">pixelSize</span> = <span class="title class_">PropertyAnimation</span>.<span class="title function_">createScaleAnimation</span>(</span><br><span class="line">  sizes,</span><br><span class="line">  colorTimes,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">graphicLayer.<span class="title function_">addGraphic</span>(animatedPoint)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘å¬æ—¶é—´å˜åŒ–</span></span><br><span class="line">timelineAnimation.<span class="title function_">onTimeChanged</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> currentTime = timelineAnimation.<span class="title function_">getCurrentTime</span>()</span><br><span class="line">  <span class="keyword">const</span> progress = pathAnimation.<span class="title function_">getProgress</span>()</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å½“å‰æ—¶é—´:&#x27;</span>, currentTime, <span class="string">&#x27;è¿›åº¦:&#x27;</span>, (progress * <span class="number">100</span>).<span class="title function_">toFixed</span>(<span class="number">1</span>) + <span class="string">&#x27;%&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŠ¨ç”»æ§åˆ¶æŒ‰é’®äº‹ä»¶</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;playBtn&#x27;</span>).<span class="property">onclick</span> = <span class="function">() =&gt;</span> pathAnimation.<span class="title function_">play</span>()</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;pauseBtn&#x27;</span>).<span class="property">onclick</span> = <span class="function">() =&gt;</span> pathAnimation.<span class="title function_">pause</span>()</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;stopBtn&#x27;</span>).<span class="property">onclick</span> = <span class="function">() =&gt;</span> pathAnimation.<span class="title function_">stop</span>()</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;speedBtn&#x27;</span>).<span class="property">onclick</span> = <span class="function">() =&gt;</span> pathAnimation.<span class="title function_">setSpeed</span>(<span class="number">10</span>)</span><br></pre></td></tr></table></figure><p>ä¸‹æ–‡ç»§ç»­ä¸ºåˆ†æã€æµ‹é‡ã€å¯è§†åŸŸã€é€šè§†ã€å‰–é¢ã€å¡åº¦ç­‰ç« èŠ‚çš„è¯¦ç»†å®ç°ä¸å±æ€§æ³¨é‡Šã€‚</p><h2 id="åˆ†æåŠŸèƒ½è¯¦è§£"><a href="#åˆ†æåŠŸèƒ½è¯¦è§£" class="headerlink" title="åˆ†æåŠŸèƒ½è¯¦è§£"></a>åˆ†æåŠŸèƒ½è¯¦è§£</h2><h3 id="æµ‹é‡å·¥å…·"><a href="#æµ‹é‡å·¥å…·" class="headerlink" title="æµ‹é‡å·¥å…·"></a>æµ‹é‡å·¥å…·</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æµ‹é‡å·¥å…·ç³»ç»Ÿ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MeasureUtil</span> &#123;</span><br><span class="line">  <span class="comment">// è·ç¦»æµ‹é‡</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">measureDistance</span>(<span class="params">positions</span>) &#123;</span><br><span class="line">    <span class="comment">// positions: Array - ä½ç½®æ•°ç»„ [[lng,lat,alt], ...]</span></span><br><span class="line">    <span class="comment">// è¿”å›: number - è·ç¦»ï¼ˆç±³ï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> totalDistance = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; positions.<span class="property">length</span> - <span class="number">1</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> point1 = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(positions[i])</span><br><span class="line">      <span class="keyword">const</span> point2 = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(positions[i + <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">      <span class="comment">// è®¡ç®—ä¸¤ç‚¹é—´è·ç¦»</span></span><br><span class="line">      <span class="keyword">const</span> distance = <span class="variable language_">this</span>.<span class="title function_">getDistance</span>([point1, point2])</span><br><span class="line">      totalDistance += distance</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> totalDistance</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é¢ç§¯æµ‹é‡</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">measureArea</span>(<span class="params">positions</span>) &#123;</span><br><span class="line">    <span class="comment">// positions: Array - è¾¹ç•Œä½ç½®æ•°ç»„</span></span><br><span class="line">    <span class="comment">// è¿”å›: number - é¢ç§¯ï¼ˆå¹³æ–¹ç±³ï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (positions.<span class="property">length</span> &lt; <span class="number">3</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è½¬æ¢ä¸ºCartesian3åæ ‡</span></span><br><span class="line">    <span class="keyword">const</span> cartesians = positions.<span class="title function_">map</span>(<span class="function">(<span class="params">pos</span>) =&gt;</span> mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(pos).<span class="title function_">toCartesian</span>())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨çƒé¢å‡ ä½•è®¡ç®—é¢ç§¯</span></span><br><span class="line">    <span class="keyword">const</span> area = mars3d.<span class="property">Cesium</span>.<span class="property">PolygonPipeline</span>.<span class="title function_">computeArea2D</span>(cartesians)</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">abs</span>(area)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é«˜åº¦æµ‹é‡</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">measureHeight</span>(<span class="params">startPosition, endPosition</span>) &#123;</span><br><span class="line">    <span class="comment">// startPosition: Array - èµ·å§‹ä½ç½® [lng,lat,alt]</span></span><br><span class="line">    <span class="comment">// endPosition: Array - ç»“æŸä½ç½® [lng,lat,alt]</span></span><br><span class="line">    <span class="comment">// è¿”å›: Object - &#123;horizontal: æ°´å¹³è·ç¦», vertical: å‚ç›´è·ç¦», slope: æ–œè·&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> start = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(startPosition)</span><br><span class="line">    <span class="keyword">const</span> end = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(endPosition)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ°´å¹³è·ç¦»</span></span><br><span class="line">    <span class="keyword">const</span> horizontalDistance = <span class="variable language_">this</span>.<span class="title function_">getDistance</span>([</span><br><span class="line">      <span class="keyword">new</span> mars3d.<span class="title class_">LngLatPoint</span>(start.<span class="property">lng</span>, start.<span class="property">lat</span>, <span class="number">0</span>),</span><br><span class="line">      <span class="keyword">new</span> mars3d.<span class="title class_">LngLatPoint</span>(end.<span class="property">lng</span>, end.<span class="property">lat</span>, <span class="number">0</span>),</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‚ç›´è·ç¦»</span></span><br><span class="line">    <span class="keyword">const</span> verticalDistance = <span class="title class_">Math</span>.<span class="title function_">abs</span>(end.<span class="property">alt</span> - start.<span class="property">alt</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–œè·</span></span><br><span class="line">    <span class="keyword">const</span> slopeDistance = <span class="variable language_">this</span>.<span class="title function_">getDistance</span>([start, end])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">horizontal</span>: horizontalDistance,</span><br><span class="line">      <span class="attr">vertical</span>: verticalDistance,</span><br><span class="line">      <span class="attr">slope</span>: slopeDistance,</span><br><span class="line">      <span class="attr">angle</span>: (<span class="title class_">Math</span>.<span class="title function_">atan2</span>(verticalDistance, horizontalDistance) * <span class="number">180</span>) / <span class="title class_">Math</span>.<span class="property">PI</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§’åº¦æµ‹é‡</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">measureAngle</span>(<span class="params">centerPosition, startPosition, endPosition</span>) &#123;</span><br><span class="line">    <span class="comment">// centerPosition: Array - è§’ç‚¹ä½ç½®</span></span><br><span class="line">    <span class="comment">// startPosition: Array - èµ·å§‹è¾¹ä½ç½®</span></span><br><span class="line">    <span class="comment">// endPosition: Array - ç»“æŸè¾¹ä½ç½®</span></span><br><span class="line">    <span class="comment">// è¿”å›: number - è§’åº¦ï¼ˆåº¦ï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> center = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(centerPosition).<span class="title function_">toCartesian</span>()</span><br><span class="line">    <span class="keyword">const</span> start = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(startPosition).<span class="title function_">toCartesian</span>()</span><br><span class="line">    <span class="keyword">const</span> end = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(endPosition).<span class="title function_">toCartesian</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¡ç®—å‘é‡</span></span><br><span class="line">    <span class="keyword">const</span> vector1 = mars3d.<span class="property">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">subtract</span>(start, center, <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">Cartesian3</span>())</span><br><span class="line">    <span class="keyword">const</span> vector2 = mars3d.<span class="property">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">subtract</span>(end, center, <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">Cartesian3</span>())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¡ç®—å¤¹è§’</span></span><br><span class="line">    <span class="keyword">const</span> dot = mars3d.<span class="property">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">dot</span>(vector1, vector2)</span><br><span class="line">    <span class="keyword">const</span> magnitude1 = mars3d.<span class="property">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">magnitude</span>(vector1)</span><br><span class="line">    <span class="keyword">const</span> magnitude2 = mars3d.<span class="property">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">magnitude</span>(vector2)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> cosAngle = dot / (magnitude1 * magnitude2)</span><br><span class="line">    <span class="keyword">const</span> angle = <span class="title class_">Math</span>.<span class="title function_">acos</span>(mars3d.<span class="property">Cesium</span>.<span class="property">Math</span>.<span class="title function_">clamp</span>(cosAngle, -<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">Util</span>.<span class="title function_">toDegrees</span>(angle)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¡åº¦è®¡ç®—</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">calculateSlope</span>(<span class="params">positions</span>) &#123;</span><br><span class="line">    <span class="comment">// positions: Array - åœ°å½¢å‰–é¢ä½ç½®æ•°ç»„</span></span><br><span class="line">    <span class="comment">// è¿”å›: Array - å¡åº¦æ•°ç»„ï¼ˆç™¾åˆ†æ¯”ï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> slopes = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; positions.<span class="property">length</span> - <span class="number">1</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> point1 = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(positions[i])</span><br><span class="line">      <span class="keyword">const</span> point2 = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(positions[i + <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> horizontalDistance = <span class="variable language_">this</span>.<span class="title function_">getDistance</span>([</span><br><span class="line">        <span class="keyword">new</span> mars3d.<span class="title class_">LngLatPoint</span>(point1.<span class="property">lng</span>, point1.<span class="property">lat</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="keyword">new</span> mars3d.<span class="title class_">LngLatPoint</span>(point2.<span class="property">lng</span>, point2.<span class="property">lat</span>, <span class="number">0</span>),</span><br><span class="line">      ])</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> verticalDistance = point2.<span class="property">alt</span> - point1.<span class="property">alt</span></span><br><span class="line">      <span class="keyword">const</span> slope = (verticalDistance / horizontalDistance) * <span class="number">100</span></span><br><span class="line"></span><br><span class="line">      slopes.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">distance</span>: horizontalDistance,</span><br><span class="line">        <span class="attr">elevation</span>: verticalDistance,</span><br><span class="line">        <span class="attr">slope</span>: slope,</span><br><span class="line">        <span class="attr">angle</span>: (<span class="title class_">Math</span>.<span class="title function_">atan</span>(slope / <span class="number">100</span>) * <span class="number">180</span>) / <span class="title class_">Math</span>.<span class="property">PI</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> slopes</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸¤ç‚¹é—´è·ç¦»è®¡ç®—</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">getDistance</span>(<span class="params">positions</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (positions.<span class="property">length</span> &lt; <span class="number">2</span>) <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> totalDistance = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; positions.<span class="property">length</span> - <span class="number">1</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> point1 = positions[i]</span><br><span class="line">      <span class="keyword">const</span> point2 = positions[i + <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> cartesian1 = point1.<span class="property">toCartesian</span></span><br><span class="line">        ? point1.<span class="title function_">toCartesian</span>()</span><br><span class="line">        : mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(point1).<span class="title function_">toCartesian</span>()</span><br><span class="line">      <span class="keyword">const</span> cartesian2 = point2.<span class="property">toCartesian</span></span><br><span class="line">        ? point2.<span class="title function_">toCartesian</span>()</span><br><span class="line">        : mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(point2).<span class="title function_">toCartesian</span>()</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> distance = mars3d.<span class="property">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">distance</span>(cartesian1, cartesian2)</span><br><span class="line">      totalDistance += distance</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> totalDistance</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ¼å¼åŒ–è·ç¦»æ˜¾ç¤º</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">formatDistance</span>(<span class="params">distance</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (distance &lt; <span class="number">1000</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> distance.<span class="title function_">toFixed</span>(<span class="number">2</span>) + <span class="string">&#x27; ç±³&#x27;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (distance &lt; <span class="number">1000000</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> (distance / <span class="number">1000</span>).<span class="title function_">toFixed</span>(<span class="number">2</span>) + <span class="string">&#x27; åƒç±³&#x27;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> (distance / <span class="number">1000000</span>).<span class="title function_">toFixed</span>(<span class="number">2</span>) + <span class="string">&#x27; å…†ç±³&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ¼å¼åŒ–é¢ç§¯æ˜¾ç¤º</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">formatArea</span>(<span class="params">area</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (area &lt; <span class="number">10000</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> area.<span class="title function_">toFixed</span>(<span class="number">2</span>) + <span class="string">&#x27; å¹³æ–¹ç±³&#x27;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (area &lt; <span class="number">1000000</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> (area / <span class="number">10000</span>).<span class="title function_">toFixed</span>(<span class="number">2</span>) + <span class="string">&#x27; å…¬é¡·&#x27;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> (area / <span class="number">1000000</span>).<span class="title function_">toFixed</span>(<span class="number">2</span>) + <span class="string">&#x27; å¹³æ–¹åƒç±³&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯è§†åŸŸåˆ†æ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ViewshedAnalysis</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span> = map</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span> = map.<span class="property">viewer</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¡ç®—å¯è§†åŸŸ</span></span><br><span class="line">  <span class="title function_">calculateViewshed</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="comment">// options: Object</span></span><br><span class="line">    <span class="comment">// viewPosition: Array - è§‚å¯Ÿç‚¹ä½ç½® [lng,lat,alt]</span></span><br><span class="line">    <span class="comment">// targetPositions: Array - ç›®æ ‡ç‚¹ä½ç½®æ•°ç»„</span></span><br><span class="line">    <span class="comment">// maxDistance: number - æœ€å¤§å¯è§†è·ç¦»</span></span><br><span class="line">    <span class="comment">// verticalAngle: number - å‚ç›´è§†è§’èŒƒå›´ï¼ˆåº¦ï¼‰</span></span><br><span class="line">    <span class="comment">// horizontalAngle: number - æ°´å¹³è§†è§’èŒƒå›´ï¼ˆåº¦ï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> viewPoint = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(options.<span class="property">viewPosition</span>)</span><br><span class="line">    <span class="keyword">const</span> maxDistance = options.<span class="property">maxDistance</span> || <span class="number">10000</span></span><br><span class="line">    <span class="keyword">const</span> results = []</span><br><span class="line"></span><br><span class="line">    options.<span class="property">targetPositions</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">targetPos, index</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> targetPoint = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(targetPos)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// è®¡ç®—è·ç¦»</span></span><br><span class="line">      <span class="keyword">const</span> distance = <span class="title class_">MeasureUtil</span>.<span class="title function_">getDistance</span>([viewPoint, targetPoint])</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (distance &gt; maxDistance) &#123;</span><br><span class="line">        results.<span class="title function_">push</span>(&#123;</span><br><span class="line">          <span class="attr">index</span>: index,</span><br><span class="line">          <span class="attr">position</span>: targetPos,</span><br><span class="line">          <span class="attr">visible</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">reason</span>: <span class="string">&#x27;è¶…å‡ºæœ€å¤§å¯è§†è·ç¦»&#x27;</span>,</span><br><span class="line">          <span class="attr">distance</span>: distance,</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å°„çº¿æ£€æµ‹</span></span><br><span class="line">      <span class="keyword">const</span> startCartesian = viewPoint.<span class="title function_">toCartesian</span>()</span><br><span class="line">      <span class="keyword">const</span> endCartesian = targetPoint.<span class="title function_">toCartesian</span>()</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> ray = <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">Ray</span>(</span><br><span class="line">        startCartesian,</span><br><span class="line">        mars3d.<span class="property">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">subtract</span>(</span><br><span class="line">          endCartesian,</span><br><span class="line">          startCartesian,</span><br><span class="line">          <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">Cartesian3</span>(),</span><br><span class="line">        ),</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ£€æµ‹ä¸åœ°å½¢æˆ–æ¨¡å‹çš„äº¤ç‚¹</span></span><br><span class="line">      <span class="keyword">const</span> intersection = <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">scene</span>.<span class="title function_">pickFromRay</span>(ray)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> visible = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">let</span> reason = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (intersection &amp;&amp; intersection.<span class="property">position</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> intersectionDistance = mars3d.<span class="property">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">distance</span>(</span><br><span class="line">          startCartesian,</span><br><span class="line">          intersection.<span class="property">position</span>,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (intersectionDistance &lt; distance * <span class="number">0.95</span>) &#123;</span><br><span class="line">          <span class="comment">// å…è®¸5%çš„è¯¯å·®</span></span><br><span class="line">          visible = <span class="literal">false</span></span><br><span class="line">          reason = <span class="string">&#x27;è¢«åœ°å½¢æˆ–å»ºç­‘é®æŒ¡&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      results.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">index</span>: index,</span><br><span class="line">        <span class="attr">position</span>: targetPos,</span><br><span class="line">        <span class="attr">visible</span>: visible,</span><br><span class="line">        <span class="attr">reason</span>: reason,</span><br><span class="line">        <span class="attr">distance</span>: distance,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºå¯è§†åŸŸé”¥ä½“</span></span><br><span class="line">  <span class="title function_">createViewshedCone</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="comment">// options: Object - å¯è§†åŸŸå‚æ•°</span></span><br><span class="line">    <span class="keyword">const</span> position = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(options.<span class="property">viewPosition</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">CylinderEntity</span>(&#123;</span><br><span class="line">      <span class="attr">position</span>: options.<span class="property">viewPosition</span>,</span><br><span class="line">      <span class="attr">style</span>: &#123;</span><br><span class="line">        <span class="attr">length</span>: options.<span class="property">maxDistance</span> || <span class="number">5000</span>,</span><br><span class="line">        <span class="attr">topRadius</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">bottomRadius</span>:</span><br><span class="line">          <span class="title class_">Math</span>.<span class="title function_">tan</span>(mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(options.<span class="property">horizontalAngle</span> || <span class="number">45</span>)) *</span><br><span class="line">          (options.<span class="property">maxDistance</span> || <span class="number">5000</span>),</span><br><span class="line">        <span class="attr">material</span>: mars3d.<span class="property">Cesium</span>.<span class="property">Color</span>.<span class="title function_">fromCssColorString</span>(options.<span class="property">color</span> || <span class="string">&#x27;#ffff00&#x27;</span>).<span class="title function_">withAlpha</span>(<span class="number">0.3</span>),</span><br><span class="line">        <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">outlineColor</span>: options.<span class="property">color</span> || <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‰–é¢åˆ†æ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProfileAnalysis</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span> = map</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span> = map.<span class="property">viewer</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœ°å½¢å‰–é¢åˆ†æ</span></span><br><span class="line">  <span class="title function_">analyzeTerrainProfile</span>(<span class="params">startPosition, endPosition, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// startPosition: Array - èµ·å§‹ä½ç½®</span></span><br><span class="line">    <span class="comment">// endPosition: Array - ç»“æŸä½ç½®</span></span><br><span class="line">    <span class="comment">// options: Object - åˆ†æå‚æ•°</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> start = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(startPosition)</span><br><span class="line">    <span class="keyword">const</span> end = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(endPosition)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sampleCount = options.<span class="property">sampleCount</span> || <span class="number">100</span></span><br><span class="line">    <span class="keyword">const</span> profilePoints = []</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”Ÿæˆå‰–é¢é‡‡æ ·ç‚¹</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= sampleCount; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> t = i / sampleCount</span><br><span class="line">      <span class="keyword">const</span> lng = start.<span class="property">lng</span> + (end.<span class="property">lng</span> - start.<span class="property">lng</span>) * t</span><br><span class="line">      <span class="keyword">const</span> lat = start.<span class="property">lat</span> + (end.<span class="property">lat</span> - start.<span class="property">lat</span>) * t</span><br><span class="line"></span><br><span class="line">      <span class="comment">// è·å–åœ°å½¢é«˜åº¦</span></span><br><span class="line">      <span class="keyword">const</span> cartographic = mars3d.<span class="property">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromDegrees</span>(lng, lat)</span><br><span class="line">      <span class="keyword">const</span> height = <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">scene</span>.<span class="property">globe</span>.<span class="title function_">getHeight</span>(cartographic) || <span class="number">0</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> distance = <span class="title class_">MeasureUtil</span>.<span class="title function_">getDistance</span>([start, <span class="keyword">new</span> mars3d.<span class="title class_">LngLatPoint</span>(lng, lat, <span class="number">0</span>)])</span><br><span class="line"></span><br><span class="line">      profilePoints.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">position</span>: [lng, lat, height],</span><br><span class="line">        <span class="attr">distance</span>: distance,</span><br><span class="line">        <span class="attr">elevation</span>: height,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">points</span>: profilePoints,</span><br><span class="line">      <span class="attr">totalDistance</span>: <span class="title class_">MeasureUtil</span>.<span class="title function_">getDistance</span>([start, end]),</span><br><span class="line">      <span class="attr">elevationRange</span>: &#123;</span><br><span class="line">        <span class="attr">min</span>: <span class="title class_">Math</span>.<span class="title function_">min</span>(...profilePoints.<span class="title function_">map</span>(<span class="function">(<span class="params">p</span>) =&gt;</span> p.<span class="property">elevation</span>)),</span><br><span class="line">        <span class="attr">max</span>: <span class="title class_">Math</span>.<span class="title function_">max</span>(...profilePoints.<span class="title function_">map</span>(<span class="function">(<span class="params">p</span>) =&gt;</span> p.<span class="property">elevation</span>)),</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">slopes</span>: <span class="title class_">MeasureUtil</span>.<span class="title function_">calculateSlope</span>(profilePoints.<span class="title function_">map</span>(<span class="function">(<span class="params">p</span>) =&gt;</span> p.<span class="property">position</span>)),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºå‰–é¢å›¾</span></span><br><span class="line">  <span class="title function_">createProfileChart</span>(<span class="params">profileData, containerId</span>) &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨å›¾è¡¨åº“ç»˜åˆ¶å‰–é¢å›¾ï¼ˆä»¥echartsä¸ºä¾‹ï¼‰</span></span><br><span class="line">    <span class="keyword">const</span> chartData = profileData.<span class="property">points</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">point</span>) =&gt;</span> [point.<span class="property">distance</span>, point.<span class="property">elevation</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> option = &#123;</span><br><span class="line">      <span class="attr">title</span>: &#123;</span><br><span class="line">        <span class="attr">text</span>: <span class="string">&#x27;åœ°å½¢å‰–é¢å›¾&#x27;</span>,</span><br><span class="line">        <span class="attr">left</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">tooltip</span>: &#123;</span><br><span class="line">        <span class="attr">trigger</span>: <span class="string">&#x27;axis&#x27;</span>,</span><br><span class="line">        <span class="attr">formatter</span>: <span class="keyword">function</span> (<span class="params">params</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> point = params[<span class="number">0</span>]</span><br><span class="line">          <span class="keyword">return</span> <span class="string">`è·ç¦»: <span class="subst">$&#123;(point.data[<span class="number">0</span>] / <span class="number">1000</span>).toFixed(<span class="number">2</span>)&#125;</span>km&lt;br/&gt;é«˜ç¨‹: <span class="subst">$&#123;point.data[<span class="number">1</span>].toFixed(<span class="number">2</span>)&#125;</span>m`</span></span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">xAxis</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;value&#x27;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;è·ç¦»(m)&#x27;</span>,</span><br><span class="line">        <span class="attr">axisLabel</span>: &#123;</span><br><span class="line">          <span class="attr">formatter</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (value / <span class="number">1000</span>).<span class="title function_">toFixed</span>(<span class="number">1</span>) + <span class="string">&#x27;km&#x27;</span></span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">yAxis</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;value&#x27;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;é«˜ç¨‹(m)&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">series</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;line&#x27;</span>,</span><br><span class="line">          <span class="attr">data</span>: chartData,</span><br><span class="line">          <span class="attr">smooth</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">areaStyle</span>: &#123;</span><br><span class="line">            <span class="attr">color</span>: <span class="string">&#x27;rgba(124, 181, 236, 0.3)&#x27;</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">lineStyle</span>: &#123;</span><br><span class="line">            <span class="attr">color</span>: <span class="string">&#x27;#7cb5ec&#x27;</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‡è®¾å·²å¼•å…¥echarts</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> echarts !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> chart = echarts.<span class="title function_">init</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(containerId))</span><br><span class="line">      chart.<span class="title function_">setOption</span>(option)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// è¿”å›å›¾è¡¨å®ä¾‹ä»¥ä¾¿åç»­æ“ä½œ</span></span><br><span class="line">      <span class="keyword">return</span> chart</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ´ªæ°´æ·¹æ²¡åˆ†æ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FloodAnalysis</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span> = map</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span> = map.<span class="property">viewer</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">floodEntity</span> = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºæ´ªæ°´æ·¹æ²¡åˆ†æ</span></span><br><span class="line">  <span class="title function_">createFloodAnalysis</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="comment">// options: Object</span></span><br><span class="line">    <span class="comment">// bounds: Array - åˆ†æèŒƒå›´ [xmin, ymin, xmax, ymax]</span></span><br><span class="line">    <span class="comment">// waterLevel: number - æ°´ä½é«˜åº¦</span></span><br><span class="line">    <span class="comment">// baseHeight: number - åŸºå‡†é«˜åº¦</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> bounds = options.<span class="property">bounds</span></span><br><span class="line">    <span class="keyword">const</span> waterLevel = options.<span class="property">waterLevel</span> || <span class="number">100</span></span><br><span class="line">    <span class="keyword">const</span> baseHeight = options.<span class="property">baseHeight</span> || <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºæ°´ä½“é¢</span></span><br><span class="line">    <span class="keyword">const</span> positions = [</span><br><span class="line">      [bounds[<span class="number">0</span>], bounds[<span class="number">1</span>], waterLevel],</span><br><span class="line">      [bounds[<span class="number">2</span>], bounds[<span class="number">1</span>], waterLevel],</span><br><span class="line">      [bounds[<span class="number">2</span>], bounds[<span class="number">3</span>], waterLevel],</span><br><span class="line">      [bounds[<span class="number">0</span>], bounds[<span class="number">3</span>], waterLevel],</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">floodEntity</span> = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolygonEntity</span>(&#123;</span><br><span class="line">      <span class="attr">positions</span>: positions,</span><br><span class="line">      <span class="attr">style</span>: &#123;</span><br><span class="line">        <span class="attr">material</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;Water&#x27;</span>,</span><br><span class="line">          <span class="attr">baseWaterColor</span>: <span class="string">&#x27;#006ab4&#x27;</span>,</span><br><span class="line">          <span class="attr">frequency</span>: <span class="number">100</span>,</span><br><span class="line">          <span class="attr">animationSpeed</span>: <span class="number">0.01</span>,</span><br><span class="line">          <span class="attr">amplitude</span>: <span class="number">1.0</span>,</span><br><span class="line">          <span class="attr">specularIntensity</span>: <span class="number">0.8</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">opacity</span>: <span class="number">0.7</span>,</span><br><span class="line">        <span class="attr">clampToGround</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">height</span>: waterLevel,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">attr</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;flood&#x27;</span>,</span><br><span class="line">        <span class="attr">waterLevel</span>: waterLevel,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">floodEntity</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŠ¨æ€è°ƒæ•´æ°´ä½</span></span><br><span class="line">  <span class="title function_">setWaterLevel</span>(<span class="params">level</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">floodEntity</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">floodEntity</span>.<span class="property">attr</span>.<span class="property">waterLevel</span> = level</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ›´æ–°å¤šè¾¹å½¢é«˜åº¦</span></span><br><span class="line">      <span class="keyword">const</span> newPositions = <span class="variable language_">this</span>.<span class="property">floodEntity</span>.<span class="property">positions</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">pos</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> [pos[<span class="number">0</span>], pos[<span class="number">1</span>], level]</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">floodEntity</span>.<span class="property">positions</span> = newPositions</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">floodEntity</span>.<span class="property">style</span>.<span class="property">height</span> = level</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">floodEntity</span>.<span class="title function_">updateStyle</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¡ç®—æ·¹æ²¡ä½“ç§¯</span></span><br><span class="line">  <span class="title function_">calculateFloodVolume</span>(<span class="params">bounds, waterLevel, terrainData</span>) &#123;</span><br><span class="line">    <span class="comment">// ç®€åŒ–è®¡ç®—ï¼šå°†åŒºåŸŸåˆ†å‰²ä¸ºç½‘æ ¼ï¼Œè®¡ç®—æ¯ä¸ªç½‘æ ¼çš„æ·¹æ²¡ä½“ç§¯</span></span><br><span class="line">    <span class="keyword">const</span> gridSize = <span class="number">100</span> <span class="comment">// ç½‘æ ¼å¤§å°ï¼ˆç±³ï¼‰</span></span><br><span class="line">    <span class="keyword">const</span> width = bounds[<span class="number">2</span>] - bounds[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">const</span> height = bounds[<span class="number">3</span>] - bounds[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> gridCountX = <span class="title class_">Math</span>.<span class="title function_">ceil</span>((width * <span class="number">111320</span>) / gridSize) <span class="comment">// ç»åº¦è½¬ç±³çš„è¿‘ä¼¼å€¼</span></span><br><span class="line">    <span class="keyword">const</span> gridCountY = <span class="title class_">Math</span>.<span class="title function_">ceil</span>((height * <span class="number">110540</span>) / gridSize) <span class="comment">// çº¬åº¦è½¬ç±³çš„è¿‘ä¼¼å€¼</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> totalVolume = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; gridCountX; i++) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; gridCountY; j++) &#123;</span><br><span class="line">        <span class="keyword">const</span> lng = bounds[<span class="number">0</span>] + (width * i) / gridCountX</span><br><span class="line">        <span class="keyword">const</span> lat = bounds[<span class="number">1</span>] + (height * j) / gridCountY</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–åœ°å½¢é«˜åº¦</span></span><br><span class="line">        <span class="keyword">const</span> cartographic = mars3d.<span class="property">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromDegrees</span>(lng, lat)</span><br><span class="line">        <span class="keyword">const</span> terrainHeight = <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">scene</span>.<span class="property">globe</span>.<span class="title function_">getHeight</span>(cartographic) || <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (waterLevel &gt; terrainHeight) &#123;</span><br><span class="line">          <span class="keyword">const</span> depth = waterLevel - terrainHeight</span><br><span class="line">          <span class="keyword">const</span> cellArea = gridSize * gridSize</span><br><span class="line">          totalVolume += depth * cellArea</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> totalVolume</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ†æå·¥å…·ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹é‡åŠŸèƒ½ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> measureTool = <span class="keyword">new</span> <span class="title class_">MeasureUtil</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·ç¦»æµ‹é‡</span></span><br><span class="line"><span class="keyword">const</span> positions = [</span><br><span class="line">  [<span class="number">117.2</span>, <span class="number">31.79</span>, <span class="number">0</span>],</span><br><span class="line">  [<span class="number">117.21</span>, <span class="number">31.8</span>, <span class="number">100</span>],</span><br><span class="line">  [<span class="number">117.22</span>, <span class="number">31.79</span>, <span class="number">200</span>],</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> distance = <span class="title class_">MeasureUtil</span>.<span class="title function_">measureDistance</span>(positions)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ€»è·ç¦»:&#x27;</span>, <span class="title class_">MeasureUtil</span>.<span class="title function_">formatDistance</span>(distance))</span><br><span class="line"></span><br><span class="line"><span class="comment">// é¢ç§¯æµ‹é‡</span></span><br><span class="line"><span class="keyword">const</span> areaPositions = [</span><br><span class="line">  [<span class="number">117.18</span>, <span class="number">31.78</span>],</span><br><span class="line">  [<span class="number">117.19</span>, <span class="number">31.78</span>],</span><br><span class="line">  [<span class="number">117.19</span>, <span class="number">31.79</span>],</span><br><span class="line">  [<span class="number">117.18</span>, <span class="number">31.79</span>],</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> area = <span class="title class_">MeasureUtil</span>.<span class="title function_">measureArea</span>(areaPositions)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;é¢ç§¯:&#x27;</span>, <span class="title class_">MeasureUtil</span>.<span class="title function_">formatArea</span>(area))</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯è§†åŸŸåˆ†æç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> viewshed = <span class="keyword">new</span> <span class="title class_">ViewshedAnalysis</span>(map)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> viewshedResults = viewshed.<span class="title function_">calculateViewshed</span>(&#123;</span><br><span class="line">  <span class="attr">viewPosition</span>: [<span class="number">117.207</span>, <span class="number">31.794</span>, <span class="number">100</span>],</span><br><span class="line">  <span class="attr">targetPositions</span>: [</span><br><span class="line">    [<span class="number">117.21</span>, <span class="number">31.8</span>, <span class="number">50</span>],</span><br><span class="line">    [<span class="number">117.22</span>, <span class="number">31.79</span>, <span class="number">80</span>],</span><br><span class="line">    [<span class="number">117.2</span>, <span class="number">31.785</span>, <span class="number">60</span>],</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">maxDistance</span>: <span class="number">5000</span>,</span><br><span class="line">  <span class="attr">horizontalAngle</span>: <span class="number">60</span>,</span><br><span class="line">  <span class="attr">verticalAngle</span>: <span class="number">30</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å¯è§†åŸŸåˆ†æç»“æœ:&#x27;</span>, viewshedResults)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‰–é¢åˆ†æç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> profile = <span class="keyword">new</span> <span class="title class_">ProfileAnalysis</span>(map)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> profileData = profile.<span class="title function_">analyzeTerrainProfile</span>([<span class="number">117.2</span>, <span class="number">31.79</span>, <span class="number">0</span>], [<span class="number">117.22</span>, <span class="number">31.8</span>, <span class="number">0</span>], &#123;</span><br><span class="line">  <span class="attr">sampleCount</span>: <span class="number">50</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å‰–é¢åˆ†æç»“æœ:&#x27;</span>, profileData)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ´ªæ°´åˆ†æç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> flood = <span class="keyword">new</span> <span class="title class_">FloodAnalysis</span>(map)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> floodEntity = flood.<span class="title function_">createFloodAnalysis</span>(&#123;</span><br><span class="line">  <span class="attr">bounds</span>: [<span class="number">117.18</span>, <span class="number">31.78</span>, <span class="number">117.22</span>, <span class="number">31.8</span>],</span><br><span class="line">  <span class="attr">waterLevel</span>: <span class="number">50</span>,</span><br><span class="line">  <span class="attr">baseHeight</span>: <span class="number">0</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">graphicLayer.<span class="title function_">addGraphic</span>(floodEntity)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŠ¨æ€è°ƒæ•´æ°´ä½</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  flood.<span class="title function_">setWaterLevel</span>(<span class="number">80</span>)</span><br><span class="line">&#125;, <span class="number">3000</span>)</span><br></pre></td></tr></table></figure><h3 id="é€šè§†åˆ†æï¼ˆLine-of-Sightï¼‰"><a href="#é€šè§†åˆ†æï¼ˆLine-of-Sightï¼‰" class="headerlink" title="é€šè§†åˆ†æï¼ˆLine of Sightï¼‰"></a>é€šè§†åˆ†æï¼ˆLine of Sightï¼‰</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é€šè§†åˆ†æï¼šåˆ¤æ–­è§‚å¯Ÿç‚¹ä¸ç›®æ ‡ç‚¹ä¹‹é—´æ˜¯å¦è¢«åœ°å½¢/æ¨¡å‹é®æŒ¡</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LineOfSightAnalysis</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span> = map</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span> = map.<span class="property">viewer</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * åˆ¤æ–­é€šè§†</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Array</span>&#125; start [lng,lat,alt] è§‚å¯Ÿç‚¹</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Array</span>&#125; end [lng,lat,alt] ç›®æ ‡ç‚¹</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; options &#123; sampleCount?: number &#125;</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> &#123;<span class="type">Object</span>&#125; &#123;<span class="type"> visible: boolean, obstructionPoint?: [lng,lat,alt] </span>&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">checkVisibility</span>(<span class="params">start, end, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> sampleCount = options.<span class="property">sampleCount</span> || <span class="number">64</span></span><br><span class="line">    <span class="keyword">const</span> startCart = mars3d.<span class="property">PointTrans</span>.<span class="title function_">lonlat2cartesian</span>(...start)</span><br><span class="line">    <span class="keyword">const</span> endCart = mars3d.<span class="property">PointTrans</span>.<span class="title function_">lonlat2cartesian</span>(...end)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ²¿çº¿å‡åŒ€é‡‡æ ·</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; sampleCount; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> t = i / sampleCount</span><br><span class="line">      <span class="keyword">const</span> interp = mars3d.<span class="property">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">lerp</span>(</span><br><span class="line">        startCart,</span><br><span class="line">        endCart,</span><br><span class="line">        t,</span><br><span class="line">        <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">Cartesian3</span>(),</span><br><span class="line">      )</span><br><span class="line">      <span class="comment">// åœ°å½¢/æ¨¡å‹æ‹¾å–</span></span><br><span class="line">      <span class="keyword">const</span> pick = <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">scene</span>.<span class="title function_">pickFromRay</span>(</span><br><span class="line">        <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">Ray</span>(</span><br><span class="line">          startCart,</span><br><span class="line">          mars3d.<span class="property">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">subtract</span>(interp, startCart, <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">Cartesian3</span>()),</span><br><span class="line">        ),</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">if</span> (pick &amp;&amp; pick.<span class="property">position</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> cg = mars3d.<span class="property">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromCartesian</span>(pick.<span class="property">position</span>)</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          <span class="attr">visible</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">obstructionPoint</span>: [</span><br><span class="line">            mars3d.<span class="property">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(cg.<span class="property">longitude</span>),</span><br><span class="line">            mars3d.<span class="property">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(cg.<span class="property">latitude</span>),</span><br><span class="line">            cg.<span class="property">height</span>,</span><br><span class="line">          ],</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">visible</span>: <span class="literal">true</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> los = <span class="keyword">new</span> <span class="title class_">LineOfSightAnalysis</span>(map)</span><br><span class="line"><span class="keyword">const</span> result = los.<span class="title function_">checkVisibility</span>([<span class="number">116.4</span>, <span class="number">39.9</span>, <span class="number">80</span>], [<span class="number">116.45</span>, <span class="number">39.92</span>, <span class="number">80</span>])</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;é€šè§†ç»“æœ:&#x27;</span>, result)</span><br></pre></td></tr></table></figure><h3 id="å¯è§†åŸŸåˆ†æï¼ˆViewshedï¼‰å‚æ•°è¡¥å……"><a href="#å¯è§†åŸŸåˆ†æï¼ˆViewshedï¼‰å‚æ•°è¡¥å……" class="headerlink" title="å¯è§†åŸŸåˆ†æï¼ˆViewshedï¼‰å‚æ•°è¡¥å……"></a>å¯è§†åŸŸåˆ†æï¼ˆViewshedï¼‰å‚æ•°è¡¥å……</h3><ul><li>è¾“å…¥å‚æ•°å»ºè®®ï¼š<ul><li>viewPosition: [lng, lat, alt] è§‚å¯Ÿç‚¹</li><li>targetPositions: Array&lt;[lng, lat, alt]&gt; ç›®æ ‡ç‚¹é›†ï¼ˆæˆ–ä»¥æ°´å¹³&#x2F;å‚ç›´è§’æ„é€ æ‰‡å½¢èŒƒå›´ï¼‰</li><li>maxDistance: number æœ€å¤§å¯è§†è·ç¦»ï¼ˆç±³ï¼‰</li><li>verticalAngle: number å‚ç›´è§†è§’èŒƒå›´ï¼ˆåº¦ï¼‰</li><li>horizontalAngle: number æ°´å¹³è§†è§’èŒƒå›´ï¼ˆåº¦ï¼‰</li></ul></li><li>è¾“å‡ºç»“æœï¼š<ul><li>æ¯ä¸ªç›®æ ‡çš„å¯è§†&#x2F;ä¸å¯è§†æ ‡è®°ã€åŸå› ã€è·ç¦»ï¼›å¹¶å¯ç”Ÿæˆä¸€ä¸ªæ‰‡å½¢ä½“æˆ–ç½‘æ ¼æ ‡æ³¨</li></ul></li></ul><p>ç»˜åˆ¶é”¥ä½“æ—¶æ³¨æ„ï¼š</p><ul><li>ä½¿ç”¨ <code>PolylineVolume</code> æˆ–è‡ªå®šä¹‰ Primitive ç”Ÿæˆé”¥ä½“è¾¹ç•Œï¼›</li><li>å¤§é‡ç½‘æ ¼æ—¶å»ºè®®æ‰¹é‡åˆå¹¶ï¼ˆPrimitive é›†åˆï¼‰ï¼Œé¿å… Entity çˆ†ç‚¸ã€‚</li></ul><h3 id="å‰–é¢é‡‡æ ·ä¸å¡åº¦-å¡å‘ï¼ˆç»†èŠ‚ï¼‰"><a href="#å‰–é¢é‡‡æ ·ä¸å¡åº¦-å¡å‘ï¼ˆç»†èŠ‚ï¼‰" class="headerlink" title="å‰–é¢é‡‡æ ·ä¸å¡åº¦&#x2F;å¡å‘ï¼ˆç»†èŠ‚ï¼‰"></a>å‰–é¢é‡‡æ ·ä¸å¡åº¦&#x2F;å¡å‘ï¼ˆç»†èŠ‚ï¼‰</h3><ul><li>é‡‡æ ·ç­–ç•¥ï¼š<ul><li>å°†èµ·ç»ˆç‚¹æ’å€¼ä¸º N æ®µï¼ˆä¾‹å¦‚ 256ï¼‰ï¼›</li><li>ä½¿ç”¨ <code>sampleTerrainMostDetailed</code>ï¼ˆè‹¥ä½¿ç”¨ Cesium åŸç”Ÿåœ°å½¢é‡‡æ ·ï¼‰æˆ– Mars3D å°è£…è¿›è¡Œæ‰¹é‡é‡‡æ ·ï¼›</li><li>ç»“æœä¿å­˜ä¸º <code>&#123; distance, elevation, position &#125;</code> æ•°ç»„ã€‚</li></ul></li><li>å¡åº¦ï¼ˆslopeï¼‰è®¡ç®—ï¼š<ul><li>å¯¹ç›¸é‚»é‡‡æ ·ç‚¹ <code>(i,i+1)</code>ï¼Œè®¡ç®—æ°´å¹³è·ç¦»ä¸é«˜å·®ï¼Œ<code>slope% = (Î”h / Î”d) * 100</code>ï¼›</li><li>å¡è§’ <code>angle = atan(slope/100)</code>ï¼ˆè½¬åº¦ï¼‰ã€‚</li></ul></li><li>å¡å‘ï¼ˆaspectï¼‰è®¡ç®—ï¼š<ul><li>å¯¹æ¯ä¸ªé‡‡æ ·æ®µï¼Œå–æ°´å¹³å‘é‡æ–¹ä½è§’ï¼ˆåŸºäºç»çº¬æŠ•å½±è¿‘ä¼¼æˆ–åœ¨ ECEF ä¸ŠæŠ•å½±åæ±‚æ–¹ä½è§’ï¼‰ã€‚</li></ul></li></ul><p>ç¤ºä¾‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç²—ç•¥å¡å‘ï¼ˆæ–¹ä½è§’ï¼Œåº¦ï¼‰</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">calculateAspect</span>(<span class="params">lngLatA, lngLatB</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">toRad</span> = (<span class="params">d</span>) =&gt; (d * <span class="title class_">Math</span>.<span class="property">PI</span>) / <span class="number">180</span></span><br><span class="line">  <span class="keyword">const</span> dLon = <span class="title function_">toRad</span>(lngLatB[<span class="number">0</span>] - lngLatA[<span class="number">0</span>])</span><br><span class="line">  <span class="keyword">const</span> y = <span class="title class_">Math</span>.<span class="title function_">sin</span>(dLon) * <span class="title class_">Math</span>.<span class="title function_">cos</span>(<span class="title function_">toRad</span>(lngLatB[<span class="number">1</span>]))</span><br><span class="line">  <span class="keyword">const</span> x =</span><br><span class="line">    <span class="title class_">Math</span>.<span class="title function_">cos</span>(<span class="title function_">toRad</span>(lngLatA[<span class="number">1</span>])) * <span class="title class_">Math</span>.<span class="title function_">sin</span>(<span class="title function_">toRad</span>(lngLatB[<span class="number">1</span>])) -</span><br><span class="line">    <span class="title class_">Math</span>.<span class="title function_">sin</span>(<span class="title function_">toRad</span>(lngLatA[<span class="number">1</span>])) * <span class="title class_">Math</span>.<span class="title function_">cos</span>(<span class="title function_">toRad</span>(lngLatB[<span class="number">1</span>])) * <span class="title class_">Math</span>.<span class="title function_">cos</span>(dLon)</span><br><span class="line">  <span class="keyword">let</span> brng = (<span class="title class_">Math</span>.<span class="title function_">atan2</span>(y, x) * <span class="number">180</span>) / <span class="title class_">Math</span>.<span class="property">PI</span></span><br><span class="line">  <span class="keyword">if</span> (brng &lt; <span class="number">0</span>) brng += <span class="number">360</span></span><br><span class="line">  <span class="keyword">return</span> brng <span class="comment">// 0=åŒ—,90=ä¸œ,180=å—,270=è¥¿</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ·¹æ²¡åˆ†æï¼ˆå‚æ•°ä¸å•ä½ä¸€è‡´æ€§ï¼‰"><a href="#æ·¹æ²¡åˆ†æï¼ˆå‚æ•°ä¸å•ä½ä¸€è‡´æ€§ï¼‰" class="headerlink" title="æ·¹æ²¡åˆ†æï¼ˆå‚æ•°ä¸å•ä½ä¸€è‡´æ€§ï¼‰"></a>æ·¹æ²¡åˆ†æï¼ˆå‚æ•°ä¸å•ä½ä¸€è‡´æ€§ï¼‰</h3><ul><li>å»ºè®®å±æ€§ï¼š<ul><li>bounds: å¤šè¾¹å½¢åŒºåŸŸï¼ˆ[lng,lat] é¡¶ç‚¹æ•°ç»„ï¼‰</li><li>baseHeight: åœ°å½¢åŸºå‡†é«˜ç¨‹ï¼ˆç±³ï¼‰æˆ–ä»åœ°å½¢é‡‡æ ·è‡ªåŠ¨ä¼°è®¡</li><li>waterLevel: å½“å‰æ°´ä½ï¼ˆç±³ï¼Œé«˜ç¨‹åŸºå‡†åŒ baseHeightï¼‰</li><li>step: è®¡ç®—æ­¥é•¿ï¼ˆç±³ï¼‰ï¼Œç”¨äºä½“ç§¯ç½‘æ ¼åŒ–ä¼°ç®—</li></ul></li><li>ä½“ç§¯ä¼°ç®—ï¼š<ul><li>å°†åŒºåŸŸåˆ’åˆ†ç½‘æ ¼ï¼Œç½‘æ ¼ä¸­å¿ƒé‡‡æ ·åœ°å½¢é«˜ç¨‹ <code>h(x,y)</code>ï¼›</li><li>è‹¥ <code>waterLevel &gt; h</code>ï¼Œå•å…ƒä½“ç§¯çº¦ <code>Î”x * Î”y * (waterLevel - h)</code>ï¼›</li><li>æ€»ä½“ç§¯ä¸ºå„å•å…ƒä½“ç§¯ä¹‹å’Œã€‚</li></ul></li></ul><p>æ³¨æ„ï¼šç»Ÿä¸€æ‰€æœ‰é«˜åº¦çš„å‚è€ƒåŸºå‡†ï¼ˆåŒä¸€æ¤­çƒã€åŒä¸€åœ°å½¢æ•°æ®æºï¼‰ï¼Œé¿å…ç›¸å¯¹&#x2F;ç»å¯¹é«˜æ··ç”¨ã€‚</p><h3 id="é˜´å½±-æ—¥ç…§åˆ†æï¼ˆç®€è¿°ï¼‰"><a href="#é˜´å½±-æ—¥ç…§åˆ†æï¼ˆç®€è¿°ï¼‰" class="headerlink" title="é˜´å½±&#x2F;æ—¥ç…§åˆ†æï¼ˆç®€è¿°ï¼‰"></a>é˜´å½±&#x2F;æ—¥ç…§åˆ†æï¼ˆç®€è¿°ï¼‰</h3><ul><li>å¯ç”¨é˜´å½±ï¼š<ul><li><code>viewer.shadows = true</code>ï¼›</li><li>é…åˆè®¾å®š <code>light</code>ï¼ˆå¤ªé˜³ï¼‰æ—¶é—´ <code>viewer.clock.currentTime</code> æ§åˆ¶æ—¥ç…§è§’åº¦ã€‚</li></ul></li><li>åŠ¨æ€æ—¶é—´åºåˆ—ï¼š<ul><li>åœ¨æ—¥é—´å¯¹å¤šä¸ªæ—¶é—´é‡‡æ ·ï¼Œç»Ÿè®¡å¯¹è±¡è¢«ç…§&#x2F;è¢«é®æ—¶é—´æ¯”ä¾‹ï¼Œå½¢æˆæ—¥ç…§åˆ†æç»“æœã€‚</li></ul></li></ul><h3 id="å°ç›®å½•ï¼ˆåˆ†æéƒ¨åˆ†ï¼‰"><a href="#å°ç›®å½•ï¼ˆåˆ†æéƒ¨åˆ†ï¼‰" class="headerlink" title="å°ç›®å½•ï¼ˆåˆ†æéƒ¨åˆ†ï¼‰"></a>å°ç›®å½•ï¼ˆåˆ†æéƒ¨åˆ†ï¼‰</h3><ul><li>é€šè§†åˆ†æï¼ˆLine of Sightï¼‰</li><li>å¯è§†åŸŸåˆ†æï¼ˆViewshedï¼‰</li><li>å‰–é¢é‡‡æ ·ä¸å¡åº¦&#x2F;å¡å‘</li><li>æ·¹æ²¡åˆ†æï¼ˆä½“ç§¯ä¼°ç®—ï¼‰</li><li>é˜´å½±&#x2F;æ—¥ç…§åˆ†æ</li></ul><h2 id="æ§ä»¶ç³»ç»Ÿè¯¦è§£"><a href="#æ§ä»¶ç³»ç»Ÿè¯¦è§£" class="headerlink" title="æ§ä»¶ç³»ç»Ÿè¯¦è§£"></a>æ§ä»¶ç³»ç»Ÿè¯¦è§£</h2><h3 id="åŸºç¡€æ§ä»¶"><a href="#åŸºç¡€æ§ä»¶" class="headerlink" title="åŸºç¡€æ§ä»¶"></a>åŸºç¡€æ§ä»¶</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ§ä»¶åŸºç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseControl</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// position: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ§ä»¶ä½ç½®</span></span><br><span class="line">    <span class="comment">// é€‰é¡¹: &#x27;top-left&#x27;, &#x27;top-right&#x27;, &#x27;bottom-left&#x27;, &#x27;bottom-right&#x27;, &#x27;center&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">position</span> = options.<span class="property">position</span> || <span class="string">&#x27;top-right&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// className: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: CSSç±»å</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">className</span> = options.<span class="property">className</span> || <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// style: Object</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å†…è”æ ·å¼</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = options.<span class="property">style</span> || &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// visible: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦å¯è§</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">visible</span> = options.<span class="property">visible</span> !== <span class="literal">undefined</span> ? options.<span class="property">visible</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// enabled: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦å¯ç”¨</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">enabled</span> = options.<span class="property">enabled</span> !== <span class="literal">undefined</span> ? options.<span class="property">enabled</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span> = <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span> = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ·»åŠ åˆ°åœ°å›¾</span></span><br><span class="line">  <span class="title function_">addTo</span>(<span class="params">map</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span> = map</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">onCreate</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">bindEvents</span>()</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä»åœ°å›¾ç§»é™¤</span></span><br><span class="line">  <span class="title function_">remove</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">domElement</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">parentNode</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">parentNode</span>.<span class="title function_">removeChild</span>(<span class="variable language_">this</span>.<span class="property">domElement</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">unbindEvents</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span> = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºDOMå…ƒç´ </span></span><br><span class="line">  <span class="title function_">onCreate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span> = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">className</span> = <span class="string">`mars3d-control <span class="subst">$&#123;<span class="variable language_">this</span>.className&#125;</span>`</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åº”ç”¨æ ·å¼</span></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>, &#123;</span><br><span class="line">      <span class="attr">position</span>: <span class="string">&#x27;absolute&#x27;</span>,</span><br><span class="line">      <span class="attr">zIndex</span>: <span class="number">1000</span>,</span><br><span class="line">      ...<span class="variable language_">this</span>.<span class="property">style</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®ä½ç½®</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setPosition</span>(<span class="variable language_">this</span>.<span class="property">position</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ åˆ°åœ°å›¾å®¹å™¨</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="property">container</span>.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="property">domElement</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®ä½ç½®</span></span><br><span class="line">  <span class="title function_">setPosition</span>(<span class="params">position</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">position</span> = position</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">domElement</span>) &#123;</span><br><span class="line">      <span class="comment">// æ¸…é™¤æ‰€æœ‰ä½ç½®æ ·å¼</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">top</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">right</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">bottom</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">left</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ ¹æ®ä½ç½®è®¾ç½®æ ·å¼</span></span><br><span class="line">      <span class="keyword">switch</span> (position) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;top-left&#x27;</span>:</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">top</span> = <span class="string">&#x27;10px&#x27;</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">left</span> = <span class="string">&#x27;10px&#x27;</span></span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;top-right&#x27;</span>:</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">top</span> = <span class="string">&#x27;10px&#x27;</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">right</span> = <span class="string">&#x27;10px&#x27;</span></span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;bottom-left&#x27;</span>:</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">bottom</span> = <span class="string">&#x27;10px&#x27;</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">left</span> = <span class="string">&#x27;10px&#x27;</span></span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;bottom-right&#x27;</span>:</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">bottom</span> = <span class="string">&#x27;10px&#x27;</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">right</span> = <span class="string">&#x27;10px&#x27;</span></span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;center&#x27;</span>:</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">top</span> = <span class="string">&#x27;50%&#x27;</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">left</span> = <span class="string">&#x27;50%&#x27;</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">transform</span> = <span class="string">&#x27;translate(-50%, -50%)&#x27;</span></span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ˜¾ç¤ºæ§ä»¶</span></span><br><span class="line">  <span class="title function_">show</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">visible</span> = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">domElement</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;block&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// éšè—æ§ä»¶</span></span><br><span class="line">  <span class="title function_">hide</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">visible</span> = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">domElement</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯ç”¨æ§ä»¶</span></span><br><span class="line">  <span class="title function_">enable</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">enabled</span> = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">domElement</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">pointerEvents</span> = <span class="string">&#x27;auto&#x27;</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">opacity</span> = <span class="string">&#x27;1&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¦ç”¨æ§ä»¶</span></span><br><span class="line">  <span class="title function_">disable</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">enabled</span> = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">domElement</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">pointerEvents</span> = <span class="string">&#x27;none&#x27;</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">opacity</span> = <span class="string">&#x27;0.5&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç»‘å®šäº‹ä»¶</span></span><br><span class="line">  <span class="title function_">bindEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// å­ç±»å®ç°</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£ç»‘äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">unbindEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// å­ç±»å®ç°</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å·¥å…·æ æ§ä»¶</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ToolbarControl</span> <span class="keyword">extends</span> <span class="title class_ inherited__">BaseControl</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(options)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// tools: Array</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å·¥å…·é…ç½®æ•°ç»„</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tools</span> = options.<span class="property">tools</span> || []</span><br><span class="line"></span><br><span class="line">    <span class="comment">// orientation: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å·¥å…·æ æ–¹å‘</span></span><br><span class="line">    <span class="comment">// é€‰é¡¹: &#x27;horizontal&#x27;, &#x27;vertical&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">orientation</span> = options.<span class="property">orientation</span> || <span class="string">&#x27;horizontal&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">activeToolId</span> = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onCreate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>.<span class="title function_">onCreate</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">className</span> += <span class="string">&#x27; mars3d-toolbar&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;flex&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">flexDirection</span> = <span class="variable language_">this</span>.<span class="property">orientation</span> === <span class="string">&#x27;horizontal&#x27;</span> ? <span class="string">&#x27;row&#x27;</span> : <span class="string">&#x27;column&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;rgba(42, 42, 42, 0.8)&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">borderRadius</span> = <span class="string">&#x27;4px&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">padding</span> = <span class="string">&#x27;5px&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createTools</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createTools</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tools</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">tool</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> button = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;button&#x27;</span>)</span><br><span class="line">      button.<span class="property">id</span> = tool.<span class="property">id</span></span><br><span class="line">      button.<span class="property">title</span> = tool.<span class="property">title</span> || <span class="string">&#x27;&#x27;</span></span><br><span class="line">      button.<span class="property">innerHTML</span> = tool.<span class="property">icon</span> || tool.<span class="property">text</span> || <span class="string">&#x27;&#x27;</span></span><br><span class="line">      button.<span class="property">className</span> = <span class="string">&#x27;mars3d-toolbar-button&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// æŒ‰é’®æ ·å¼</span></span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">assign</span>(button.<span class="property">style</span>, &#123;</span><br><span class="line">        <span class="attr">width</span>: <span class="string">&#x27;32px&#x27;</span>,</span><br><span class="line">        <span class="attr">height</span>: <span class="string">&#x27;32px&#x27;</span>,</span><br><span class="line">        <span class="attr">margin</span>: <span class="string">&#x27;2px&#x27;</span>,</span><br><span class="line">        <span class="attr">border</span>: <span class="string">&#x27;none&#x27;</span>,</span><br><span class="line">        <span class="attr">borderRadius</span>: <span class="string">&#x27;3px&#x27;</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;transparent&#x27;</span>,</span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">        <span class="attr">cursor</span>: <span class="string">&#x27;pointer&#x27;</span>,</span><br><span class="line">        <span class="attr">display</span>: <span class="string">&#x27;flex&#x27;</span>,</span><br><span class="line">        <span class="attr">alignItems</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">        <span class="attr">justifyContent</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">        <span class="attr">fontSize</span>: <span class="string">&#x27;14px&#x27;</span>,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ‚¬åœæ•ˆæœ</span></span><br><span class="line">      button.<span class="title function_">addEventListener</span>(<span class="string">&#x27;mouseenter&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        button.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;rgba(255, 255, 255, 0.1)&#x27;</span></span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      button.<span class="title function_">addEventListener</span>(<span class="string">&#x27;mouseleave&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">activeToolId</span> !== tool.<span class="property">id</span>) &#123;</span><br><span class="line">          button.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;transparent&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ç‚¹å‡»äº‹ä»¶</span></span><br><span class="line">      button.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">activateTool</span>(tool.<span class="property">id</span>)</span><br><span class="line">        <span class="keyword">if</span> (tool.<span class="property">callback</span>) &#123;</span><br><span class="line">          tool.<span class="title function_">callback</span>(tool, <span class="variable language_">this</span>.<span class="property">map</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="title function_">appendChild</span>(button)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¿€æ´»å·¥å…·</span></span><br><span class="line">  <span class="title function_">activateTool</span>(<span class="params">toolId</span>) &#123;</span><br><span class="line">    <span class="comment">// é‡ç½®æ‰€æœ‰æŒ‰é’®çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">const</span> buttons = <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.mars3d-toolbar-button&#x27;</span>)</span><br><span class="line">    buttons.<span class="title function_">forEach</span>(<span class="function">(<span class="params">btn</span>) =&gt;</span> &#123;</span><br><span class="line">      btn.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;transparent&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®å½“å‰æ¿€æ´»å·¥å…·</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">activeToolId</span> = toolId</span><br><span class="line">    <span class="keyword">const</span> activeButton = <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="title function_">querySelector</span>(<span class="string">`#<span class="subst">$&#123;toolId&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">if</span> (activeButton) &#123;</span><br><span class="line">      activeButton.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;rgba(255, 255, 255, 0.2)&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ·»åŠ å·¥å…·</span></span><br><span class="line">  <span class="title function_">addTool</span>(<span class="params">tool</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tools</span>.<span class="title function_">push</span>(tool)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createTools</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç§»é™¤å·¥å…·</span></span><br><span class="line">  <span class="title function_">removeTool</span>(<span class="params">toolId</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tools</span> = <span class="variable language_">this</span>.<span class="property">tools</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">tool</span>) =&gt;</span> tool.<span class="property">id</span> !== toolId)</span><br><span class="line">    <span class="keyword">const</span> button = <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="title function_">querySelector</span>(<span class="string">`#<span class="subst">$&#123;toolId&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">if</span> (button) &#123;</span><br><span class="line">      button.<span class="title function_">remove</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å›¾å±‚æ§åˆ¶å™¨</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LayerControl</span> <span class="keyword">extends</span> <span class="title class_ inherited__">BaseControl</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(options)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// title: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ§ä»¶æ ‡é¢˜</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">title</span> = options.<span class="property">title</span> || <span class="string">&#x27;å›¾å±‚æ§åˆ¶&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// collapsible: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦å¯æŠ˜å </span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">collapsible</span> = options.<span class="property">collapsible</span> !== <span class="literal">undefined</span> ? options.<span class="property">collapsible</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// collapsed: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: åˆå§‹æ˜¯å¦æŠ˜å </span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">collapsed</span> = options.<span class="property">collapsed</span> !== <span class="literal">undefined</span> ? options.<span class="property">collapsed</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layers</span> = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onCreate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>.<span class="title function_">onCreate</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">className</span> += <span class="string">&#x27; mars3d-layer-control&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;rgba(0, 0, 0, 0.8)&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">borderRadius</span> = <span class="string">&#x27;4px&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">color</span> = <span class="string">&#x27;#ffffff&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">minWidth</span> = <span class="string">&#x27;200px&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">maxHeight</span> = <span class="string">&#x27;300px&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">overflow</span> = <span class="string">&#x27;hidden&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createHeader</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createContent</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">collapsed</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">collapse</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createHeader</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">headerElement</span> = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">headerElement</span>.<span class="property">className</span> = <span class="string">&#x27;layer-control-header&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">headerElement</span>.<span class="property">style</span>.<span class="property">padding</span> = <span class="string">&#x27;8px 12px&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">headerElement</span>.<span class="property">style</span>.<span class="property">borderBottom</span> = <span class="string">&#x27;1px solid rgba(255, 255, 255, 0.2)&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">headerElement</span>.<span class="property">style</span>.<span class="property">cursor</span> = <span class="variable language_">this</span>.<span class="property">collapsible</span> ? <span class="string">&#x27;pointer&#x27;</span> : <span class="string">&#x27;default&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">headerElement</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;flex&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">headerElement</span>.<span class="property">style</span>.<span class="property">justifyContent</span> = <span class="string">&#x27;space-between&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">headerElement</span>.<span class="property">style</span>.<span class="property">alignItems</span> = <span class="string">&#x27;center&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> titleElement = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;span&#x27;</span>)</span><br><span class="line">    titleElement.<span class="property">textContent</span> = <span class="variable language_">this</span>.<span class="property">title</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">headerElement</span>.<span class="title function_">appendChild</span>(titleElement)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">collapsible</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">toggleButton</span> = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;span&#x27;</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">toggleButton</span>.<span class="property">innerHTML</span> = <span class="string">&#x27;â–¼&#x27;</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">toggleButton</span>.<span class="property">style</span>.<span class="property">transition</span> = <span class="string">&#x27;transform 0.3s&#x27;</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">headerElement</span>.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="property">toggleButton</span>)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">headerElement</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">toggle</span>()</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="property">headerElement</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createContent</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">contentElement</span> = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">contentElement</span>.<span class="property">className</span> = <span class="string">&#x27;layer-control-content&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">contentElement</span>.<span class="property">style</span>.<span class="property">padding</span> = <span class="string">&#x27;8px&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">contentElement</span>.<span class="property">style</span>.<span class="property">maxHeight</span> = <span class="string">&#x27;250px&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">contentElement</span>.<span class="property">style</span>.<span class="property">overflowY</span> = <span class="string">&#x27;auto&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="property">contentElement</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ·»åŠ å›¾å±‚åˆ°æ§åˆ¶å™¨</span></span><br><span class="line">  <span class="title function_">addLayer</span>(<span class="params">layer</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layers</span>.<span class="title function_">push</span>(layer)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createLayerItem</span>(layer)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç§»é™¤å›¾å±‚</span></span><br><span class="line">  <span class="title function_">removeLayer</span>(<span class="params">layer</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layers</span> = <span class="variable language_">this</span>.<span class="property">layers</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">l</span>) =&gt;</span> l !== layer)</span><br><span class="line">    <span class="keyword">const</span> item = <span class="variable language_">this</span>.<span class="property">contentElement</span>.<span class="title function_">querySelector</span>(<span class="string">`[data-layer-id=&quot;<span class="subst">$&#123;layer.id&#125;</span>&quot;]`</span>)</span><br><span class="line">    <span class="keyword">if</span> (item) &#123;</span><br><span class="line">      item.<span class="title function_">remove</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºå›¾å±‚é¡¹</span></span><br><span class="line">  <span class="title function_">createLayerItem</span>(<span class="params">layer</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> item = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    item.<span class="property">className</span> = <span class="string">&#x27;layer-item&#x27;</span></span><br><span class="line">    item.<span class="title function_">setAttribute</span>(<span class="string">&#x27;data-layer-id&#x27;</span>, layer.<span class="property">id</span>)</span><br><span class="line">    item.<span class="property">style</span>.<span class="property">padding</span> = <span class="string">&#x27;4px 0&#x27;</span></span><br><span class="line">    item.<span class="property">style</span>.<span class="property">borderBottom</span> = <span class="string">&#x27;1px solid rgba(255, 255, 255, 0.1)&#x27;</span></span><br><span class="line">    item.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;flex&#x27;</span></span><br><span class="line">    item.<span class="property">style</span>.<span class="property">alignItems</span> = <span class="string">&#x27;center&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤é€‰æ¡†</span></span><br><span class="line">    <span class="keyword">const</span> checkbox = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;input&#x27;</span>)</span><br><span class="line">    checkbox.<span class="property">type</span> = <span class="string">&#x27;checkbox&#x27;</span></span><br><span class="line">    checkbox.<span class="property">checked</span> = layer.<span class="property">show</span></span><br><span class="line">    checkbox.<span class="property">style</span>.<span class="property">marginRight</span> = <span class="string">&#x27;8px&#x27;</span></span><br><span class="line">    checkbox.<span class="title function_">addEventListener</span>(<span class="string">&#x27;change&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      layer.<span class="property">show</span> = checkbox.<span class="property">checked</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å›¾å±‚åç§°</span></span><br><span class="line">    <span class="keyword">const</span> label = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;label&#x27;</span>)</span><br><span class="line">    label.<span class="property">textContent</span> = layer.<span class="property">name</span></span><br><span class="line">    label.<span class="property">style</span>.<span class="property">flex</span> = <span class="string">&#x27;1&#x27;</span></span><br><span class="line">    label.<span class="property">style</span>.<span class="property">cursor</span> = <span class="string">&#x27;pointer&#x27;</span></span><br><span class="line">    label.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      checkbox.<span class="property">checked</span> = !checkbox.<span class="property">checked</span></span><br><span class="line">      checkbox.<span class="title function_">dispatchEvent</span>(<span class="keyword">new</span> <span class="title class_">Event</span>(<span class="string">&#x27;change&#x27;</span>))</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€æ˜åº¦æ»‘å—</span></span><br><span class="line">    <span class="keyword">const</span> opacitySlider = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;input&#x27;</span>)</span><br><span class="line">    opacitySlider.<span class="property">type</span> = <span class="string">&#x27;range&#x27;</span></span><br><span class="line">    opacitySlider.<span class="property">min</span> = <span class="string">&#x27;0&#x27;</span></span><br><span class="line">    opacitySlider.<span class="property">max</span> = <span class="string">&#x27;100&#x27;</span></span><br><span class="line">    opacitySlider.<span class="property">value</span> = (layer.<span class="property">alpha</span> || <span class="number">1</span>) * <span class="number">100</span></span><br><span class="line">    opacitySlider.<span class="property">style</span>.<span class="property">width</span> = <span class="string">&#x27;60px&#x27;</span></span><br><span class="line">    opacitySlider.<span class="property">style</span>.<span class="property">marginLeft</span> = <span class="string">&#x27;8px&#x27;</span></span><br><span class="line">    opacitySlider.<span class="title function_">addEventListener</span>(<span class="string">&#x27;input&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (layer.<span class="property">setOpacity</span>) &#123;</span><br><span class="line">        layer.<span class="title function_">setOpacity</span>(opacitySlider.<span class="property">value</span> / <span class="number">100</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    item.<span class="title function_">appendChild</span>(checkbox)</span><br><span class="line">    item.<span class="title function_">appendChild</span>(label)</span><br><span class="line">    item.<span class="title function_">appendChild</span>(opacitySlider)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">contentElement</span>.<span class="title function_">appendChild</span>(item)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æŠ˜å /å±•å¼€</span></span><br><span class="line">  <span class="title function_">toggle</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">collapsed</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">expand</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">collapse</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å±•å¼€</span></span><br><span class="line">  <span class="title function_">expand</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">collapsed</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">contentElement</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;block&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">toggleButton</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">toggleButton</span>.<span class="property">style</span>.<span class="property">transform</span> = <span class="string">&#x27;rotate(0deg)&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æŠ˜å </span></span><br><span class="line">  <span class="title function_">collapse</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">collapsed</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">contentElement</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">toggleButton</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">toggleButton</span>.<span class="property">style</span>.<span class="property">transform</span> = <span class="string">&#x27;rotate(-90deg)&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŒ‡å—é’ˆæ§ä»¶</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CompassControl</span> <span class="keyword">extends</span> <span class="title class_ inherited__">BaseControl</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(options)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// size: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æŒ‡å—é’ˆå¤§å°</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">size</span> = options.<span class="property">size</span> || <span class="number">60</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isRotating</span> = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onCreate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>.<span class="title function_">onCreate</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">className</span> += <span class="string">&#x27; mars3d-compass&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">width</span> = <span class="variable language_">this</span>.<span class="property">size</span> + <span class="string">&#x27;px&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">height</span> = <span class="variable language_">this</span>.<span class="property">size</span> + <span class="string">&#x27;px&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">borderRadius</span> = <span class="string">&#x27;50%&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;rgba(0, 0, 0, 0.8)&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">border</span> = <span class="string">&#x27;2px solid rgba(255, 255, 255, 0.3)&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">cursor</span> = <span class="string">&#x27;pointer&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;flex&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">alignItems</span> = <span class="string">&#x27;center&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">justifyContent</span> = <span class="string">&#x27;center&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">transition</span> = <span class="string">&#x27;transform 0.3s&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºæŒ‡é’ˆ</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">needle</span> = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">needle</span>.<span class="property">style</span>.<span class="property">width</span> = <span class="string">&#x27;2px&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">needle</span>.<span class="property">style</span>.<span class="property">height</span> = <span class="variable language_">this</span>.<span class="property">size</span> * <span class="number">0.7</span> + <span class="string">&#x27;px&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">needle</span>.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;#ff0000&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">needle</span>.<span class="property">style</span>.<span class="property">position</span> = <span class="string">&#x27;relative&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">needle</span>.<span class="property">style</span>.<span class="property">transformOrigin</span> = <span class="string">&#x27;center bottom&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ åŒ—æ ‡è¯†</span></span><br><span class="line">    <span class="keyword">const</span> northMark = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    northMark.<span class="property">textContent</span> = <span class="string">&#x27;N&#x27;</span></span><br><span class="line">    northMark.<span class="property">style</span>.<span class="property">position</span> = <span class="string">&#x27;absolute&#x27;</span></span><br><span class="line">    northMark.<span class="property">style</span>.<span class="property">top</span> = <span class="string">&#x27;5px&#x27;</span></span><br><span class="line">    northMark.<span class="property">style</span>.<span class="property">left</span> = <span class="string">&#x27;50%&#x27;</span></span><br><span class="line">    northMark.<span class="property">style</span>.<span class="property">transform</span> = <span class="string">&#x27;translateX(-50%)&#x27;</span></span><br><span class="line">    northMark.<span class="property">style</span>.<span class="property">color</span> = <span class="string">&#x27;#ffffff&#x27;</span></span><br><span class="line">    northMark.<span class="property">style</span>.<span class="property">fontSize</span> = <span class="string">&#x27;12px&#x27;</span></span><br><span class="line">    northMark.<span class="property">style</span>.<span class="property">fontWeight</span> = <span class="string">&#x27;bold&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="property">needle</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="title function_">appendChild</span>(northMark)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">bindEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ç›‘å¬ç›¸æœºå˜åŒ–</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;cameraChanged&#x27;</span>, <span class="variable language_">this</span>.<span class="property">updateCompass</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç‚¹å‡»é‡ç½®æ–¹å‘</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">resetNorth</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ›´æ–°æŒ‡å—é’ˆæ–¹å‘</span></span><br><span class="line">  <span class="title function_">updateCompass</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isRotating</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> heading = <span class="variable language_">this</span>.<span class="property">map</span>.<span class="property">camera</span>.<span class="property">heading</span></span><br><span class="line">    <span class="keyword">const</span> rotation = -mars3d.<span class="property">Util</span>.<span class="title function_">toDegrees</span>(heading)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">transform</span> = <span class="string">`rotate(<span class="subst">$&#123;rotation&#125;</span>deg)`</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é‡ç½®åˆ°åŒ—æ–¹</span></span><br><span class="line">  <span class="title function_">resetNorth</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isRotating</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> currentPosition = <span class="variable language_">this</span>.<span class="property">map</span>.<span class="property">camera</span>.<span class="property">position</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="property">camera</span>.<span class="title function_">flyTo</span>(&#123;</span><br><span class="line">      <span class="attr">destination</span>: currentPosition,</span><br><span class="line">      <span class="attr">orientation</span>: &#123;</span><br><span class="line">        <span class="attr">heading</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">pitch</span>: <span class="variable language_">this</span>.<span class="property">map</span>.<span class="property">camera</span>.<span class="property">pitch</span>,</span><br><span class="line">        <span class="attr">roll</span>: <span class="variable language_">this</span>.<span class="property">map</span>.<span class="property">camera</span>.<span class="property">roll</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">duration</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isRotating</span> = <span class="literal">false</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ§ä»¶ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºå·¥å…·æ </span></span><br><span class="line"><span class="keyword">const</span> toolbar = <span class="keyword">new</span> <span class="title class_">ToolbarControl</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="string">&#x27;top-left&#x27;</span>,</span><br><span class="line">  <span class="attr">orientation</span>: <span class="string">&#x27;horizontal&#x27;</span>,</span><br><span class="line">  <span class="attr">tools</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">id</span>: <span class="string">&#x27;measure-distance&#x27;</span>,</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&#x27;è·ç¦»æµ‹é‡&#x27;</span>,</span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&#x27;ğŸ“&#x27;</span>,</span><br><span class="line">      <span class="attr">callback</span>: <span class="function">(<span class="params">tool, map</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å¼€å§‹è·ç¦»æµ‹é‡&#x27;</span>)</span><br><span class="line">        <span class="comment">// å¯åŠ¨è·ç¦»æµ‹é‡å·¥å…·</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">id</span>: <span class="string">&#x27;measure-area&#x27;</span>,</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&#x27;é¢ç§¯æµ‹é‡&#x27;</span>,</span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&#x27;ğŸ“&#x27;</span>,</span><br><span class="line">      <span class="attr">callback</span>: <span class="function">(<span class="params">tool, map</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å¼€å§‹é¢ç§¯æµ‹é‡&#x27;</span>)</span><br><span class="line">        <span class="comment">// å¯åŠ¨é¢ç§¯æµ‹é‡å·¥å…·</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">id</span>: <span class="string">&#x27;draw-point&#x27;</span>,</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&#x27;ç”»ç‚¹&#x27;</span>,</span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&#x27;ğŸ“&#x27;</span>,</span><br><span class="line">      <span class="attr">callback</span>: <span class="function">(<span class="params">tool, map</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å¼€å§‹ç”»ç‚¹&#x27;</span>)</span><br><span class="line">        <span class="comment">// å¯åŠ¨ç”»ç‚¹å·¥å…·</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">id</span>: <span class="string">&#x27;draw-line&#x27;</span>,</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&#x27;ç”»çº¿&#x27;</span>,</span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&#x27;ğŸ“&#x27;</span>,</span><br><span class="line">      <span class="attr">callback</span>: <span class="function">(<span class="params">tool, map</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å¼€å§‹ç”»çº¿&#x27;</span>)</span><br><span class="line">        <span class="comment">// å¯åŠ¨ç”»çº¿å·¥å…·</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">toolbar.<span class="title function_">addTo</span>(map)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºå›¾å±‚æ§åˆ¶å™¨</span></span><br><span class="line"><span class="keyword">const</span> layerControl = <span class="keyword">new</span> <span class="title class_">LayerControl</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="string">&#x27;top-right&#x27;</span>,</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&#x27;å›¾å±‚ç®¡ç†&#x27;</span>,</span><br><span class="line">  <span class="attr">collapsible</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">collapsed</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">layerControl.<span class="title function_">addTo</span>(map)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ å›¾å±‚åˆ°æ§åˆ¶å™¨</span></span><br><span class="line">map.<span class="title function_">eachLayer</span>(<span class="function">(<span class="params">layer</span>) =&gt;</span> &#123;</span><br><span class="line">  layerControl.<span class="title function_">addLayer</span>(layer)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºæŒ‡å—é’ˆ</span></span><br><span class="line"><span class="keyword">const</span> compass = <span class="keyword">new</span> <span class="title class_">CompassControl</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="string">&#x27;bottom-right&#x27;</span>,</span><br><span class="line">  <span class="attr">size</span>: <span class="number">50</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">compass.<span class="title function_">addTo</span>(map)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŠ¨æ€æ·»åŠ å·¥å…·</span></span><br><span class="line">toolbar.<span class="title function_">addTool</span>(&#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="string">&#x27;clear-all&#x27;</span>,</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&#x27;æ¸…é™¤æ‰€æœ‰&#x27;</span>,</span><br><span class="line">  <span class="attr">icon</span>: <span class="string">&#x27;ğŸ—‘ï¸&#x27;</span>,</span><br><span class="line">  <span class="attr">callback</span>: <span class="function">(<span class="params">tool, map</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// æ¸…é™¤æ‰€æœ‰ç»˜åˆ¶å†…å®¹</span></span><br><span class="line">    map.<span class="title function_">eachLayer</span>(<span class="function">(<span class="params">layer</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (layer.<span class="property">clear</span>) &#123;</span><br><span class="line">        layer.<span class="title function_">clear</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="ç»˜åˆ¶åŠŸèƒ½è¯¦è§£"><a href="#ç»˜åˆ¶åŠŸèƒ½è¯¦è§£" class="headerlink" title="ç»˜åˆ¶åŠŸèƒ½è¯¦è§£"></a>ç»˜åˆ¶åŠŸèƒ½è¯¦è§£</h2><h3 id="ç»˜åˆ¶å·¥å…·åŸºç±»"><a href="#ç»˜åˆ¶å·¥å…·åŸºç±»" class="headerlink" title="ç»˜åˆ¶å·¥å…·åŸºç±»"></a>ç»˜åˆ¶å·¥å…·åŸºç±»</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç»˜åˆ¶å·¥å…·åŸºç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DrawTool</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span> = map</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span> = map.<span class="property">viewer</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = map.<span class="property">scene</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span> = map.<span class="property">camera</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// type: string</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç»˜åˆ¶ç±»å‹</span></span><br><span class="line">    <span class="comment">// é€‰é¡¹: &#x27;point&#x27;, &#x27;polyline&#x27;, &#x27;polygon&#x27;, &#x27;rectangle&#x27;, &#x27;circle&#x27;, &#x27;ellipse&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">type</span> = options.<span class="property">type</span> || <span class="string">&#x27;point&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// style: Object</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç»˜åˆ¶æ ·å¼</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = options.<span class="property">style</span> || &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clampToGround: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦è´´åœ°</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clampToGround</span> = options.<span class="property">clampToGround</span> !== <span class="literal">undefined</span> ? options.<span class="property">clampToGround</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// hasMidPoint: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: æ˜¯å¦æ˜¾ç¤ºä¸­é—´ç‚¹</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hasMidPoint</span> = options.<span class="property">hasMidPoint</span> !== <span class="literal">undefined</span> ? options.<span class="property">hasMidPoint</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// hasEdit: boolean</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: ç»˜åˆ¶å®Œæˆåæ˜¯å¦å¯ç¼–è¾‘</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hasEdit</span> = options.<span class="property">hasEdit</span> !== <span class="literal">undefined</span> ? options.<span class="property">hasEdit</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// addHeight: number</span></span><br><span class="line">    <span class="comment">// ä½œç”¨: å¢åŠ çš„é«˜åº¦åç§»</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">addHeight</span> = options.<span class="property">addHeight</span> || <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isDrawing</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawingPositions</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawingGraphic</span> = <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tempGraphics</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handler</span> = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¼€å§‹ç»˜åˆ¶</span></span><br><span class="line">  <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isDrawing</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">stop</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isDrawing</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawingPositions</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tempGraphics</span> = []</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createHandler</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">bindEvents</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ”¹å˜é¼ æ ‡æ ·å¼</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">canvas</span>.<span class="property">style</span>.<span class="property">cursor</span> = <span class="string">&#x27;crosshair&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§¦å‘å¼€å§‹ç»˜åˆ¶äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">fire</span>(<span class="string">&#x27;drawStart&#x27;</span>, &#123; <span class="attr">type</span>: <span class="variable language_">this</span>.<span class="property">type</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœæ­¢ç»˜åˆ¶</span></span><br><span class="line">  <span class="title function_">stop</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">isDrawing</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isDrawing</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">unbindEvents</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç†ä¸´æ—¶å›¾å½¢</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">clearTempGraphics</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¢å¤é¼ æ ‡æ ·å¼</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">canvas</span>.<span class="property">style</span>.<span class="property">cursor</span> = <span class="string">&#x27;default&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§¦å‘åœæ­¢ç»˜åˆ¶äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">fire</span>(<span class="string">&#x27;drawStop&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºäº‹ä»¶å¤„ç†å™¨</span></span><br><span class="line">  <span class="title function_">createHandler</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handler</span> = <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">ScreenSpaceEventHandler</span>(<span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">canvas</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç»‘å®šäº‹ä»¶</span></span><br><span class="line">  <span class="title function_">bindEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// é¼ æ ‡å·¦é”®ç‚¹å‡»</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handler</span>.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">click</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> position = <span class="variable language_">this</span>.<span class="title function_">getPickPosition</span>(click.<span class="property">position</span>)</span><br><span class="line">      <span class="keyword">if</span> (position) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">addPosition</span>(position)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, mars3d.<span class="property">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">LEFT_CLICK</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é¼ æ ‡ç§»åŠ¨</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handler</span>.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">movement</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">drawingPositions</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> position = <span class="variable language_">this</span>.<span class="title function_">getPickPosition</span>(movement.<span class="property">endPosition</span>)</span><br><span class="line">        <span class="keyword">if</span> (position) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">updateDrawing</span>(position)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, mars3d.<span class="property">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">MOUSE_MOVE</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é¼ æ ‡å³é”®ç»“æŸç»˜åˆ¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handler</span>.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">click</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">finishDrawing</span>()</span><br><span class="line">    &#125;, mars3d.<span class="property">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">RIGHT_CLICK</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒå‡»ç»“æŸç»˜åˆ¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handler</span>.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">click</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">finishDrawing</span>()</span><br><span class="line">    &#125;, mars3d.<span class="property">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">LEFT_DOUBLE_CLICK</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£ç»‘äº‹ä»¶</span></span><br><span class="line">  <span class="title function_">unbindEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">handler</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">handler</span>.<span class="title function_">destroy</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">handler</span> = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–æ‹¾å–ä½ç½®</span></span><br><span class="line">  <span class="title function_">getPickPosition</span>(<span class="params">screenPosition</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> cartesian</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">clampToGround</span>) &#123;</span><br><span class="line">      <span class="comment">// è´´åœ°æ¨¡å¼ï¼šæ‹¾å–åœ°å½¢</span></span><br><span class="line">      <span class="keyword">const</span> ray = <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">getPickRay</span>(screenPosition)</span><br><span class="line">      cartesian = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">globe</span>.<span class="title function_">pick</span>(ray, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// ç©ºé—´æ¨¡å¼ï¼šæ‹¾å–æ¤­çƒé¢</span></span><br><span class="line">      cartesian = <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">pickEllipsoid</span>(screenPosition, <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">globe</span>.<span class="property">ellipsoid</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cartesian) &#123;</span><br><span class="line">      <span class="comment">// è½¬æ¢ä¸ºç»çº¬åº¦åæ ‡</span></span><br><span class="line">      <span class="keyword">const</span> cartographic = mars3d.<span class="property">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromCartesian</span>(cartesian)</span><br><span class="line">      <span class="keyword">const</span> lng = mars3d.<span class="property">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(cartographic.<span class="property">longitude</span>)</span><br><span class="line">      <span class="keyword">const</span> lat = mars3d.<span class="property">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(cartographic.<span class="property">latitude</span>)</span><br><span class="line">      <span class="keyword">const</span> alt = cartographic.<span class="property">height</span> + <span class="variable language_">this</span>.<span class="property">addHeight</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> [lng, lat, alt]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ·»åŠ ä½ç½®ç‚¹</span></span><br><span class="line">  <span class="title function_">addPosition</span>(<span class="params">position</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawingPositions</span>.<span class="title function_">push</span>(position)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºæˆ–æ›´æ–°ç»˜åˆ¶å›¾å½¢</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createOrUpdateGraphic</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§¦å‘æ·»åŠ ç‚¹äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">fire</span>(<span class="string">&#x27;addPosition&#x27;</span>, &#123; position, <span class="attr">positions</span>: <span class="variable language_">this</span>.<span class="property">drawingPositions</span>.<span class="title function_">slice</span>() &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ›´æ–°ç»˜åˆ¶è¿‡ç¨‹</span></span><br><span class="line">  <span class="title function_">updateDrawing</span>(<span class="params">position</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">drawingPositions</span>.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸´æ—¶ä½ç½®æ•°ç»„</span></span><br><span class="line">    <span class="keyword">const</span> tempPositions = <span class="variable language_">this</span>.<span class="property">drawingPositions</span>.<span class="title function_">slice</span>()</span><br><span class="line">    tempPositions.<span class="title function_">push</span>(position)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ›´æ–°ä¸´æ—¶å›¾å½¢</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">updateTempGraphic</span>(tempPositions)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å®Œæˆç»˜åˆ¶</span></span><br><span class="line">  <span class="title function_">finishDrawing</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">drawingPositions</span>.<span class="property">length</span> &lt; <span class="variable language_">this</span>.<span class="title function_">getMinPositionCount</span>()) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.type&#125;</span>ç»˜åˆ¶è‡³å°‘éœ€è¦<span class="subst">$&#123;<span class="variable language_">this</span>.getMinPositionCount()&#125;</span>ä¸ªç‚¹`</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºæœ€ç»ˆå›¾å½¢</span></span><br><span class="line">    <span class="keyword">const</span> graphic = <span class="variable language_">this</span>.<span class="title function_">createFinalGraphic</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç†ä¸´æ—¶å›¾å½¢</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">clearTempGraphics</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœæ­¢ç»˜åˆ¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">stop</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§¦å‘å®Œæˆç»˜åˆ¶äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">fire</span>(<span class="string">&#x27;drawComplete&#x27;</span>, &#123;</span><br><span class="line">      graphic,</span><br><span class="line">      <span class="attr">positions</span>: <span class="variable language_">this</span>.<span class="property">drawingPositions</span>.<span class="title function_">slice</span>(),</span><br><span class="line">      <span class="attr">type</span>: <span class="variable language_">this</span>.<span class="property">type</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> graphic</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–æœ€å°ä½ç½®ç‚¹æ•°é‡</span></span><br><span class="line">  <span class="title function_">getMinPositionCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable language_">this</span>.<span class="property">type</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;point&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;polyline&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;polygon&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;rectangle&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;circle&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;ellipse&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºæˆ–æ›´æ–°å›¾å½¢ï¼ˆå­ç±»å®ç°ï¼‰</span></span><br><span class="line">  <span class="title function_">createOrUpdateGraphic</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// å­ç±»å®ç°å…·ä½“é€»è¾‘</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ›´æ–°ä¸´æ—¶å›¾å½¢ï¼ˆå­ç±»å®ç°ï¼‰</span></span><br><span class="line">  <span class="title function_">updateTempGraphic</span>(<span class="params">positions</span>) &#123;</span><br><span class="line">    <span class="comment">// å­ç±»å®ç°å…·ä½“é€»è¾‘</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºæœ€ç»ˆå›¾å½¢ï¼ˆå­ç±»å®ç°ï¼‰</span></span><br><span class="line">  <span class="title function_">createFinalGraphic</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// å­ç±»å®ç°å…·ä½“é€»è¾‘</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¸…ç†ä¸´æ—¶å›¾å½¢</span></span><br><span class="line">  <span class="title function_">clearTempGraphics</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tempGraphics</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">graphic</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (graphic.<span class="property">remove</span>) &#123;</span><br><span class="line">        graphic.<span class="title function_">remove</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tempGraphics</span> = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// äº‹ä»¶å¤„ç†</span></span><br><span class="line">  <span class="title function_">fire</span>(<span class="params">eventType, data = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">map</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">map</span>.<span class="property">fire</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">fire</span>(<span class="string">`draw<span class="subst">$&#123;eventType&#125;</span>`</span>, data)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç‚¹ç»˜åˆ¶å·¥å…·</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DrawPoint</span> <span class="keyword">extends</span> <span class="title class_ inherited__">DrawTool</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(map, &#123; ...options, <span class="attr">type</span>: <span class="string">&#x27;point&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é»˜è®¤ç‚¹æ ·å¼</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line">        <span class="attr">pixelSize</span>: <span class="number">12</span>,</span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="string">&#x27;#000000&#x27;</span>,</span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">heightReference</span>: <span class="variable language_">this</span>.<span class="property">clampToGround</span> ? <span class="number">1</span> : <span class="number">0</span>, <span class="comment">// CLAMP_TO_GROUND : NONE</span></span><br><span class="line">        <span class="attr">disableDepthTestDistance</span>: <span class="title class_">Number</span>.<span class="property">POSITIVE_INFINITY</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">addPosition</span>(<span class="params">position</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawingPositions</span> = [position] <span class="comment">// ç‚¹åªéœ€è¦ä¸€ä¸ªä½ç½®</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç›´æ¥å®Œæˆç»˜åˆ¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">finishDrawing</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createFinalGraphic</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> position = <span class="variable language_">this</span>.<span class="property">drawingPositions</span>[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> graphic = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PointEntity</span>(&#123;</span><br><span class="line">      <span class="attr">position</span>: position,</span><br><span class="line">      <span class="attr">style</span>: <span class="variable language_">this</span>.<span class="property">style</span>,</span><br><span class="line">      <span class="attr">attr</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;draw-point&#x27;</span>,</span><br><span class="line">        <span class="attr">drawType</span>: <span class="variable language_">this</span>.<span class="property">type</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> graphic</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç»˜åˆ¶å·¥å…·</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DrawPolyline</span> <span class="keyword">extends</span> <span class="title class_ inherited__">DrawTool</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(map, &#123; ...options, <span class="attr">type</span>: <span class="string">&#x27;polyline&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é»˜è®¤çº¿æ ·å¼</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line">        <span class="attr">width</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="attr">opacity</span>: <span class="number">1.0</span>,</span><br><span class="line">        <span class="attr">clampToGround</span>: <span class="variable language_">this</span>.<span class="property">clampToGround</span>,</span><br><span class="line">        <span class="attr">outline</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="string">&#x27;#000000&#x27;</span>,</span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">lineType</span>: <span class="string">&#x27;solid&#x27;</span>, <span class="comment">// solid, dash, dot, dashdot, longdash</span></span><br><span class="line">        <span class="attr">materialType</span>: <span class="string">&#x27;Color&#x27;</span>, <span class="comment">// Color, PolylineGlow, PolylineArrow, PolylineDash</span></span><br><span class="line">        <span class="attr">materialOptions</span>: &#123;&#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createOrUpdateGraphic</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">drawingPositions</span>.<span class="property">length</span> &lt; <span class="number">2</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">drawingGraphic</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingGraphic</span> = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolylineEntity</span>(&#123;</span><br><span class="line">        <span class="attr">positions</span>: <span class="variable language_">this</span>.<span class="property">drawingPositions</span>,</span><br><span class="line">        <span class="attr">style</span>: <span class="variable language_">this</span>.<span class="property">style</span>,</span><br><span class="line">        <span class="attr">attr</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;draw-polyline-temp&#x27;</span>,</span><br><span class="line">          <span class="attr">drawType</span>: <span class="variable language_">this</span>.<span class="property">type</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ·»åŠ åˆ°ä¸´æ—¶å›¾å½¢æ•°ç»„</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">tempGraphics</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="property">drawingGraphic</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingGraphic</span>.<span class="property">positions</span> = <span class="variable language_">this</span>.<span class="property">drawingPositions</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">updateTempGraphic</span>(<span class="params">positions</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (positions.<span class="property">length</span> &lt; <span class="number">2</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">drawingGraphic</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingGraphic</span>.<span class="property">positions</span> = positions</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createFinalGraphic</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> graphic = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolylineEntity</span>(&#123;</span><br><span class="line">      <span class="attr">positions</span>: <span class="variable language_">this</span>.<span class="property">drawingPositions</span>,</span><br><span class="line">      <span class="attr">style</span>: <span class="variable language_">this</span>.<span class="property">style</span>,</span><br><span class="line">      <span class="attr">attr</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;draw-polyline&#x27;</span>,</span><br><span class="line">        <span class="attr">drawType</span>: <span class="variable language_">this</span>.<span class="property">type</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœéœ€è¦ç¼–è¾‘åŠŸèƒ½</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">hasEdit</span>) &#123;</span><br><span class="line">      graphic.<span class="property">hasEdit</span> = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> graphic</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é¢ç»˜åˆ¶å·¥å…·</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DrawPolygon</span> <span class="keyword">extends</span> <span class="title class_ inherited__">DrawTool</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(map, &#123; ...options, <span class="attr">type</span>: <span class="string">&#x27;polygon&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é»˜è®¤é¢æ ·å¼</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line">        <span class="attr">opacity</span>: <span class="number">0.6</span>,</span><br><span class="line">        <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">outlineOpacity</span>: <span class="number">1.0</span>,</span><br><span class="line">        <span class="attr">fill</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">clampToGround</span>: <span class="variable language_">this</span>.<span class="property">clampToGround</span>,</span><br><span class="line">        <span class="attr">height</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">extrudedHeight</span>: <span class="literal">undefined</span>,</span><br><span class="line">        <span class="attr">materialType</span>: <span class="string">&#x27;Color&#x27;</span>,</span><br><span class="line">        <span class="attr">materialOptions</span>: &#123;&#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createOrUpdateGraphic</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">drawingPositions</span>.<span class="property">length</span> &lt; <span class="number">3</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">drawingGraphic</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingGraphic</span> = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolygonEntity</span>(&#123;</span><br><span class="line">        <span class="attr">positions</span>: <span class="variable language_">this</span>.<span class="property">drawingPositions</span>,</span><br><span class="line">        <span class="attr">style</span>: <span class="variable language_">this</span>.<span class="property">style</span>,</span><br><span class="line">        <span class="attr">attr</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;draw-polygon-temp&#x27;</span>,</span><br><span class="line">          <span class="attr">drawType</span>: <span class="variable language_">this</span>.<span class="property">type</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">tempGraphics</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="property">drawingGraphic</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingGraphic</span>.<span class="property">positions</span> = <span class="variable language_">this</span>.<span class="property">drawingPositions</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">updateTempGraphic</span>(<span class="params">positions</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (positions.<span class="property">length</span> &lt; <span class="number">3</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">drawingGraphic</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingGraphic</span>.<span class="property">positions</span> = positions</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createFinalGraphic</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> graphic = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolygonEntity</span>(&#123;</span><br><span class="line">      <span class="attr">positions</span>: <span class="variable language_">this</span>.<span class="property">drawingPositions</span>,</span><br><span class="line">      <span class="attr">style</span>: <span class="variable language_">this</span>.<span class="property">style</span>,</span><br><span class="line">      <span class="attr">attr</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;draw-polygon&#x27;</span>,</span><br><span class="line">        <span class="attr">drawType</span>: <span class="variable language_">this</span>.<span class="property">type</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">hasEdit</span>) &#123;</span><br><span class="line">      graphic.<span class="property">hasEdit</span> = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> graphic</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çŸ©å½¢ç»˜åˆ¶å·¥å…·</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DrawRectangle</span> <span class="keyword">extends</span> <span class="title class_ inherited__">DrawTool</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(map, &#123; ...options, <span class="attr">type</span>: <span class="string">&#x27;rectangle&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line">        <span class="attr">opacity</span>: <span class="number">0.6</span>,</span><br><span class="line">        <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">clampToGround</span>: <span class="variable language_">this</span>.<span class="property">clampToGround</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getMinPositionCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span> <span class="comment">// çŸ©å½¢éœ€è¦å¯¹è§’ä¸¤ç‚¹</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">updateTempGraphic</span>(<span class="params">positions</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (positions.<span class="property">length</span> &lt; <span class="number">2</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®ä¸¤ä¸ªå¯¹è§’ç‚¹è®¡ç®—çŸ©å½¢å››ä¸ªé¡¶ç‚¹</span></span><br><span class="line">    <span class="keyword">const</span> rectanglePositions = <span class="variable language_">this</span>.<span class="title function_">calculateRectanglePositions</span>(</span><br><span class="line">      positions[<span class="number">0</span>],</span><br><span class="line">      positions[positions.<span class="property">length</span> - <span class="number">1</span>],</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">drawingGraphic</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingGraphic</span> = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolygonEntity</span>(&#123;</span><br><span class="line">        <span class="attr">positions</span>: rectanglePositions,</span><br><span class="line">        <span class="attr">style</span>: <span class="variable language_">this</span>.<span class="property">style</span>,</span><br><span class="line">        <span class="attr">attr</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;draw-rectangle-temp&#x27;</span>,</span><br><span class="line">          <span class="attr">drawType</span>: <span class="variable language_">this</span>.<span class="property">type</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">tempGraphics</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="property">drawingGraphic</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingGraphic</span>.<span class="property">positions</span> = rectanglePositions</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">calculateRectanglePositions</span>(<span class="params">startPos, endPos</span>) &#123;</span><br><span class="line">    <span class="comment">// è®¡ç®—çŸ©å½¢å››ä¸ªé¡¶ç‚¹</span></span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">      [startPos[<span class="number">0</span>], startPos[<span class="number">1</span>], startPos[<span class="number">2</span>] || <span class="number">0</span>],</span><br><span class="line">      [endPos[<span class="number">0</span>], startPos[<span class="number">1</span>], startPos[<span class="number">2</span>] || <span class="number">0</span>],</span><br><span class="line">      [endPos[<span class="number">0</span>], endPos[<span class="number">1</span>], endPos[<span class="number">2</span>] || <span class="number">0</span>],</span><br><span class="line">      [startPos[<span class="number">0</span>], endPos[<span class="number">1</span>], startPos[<span class="number">2</span>] || <span class="number">0</span>],</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createFinalGraphic</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> rectanglePositions = <span class="variable language_">this</span>.<span class="title function_">calculateRectanglePositions</span>(</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingPositions</span>[<span class="number">0</span>],</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingPositions</span>[<span class="number">1</span>],</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> graphic = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolygonEntity</span>(&#123;</span><br><span class="line">      <span class="attr">positions</span>: rectanglePositions,</span><br><span class="line">      <span class="attr">style</span>: <span class="variable language_">this</span>.<span class="property">style</span>,</span><br><span class="line">      <span class="attr">attr</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;draw-rectangle&#x27;</span>,</span><br><span class="line">        <span class="attr">drawType</span>: <span class="variable language_">this</span>.<span class="property">type</span>,</span><br><span class="line">        <span class="attr">startPosition</span>: <span class="variable language_">this</span>.<span class="property">drawingPositions</span>[<span class="number">0</span>],</span><br><span class="line">        <span class="attr">endPosition</span>: <span class="variable language_">this</span>.<span class="property">drawingPositions</span>[<span class="number">1</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">hasEdit</span>) &#123;</span><br><span class="line">      graphic.<span class="property">hasEdit</span> = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> graphic</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ†å½¢ç»˜åˆ¶å·¥å…·</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DrawCircle</span> <span class="keyword">extends</span> <span class="title class_ inherited__">DrawTool</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(map, &#123; ...options, <span class="attr">type</span>: <span class="string">&#x27;circle&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line">        <span class="attr">opacity</span>: <span class="number">0.6</span>,</span><br><span class="line">        <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">clampToGround</span>: <span class="variable language_">this</span>.<span class="property">clampToGround</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ†å½¢åˆ†æ®µæ•°</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">segments</span> = options.<span class="property">segments</span> || <span class="number">32</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">updateTempGraphic</span>(<span class="params">positions</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (positions.<span class="property">length</span> &lt; <span class="number">2</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¡ç®—åœ†å½¢ä½ç½®</span></span><br><span class="line">    <span class="keyword">const</span> circlePositions = <span class="variable language_">this</span>.<span class="title function_">calculateCirclePositions</span>(</span><br><span class="line">      positions[<span class="number">0</span>],</span><br><span class="line">      positions[positions.<span class="property">length</span> - <span class="number">1</span>],</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">drawingGraphic</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingGraphic</span> = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolygonEntity</span>(&#123;</span><br><span class="line">        <span class="attr">positions</span>: circlePositions,</span><br><span class="line">        <span class="attr">style</span>: <span class="variable language_">this</span>.<span class="property">style</span>,</span><br><span class="line">        <span class="attr">attr</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;draw-circle-temp&#x27;</span>,</span><br><span class="line">          <span class="attr">drawType</span>: <span class="variable language_">this</span>.<span class="property">type</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">tempGraphics</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="property">drawingGraphic</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingGraphic</span>.<span class="property">positions</span> = circlePositions</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">calculateCirclePositions</span>(<span class="params">centerPos, edgePos</span>) &#123;</span><br><span class="line">    <span class="comment">// è®¡ç®—åŠå¾„</span></span><br><span class="line">    <span class="keyword">const</span> radius = mars3d.<span class="property">MeasureUtil</span>.<span class="title function_">getDistance</span>([</span><br><span class="line">      mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(centerPos),</span><br><span class="line">      mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(edgePos),</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> positions = []</span><br><span class="line">    <span class="keyword">const</span> center = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(centerPos)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”Ÿæˆåœ†å½¢ä¸Šçš„ç‚¹</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= <span class="variable language_">this</span>.<span class="property">segments</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> angle = (i / <span class="variable language_">this</span>.<span class="property">segments</span>) * <span class="number">2</span> * <span class="title class_">Math</span>.<span class="property">PI</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// è®¡ç®—åç§»è·ç¦»ï¼ˆç®€åŒ–è®¡ç®—ï¼Œå®é™…åº”è€ƒè™‘åœ°çƒæ›²ç‡ï¼‰</span></span><br><span class="line">      <span class="keyword">const</span> offsetLng =</span><br><span class="line">        (radius * <span class="title class_">Math</span>.<span class="title function_">cos</span>(angle)) / (<span class="number">111320</span> * <span class="title class_">Math</span>.<span class="title function_">cos</span>(mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(center.<span class="property">lat</span>)))</span><br><span class="line">      <span class="keyword">const</span> offsetLat = (radius * <span class="title class_">Math</span>.<span class="title function_">sin</span>(angle)) / <span class="number">110540</span></span><br><span class="line"></span><br><span class="line">      positions.<span class="title function_">push</span>([center.<span class="property">lng</span> + offsetLng, center.<span class="property">lat</span> + offsetLat, center.<span class="property">alt</span>])</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> positions</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createFinalGraphic</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> circlePositions = <span class="variable language_">this</span>.<span class="title function_">calculateCirclePositions</span>(</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingPositions</span>[<span class="number">0</span>],</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingPositions</span>[<span class="number">1</span>],</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¡ç®—åŠå¾„</span></span><br><span class="line">    <span class="keyword">const</span> radius = mars3d.<span class="property">MeasureUtil</span>.<span class="title function_">getDistance</span>([</span><br><span class="line">      mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(<span class="variable language_">this</span>.<span class="property">drawingPositions</span>[<span class="number">0</span>]),</span><br><span class="line">      mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(<span class="variable language_">this</span>.<span class="property">drawingPositions</span>[<span class="number">1</span>]),</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> graphic = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolygonEntity</span>(&#123;</span><br><span class="line">      <span class="attr">positions</span>: circlePositions,</span><br><span class="line">      <span class="attr">style</span>: <span class="variable language_">this</span>.<span class="property">style</span>,</span><br><span class="line">      <span class="attr">attr</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;draw-circle&#x27;</span>,</span><br><span class="line">        <span class="attr">drawType</span>: <span class="variable language_">this</span>.<span class="property">type</span>,</span><br><span class="line">        <span class="attr">center</span>: <span class="variable language_">this</span>.<span class="property">drawingPositions</span>[<span class="number">0</span>],</span><br><span class="line">        <span class="attr">radius</span>: radius,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">hasEdit</span>) &#123;</span><br><span class="line">      graphic.<span class="property">hasEdit</span> = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> graphic</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç»˜åˆ¶ç®¡ç†å™¨"><a href="#ç»˜åˆ¶ç®¡ç†å™¨" class="headerlink" title="ç»˜åˆ¶ç®¡ç†å™¨"></a>ç»˜åˆ¶ç®¡ç†å™¨</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç»˜åˆ¶ç®¡ç†å™¨</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DrawManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span> = map</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span> = options</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“å‰ç»˜åˆ¶å·¥å…·</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">currentTool</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»˜åˆ¶ç»“æœå›¾å±‚</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawLayer</span> =</span><br><span class="line">      options.<span class="property">drawLayer</span> ||</span><br><span class="line">      <span class="keyword">new</span> mars3d.<span class="property">layer</span>.<span class="title class_">GraphicLayer</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;ç»˜åˆ¶å›¾å±‚&#x27;</span>,</span><br><span class="line">        <span class="attr">hasEdit</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå›¾å±‚æœªæ·»åŠ åˆ°åœ°å›¾ï¼Œåˆ™æ·»åŠ </span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">drawLayer</span>.<span class="property">isAdded</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">addLayer</span>(<span class="variable language_">this</span>.<span class="property">drawLayer</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»˜åˆ¶å†å²</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawHistory</span> = []</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»‘å®šäº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">bindEvents</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç»‘å®šäº‹ä»¶</span></span><br><span class="line">  <span class="title function_">bindEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ç›‘å¬ç»˜åˆ¶å®Œæˆäº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;drawComplete&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onDrawComplete</span>(event.<span class="property">graphic</span>, event.<span class="property">type</span>, event.<span class="property">positions</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç›‘å¬ç»˜åˆ¶å¼€å§‹äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;drawStart&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å¼€å§‹ç»˜åˆ¶:&#x27;</span>, event.<span class="property">type</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç›‘å¬ç»˜åˆ¶åœæ­¢äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;drawStop&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;åœæ­¢ç»˜åˆ¶&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¼€å§‹ç»˜åˆ¶</span></span><br><span class="line">  <span class="title function_">startDraw</span>(<span class="params">type, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// åœæ­¢å½“å‰ç»˜åˆ¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">stopDraw</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºå¯¹åº”çš„ç»˜åˆ¶å·¥å…·</span></span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;point&#x27;</span>:</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentTool</span> = <span class="keyword">new</span> <span class="title class_">DrawPoint</span>(<span class="variable language_">this</span>.<span class="property">map</span>, options)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;polyline&#x27;</span>:</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentTool</span> = <span class="keyword">new</span> <span class="title class_">DrawPolyline</span>(<span class="variable language_">this</span>.<span class="property">map</span>, options)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;polygon&#x27;</span>:</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentTool</span> = <span class="keyword">new</span> <span class="title class_">DrawPolygon</span>(<span class="variable language_">this</span>.<span class="property">map</span>, options)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;rectangle&#x27;</span>:</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentTool</span> = <span class="keyword">new</span> <span class="title class_">DrawRectangle</span>(<span class="variable language_">this</span>.<span class="property">map</span>, options)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;circle&#x27;</span>:</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentTool</span> = <span class="keyword">new</span> <span class="title class_">DrawCircle</span>(<span class="variable language_">this</span>.<span class="property">map</span>, options)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;ä¸æ”¯æŒçš„ç»˜åˆ¶ç±»å‹:&#x27;</span>, type)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¼€å§‹ç»˜åˆ¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">currentTool</span>.<span class="title function_">start</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœæ­¢ç»˜åˆ¶</span></span><br><span class="line">  <span class="title function_">stopDraw</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">currentTool</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">currentTool</span>.<span class="title function_">stop</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">currentTool</span> = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç»˜åˆ¶å®Œæˆå¤„ç†</span></span><br><span class="line">  <span class="title function_">onDrawComplete</span>(<span class="params">graphic, type, positions</span>) &#123;</span><br><span class="line">    <span class="comment">// æ·»åŠ åˆ°ç»˜åˆ¶å›¾å±‚</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawLayer</span>.<span class="title function_">addGraphic</span>(graphic)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ åˆ°å†å²è®°å½•</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawHistory</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">      <span class="attr">graphic</span>: graphic,</span><br><span class="line">      <span class="attr">type</span>: type,</span><br><span class="line">      <span class="attr">positions</span>: positions,</span><br><span class="line">      <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§¦å‘è‡ªå®šä¹‰äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">fire</span>(<span class="string">&#x27;drawComplete&#x27;</span>, &#123; graphic, type, positions &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ç»˜åˆ¶å®Œæˆ: <span class="subst">$&#123;type&#125;</span>`</span>, graphic)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ é™¤æŒ‡å®šå›¾å½¢</span></span><br><span class="line">  <span class="title function_">deleteGraphic</span>(<span class="params">graphic</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawLayer</span>.<span class="title function_">removeGraphic</span>(graphic)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»å†å²è®°å½•ä¸­ç§»é™¤</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawHistory</span> = <span class="variable language_">this</span>.<span class="property">drawHistory</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> item.<span class="property">graphic</span> !== graphic)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">fire</span>(<span class="string">&#x27;graphicDeleted&#x27;</span>, &#123; graphic &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¸…ç©ºæ‰€æœ‰ç»˜åˆ¶</span></span><br><span class="line">  <span class="title function_">clear</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawLayer</span>.<span class="title function_">clear</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawHistory</span> = []</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">fire</span>(<span class="string">&#x27;drawCleared&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ’¤é”€ä¸Šä¸€æ­¥ç»˜åˆ¶</span></span><br><span class="line">  <span class="title function_">undo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">drawHistory</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> lastItem = <span class="variable language_">this</span>.<span class="property">drawHistory</span>.<span class="title function_">pop</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawLayer</span>.<span class="title function_">removeGraphic</span>(lastItem.<span class="property">graphic</span>)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">fire</span>(<span class="string">&#x27;drawUndo&#x27;</span>, &#123; <span class="attr">graphic</span>: lastItem.<span class="property">graphic</span> &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–ç»˜åˆ¶ç»“æœ</span></span><br><span class="line">  <span class="title function_">getDrawResults</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">drawHistory</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> (&#123;</span><br><span class="line">      <span class="attr">type</span>: item.<span class="property">type</span>,</span><br><span class="line">      <span class="attr">positions</span>: item.<span class="property">positions</span>,</span><br><span class="line">      <span class="attr">graphic</span>: item.<span class="property">graphic</span>,</span><br><span class="line">      <span class="attr">timestamp</span>: item.<span class="property">timestamp</span>,</span><br><span class="line">    &#125;))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯¼å‡ºä¸ºGeoJSON</span></span><br><span class="line">  <span class="title function_">exportToGeoJSON</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">drawLayer</span>.<span class="title function_">toGeoJSON</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä»GeoJSONå¯¼å…¥</span></span><br><span class="line">  <span class="title function_">importFromGeoJSON</span>(<span class="params">geojson, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawLayer</span>.<span class="title function_">loadGeoJSON</span>(geojson, options)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®ç»˜åˆ¶æ ·å¼</span></span><br><span class="line">  <span class="title function_">setDrawStyle</span>(<span class="params">type, style</span>) &#123;</span><br><span class="line">    <span class="comment">// ä¿å­˜æ ·å¼ï¼Œç”¨äºä¸‹æ¬¡ç»˜åˆ¶</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span>[<span class="string">`<span class="subst">$&#123;type&#125;</span>Style`</span>] = style</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯ç”¨/ç¦ç”¨ç¼–è¾‘</span></span><br><span class="line">  <span class="title function_">enableEdit</span>(<span class="params">enabled = <span class="literal">true</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawLayer</span>.<span class="property">hasEdit</span> = enabled</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawLayer</span>.<span class="title function_">enableEdit</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawLayer</span>.<span class="title function_">disableEdit</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// äº‹ä»¶å¤„ç†</span></span><br><span class="line">  <span class="title function_">fire</span>(<span class="params">eventType, data = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">map</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">map</span>.<span class="property">fire</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">fire</span>(<span class="string">`drawManager<span class="subst">$&#123;eventType&#125;</span>`</span>, data)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç»˜åˆ¶æ§ä»¶"><a href="#ç»˜åˆ¶æ§ä»¶" class="headerlink" title="ç»˜åˆ¶æ§ä»¶"></a>ç»˜åˆ¶æ§ä»¶</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç»˜åˆ¶æ§ä»¶</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DrawControl</span> <span class="keyword">extends</span> <span class="title class_ inherited__">BaseControl</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(options)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»˜åˆ¶ç®¡ç†å™¨</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawManager</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å·¥å…·é…ç½®</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tools</span> = options.<span class="property">tools</span> || [</span><br><span class="line">      &#123; <span class="attr">type</span>: <span class="string">&#x27;point&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;ç‚¹&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;ğŸ“&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">type</span>: <span class="string">&#x27;polyline&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;çº¿&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;ğŸ“&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">type</span>: <span class="string">&#x27;polygon&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;é¢&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;ğŸ”²&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">type</span>: <span class="string">&#x27;rectangle&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;çŸ©å½¢&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;â¬›&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">type</span>: <span class="string">&#x27;circle&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;åœ†&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;â­•&#x27;</span> &#125;,</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“å‰æ¿€æ´»çš„å·¥å…·</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">activeTool</span> = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onCreate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>.<span class="title function_">onCreate</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">className</span> += <span class="string">&#x27; mars3d-draw-control&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;rgba(0, 0, 0, 0.8)&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">borderRadius</span> = <span class="string">&#x27;4px&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">padding</span> = <span class="string">&#x27;8px&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;flex&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">flexDirection</span> = <span class="string">&#x27;column&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">gap</span> = <span class="string">&#x27;4px&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºç»˜åˆ¶ç®¡ç†å™¨</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawManager</span> = <span class="keyword">new</span> <span class="title class_">DrawManager</span>(<span class="variable language_">this</span>.<span class="property">map</span>)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createTools</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createActions</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createTools</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> toolsContainer = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    toolsContainer.<span class="property">className</span> = <span class="string">&#x27;draw-tools&#x27;</span></span><br><span class="line">    toolsContainer.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;flex&#x27;</span></span><br><span class="line">    toolsContainer.<span class="property">style</span>.<span class="property">flexDirection</span> = <span class="string">&#x27;column&#x27;</span></span><br><span class="line">    toolsContainer.<span class="property">style</span>.<span class="property">gap</span> = <span class="string">&#x27;2px&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tools</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">tool</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> button = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;button&#x27;</span>)</span><br><span class="line">      button.<span class="property">className</span> = <span class="string">&#x27;draw-tool-button&#x27;</span></span><br><span class="line">      button.<span class="title function_">setAttribute</span>(<span class="string">&#x27;data-type&#x27;</span>, tool.<span class="property">type</span>)</span><br><span class="line">      button.<span class="property">innerHTML</span> = <span class="string">`<span class="subst">$&#123;tool.icon&#125;</span> <span class="subst">$&#123;tool.name&#125;</span>`</span></span><br><span class="line">      button.<span class="property">title</span> = <span class="string">`ç»˜åˆ¶<span class="subst">$&#123;tool.name&#125;</span>`</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// æŒ‰é’®æ ·å¼</span></span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">assign</span>(button.<span class="property">style</span>, &#123;</span><br><span class="line">        <span class="attr">padding</span>: <span class="string">&#x27;6px 12px&#x27;</span>,</span><br><span class="line">        <span class="attr">border</span>: <span class="string">&#x27;none&#x27;</span>,</span><br><span class="line">        <span class="attr">borderRadius</span>: <span class="string">&#x27;3px&#x27;</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;transparent&#x27;</span>,</span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">        <span class="attr">cursor</span>: <span class="string">&#x27;pointer&#x27;</span>,</span><br><span class="line">        <span class="attr">fontSize</span>: <span class="string">&#x27;12px&#x27;</span>,</span><br><span class="line">        <span class="attr">textAlign</span>: <span class="string">&#x27;left&#x27;</span>,</span><br><span class="line">        <span class="attr">transition</span>: <span class="string">&#x27;background-color 0.3s&#x27;</span>,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ‚¬åœæ•ˆæœ</span></span><br><span class="line">      button.<span class="title function_">addEventListener</span>(<span class="string">&#x27;mouseenter&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">activeTool</span> !== tool.<span class="property">type</span>) &#123;</span><br><span class="line">          button.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;rgba(255, 255, 255, 0.1)&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      button.<span class="title function_">addEventListener</span>(<span class="string">&#x27;mouseleave&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">activeTool</span> !== tool.<span class="property">type</span>) &#123;</span><br><span class="line">          button.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;transparent&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ç‚¹å‡»äº‹ä»¶</span></span><br><span class="line">      button.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">selectTool</span>(tool.<span class="property">type</span>, button)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      toolsContainer.<span class="title function_">appendChild</span>(button)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="title function_">appendChild</span>(toolsContainer)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createActions</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> actionsContainer = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    actionsContainer.<span class="property">className</span> = <span class="string">&#x27;draw-actions&#x27;</span></span><br><span class="line">    actionsContainer.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;flex&#x27;</span></span><br><span class="line">    actionsContainer.<span class="property">style</span>.<span class="property">flexDirection</span> = <span class="string">&#x27;column&#x27;</span></span><br><span class="line">    actionsContainer.<span class="property">style</span>.<span class="property">gap</span> = <span class="string">&#x27;2px&#x27;</span></span><br><span class="line">    actionsContainer.<span class="property">style</span>.<span class="property">borderTop</span> = <span class="string">&#x27;1px solid rgba(255, 255, 255, 0.2)&#x27;</span></span><br><span class="line">    actionsContainer.<span class="property">style</span>.<span class="property">paddingTop</span> = <span class="string">&#x27;6px&#x27;</span></span><br><span class="line">    actionsContainer.<span class="property">style</span>.<span class="property">marginTop</span> = <span class="string">&#x27;6px&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> actions = [</span><br><span class="line">      &#123; <span class="attr">id</span>: <span class="string">&#x27;stop&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;åœæ­¢&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;â¹ï¸&#x27;</span>, <span class="attr">action</span>: <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">stopDraw</span>() &#125;,</span><br><span class="line">      &#123; <span class="attr">id</span>: <span class="string">&#x27;undo&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;æ’¤é”€&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;â†¶&#x27;</span>, <span class="attr">action</span>: <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">drawManager</span>.<span class="title function_">undo</span>() &#125;,</span><br><span class="line">      &#123; <span class="attr">id</span>: <span class="string">&#x27;clear&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;æ¸…ç©º&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;ğŸ—‘ï¸&#x27;</span>, <span class="attr">action</span>: <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">drawManager</span>.<span class="title function_">clear</span>() &#125;,</span><br><span class="line">      &#123; <span class="attr">id</span>: <span class="string">&#x27;export&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;å¯¼å‡º&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;ğŸ“¤&#x27;</span>, <span class="attr">action</span>: <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">exportData</span>() &#125;,</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    actions.<span class="title function_">forEach</span>(<span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> button = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;button&#x27;</span>)</span><br><span class="line">      button.<span class="property">className</span> = <span class="string">&#x27;draw-action-button&#x27;</span></span><br><span class="line">      button.<span class="property">innerHTML</span> = <span class="string">`<span class="subst">$&#123;action.icon&#125;</span> <span class="subst">$&#123;action.name&#125;</span>`</span></span><br><span class="line">      button.<span class="property">title</span> = action.<span class="property">name</span></span><br><span class="line"></span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">assign</span>(button.<span class="property">style</span>, &#123;</span><br><span class="line">        <span class="attr">padding</span>: <span class="string">&#x27;4px 8px&#x27;</span>,</span><br><span class="line">        <span class="attr">border</span>: <span class="string">&#x27;none&#x27;</span>,</span><br><span class="line">        <span class="attr">borderRadius</span>: <span class="string">&#x27;3px&#x27;</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;transparent&#x27;</span>,</span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">        <span class="attr">cursor</span>: <span class="string">&#x27;pointer&#x27;</span>,</span><br><span class="line">        <span class="attr">fontSize</span>: <span class="string">&#x27;11px&#x27;</span>,</span><br><span class="line">        <span class="attr">textAlign</span>: <span class="string">&#x27;left&#x27;</span>,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      button.<span class="title function_">addEventListener</span>(<span class="string">&#x27;mouseenter&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        button.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;rgba(255, 255, 255, 0.1)&#x27;</span></span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      button.<span class="title function_">addEventListener</span>(<span class="string">&#x27;mouseleave&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        button.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;transparent&#x27;</span></span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      button.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, action.<span class="property">action</span>)</span><br><span class="line"></span><br><span class="line">      actionsContainer.<span class="title function_">appendChild</span>(button)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="title function_">appendChild</span>(actionsContainer)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é€‰æ‹©å·¥å…·</span></span><br><span class="line">  <span class="title function_">selectTool</span>(<span class="params">toolType, buttonElement</span>) &#123;</span><br><span class="line">    <span class="comment">// é‡ç½®æ‰€æœ‰æŒ‰é’®çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">const</span> buttons = <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.draw-tool-button&#x27;</span>)</span><br><span class="line">    buttons.<span class="title function_">forEach</span>(<span class="function">(<span class="params">btn</span>) =&gt;</span> &#123;</span><br><span class="line">      btn.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;transparent&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">activeTool</span> === toolType) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰æ¿€æ´»çš„å·¥å…·ï¼Œåˆ™åœæ­¢ç»˜åˆ¶</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">stopDraw</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// æ¿€æ´»æ–°å·¥å…·</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">activeTool</span> = toolType</span><br><span class="line">      buttonElement.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;rgba(255, 255, 255, 0.2)&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¼€å§‹ç»˜åˆ¶</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawManager</span>.<span class="title function_">startDraw</span>(toolType, <span class="variable language_">this</span>.<span class="title function_">getToolOptions</span>(toolType))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœæ­¢ç»˜åˆ¶</span></span><br><span class="line">  <span class="title function_">stopDraw</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">activeTool</span> = <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawManager</span>.<span class="title function_">stopDraw</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡ç½®æŒ‰é’®çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">const</span> buttons = <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.draw-tool-button&#x27;</span>)</span><br><span class="line">    buttons.<span class="title function_">forEach</span>(<span class="function">(<span class="params">btn</span>) =&gt;</span> &#123;</span><br><span class="line">      btn.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;transparent&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–å·¥å…·é€‰é¡¹</span></span><br><span class="line">  <span class="title function_">getToolOptions</span>(<span class="params">toolType</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> options = &#123;</span><br><span class="line">      <span class="attr">clampToGround</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">hasEdit</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®å·¥å…·ç±»å‹è®¾ç½®é»˜è®¤æ ·å¼</span></span><br><span class="line">    <span class="keyword">switch</span> (toolType) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;point&#x27;</span>:</span><br><span class="line">        options.<span class="property">style</span> = &#123;</span><br><span class="line">          <span class="attr">color</span>: <span class="string">&#x27;#ff0000&#x27;</span>,</span><br><span class="line">          <span class="attr">pixelSize</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">outlineColor</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">          <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;polyline&#x27;</span>:</span><br><span class="line">        options.<span class="property">style</span> = &#123;</span><br><span class="line">          <span class="attr">color</span>: <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line">          <span class="attr">width</span>: <span class="number">3</span>,</span><br><span class="line">          <span class="attr">materialType</span>: <span class="string">&#x27;Color&#x27;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;polygon&#x27;</span>:</span><br><span class="line">        options.<span class="property">style</span> = &#123;</span><br><span class="line">          <span class="attr">color</span>: <span class="string">&#x27;#00ff00&#x27;</span>,</span><br><span class="line">          <span class="attr">opacity</span>: <span class="number">0.5</span>,</span><br><span class="line">          <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">outlineColor</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">          <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;rectangle&#x27;</span>:</span><br><span class="line">        options.<span class="property">style</span> = &#123;</span><br><span class="line">          <span class="attr">color</span>: <span class="string">&#x27;#0000ff&#x27;</span>,</span><br><span class="line">          <span class="attr">opacity</span>: <span class="number">0.5</span>,</span><br><span class="line">          <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">outlineColor</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">          <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;circle&#x27;</span>:</span><br><span class="line">        options.<span class="property">style</span> = &#123;</span><br><span class="line">          <span class="attr">color</span>: <span class="string">&#x27;#ff00ff&#x27;</span>,</span><br><span class="line">          <span class="attr">opacity</span>: <span class="number">0.5</span>,</span><br><span class="line">          <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">outlineColor</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">          <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> options</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯¼å‡ºæ•°æ®</span></span><br><span class="line">  <span class="title function_">exportData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> geojson = <span class="variable language_">this</span>.<span class="property">drawManager</span>.<span class="title function_">exportToGeoJSON</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸‹è½½é“¾æ¥</span></span><br><span class="line">    <span class="keyword">const</span> dataStr = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(geojson, <span class="literal">null</span>, <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">const</span> dataBlob = <span class="keyword">new</span> <span class="title class_">Blob</span>([dataStr], &#123; <span class="attr">type</span>: <span class="string">&#x27;application/json&#x27;</span> &#125;)</span><br><span class="line">    <span class="keyword">const</span> url = <span class="variable constant_">URL</span>.<span class="title function_">createObjectURL</span>(dataBlob)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> link = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    link.<span class="property">href</span> = url</span><br><span class="line">    link.<span class="property">download</span> = <span class="string">`draw-data-<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().getTime()&#125;</span>.geojson`</span></span><br><span class="line">    link.<span class="title function_">click</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable constant_">URL</span>.<span class="title function_">revokeObjectURL</span>(url)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»˜åˆ¶åŠŸèƒ½ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºç»˜åˆ¶æ§ä»¶</span></span><br><span class="line"><span class="keyword">const</span> drawControl = <span class="keyword">new</span> <span class="title class_">DrawControl</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="string">&#x27;top-left&#x27;</span>,</span><br><span class="line">  <span class="attr">tools</span>: [</span><br><span class="line">    &#123; <span class="attr">type</span>: <span class="string">&#x27;point&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;æ ‡æ³¨&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;ğŸ“&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">type</span>: <span class="string">&#x27;polyline&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;è·¯å¾„&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;ğŸ“&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">type</span>: <span class="string">&#x27;polygon&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;åŒºåŸŸ&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;ğŸ”²&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">type</span>: <span class="string">&#x27;rectangle&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;çŸ©å½¢&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;â¬›&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">type</span>: <span class="string">&#x27;circle&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;åœ†å½¢&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;â­•&#x27;</span> &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">drawControl.<span class="title function_">addTo</span>(map)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘å¬ç»˜åˆ¶äº‹ä»¶</span></span><br><span class="line">map.<span class="title function_">on</span>(<span class="string">&#x27;drawManager:drawComplete&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç»˜åˆ¶å®Œæˆ:&#x27;</span>, event.<span class="property">graphic</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è‡ªå®šä¹‰å¤„ç†é€»è¾‘</span></span><br><span class="line">  <span class="comment">// æ¯”å¦‚ä¿å­˜åˆ°æ•°æ®åº“ã€è®¡ç®—é¢ç§¯ç­‰</span></span><br><span class="line">  <span class="keyword">if</span> (event.<span class="property">type</span> === <span class="string">&#x27;polygon&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> area = mars3d.<span class="property">MeasureUtil</span>.<span class="title function_">measureArea</span>(event.<span class="property">positions</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å¤šè¾¹å½¢é¢ç§¯:&#x27;</span>, mars3d.<span class="property">MeasureUtil</span>.<span class="title function_">formatArea</span>(area))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¨‹åºåŒ–ç»˜åˆ¶ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> drawManager = <span class="keyword">new</span> <span class="title class_">DrawManager</span>(map)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›´æ¥å¼€å§‹ç»˜åˆ¶</span></span><br><span class="line">drawManager.<span class="title function_">startDraw</span>(<span class="string">&#x27;polygon&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&#x27;#ff0000&#x27;</span>,</span><br><span class="line">    <span class="attr">opacity</span>: <span class="number">0.6</span>,</span><br><span class="line">    <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">outlineColor</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">    <span class="attr">outlineWidth</span>: <span class="number">3</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">clampToGround</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">hasEdit</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®ç»˜åˆ¶æ ·å¼</span></span><br><span class="line">drawManager.<span class="title function_">setDrawStyle</span>(<span class="string">&#x27;polyline&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">color</span>: <span class="string">&#x27;#00ffff&#x27;</span>,</span><br><span class="line">  <span class="attr">width</span>: <span class="number">5</span>,</span><br><span class="line">  <span class="attr">materialType</span>: <span class="string">&#x27;PolylineGlow&#x27;</span>,</span><br><span class="line">  <span class="attr">materialOptions</span>: &#123;</span><br><span class="line">    <span class="attr">glowPower</span>: <span class="number">0.3</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç»˜åˆ¶åŠŸèƒ½æ¨¡å—æä¾›äº†å®Œæ•´çš„ç»˜åˆ¶è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š</p><ol><li><strong>ç»˜åˆ¶å·¥å…·åŸºç±»</strong> - æä¾›ç»Ÿä¸€çš„ç»˜åˆ¶æ¥å£å’Œäº‹ä»¶å¤„ç†</li><li><strong>å…·ä½“ç»˜åˆ¶å·¥å…·</strong> - ç‚¹ã€çº¿ã€é¢ã€çŸ©å½¢ã€åœ†å½¢ç­‰å›¾å½¢çš„ç»˜åˆ¶</li><li><strong>ç»˜åˆ¶ç®¡ç†å™¨</strong> - ç»Ÿä¸€ç®¡ç†ç»˜åˆ¶è¿‡ç¨‹å’Œç»“æœ</li><li><strong>ç»˜åˆ¶æ§ä»¶</strong> - æä¾›ç”¨æˆ·ç•Œé¢å’Œäº¤äº’åŠŸèƒ½</li></ol><p>æ¯ä¸ªå·¥å…·éƒ½æ”¯æŒè‡ªå®šä¹‰æ ·å¼ã€è´´åœ°æ¨¡å¼ã€ç¼–è¾‘åŠŸèƒ½ç­‰ç‰¹æ€§ï¼Œå¯ä»¥æ»¡è¶³å„ç§ç»˜åˆ¶éœ€æ±‚ã€‚</p><h2 id="ğŸ“š-æ€»ç»“"><a href="#ğŸ“š-æ€»ç»“" class="headerlink" title="ğŸ“š æ€»ç»“"></a>ğŸ“š æ€»ç»“</h2><p>æœ¬æŒ‡å—æ¶µç›–äº†Mars3Dç¦»çº¿å¼€å‘çš„æ‰€æœ‰æ ¸å¿ƒæ¦‚å¿µå’Œè¯¦ç»†å±æ€§è¯´æ˜ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li><strong>ç¯å¢ƒé…ç½®</strong>: å®Œæ•´çš„ç¦»çº¿å¼€å‘ç¯å¢ƒæ­å»º</li><li><strong>Mapé…ç½®</strong>: è¯¦ç»†çš„æ„é€ å‚æ•°å’Œåœ°å›¾é€‰é¡¹</li><li><strong>åæ ‡ç³»ç»Ÿ</strong>: å®Œæ•´çš„åæ ‡è½¬æ¢å’ŒæŠ•å½±ç³»ç»Ÿ</li><li><strong>å›¾å±‚ç³»ç»Ÿ</strong>: å„ç§ç±»å‹å›¾å±‚çš„è¯¦ç»†é…ç½®</li><li><strong>çŸ¢é‡æ•°æ®</strong>: ç‚¹ã€çº¿ã€é¢ç­‰å›¾å½¢çš„å®Œæ•´å±æ€§</li><li><strong>ä¸‰ç»´æ¨¡å‹</strong>: æ¨¡å‹åŠ è½½å’Œç“¦ç‰‡é›†çš„é…ç½®é€‰é¡¹</li><li><strong>ç›¸æœºæ§åˆ¶</strong>: å®Œæ•´çš„ç›¸æœºæ“ä½œæ–¹æ³•</li><li><strong>äº‹ä»¶å¤„ç†</strong>: åœ°å›¾å’Œå›¾å½¢çš„äº‹ä»¶å¤„ç†æœºåˆ¶</li><li><strong>æè´¨ç³»ç»Ÿ</strong>: å„ç§å†…ç½®å’Œè‡ªå®šä¹‰æè´¨</li><li><strong>åŠ¨ç”»ç³»ç»Ÿ</strong>: è½¨è¿¹åŠ¨ç”»å’Œå±æ€§åŠ¨ç”»</li><li><strong>åˆ†æåŠŸèƒ½</strong>: ç©ºé—´åˆ†æå’Œæµ‹é‡å·¥å…·</li><li><strong>æ§ä»¶ç³»ç»Ÿ</strong>: å„ç§å†…ç½®æ§ä»¶çš„é…ç½®å’Œä½¿ç”¨</li><li><strong>ç»˜åˆ¶åŠŸèƒ½</strong>: å®Œæ•´çš„ç»˜åˆ¶å·¥å…·è§£å†³æ–¹æ¡ˆ</li></ul><p>è¿™ä»½æŒ‡å—ä¸ºç¦»çº¿Mars3Då¼€å‘æä¾›äº†å®Œæ•´çš„å‚è€ƒï¼Œæ¯ä¸ªå±æ€§éƒ½åŒ…å«äº†ä½œç”¨è¯´æ˜ã€é»˜è®¤å€¼ã€ä½¿ç”¨ç¤ºä¾‹ï¼Œå¸®åŠ©å¼€å‘è€…åœ¨æ— ç½‘ç»œç¯å¢ƒä¸‹ä¹Ÿèƒ½é«˜æ•ˆå¼€å‘Mars3Dåº”ç”¨ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Mars3D-å®Œæ•´ç¦»çº¿å¼€å‘æŒ‡å—&quot;&gt;&lt;a href=&quot;#Mars3D-å®Œæ•´ç¦»çº¿å¼€å‘æŒ‡å—&quot; class=&quot;headerlink&quot; title=&quot;Mars3D å®Œæ•´ç¦»çº¿å¼€å‘æŒ‡å—&quot;&gt;&lt;/a&gt;Mars3D å®Œæ•´ç¦»çº¿å¼€å‘æŒ‡å—&lt;/h1&gt;&lt;h2 id=&quot;ğŸ“‹-ç›®å½•&quot;&gt;&lt;a hre</summary>
      
    
    
    
    
    <category term="ä¸‰ç»´GIS" scheme="https://aoayaoa.github.io/tags/%E4%B8%89%E7%BB%B4GIS/"/>
    
    <category term="mars3d" scheme="https://aoayaoa.github.io/tags/mars3d/"/>
    
    <category term="æ•™ç¨‹" scheme="https://aoayaoa.github.io/tags/%E6%95%99%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Goè¯­è¨€å­¦ä¹ æ€»ç»“</title>
    <link href="https://aoayaoa.github.io/2025/04/25/Go%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/"/>
    <id>https://aoayaoa.github.io/2025/04/25/Go%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/</id>
    <published>2025-04-24T16:00:00.000Z</published>
    <updated>2025-05-04T13:38:00.698Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Goè¯­è¨€å­¦ä¹ æ€»ç»“"><a href="#Goè¯­è¨€å­¦ä¹ æ€»ç»“" class="headerlink" title="Goè¯­è¨€å­¦ä¹ æ€»ç»“"></a>Goè¯­è¨€å­¦ä¹ æ€»ç»“</h1><h2 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h2><ul><li><a href="#%E4%B8%80go%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80">ä¸€ã€Goè¯­è¨€åŸºç¡€</a><ul><li><a href="#1-%E5%AE%89%E8%A3%85%E4%B8%8E%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE">1. å®‰è£…ä¸ç¯å¢ƒé…ç½®</a></li><li><a href="#2-go%E8%AF%AD%E8%A8%80%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5">2. Goè¯­è¨€æ ¸å¿ƒæ¦‚å¿µ</a><ul><li><a href="#%E5%8C%85%E4%B8%8E%E6%A8%A1%E5%9D%97">åŒ…ä¸æ¨¡å—</a></li><li><a href="#%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">åŸºæœ¬æ•°æ®ç±»å‹</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">æ•°æ®ç±»å‹ä½¿ç”¨åœºæ™¯</a></li><li><a href="#%E5%A4%8D%E6%95%B0%E7%B1%BB%E5%9E%8B%E8%AF%A6%E8%A7%A3">å¤æ•°ç±»å‹è¯¦è§£</a></li><li><a href="#%E5%8F%98%E9%87%8F%E4%B8%8E%E5%B8%B8%E9%87%8F">å˜é‡ä¸å¸¸é‡</a></li><li><a href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6">æµç¨‹æ§åˆ¶</a></li></ul></li><li><a href="#3-%E5%87%BD%E6%95%B0%E4%B8%8E%E6%96%B9%E6%B3%95">3. å‡½æ•°ä¸æ–¹æ³•</a></li><li><a href="#4-%E7%BB%93%E6%9E%84%E4%BD%93%E4%B8%8E%E6%8E%A5%E5%8F%A3">4. ç»“æ„ä½“ä¸æ¥å£</a></li><li><a href="#5-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B">5. å¹¶å‘ç¼–ç¨‹</a></li><li><a href="#%E9%80%9A%E9%81%93%E8%AF%A6%E8%A7%A3">6. é€šé“è¯¦è§£</a></li><li><a href="#context%E4%B8%8A%E4%B8%8B%E6%96%87">7. Contextä¸Šä¸‹æ–‡</a></li></ul></li><li><a href="#%E4%BA%8C%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84%E4%B8%8E%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F">äºŒã€é¡¹ç›®æ¶æ„ä¸è®¾è®¡æ¨¡å¼</a><ul><li><a href="#1-%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84">1. åˆ†å±‚æ¶æ„</a></li><li><a href="#2-%E4%BB%93%E5%82%A8%E6%A8%A1%E5%BC%8Frepository-pattern">2. ä»“å‚¨æ¨¡å¼</a></li><li><a href="#3-%E6%9C%8D%E5%8A%A1%E5%B1%82service-layer">3. æœåŠ¡å±‚</a></li><li><a href="#4-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86">4. é…ç½®ç®¡ç†</a></li><li><a href="#5-%E4%B8%AD%E9%97%B4%E4%BB%B6%E8%AE%BE%E8%AE%A1">5. ä¸­é—´ä»¶è®¾è®¡</a></li><li><a href="#6-%E6%97%A5%E5%BF%97%E5%B7%A5%E5%85%B7">6. æ—¥å¿—å·¥å…·</a></li></ul></li><li><a href="#%E4%B8%89web%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91gin%E6%A1%86%E6%9E%B6">ä¸‰ã€Webåº”ç”¨å¼€å‘</a><ul><li><a href="#1-%E8%B7%AF%E7%94%B1%E8%AE%BE%E7%BD%AE">1. è·¯ç”±è®¾ç½®</a></li><li><a href="#2-%E6%8E%A7%E5%88%B6%E5%99%A8%E5%AE%9E%E7%8E%B0">2. æ§åˆ¶å™¨å®ç°</a></li><li><a href="#3-%E4%B8%BB%E7%A8%8B%E5%BA%8F%E5%85%A5%E5%8F%A3">3. ä¸»ç¨‹åºå…¥å£</a></li></ul></li><li><a href="#%E5%9B%9B%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B8%8E%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83">å››ã€æœ€ä½³å®è·µä¸ç¼–ç è§„èŒƒ</a><ul><li><a href="#1-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">1. é”™è¯¯å¤„ç†</a></li><li><a href="#2-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6">2. å¹¶å‘æ§åˆ¶</a></li><li><a href="#3-%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95">3. å•å…ƒæµ‹è¯•</a></li><li><a href="#4-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">4. æ€§èƒ½ä¼˜åŒ–</a></li><li><a href="#5-api%E8%AE%BE%E8%AE%A1">5. APIè®¾è®¡</a></li></ul></li><li><a href="#%E4%BA%94%E8%BF%9B%E9%98%B6%E4%B8%BB%E9%A2%98%E4%B8%8E%E6%89%A9%E5%B1%95">äº”ã€è¿›é˜¶ä¸»é¢˜ä¸æ‰©å±•</a><ul><li><a href="#1-%E9%83%A8%E7%BD%B2%E4%B8%8Ecicd">1. éƒ¨ç½²ä¸CI&#x2F;CD</a></li><li><a href="#2-%E7%9B%91%E6%8E%A7%E4%B8%8E%E6%97%A5%E5%BF%97">2. ç›‘æ§ä¸æ—¥å¿—</a></li><li><a href="#3-%E5%AE%89%E5%85%A8%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">3. å®‰å…¨æœ€ä½³å®è·µ</a></li></ul></li><li><a href="#%E5%85%AD%E5%B8%B8%E8%A7%81%E9%99%B7%E9%98%B1%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">å…­ã€å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ</a><ul><li><a href="#1-%E5%88%9D%E5%AD%A6%E8%80%85%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF">1. åˆå­¦è€…å¸¸è§é”™è¯¯</a></li><li><a href="#2-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%8F%90%E7%A4%BA">2. æ€§èƒ½ä¼˜åŒ–æç¤º</a></li><li><a href="#3-%E4%BB%A3%E7%A0%81%E9%A3%8E%E6%A0%BC%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">3. ä»£ç é£æ ¼æœ€ä½³å®è·µ</a></li></ul></li><li><a href="#%E4%B8%83%E6%B3%9B%E5%9E%8B%E7%BC%96%E7%A8%8B-go-118">ä¸ƒã€æ³›å‹ç¼–ç¨‹ (Go 1.18+)</a><ul><li><a href="#1-%E6%B3%9B%E5%9E%8B%E5%87%BD%E6%95%B0">1. æ³›å‹å‡½æ•°</a></li><li><a href="#2-%E6%B3%9B%E5%9E%8B%E7%B1%BB%E5%9E%8B">2. æ³›å‹ç±»å‹</a></li><li><a href="#3-%E4%BD%BF%E7%94%A8%E6%B3%9B%E5%9E%8B%E7%B1%BB%E5%9E%8B">3. ä½¿ç”¨æ³›å‹ç±»å‹</a></li><li><a href="#4-%E6%B3%9B%E5%9E%8B%E7%BA%A6%E6%9D%9F">4. æ³›å‹çº¦æŸ</a></li><li><a href="#5-%E6%B3%9B%E5%9E%8B%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">5. æ³›å‹ä½¿ç”¨åœºæ™¯</a></li><li><a href="#6-%E6%B3%9B%E5%9E%8B%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">6. æ³›å‹æœ€ä½³å®è·µ</a></li></ul></li><li><a href="#%E5%85%AB%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E7%82%B9%E5%9B%9E%E9%A1%BE">å…«ã€æ ¸å¿ƒçŸ¥è¯†ç‚¹å›é¡¾</a></li></ul><hr><h2 id="ä¸€ã€Goè¯­è¨€åŸºç¡€"><a href="#ä¸€ã€Goè¯­è¨€åŸºç¡€" class="headerlink" title="ä¸€ã€Goè¯­è¨€åŸºç¡€"></a>ä¸€ã€Goè¯­è¨€åŸºç¡€</h2><h3 id="1-å®‰è£…ä¸ç¯å¢ƒé…ç½®"><a href="#1-å®‰è£…ä¸ç¯å¢ƒé…ç½®" class="headerlink" title="1. å®‰è£…ä¸ç¯å¢ƒé…ç½®"></a>1. å®‰è£…ä¸ç¯å¢ƒé…ç½®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½å®‰è£…Go</span></span><br><span class="line">brew install go  <span class="comment"># macOS</span></span><br><span class="line"><span class="comment"># æˆ– apt-get install golang-go  # Ubuntu</span></span><br><span class="line"><span class="comment"># æˆ–ä» https://golang.org/dl/ ä¸‹è½½å®‰è£…åŒ…</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="built_in">export</span> GOROOT=/usr/local/go  <span class="comment"># Goå®‰è£…è·¯å¾„</span></span><br><span class="line"><span class="built_in">export</span> GOPATH=<span class="variable">$HOME</span>/go       <span class="comment"># Goå·¥ä½œåŒº</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$GOROOT</span>/bin:<span class="variable">$GOPATH</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯å®‰è£…</span></span><br><span class="line">go version</span><br></pre></td></tr></table></figure><h3 id="2-Goè¯­è¨€æ ¸å¿ƒæ¦‚å¿µ"><a href="#2-Goè¯­è¨€æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="2. Goè¯­è¨€æ ¸å¿ƒæ¦‚å¿µ"></a>2. Goè¯­è¨€æ ¸å¿ƒæ¦‚å¿µ</h3><h4 id="åŒ…ä¸æ¨¡å—"><a href="#åŒ…ä¸æ¨¡å—" class="headerlink" title="åŒ…ä¸æ¨¡å—"></a>åŒ…ä¸æ¨¡å—</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å£°æ˜åŒ…</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¼å…¥åŒ…</span></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span>  <span class="comment">// ç¬¬ä¸‰æ–¹åŒ…</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–æ¨¡å—</span></span><br><span class="line"><span class="comment">// go mod init go-app</span></span><br></pre></td></tr></table></figure><h4 id="åŸºæœ¬æ•°æ®ç±»å‹"><a href="#åŸºæœ¬æ•°æ®ç±»å‹" class="headerlink" title="åŸºæœ¬æ•°æ®ç±»å‹"></a>åŸºæœ¬æ•°æ®ç±»å‹</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸºæœ¬ç±»å‹</span></span><br><span class="line"><span class="keyword">var</span> i <span class="type">int</span> = <span class="number">10</span>            <span class="comment">// æ•´æ•°</span></span><br><span class="line"><span class="keyword">var</span> f <span class="type">float64</span> = <span class="number">3.14</span>      <span class="comment">// æµ®ç‚¹æ•°</span></span><br><span class="line"><span class="keyword">var</span> b <span class="type">bool</span> = <span class="literal">true</span>         <span class="comment">// å¸ƒå°”å€¼</span></span><br><span class="line"><span class="keyword">var</span> s <span class="type">string</span> = <span class="string">&quot;hello&quot;</span>    <span class="comment">// å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="keyword">var</span> r <span class="type">rune</span> = <span class="string">&#x27;ä½ &#x27;</span>         <span class="comment">// Unicodeå­—ç¬¦</span></span><br><span class="line"><span class="keyword">var</span> by <span class="type">byte</span> = <span class="string">&#x27;A&#x27;</span>         <span class="comment">// ASCIIå­—ç¬¦</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤åˆç±»å‹</span></span><br><span class="line"><span class="keyword">var</span> arr [<span class="number">5</span>]<span class="type">int</span>                   <span class="comment">// æ•°ç»„</span></span><br><span class="line"><span class="keyword">var</span> slice = []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;       <span class="comment">// åˆ‡ç‰‡</span></span><br><span class="line"><span class="keyword">var</span> m = <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>&#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;   <span class="comment">// æ˜ å°„</span></span><br><span class="line"><span class="keyword">var</span> p *<span class="type">int</span>                       <span class="comment">// æŒ‡é’ˆ</span></span><br></pre></td></tr></table></figure><h4 id="æ•°æ®ç±»å‹ä½¿ç”¨åœºæ™¯"><a href="#æ•°æ®ç±»å‹ä½¿ç”¨åœºæ™¯" class="headerlink" title="æ•°æ®ç±»å‹ä½¿ç”¨åœºæ™¯"></a>æ•°æ®ç±»å‹ä½¿ç”¨åœºæ™¯</h4><p><strong>æ•°å€¼ç±»å‹</strong>ï¼š</p><ul><li><p><code>int</code>&#x2F;<code>int8</code>&#x2F;<code>int16</code>&#x2F;<code>int32</code>&#x2F;<code>int64</code>ï¼šç”¨äºè¡¨ç¤ºæ•´æ•°å€¼</p><ul><li>ä½¿ç”¨åœºæ™¯ï¼šå¾ªç¯è®¡æ•°å™¨ã€æ•°ç»„ç´¢å¼•ã€IDã€å¹´é¾„ç­‰</li><li>é€‰æ‹©å»ºè®®ï¼šé€šå¸¸ä½¿ç”¨<code>int</code>ï¼ŒGoä¼šæ ¹æ®å¹³å°é€‰æ‹©åˆé€‚çš„ä½æ•°(32ä½æˆ–64ä½)</li></ul></li><li><p><code>uint</code>&#x2F;<code>uint8</code>&#x2F;<code>uint16</code>&#x2F;<code>uint32</code>&#x2F;<code>uint64</code>ï¼šæ— ç¬¦å·æ•´æ•°</p><ul><li>ä½¿ç”¨åœºæ™¯ï¼šæ–‡ä»¶å¤§å°ã€å†…å­˜å¤§å°ã€ä½æ“ä½œç­‰å¿…é¡»ä¸ºéè´Ÿæ•°çš„åœºåˆ</li><li><code>uint8</code>ç­‰åŒäº<code>byte</code>ï¼Œå¸¸ç”¨äºå¤„ç†äºŒè¿›åˆ¶æ•°æ®</li></ul></li><li><p><code>float32</code>&#x2F;<code>float64</code>ï¼šæµ®ç‚¹æ•°</p><ul><li>ä½¿ç”¨åœºæ™¯ï¼šç§‘å­¦è®¡ç®—ã€é‡‘èè®¡ç®—(æ³¨æ„ç²¾åº¦é—®é¢˜)ã€åæ ‡å€¼ç­‰</li><li>é€‰æ‹©å»ºè®®ï¼šé€šå¸¸ä¼˜å…ˆä½¿ç”¨<code>float64</code>ä»¥è·å¾—æ›´é«˜ç²¾åº¦</li></ul></li><li><p><code>complex64</code>&#x2F;<code>complex128</code>ï¼šå¤æ•°</p><ul><li>ä½¿ç”¨åœºæ™¯ï¼šç§‘å­¦è®¡ç®—ã€ä¿¡å·å¤„ç†ã€ç”µæ°”å·¥ç¨‹è®¡ç®—</li></ul></li></ul><p><strong>å­—ç¬¦ç›¸å…³ç±»å‹</strong>ï¼š</p><ul><li><p><code>string</code>ï¼šå­—ç¬¦ä¸²</p><ul><li>ä½¿ç”¨åœºæ™¯ï¼šæ–‡æœ¬å¤„ç†ã€ç”¨æˆ·è¾“å…¥ã€é…ç½®ä¿¡æ¯ç­‰</li><li>ç‰¹ç‚¹ï¼šä¸å¯å˜ï¼ŒUTF-8ç¼–ç ï¼Œå¯ä½¿ç”¨+è¿æ¥æˆ–strings.Builderæ„å»º</li></ul></li><li><p><code>rune</code>ï¼šç­‰åŒäº<code>int32</code>ï¼Œè¡¨ç¤ºä¸€ä¸ªUnicodeç ç‚¹</p><ul><li>ä½¿ç”¨åœºæ™¯ï¼šå¤„ç†å›½é™…åŒ–æ–‡æœ¬ã€éœ€è¦éå†Unicodeå­—ç¬¦çš„åœºæ™¯</li><li>ç¤ºä¾‹ï¼š<code>for _, r := range &quot;ä½ å¥½ä¸–ç•Œ&quot; &#123; fmt.Printf(&quot;%c&quot;, r) &#125;</code></li></ul></li><li><p><code>byte</code>ï¼šç­‰åŒäº<code>uint8</code>ï¼Œè¡¨ç¤ºä¸€ä¸ªASCIIå­—ç¬¦æˆ–äºŒè¿›åˆ¶æ•°æ®çš„ä¸€ä¸ªå­—èŠ‚</p><ul><li>ä½¿ç”¨åœºæ™¯ï¼šæ–‡ä»¶I&#x2F;Oã€ç½‘ç»œä¼ è¾“ã€åŠ å¯†è§£å¯†ã€å›¾åƒå¤„ç†ç­‰</li></ul></li></ul><p><strong>å¸ƒå°”ç±»å‹</strong>ï¼š</p><ul><li><code>bool</code>ï¼štrueæˆ–false<ul><li>ä½¿ç”¨åœºæ™¯ï¼šæ¡ä»¶åˆ¤æ–­ã€æ ‡å¿—ä½ã€çŠ¶æ€è¡¨ç¤º</li><li>æ³¨æ„ï¼šGoä¸­ä¸å…è®¸å°†æ•´æ•°éšå¼è½¬æ¢ä¸ºå¸ƒå°”å€¼</li></ul></li></ul><p><strong>å¤åˆç±»å‹</strong>ï¼š</p><ul><li><p>æ•°ç»„<code>[n]T</code>ï¼šå›ºå®šé•¿åº¦çš„å…ƒç´ åºåˆ—</p><ul><li>ä½¿ç”¨åœºæ™¯ï¼šçŸ¥é“å…ƒç´ ä¸ªæ•°ä¸”ä¸ä¼šå˜åŒ–çš„é›†åˆ</li><li>æ³¨æ„ï¼šä½œä¸ºå‡½æ•°å‚æ•°æ—¶ä¼šå¤åˆ¶æ•´ä¸ªæ•°ç»„ï¼Œé€šå¸¸ä½¿ç”¨åˆ‡ç‰‡ä»£æ›¿</li></ul></li><li><p>åˆ‡ç‰‡<code>[]T</code>ï¼šåŠ¨æ€æ•°ç»„</p><ul><li>ä½¿ç”¨åœºæ™¯ï¼šå¤§å¤šæ•°éœ€è¦åºåˆ—çš„åœºåˆï¼Œå¦‚å‡½æ•°è¿”å›å¤šä¸ªåŒç±»ç»“æœ</li><li>ç‰¹ç‚¹ï¼šå¯åŠ¨æ€å¢é•¿ï¼Œåº•å±‚å¼•ç”¨æ•°ç»„ï¼Œä¼ é€’æ—¶æ˜¯å¼•ç”¨ä¼ é€’</li></ul></li><li><p>æ˜ å°„<code>map[K]V</code>ï¼šé”®å€¼å¯¹é›†åˆ</p><ul><li>ä½¿ç”¨åœºæ™¯ï¼šéœ€è¦é€šè¿‡é”®å¿«é€ŸæŸ¥æ‰¾å€¼ï¼Œé…ç½®è®¾ç½®ï¼Œç¼“å­˜</li><li>ç‰¹ç‚¹ï¼šæ— åºï¼Œé”®å¿…é¡»å¯æ¯”è¾ƒï¼ˆä¸èƒ½ç”¨åˆ‡ç‰‡ä½œé”®ï¼‰</li></ul></li><li><p>æŒ‡é’ˆ<code>*T</code>ï¼šæŒ‡å‘å˜é‡çš„å†…å­˜åœ°å€</p><ul><li>ä½¿ç”¨åœºæ™¯ï¼šéœ€è¦ä¿®æ”¹å‡½æ•°å¤–çš„å˜é‡ï¼Œé¿å…å¤§å¯¹è±¡å¤åˆ¶</li><li>ç¤ºä¾‹ï¼š<code>func updateValue(ptr *int) &#123; *ptr = 100 &#125;</code></li></ul></li><li><p>ç»“æ„ä½“<code>struct</code>ï¼šè‡ªå®šä¹‰å¤åˆç±»å‹</p><ul><li>ä½¿ç”¨åœºæ™¯ï¼šè¡¨ç¤ºå®ä½“å¯¹è±¡ã€æ•°æ®æ¨¡å‹ã€è¯·æ±‚&#x2F;å“åº”ç»“æ„</li><li>ç¤ºä¾‹ï¼š<code>type User struct &#123; Name string; Age int &#125;</code></li></ul></li><li><p>æ¥å£<code>interface</code>ï¼šæ–¹æ³•é›†åˆ</p><ul><li>ä½¿ç”¨åœºæ™¯ï¼šå®ç°å¤šæ€ã€ä¾èµ–æ³¨å…¥ã€æŠ½è±¡è¡Œä¸º</li><li>é›¶å€¼ï¼š<code>nil</code>ï¼Œä»£è¡¨æ²¡æœ‰å…·ä½“ç±»å‹å®ç°</li></ul></li><li><p>é€šé“<code>chan</code>ï¼šgoroutineé—´é€šä¿¡çš„ç®¡é“</p><ul><li>ä½¿ç”¨åœºæ™¯ï¼šå¹¶å‘ç¼–ç¨‹ï¼Œæ•°æ®æµæ§åˆ¶ï¼ŒåŒæ­¥å¤šä¸ªgoroutine</li><li>ç¤ºä¾‹ï¼š<code>ch := make(chan int, 10) // æœ‰ç¼“å†²é€šé“</code></li></ul></li><li><p>å‡½æ•°ç±»å‹<code>func</code>ï¼šå‡½æ•°ä½œä¸ºå€¼ä¼ é€’</p><ul><li>ä½¿ç”¨åœºæ™¯ï¼šå›è°ƒå‡½æ•°ã€ç­–ç•¥æ¨¡å¼å®ç°ã€äº‹ä»¶å¤„ç†</li><li>ç¤ºä¾‹ï¼š<code>var handler func(w http.ResponseWriter, r *http.Request)</code></li></ul></li></ul><p><strong>ç‰¹æ®Šç±»å‹</strong>ï¼š</p><ul><li><p><code>error</code>ï¼šé”™è¯¯æ¥å£</p><ul><li>ä½¿ç”¨åœºæ™¯ï¼šé”™è¯¯å¤„ç†å’Œä¼ æ’­</li><li>æƒ¯ä¾‹ï¼šå‡½æ•°æœ€åä¸€ä¸ªè¿”å›å€¼é€šå¸¸æ˜¯error</li></ul></li><li><p><code>nil</code>ï¼šé›¶å€¼</p><ul><li>é€‚ç”¨ç±»å‹ï¼šæŒ‡é’ˆã€åˆ‡ç‰‡ã€æ˜ å°„ã€é€šé“ã€å‡½æ•°å’Œæ¥å£</li></ul></li></ul><h4 id="å˜é‡ä¸å¸¸é‡"><a href="#å˜é‡ä¸å¸¸é‡" class="headerlink" title="å˜é‡ä¸å¸¸é‡"></a>å˜é‡ä¸å¸¸é‡</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å˜é‡å£°æ˜</span></span><br><span class="line"><span class="keyword">var</span> name <span class="type">string</span>     <span class="comment">// å£°æ˜å˜é‡</span></span><br><span class="line">name = <span class="string">&quot;Go&quot;</span>         <span class="comment">// èµ‹å€¼</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> name = <span class="string">&quot;Go&quot;</span>     <span class="comment">// å£°æ˜å¹¶åˆå§‹åŒ–ï¼ˆç±»å‹æ¨æ–­ï¼‰</span></span><br><span class="line">name := <span class="string">&quot;Go&quot;</span>        <span class="comment">// çŸ­å˜é‡å£°æ˜ï¼ˆå‡½æ•°å†…éƒ¨ä½¿ç”¨ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¸¸é‡å£°æ˜</span></span><br><span class="line"><span class="keyword">const</span> Pi = <span class="number">3.14159</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    StatusOK = <span class="number">200</span></span><br><span class="line">    StatusNotFound = <span class="number">404</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><h4 id="æµç¨‹æ§åˆ¶"><a href="#æµç¨‹æ§åˆ¶" class="headerlink" title="æµç¨‹æ§åˆ¶"></a>æµç¨‹æ§åˆ¶</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¡ä»¶è¯­å¥</span></span><br><span class="line"><span class="keyword">if</span> x &gt; <span class="number">10</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> x &gt; <span class="number">5</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// switchè¯­å¥</span></span><br><span class="line"><span class="keyword">switch</span> status &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="number">200</span>:</span><br><span class="line">    fmt.Println(<span class="string">&quot;OK&quot;</span>)</span><br><span class="line"><span class="keyword">case</span> <span class="number">404</span>:</span><br><span class="line">    fmt.Println(<span class="string">&quot;Not Found&quot;</span>)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">    fmt.Println(<span class="string">&quot;Unknown&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¾ªç¯</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">    <span class="comment">// ä¼ ç»Ÿforå¾ªç¯</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i &lt; <span class="number">10</span> &#123;</span><br><span class="line">    <span class="comment">// whileé£æ ¼å¾ªç¯</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">    <span class="comment">// æ— é™å¾ªç¯</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// èŒƒå›´å¾ªç¯</span></span><br><span class="line"><span class="keyword">for</span> i, v := <span class="keyword">range</span> slice &#123;</span><br><span class="line">    <span class="comment">// éå†åˆ‡ç‰‡</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v := <span class="keyword">range</span> m &#123;</span><br><span class="line">    <span class="comment">// éå†æ˜ å°„</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-å‡½æ•°ä¸æ–¹æ³•"><a href="#3-å‡½æ•°ä¸æ–¹æ³•" class="headerlink" title="3. å‡½æ•°ä¸æ–¹æ³•"></a>3. å‡½æ•°ä¸æ–¹æ³•</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‡½æ•°å®šä¹‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(a, b <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤šè¿”å›å€¼</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">divide</span><span class="params">(a, b <span class="type">float64</span>)</span></span> (<span class="type">float64</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, fmt.Errorf(<span class="string">&quot;é™¤æ•°ä¸èƒ½ä¸º0&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> a / b, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–¹æ³•ï¼ˆå¸¦æ¥æ”¶è€…çš„å‡½æ•°ï¼‰</span></span><br><span class="line"><span class="keyword">type</span> Rectangle <span class="keyword">struct</span> &#123;</span><br><span class="line">    Width, Height <span class="type">float64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å€¼æ¥æ”¶è€…</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r Rectangle)</span></span> Area() <span class="type">float64</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> r.Width * r.Height</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŒ‡é’ˆæ¥æ”¶è€…ï¼ˆå¯ä¿®æ”¹æ¥æ”¶è€…ï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Rectangle)</span></span> Scale(factor <span class="type">float64</span>) &#123;</span><br><span class="line">    r.Width *= factor</span><br><span class="line">    r.Height *= factor</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-ç»“æ„ä½“ä¸æ¥å£"><a href="#4-ç»“æ„ä½“ä¸æ¥å£" class="headerlink" title="4. ç»“æ„ä½“ä¸æ¥å£"></a>4. ç»“æ„ä½“ä¸æ¥å£</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç»“æ„ä½“å®šä¹‰</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID        <span class="type">uint</span>      <span class="string">`json:&quot;id&quot;`</span></span><br><span class="line">    Username  <span class="type">string</span>    <span class="string">`json:&quot;username&quot;`</span></span><br><span class="line">    Email     <span class="type">string</span>    <span class="string">`json:&quot;email&quot;`</span></span><br><span class="line">    Password  <span class="type">string</span>    <span class="string">`json:&quot;-&quot;`</span> <span class="comment">// ä¸è¾“å‡ºåˆ°JSON</span></span><br><span class="line">    CreatedAt time.Time <span class="string">`json:&quot;created_at&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºå®ä¾‹</span></span><br><span class="line">user := User&#123;</span><br><span class="line">    Username: <span class="string">&quot;zhang&quot;</span>,</span><br><span class="line">    Email:    <span class="string">&quot;zhang@example.com&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¥å£å®šä¹‰</span></span><br><span class="line"><span class="keyword">type</span> UserRepository <span class="keyword">interface</span> &#123;</span><br><span class="line">    FindByID(id <span class="type">uint</span>) (*User, <span class="type">error</span>)</span><br><span class="line">    Create(user *User) <span class="type">error</span></span><br><span class="line">    Update(user *User) <span class="type">error</span></span><br><span class="line">    Delete(id <span class="type">uint</span>) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç°æ¥å£ï¼ˆéšå¼å®ç°ï¼‰</span></span><br><span class="line"><span class="keyword">type</span> MongoUserRepository <span class="keyword">struct</span> &#123;</span><br><span class="line">    db *mongodb.Database</span><br><span class="line">    collection *mongodb.Collection</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *MongoUserRepository)</span></span> FindByID(id <span class="type">uint</span>) (*User, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// å®ç°ä»£ç ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-å¹¶å‘ç¼–ç¨‹"><a href="#5-å¹¶å‘ç¼–ç¨‹" class="headerlink" title="5. å¹¶å‘ç¼–ç¨‹"></a>5. å¹¶å‘ç¼–ç¨‹</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Goroutine</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// åœ¨æ–°çš„goroutineä¸­æ‰§è¡Œ</span></span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šé“</span></span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)      <span class="comment">// æ— ç¼“å†²é€šé“</span></span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">10</span>)  <span class="comment">// å¸¦ç¼“å†²é€šé“</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘é€å’Œæ¥æ”¶</span></span><br><span class="line">ch &lt;- <span class="number">42</span>        <span class="comment">// å‘é€æ•°æ®</span></span><br><span class="line">value := &lt;-ch   <span class="comment">// æ¥æ”¶æ•°æ®</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Selectè¯­å¥</span></span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> msg := &lt;-ch1:</span><br><span class="line">    <span class="comment">// å¤„ç†ch1æ¥æ”¶çš„æ¶ˆæ¯</span></span><br><span class="line"><span class="keyword">case</span> ch2 &lt;- <span class="number">42</span>:</span><br><span class="line">    <span class="comment">// å‘ch2å‘é€æ•°æ®æˆåŠŸ</span></span><br><span class="line"><span class="keyword">case</span> &lt;-time.After(time.Second):</span><br><span class="line">    <span class="comment">// è¶…æ—¶å¤„ç†</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">    <span class="comment">// éé˜»å¡æ“ä½œ</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŒæ­¥å·¥å…·</span></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"><span class="keyword">var</span> mu sync.Mutex</span><br></pre></td></tr></table></figure><h4 id="å¤æ•°ç±»å‹è¯¦è§£"><a href="#å¤æ•°ç±»å‹è¯¦è§£" class="headerlink" title="å¤æ•°ç±»å‹è¯¦è§£"></a>å¤æ•°ç±»å‹è¯¦è§£</h4><p>å¤æ•°åœ¨Goä¸­æœ‰ä¸¤ç§ç±»å‹ï¼š<code>complex64</code>å’Œ<code>complex128</code>ï¼Œåˆ†åˆ«ç”±float32å’Œfloat64çš„å®éƒ¨å’Œè™šéƒ¨ç»„æˆã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å£°æ˜å¤æ•°</span></span><br><span class="line"><span class="keyword">var</span> c1 <span class="type">complex64</span> = <span class="number">1</span> + <span class="number">2i</span>      <span class="comment">// complex64ç±»å‹</span></span><br><span class="line"><span class="keyword">var</span> c2 <span class="type">complex128</span> = <span class="number">3.14</span> + <span class="number">5.6i</span> <span class="comment">// complex128ç±»å‹</span></span><br><span class="line">c3 := <span class="built_in">complex</span>(<span class="number">1.0</span>, <span class="number">2.0</span>)        <span class="comment">// ä½¿ç”¨complexå‡½æ•°åˆ›å»º</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å®éƒ¨å’Œè™šéƒ¨</span></span><br><span class="line">realPart := <span class="built_in">real</span>(c1)  <span class="comment">// è·å–å®éƒ¨ï¼š1.0</span></span><br><span class="line">imagPart := <span class="built_in">imag</span>(c1)  <span class="comment">// è·å–è™šéƒ¨ï¼š2.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤æ•°è¿ç®—</span></span><br><span class="line">sum := c1 + <span class="type">complex64</span>(c2)  <span class="comment">// å¤æ•°åŠ æ³•</span></span><br><span class="line">product := c1 * <span class="type">complex64</span>(c2)  <span class="comment">// å¤æ•°ä¹˜æ³•</span></span><br><span class="line">conjugate := <span class="built_in">complex</span>(<span class="built_in">real</span>(c1), -<span class="built_in">imag</span>(c1))  <span class="comment">// å¤æ•°å…±è½­</span></span><br></pre></td></tr></table></figure><p><strong>å¤æ•°ä½¿ç”¨åœºæ™¯</strong>:</p><ul><li>å‚…é‡Œå¶å˜æ¢å’Œé¢‘è°±åˆ†æ</li><li>ä¿¡å·å¤„ç†</li><li>ç”µæ°”å’Œç”µå­å·¥ç¨‹è®¡ç®—</li><li>å¹³é¢å‡ ä½•å’Œå‘é‡è®¡ç®—</li><li>é‡å­è®¡ç®—æ¨¡æ‹Ÿ</li></ul><p><strong>å¤æ•°æ ‡å‡†åº“</strong>:<br>Goæä¾›äº†<code>math/cmplx</code>åŒ…ç”¨äºå¤æ•°è®¡ç®—:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;math/cmplx&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¡ç®—å¤æ•°çš„ç»å¯¹å€¼</span></span><br><span class="line">abs := cmplx.Abs(<span class="number">2</span> + <span class="number">3i</span>)  <span class="comment">// ç»“æœ: 3.605551275463989</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¡ç®—å¤æ•°çš„ç›¸ä½è§’</span></span><br><span class="line">phase := cmplx.Phase(<span class="number">2</span> + <span class="number">2i</span>)  <span class="comment">// ç»“æœ: 0.7853981633974483 (Ï€/4)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¶ä»–å‡½æ•°</span></span><br><span class="line">sqrt := cmplx.Sqrt(<span class="number">-1</span>)  <span class="comment">// å¤æ•°å¹³æ–¹æ ¹: 0+1i</span></span><br><span class="line">exp := cmplx.Exp(<span class="number">1i</span> * math.Pi)  <span class="comment">// æ¬§æ‹‰å…¬å¼: -1+0i</span></span><br></pre></td></tr></table></figure><h3 id="é€šé“è¯¦è§£"><a href="#é€šé“è¯¦è§£" class="headerlink" title="é€šé“è¯¦è§£"></a>é€šé“è¯¦è§£</h3><p>é€šé“(Channel)æ˜¯Goè¯­è¨€çš„ä¸€ä¸ªæ ¸å¿ƒç‰¹æ€§ï¼Œç”¨äºgoroutineä¹‹é—´çš„é€šä¿¡å’ŒåŒæ­¥ã€‚</p><h4 id="é€šé“åŸºç¡€"><a href="#é€šé“åŸºç¡€" class="headerlink" title="é€šé“åŸºç¡€"></a>é€šé“åŸºç¡€</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºé€šé“</span></span><br><span class="line">unbuffered := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)        <span class="comment">// æ— ç¼“å†²é€šé“</span></span><br><span class="line">buffered := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>, <span class="number">10</span>)   <span class="comment">// æœ‰ç¼“å†²é€šé“ï¼Œå®¹é‡ä¸º10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘é€æ•°æ®åˆ°é€šé“ (ä¼šé˜»å¡ç›´åˆ°æœ‰äººæ¥æ”¶)</span></span><br><span class="line">unbuffered &lt;- <span class="number">42</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»é€šé“æ¥æ”¶æ•°æ® (ä¼šé˜»å¡ç›´åˆ°æœ‰æ•°æ®å¯æ¥æ”¶)</span></span><br><span class="line">value := &lt;-unbuffered</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…³é—­é€šé“ (é€šå¸¸ç”±å‘é€æ–¹å®Œæˆ)</span></span><br><span class="line"><span class="built_in">close</span>(buffered)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥é€šé“æ˜¯å¦å…³é—­</span></span><br><span class="line">val, ok := &lt;-buffered  <span class="comment">// okä¸ºfalseè¡¨ç¤ºé€šé“å·²å…³é—­</span></span><br></pre></td></tr></table></figure><h4 id="é€šé“ç±»å‹ä¸æ–¹å‘"><a href="#é€šé“ç±»å‹ä¸æ–¹å‘" class="headerlink" title="é€šé“ç±»å‹ä¸æ–¹å‘"></a>é€šé“ç±»å‹ä¸æ–¹å‘</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŒå‘é€šé“ (å¯å‘é€ä¹Ÿå¯æ¥æ”¶)</span></span><br><span class="line"><span class="keyword">chan</span> T</span><br><span class="line"></span><br><span class="line"><span class="comment">// åªè¯»é€šé“ (åªèƒ½æ¥æ”¶)</span></span><br><span class="line">&lt;-<span class="keyword">chan</span> T</span><br><span class="line"></span><br><span class="line"><span class="comment">// åªå†™é€šé“ (åªèƒ½å‘é€)</span></span><br><span class="line"><span class="keyword">chan</span>&lt;- T</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç±»å‹è½¬æ¢ç¤ºä¾‹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(in &lt;-<span class="keyword">chan</span> <span class="type">int</span>, out <span class="keyword">chan</span>&lt;- <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// workeråªèƒ½ä»inæ¥æ”¶æ•°æ®ï¼Œå‘outå‘é€æ•°æ®</span></span><br><span class="line">    val := &lt;-in</span><br><span class="line">    out &lt;- val * <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç¼“å†²ä¸éç¼“å†²é€šé“"><a href="#ç¼“å†²ä¸éç¼“å†²é€šé“" class="headerlink" title="ç¼“å†²ä¸éç¼“å†²é€šé“"></a>ç¼“å†²ä¸éç¼“å†²é€šé“</h4><p><strong>æ— ç¼“å†²é€šé“</strong>:</p><ul><li>å‘é€æ“ä½œä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰æ¥æ”¶æ–¹å‡†å¤‡å¥½æ¥æ”¶</li><li>æ¥æ”¶æ“ä½œä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰å‘é€æ–¹å‘é€æ•°æ®</li><li>æä¾›äº†åŒæ­¥ä¿è¯ - å‘é€æ–¹çŸ¥é“æ¥æ”¶æ–¹å·²ç»æ¥æ”¶äº†æ•°æ®</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)  <span class="comment">// æ— ç¼“å†²é€šé“</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™ä¼šå¯¼è‡´æ­»é”ï¼Œå› ä¸ºæ²¡æœ‰goroutineèƒ½æ¥æ”¶</span></span><br><span class="line">ch &lt;- <span class="number">1</span>  <span class="comment">// é˜»å¡åœ¨è¿™é‡Œ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£ç¡®ä½¿ç”¨éœ€è¦å¦ä¸€ä¸ªgoroutineæ¥æ”¶</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(&lt;-ch)  <span class="comment">// æ¥æ”¶æ•°æ®</span></span><br><span class="line">&#125;()</span><br><span class="line">ch &lt;- <span class="number">1</span>  <span class="comment">// å‘é€æ•°æ®åç»§ç»­æ‰§è¡Œ</span></span><br></pre></td></tr></table></figure><p><strong>æœ‰ç¼“å†²é€šé“</strong>:</p><ul><li>å‘é€æ“ä½œåªåœ¨ç¼“å†²åŒºæ»¡æ—¶é˜»å¡</li><li>æ¥æ”¶æ“ä½œåªåœ¨ç¼“å†²åŒºç©ºæ—¶é˜»å¡</li><li>å¯ä»¥ç”¨äºè§£è€¦ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">3</span>)  <span class="comment">// å®¹é‡ä¸º3çš„ç¼“å†²é€šé“</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸ä¼šé˜»å¡ï¼Œå› ä¸ºé€šé“æœ‰è¶³å¤Ÿç¼“å†²ç©ºé—´</span></span><br><span class="line">ch &lt;- <span class="number">1</span></span><br><span class="line">ch &lt;- <span class="number">2</span></span><br><span class="line">ch &lt;- <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬å››ä¸ªå‘é€ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰ç©ºé—´</span></span><br><span class="line"><span class="comment">// ch &lt;- 4  // å¦‚æœæ²¡æœ‰äººæ¥æ”¶ï¼Œè¿™é‡Œä¼šå¯¼è‡´æ­»é”</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¥æ”¶å€¼å¹¶é‡Šæ”¾ç¼“å†²ç©ºé—´</span></span><br><span class="line">fmt.Println(&lt;-ch)  <span class="comment">// è¾“å‡º: 1</span></span><br><span class="line">fmt.Println(&lt;-ch)  <span class="comment">// è¾“å‡º: 2</span></span><br></pre></td></tr></table></figure><h4 id="Selectè¯­å¥è¯¦è§£"><a href="#Selectè¯­å¥è¯¦è§£" class="headerlink" title="Selectè¯­å¥è¯¦è§£"></a>Selectè¯­å¥è¯¦è§£</h4><p><code>select</code>è¯­å¥æ˜¯Goä¸­ç”¨äºå¤šé€šé“æ“ä½œçš„å…³é”®ç»“æ„:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> v1 := &lt;-ch1:</span><br><span class="line">    <span class="comment">// ä»ch1æ¥æ”¶åˆ°æ•°æ®</span></span><br><span class="line"><span class="keyword">case</span> ch2 &lt;- v2:</span><br><span class="line">    <span class="comment">// æˆåŠŸå‘ch2å‘é€æ•°æ®</span></span><br><span class="line"><span class="keyword">case</span> &lt;-time.After(<span class="number">1</span> * time.Second):</span><br><span class="line">    <span class="comment">// è¶…æ—¶å¤„ç†</span></span><br><span class="line"><span class="keyword">case</span> &lt;-done:</span><br><span class="line">    <span class="comment">// å®Œæˆä¿¡å·ï¼Œé€šå¸¸ç”¨äºå–æ¶ˆ</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">    <span class="comment">// å¦‚æœæ‰€æœ‰é€šé“éƒ½é˜»å¡ï¼Œæ‰§è¡Œè¿™é‡Œ(éé˜»å¡æ“ä½œ)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>selectç‰¹æ€§</strong>:</p><ul><li>å¦‚æœå¤šä¸ªcaseåŒæ—¶å°±ç»ªï¼Œéšæœºé€‰æ‹©ä¸€ä¸ªæ‰§è¡Œ</li><li>æ²¡æœ‰caseå°±ç»ªä¸”æ— defaultæ—¶ï¼Œselectä¼šé˜»å¡</li><li>defaultä½¿selectå˜æˆéé˜»å¡æ“ä½œ</li></ul><h4 id="é€šé“çš„å¸¸è§ä½¿ç”¨æ¨¡å¼"><a href="#é€šé“çš„å¸¸è§ä½¿ç”¨æ¨¡å¼" class="headerlink" title="é€šé“çš„å¸¸è§ä½¿ç”¨æ¨¡å¼"></a>é€šé“çš„å¸¸è§ä½¿ç”¨æ¨¡å¼</h4><p><strong>å·¥ä½œæ± æ¨¡å¼</strong>:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(id <span class="type">int</span>, jobs &lt;-<span class="keyword">chan</span> <span class="type">int</span>, results <span class="keyword">chan</span>&lt;- <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> j := <span class="keyword">range</span> jobs &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;worker %d processing job %d\n&quot;</span>, id, j)</span><br><span class="line">        results &lt;- j * <span class="number">2</span>  <span class="comment">// æ‰§è¡Œå·¥ä½œå¹¶å‘é€ç»“æœ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    jobs := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">100</span>)</span><br><span class="line">    results := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯åŠ¨3ä¸ªworker</span></span><br><span class="line">    <span class="keyword">for</span> w := <span class="number">1</span>; w &lt;= <span class="number">3</span>; w++ &#123;</span><br><span class="line">        <span class="keyword">go</span> worker(w, jobs, results)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘é€å·¥ä½œ</span></span><br><span class="line">    <span class="keyword">for</span> j := <span class="number">1</span>; j &lt;= <span class="number">9</span>; j++ &#123;</span><br><span class="line">        jobs &lt;- j</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(jobs)  <span class="comment">// å…³é—­é€šé“è¡¨ç¤ºæ²¡æœ‰æ›´å¤šå·¥ä½œ</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ”¶é›†ç»“æœ</span></span><br><span class="line">    <span class="keyword">for</span> a := <span class="number">1</span>; a &lt;= <span class="number">9</span>; a++ &#123;</span><br><span class="line">        &lt;-results</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¶…æ—¶æ§åˆ¶</strong>:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> res := &lt;-c:</span><br><span class="line">    fmt.Println(<span class="string">&quot;æ¥æ”¶åˆ°ç»“æœ:&quot;</span>, res)</span><br><span class="line"><span class="keyword">case</span> &lt;-time.After(<span class="number">1</span> * time.Second):</span><br><span class="line">    fmt.Println(<span class="string">&quot;æ“ä½œè¶…æ—¶&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å–æ¶ˆå’Œç»ˆæ­¢</strong>:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">            <span class="comment">// æ¥æ”¶åˆ°å–æ¶ˆä¿¡å·</span></span><br><span class="line">            fmt.Println(<span class="string">&quot;å·¥ä½œå–æ¶ˆ&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// ç»§ç»­å·¥ä½œ</span></span><br><span class="line">            fmt.Println(<span class="string">&quot;å·¥ä½œä¸­...&quot;</span>)</span><br><span class="line">            time.Sleep(<span class="number">100</span> * time.Millisecond)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ctx, cancel := context.WithTimeout(context.Background(), <span class="number">1</span>*time.Second)</span><br><span class="line">    <span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> worker(ctx)</span><br><span class="line">    time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é™é€Ÿå™¨</strong>:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªé™åˆ¶æ¯ç§’å¤„ç†5ä¸ªè¯·æ±‚çš„é™é€Ÿå™¨</span></span><br><span class="line">limiter := time.Tick(<span class="number">200</span> * time.Millisecond)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤„ç†è¯·æ±‚</span></span><br><span class="line"><span class="keyword">for</span> req := <span class="keyword">range</span> requests &#123;</span><br><span class="line">    &lt;-limiter  <span class="comment">// ç­‰å¾…ä¸‹ä¸€ä¸ªä»¤ç‰Œ</span></span><br><span class="line">    <span class="keyword">go</span> process(req)  <span class="comment">// å¤„ç†è¯·æ±‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="é€šé“å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ"><a href="#é€šé“å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ" class="headerlink" title="é€šé“å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ"></a>é€šé“å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ</h4><ol><li><p><strong>ä»å…³é—­çš„é€šé“æ¥æ”¶æ•°æ®</strong>:</p><ul><li>ä»å·²å…³é—­çš„é€šé“æ¥æ”¶ä¼šç«‹å³è¿”å›é€šé“å…ƒç´ ç±»å‹çš„é›¶å€¼</li><li>åº”ä½¿ç”¨<code>val, ok := &lt;-ch</code>å½¢å¼æ£€æŸ¥é€šé“çŠ¶æ€</li></ul></li><li><p><strong>å‘å…³é—­çš„é€šé“å‘é€æ•°æ®</strong>:</p><ul><li>ä¼šå¯¼è‡´panic</li><li>ç¡®ä¿åªæœ‰å‘é€æ–¹å…³é—­é€šé“ï¼Œæ¥æ”¶æ–¹ä¸åº”å…³é—­</li></ul></li><li><p><strong>é‡å¤å…³é—­é€šé“</strong>:</p><ul><li>ä¼šå¯¼è‡´panic</li><li>ä½¿ç”¨<code>sync.Once</code>ç¡®ä¿åªå…³é—­ä¸€æ¬¡ï¼Œæˆ–ä½¿ç”¨ä¸“é—¨çš„ç»ˆæ­¢é€šé“</li></ul></li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨sync.Onceå®‰å…¨å…³é—­é€šé“</span></span><br><span class="line"><span class="keyword">var</span> once sync.Once</span><br><span class="line"><span class="built_in">close</span> := <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">close</span>(ch)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="5"><li><strong>æ³„æ¼çš„goroutine</strong>:<ul><li>å½“goroutineåœ¨é€šé“ä¸Šæ°¸ä¹…é˜»å¡æ—¶å‘ç”Ÿ</li><li>æ€»æ˜¯ç¡®ä¿æœ‰ç»ˆæ­¢æ¡ä»¶ï¼Œæˆ–ä½¿ç”¨contextåŒ…ç®¡ç†ç”Ÿå‘½å‘¨æœŸ</li></ul></li></ol><h3 id="7-Contextä¸Šä¸‹æ–‡"><a href="#7-Contextä¸Šä¸‹æ–‡" class="headerlink" title="7. Contextä¸Šä¸‹æ–‡"></a>7. Contextä¸Šä¸‹æ–‡</h3><p>Contextæ˜¯Goè¯­è¨€ä¸­ç”¨äºè·¨APIè¾¹ç•Œå’Œè¿›ç¨‹é—´ä¼ é€’æˆªæ­¢æ—¶é—´ã€å–æ¶ˆä¿¡å·å’Œå…¶ä»–è¯·æ±‚èŒƒå›´å€¼çš„æ ‡å‡†æ–¹å¼ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºContext</span></span><br><span class="line">ctx := context.Background()  <span class="comment">// ç©ºContextï¼Œä¸ä¼šè¢«å–æ¶ˆ</span></span><br><span class="line">ctx := context.TODO()        <span class="comment">// ä¸´æ—¶Contextï¼Œè¡¨ç¤ºä¸ç¡®å®šä½¿ç”¨å“ªç§Context</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºå¸¦æœ‰æˆªæ­¢æ—¶é—´çš„Context</span></span><br><span class="line">deadline := time.Now().Add(<span class="number">5</span> * time.Second)</span><br><span class="line">ctx, cancel := context.WithDeadline(parentCtx, deadline)</span><br><span class="line"><span class="keyword">defer</span> cancel()  <span class="comment">// å³ä½¿æˆªæ­¢æ—¶é—´åˆ°äº†ï¼Œä¹Ÿæœ€å¥½è°ƒç”¨cancel</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºå¸¦æœ‰è¶…æ—¶çš„Context</span></span><br><span class="line">ctx, cancel := context.WithTimeout(parentCtx, <span class="number">5</span> * time.Second)</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºå¯å–æ¶ˆçš„Context</span></span><br><span class="line">ctx, cancel := context.WithCancel(parentCtx)</span><br><span class="line"><span class="comment">// åœ¨æŸä¸ªæ¡ä»¶ä¸‹å–æ¶ˆ</span></span><br><span class="line"><span class="keyword">if</span> shouldCancel &#123;</span><br><span class="line">    cancel()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºå¸¦å€¼çš„Context</span></span><br><span class="line">ctx = context.WithValue(parentCtx, <span class="string">&quot;userID&quot;</span>, <span class="string">&quot;12345&quot;</span>)</span><br><span class="line"><span class="comment">// è·å–Contextä¸­çš„å€¼</span></span><br><span class="line"><span class="keyword">if</span> userID, ok := ctx.Value(<span class="string">&quot;userID&quot;</span>).(<span class="type">string</span>); ok &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨userID</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Contextä½¿ç”¨è§„åˆ™</strong>:</p><ol><li>ä¸è¦å°†Contextå­˜å‚¨åœ¨ç»“æ„ä½“ä¸­ï¼Œè€Œæ˜¯æ˜¾å¼ä¼ é€’ç»™æ¯ä¸ªéœ€è¦å®ƒçš„å‡½æ•°</li><li>ä¸è¦ä¼ é€’nil Contextï¼Œå¦‚æœä¸ç¡®å®šä½¿ç”¨å“ªä¸ªContextï¼Œä½¿ç”¨context.TODO()</li><li>Contextåº”è¯¥æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œé€šå¸¸å‘½åä¸ºctx</li><li>ä¸è¦å¯¹åŒä¸€ä¸ªContextå¤šæ¬¡è°ƒç”¨cancelå‡½æ•°</li><li>Contextå€¼åº”è¯¥æ˜¯è¯·æ±‚èŒƒå›´çš„æ•°æ®ï¼Œä¸è¦ç”¨äºä¼ é€’å¯é€‰å‚æ•°</li></ol><p><strong>å®é™…åº”ç”¨ç¤ºä¾‹</strong>:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleRequest</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">    <span class="comment">// ä»è¯·æ±‚åˆ›å»ºContext</span></span><br><span class="line">    ctx := r.Context()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ è¶…æ—¶</span></span><br><span class="line">    ctx, cancel := context.WithTimeout(ctx, <span class="number">2</span>*time.Second)</span><br><span class="line">    <span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨éœ€è¦Contextçš„å‡½æ•°</span></span><br><span class="line">    result, err := doSomethingSlowly(ctx)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        http.Error(w, err.Error(), http.StatusInternalServerError)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›ç»“æœ</span></span><br><span class="line">    fmt.Fprintf(w, <span class="string">&quot;Result: %s&quot;</span>, result)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doSomethingSlowly</span><span class="params">(ctx context.Context)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºç»“æœé€šé“</span></span><br><span class="line">    resultCh := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨goroutineä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">        time.Sleep(<span class="number">3</span> * time.Second)</span><br><span class="line">        resultCh &lt;- <span class="string">&quot;æ“ä½œå®Œæˆ&quot;</span></span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨selectç›‘å¬å¤šä¸ªé€šé“</span></span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> result := &lt;-resultCh:</span><br><span class="line">        <span class="keyword">return</span> result, <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, ctx.Err() <span class="comment">// å¯èƒ½æ˜¯DeadlineExceededæˆ–Canceled</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Contextåœ¨ä¸­é—´ä»¶ä¸­çš„åº”ç”¨</strong>:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loggingMiddleware</span><span class="params">(next http.Handler)</span></span> http.Handler &#123;</span><br><span class="line">    <span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">        <span class="comment">// ä»è¯·æ±‚åˆ›å»ºContext</span></span><br><span class="line">        ctx := r.Context()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ·»åŠ è¯·æ±‚IDåˆ°Context</span></span><br><span class="line">        requestID := uuid.New().String()</span><br><span class="line">        ctx = context.WithValue(ctx, <span class="string">&quot;requestID&quot;</span>, requestID)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ–°Contextåˆ›å»ºæ–°è¯·æ±‚</span></span><br><span class="line">        r = r.WithContext(ctx)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®°å½•è¯·æ±‚å¼€å§‹</span></span><br><span class="line">        log.Printf(<span class="string">&quot;Request %s started&quot;</span>, requestID)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è°ƒç”¨ä¸‹ä¸€ä¸ªå¤„ç†å™¨</span></span><br><span class="line">        next.ServeHTTP(w, r)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®°å½•è¯·æ±‚ç»“æŸ</span></span><br><span class="line">        log.Printf(<span class="string">&quot;Request %s completed&quot;</span>, requestID)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨Contextä¼ é€’æ•°æ®åº“äº‹åŠ¡</strong>:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Contexté”®ç±»å‹</span></span><br><span class="line"><span class="keyword">type</span> txKey <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†äº‹åŠ¡æ”¾å…¥Context</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithTx</span><span class="params">(ctx context.Context, tx *sql.Tx)</span></span> context.Context &#123;</span><br><span class="line">    <span class="keyword">return</span> context.WithValue(ctx, txKey&#123;&#125;, tx)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»Contextè·å–äº‹åŠ¡</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetTx</span><span class="params">(ctx context.Context)</span></span> (*sql.Tx, <span class="type">bool</span>) &#123;</span><br><span class="line">    tx, ok := ctx.Value(txKey&#123;&#125;).(*sql.Tx)</span><br><span class="line">    <span class="keyword">return</span> tx, ok</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateUser</span><span class="params">(ctx context.Context, user User)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    tx, ok := GetTx(ctx)</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ›å»ºæ–°äº‹åŠ¡</span></span><br><span class="line">        <span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">        tx, err = db.BeginTx(ctx, <span class="literal">nil</span>)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">defer</span> tx.Rollback()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰§è¡Œåˆ›å»ºç”¨æˆ·</span></span><br><span class="line">        <span class="keyword">if</span> err := insertUser(ctx, tx, user); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> tx.Commit()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨ç°æœ‰äº‹åŠ¡ä¸­æ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">return</span> insertUser(ctx, tx, user)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="äºŒã€é¡¹ç›®æ¶æ„ä¸è®¾è®¡æ¨¡å¼"><a href="#äºŒã€é¡¹ç›®æ¶æ„ä¸è®¾è®¡æ¨¡å¼" class="headerlink" title="äºŒã€é¡¹ç›®æ¶æ„ä¸è®¾è®¡æ¨¡å¼"></a>äºŒã€é¡¹ç›®æ¶æ„ä¸è®¾è®¡æ¨¡å¼</h2><h3 id="1-åˆ†å±‚æ¶æ„"><a href="#1-åˆ†å±‚æ¶æ„" class="headerlink" title="1. åˆ†å±‚æ¶æ„"></a>1. åˆ†å±‚æ¶æ„</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">go-app/</span><br><span class="line">â”œâ”€â”€ config/                # é…ç½®ç›¸å…³</span><br><span class="line">â”‚   â””â”€â”€ config.go          # åº”ç”¨é…ç½®</span><br><span class="line">â”œâ”€â”€ controller/            # æ§åˆ¶å™¨å±‚ï¼ˆå¤„ç†HTTPè¯·æ±‚ï¼‰</span><br><span class="line">â”‚   â””â”€â”€ user_controller.go</span><br><span class="line">â”œâ”€â”€ service/               # æœåŠ¡å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰</span><br><span class="line">â”‚   â””â”€â”€ user_service.go</span><br><span class="line">â”œâ”€â”€ database/              # æ•°æ®åº“ç›¸å…³</span><br><span class="line">â”‚   â”œâ”€â”€ database.go        # æ•°æ®åº“åˆå§‹åŒ–</span><br><span class="line">â”‚   â””â”€â”€ repositories/      # æ•°æ®è®¿é—®å±‚</span><br><span class="line">â”‚       â”œâ”€â”€ repository.go  # é€šç”¨æ¥å£</span><br><span class="line">â”‚       â””â”€â”€ mongo_repository.go</span><br><span class="line">â”œâ”€â”€ middleware/            # HTTPä¸­é—´ä»¶</span><br><span class="line">â”‚   â”œâ”€â”€ logger.go          # æ—¥å¿—ä¸­é—´ä»¶</span><br><span class="line">â”‚   â””â”€â”€ auth.go            # è®¤è¯ä¸­é—´ä»¶</span><br><span class="line">â”œâ”€â”€ models/                # æ•°æ®æ¨¡å‹</span><br><span class="line">â”‚   â””â”€â”€ user.go</span><br><span class="line">â”œâ”€â”€ utils/                 # å·¥å…·å‡½æ•°</span><br><span class="line">â”‚   â””â”€â”€ logger.go          # æ—¥å¿—å·¥å…·</span><br><span class="line">â”œâ”€â”€ router/                # è·¯ç”±è®¾ç½®</span><br><span class="line">â”‚   â””â”€â”€ router.go</span><br><span class="line">â”œâ”€â”€ main.go                # ç¨‹åºå…¥å£</span><br><span class="line">â””â”€â”€ go.mod                 # ä¾èµ–ç®¡ç†</span><br></pre></td></tr></table></figure><h3 id="2-ä»“å‚¨æ¨¡å¼ï¼ˆRepository-Patternï¼‰"><a href="#2-ä»“å‚¨æ¨¡å¼ï¼ˆRepository-Patternï¼‰" class="headerlink" title="2. ä»“å‚¨æ¨¡å¼ï¼ˆRepository Patternï¼‰"></a>2. ä»“å‚¨æ¨¡å¼ï¼ˆRepository Patternï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é€šç”¨ä»“å‚¨æ¥å£</span></span><br><span class="line"><span class="keyword">type</span> Repository <span class="keyword">interface</span> &#123;</span><br><span class="line">    FindByID(id <span class="type">string</span>) (bson.M, <span class="type">error</span>)</span><br><span class="line">    FindAll(filter bson.M, skip, limit <span class="type">int64</span>, sort bson.D) ([]bson.M, <span class="type">int64</span>, <span class="type">error</span>)</span><br><span class="line">    Create(document <span class="keyword">interface</span>&#123;&#125;) (<span class="type">string</span>, <span class="type">error</span>)</span><br><span class="line">    Update(id <span class="type">string</span>, update bson.M) <span class="type">error</span></span><br><span class="line">    Delete(id <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MongoDBå®ç°</span></span><br><span class="line"><span class="keyword">type</span> MongoRepository <span class="keyword">struct</span> &#123;</span><br><span class="line">    db         *mongodb.Database</span><br><span class="line">    collection *mongodb.Collection</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºMongoDBå­˜å‚¨åº“</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMongoRepository</span><span class="params">(db *mongodb.Database, collectionName <span class="type">string</span>)</span></span> *MongoRepository &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;MongoRepository&#123;</span><br><span class="line">        db:         db,</span><br><span class="line">        collection: db.Collection(collectionName),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç°æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *MongoRepository)</span></span> FindByID(id <span class="type">string</span>) (bson.M, <span class="type">error</span>) &#123;</span><br><span class="line">    ctx, cancel := context.WithTimeout(context.Background(), <span class="number">10</span>*time.Second)</span><br><span class="line">    <span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">    objID, err := primitive.ObjectIDFromHex(id)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;æ— æ•ˆçš„IDæ ¼å¼: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> result bson.M</span><br><span class="line">    err = r.collection.FindOne(ctx, bson.M&#123;<span class="string">&quot;_id&quot;</span>: objID&#125;).Decode(&amp;result)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> err == mongodb.ErrNoDocuments &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;æ–‡æ¡£ä¸å­˜åœ¨&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-æœåŠ¡å±‚ï¼ˆService-Layerï¼‰"><a href="#3-æœåŠ¡å±‚ï¼ˆService-Layerï¼‰" class="headerlink" title="3. æœåŠ¡å±‚ï¼ˆService Layerï¼‰"></a>3. æœåŠ¡å±‚ï¼ˆService Layerï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”¨æˆ·æœåŠ¡æ¥å£</span></span><br><span class="line"><span class="keyword">type</span> UserService <span class="keyword">interface</span> &#123;</span><br><span class="line">    GetUserByID(id <span class="type">string</span>) (*User, <span class="type">error</span>)</span><br><span class="line">    CreateUser(user *User) (<span class="type">string</span>, <span class="type">error</span>)</span><br><span class="line">    UpdateUser(id <span class="type">string</span>, user *User) <span class="type">error</span></span><br><span class="line">    DeleteUser(id <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨æˆ·æœåŠ¡å®ç°</span></span><br><span class="line"><span class="keyword">type</span> UserServiceImpl <span class="keyword">struct</span> &#123;</span><br><span class="line">    repo Repository</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºç”¨æˆ·æœåŠ¡</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewUserService</span><span class="params">(repo Repository)</span></span> UserService &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;UserServiceImpl&#123;repo: repo&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç°æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *UserServiceImpl)</span></span> GetUserByID(id <span class="type">string</span>) (*User, <span class="type">error</span>) &#123;</span><br><span class="line">    doc, err := s.repo.FindByID(id)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è½¬æ¢ä¸ºç”¨æˆ·å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">var</span> user User</span><br><span class="line">    <span class="comment">// ...å¤„ç†è½¬æ¢é€»è¾‘</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &amp;user, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-é…ç½®ç®¡ç†"><a href="#4-é…ç½®ç®¡ç†" class="headerlink" title="4. é…ç½®ç®¡ç†"></a>4. é…ç½®ç®¡ç†</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config/config.go</span></span><br><span class="line"><span class="keyword">package</span> config</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/spf13/viper&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// é…ç½®ç»“æ„ä½“</span></span><br><span class="line"><span class="keyword">type</span> Config <span class="keyword">struct</span> &#123;</span><br><span class="line">    Server <span class="keyword">struct</span> &#123;</span><br><span class="line">        Port         <span class="type">string</span>        <span class="string">`mapstructure:&quot;SERVER_PORT&quot;`</span></span><br><span class="line">        Mode         <span class="type">string</span>        <span class="string">`mapstructure:&quot;SERVER_MODE&quot;`</span></span><br><span class="line">        ReadTimeout  time.Duration <span class="string">`mapstructure:&quot;SERVER_READ_TIMEOUT&quot;`</span></span><br><span class="line">        WriteTimeout time.Duration <span class="string">`mapstructure:&quot;SERVER_WRITE_TIMEOUT&quot;`</span></span><br><span class="line">        IdleTimeout  time.Duration <span class="string">`mapstructure:&quot;SERVER_IDLE_TIMEOUT&quot;`</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Database <span class="keyword">struct</span> &#123;</span><br><span class="line">        <span class="comment">// MySQLé…ç½®...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MongoDB <span class="keyword">struct</span> &#123;</span><br><span class="line">        URI      <span class="type">string</span> <span class="string">`mapstructure:&quot;MONGODB_URI&quot;`</span></span><br><span class="line">        Database <span class="type">string</span> <span class="string">`mapstructure:&quot;MONGODB_DATABASE&quot;`</span></span><br><span class="line">        Username <span class="type">string</span> <span class="string">`mapstructure:&quot;MONGODB_USERNAME&quot;`</span></span><br><span class="line">        Password <span class="type">string</span> <span class="string">`mapstructure:&quot;MONGODB_PASSWORD&quot;`</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    JWT <span class="keyword">struct</span> &#123;</span><br><span class="line">        Secret <span class="type">string</span>        <span class="string">`mapstructure:&quot;JWT_SECRET&quot;`</span></span><br><span class="line">        Expire time.Duration <span class="string">`mapstructure:&quot;JWT_EXPIRE&quot;`</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Logger <span class="keyword">struct</span> &#123;</span><br><span class="line">        Dir          <span class="type">string</span> <span class="string">`mapstructure:&quot;LOGGER_DIR&quot;`</span></span><br><span class="line">        FileName     <span class="type">string</span> <span class="string">`mapstructure:&quot;LOGGER_FILENAME&quot;`</span></span><br><span class="line">        MaxSize      <span class="type">int</span>    <span class="string">`mapstructure:&quot;LOGGER_MAX_SIZE&quot;`</span></span><br><span class="line">        MaxBackups   <span class="type">int</span>    <span class="string">`mapstructure:&quot;LOGGER_MAX_BACKUPS&quot;`</span></span><br><span class="line">        MaxAge       <span class="type">int</span>    <span class="string">`mapstructure:&quot;LOGGER_MAX_AGE&quot;`</span></span><br><span class="line">        Compress     <span class="type">bool</span>   <span class="string">`mapstructure:&quot;LOGGER_COMPRESS&quot;`</span></span><br><span class="line">        ConsoleOutput <span class="type">bool</span>  <span class="string">`mapstructure:&quot;LOGGER_CONSOLE_OUTPUT&quot;`</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŠ è½½é…ç½®</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LoadConfig</span><span class="params">()</span></span> *Config &#123;</span><br><span class="line">    <span class="comment">// è·å–ç¯å¢ƒå˜é‡</span></span><br><span class="line">    env := os.Getenv(<span class="string">&quot;APP_ENV&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> env == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        env = <span class="string">&quot;test&quot;</span> <span class="comment">// é»˜è®¤æµ‹è¯•ç¯å¢ƒ</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®é…ç½®æ–‡ä»¶</span></span><br><span class="line">    viper.SetConfigName(<span class="string">&quot;.env.&quot;</span> + env)</span><br><span class="line">    viper.SetConfigType(<span class="string">&quot;env&quot;</span>)</span><br><span class="line">    viper.AddConfigPath(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">    viper.AutomaticEnv()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–é…ç½®æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> err := viper.ReadInConfig(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;æ— æ³•è¯»å–é…ç½®æ–‡ä»¶: &quot;</span> + err.Error())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æé…ç½®</span></span><br><span class="line">    <span class="keyword">var</span> config Config</span><br><span class="line">    <span class="keyword">if</span> err := viper.Unmarshal(&amp;config); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;æ— æ³•è§£æé…ç½®æ–‡ä»¶: &quot;</span> + err.Error())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &amp;config</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-ä¸­é—´ä»¶è®¾è®¡"><a href="#5-ä¸­é—´ä»¶è®¾è®¡" class="headerlink" title="5. ä¸­é—´ä»¶è®¾è®¡"></a>5. ä¸­é—´ä»¶è®¾è®¡</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// middleware/logger.go</span></span><br><span class="line"><span class="keyword">package</span> middleware</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;go-app/utils&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">    <span class="string">&quot;go.uber.org/zap&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ—¥å¿—ä¸­é—´ä»¶</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Logger</span><span class="params">()</span></span> gin.HandlerFunc &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        <span class="comment">// å¼€å§‹æ—¶é—´</span></span><br><span class="line">        start := time.Now()</span><br><span class="line">        path := c.Request.URL.Path</span><br><span class="line">        query := c.Request.URL.RawQuery</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¤„ç†è¯·æ±‚</span></span><br><span class="line">        c.Next()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç»“æŸæ—¶é—´</span></span><br><span class="line">        end := time.Now()</span><br><span class="line">        latency := end.Sub(start)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–çŠ¶æ€</span></span><br><span class="line">        status := c.Writer.Status()</span><br><span class="line">        clientIP := c.ClientIP()</span><br><span class="line">        method := c.Request.Method</span><br><span class="line">        userAgent := c.Request.UserAgent()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„å»ºæ—¥å¿—å­—æ®µ</span></span><br><span class="line">        fields := []zap.Field&#123;</span><br><span class="line">            zap.Int(<span class="string">&quot;status&quot;</span>, status),</span><br><span class="line">            zap.String(<span class="string">&quot;method&quot;</span>, method),</span><br><span class="line">            zap.String(<span class="string">&quot;path&quot;</span>, path),</span><br><span class="line">            zap.String(<span class="string">&quot;query&quot;</span>, query),</span><br><span class="line">            zap.String(<span class="string">&quot;ip&quot;</span>, clientIP),</span><br><span class="line">            zap.String(<span class="string">&quot;user-agent&quot;</span>, userAgent),</span><br><span class="line">            zap.Duration(<span class="string">&quot;latency&quot;</span>, latency),</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ ¹æ®çŠ¶æ€ç è®°å½•ä¸åŒçº§åˆ«çš„æ—¥å¿—</span></span><br><span class="line">        msg := fmt.Sprintf(<span class="string">&quot;[GIN] %d %s %s&quot;</span>, status, method, path)</span><br><span class="line">        <span class="keyword">if</span> status &gt;= <span class="number">500</span> &#123;</span><br><span class="line">            utils.Error(msg, fields...)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> status &gt;= <span class="number">400</span> &#123;</span><br><span class="line">            utils.Warn(msg, fields...)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            utils.Info(msg, fields...)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// middleware/middleware.go</span></span><br><span class="line"><span class="keyword">package</span> middleware</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;go-app/config&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®æ‰€æœ‰ä¸­é—´ä»¶</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetupMiddlewares</span><span class="params">(r *gin.Engine, cfg *config.Config)</span></span> &#123;</span><br><span class="line">    <span class="comment">// æ—¥å¿—ä¸­é—´ä»¶ï¼ˆæ”¾åœ¨æœ€å‰é¢ï¼Œè®°å½•æ‰€æœ‰è¯·æ±‚ï¼‰</span></span><br><span class="line">    r.Use(Logger())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…¨å±€é”™è¯¯å¤„ç†ä¸­é—´ä»¶</span></span><br><span class="line">    r.Use(ErrorHandler())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·¨åŸŸä¸­é—´ä»¶</span></span><br><span class="line">    r.Use(Cors())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­¾åéªŒè¯ä¸­é—´ä»¶</span></span><br><span class="line">    r.Use(Signature(&amp;SignatureConfig&#123;</span><br><span class="line">        AppKey:    cfg.Signature.AppKey,</span><br><span class="line">        AppSecret: cfg.Signature.AppSecret,</span><br><span class="line">        Expire:    cfg.Signature.Expire,</span><br><span class="line">    &#125;))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-æ—¥å¿—å·¥å…·"><a href="#6-æ—¥å¿—å·¥å…·" class="headerlink" title="6. æ—¥å¿—å·¥å…·"></a>6. æ—¥å¿—å·¥å…·</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utils/logger.go</span></span><br><span class="line"><span class="keyword">package</span> utils</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;path/filepath&quot;</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;go.uber.org/zap&quot;</span></span><br><span class="line">    <span class="string">&quot;go.uber.org/zap/zapcore&quot;</span></span><br><span class="line">    <span class="string">&quot;gopkg.in/natefinch/lumberjack.v2&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    logger      *zap.Logger</span><br><span class="line">    sugarLogger *zap.SugaredLogger</span><br><span class="line">    once        sync.Once</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ—¥å¿—é…ç½®</span></span><br><span class="line"><span class="keyword">type</span> LogConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">    LogDir        <span class="type">string</span> <span class="comment">// æ—¥å¿—ç›®å½•</span></span><br><span class="line">    LogFileName   <span class="type">string</span> <span class="comment">// æ—¥å¿—æ–‡ä»¶å</span></span><br><span class="line">    MaxSize       <span class="type">int</span>    <span class="comment">// å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§å¤§å°ï¼Œå•ä½MB</span></span><br><span class="line">    MaxBackups    <span class="type">int</span>    <span class="comment">// æœ€å¤§ä¿ç•™æ—§æ—¥å¿—æ–‡ä»¶æ•°</span></span><br><span class="line">    MaxAge        <span class="type">int</span>    <span class="comment">// æ—¥å¿—æ–‡ä»¶ä¿ç•™å¤©æ•°</span></span><br><span class="line">    Compress      <span class="type">bool</span>   <span class="comment">// æ˜¯å¦å‹ç¼©æ—§æ—¥å¿—æ–‡ä»¶</span></span><br><span class="line">    ConsoleOutput <span class="type">bool</span>   <span class="comment">// æ˜¯å¦è¾“å‡ºåˆ°æ§åˆ¶å°</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é»˜è®¤æ—¥å¿—é…ç½®</span></span><br><span class="line"><span class="keyword">var</span> defaultLogConfig = LogConfig&#123;</span><br><span class="line">    LogDir:        <span class="string">&quot;logs&quot;</span>,</span><br><span class="line">    LogFileName:   <span class="string">&quot;app.log&quot;</span>,</span><br><span class="line">    MaxSize:       <span class="number">100</span>,</span><br><span class="line">    MaxBackups:    <span class="number">10</span>,</span><br><span class="line">    MaxAge:        <span class="number">30</span>,</span><br><span class="line">    Compress:      <span class="literal">true</span>,</span><br><span class="line">    ConsoleOutput: <span class="literal">true</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–æ—¥å¿—</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitLogger</span><span class="params">()</span></span> &#123;</span><br><span class="line">    InitLoggerWithConfig(defaultLogConfig)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨é…ç½®åˆå§‹åŒ–æ—¥å¿—</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitLoggerWithConfig</span><span class="params">(config LogConfig)</span></span> &#123;</span><br><span class="line">    once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> err := os.MkdirAll(config.LogDir, <span class="number">0755</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="built_in">panic</span>(<span class="string">&quot;æ— æ³•åˆ›å»ºæ—¥å¿—ç›®å½•: &quot;</span> + err.Error())</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é…ç½®ç¼–ç å™¨</span></span><br><span class="line">        encoderConfig := zapcore.EncoderConfig&#123;</span><br><span class="line">            TimeKey:        <span class="string">&quot;time&quot;</span>,</span><br><span class="line">            LevelKey:       <span class="string">&quot;level&quot;</span>,</span><br><span class="line">            NameKey:        <span class="string">&quot;logger&quot;</span>,</span><br><span class="line">            CallerKey:      <span class="string">&quot;caller&quot;</span>,</span><br><span class="line">            FunctionKey:    zapcore.OmitKey,</span><br><span class="line">            MessageKey:     <span class="string">&quot;msg&quot;</span>,</span><br><span class="line">            StacktraceKey:  <span class="string">&quot;stacktrace&quot;</span>,</span><br><span class="line">            LineEnding:     zapcore.DefaultLineEnding,</span><br><span class="line">            EncodeLevel:    zapcore.LowercaseLevelEncoder,</span><br><span class="line">            EncodeTime:     zapcore.ISO8601TimeEncoder,</span><br><span class="line">            EncodeDuration: zapcore.SecondsDurationEncoder,</span><br><span class="line">            EncodeCaller:   zapcore.ShortCallerEncoder,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ—¥å¿—è¾“å‡ºé…ç½®</span></span><br><span class="line">        <span class="comment">// ... [è¯¦ç»†é…ç½®çœç•¥]</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºæ—¥å¿—è®°å½•å™¨</span></span><br><span class="line">        logger = zap.New(core, zap.AddCaller(), zap.AddCallerSkip(<span class="number">1</span>))</span><br><span class="line">        sugarLogger = logger.Sugar()</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–æ—¥å¿—è®°å½•å™¨</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetLogger</span><span class="params">()</span></span> *zap.Logger &#123;</span><br><span class="line">    <span class="keyword">if</span> logger == <span class="literal">nil</span> &#123;</span><br><span class="line">        InitLogger()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> logger</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ—¥å¿—æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Info</span><span class="params">(msg <span class="type">string</span>, fields ...zap.Field)</span></span> &#123;</span><br><span class="line">    GetLogger().Info(msg, fields...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Error</span><span class="params">(msg <span class="type">string</span>, fields ...zap.Field)</span></span> &#123;</span><br><span class="line">    GetLogger().Error(msg, fields...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Fatal</span><span class="params">(msg <span class="type">string</span>, fields ...zap.Field)</span></span> &#123;</span><br><span class="line">    GetLogger().Fatal(msg, fields...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="ä¸‰ã€Webåº”ç”¨å¼€å‘ï¼ˆGinæ¡†æ¶ï¼‰"><a href="#ä¸‰ã€Webåº”ç”¨å¼€å‘ï¼ˆGinæ¡†æ¶ï¼‰" class="headerlink" title="ä¸‰ã€Webåº”ç”¨å¼€å‘ï¼ˆGinæ¡†æ¶ï¼‰"></a>ä¸‰ã€Webåº”ç”¨å¼€å‘ï¼ˆGinæ¡†æ¶ï¼‰</h2><h3 id="1-è·¯ç”±è®¾ç½®"><a href="#1-è·¯ç”±è®¾ç½®" class="headerlink" title="1. è·¯ç”±è®¾ç½®"></a>1. è·¯ç”±è®¾ç½®</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router/router.go</span></span><br><span class="line"><span class="keyword">package</span> router</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;go-app/config&quot;</span></span><br><span class="line">    <span class="string">&quot;go-app/controller&quot;</span></span><br><span class="line">    <span class="string">&quot;go-app/database/repositories&quot;</span></span><br><span class="line">    <span class="string">&quot;go-app/middleware&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Setup</span><span class="params">(r *gin.Engine, cfg *config.Config, repoManager *repositories.RepositoryManager)</span></span> &#123;</span><br><span class="line">    <span class="comment">// å…¬å…±è·¯ç”±ç»„</span></span><br><span class="line">    public := r.Group(<span class="string">&quot;/api&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¤è¯è·¯ç”±ç»„</span></span><br><span class="line">    authorized := r.Group(<span class="string">&quot;/api&quot;</span>)</span><br><span class="line">    authorized.Use(middleware.JWTAuth(cfg))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨æˆ·ç›¸å…³è·¯ç”±</span></span><br><span class="line">    setupUserRoutes(public, authorized, controller.NewUserController(repoManager.UserRepo, cfg))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// äº§å“ç›¸å…³è·¯ç”±</span></span><br><span class="line">    setupProductRoutes(public, authorized, controller.NewProductController(repoManager.ProductRepo, cfg))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setupUserRoutes</span><span class="params">(public, authorized *gin.RouterGroup, controller *controller.UserController)</span></span> &#123;</span><br><span class="line">    <span class="comment">// å…¬å…±æ¥å£</span></span><br><span class="line">    public.POST(<span class="string">&quot;/login&quot;</span>, controller.Login)</span><br><span class="line">    public.POST(<span class="string">&quot;/register&quot;</span>, controller.Register)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éœ€è¦è®¤è¯çš„æ¥å£</span></span><br><span class="line">    users := authorized.Group(<span class="string">&quot;/users&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        users.GET(<span class="string">&quot;&quot;</span>, controller.GetUsers)</span><br><span class="line">        users.GET(<span class="string">&quot;/:id&quot;</span>, controller.GetUser)</span><br><span class="line">        users.PUT(<span class="string">&quot;/:id&quot;</span>, controller.UpdateUser)</span><br><span class="line">        users.DELETE(<span class="string">&quot;/:id&quot;</span>, controller.DeleteUser)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-æ§åˆ¶å™¨å®ç°"><a href="#2-æ§åˆ¶å™¨å®ç°" class="headerlink" title="2. æ§åˆ¶å™¨å®ç°"></a>2. æ§åˆ¶å™¨å®ç°</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// controller/user_controller.go</span></span><br><span class="line"><span class="keyword">package</span> controller</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">    <span class="string">&quot;strconv&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;go-app/config&quot;</span></span><br><span class="line">    <span class="string">&quot;go-app/database/repositories&quot;</span></span><br><span class="line">    <span class="string">&quot;go-app/models&quot;</span></span><br><span class="line">    <span class="string">&quot;go-app/service&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> UserController <span class="keyword">struct</span> &#123;</span><br><span class="line">    userService service.UserService</span><br><span class="line">    cfg         *config.Config</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewUserController</span><span class="params">(userRepo repositories.UserRepository, cfg *config.Config)</span></span> *UserController &#123;</span><br><span class="line">    userService := service.NewUserService(userRepo, cfg)</span><br><span class="line">    <span class="keyword">return</span> &amp;UserController&#123;</span><br><span class="line">        userService: userService,</span><br><span class="line">        cfg:         cfg,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç™»å½•</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *UserController)</span></span> Login(ctx *gin.Context) &#123;</span><br><span class="line">    <span class="keyword">var</span> loginReq models.LoginRequest</span><br><span class="line">    <span class="keyword">if</span> err := ctx.ShouldBindJSON(&amp;loginReq); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        ctx.JSON(http.StatusBadRequest, gin.H&#123;<span class="string">&quot;error&quot;</span>: err.Error()&#125;)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    user, token, err := c.userService.Login(loginReq)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        ctx.JSON(http.StatusUnauthorized, gin.H&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯&quot;</span>&#125;)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">        <span class="string">&quot;user&quot;</span>:  user,</span><br><span class="line">        <span class="string">&quot;token&quot;</span>: token,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–ç”¨æˆ·åˆ—è¡¨</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *UserController)</span></span> GetUsers(ctx *gin.Context) &#123;</span><br><span class="line">    page, _ := strconv.Atoi(ctx.DefaultQuery(<span class="string">&quot;page&quot;</span>, <span class="string">&quot;1&quot;</span>))</span><br><span class="line">    pageSize, _ := strconv.Atoi(ctx.DefaultQuery(<span class="string">&quot;pageSize&quot;</span>, <span class="string">&quot;10&quot;</span>))</span><br><span class="line"></span><br><span class="line">    users, total, err := c.userService.GetUsers(page, pageSize)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        ctx.JSON(http.StatusInternalServerError, gin.H&#123;<span class="string">&quot;error&quot;</span>: err.Error()&#125;)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">        <span class="string">&quot;data&quot;</span>: users,</span><br><span class="line">        <span class="string">&quot;meta&quot;</span>: gin.H&#123;</span><br><span class="line">            <span class="string">&quot;total&quot;</span>:     total,</span><br><span class="line">            <span class="string">&quot;page&quot;</span>:      page,</span><br><span class="line">            <span class="string">&quot;page_size&quot;</span>: pageSize,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¶ä»–æ–¹æ³•...</span></span><br></pre></td></tr></table></figure><h3 id="3-ä¸»ç¨‹åºå…¥å£"><a href="#3-ä¸»ç¨‹åºå…¥å£" class="headerlink" title="3. ä¸»ç¨‹åºå…¥å£"></a>3. ä¸»ç¨‹åºå…¥å£</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;os/signal&quot;</span></span><br><span class="line">    <span class="string">&quot;syscall&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;go-app/config&quot;</span></span><br><span class="line">    <span class="string">&quot;go-app/database&quot;</span></span><br><span class="line">    <span class="string">&quot;go-app/database/repositories&quot;</span></span><br><span class="line">    <span class="string">&quot;go-app/middleware&quot;</span></span><br><span class="line">    <span class="string">&quot;go-app/router&quot;</span></span><br><span class="line">    <span class="string">&quot;go-app/utils&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/joho/godotenv&quot;</span></span><br><span class="line">    <span class="string">&quot;go.uber.org/zap&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// åŠ è½½ç¯å¢ƒå˜é‡</span></span><br><span class="line">    <span class="keyword">if</span> err := godotenv.Load(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;è­¦å‘Š: .envæ–‡ä»¶æœªæ‰¾åˆ°ï¼Œä½¿ç”¨ç³»ç»Ÿç¯å¢ƒå˜é‡&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŠ è½½é…ç½®</span></span><br><span class="line">    cfg := config.LoadConfig()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æ—¥å¿—</span></span><br><span class="line">    initLogger(cfg)</span><br><span class="line">    <span class="keyword">defer</span> utils.Sync() <span class="comment">// ç¡®ä¿æ—¥å¿—å†™å…¥</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®è¿è¡Œæ¨¡å¼</span></span><br><span class="line">    gin.SetMode(cfg.Server.Mode)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æ•°æ®åº“è¿æ¥</span></span><br><span class="line">    err := database.InitDB()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        utils.Error(<span class="string">&quot;MySQLæ•°æ®åº“åˆå§‹åŒ–å¤±è´¥&quot;</span>, zap.Error(err))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–MongoDBè¿æ¥</span></span><br><span class="line">    _, err = database.InitMongoDB(cfg)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        utils.Error(<span class="string">&quot;MongoDBåˆå§‹åŒ–å¤±è´¥&quot;</span>, zap.Error(err))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºå­˜å‚¨åº“ç®¡ç†å™¨</span></span><br><span class="line">    repoManager := repositories.NewRepositoryManager(database.DB, database.MongoDB)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºGinå¼•æ“</span></span><br><span class="line">    r := gin.New()</span><br><span class="line">    r.Use(gin.Recovery())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®ä¸­é—´ä»¶</span></span><br><span class="line">    middleware.SetupMiddlewares(r, cfg)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®è·¯ç”±</span></span><br><span class="line">    router.Setup(r, cfg, repoManager)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é…ç½®HTTPæœåŠ¡å™¨</span></span><br><span class="line">    server := &amp;http.Server&#123;</span><br><span class="line">        Addr:         <span class="string">&quot;:&quot;</span> + cfg.Server.Port,</span><br><span class="line">        Handler:      r,</span><br><span class="line">        ReadTimeout:  cfg.Server.ReadTimeout,</span><br><span class="line">        WriteTimeout: cfg.Server.WriteTimeout,</span><br><span class="line">        IdleTimeout:  cfg.Server.IdleTimeout,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯åŠ¨HTTPæœåŠ¡å™¨</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        utils.Info(fmt.Sprintf(<span class="string">&quot;æœåŠ¡å™¨å¯åŠ¨äº http://localhost:%s&quot;</span>, cfg.Server.Port))</span><br><span class="line">        <span class="keyword">if</span> err := server.ListenAndServe(); err != <span class="literal">nil</span> &amp;&amp; err != http.ErrServerClosed &#123;</span><br><span class="line">            utils.Fatal(<span class="string">&quot;æœåŠ¡å™¨å¯åŠ¨å¤±è´¥&quot;</span>, zap.Error(err))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…ä¸­æ–­ä¿¡å·</span></span><br><span class="line">    quit := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)</span><br><span class="line">    signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)</span><br><span class="line">    &lt;-quit</span><br><span class="line"></span><br><span class="line">    utils.Info(<span class="string">&quot;æ­£åœ¨å…³é—­æœåŠ¡å™¨...&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–æ—¥å¿—</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initLogger</span><span class="params">(cfg *config.Config)</span></span> &#123;</span><br><span class="line">    logConfig := utils.LogConfig&#123;</span><br><span class="line">        LogDir:        <span class="string">&quot;logs&quot;</span>,</span><br><span class="line">        LogFileName:   <span class="string">&quot;app.log&quot;</span>,</span><br><span class="line">        MaxSize:       <span class="number">100</span>,</span><br><span class="line">        MaxBackups:    <span class="number">10</span>,</span><br><span class="line">        MaxAge:        <span class="number">30</span>,</span><br><span class="line">        Compress:      <span class="literal">true</span>,</span><br><span class="line">        ConsoleOutput: <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨é…ç½®æ–‡ä»¶çš„è®¾ç½®ï¼ˆå¦‚æœæœ‰ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> cfg.Logger.Dir != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        logConfig.LogDir = cfg.Logger.Dir</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...å…¶ä»–é…ç½®é¡¹</span></span><br><span class="line"></span><br><span class="line">    utils.InitLoggerWithConfig(logConfig)</span><br><span class="line">    utils.Info(<span class="string">&quot;åº”ç”¨ç¨‹åºå¯åŠ¨&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="å››ã€æœ€ä½³å®è·µä¸ç¼–ç è§„èŒƒ"><a href="#å››ã€æœ€ä½³å®è·µä¸ç¼–ç è§„èŒƒ" class="headerlink" title="å››ã€æœ€ä½³å®è·µä¸ç¼–ç è§„èŒƒ"></a>å››ã€æœ€ä½³å®è·µä¸ç¼–ç è§„èŒƒ</h2><h3 id="1-é”™è¯¯å¤„ç†"><a href="#1-é”™è¯¯å¤„ç†" class="headerlink" title="1. é”™è¯¯å¤„ç†"></a>1. é”™è¯¯å¤„ç†</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸºæœ¬é”™è¯¯æ£€æŸ¥</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    result, err := someOperation()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;æ“ä½œå¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç†ç»“æœ...</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰é”™è¯¯ç±»å‹</span></span><br><span class="line"><span class="keyword">type</span> NotFoundError <span class="keyword">struct</span> &#123;</span><br><span class="line">    Resource <span class="type">string</span></span><br><span class="line">    ID       <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *NotFoundError)</span></span> Error() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;%s ID=%s ä¸å­˜åœ¨&quot;</span>, e.Resource, e.ID)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é”™è¯¯ç±»å‹åˆ¤æ–­</span></span><br><span class="line"><span class="keyword">if</span> errors.Is(err, sql.ErrNoRows) &#123;</span><br><span class="line">    <span class="comment">// å¤„ç†è®°å½•ä¸å­˜åœ¨çš„æƒ…å†µ</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–åŸå§‹é”™è¯¯</span></span><br><span class="line"><span class="keyword">var</span> notFoundErr *NotFoundError</span><br><span class="line"><span class="keyword">if</span> errors.As(err, &amp;notFoundErr) &#123;</span><br><span class="line">    <span class="comment">// å¤„ç†ç‰¹å®šç±»å‹çš„é”™è¯¯</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-å¹¶å‘æ§åˆ¶"><a href="#2-å¹¶å‘æ§åˆ¶" class="headerlink" title="2. å¹¶å‘æ§åˆ¶"></a>2. å¹¶å‘æ§åˆ¶</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨Contextæ§åˆ¶è¶…æ—¶å’Œå–æ¶ˆ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processWithTimeout</span><span class="params">(data []<span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    ctx, cancel := context.WithTimeout(context.Background(), <span class="number">5</span>*time.Second)</span><br><span class="line">    <span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">    results := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>, <span class="built_in">len</span>(data))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, item := <span class="keyword">range</span> data &#123;</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(item <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">            <span class="keyword">select</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">                <span class="keyword">return</span> <span class="comment">// è¶…æ—¶æˆ–è¢«å–æ¶ˆ</span></span><br><span class="line">            <span class="keyword">case</span> results &lt;- processItem(item):</span><br><span class="line">                <span class="comment">// å¤„ç†å®Œæˆ</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;(item)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ”¶é›†ç»“æœ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨WaitGroupåŒæ­¥å¤šä¸ªgoroutine</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processItems</span><span class="params">(items []<span class="type">string</span>)</span></span> []<span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">    results := <span class="built_in">make</span>([]<span class="type">string</span>, <span class="built_in">len</span>(items))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, item := <span class="keyword">range</span> items &#123;</span><br><span class="line">        wg.Add(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="type">int</span>, item <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">            <span class="keyword">defer</span> wg.Done()</span><br><span class="line">            results[i] = processItem(item)</span><br><span class="line">        &#125;(i, item)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    wg.Wait() <span class="comment">// ç­‰å¾…æ‰€æœ‰å¤„ç†å®Œæˆ</span></span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨workeræ± æ¨¡å¼</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">workerPool</span><span class="params">(tasks &lt;-<span class="keyword">chan</span> Task, results <span class="keyword">chan</span>&lt;- Result, numWorkers <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯åŠ¨å›ºå®šæ•°é‡çš„worker</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; numWorkers; i++ &#123;</span><br><span class="line">        wg.Add(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(workerID <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">            <span class="keyword">defer</span> wg.Done()</span><br><span class="line">            <span class="keyword">for</span> task := <span class="keyword">range</span> tasks &#123;</span><br><span class="line">                results &lt;- processTask(task)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;(i)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    wg.Wait()</span><br><span class="line">    <span class="built_in">close</span>(results)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-å•å…ƒæµ‹è¯•"><a href="#3-å•å…ƒæµ‹è¯•" class="headerlink" title="3. å•å…ƒæµ‹è¯•"></a>3. å•å…ƒæµ‹è¯•</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// service/user_service_test.go</span></span><br><span class="line"><span class="keyword">package</span> service</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;testing&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;go-app/models&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/stretchr/testify/assert&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/stretchr/testify/mock&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¨¡æ‹Ÿç”¨æˆ·å­˜å‚¨åº“</span></span><br><span class="line"><span class="keyword">type</span> MockUserRepository <span class="keyword">struct</span> &#123;</span><br><span class="line">    mock.Mock</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *MockUserRepository)</span></span> FindByID(id <span class="type">string</span>) (*models.User, <span class="type">error</span>) &#123;</span><br><span class="line">    args := m.Called(id)</span><br><span class="line">    <span class="keyword">if</span> args.Get(<span class="number">0</span>) == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, args.Error(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> args.Get(<span class="number">0</span>).(*models.User), args.Error(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•è·å–ç”¨æˆ·</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestGetUser</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    mockRepo := <span class="built_in">new</span>(MockUserRepository)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®æ¨¡æ‹Ÿè¡Œä¸º</span></span><br><span class="line">    mockRepo.On(<span class="string">&quot;FindByID&quot;</span>, <span class="string">&quot;1&quot;</span>).Return(&amp;models.User&#123;</span><br><span class="line">        ID:       <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        Username: <span class="string">&quot;testuser&quot;</span>,</span><br><span class="line">    &#125;, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºæœåŠ¡</span></span><br><span class="line">    service := NewUserService(mockRepo, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡Œæµ‹è¯•</span></span><br><span class="line">    user, err := service.GetUserByID(<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–­è¨€ç»“æœ</span></span><br><span class="line">    assert.NoError(t, err)</span><br><span class="line">    assert.NotNil(t, user)</span><br><span class="line">    assert.Equal(t, <span class="string">&quot;1&quot;</span>, user.ID)</span><br><span class="line">    assert.Equal(t, <span class="string">&quot;testuser&quot;</span>, user.Username)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éªŒè¯æ¨¡æ‹Ÿè°ƒç”¨</span></span><br><span class="line">    mockRepo.AssertExpectations(t)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-æ€§èƒ½ä¼˜åŒ–"><a href="#4-æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="4. æ€§èƒ½ä¼˜åŒ–"></a>4. æ€§èƒ½ä¼˜åŒ–</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨é€‚å½“çš„æ•°æ®ç»“æ„</span></span><br><span class="line"><span class="comment">// ä¾‹å¦‚ï¼Œä½¿ç”¨sync.Mapä»£æ›¿åŠ é”çš„map</span></span><br><span class="line"><span class="keyword">var</span> cache sync.Map</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»å–ç¼“å­˜</span></span><br><span class="line">value, ok := cache.Load(<span class="string">&quot;key&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> ok &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ç¼“å­˜çš„å€¼</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// è®¡ç®—æ–°å€¼</span></span><br><span class="line">    newValue := computeExpensiveValue()</span><br><span class="line">    cache.Store(<span class="string">&quot;key&quot;</span>, newValue)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥</span></span><br><span class="line"><span class="comment">// ä½æ•ˆæ–¹å¼</span></span><br><span class="line">s := <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">    s += <span class="string">&quot;x&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é«˜æ•ˆæ–¹å¼</span></span><br><span class="line"><span class="keyword">var</span> sb strings.Builder</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">    sb.WriteString(<span class="string">&quot;x&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">s := sb.String()</span><br><span class="line"></span><br><span class="line"><span class="comment">// é¿å…ä¸å¿…è¦çš„å†…å­˜åˆ†é…</span></span><br><span class="line">preallocated := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">0</span>, expectedSize) <span class="comment">// é¢„åˆ†é…å®¹é‡</span></span><br></pre></td></tr></table></figure><h3 id="5-APIè®¾è®¡"><a href="#5-APIè®¾è®¡" class="headerlink" title="5. APIè®¾è®¡"></a>5. APIè®¾è®¡</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RESTful APIè®¾è®¡</span></span><br><span class="line"><span class="comment">// GET /api/users      - è·å–æ‰€æœ‰ç”¨æˆ·</span></span><br><span class="line"><span class="comment">// GET /api/users/:id  - è·å–å•ä¸ªç”¨æˆ·</span></span><br><span class="line"><span class="comment">// POST /api/users     - åˆ›å»ºç”¨æˆ·</span></span><br><span class="line"><span class="comment">// PUT /api/users/:id  - æ›´æ–°ç”¨æˆ·</span></span><br><span class="line"><span class="comment">// DELETE /api/users/:id - åˆ é™¤ç”¨æˆ·</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»Ÿä¸€çš„å“åº”æ ¼å¼</span></span><br><span class="line"><span class="keyword">type</span> Response <span class="keyword">struct</span> &#123;</span><br><span class="line">    Code    <span class="type">int</span>         <span class="string">`json:&quot;code&quot;`</span></span><br><span class="line">    Message <span class="type">string</span>      <span class="string">`json:&quot;message&quot;`</span></span><br><span class="line">    Data    <span class="keyword">interface</span>&#123;&#125; <span class="string">`json:&quot;data,omitempty&quot;`</span></span><br><span class="line">    Meta    <span class="keyword">interface</span>&#123;&#125; <span class="string">`json:&quot;meta,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetUsers</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">    users, total, err := userService.GetUsers(page, pageSize)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        c.JSON(http.StatusInternalServerError, Response&#123;</span><br><span class="line">            Code:    <span class="number">500</span>,</span><br><span class="line">            Message: <span class="string">&quot;è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥&quot;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    c.JSON(http.StatusOK, Response&#123;</span><br><span class="line">        Code:    <span class="number">200</span>,</span><br><span class="line">        Message: <span class="string">&quot;æˆåŠŸ&quot;</span>,</span><br><span class="line">        Data:    users,</span><br><span class="line">        Meta: <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">            <span class="string">&quot;total&quot;</span>:     total,</span><br><span class="line">            <span class="string">&quot;page&quot;</span>:      page,</span><br><span class="line">            <span class="string">&quot;page_size&quot;</span>: pageSize,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="äº”ã€è¿›é˜¶ä¸»é¢˜ä¸æ‰©å±•"><a href="#äº”ã€è¿›é˜¶ä¸»é¢˜ä¸æ‰©å±•" class="headerlink" title="äº”ã€è¿›é˜¶ä¸»é¢˜ä¸æ‰©å±•"></a>äº”ã€è¿›é˜¶ä¸»é¢˜ä¸æ‰©å±•</h2><h3 id="1-éƒ¨ç½²ä¸CI-CD"><a href="#1-éƒ¨ç½²ä¸CI-CD" class="headerlink" title="1. éƒ¨ç½²ä¸CI&#x2F;CD"></a>1. éƒ¨ç½²ä¸CI&#x2F;CD</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dockerfile</span></span><br><span class="line"><span class="string">FROM</span> <span class="string">golang:1.19-alpine</span> <span class="string">AS</span> <span class="string">builder</span></span><br><span class="line"></span><br><span class="line"><span class="string">WORKDIR</span> <span class="string">/app</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">.</span> <span class="string">.</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">go</span> <span class="string">mod</span> <span class="string">download</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">go</span> <span class="string">build</span> <span class="string">-o</span> <span class="string">app</span></span><br><span class="line"></span><br><span class="line"><span class="string">FROM</span> <span class="string">alpine:latest</span></span><br><span class="line"><span class="string">WORKDIR</span> <span class="string">/app</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">--from=builder</span> <span class="string">/app/app</span> <span class="string">.</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">--from=builder</span> <span class="string">/app/configs</span> <span class="string">./configs</span></span><br><span class="line"></span><br><span class="line"><span class="string">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"><span class="string">CMD</span> [<span class="string">&quot;./app&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker-compose.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">app:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">APP_ENV=prod</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mongodb</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">mongodb:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mongo:latest</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mongo-data:/data/db</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;27017:27017&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">mongo-data:</span></span><br></pre></td></tr></table></figure><h3 id="2-ç›‘æ§ä¸æ—¥å¿—"><a href="#2-ç›‘æ§ä¸æ—¥å¿—" class="headerlink" title="2. ç›‘æ§ä¸æ—¥å¿—"></a>2. ç›‘æ§ä¸æ—¥å¿—</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŒ‡æ ‡æ”¶é›†</span></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;github.com/prometheus/client_golang/prometheus&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/prometheus/client_golang/prometheus/promhttp&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    httpRequestsTotal = prometheus.NewCounterVec(</span><br><span class="line">        prometheus.CounterOpts&#123;</span><br><span class="line">            Name: <span class="string">&quot;http_requests_total&quot;</span>,</span><br><span class="line">            Help: <span class="string">&quot;HTTPè¯·æ±‚æ€»æ•°&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        []<span class="type">string</span>&#123;<span class="string">&quot;method&quot;</span>, <span class="string">&quot;path&quot;</span>, <span class="string">&quot;status&quot;</span>&#125;,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    httpRequestDuration = prometheus.NewHistogramVec(</span><br><span class="line">        prometheus.HistogramOpts&#123;</span><br><span class="line">            Name:    <span class="string">&quot;http_request_duration_seconds&quot;</span>,</span><br><span class="line">            Help:    <span class="string">&quot;HTTPè¯·æ±‚å¤„ç†æ—¶é—´&quot;</span>,</span><br><span class="line">            Buckets: prometheus.DefBuckets,</span><br><span class="line">        &#125;,</span><br><span class="line">        []<span class="type">string</span>&#123;<span class="string">&quot;method&quot;</span>, <span class="string">&quot;path&quot;</span>&#125;,</span><br><span class="line">    )</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    prometheus.MustRegister(httpRequestsTotal)</span><br><span class="line">    prometheus.MustRegister(httpRequestDuration)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨Ginä¸­æ·»åŠ æŒ‡æ ‡ç«¯ç‚¹</span></span><br><span class="line">r.GET(<span class="string">&quot;/metrics&quot;</span>, gin.WrapH(promhttp.Handler()))</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ—¥å¿—èšåˆä¸åˆ†æ</span></span><br><span class="line"><span class="comment">// 1. ä½¿ç”¨ELK/EFKå †æ ˆ</span></span><br><span class="line"><span class="comment">// 2. ä½¿ç”¨OpenTelemetryè¿›è¡Œåˆ†å¸ƒå¼è¿½è¸ª</span></span><br></pre></td></tr></table></figure><h3 id="3-å®‰å…¨æœ€ä½³å®è·µ"><a href="#3-å®‰å…¨æœ€ä½³å®è·µ" class="headerlink" title="3. å®‰å…¨æœ€ä½³å®è·µ"></a>3. å®‰å…¨æœ€ä½³å®è·µ</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®‰å…¨æœ€ä½³å®è·µ</span></span><br><span class="line"><span class="comment">// 1. å¯†ç å“ˆå¸Œ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hashPassword</span><span class="params">(password <span class="type">string</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    hash, err := bcrypt.GenerateFromPassword([]<span class="type">byte</span>(password), bcrypt.DefaultCost)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">string</span>(hash), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">verifyPassword</span><span class="params">(hashedPassword, password <span class="type">string</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    err := bcrypt.CompareHashAndPassword([]<span class="type">byte</span>(hashedPassword), []<span class="type">byte</span>(password))</span><br><span class="line">    <span class="keyword">return</span> err == <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. CSRFä¿æŠ¤</span></span><br><span class="line">r.Use(csrf.Middleware(csrf.Options&#123;</span><br><span class="line">    Secret: <span class="string">&quot;32-byte-long-auth-key&quot;</span>,</span><br><span class="line">    ErrorFunc: <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        c.JSON(http.StatusForbidden, gin.H&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;CSRF token mismatch&quot;</span>&#125;)</span><br><span class="line">        c.Abort()</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. å®‰å…¨æ ‡å¤´</span></span><br><span class="line">r.Use(secure.New(secure.Options&#123;</span><br><span class="line">    AllowedHosts:          []<span class="type">string</span>&#123;<span class="string">&quot;example.com&quot;</span>, <span class="string">&quot;ssl.example.com&quot;</span>&#125;,</span><br><span class="line">    SSLRedirect:           <span class="literal">true</span>,</span><br><span class="line">    SSLHost:               <span class="string">&quot;ssl.example.com&quot;</span>,</span><br><span class="line">    STSSeconds:            <span class="number">315360000</span>,</span><br><span class="line">    STSIncludeSubdomains:  <span class="literal">true</span>,</span><br><span class="line">    FrameDeny:             <span class="literal">true</span>,</span><br><span class="line">    ContentTypeNosniff:    <span class="literal">true</span>,</span><br><span class="line">    BrowserXssFilter:      <span class="literal">true</span>,</span><br><span class="line">    ContentSecurityPolicy: <span class="string">&quot;default-src &#x27;self&#x27;&quot;</span>,</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure><hr><h2 id="å…­ã€å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ"><a href="#å…­ã€å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ" class="headerlink" title="å…­ã€å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ"></a>å…­ã€å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ</h2><h3 id="1-åˆå­¦è€…å¸¸è§é”™è¯¯"><a href="#1-åˆå­¦è€…å¸¸è§é”™è¯¯" class="headerlink" title="1. åˆå­¦è€…å¸¸è§é”™è¯¯"></a>1. åˆå­¦è€…å¸¸è§é”™è¯¯</h3><blockquote><p>âš ï¸ <strong>é™·é˜±</strong>: åœ¨å¾ªç¯ä¸­ä½¿ç”¨ goroutine æ—¶é—­åŒ…æ•è·è¿­ä»£å˜é‡</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é”™è¯¯ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        fmt.Println(i)  <span class="comment">// å¤§å¤šæ•°æƒ…å†µä¸‹ä¼šæ‰“å°å‡ºåŒä¸€ä¸ªå€¼(10)</span></span><br><span class="line">    &#125;()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£ç¡®ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">    i := i  <span class="comment">// åœ¨å¾ªç¯å†…éƒ¨åˆ›å»ºæ–°å˜é‡</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        fmt.Println(i)  <span class="comment">// æ¯ä¸ª goroutine æœ‰è‡ªå·±çš„ i å€¼</span></span><br><span class="line">    &#125;()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æˆ–è€…é€šè¿‡å‚æ•°ä¼ é€’</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">        fmt.Println(i)  <span class="comment">// i ä½œä¸ºå‚æ•°ä¼ å…¥</span></span><br><span class="line">    &#125;(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>âš ï¸ <strong>é™·é˜±</strong>: nil åˆ‡ç‰‡ä¸ç©ºåˆ‡ç‰‡çš„æ··æ·†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s1 []<span class="type">int</span>         <span class="comment">// nil åˆ‡ç‰‡ï¼Œs1 == nil ä¸º true</span></span><br><span class="line">s2 := []<span class="type">int</span>&#123;&#125;        <span class="comment">// ç©ºåˆ‡ç‰‡ï¼Œs2 == nil ä¸º falseï¼Œä½† len(s2) == 0</span></span><br><span class="line">s3 := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">0</span>) <span class="comment">// ç©ºåˆ‡ç‰‡ï¼Œs3 == nil ä¸º falseï¼Œä½† len(s3) == 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨æ„ï¼šè™½ç„¶ nil åˆ‡ç‰‡å’Œç©ºåˆ‡ç‰‡è¡Œä¸ºç›¸ä¼¼ï¼Œéƒ½å¯ä»¥å®‰å…¨åœ°è°ƒç”¨ append</span></span><br><span class="line"><span class="comment">// ä½†æ˜¯åœ¨åºåˆ—åŒ–(å¦‚JSON)æˆ–æ¯”è¾ƒæ—¶å¯èƒ½äº§ç”Ÿä¸åŒç»“æœ</span></span><br></pre></td></tr></table></figure></blockquote><blockquote><p>âš ï¸ <strong>é™·é˜±</strong>: æœªæ£€æŸ¥ map ä¸­é”®æ˜¯å¦å­˜åœ¨</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é”™è¯¯ç¤ºä¾‹</span></span><br><span class="line">m := <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>&#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;</span><br><span class="line">value := m[<span class="string">&quot;b&quot;</span>] <span class="comment">// å¦‚æœé”®ä¸å­˜åœ¨ï¼Œè¿”å›å€¼ç±»å‹çš„é›¶å€¼(è¿™é‡Œæ˜¯0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£ç¡®ç¤ºä¾‹</span></span><br><span class="line">value, exists := m[<span class="string">&quot;b&quot;</span>] <span class="comment">// exists å°†ä¸º false</span></span><br><span class="line"><span class="keyword">if</span> exists &#123;</span><br><span class="line">    <span class="comment">// é”®å­˜åœ¨</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// é”®ä¸å­˜åœ¨</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>âš ï¸ <strong>é™·é˜±</strong>: å¹¶å‘è®¿é—® map å¼•èµ· panic</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯èƒ½å¯¼è‡´ panic çš„å¹¶å‘ä»£ç </span></span><br><span class="line">m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">        m[fmt.Sprintf(<span class="string">&quot;key%d&quot;</span>, i)] = i <span class="comment">// å†™å…¥ map</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">        _ = m[fmt.Sprintf(<span class="string">&quot;key%d&quot;</span>, i)] <span class="comment">// è¯»å– map</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£ç¡®ç¤ºä¾‹ï¼šä½¿ç”¨ sync.Map æˆ–äº’æ–¥é”</span></span><br><span class="line"><span class="keyword">var</span> m sync.Map</span><br><span class="line"><span class="comment">// æˆ–</span></span><br><span class="line"><span class="keyword">var</span> mu sync.Mutex</span><br><span class="line">m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å†™å…¥æ—¶</span></span><br><span class="line">mu.Lock()</span><br><span class="line">m[<span class="string">&quot;key&quot;</span>] = value</span><br><span class="line">mu.Unlock()</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»å–æ—¶</span></span><br><span class="line">mu.Lock()</span><br><span class="line">value := m[<span class="string">&quot;key&quot;</span>]</span><br><span class="line">mu.Unlock()</span><br></pre></td></tr></table></figure></blockquote><h3 id="2-æ€§èƒ½ä¼˜åŒ–æç¤º"><a href="#2-æ€§èƒ½ä¼˜åŒ–æç¤º" class="headerlink" title="2. æ€§èƒ½ä¼˜åŒ–æç¤º"></a>2. æ€§èƒ½ä¼˜åŒ–æç¤º</h3><blockquote><p>ğŸš€ <strong>æ€§èƒ½æç¤º</strong>: é¢„åˆ†é…å†…å­˜ä»¥å‡å°‘åˆ†é…æ¬¡æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½æ•ˆæ–¹å¼</span></span><br><span class="line">s := []<span class="type">int</span>&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</span><br><span class="line">    s = <span class="built_in">append</span>(s, i) <span class="comment">// å¯èƒ½å¯¼è‡´å¤šæ¬¡é‡æ–°åˆ†é…</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é«˜æ•ˆæ–¹å¼</span></span><br><span class="line">s := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">0</span>, <span class="number">10000</span>) <span class="comment">// é¢„åˆ†é…å®¹é‡</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</span><br><span class="line">    s = <span class="built_in">append</span>(s, i) <span class="comment">// ä¸ä¼šé‡æ–°åˆ†é…</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>ğŸš€ <strong>æ€§èƒ½æç¤º</strong>: åœ¨çƒ­è·¯å¾„ä¸Šé¿å…ä½¿ç”¨åå°„</p><p>åå°„åœ¨Goä¸­æ˜¯å¼ºå¤§çš„ç‰¹æ€§ï¼Œä½†æ€§èƒ½ä»£ä»·å¾ˆé«˜ã€‚å¯¹äºé¢‘ç¹è°ƒç”¨çš„ä»£ç ï¼Œå°½é‡é¿å…ä½¿ç”¨åå°„ã€‚</p><p>è€ƒè™‘ä½¿ç”¨ä»£ç ç”Ÿæˆã€æ¥å£æˆ–ç±»å‹æ–­è¨€ç­‰æ›¿ä»£æ–¹æ¡ˆã€‚</p></blockquote><blockquote><p>ğŸš€ <strong>æ€§èƒ½æç¤º</strong>: å‡å°‘åƒåœ¾å›æ”¶å‹åŠ›</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é‡ç”¨å¯¹è±¡</span></span><br><span class="line"><span class="keyword">var</span> bufPool = sync.Pool&#123;</span><br><span class="line">    New: <span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// ä»æ± ä¸­è·å–</span></span><br><span class="line">    buf := bufPool.Get().(*bytes.Buffer)</span><br><span class="line">    <span class="keyword">defer</span> bufPool.Put(buf) <span class="comment">// ä½¿ç”¨å®Œæ”¾å›æ± ä¸­</span></span><br><span class="line"></span><br><span class="line">    buf.Reset() <span class="comment">// é‡ç½®ç¼“å†²åŒº</span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ buf...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><h3 id="3-ä»£ç é£æ ¼æœ€ä½³å®è·µ"><a href="#3-ä»£ç é£æ ¼æœ€ä½³å®è·µ" class="headerlink" title="3. ä»£ç é£æ ¼æœ€ä½³å®è·µ"></a>3. ä»£ç é£æ ¼æœ€ä½³å®è·µ</h3><blockquote><p>ğŸ’ <strong>æœ€ä½³å®è·µ</strong>: ä½¿ç”¨å‘½åè¿”å›å€¼æé«˜å¯è¯»æ€§</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸ä½¿ç”¨å‘½åè¿”å›å€¼</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">divide</span><span class="params">(a, b <span class="type">float64</span>)</span></span> (<span class="type">float64</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">&quot;é™¤æ•°ä¸èƒ½ä¸º0&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> a / b, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨å‘½åè¿”å›å€¼</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">divide</span><span class="params">(a, b <span class="type">float64</span>)</span></span> (result <span class="type">float64</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0</span> &#123;</span><br><span class="line">        err = errors.New(<span class="string">&quot;é™¤æ•°ä¸èƒ½ä¸º0&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="comment">// è‡ªåŠ¨è¿”å› result=0, err=é”™è¯¯</span></span><br><span class="line">    &#125;</span><br><span class="line">    result = a / b</span><br><span class="line">    <span class="keyword">return</span> <span class="comment">// è‡ªåŠ¨è¿”å› result=è®¡ç®—ç»“æœ, err=nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>ğŸ’ <strong>æœ€ä½³å®è·µ</strong>: ä¼˜é›…å¤„ç†èµ„æºæ¸…ç†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">f, err := os.Open(<span class="string">&quot;file.txt&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> f.Close() <span class="comment">// ç¡®ä¿å‡½æ•°è¿”å›å‰å…³é—­æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤„ç†æ–‡ä»¶...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤šä¸ªdeferè¯­å¥æŒ‰LIFOé¡ºåºæ‰§è¡Œ</span></span><br></pre></td></tr></table></figure></blockquote><blockquote><p>ğŸ’ <strong>æœ€ä½³å®è·µ</strong>: æœ‰æ„ä¹‰çš„é”™è¯¯å¤„ç†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸æ¨èï¼šä¸¢å¼ƒé”™è¯¯</span></span><br><span class="line">_ = SomeFunction()</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸æ¨èï¼šç©ºçš„if err != nil</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> err <span class="comment">// æ²¡æœ‰æ·»åŠ ä¸Šä¸‹æ–‡</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¨èï¼šæ·»åŠ ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¨èï¼šæ ¹æ®é”™è¯¯ç±»å‹åˆ†åˆ«å¤„ç†</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> errors.Is(err, os.ErrNotExist) &#123;</span><br><span class="line">        <span class="comment">// å¤„ç†æ–‡ä»¶ä¸å­˜åœ¨çš„æƒ…å†µ</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> errors.Is(err, os.ErrPermission) &#123;</span><br><span class="line">        <span class="comment">// å¤„ç†æƒé™é”™è¯¯</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¤„ç†å…¶ä»–é”™è¯¯</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><hr><h2 id="ä¸ƒã€æ³›å‹ç¼–ç¨‹-Go-1-18"><a href="#ä¸ƒã€æ³›å‹ç¼–ç¨‹-Go-1-18" class="headerlink" title="ä¸ƒã€æ³›å‹ç¼–ç¨‹ (Go 1.18+)"></a>ä¸ƒã€æ³›å‹ç¼–ç¨‹ (Go 1.18+)</h2><h3 id="1-æ³›å‹å‡½æ•°"><a href="#1-æ³›å‹å‡½æ•°" class="headerlink" title="1. æ³›å‹å‡½æ•°"></a>1. æ³›å‹å‡½æ•°</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ³›å‹å‡½æ•°</span></span><br><span class="line"><span class="comment">// çº¦æŸTä¸ºå¯æ¯”è¾ƒçš„æ•°å­—ç±»å‹(int, floatç­‰)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Min</span>[<span class="title">T</span> <span class="title">constraints</span>.<span class="title">Ordered</span>]<span class="params">(x, y T)</span></span> T &#123;</span><br><span class="line">    <span class="keyword">if</span> x &lt; y &#123;</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> y</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨æ–¹å¼</span></span><br><span class="line">minInt := Min[<span class="type">int</span>](<span class="number">10</span>, <span class="number">20</span>)      <span class="comment">// æ˜¾å¼æŒ‡å®šç±»å‹</span></span><br><span class="line">minFloat := Min(<span class="number">10.5</span>, <span class="number">20.5</span>)     <span class="comment">// ç±»å‹æ¨æ–­ä¸ºfloat64</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³›å‹ç±»å‹</span></span><br><span class="line"><span class="keyword">type</span> Stack[T any] <span class="keyword">struct</span> &#123;</span><br><span class="line">    elements []T</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³›å‹ç±»å‹çš„æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Stack[T])</span></span> Push(value T) &#123;</span><br><span class="line">    s.elements = <span class="built_in">append</span>(s.elements, value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Stack[T])</span></span> Pop() (T, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> zero T</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(s.elements) == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> zero, errors.New(<span class="string">&quot;stack is empty&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    value := s.elements[<span class="built_in">len</span>(s.elements)<span class="number">-1</span>]</span><br><span class="line">    s.elements = s.elements[:<span class="built_in">len</span>(s.elements)<span class="number">-1</span>]</span><br><span class="line">    <span class="keyword">return</span> value, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨æ³›å‹ç±»å‹</span></span><br><span class="line">stringStack := Stack[<span class="type">string</span>]&#123;&#125;</span><br><span class="line">stringStack.Push(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">stringStack.Push(<span class="string">&quot;world&quot;</span>)</span><br><span class="line">value, _ := stringStack.Pop() <span class="comment">// &quot;world&quot;</span></span><br></pre></td></tr></table></figure><p><strong>æ³›å‹çº¦æŸ</strong>:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨constraintsåŒ…ä¸­çš„çº¦æŸ</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;golang.org/x/exp/constraints&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ•°å€¼ç±»å‹çº¦æŸ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sum</span>[<span class="title">T</span> <span class="title">constraints</span>.<span class="title">Integer</span> | <span class="title">constraints</span>.<span class="title">Float</span>]<span class="params">(values []T)</span></span> T &#123;</span><br><span class="line">    <span class="keyword">var</span> sum T</span><br><span class="line">    <span class="keyword">for</span> _, v := <span class="keyword">range</span> values &#123;</span><br><span class="line">        sum += v</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰çº¦æŸ</span></span><br><span class="line"><span class="keyword">type</span> Comparable <span class="keyword">interface</span> &#123;</span><br><span class="line">    comparable  <span class="comment">// å†…å»ºçº¦æŸï¼Œè¡¨ç¤ºå¯ä»¥ç”¨==å’Œ!=æ¯”è¾ƒ</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤åˆçº¦æŸ</span></span><br><span class="line"><span class="keyword">type</span> Number <span class="keyword">interface</span> &#123;</span><br><span class="line">    constraints.Integer | constraints.Float</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¸¦æ–¹æ³•çš„çº¦æŸ</span></span><br><span class="line"><span class="keyword">type</span> Stringer <span class="keyword">interface</span> &#123;</span><br><span class="line">    String() <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»“æ„åŒ–ç±»å‹çº¦æŸ</span></span><br><span class="line"><span class="keyword">type</span> HasAge <span class="keyword">interface</span> &#123;</span><br><span class="line">    Age() <span class="type">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ³›å‹ä½¿ç”¨åœºæ™¯</strong>:</p><ul><li>é€šç”¨å®¹å™¨ç±»å‹ï¼ˆæ ˆã€é˜Ÿåˆ—ã€æ ‘ç­‰ï¼‰</li><li>ç®—æ³•å®ç°ï¼ˆæ’åºã€æœç´¢ç­‰ï¼‰</li><li>é¿å…æ¥å£+ç±»å‹æ–­è¨€æˆ–åå°„çš„æ€§èƒ½å¼€é”€</li><li>å‡å°‘ä»£ç é‡å¤</li></ul><p><strong>æ³›å‹æœ€ä½³å®è·µ</strong>:</p><ul><li>åªåœ¨çœŸæ­£éœ€è¦æ³›å‹çš„åœ°æ–¹ä½¿ç”¨å®ƒ</li><li>ä¼˜å…ˆä½¿ç”¨ç®€å•çš„çº¦æŸ</li><li>æä¾›æœ‰æ„ä¹‰çš„ç±»å‹å‚æ•°åï¼ˆå¦‚<code>[K, V]</code>ç”¨äºé”®å€¼å¯¹ï¼‰</li><li>ä¸è¦è¿‡åº¦è®¾è®¡æ³›å‹ç±»å‹</li></ul><hr><h2 id="å…«ã€æ ¸å¿ƒçŸ¥è¯†ç‚¹å›é¡¾"><a href="#å…«ã€æ ¸å¿ƒçŸ¥è¯†ç‚¹å›é¡¾" class="headerlink" title="å…«ã€æ ¸å¿ƒçŸ¥è¯†ç‚¹å›é¡¾"></a>å…«ã€æ ¸å¿ƒçŸ¥è¯†ç‚¹å›é¡¾</h2><p>ä»¥ä¸‹æ˜¯Goè¯­è¨€å­¦ä¹ è¿‡ç¨‹ä¸­çš„æ ¸å¿ƒçŸ¥è¯†ç‚¹æ€»ç»“ï¼Œä½œä¸ºå¿«é€Ÿå‚è€ƒå’Œå¤ä¹ ä½¿ç”¨ã€‚</p><h3 id="1-è¯­æ³•ä¸åŸºç¡€ç»“æ„"><a href="#1-è¯­æ³•ä¸åŸºç¡€ç»“æ„" class="headerlink" title="1. è¯­æ³•ä¸åŸºç¡€ç»“æ„"></a>1. è¯­æ³•ä¸åŸºç¡€ç»“æ„</h3><table><thead><tr><th>çŸ¥è¯†ç‚¹</th><th>å…³é”®è¦ç‚¹</th><th>é‡è¦åº¦</th></tr></thead><tbody><tr><td>åŸºæœ¬è¯­æ³•</td><td>å¼ºç±»å‹ï¼Œç¼–è¯‘å‹ï¼Œåƒåœ¾å›æ”¶ï¼Œå¹¶å‘æ”¯æŒ</td><td>â˜…â˜…â˜…â˜…â˜…</td></tr><tr><td>åŒ…ç®¡ç†</td><td>packageå£°æ˜ï¼Œimportå¯¼å…¥ï¼Œgo modç®¡ç†</td><td>â˜…â˜…â˜…â˜…â˜…</td></tr><tr><td>å˜é‡å£°æ˜</td><td>varå£°æ˜ï¼Œ:&#x3D;çŸ­å£°æ˜ï¼Œå¤šå˜é‡å£°æ˜ï¼Œç±»å‹æ¨æ–­</td><td>â˜…â˜…â˜…â˜…â˜…</td></tr><tr><td>åŸºæœ¬ç±»å‹</td><td>int&#x2F;uint, float, string, bool, byte, rune</td><td>â˜…â˜…â˜…â˜…â˜…</td></tr><tr><td>å¤åˆç±»å‹</td><td>array, slice, map, struct, pointer, interface</td><td>â˜…â˜…â˜…â˜…â˜…</td></tr><tr><td>æ§åˆ¶æµ</td><td>if&#x2F;else, switch, forå¾ªç¯, range</td><td>â˜…â˜…â˜…â˜…â˜…</td></tr></tbody></table><h3 id="2-å‡½æ•°ä¸æ•°æ®ç»“æ„"><a href="#2-å‡½æ•°ä¸æ•°æ®ç»“æ„" class="headerlink" title="2. å‡½æ•°ä¸æ•°æ®ç»“æ„"></a>2. å‡½æ•°ä¸æ•°æ®ç»“æ„</h3><table><thead><tr><th>çŸ¥è¯†ç‚¹</th><th>å…³é”®è¦ç‚¹</th><th>é‡è¦åº¦</th></tr></thead><tbody><tr><td>å‡½æ•°å®šä¹‰</td><td>å€¼ä¼ é€’ï¼Œå¤šè¿”å›å€¼ï¼Œå‘½åè¿”å›å€¼ï¼Œå¯å˜å‚æ•°</td><td>â˜…â˜…â˜…â˜…â˜…</td></tr><tr><td>æ–¹æ³•</td><td>å€¼æ¥æ”¶è€…vsæŒ‡é’ˆæ¥æ”¶è€…ï¼Œæ–¹æ³•é›†</td><td>â˜…â˜…â˜…â˜…â˜…</td></tr><tr><td>ç»“æ„ä½“</td><td>å­—æ®µï¼ŒåµŒå¥—ï¼Œæ ‡ç­¾ï¼Œé›¶å€¼ï¼Œåˆå§‹åŒ–</td><td>â˜…â˜…â˜…â˜…â˜…</td></tr><tr><td>æ¥å£</td><td>éšå¼å®ç°ï¼Œç©ºæ¥å£ï¼Œç±»å‹æ–­è¨€ï¼Œæ¥å£ç»„åˆ</td><td>â˜…â˜…â˜…â˜…â˜…</td></tr><tr><td>é”™è¯¯å¤„ç†</td><td>erroræ¥å£ï¼Œerror wrap&#x2F;unwrap</td><td>â˜…â˜…â˜…â˜…â˜…</td></tr><tr><td>defer</td><td>èµ„æºæ¸…ç†ï¼Œå‡½æ•°ç»“æŸæ‰§è¡Œï¼ŒLIFOé¡ºåº</td><td>â˜…â˜…â˜…â˜…â˜†</td></tr></tbody></table><h3 id="3-å¹¶å‘ç¼–ç¨‹"><a href="#3-å¹¶å‘ç¼–ç¨‹" class="headerlink" title="3. å¹¶å‘ç¼–ç¨‹"></a>3. å¹¶å‘ç¼–ç¨‹</h3><table><thead><tr><th>çŸ¥è¯†ç‚¹</th><th>å…³é”®è¦ç‚¹</th><th>é‡è¦åº¦</th></tr></thead><tbody><tr><td>goroutine</td><td>è½»é‡çº§çº¿ç¨‹ï¼Œå¯åŠ¨æ–¹å¼ï¼Œç”Ÿå‘½å‘¨æœŸ</td><td>â˜…â˜…â˜…â˜…â˜…</td></tr><tr><td>channel</td><td>æœ‰ç¼“å†²vsæ— ç¼“å†²ï¼Œå…³é—­é€šé“ï¼Œrangeé€šé“</td><td>â˜…â˜…â˜…â˜…â˜…</td></tr><tr><td>select</td><td>å¤šé€šé“æ“ä½œï¼Œè¶…æ—¶å¤„ç†ï¼Œéé˜»å¡IO</td><td>â˜…â˜…â˜…â˜…â˜…</td></tr><tr><td>syncåŒ…</td><td>Mutex, RWMutex, WaitGroup, Once, Map</td><td>â˜…â˜…â˜…â˜…â˜†</td></tr><tr><td>context</td><td>è¶…æ—¶æ§åˆ¶ï¼Œå–æ¶ˆæ“ä½œï¼Œå€¼ä¼ é€’</td><td>â˜…â˜…â˜…â˜…â˜…</td></tr><tr><td>ç«æ€æ£€æµ‹</td><td>go build&#x2F;test -raceï¼Œé¿å…æ•°æ®ç«äº‰</td><td>â˜…â˜…â˜…â˜…â˜†</td></tr></tbody></table><h3 id="4-å·¥ç¨‹å®è·µ"><a href="#4-å·¥ç¨‹å®è·µ" class="headerlink" title="4. å·¥ç¨‹å®è·µ"></a>4. å·¥ç¨‹å®è·µ</h3><table><thead><tr><th>çŸ¥è¯†ç‚¹</th><th>å…³é”®è¦ç‚¹</th><th>é‡è¦åº¦</th></tr></thead><tbody><tr><td>é¡¹ç›®ç»“æ„</td><td>æ ‡å‡†å¸ƒå±€ï¼ŒDDDåˆ†å±‚ï¼Œæ¨¡å—åŒ–è®¾è®¡</td><td>â˜…â˜…â˜…â˜…â˜†</td></tr><tr><td>ä¾èµ–ç®¡ç†</td><td>go.mod, go.sum, replace, ç‰ˆæœ¬ç®¡ç†</td><td>â˜…â˜…â˜…â˜…â˜†</td></tr><tr><td>æµ‹è¯•</td><td>è¡¨é©±åŠ¨æµ‹è¯•ï¼Œæµ‹è¯•è¾…åŠ©å‡½æ•°ï¼ŒMockæµ‹è¯•</td><td>â˜…â˜…â˜…â˜…â˜†</td></tr><tr><td>æ–‡æ¡£</td><td>godoc, ç¤ºä¾‹æµ‹è¯•ï¼Œpkgsite</td><td>â˜…â˜…â˜…â˜†â˜†</td></tr><tr><td>æ€§èƒ½</td><td>pprof, trace, benchmark, å†…å­˜ç®¡ç†</td><td>â˜…â˜…â˜…â˜…â˜†</td></tr><tr><td>éƒ¨ç½²</td><td>äº¤å‰ç¼–è¯‘ï¼ŒDockerå®¹å™¨åŒ–ï¼ŒCI&#x2F;CD</td><td>â˜…â˜…â˜…â˜…â˜†</td></tr></tbody></table><h3 id="5-Webå¼€å‘"><a href="#5-Webå¼€å‘" class="headerlink" title="5. Webå¼€å‘"></a>5. Webå¼€å‘</h3><table><thead><tr><th>çŸ¥è¯†ç‚¹</th><th>å…³é”®è¦ç‚¹</th><th>é‡è¦åº¦</th></tr></thead><tbody><tr><td>net&#x2F;http</td><td>ListenAndServe, Handleræ¥å£, ServeMux</td><td>â˜…â˜…â˜…â˜…â˜†</td></tr><tr><td>ä¸­é—´ä»¶</td><td>å¤„ç†é“¾ï¼Œè£…é¥°å™¨æ¨¡å¼ï¼Œæ¢å¤å’Œæ—¥å¿—</td><td>â˜…â˜…â˜…â˜…â˜†</td></tr><tr><td>æ•°æ®åº“</td><td>database&#x2F;sqlæ¥å£ï¼ŒORMå·¥å…·ï¼Œäº‹åŠ¡å¤„ç†</td><td>â˜…â˜…â˜…â˜…â˜†</td></tr><tr><td>APIè®¾è®¡</td><td>RESTful, JSONå¤„ç†ï¼ŒçŠ¶æ€ç ï¼Œé”™è¯¯å“åº”</td><td>â˜…â˜…â˜…â˜…â˜†</td></tr><tr><td>è®¤è¯æˆæƒ</td><td>JWTï¼ŒOAuth2ï¼Œä¼šè¯ç®¡ç†</td><td>â˜…â˜…â˜…â˜…â˜†</td></tr><tr><td>å¹¶å‘æ¨¡å‹</td><td>è¯·æ±‚å¤„ç†æ¨¡å‹ï¼Œgoroutineç®¡ç†</td><td>â˜…â˜…â˜…â˜…â˜†</td></tr></tbody></table><blockquote><p><strong>æ€»ç»“ä½¿ç”¨æç¤º</strong>ï¼š</p><ul><li>é‡è¦åº¦ä»â˜…â˜†â˜†â˜†â˜†(æœ€ä½)åˆ°â˜…â˜…â˜…â˜…â˜…(æœ€é«˜)ï¼Œè¡¨ç¤ºåœ¨å®é™…é¡¹ç›®ä¸­çš„ä½¿ç”¨é¢‘ç‡å’Œé‡è¦æ€§</li><li>è¿™äº›çŸ¥è¯†ç‚¹æ˜¯ç›¸äº’å…³è”çš„ï¼Œåº”ç»¼åˆç†è§£å’Œåº”ç”¨</li><li>å®šæœŸå›é¡¾è¿™äº›æ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼Œå·©å›ºå¯¹Goè¯­è¨€çš„ç†è§£</li></ul></blockquote><hr>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Goè¯­è¨€å­¦ä¹ æ€»ç»“&quot;&gt;&lt;a href=&quot;#Goè¯­è¨€å­¦ä¹ æ€»ç»“&quot; class=&quot;headerlink&quot; title=&quot;Goè¯­è¨€å­¦ä¹ æ€»ç»“&quot;&gt;&lt;/a&gt;Goè¯­è¨€å­¦ä¹ æ€»ç»“&lt;/h1&gt;&lt;h2 id=&quot;ç›®å½•&quot;&gt;&lt;a href=&quot;#ç›®å½•&quot; class=&quot;headerlink&quot; titl</summary>
      
    
    
    
    
    <category term="Golang" scheme="https://aoayaoa.github.io/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>Denoå­¦ä¹ è®°å½•</title>
    <link href="https://aoayaoa.github.io/2025/04/15/deno%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"/>
    <id>https://aoayaoa.github.io/2025/04/15/deno%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/</id>
    <published>2025-04-14T16:00:00.000Z</published>
    <updated>2025-04-16T02:50:03.343Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Denoå­¦ä¹ è®°å½•-ğŸ“˜"><a href="#Denoå­¦ä¹ è®°å½•-ğŸ“˜" class="headerlink" title="Denoå­¦ä¹ è®°å½• ğŸ“˜"></a>Denoå­¦ä¹ è®°å½• ğŸ“˜</h1><div align="left"><p><img src= "/img/loading.gif" data-lazy-src="https://img.shields.io/badge/Deno-v1.x-black?logo=deno" alt="Deno"><br><img src= "/img/loading.gif" data-lazy-src="https://img.shields.io/badge/TypeScript-v5.x-blue?logo=typescript" alt="TypeScript"><br><img src= "/img/loading.gif" data-lazy-src="https://img.shields.io/badge/MongoDB-v6.x-green?logo=mongodb" alt="MongoDB"><br><img src= "/img/loading.gif" data-lazy-src="https://img.shields.io/badge/Oak-v12.x-lightgrey" alt="Oak"></p><h2 id="ğŸ“‹-ç›®å½•"><a href="#ğŸ“‹-ç›®å½•" class="headerlink" title="ğŸ“‹ ç›®å½•"></a>ğŸ“‹ ç›®å½•</h2><h3 id="ä¸€ã€DenoåŸºç¡€æŠ€æœ¯"><a href="#ä¸€ã€DenoåŸºç¡€æŠ€æœ¯" class="headerlink" title="ä¸€ã€DenoåŸºç¡€æŠ€æœ¯"></a>ä¸€ã€DenoåŸºç¡€æŠ€æœ¯</h3><ul><li><a href="#%E9%A1%B9%E7%9B%AE%E6%A6%82%E8%BF%B0">é¡¹ç›®æ¦‚è¿°</a></li><li><a href="#%E6%8A%80%E6%9C%AF%E6%A0%88">æŠ€æœ¯æ ˆ</a></li><li><a href="#deno%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95">DenoåŸºç¡€ç”¨æ³•</a></li><li><a href="#%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86">æƒé™ç®¡ç†</a></li><li><a href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4">å¸¸ç”¨å‘½ä»¤</a></li><li><a href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F">ç¯å¢ƒå˜é‡</a></li><li><a href="#%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E5%92%8C%E4%BE%9D%E8%B5%96%E7%AE%A1%E7%90%86">ç¬¬ä¸‰æ–¹åº“å’Œä¾èµ–ç®¡ç†</a></li><li><a href="#deno%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97">Denoéƒ¨ç½²æŒ‡å—</a></li></ul><h3 id="äºŒã€é¡¹ç›®å…·ä½“å®ç°"><a href="#äºŒã€é¡¹ç›®å…·ä½“å®ç°" class="headerlink" title="äºŒã€é¡¹ç›®å…·ä½“å®ç°"></a>äºŒã€é¡¹ç›®å…·ä½“å®ç°</h3><ul><li><a href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84">é¡¹ç›®ç»“æ„</a></li><li><a href="#api%E8%B7%AF%E7%94%B1">APIè·¯ç”±</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B">æ•°æ®æ¨¡å‹</a></li><li><a href="#mongodb%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C">MongoDBæ•°æ®åº“æ“ä½œ</a></li><li><a href="#mbti%E6%B5%8B%E8%AF%95%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82">MBTIæµ‹è¯•å®ç°ç»†èŠ‚</a></li></ul><h3 id="ä¸‰ã€æœ€ä½³å®è·µå’Œæ‰©å±•"><a href="#ä¸‰ã€æœ€ä½³å®è·µå’Œæ‰©å±•" class="headerlink" title="ä¸‰ã€æœ€ä½³å®è·µå’Œæ‰©å±•"></a>ä¸‰ã€æœ€ä½³å®è·µå’Œæ‰©å±•</h3><ul><li><a href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%E5%92%8C%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">æ³¨æ„äº‹é¡¹å’Œæœ€ä½³å®è·µ</a></li><li><a href="#%E5%89%8D%E7%AB%AF%E5%B1%95%E7%A4%BA%E4%B8%8Eui%E4%BC%98%E5%8C%96">å‰ç«¯å±•ç¤ºä¸UIä¼˜åŒ–</a></li><li><a href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5">å¸¸è§é—®é¢˜æ’æŸ¥</a></li><li><a href="#%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83">ä»£ç è§„èŒƒ</a></li><li><a href="#%E6%89%A9%E5%B1%95%E5%92%8C%E6%94%B9%E8%BF%9B">æ‰©å±•å’Œæ”¹è¿›</a></li><li><a href="#%E8%B5%84%E6%BA%90%E9%93%BE%E6%8E%A5">èµ„æºé“¾æ¥</a></li></ul><hr><h2 id="ğŸš€-é¡¹ç›®æ¦‚è¿°"><a href="#ğŸš€-é¡¹ç›®æ¦‚è¿°" class="headerlink" title="ğŸš€ é¡¹ç›®æ¦‚è¿°"></a>ğŸš€ é¡¹ç›®æ¦‚è¿°</h2><p>è¿™æ˜¯ä¸€ä¸ªåŸºäºDenoè¿è¡Œæ—¶çš„åç«¯æœåŠ¡é¡¹ç›®ï¼Œä¸»è¦åŠŸèƒ½åŒ…æ‹¬MBTIäººæ ¼æµ‹è¯•ç³»ç»Ÿã€‚é¡¹ç›®é‡‡ç”¨TypeScriptè¯­è¨€å¼€å‘ï¼Œä½¿ç”¨Oak HTTPæœåŠ¡å™¨æ¡†æ¶å¤„ç†HTTPè¯·æ±‚ï¼ŒMongoDBä½œä¸ºæ•°æ®å­˜å‚¨è§£å†³æ–¹æ¡ˆã€‚</p><hr><h2 id="ğŸ’»-æŠ€æœ¯æ ˆ"><a href="#ğŸ’»-æŠ€æœ¯æ ˆ" class="headerlink" title="ğŸ’» æŠ€æœ¯æ ˆ"></a>ğŸ’» æŠ€æœ¯æ ˆ</h2><table><thead><tr><th>åˆ†ç±»</th><th>æŠ€æœ¯</th><th>æè¿°</th></tr></thead><tbody><tr><td><strong>è¿è¡Œæ—¶ç¯å¢ƒ</strong></td><td>Deno</td><td>å®‰å…¨çš„JavaScriptå’ŒTypeScriptè¿è¡Œæ—¶</td></tr><tr><td><strong>è¯­è¨€</strong></td><td>TypeScript</td><td>å¸¦æœ‰ç±»å‹ç³»ç»Ÿçš„JavaScriptè¶…é›†</td></tr><tr><td><strong>HTTPæœåŠ¡å™¨æ¡†æ¶</strong></td><td>Oak</td><td>å—Koaå¯å‘çš„Denoä¸­é—´ä»¶æ¡†æ¶</td></tr><tr><td><strong>æ•°æ®åº“</strong></td><td>MongoDB</td><td>NoSQLæ–‡æ¡£æ•°æ®åº“</td></tr><tr><td><strong>ODM</strong></td><td>Mongoose</td><td>MongoDBå¯¹è±¡æ¨¡å‹å·¥å…·</td></tr><tr><td><strong>APIæ–‡æ¡£</strong></td><td>æš‚æ— </td><td>å¯è€ƒè™‘æ·»åŠ Swagger</td></tr><tr><td><strong>æµ‹è¯•æ¡†æ¶</strong></td><td>Denoå†…ç½®æµ‹è¯•å·¥å…·</td><td>Denoè‡ªå¸¦çš„æµ‹è¯•åŠŸèƒ½</td></tr></tbody></table><hr><h2 id="ğŸ› ï¸-ç¯å¢ƒå‡†å¤‡"><a href="#ğŸ› ï¸-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ğŸ› ï¸ ç¯å¢ƒå‡†å¤‡"></a>ğŸ› ï¸ ç¯å¢ƒå‡†å¤‡</h2><p>åœ¨å¼€å§‹é¡¹ç›®ä¹‹å‰ï¼Œè¯·å‡†å¤‡ä»¥ä¸‹ç¯å¢ƒï¼š</p><h3 id="1-å®‰è£…Deno"><a href="#1-å®‰è£…Deno" class="headerlink" title="1. å®‰è£…Deno"></a>1. å®‰è£…Deno</h3><p>Deno æ˜¯ä¸€ä¸ªç°ä»£çš„JavaScriptå’ŒTypeScriptè¿è¡Œæ—¶ç¯å¢ƒã€‚æ¨èä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š</p><table><thead><tr><th>æ“ä½œç³»ç»Ÿ</th><th>å‘½ä»¤</th></tr></thead><tbody><tr><td>macOS &#x2F; Linux</td><td>`curl -fsSL <a href="https://deno.land/install.sh">https://deno.land/install.sh</a></td></tr><tr><td>Windows</td><td>`irm <a href="https://deno.land/install.ps1">https://deno.land/install.ps1</a></td></tr></tbody></table><p>éªŒè¯å®‰è£…ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deno --version</span><br></pre></td></tr></table></figure><blockquote><p><strong>æ³¨</strong>ï¼šæ›´å¤šå®‰è£…é€‰é¡¹ï¼ˆå¦‚Homebrewï¼‰è¯·å‚è€ƒ Denoå®‰è£…æŒ‡å—ã€‚</p></blockquote><h3 id="2-å®‰è£…MongoDB"><a href="#2-å®‰è£…MongoDB" class="headerlink" title="2. å®‰è£…MongoDB"></a>2. å®‰è£…MongoDB</h3><p>é¡¹ç›®ä½¿ç”¨ MongoDB ä½œä¸ºæ•°æ®åº“ã€‚æ‚¨å¯ä»¥é€‰æ‹©æœ¬åœ°å®‰è£…æˆ–ä½¿ç”¨Dockerã€‚</p><h4 id="2-1-æœ¬åœ°å®‰è£…MongoDB"><a href="#2-1-æœ¬åœ°å®‰è£…MongoDB" class="headerlink" title="2.1 æœ¬åœ°å®‰è£…MongoDB"></a>2.1 æœ¬åœ°å®‰è£…MongoDB</h4><p>è¯·è®¿é—® MongoDBå®‰è£…æŒ‡å— å®‰è£…ã€‚å¯åŠ¨æœåŠ¡ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod</span><br></pre></td></tr></table></figure><h4 id="2-2-ä½¿ç”¨Dockerè¿è¡ŒMongoDB"><a href="#2-2-ä½¿ç”¨Dockerè¿è¡ŒMongoDB" class="headerlink" title="2.2 ä½¿ç”¨Dockerè¿è¡ŒMongoDB"></a>2.2 ä½¿ç”¨Dockerè¿è¡ŒMongoDB</h4><p>è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 27017:27017 --name mongodb mongo:latest</span><br></pre></td></tr></table></figure><h2 id="ğŸ¦•-DenoåŸºç¡€ç”¨æ³•"><a href="#ğŸ¦•-DenoåŸºç¡€ç”¨æ³•" class="headerlink" title="ğŸ¦• DenoåŸºç¡€ç”¨æ³•"></a>ğŸ¦• DenoåŸºç¡€ç”¨æ³•</h2><h2 id="âš¡-å¸¸ç”¨å‘½ä»¤"><a href="#âš¡-å¸¸ç”¨å‘½ä»¤" class="headerlink" title="âš¡ å¸¸ç”¨å‘½ä»¤"></a>âš¡ å¸¸ç”¨å‘½ä»¤</h2><p>é¡¹ç›®ä¸­å®šä¹‰äº†å¤šä¸ªDenoä»»åŠ¡ï¼Œå¯ä»¥é€šè¿‡<code>deno task &lt;task_name&gt;</code>æ‰§è¡Œï¼š</p><table><thead><tr><th>å‘½ä»¤</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>deno task dev</code></td><td>å¼€å‘æ¨¡å¼å¯åŠ¨</td></tr><tr><td><code>deno task start</code></td><td>ç”Ÿäº§æ¨¡å¼å¯åŠ¨</td></tr><tr><td><code>deno task hot-reload</code></td><td>çƒ­é‡è½½æ¨¡å¼</td></tr><tr><td><code>deno task test</code></td><td>è¿è¡Œæµ‹è¯•</td></tr><tr><td><code>deno task mongo:init</code></td><td>åˆå§‹åŒ–MongoDB</td></tr><tr><td><code>deno task mongo:generate-mbti</code></td><td>ç”ŸæˆMBTIæµ‹è¯•æ•°æ®</td></tr><tr><td><code>deno run task -- watch</code></td><td>ç›‘å¬æ–‡ä»¶å˜åŒ–</td></tr></tbody></table><h3 id="æ–‡ä»¶æ“ä½œ"><a href="#æ–‡ä»¶æ“ä½œ" class="headerlink" title="æ–‡ä»¶æ“ä½œ"></a>æ–‡ä»¶æ“ä½œ</h3><h4 id="è¯»å–æ–‡ä»¶"><a href="#è¯»å–æ–‡ä»¶" class="headerlink" title="è¯»å–æ–‡ä»¶"></a>è¯»å–æ–‡ä»¶</h4><p>Denoæä¾›äº†ç®€å•ç›´è§‚çš„æ–‡ä»¶APIï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŒæ­¥è¯»å–æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">const</span> text = <span class="title class_">Deno</span>.<span class="title function_">readTextFileSync</span>(<span class="string">&quot;./data/config.json&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(text);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼‚æ­¥è¯»å–æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> text = <span class="keyword">await</span> <span class="title class_">Deno</span>.<span class="title function_">readTextFile</span>(<span class="string">&quot;./data/users.json&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> users = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(text);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(users);</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;è¯»å–æ–‡ä»¶å¤±è´¥:&quot;</span>, error);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»å–äºŒè¿›åˆ¶æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title class_">Deno</span>.<span class="title function_">readFile</span>(<span class="string">&quot;./assets/image.png&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="å†™å…¥æ–‡ä»¶"><a href="#å†™å…¥æ–‡ä»¶" class="headerlink" title="å†™å…¥æ–‡ä»¶"></a>å†™å…¥æ–‡ä»¶</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŒæ­¥å†™å…¥æ–‡æœ¬æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">const</span> data = &#123; <span class="attr">name</span>: <span class="string">&quot;Test User&quot;</span>, <span class="attr">email</span>: <span class="string">&quot;test@example.com&quot;</span> &#125;;</span><br><span class="line"><span class="title class_">Deno</span>.<span class="title function_">writeTextFileSync</span>(<span class="string">&quot;./data/user.json&quot;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data, <span class="literal">null</span>, <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼‚æ­¥å†™å…¥æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">await</span> <span class="title class_">Deno</span>.<span class="title function_">writeTextFile</span>(<span class="string">&quot;./logs/app.log&quot;</span>, <span class="string">`[<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().toISOString()&#125;</span>] Server started\n`</span>, &#123; <span class="attr">append</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å†™å…¥äºŒè¿›åˆ¶æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">await</span> <span class="title class_">Deno</span>.<span class="title function_">writeFile</span>(<span class="string">&quot;./output/data.bin&quot;</span>, <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]));</span><br></pre></td></tr></table></figure><h4 id="æ–‡ä»¶æ“ä½œå·¥å…·å‡½æ•°"><a href="#æ–‡ä»¶æ“ä½œå·¥å…·å‡½æ•°" class="headerlink" title="æ–‡ä»¶æ“ä½œå·¥å…·å‡½æ•°"></a>æ–‡ä»¶æ“ä½œå·¥å…·å‡½æ•°</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fileExists</span>(<span class="params"><span class="attr">path</span>: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">Deno</span>.<span class="title function_">stat</span>(path);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="keyword">if</span> (error <span class="keyword">instanceof</span> <span class="title class_">Deno</span>.<span class="property">errors</span>.<span class="property">NotFound</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> error;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">ensureDir</span>(<span class="params"><span class="attr">dir</span>: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> fileInfo = <span class="keyword">await</span> <span class="title class_">Deno</span>.<span class="title function_">stat</span>(dir);</span><br><span class="line">    <span class="keyword">if</span> (!fileInfo.<span class="property">isDirectory</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`è·¯å¾„å­˜åœ¨ä½†ä¸æ˜¯ç›®å½•: <span class="subst">$&#123;dir&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="keyword">if</span> (error <span class="keyword">instanceof</span> <span class="title class_">Deno</span>.<span class="property">errors</span>.<span class="property">NotFound</span>) &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="title class_">Deno</span>.<span class="title function_">mkdir</span>(dir, &#123; <span class="attr">recursive</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> error;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¤„ç†é™æ€èµ„æº"><a href="#å¤„ç†é™æ€èµ„æº" class="headerlink" title="å¤„ç†é™æ€èµ„æº"></a>å¤„ç†é™æ€èµ„æº</h3><p>åœ¨Oak HTTPæœåŠ¡å™¨æ¡†æ¶ä¸­ä½¿ç”¨é™æ€æ–‡ä»¶ä¸­é—´ä»¶ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Application</span>, <span class="title class_">Router</span> &#125; <span class="keyword">from</span> <span class="string">&quot;oak&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; send &#125; <span class="keyword">from</span> <span class="string">&quot;https://deno.land/x/oak@v12.6.1/send.ts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Application</span>();</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// é™æ€æ–‡ä»¶å¤„ç†ä¸­é—´ä»¶</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// å¤„ç†é™æ€æ–‡ä»¶è¯·æ±‚</span></span><br><span class="line">    <span class="keyword">if</span> (ctx.<span class="property">request</span>.<span class="property">url</span>.<span class="property">pathname</span>.<span class="title function_">startsWith</span>(<span class="string">&quot;/static&quot;</span>)) &#123;</span><br><span class="line">      <span class="keyword">const</span> path = ctx.<span class="property">request</span>.<span class="property">url</span>.<span class="property">pathname</span>.<span class="title function_">replace</span>(<span class="string">&quot;/static&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">send</span>(ctx, path, &#123;</span><br><span class="line">        <span class="attr">root</span>: <span class="string">`<span class="subst">$&#123;Deno.cwd()&#125;</span>/public`</span>,</span><br><span class="line">        <span class="attr">index</span>: <span class="string">&quot;index.html&quot;</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="keyword">if</span> (err.<span class="property">status</span> !== <span class="number">404</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰é™æ€æ–‡ä»¶æœåŠ¡å‡½æ•°</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">serveStaticFile</span>(<span class="params"><span class="attr">ctx</span>: <span class="title class_">Context</span>, <span class="attr">filePath</span>: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> fullPath = <span class="string">`<span class="subst">$&#123;Deno.cwd()&#125;</span>/public/<span class="subst">$&#123;filePath&#125;</span>`</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="title class_">Deno</span>.<span class="title function_">stat</span>(fullPath);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="keyword">if</span> (error <span class="keyword">instanceof</span> <span class="title class_">Deno</span>.<span class="property">errors</span>.<span class="property">NotFound</span>) &#123;</span><br><span class="line">        ctx.<span class="property">response</span>.<span class="property">status</span> = <span class="number">404</span>;</span><br><span class="line">        ctx.<span class="property">response</span>.<span class="property">body</span> = &#123; <span class="attr">error</span>: <span class="string">&quot;File not found&quot;</span> &#125;;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">throw</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¾ç½®å†…å®¹ç±»å‹</span></span><br><span class="line">    <span class="keyword">let</span> contentType = <span class="string">&quot;application/octet-stream&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (filePath.<span class="title function_">endsWith</span>(<span class="string">&quot;.html&quot;</span>)) contentType = <span class="string">&quot;text/html&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (filePath.<span class="title function_">endsWith</span>(<span class="string">&quot;.css&quot;</span>)) contentType = <span class="string">&quot;text/css&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (filePath.<span class="title function_">endsWith</span>(<span class="string">&quot;.js&quot;</span>)) contentType = <span class="string">&quot;text/javascript&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (filePath.<span class="title function_">endsWith</span>(<span class="string">&quot;.json&quot;</span>)) contentType = <span class="string">&quot;application/json&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (filePath.<span class="title function_">endsWith</span>(<span class="string">&quot;.png&quot;</span>)) contentType = <span class="string">&quot;image/png&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (filePath.<span class="title function_">endsWith</span>(<span class="string">&quot;.jpg&quot;</span>) || filePath.<span class="title function_">endsWith</span>(<span class="string">&quot;.jpeg&quot;</span>)) contentType = <span class="string">&quot;image/jpeg&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¯»å–å¹¶å‘é€æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">const</span> content = <span class="keyword">await</span> <span class="title class_">Deno</span>.<span class="title function_">readFile</span>(fullPath);</span><br><span class="line">    ctx.<span class="property">response</span>.<span class="property">headers</span>.<span class="title function_">set</span>(<span class="string">&quot;Content-Type&quot;</span>, contentType);</span><br><span class="line">    ctx.<span class="property">response</span>.<span class="property">body</span> = content;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`æä¾›é™æ€æ–‡ä»¶å¤±è´¥: <span class="subst">$&#123;filePath&#125;</span>`</span>, error);</span><br><span class="line">    ctx.<span class="property">response</span>.<span class="property">status</span> = <span class="number">500</span>;</span><br><span class="line">    ctx.<span class="property">response</span>.<span class="property">body</span> = &#123; <span class="attr">error</span>: <span class="string">&quot;Internal server error&quot;</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/images/:filename&quot;</span>, <span class="title function_">async</span> (ctx) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> filename = ctx.<span class="property">params</span>.<span class="property">filename</span>;</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">serveStaticFile</span>(ctx, <span class="string">`images/<span class="subst">$&#123;filename&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨Webæ ‡å‡†API"><a href="#ä½¿ç”¨Webæ ‡å‡†API" class="headerlink" title="ä½¿ç”¨Webæ ‡å‡†API"></a>ä½¿ç”¨Webæ ‡å‡†API</h3><p>Denoä½¿ç”¨Webæ ‡å‡†APIè¿›è¡Œå¼€å‘ï¼Œæ— éœ€é¢å¤–çš„åº“ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨fetch APIå‘èµ·ç½‘ç»œè¯·æ±‚</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchData</span>(<span class="params"><span class="attr">url</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(url);</span><br><span class="line">    <span class="keyword">if</span> (!response.<span class="property">ok</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`HTTPé”™è¯¯: <span class="subst">$&#123;response.status&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;è¯·æ±‚å¤±è´¥:&quot;</span>, error);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨URL APIè§£æURL</span></span><br><span class="line"><span class="keyword">const</span> url = <span class="keyword">new</span> <span class="title function_">URL</span>(<span class="string">&quot;https://example.com/api/users?page=1&amp;limit=10&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(url.<span class="property">searchParams</span>.<span class="title function_">get</span>(<span class="string">&quot;page&quot;</span>)); <span class="comment">// &quot;1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨EventTarget</span></span><br><span class="line"><span class="keyword">const</span> target = <span class="keyword">new</span> <span class="title class_">EventTarget</span>();</span><br><span class="line">target.<span class="title function_">addEventListener</span>(<span class="string">&quot;message&quot;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;æ”¶åˆ°æ¶ˆæ¯:&quot;</span>, event.<span class="property">detail</span>);</span><br><span class="line">&#125;);</span><br><span class="line">target.<span class="title function_">dispatchEvent</span>(<span class="keyword">new</span> <span class="title class_">CustomEvent</span>(<span class="string">&quot;message&quot;</span>, &#123; <span class="attr">detail</span>: <span class="string">&quot;Hello Deno!&quot;</span> &#125;));</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨Web-Worker"><a href="#ä½¿ç”¨Web-Worker" class="headerlink" title="ä½¿ç”¨Web Worker"></a>ä½¿ç”¨Web Worker</h3><p>Denoæ”¯æŒå¤šçº¿ç¨‹å¤„ç†ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.ts</span></span><br><span class="line"><span class="comment">// åˆ›å»ºWeb Worker</span></span><br><span class="line"><span class="keyword">const</span> worker = <span class="keyword">new</span> <span class="title class_">Worker</span>(<span class="keyword">new</span> <span class="title function_">URL</span>(<span class="string">&quot;./worker.ts&quot;</span>, <span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">url</span>).<span class="property">href</span>, &#123; <span class="attr">type</span>: <span class="string">&quot;module&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘é€æ¶ˆæ¯åˆ°Worker</span></span><br><span class="line">worker.<span class="title function_">postMessage</span>(&#123; <span class="attr">type</span>: <span class="string">&quot;process&quot;</span>, <span class="attr">data</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>] &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤„ç†Workerè¿”å›çš„æ¶ˆæ¯</span></span><br><span class="line">worker.<span class="property">onmessage</span> = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Workerç»“æœ:&quot;</span>, e.<span class="property">data</span>);</span><br><span class="line">  <span class="comment">// å®Œæˆåç»ˆæ­¢Worker</span></span><br><span class="line">  worker.<span class="title function_">terminate</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// worker.ts</span></span><br><span class="line"><span class="comment">// æ¥æ”¶å¹¶å¤„ç†ä¸»çº¿ç¨‹æ¶ˆæ¯</span></span><br><span class="line">self.<span class="property">onmessage</span> = <span class="title function_">async</span> (e) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="keyword">type</span>, data &#125; = e.<span class="property">data</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">type</span> === <span class="string">&quot;process&quot;</span>) &#123;</span><br><span class="line">    <span class="comment">// æ‰§è¡Œè€—æ—¶æ“ä½œ</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">processData</span>(data);</span><br><span class="line">    <span class="comment">// è¿”å›ç»“æœç»™ä¸»çº¿ç¨‹</span></span><br><span class="line">    self.<span class="title function_">postMessage</span>(result);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">processData</span>(<span class="params"><span class="attr">numbers</span>: <span class="built_in">number</span>[]</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">number</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶è®¡ç®—</span></span><br><span class="line">  <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(resolve, <span class="number">1000</span>));</span><br><span class="line">  <span class="keyword">return</span> numbers.<span class="title function_">reduce</span>(<span class="function">(<span class="params">sum, num</span>) =&gt;</span> sum + num, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ‰§è¡ŒShellå‘½ä»¤"><a href="#æ‰§è¡ŒShellå‘½ä»¤" class="headerlink" title="æ‰§è¡ŒShellå‘½ä»¤"></a>æ‰§è¡ŒShellå‘½ä»¤</h3><p>Denoæä¾›APIæ‰§è¡Œå­è¿›ç¨‹ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç®€å•å‘½ä»¤æ‰§è¡Œ</span></span><br><span class="line"><span class="keyword">const</span> process = <span class="title class_">Deno</span>.<span class="title function_">run</span>(&#123;</span><br><span class="line">  <span class="attr">cmd</span>: [<span class="string">&quot;ls&quot;</span>, <span class="string">&quot;-la&quot;</span>],</span><br><span class="line">  <span class="attr">stdout</span>: <span class="string">&quot;piped&quot;</span>,</span><br><span class="line">  <span class="attr">stderr</span>: <span class="string">&quot;piped&quot;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­‰å¾…å‘½ä»¤å®Œæˆå¹¶è·å–è¾“å‡º</span></span><br><span class="line"><span class="keyword">const</span> &#123; code &#125; = <span class="keyword">await</span> process.<span class="title function_">status</span>();</span><br><span class="line"><span class="keyword">if</span> (code === <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> output = <span class="keyword">await</span> process.<span class="title function_">output</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">new</span> <span class="title class_">TextDecoder</span>().<span class="title function_">decode</span>(output));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> errorOutput = <span class="keyword">await</span> process.<span class="title function_">stderrOutput</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="keyword">new</span> <span class="title class_">TextDecoder</span>().<span class="title function_">decode</span>(errorOutput));</span><br><span class="line">&#125;</span><br><span class="line">process.<span class="title function_">close</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¼ é€’ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="keyword">const</span> process = <span class="title class_">Deno</span>.<span class="title function_">run</span>(&#123;</span><br><span class="line">  <span class="attr">cmd</span>: [<span class="string">&quot;printenv&quot;</span>, <span class="string">&quot;MY_VARIABLE&quot;</span>],</span><br><span class="line">  <span class="attr">env</span>: &#123; <span class="string">&quot;MY_VARIABLE&quot;</span>: <span class="string">&quot;Hello Deno!&quot;</span> &#125;,</span><br><span class="line">  <span class="attr">stdout</span>: <span class="string">&quot;piped&quot;</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨WebSocket"><a href="#ä½¿ç”¨WebSocket" class="headerlink" title="ä½¿ç”¨WebSocket"></a>ä½¿ç”¨WebSocket</h3><p>Denoæ”¯æŒWebSocketè¿›è¡Œå®æ—¶é€šä¿¡ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æœåŠ¡ç«¯WebSocket</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Application</span> &#125; <span class="keyword">from</span> <span class="string">&quot;oak&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Server</span> &#125; <span class="keyword">from</span> <span class="string">&quot;https://deno.land/std@0.196.0/http/server.ts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">WebSocketServer</span> &#125; <span class="keyword">from</span> <span class="string">&quot;https://deno.land/x/websocket@v0.1.4/mod.ts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºWebSocketæœåŠ¡å™¨</span></span><br><span class="line"><span class="keyword">const</span> wss = <span class="keyword">new</span> <span class="title class_">WebSocketServer</span>(&#123; <span class="attr">port</span>: <span class="number">8080</span> &#125;);</span><br><span class="line"></span><br><span class="line">wss.<span class="title function_">on</span>(<span class="string">&quot;connection&quot;</span>, <span class="function">(<span class="params">ws</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;æ–°å®¢æˆ·ç«¯è¿æ¥&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å¤„ç†æ¶ˆæ¯</span></span><br><span class="line">  ws.<span class="title function_">on</span>(<span class="string">&quot;message&quot;</span>, <span class="function">(<span class="params">message</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;æ”¶åˆ°æ¶ˆæ¯:&quot;</span>, message);</span><br><span class="line">    <span class="comment">// å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰å®¢æˆ·ç«¯</span></span><br><span class="line">    wss.<span class="property">clients</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">client</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (client.<span class="property">readyState</span> === <span class="title class_">WebSocket</span>.<span class="property">OPEN</span>) &#123;</span><br><span class="line">        client.<span class="title function_">send</span>(<span class="string">`æœåŠ¡å™¨æ—¶é—´: <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().toISOString()&#125;</span>, æ¶ˆæ¯: <span class="subst">$&#123;message&#125;</span>`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å¤„ç†è¿æ¥å…³é—­</span></span><br><span class="line">  ws.<span class="title function_">on</span>(<span class="string">&quot;close&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;å®¢æˆ·ç«¯æ–­å¼€è¿æ¥&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®¢æˆ·ç«¯WebSocket</span></span><br><span class="line"><span class="keyword">const</span> socket = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&quot;ws://localhost:8080&quot;</span>);</span><br><span class="line"></span><br><span class="line">socket.<span class="property">onopen</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;è¿æ¥å·²å»ºç«‹&quot;</span>);</span><br><span class="line">  socket.<span class="title function_">send</span>(<span class="string">&quot;Hello Server!&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">socket.<span class="property">onmessage</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;æ”¶åˆ°æ¶ˆæ¯:&quot;</span>, event.<span class="property">data</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">socket.<span class="property">onclose</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;è¿æ¥å·²å…³é—­&quot;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><hr><h2 id="ğŸ”-ç¯å¢ƒå˜é‡"><a href="#ğŸ”-ç¯å¢ƒå˜é‡" class="headerlink" title="ğŸ” ç¯å¢ƒå˜é‡"></a>ğŸ” ç¯å¢ƒå˜é‡</h2><p>é¡¹ç›®é€šè¿‡<code>.env</code>æ–‡ä»¶å’Œ<code>Deno.env.get()</code>æ–¹æ³•ç®¡ç†ç¯å¢ƒå˜é‡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MONGODB_URI=mongodb://[username]:[password]@[host]/</span><br><span class="line">MONGODB_DATABASE=database_name</span><br></pre></td></tr></table></figure><blockquote><p>âš ï¸ <strong>è­¦å‘Š</strong>: åˆ‡å‹¿å°†åŒ…å«æ•æ„Ÿä¿¡æ¯çš„.envæ–‡ä»¶æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿã€‚</p></blockquote><hr><h2 id="ğŸ›¡ï¸-æƒé™ç®¡ç†"><a href="#ğŸ›¡ï¸-æƒé™ç®¡ç†" class="headerlink" title="ğŸ›¡ï¸ æƒé™ç®¡ç†"></a>ğŸ›¡ï¸ æƒé™ç®¡ç†</h2><p>Denoéœ€è¦æ˜ç¡®çš„æƒé™æ‰èƒ½è®¿é—®ç³»ç»Ÿèµ„æºï¼š</p><table><thead><tr><th>æƒé™æ ‡å¿—</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>--allow-net</code></td><td>ç½‘ç»œè®¿é—®æƒé™</td></tr><tr><td><code>--allow-env</code></td><td>ç¯å¢ƒå˜é‡è®¿é—®æƒé™</td></tr><tr><td><code>--allow-read</code></td><td>æ–‡ä»¶è¯»å–æƒé™</td></tr><tr><td><code>--allow-write</code></td><td>æ–‡ä»¶å†™å…¥æƒé™</td></tr><tr><td><code>--allow-sys</code></td><td>ç³»ç»Ÿä¿¡æ¯è®¿é—®æƒé™</td></tr></tbody></table><p>åœ¨<code>deno.json</code>ä¸­ï¼Œè¿™äº›æƒé™å·²é€šè¿‡taské…ç½®è¿›è¡Œé¢„è®¾ã€‚</p><hr><h2 id="ğŸ“¦-ç¬¬ä¸‰æ–¹åº“å’Œä¾èµ–ç®¡ç†"><a href="#ğŸ“¦-ç¬¬ä¸‰æ–¹åº“å’Œä¾èµ–ç®¡ç†" class="headerlink" title="ğŸ“¦ ç¬¬ä¸‰æ–¹åº“å’Œä¾èµ–ç®¡ç†"></a>ğŸ“¦ ç¬¬ä¸‰æ–¹åº“å’Œä¾èµ–ç®¡ç†</h2><h3 id="å¸¸ç”¨ç¬¬ä¸‰æ–¹åº“"><a href="#å¸¸ç”¨ç¬¬ä¸‰æ–¹åº“" class="headerlink" title="å¸¸ç”¨ç¬¬ä¸‰æ–¹åº“"></a>å¸¸ç”¨ç¬¬ä¸‰æ–¹åº“</h3><table><thead><tr><th>åº“å</th><th>æ¥æº</th><th>ä½œç”¨</th><th>ç”¨æ³•ç¤ºä¾‹</th></tr></thead><tbody><tr><td><strong>Oak</strong></td><td>JSR</td><td>HTTPæœåŠ¡å™¨æ¡†æ¶</td><td><code>import &#123; Application &#125; from &quot;oak&quot;;</code></td></tr><tr><td><strong>Mongoose</strong></td><td>npm</td><td>MongoDBå¯¹è±¡å»ºæ¨¡å·¥å…·</td><td><code>import mongoose from &quot;mongoose&quot;;</code></td></tr><tr><td><strong>Zod</strong></td><td>npm</td><td>ç±»å‹éªŒè¯åº“</td><td><code>import &#123; z &#125; from &quot;zod&quot;;</code></td></tr><tr><td><strong>std&#x2F;assert</strong></td><td>JSR</td><td>æ–­è¨€åº“</td><td><code>import &#123; assertEquals &#125; from &quot;@std/assert&quot;;</code></td></tr><tr><td><strong>cliffy</strong></td><td>deno.land</td><td>CLIæ¡†æ¶å’Œå·¥å…·</td><td><code>import &#123; Command &#125; from &quot;cliffy&quot;;</code></td></tr><tr><td><strong>Fresh</strong></td><td>JSR</td><td>Webæ¡†æ¶</td><td><code>import &#123; defineConfig &#125; from &quot;fresh&quot;;</code></td></tr><tr><td><strong>MD5</strong></td><td>npm</td><td>å“ˆå¸ŒåŠ å¯†ç®—æ³•</td><td><code>import md5 from &quot;md5&quot;;</code></td></tr><tr><td><strong>AJV</strong></td><td>esm.sh</td><td>JSON SchemaéªŒè¯å™¨</td><td><code>import Ajv from &quot;ajv&quot;;</code></td></tr><tr><td><strong>JWT</strong></td><td>deno.land</td><td>JSON Web Tokenå¤„ç†</td><td><code>import &#123; create, verify &#125; from &quot;djwt&quot;;</code></td></tr></tbody></table><h3 id="æ•°æ®éªŒè¯ä¸å®‰å…¨ç›¸å…³åº“"><a href="#æ•°æ®éªŒè¯ä¸å®‰å…¨ç›¸å…³åº“" class="headerlink" title="æ•°æ®éªŒè¯ä¸å®‰å…¨ç›¸å…³åº“"></a>æ•°æ®éªŒè¯ä¸å®‰å…¨ç›¸å…³åº“</h3><h4 id="1-AJV-å’Œ-JSON-Schema"><a href="#1-AJV-å’Œ-JSON-Schema" class="headerlink" title="1. AJV å’Œ JSON Schema"></a>1. AJV å’Œ JSON Schema</h4><p><a href="https://ajv.js.org/">AJV</a>æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„JSON SchemaéªŒè¯å™¨ï¼Œç”¨äºéªŒè¯æ•°æ®ç»“æ„æ˜¯å¦ç¬¦åˆé¢„å®šä¹‰çš„æ¨¡å¼ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Ajv</span> <span class="keyword">from</span> <span class="string">&quot;ajv&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> addFormats <span class="keyword">from</span> <span class="string">&quot;ajv-formats&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–AJV</span></span><br><span class="line"><span class="keyword">const</span> ajv = <span class="keyword">new</span> <span class="title class_">Ajv</span>(&#123;</span><br><span class="line">  <span class="attr">allErrors</span>: <span class="literal">true</span>,      <span class="comment">// æŠ¥å‘Šæ‰€æœ‰é”™è¯¯ï¼ˆè€Œä¸æ˜¯ç¬¬ä¸€ä¸ªï¼‰</span></span><br><span class="line">  <span class="attr">removeAdditional</span>: <span class="literal">true</span>, <span class="comment">// åˆ é™¤schemaä¸­æœªå®šä¹‰çš„å±æ€§</span></span><br><span class="line">  <span class="attr">useDefaults</span>: <span class="literal">true</span>     <span class="comment">// ä½¿ç”¨æ¨¡å¼ä¸­å®šä¹‰çš„é»˜è®¤å€¼</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ æ ¼å¼éªŒè¯</span></span><br><span class="line"><span class="title function_">addFormats</span>(ajv);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰JSON Schema</span></span><br><span class="line"><span class="keyword">const</span> userSchema = &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">  <span class="attr">properties</span>: &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123; <span class="attr">type</span>: <span class="string">&quot;string&quot;</span> &#125;,</span><br><span class="line">    <span class="attr">name</span>: &#123; <span class="attr">type</span>: <span class="string">&quot;string&quot;</span>, <span class="attr">minLength</span>: <span class="number">2</span> &#125;,</span><br><span class="line">    <span class="attr">email</span>: &#123; <span class="attr">type</span>: <span class="string">&quot;string&quot;</span>, <span class="attr">format</span>: <span class="string">&quot;email&quot;</span> &#125;,</span><br><span class="line">    <span class="attr">age</span>: &#123; <span class="attr">type</span>: <span class="string">&quot;number&quot;</span>, <span class="attr">minimum</span>: <span class="number">0</span> &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">required</span>: [<span class="string">&quot;id&quot;</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;email&quot;</span>],</span><br><span class="line">  <span class="attr">additionalProperties</span>: <span class="literal">false</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¼–è¯‘schemaä»¥ä¾¿é‡å¤ä½¿ç”¨</span></span><br><span class="line"><span class="keyword">const</span> validateUser = ajv.<span class="title function_">compile</span>(userSchema);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨å°è£…çš„éªŒè¯å·¥å…·</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">validateData</span>(<span class="params"><span class="attr">data</span>: <span class="built_in">unknown</span>, <span class="attr">schema</span>: <span class="built_in">object</span></span>): &#123; <span class="attr">isValid</span>: <span class="built_in">boolean</span>; <span class="attr">errors</span>: <span class="built_in">any</span>[] &#125; &#123;</span><br><span class="line">  <span class="keyword">const</span> validate = ajv.<span class="title function_">compile</span>(schema);</span><br><span class="line">  <span class="keyword">const</span> isValid = <span class="title function_">validate</span>(data);</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    isValid,</span><br><span class="line">    <span class="attr">errors</span>: isValid ? [] : (validate.<span class="property">errors</span> || [])</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¤ºä¾‹ä½¿ç”¨</span></span><br><span class="line"><span class="keyword">const</span> result = <span class="title function_">validateData</span>(userData, userSchema);</span><br><span class="line"><span class="keyword">if</span> (!result.<span class="property">isValid</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;æ•°æ®éªŒè¯å¤±è´¥:&quot;</span>, result.<span class="property">errors</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æœ€ä½³å®è·µï¼š</strong></p><ul><li>é›†ä¸­ç®¡ç†æ‰€æœ‰JSON Schemaå®šä¹‰</li><li>ä¸ºå¤æ‚APIåˆ›å»ºå¯é‡ç”¨çš„éªŒè¯å‡½æ•°</li><li>ä½¿ç”¨AJVçš„è‡ªå®šä¹‰å…³é”®å­—å’Œæ ¼å¼æ‹“å±•ç‰¹å®šéœ€æ±‚</li><li>åœ¨APIç«¯ç‚¹å¤„ç†å‰éªŒè¯è¯·æ±‚æ•°æ®</li></ul><h4 id="2-MD5"><a href="#2-MD5" class="headerlink" title="2. MD5"></a>2. MD5</h4><p>MD5æ˜¯ä¸€ç§å¹¿æ³›ä½¿ç”¨çš„å“ˆå¸Œç®—æ³•ï¼Œåœ¨é¡¹ç›®ä¸­å¸¸ç”¨äºå¯†ç åŠ å¯†æˆ–ç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> md5 <span class="keyword">from</span> <span class="string">&quot;md5&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŸºæœ¬ä½¿ç”¨</span></span><br><span class="line"><span class="keyword">const</span> hash = <span class="title function_">md5</span>(<span class="string">&quot;some-string&quot;</span>); <span class="comment">// è¿”å›32å­—ç¬¦çš„å“ˆå¸Œå­—ç¬¦ä¸²</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨äºå¯†ç åŠ å¯†ï¼ˆæ¨èæ·»åŠ ç›å€¼ï¼‰</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hashPassword</span>(<span class="params"><span class="attr">password</span>: <span class="built_in">string</span>, <span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">md5</span>(password + salt);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨äºç”ŸæˆAPIè¯·æ±‚ç­¾å</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">generateSignature</span>(<span class="params"><span class="attr">params</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;, <span class="attr">secretKey</span>: <span class="built_in">string</span></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="comment">// æŒ‰å­—æ¯é¡ºåºæ’åºå‚æ•°</span></span><br><span class="line">  <span class="keyword">const</span> sortedKeys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(params).<span class="title function_">sort</span>();</span><br><span class="line">  <span class="keyword">let</span> signStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// æ„å»ºç­¾åå­—ç¬¦ä¸²</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">of</span> sortedKeys) &#123;</span><br><span class="line">    signStr += <span class="string">`<span class="subst">$&#123;key&#125;</span>=<span class="subst">$&#123;params[key]&#125;</span>&amp;`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// æ·»åŠ å¯†é’¥å¹¶ç”Ÿæˆæœ€ç»ˆç­¾å</span></span><br><span class="line">  signStr += secretKey;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">md5</span>(signStr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å®‰å…¨æç¤ºï¼š</strong></p><ul><li>âš ï¸ MD5ä¸å†è¢«è®¤ä¸ºæ˜¯å®‰å…¨çš„å¯†ç å“ˆå¸Œç®—æ³•</li><li>å¯¹äºå¯†ç å­˜å‚¨ï¼Œæ¨èä½¿ç”¨æ›´å®‰å…¨çš„ç®—æ³•å¦‚bcryptæˆ–Argon2</li><li>MD5é€‚ç”¨äºéå®‰å…¨åœºæ™¯å¦‚ç¼“å­˜é”®ç”Ÿæˆã€å†…å®¹å®Œæ•´æ€§æ ¡éªŒç­‰</li></ul><h4 id="3-JWT-JSON-Web-Token"><a href="#3-JWT-JSON-Web-Token" class="headerlink" title="3. JWT (JSON Web Token)"></a>3. JWT (JSON Web Token)</h4><p>JWTç”¨äºåˆ›å»ºå’ŒéªŒè¯ä»¤ç‰Œï¼Œå¸¸ç”¨äºèº«ä»½éªŒè¯å’Œæˆæƒï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; create, verify, decode &#125; <span class="keyword">from</span> <span class="string">&quot;djwt&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; crypto &#125; <span class="keyword">from</span> <span class="string">&quot;std/crypto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”Ÿæˆå¯†é’¥</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">generateKey</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">CryptoKey</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> crypto.<span class="property">subtle</span>.<span class="title function_">generateKey</span>(</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&quot;HMAC&quot;</span>, <span class="attr">hash</span>: <span class="string">&quot;SHA-512&quot;</span> &#125;,</span><br><span class="line">    <span class="literal">true</span>,</span><br><span class="line">    [<span class="string">&quot;sign&quot;</span>, <span class="string">&quot;verify&quot;</span>]</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºJWTä»¤ç‰Œ</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createToken</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">payload</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt;, </span></span><br><span class="line"><span class="params">  <span class="attr">expiresIn</span>: <span class="built_in">number</span> = <span class="number">60</span> * <span class="number">60</span> <span class="comment">// 1å°æ—¶ï¼Œä»¥ç§’ä¸ºå•ä½</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> key = <span class="keyword">await</span> <span class="title function_">generateKey</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> jwt = <span class="keyword">await</span> <span class="title function_">create</span>(</span><br><span class="line">    &#123; <span class="attr">alg</span>: <span class="string">&quot;HS512&quot;</span>, <span class="attr">typ</span>: <span class="string">&quot;JWT&quot;</span> &#125;,</span><br><span class="line">    &#123; </span><br><span class="line">      ...payload, </span><br><span class="line">      <span class="attr">exp</span>: <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Date</span>.<span class="title function_">now</span>() / <span class="number">1000</span>) + expiresIn </span><br><span class="line">    &#125;,</span><br><span class="line">    key</span><br><span class="line">  );</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> jwt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// éªŒè¯JWTä»¤ç‰Œ</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">verifyToken</span>(<span class="params"><span class="attr">token</span>: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt; | <span class="literal">null</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> key = <span class="keyword">await</span> <span class="title function_">generateKey</span>(); <span class="comment">// ç”Ÿäº§ç¯å¢ƒä¸­åº”è¯¥é‡ç”¨å¯†é’¥</span></span><br><span class="line">    <span class="keyword">const</span> payload = <span class="keyword">await</span> <span class="title function_">verify</span>(token, key);</span><br><span class="line">    <span class="keyword">return</span> payload;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;JWTéªŒè¯å¤±è´¥:&quot;</span>, err);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> userToken = <span class="keyword">await</span> <span class="title function_">createToken</span>(&#123; <span class="attr">userId</span>: <span class="string">&quot;123&quot;</span>, <span class="attr">role</span>: <span class="string">&quot;admin&quot;</span> &#125;);</span><br><span class="line"><span class="comment">// åœ¨è¯·æ±‚å¤´ä¸­ä½¿ç”¨: Authorization: Bearer &lt;token&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// èº«ä»½éªŒè¯ä¸­é—´ä»¶</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">authMiddleware</span>(<span class="params"><span class="attr">ctx</span>: <span class="title class_">Context</span>, <span class="attr">next</span>: <span class="title class_">Next</span></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> authHeader = ctx.<span class="property">request</span>.<span class="property">headers</span>.<span class="title function_">get</span>(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!authHeader || !authHeader.<span class="title function_">startsWith</span>(<span class="string">&quot;Bearer &quot;</span>)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;ç¼ºå°‘æœ‰æ•ˆçš„æˆæƒä»¤ç‰Œ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> token = authHeader.<span class="title function_">replace</span>(<span class="string">&quot;Bearer &quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> payload = <span class="keyword">await</span> <span class="title function_">verifyToken</span>(token);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!payload) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;æ— æ•ˆçš„ä»¤ç‰Œ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å°†ç”¨æˆ·ä¿¡æ¯é™„åŠ åˆ°ä¸Šä¸‹æ–‡</span></span><br><span class="line">    ctx.<span class="property">state</span>.<span class="property">user</span> = payload;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    ctx.<span class="property">response</span>.<span class="property">status</span> = <span class="number">401</span>;</span><br><span class="line">    ctx.<span class="property">response</span>.<span class="property">body</span> = &#123;</span><br><span class="line">      <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">code</span>: <span class="number">401</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&quot;æœªæˆæƒè®¿é—®&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>JWTæœ€ä½³å®è·µï¼š</strong></p><ul><li>è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ï¼Œé¿å…ä»¤ç‰Œæ°¸ä¹…æœ‰æ•ˆ</li><li>ä»…åœ¨ä»¤ç‰Œä¸­å­˜å‚¨å¿…è¦ä¿¡æ¯ï¼Œé¿å…å­˜å‚¨æ•æ„Ÿæ•°æ®</li><li>ä½¿ç”¨HTTPSä¼ è¾“ä»¤ç‰Œ</li><li>å®ç°ä»¤ç‰Œåˆ·æ–°æœºåˆ¶</li><li>è€ƒè™‘ä½¿ç”¨Redisç­‰å­˜å‚¨æœºåˆ¶æ¥æ”¯æŒä»¤ç‰ŒåŠé”€</li></ul><h3 id="å®é™…åº”ç”¨ç¤ºä¾‹"><a href="#å®é™…åº”ç”¨ç¤ºä¾‹" class="headerlink" title="å®é™…åº”ç”¨ç¤ºä¾‹"></a>å®é™…åº”ç”¨ç¤ºä¾‹</h3><h4 id="JSON-Schemaç”¨äºAPIéªŒè¯"><a href="#JSON-Schemaç”¨äºAPIéªŒè¯" class="headerlink" title="JSON Schemaç”¨äºAPIéªŒè¯"></a>JSON Schemaç”¨äºAPIéªŒè¯</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/schemas/user.schema.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> createUserSchema = &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">  <span class="attr">properties</span>: &#123;</span><br><span class="line">    <span class="attr">username</span>: &#123; <span class="attr">type</span>: <span class="string">&quot;string&quot;</span>, <span class="attr">minLength</span>: <span class="number">3</span>, <span class="attr">maxLength</span>: <span class="number">20</span> &#125;,</span><br><span class="line">    <span class="attr">email</span>: &#123; <span class="attr">type</span>: <span class="string">&quot;string&quot;</span>, <span class="attr">format</span>: <span class="string">&quot;email&quot;</span> &#125;,</span><br><span class="line">    <span class="attr">password</span>: &#123; <span class="attr">type</span>: <span class="string">&quot;string&quot;</span>, <span class="attr">minLength</span>: <span class="number">8</span> &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">required</span>: [<span class="string">&quot;username&quot;</span>, <span class="string">&quot;email&quot;</span>, <span class="string">&quot;password&quot;</span>],</span><br><span class="line">  <span class="attr">additionalProperties</span>: <span class="literal">false</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// src/middlewares/validate.middleware.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Context</span>, <span class="title class_">Next</span> &#125; <span class="keyword">from</span> <span class="string">&quot;oak&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; validateSchema &#125; <span class="keyword">from</span> <span class="string">&quot;../utils/json-schema.ts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">validateRequest</span>(<span class="params"><span class="attr">schema</span>: <span class="built_in">object</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">async</span> (<span class="attr">ctx</span>: <span class="title class_">Context</span>, <span class="attr">next</span>: <span class="title class_">Next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> body = <span class="keyword">await</span> ctx.<span class="property">request</span>.<span class="title function_">body</span>().<span class="property">value</span>;</span><br><span class="line">      <span class="keyword">const</span> &#123; isValid, errors &#125; = <span class="title function_">validateSchema</span>(body, schema);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (!isValid) &#123;</span><br><span class="line">        ctx.<span class="property">response</span>.<span class="property">status</span> = <span class="number">400</span>;</span><br><span class="line">        ctx.<span class="property">response</span>.<span class="property">body</span> = &#123;</span><br><span class="line">          <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">code</span>: <span class="number">400</span>,</span><br><span class="line">          <span class="attr">message</span>: <span class="string">&quot;è¯·æ±‚æ•°æ®éªŒè¯å¤±è´¥&quot;</span>,</span><br><span class="line">          <span class="attr">errors</span>: errors</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      ctx.<span class="property">response</span>.<span class="property">status</span> = <span class="number">400</span>;</span><br><span class="line">      ctx.<span class="property">response</span>.<span class="property">body</span> = &#123;</span><br><span class="line">        <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">code</span>: <span class="number">400</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&quot;æ— æ•ˆçš„è¯·æ±‚æ•°æ®&quot;</span></span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·¯ç”±ä¸­ä½¿ç”¨éªŒè¯ä¸­é—´ä»¶</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/api/users&quot;</span>, <span class="title function_">validateRequest</span>(createUserSchema), userController.<span class="property">createUser</span>);</span><br></pre></td></tr></table></figure><h4 id="MD5ç”¨äºç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦"><a href="#MD5ç”¨äºç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦" class="headerlink" title="MD5ç”¨äºç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦"></a>MD5ç”¨äºç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”Ÿæˆæµ‹è¯•ID</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">generateTestId</span>(<span class="params"><span class="attr">userId</span>: <span class="built_in">string</span>, <span class="attr">timestamp</span>: <span class="built_in">number</span></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">md5</span>(<span class="string">`<span class="subst">$&#123;userId&#125;</span>-<span class="subst">$&#123;timestamp&#125;</span>-<span class="subst">$&#123;<span class="built_in">Math</span>.random()&#125;</span>`</span>).<span class="title function_">substring</span>(<span class="number">0</span>, <span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MBTIæµ‹è¯•æäº¤</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">submitTest</span>(<span class="params"><span class="attr">testData</span>: <span class="title class_">MBTITestSubmission</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> now = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">  <span class="keyword">const</span> testId = <span class="title function_">generateTestId</span>(testData.<span class="property">user_id</span>, now.<span class="title function_">getTime</span>());</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å­˜å‚¨æµ‹è¯•æ•°æ®...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="JSR-DenoåŒ…æ³¨å†Œè¡¨"><a href="#JSR-DenoåŒ…æ³¨å†Œè¡¨" class="headerlink" title="JSR (DenoåŒ…æ³¨å†Œè¡¨)"></a>JSR (DenoåŒ…æ³¨å†Œè¡¨)</h3><p>JSRæ˜¯å®˜æ–¹çš„DenoåŒ…æ³¨å†Œè¡¨ï¼Œæä¾›TypeScriptå’ŒJavaScriptåŒ…ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»JSRå¯¼å…¥åŒ…</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Application</span>, <span class="title class_">Router</span> &#125; <span class="keyword">from</span> <span class="string">&quot;jsr:@oak/oak@^12.6.1&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; assertEquals &#125; <span class="keyword">from</span> <span class="string">&quot;jsr:@std/assert@1&quot;</span>;</span><br></pre></td></tr></table></figure><h4 id="åœ¨é¡¹ç›®ä¸­ä½¿ç”¨JSR"><a href="#åœ¨é¡¹ç›®ä¸­ä½¿ç”¨JSR" class="headerlink" title="åœ¨é¡¹ç›®ä¸­ä½¿ç”¨JSR"></a>åœ¨é¡¹ç›®ä¸­ä½¿ç”¨JSR</h4><ol><li>åœ¨<code>deno.json</code>ä¸­é…ç½®importsï¼š</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;imports&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@std/assert&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jsr:@std/assert@1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;oak&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jsr:@oak/oak@^12.6.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fresh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jsr:@denoland/fresh@^2.0.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>ç„¶ååœ¨ä»£ç ä¸­å¯¼å…¥ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Application</span> &#125; <span class="keyword">from</span> <span class="string">&quot;oak&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; assertEquals &#125; <span class="keyword">from</span> <span class="string">&quot;@std/assert&quot;</span>;</span><br></pre></td></tr></table></figure><h3 id="NPMæ”¯æŒ"><a href="#NPMæ”¯æŒ" class="headerlink" title="NPMæ”¯æŒ"></a>NPMæ”¯æŒ</h3><p>Denoæ”¯æŒç›´æ¥ä½¿ç”¨NPMåŒ…ï¼Œæ— éœ€è½¬æ¢æˆ–é¢å¤–å·¥å…·ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç›´æ¥ä»npmå¯¼å…¥</span></span><br><span class="line"><span class="keyword">import</span> mongoose <span class="keyword">from</span> <span class="string">&quot;npm:mongoose@^8.0.0&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; z &#125; <span class="keyword">from</span> <span class="string">&quot;npm:zod@^3.22.4&quot;</span>;</span><br></pre></td></tr></table></figure><h4 id="åœ¨é¡¹ç›®ä¸­ä½¿ç”¨NPMåŒ…"><a href="#åœ¨é¡¹ç›®ä¸­ä½¿ç”¨NPMåŒ…" class="headerlink" title="åœ¨é¡¹ç›®ä¸­ä½¿ç”¨NPMåŒ…"></a>åœ¨é¡¹ç›®ä¸­ä½¿ç”¨NPMåŒ…</h4><ol><li>åœ¨<code>deno.json</code>ä¸­é…ç½®importsï¼š</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;imports&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;mongoose&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npm:mongoose@^8.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;zod&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npm:zod@^3.22.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;md5&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npm:md5@^2.3.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>ç„¶ååœ¨ä»£ç ä¸­å¯¼å…¥ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mongoose <span class="keyword">from</span> <span class="string">&quot;mongoose&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; z &#125; <span class="keyword">from</span> <span class="string">&quot;zod&quot;</span>;</span><br></pre></td></tr></table></figure><h3 id="å…¶ä»–æºå¯¼å…¥"><a href="#å…¶ä»–æºå¯¼å…¥" class="headerlink" title="å…¶ä»–æºå¯¼å…¥"></a>å…¶ä»–æºå¯¼å…¥</h3><p>Denoè¿˜æ”¯æŒä»URLç›´æ¥å¯¼å…¥ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»URLå¯¼å…¥</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Command</span> &#125; <span class="keyword">from</span> <span class="string">&quot;https://deno.land/x/cliffy@v0.25.7/command/mod.ts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MySQLConnector</span> &#125; <span class="keyword">from</span> <span class="string">&quot;https://deno.land/x/mysql@v2.12.1/mod.ts&quot;</span>;</span><br></pre></td></tr></table></figure><h3 id="åŒ…ç‰ˆæœ¬ç®¡ç†"><a href="#åŒ…ç‰ˆæœ¬ç®¡ç†" class="headerlink" title="åŒ…ç‰ˆæœ¬ç®¡ç†"></a>åŒ…ç‰ˆæœ¬ç®¡ç†</h3><hr><h2 id="ğŸ“-é¡¹ç›®ç»“æ„"><a href="#ğŸ“-é¡¹ç›®ç»“æ„" class="headerlink" title="ğŸ“ é¡¹ç›®ç»“æ„"></a>ğŸ“ é¡¹ç›®ç»“æ„</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/</span><br><span class="line">â”œâ”€â”€ main.ts                # ä¸»å…¥å£æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ src/</span><br><span class="line">â”‚   â”œâ”€â”€ routes/            # è·¯ç”±å®šä¹‰</span><br><span class="line">â”‚   â”œâ”€â”€ controllers/       # æ§åˆ¶å™¨</span><br><span class="line">â”‚   â”œâ”€â”€ services/          # æœåŠ¡å±‚</span><br><span class="line">â”‚   â”œâ”€â”€ middleware/        # ä¸­é—´ä»¶</span><br><span class="line">â”‚   â”œâ”€â”€ utils/             # å·¥å…·å‡½æ•°</span><br><span class="line">â”‚   â”œâ”€â”€ scripts/           # è„šæœ¬æ–‡ä»¶</span><br><span class="line">â”‚   â””â”€â”€ examples/          # ç¤ºä¾‹ä»£ç </span><br><span class="line">â”œâ”€â”€ deno.json              # Denoé¡¹ç›®é…ç½®</span><br><span class="line">â””â”€â”€ .env                   # ç¯å¢ƒå˜é‡</span><br></pre></td></tr></table></figure><hr><h2 id="ğŸ”Œ-APIè·¯ç”±"><a href="#ğŸ”Œ-APIè·¯ç”±" class="headerlink" title="ğŸ”Œ APIè·¯ç”±"></a>ğŸ”Œ APIè·¯ç”±</h2><p>é¡¹ç›®ä½¿ç”¨Oak HTTPæœåŠ¡å™¨æ¡†æ¶å®šä¹‰è·¯ç”±ï¼Œä¸»è¦APIè·¯ç”±åŒ…æ‹¬ï¼š</p><h3 id="MBTIæµ‹è¯•API"><a href="#MBTIæµ‹è¯•API" class="headerlink" title="MBTIæµ‹è¯•API"></a>MBTIæµ‹è¯•API</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MBTIæµ‹è¯•ç›¸å…³è·¯ç”±</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/api/mbti/questions&quot;</span>, mbtiController.<span class="property">getQuestions</span>);</span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/api/mbti/types&quot;</span>, mbtiController.<span class="property">getAllTypes</span>);</span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/api/mbti/types/:type&quot;</span>, mbtiController.<span class="property">getTypeDetails</span>);</span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/api/mbti/roles&quot;</span>, mbtiController.<span class="property">getRoles</span>);</span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/api/mbti/test&quot;</span>, mbtiController.<span class="property">submitTest</span>);</span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/api/mbti/user/:userId/history&quot;</span>, authMiddleware, mbtiController.<span class="property">getUserTestHistory</span>);</span><br></pre></td></tr></table></figure><blockquote><p>ğŸ“ <strong>æ³¨æ„</strong>ï¼šç”¨æˆ·å†å²è®°å½•APIéœ€è¦èº«ä»½éªŒè¯ã€‚</p></blockquote><hr><h2 id="ğŸ“Š-æ•°æ®æ¨¡å‹"><a href="#ğŸ“Š-æ•°æ®æ¨¡å‹" class="headerlink" title="ğŸ“Š æ•°æ®æ¨¡å‹"></a>ğŸ“Š æ•°æ®æ¨¡å‹</h2><h3 id="MBTIç›¸å…³æ¨¡å‹"><a href="#MBTIç›¸å…³æ¨¡å‹" class="headerlink" title="MBTIç›¸å…³æ¨¡å‹"></a>MBTIç›¸å…³æ¨¡å‹</h3><details><summary><b>MBTIQuestion</b>: MBTIæµ‹è¯•é—®é¢˜</summary><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">MBTIQuestion</span> &#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="built_in">number</span>;</span><br><span class="line">  <span class="attr">question</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">options</span>: <span class="title class_">Array</span>&lt;&#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="built_in">string</span>;</span><br><span class="line">    <span class="attr">text</span>: <span class="built_in">string</span>;</span><br><span class="line">  &#125;&gt;;</span><br><span class="line">  <span class="attr">dimension</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><details><summary><b>MBTIType</b>: MBTIäººæ ¼ç±»å‹</summary><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">MBTIType</span> &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="built_in">string</span>;       <span class="comment">// å¦‚ &quot;INTJ-A&quot;</span></span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;       <span class="comment">// å¦‚ &quot;å»ºç­‘å¸ˆ&quot;</span></span><br><span class="line">  <span class="attr">title</span>: <span class="built_in">string</span>;      <span class="comment">// å¦‚ &quot;å»ºç­‘å¸ˆ (è‡ªä¿¡å‹)&quot;</span></span><br><span class="line">  <span class="attr">description</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">strengths</span>: <span class="built_in">string</span>[];</span><br><span class="line">  <span class="attr">weaknesses</span>: <span class="built_in">string</span>[];</span><br><span class="line">  <span class="attr">roles</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">careers</span>: <span class="built_in">string</span>[];</span><br><span class="line">  <span class="attr">famousPeople</span>: <span class="built_in">string</span>[];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><details><summary><b>MBTIRole</b>: MBTIè§’è‰²åˆ†ç±»</summary><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">MBTIRole</span> &#123;</span><br><span class="line">  <span class="attr">role</span>: <span class="built_in">string</span>;      <span class="comment">// å¦‚ &quot;åˆ†æå¸ˆ&quot;</span></span><br><span class="line">  <span class="attr">types</span>: <span class="built_in">string</span>[];   <span class="comment">// å¦‚ [&quot;INTJ&quot;, &quot;INTP&quot;, &quot;ENTJ&quot;, &quot;ENTP&quot;]</span></span><br><span class="line">  <span class="attr">description</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">traits</span>: <span class="built_in">string</span>[];</span><br><span class="line">  <span class="attr">color</span>: <span class="built_in">string</span>;     <span class="comment">// å¦‚ &quot;#88619A&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><details><summary><b>MBTITestResult</b>: æµ‹è¯•ç»“æœ</summary><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">MBTITestResult</span> &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="built_in">string</span>;  <span class="comment">// å¦‚ &quot;INTJ-A&quot;</span></span><br><span class="line">  <span class="attr">scores</span>: &#123;</span><br><span class="line">    <span class="attr">EI_E</span>: <span class="built_in">number</span>, <span class="attr">EI_I</span>: <span class="built_in">number</span>,</span><br><span class="line">    <span class="attr">SN_S</span>: <span class="built_in">number</span>, <span class="attr">SN_N</span>: <span class="built_in">number</span>,</span><br><span class="line">    <span class="attr">TF_T</span>: <span class="built_in">number</span>, <span class="attr">TF_F</span>: <span class="built_in">number</span>,</span><br><span class="line">    <span class="attr">JP_J</span>: <span class="built_in">number</span>, <span class="attr">JP_P</span>: <span class="built_in">number</span>,</span><br><span class="line">    <span class="attr">AT_A</span>: <span class="built_in">number</span>, <span class="attr">AT_T</span>: <span class="built_in">number</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="ğŸ§©-MBTIæµ‹è¯•å®ç°ç»†èŠ‚"><a href="#ğŸ§©-MBTIæµ‹è¯•å®ç°ç»†èŠ‚" class="headerlink" title="ğŸ§© MBTIæµ‹è¯•å®ç°ç»†èŠ‚"></a>ğŸ§© MBTIæµ‹è¯•å®ç°ç»†èŠ‚</h2><h3 id="1-æµ‹è¯•æµç¨‹"><a href="#1-æµ‹è¯•æµç¨‹" class="headerlink" title="1. æµ‹è¯•æµç¨‹"></a>1. æµ‹è¯•æµç¨‹</h3><pre><code class="highlight mermaid">graph LR    A[è·å–é—®é¢˜] --&gt; B[æäº¤ç­”æ¡ˆ]    B --&gt; C[è®¡ç®—ç»“æœ]    C --&gt; D[ä¿å­˜ç»“æœ]    D --&gt; E[æŸ¥çœ‹å†å²]</code></pre><ol><li>ç”¨æˆ·è·å–æµ‹è¯•é—®é¢˜ (<code>GET /api/mbti/questions</code>)</li><li>ç”¨æˆ·æäº¤æµ‹è¯•ç­”æ¡ˆ (<code>POST /api/mbti/test</code>)</li><li>ç³»ç»Ÿè®¡ç®—æµ‹è¯•ç»“æœå¹¶ä¿å­˜</li><li>ç”¨æˆ·å¯æŸ¥çœ‹æµ‹è¯•å†å² (<code>GET /api/mbti/user/:userId/history</code>)</li></ol><h3 id="2-ç»“æœè®¡ç®—é€»è¾‘"><a href="#2-ç»“æœè®¡ç®—é€»è¾‘" class="headerlink" title="2. ç»“æœè®¡ç®—é€»è¾‘"></a>2. ç»“æœè®¡ç®—é€»è¾‘</h3><details><summary>å±•å¼€æŸ¥çœ‹ç»“æœè®¡ç®—ä»£ç </summary><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">calculateTestResult</span>(<span class="attr">responses</span>: <span class="title class_">MBTITestResponse</span>[]): <span class="title class_">MBTITestResult</span> &#123;</span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–åˆ†æ•°</span></span><br><span class="line">  <span class="keyword">const</span> scores = &#123;</span><br><span class="line">    <span class="attr">EI_E</span>: <span class="number">0</span>, <span class="attr">EI_I</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">SN_S</span>: <span class="number">0</span>, <span class="attr">SN_N</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">TF_T</span>: <span class="number">0</span>, <span class="attr">TF_F</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">JP_J</span>: <span class="number">0</span>, <span class="attr">JP_P</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">AT_A</span>: <span class="number">0</span>, <span class="attr">AT_T</span>: <span class="number">0</span></span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ç´¯è®¡æ¯ä¸ªç»´åº¦çš„åˆ†æ•°</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> response <span class="keyword">of</span> responses) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (response.<span class="property">selected_value</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;E&#x27;</span>: scores.<span class="property">EI_E</span>++; <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;I&#x27;</span>: scores.<span class="property">EI_I</span>++; <span class="keyword">break</span>;</span><br><span class="line">      <span class="comment">// ...å…¶ä»–ç»´åº¦</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ç¡®å®šæ¯ä¸ªç»´åº¦çš„ä¸»å¯¼ç‰¹è´¨</span></span><br><span class="line">  <span class="keyword">const</span> <span class="variable constant_">E_I</span> = scores.<span class="property">EI_E</span> &gt; scores.<span class="property">EI_I</span> ? <span class="string">&#x27;E&#x27;</span> : <span class="string">&#x27;I&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="variable constant_">S_N</span> = scores.<span class="property">SN_S</span> &gt; scores.<span class="property">SN_N</span> ? <span class="string">&#x27;S&#x27;</span> : <span class="string">&#x27;N&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="variable constant_">T_F</span> = scores.<span class="property">TF_T</span> &gt; scores.<span class="property">TF_F</span> ? <span class="string">&#x27;T&#x27;</span> : <span class="string">&#x27;F&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="variable constant_">J_P</span> = scores.<span class="property">JP_J</span> &gt; scores.<span class="property">JP_P</span> ? <span class="string">&#x27;J&#x27;</span> : <span class="string">&#x27;P&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="variable constant_">A_T</span> = scores.<span class="property">AT_A</span> &gt; scores.<span class="property">AT_T</span> ? <span class="string">&#x27;A&#x27;</span> : <span class="string">&#x27;T&#x27;</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ç»„åˆMBTIç±»å‹</span></span><br><span class="line">  <span class="keyword">const</span> mbtiType = <span class="string">`<span class="subst">$&#123;E_I&#125;</span><span class="subst">$&#123;S_N&#125;</span><span class="subst">$&#123;T_F&#125;</span><span class="subst">$&#123;J_P&#125;</span>-<span class="subst">$&#123;A_T&#125;</span>`</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">type</span>: mbtiType,</span><br><span class="line">    scores</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-æ•°æ®åº“é›†åˆ"><a href="#3-æ•°æ®åº“é›†åˆ" class="headerlink" title="3. æ•°æ®åº“é›†åˆ"></a>3. æ•°æ®åº“é›†åˆ</h3><p>MBTIæµ‹è¯•ç³»ç»Ÿä½¿ç”¨äº†ä»¥ä¸‹MongoDBé›†åˆï¼š</p><table><thead><tr><th>é›†åˆåç§°</th><th>ç”¨é€”</th></tr></thead><tbody><tr><td><code>mbti_questions</code></td><td>å­˜å‚¨æµ‹è¯•é—®é¢˜</td></tr><tr><td><code>mbti_types</code></td><td>å­˜å‚¨MBTIç±»å‹æè¿°</td></tr><tr><td><code>mbti_roles</code></td><td>å­˜å‚¨MBTIè§’è‰²åˆ†ç±»</td></tr><tr><td><code>mbti_test_results</code></td><td>å­˜å‚¨ç”¨æˆ·æµ‹è¯•è®°å½•</td></tr></tbody></table><hr><h2 id="ğŸ—„ï¸-MongoDBæ•°æ®åº“æ“ä½œ"><a href="#ğŸ—„ï¸-MongoDBæ•°æ®åº“æ“ä½œ" class="headerlink" title="ğŸ—„ï¸ MongoDBæ•°æ®åº“æ“ä½œ"></a>ğŸ—„ï¸ MongoDBæ•°æ®åº“æ“ä½œ</h2><p>é¡¹ç›®ä½¿ç”¨è‡ªå®šä¹‰çš„<code>MongoDBService</code>ç±»è¿›è¡Œæ•°æ®åº“æ“ä½œï¼Œä¸»è¦æ–¹æ³•å¦‚ä¸‹ï¼š</p><h3 id="è¿æ¥æ•°æ®åº“"><a href="#è¿æ¥æ•°æ®åº“" class="headerlink" title="è¿æ¥æ•°æ®åº“"></a>è¿æ¥æ•°æ®åº“</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹åŒ–è¿æ¥</span></span><br><span class="line"><span class="keyword">const</span> mongoDBService = <span class="keyword">new</span> <span class="title class_">MongoDBService</span>(&#123;</span><br><span class="line">  <span class="attr">uri</span>: <span class="string">&quot;mongodb://[username]:[password]@[host]/&quot;</span>,</span><br><span class="line">  <span class="attr">dbName</span>: <span class="string">&quot;database_name&quot;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿æ¥æ•°æ®åº“</span></span><br><span class="line"><span class="keyword">await</span> mongoDBService.<span class="title function_">connect</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…³é—­è¿æ¥</span></span><br><span class="line"><span class="keyword">await</span> mongoDBService.<span class="title function_">close</span>();</span><br></pre></td></tr></table></figure><h3 id="åŸºæœ¬CRUDæ“ä½œ"><a href="#åŸºæœ¬CRUDæ“ä½œ" class="headerlink" title="åŸºæœ¬CRUDæ“ä½œ"></a>åŸºæœ¬CRUDæ“ä½œ</h3><details><summary>å±•å¼€æŸ¥çœ‹CRUDæ“ä½œç¤ºä¾‹</summary><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŸ¥è¯¢æ–‡æ¡£</span></span><br><span class="line"><span class="keyword">const</span> documents = <span class="keyword">await</span> mongoDBService.<span class="title function_">find</span>(<span class="string">&quot;collection_name&quot;</span>, &#123; <span class="attr">field</span>: <span class="string">&quot;value&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®IDæŸ¥è¯¢</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable language_">document</span> = <span class="keyword">await</span> mongoDBService.<span class="title function_">findById</span>(<span class="string">&quot;collection_name&quot;</span>, <span class="string">&quot;id&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ’å…¥æ–‡æ¡£</span></span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> mongoDBService.<span class="title function_">insertOne</span>(<span class="string">&quot;collection_name&quot;</span>, &#123; <span class="attr">field</span>: <span class="string">&quot;value&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰¹é‡æ’å…¥</span></span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> mongoDBService.<span class="title function_">insertMany</span>(<span class="string">&quot;collection_name&quot;</span>, [&#123; <span class="attr">field</span>: <span class="string">&quot;value&quot;</span> &#125;]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ›´æ–°æ–‡æ¡£</span></span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> mongoDBService.<span class="title function_">updateOne</span>(</span><br><span class="line">  <span class="string">&quot;collection_name&quot;</span>, </span><br><span class="line">  &#123; <span class="attr">field</span>: <span class="string">&quot;value&quot;</span> &#125;, </span><br><span class="line">  &#123; <span class="attr">$set</span>: &#123; <span class="attr">field</span>: <span class="string">&quot;new_value&quot;</span> &#125; &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®IDæ›´æ–°</span></span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> mongoDBService.<span class="title function_">updateById</span>(<span class="string">&quot;collection_name&quot;</span>, <span class="string">&quot;id&quot;</span>, &#123; <span class="attr">field</span>: <span class="string">&quot;value&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ é™¤æ–‡æ¡£</span></span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> mongoDBService.<span class="title function_">deleteOne</span>(<span class="string">&quot;collection_name&quot;</span>, &#123; <span class="attr">field</span>: <span class="string">&quot;value&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®IDåˆ é™¤</span></span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> mongoDBService.<span class="title function_">deleteById</span>(<span class="string">&quot;collection_name&quot;</span>, <span class="string">&quot;id&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// èšåˆæŸ¥è¯¢</span></span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> mongoDBService.<span class="title function_">aggregate</span>(<span class="string">&quot;collection_name&quot;</span>, [</span><br><span class="line">  &#123; <span class="attr">$match</span>: &#123; <span class="attr">field</span>: <span class="string">&quot;value&quot;</span> &#125; &#125;,</span><br><span class="line">  &#123; <span class="attr">$group</span>: &#123; <span class="attr">_id</span>: <span class="string">&quot;$field&quot;</span>, <span class="attr">count</span>: &#123; <span class="attr">$sum</span>: <span class="number">1</span> &#125; &#125; &#125;</span><br><span class="line">]);</span><br></pre></td></tr></table></figure><h3 id="MBTIå®é™…æ•°æ®åº“æ“ä½œç¤ºä¾‹"><a href="#MBTIå®é™…æ•°æ®åº“æ“ä½œç¤ºä¾‹" class="headerlink" title="MBTIå®é™…æ•°æ®åº“æ“ä½œç¤ºä¾‹"></a>MBTIå®é™…æ•°æ®åº“æ“ä½œç¤ºä¾‹</h3><details><summary>æŸ¥è¯¢æ‰€æœ‰MBTIç±»å‹</summary><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">getAllTypes</span>(): <span class="title class_">Promise</span>&lt;<span class="title class_">MBTIType</span>[]&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">mongoDBService</span>.<span class="title function_">connect</span>();</span><br><span class="line">    <span class="keyword">const</span> types = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">mongoDBService</span>.<span class="title function_">find</span>(<span class="variable language_">this</span>.<span class="property">typesCollection</span>, &#123;&#125;);</span><br><span class="line">    <span class="keyword">return</span> types <span class="keyword">as</span> <span class="built_in">unknown</span> <span class="keyword">as</span> <span class="title class_">MBTIType</span>[];</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">error</span>(<span class="string">&quot;è·å–æ‰€æœ‰MBTIç±»å‹å¤±è´¥:&quot;</span>, error);</span><br><span class="line">    <span class="keyword">throw</span> error;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">mongoDBService</span>.<span class="title function_">close</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details><details><summary>ä¿å­˜æµ‹è¯•ç»“æœ</summary><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–°ç”¨æˆ·ï¼Œåˆ›å»ºè®°å½•</span></span><br><span class="line"><span class="keyword">const</span> newUserData = &#123;</span><br><span class="line">  <span class="attr">user_id</span>: testData.<span class="property">user_id</span>,</span><br><span class="line">  <span class="attr">nickname</span>: testData.<span class="property">nickname</span> || testData.<span class="property">user_id</span>,</span><br><span class="line">  <span class="attr">tests</span>: [&#123;</span><br><span class="line">    <span class="attr">test_id</span>: testId,</span><br><span class="line">    <span class="attr">test_date</span>: now,</span><br><span class="line">    <span class="attr">completed</span>: isCompleted,</span><br><span class="line">    <span class="attr">responses</span>: testData.<span class="property">responses</span>,</span><br><span class="line">    <span class="attr">result</span>: testResult</span><br><span class="line">  &#125;],</span><br><span class="line">  <span class="attr">test_count</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">latest_type</span>: testResult?.<span class="property">type</span> || <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">created_at</span>: now,</span><br><span class="line">  <span class="attr">updated_at</span>: now</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">mongoDBService</span>.<span class="title function_">insertOne</span>(<span class="variable language_">this</span>.<span class="property">testResultsCollection</span>, newUserData);</span><br></pre></td></tr></table></figure><details><summary>æ›´æ–°ç°æœ‰è®°å½•</summary><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç°æœ‰ç”¨æˆ·ï¼Œæ›´æ–°è®°å½•</span></span><br><span class="line"><span class="keyword">const</span> userData = existingUsers[<span class="number">0</span>] <span class="keyword">as</span> <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt;;</span><br><span class="line"><span class="keyword">const</span> tests = userData.<span class="property">tests</span> <span class="keyword">as</span> <span class="title class_">Array</span>&lt;<span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt;&gt; || [];</span><br><span class="line"></span><br><span class="line">tests.<span class="title function_">push</span>(&#123;</span><br><span class="line">  <span class="attr">test_id</span>: testId,</span><br><span class="line">  <span class="attr">test_date</span>: now,</span><br><span class="line">  <span class="attr">completed</span>: isCompleted,</span><br><span class="line">  <span class="attr">responses</span>: testData.<span class="property">responses</span>,</span><br><span class="line">  <span class="attr">result</span>: testResult</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">updateData</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt; = &#123;</span><br><span class="line">  tests,</span><br><span class="line">  <span class="attr">test_count</span>: tests.<span class="property">length</span>,</span><br><span class="line">  <span class="attr">updated_at</span>: now</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœæµ‹è¯•å®Œæˆï¼Œæ›´æ–°æœ€æ–°ç±»å‹</span></span><br><span class="line"><span class="keyword">if</span> (isCompleted &amp;&amp; testResult) &#123;</span><br><span class="line">  updateData.<span class="property">latest_type</span> = testResult.<span class="property">type</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">mongoDBService</span>.<span class="title function_">updateOne</span>(</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">testResultsCollection</span>,</span><br><span class="line">  &#123; <span class="attr">user_id</span>: testData.<span class="property">user_id</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">$set</span>: updateData &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h3 id="åˆ†é¡µæŸ¥è¯¢"><a href="#åˆ†é¡µæŸ¥è¯¢" class="headerlink" title="åˆ†é¡µæŸ¥è¯¢"></a>åˆ†é¡µæŸ¥è¯¢</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> mongoDBService.<span class="title function_">paginate</span>(</span><br><span class="line">  <span class="string">&quot;collection_name&quot;</span>,   <span class="comment">// é›†åˆåç§°</span></span><br><span class="line">  <span class="number">1</span>,                   <span class="comment">// é¡µç </span></span><br><span class="line">  <span class="number">10</span>,                  <span class="comment">// æ¯é¡µè®°å½•æ•°</span></span><br><span class="line">  &#123; <span class="attr">field</span>: <span class="string">&quot;value&quot;</span> &#125;,  <span class="comment">// æŸ¥è¯¢æ¡ä»¶</span></span><br><span class="line">  &#123; <span class="attr">sort</span>: &#123; <span class="attr">field</span>: <span class="number">1</span> &#125; &#125; <span class="comment">// æ’åºé€‰é¡¹</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><h4 id="è¿”å›ç»“æœæ ¼å¼"><a href="#è¿”å›ç»“æœæ ¼å¼" class="headerlink" title="è¿”å›ç»“æœæ ¼å¼"></a>è¿”å›ç»“æœæ ¼å¼</h4><table><thead><tr><th>å­—æ®µ</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>data</code></td><td>æ•°æ®æ•°ç»„</td></tr><tr><td><code>total</code></td><td>æ€»è®°å½•æ•°</td></tr><tr><td><code>page</code></td><td>å½“å‰é¡µç </td></tr><tr><td><code>limit</code></td><td>æ¯é¡µè®°å½•æ•°</td></tr><tr><td><code>pageCount</code></td><td>æ€»é¡µæ•°</td></tr></tbody></table><hr><h2 id="ğŸ§°-MongoDBæŸ¥è¯¢è¯­æ³•"><a href="#ğŸ§°-MongoDBæŸ¥è¯¢è¯­æ³•" class="headerlink" title="ğŸ§° MongoDBæŸ¥è¯¢è¯­æ³•"></a>ğŸ§° MongoDBæŸ¥è¯¢è¯­æ³•</h2><h3 id="å¸¸ç”¨æ“ä½œç¬¦"><a href="#å¸¸ç”¨æ“ä½œç¬¦" class="headerlink" title="å¸¸ç”¨æ“ä½œç¬¦"></a>å¸¸ç”¨æ“ä½œç¬¦</h3><details><summary>å±•å¼€æŸ¥çœ‹å¸¸ç”¨æŸ¥è¯¢æ“ä½œç¬¦</summary><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç›¸ç­‰æŸ¥è¯¢</span></span><br><span class="line">&#123; <span class="attr">field</span>: <span class="string">&quot;value&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸ç­‰æŸ¥è¯¢</span></span><br><span class="line">&#123; <span class="attr">field</span>: &#123; <span class="attr">$ne</span>: <span class="string">&quot;value&quot;</span> &#125; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤§äº/å°äº</span></span><br><span class="line">&#123; <span class="attr">field</span>: &#123; <span class="attr">$gt</span>: <span class="number">10</span> &#125; &#125;  <span class="comment">// å¤§äº</span></span><br><span class="line">&#123; <span class="attr">field</span>: &#123; <span class="attr">$lt</span>: <span class="number">10</span> &#125; &#125;  <span class="comment">// å°äº</span></span><br><span class="line">&#123; <span class="attr">field</span>: &#123; <span class="attr">$gte</span>: <span class="number">10</span> &#125; &#125; <span class="comment">// å¤§äºç­‰äº</span></span><br><span class="line">&#123; <span class="attr">field</span>: &#123; <span class="attr">$lte</span>: <span class="number">10</span> &#125; &#125; <span class="comment">// å°äºç­‰äº</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// INæŸ¥è¯¢</span></span><br><span class="line">&#123; <span class="attr">field</span>: &#123; <span class="attr">$in</span>: [<span class="string">&quot;value1&quot;</span>, <span class="string">&quot;value2&quot;</span>] &#125; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€»è¾‘æ“ä½œç¬¦</span></span><br><span class="line">&#123; <span class="attr">$and</span>: [&#123; <span class="attr">field1</span>: <span class="string">&quot;value1&quot;</span> &#125;, &#123; <span class="attr">field2</span>: <span class="string">&quot;value2&quot;</span> &#125;] &#125;</span><br><span class="line">&#123; <span class="attr">$or</span>: [&#123; <span class="attr">field1</span>: <span class="string">&quot;value1&quot;</span> &#125;, &#123; <span class="attr">field1</span>: <span class="string">&quot;value2&quot;</span> &#125;] &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£åˆ™è¡¨è¾¾å¼</span></span><br><span class="line">&#123; <span class="attr">field</span>: &#123; <span class="attr">$regex</span>: <span class="string">&quot;pattern&quot;</span>, <span class="attr">$options</span>: <span class="string">&quot;i&quot;</span> &#125; &#125; <span class="comment">// iè¡¨ç¤ºä¸åŒºåˆ†å¤§å°å†™</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å­˜åœ¨æ€§æ£€æŸ¥</span></span><br><span class="line">&#123; <span class="attr">field</span>: &#123; <span class="attr">$exists</span>: <span class="literal">true</span> &#125; &#125;</span><br></pre></td></tr></table></figure><h3 id="æ›´æ–°æ“ä½œç¬¦"><a href="#æ›´æ–°æ“ä½œç¬¦" class="headerlink" title="æ›´æ–°æ“ä½œç¬¦"></a>æ›´æ–°æ“ä½œç¬¦</h3><details><summary>å±•å¼€æŸ¥çœ‹å¸¸ç”¨æ›´æ–°æ“ä½œç¬¦</summary><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¾ç½®å­—æ®µå€¼</span></span><br><span class="line">&#123; <span class="attr">$set</span>: &#123; <span class="attr">field</span>: <span class="string">&quot;new_value&quot;</span> &#125; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¢åŠ æ•°å€¼</span></span><br><span class="line">&#123; <span class="attr">$inc</span>: &#123; <span class="attr">counter</span>: <span class="number">1</span> &#125; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ åˆ°æ•°ç»„</span></span><br><span class="line">&#123; <span class="attr">$push</span>: &#123; <span class="attr">array_field</span>: <span class="string">&quot;new_item&quot;</span> &#125; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»æ•°ç»„ç§»é™¤</span></span><br><span class="line">&#123; <span class="attr">$pull</span>: &#123; <span class="attr">array_field</span>: <span class="string">&quot;item_to_remove&quot;</span> &#125; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ åˆ°é›†åˆï¼ˆä¸é‡å¤ï¼‰</span></span><br><span class="line">&#123; <span class="attr">$addToSet</span>: &#123; <span class="attr">array_field</span>: <span class="string">&quot;new_unique_item&quot;</span> &#125; &#125;</span><br></pre></td></tr></table></figure><hr><h2 id="ğŸ“-æ³¨æ„äº‹é¡¹å’Œæœ€ä½³å®è·µ"><a href="#ğŸ“-æ³¨æ„äº‹é¡¹å’Œæœ€ä½³å®è·µ" class="headerlink" title="ğŸ“ æ³¨æ„äº‹é¡¹å’Œæœ€ä½³å®è·µ"></a>ğŸ“ æ³¨æ„äº‹é¡¹å’Œæœ€ä½³å®è·µ</h2><h3 id="æ•°æ®åº“è¿æ¥ç®¡ç†"><a href="#æ•°æ®åº“è¿æ¥ç®¡ç†" class="headerlink" title="æ•°æ®åº“è¿æ¥ç®¡ç†"></a>æ•°æ®åº“è¿æ¥ç®¡ç†</h3><ul><li>âœ… å§‹ç»ˆåœ¨æ“ä½œç»“æŸåå…³é—­æ•°æ®åº“è¿æ¥ï¼ˆä½¿ç”¨<code>finally</code>å—ï¼‰</li><li>âœ… ä½¿ç”¨try-catch-finallyå¤„ç†æ•°æ®åº“æ“ä½œå¯èƒ½å‡ºç°çš„å¼‚å¸¸</li></ul><h3 id="é”™è¯¯å¤„ç†å’Œæ—¥å¿—"><a href="#é”™è¯¯å¤„ç†å’Œæ—¥å¿—" class="headerlink" title="é”™è¯¯å¤„ç†å’Œæ—¥å¿—"></a>é”™è¯¯å¤„ç†å’Œæ—¥å¿—</h3><ul><li>âœ… ä½¿ç”¨ç»Ÿä¸€çš„Loggerç±»è¿›è¡Œæ—¥å¿—è®°å½•</li><li>âœ… æ‰€æœ‰å¤–éƒ¨è°ƒç”¨ï¼ˆæ•°æ®åº“ã€APIï¼‰éƒ½åº”æœ‰é”™è¯¯å¤„ç†</li></ul><h3 id="MongoDBæ“ä½œ"><a href="#MongoDBæ“ä½œ" class="headerlink" title="MongoDBæ“ä½œ"></a>MongoDBæ“ä½œ</h3><ul><li>âœ… ä½¿ç”¨<code>countDocuments</code>è€Œä¸æ˜¯å·²åºŸå¼ƒçš„<code>count</code>æ–¹æ³•</li><li>âœ… ä½¿ç”¨<code>find</code>æ–¹æ³•æ—¶æ·»åŠ åˆé€‚çš„æŠ•å½±(projection)ä»¥å‡å°‘æ•°æ®ä¼ è¾“</li><li>âœ… å¯¹å¤§ç»“æœé›†ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢</li></ul><h3 id="å®‰å…¨æ€§"><a href="#å®‰å…¨æ€§" class="headerlink" title="å®‰å…¨æ€§"></a>å®‰å…¨æ€§</h3><ul><li>ğŸ”’ æ•æ„ŸAPIä½¿ç”¨<code>authMiddleware</code>è¿›è¡Œä¿æŠ¤</li><li>ğŸ”’ ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚æ•°æ®åº“å¯†ç ï¼‰</li></ul><h3 id="æ€§èƒ½ä¼˜åŒ–"><a href="#æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–"></a>æ€§èƒ½ä¼˜åŒ–</h3><ul><li>âš¡ å¤§é‡æ–‡æ¡£ä½¿ç”¨æ‰¹é‡æ“ä½œï¼ˆinsertMany, updateManyï¼‰</li><li>âš¡ æ·»åŠ é€‚å½“çš„ç´¢å¼•ä»¥åŠ é€ŸæŸ¥è¯¢</li><li>âš¡ ä½¿ç”¨æŠ•å½±é™åˆ¶è¿”å›å­—æ®µ</li></ul><h3 id="ç‰¹å®šé¡¹ç›®æ³¨æ„äº‹é¡¹"><a href="#ç‰¹å®šé¡¹ç›®æ³¨æ„äº‹é¡¹" class="headerlink" title="ç‰¹å®šé¡¹ç›®æ³¨æ„äº‹é¡¹"></a>ç‰¹å®šé¡¹ç›®æ³¨æ„äº‹é¡¹</h3><ul><li>ğŸ“‹ MBTIæµ‹è¯•éœ€è¦è‡³å°‘16ä¸ªé—®é¢˜æ‰èƒ½å®Œæˆ</li><li>ğŸ“‹ æ¯ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªæµ‹è¯•è®°å½•</li><li>ğŸ“‹ APIå“åº”æ ¼å¼ä¿æŒä¸€è‡´ï¼ˆåŒ…å«success, code, data&#x2F;messageå­—æ®µï¼‰</li></ul><hr><h3 id="APIå“åº”æ ¼å¼è®¾è®¡"><a href="#APIå“åº”æ ¼å¼è®¾è®¡" class="headerlink" title="APIå“åº”æ ¼å¼è®¾è®¡"></a>APIå“åº”æ ¼å¼è®¾è®¡</h3><p>ä¸ºç¡®ä¿å‰ç«¯èƒ½é«˜æ•ˆå¤„ç†APIå“åº”ï¼Œæ‰€æœ‰APIåº”éµå¾ªä¸€è‡´çš„å“åº”æ ¼å¼ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">ApiResponse</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="attr">success</span>: <span class="built_in">boolean</span>;     <span class="comment">// è¯·æ±‚æ˜¯å¦æˆåŠŸ</span></span><br><span class="line">  <span class="attr">code</span>: <span class="built_in">number</span>;         <span class="comment">// çŠ¶æ€ç ï¼Œä¸HTTPçŠ¶æ€ç ä¿æŒä¸€è‡´</span></span><br><span class="line">  <span class="attr">data</span>?: T;             <span class="comment">// æˆåŠŸæ—¶è¿”å›çš„æ•°æ®</span></span><br><span class="line">  <span class="attr">message</span>?: <span class="built_in">string</span>;     <span class="comment">// é”™è¯¯æ—¶çš„æ¶ˆæ¯</span></span><br><span class="line">  <span class="attr">pagination</span>?: &#123;        <span class="comment">// åˆ†é¡µä¿¡æ¯ï¼ˆå¦‚é€‚ç”¨ï¼‰</span></span><br><span class="line">    <span class="attr">total</span>: <span class="built_in">number</span>;</span><br><span class="line">    <span class="attr">page</span>: <span class="built_in">number</span>;</span><br><span class="line">    <span class="attr">limit</span>: <span class="built_in">number</span>;</span><br><span class="line">    <span class="attr">pageCount</span>: <span class="built_in">number</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å‰ç«¯å®ç°å»ºè®®"><a href="#å‰ç«¯å®ç°å»ºè®®" class="headerlink" title="å‰ç«¯å®ç°å»ºè®®"></a>å‰ç«¯å®ç°å»ºè®®</h3><ol><li><p><strong>MBTIæµ‹è¯•ç•Œé¢è®¾è®¡</strong>:</p><ul><li>é‡‡ç”¨åˆ†æ­¥éª¤å±•ç¤ºé—®é¢˜ï¼Œå‡è½»ç”¨æˆ·è´Ÿæ‹…</li><li>è¿›åº¦æŒ‡ç¤ºå™¨æ˜¾ç¤ºå®Œæˆæƒ…å†µ</li><li>ä½¿ç”¨ç›´è§‚çš„é€‰é¡¹è®¾è®¡ï¼ˆå¦‚æ»‘å—ã€å•é€‰æŒ‰é’®ï¼‰</li><li>ç»“æœé¡µé¢çªå‡ºæ˜¾ç¤ºç”¨æˆ·çš„MBTIç±»å‹å’Œç‰¹ç‚¹</li></ul></li><li><p><strong>å“åº”å¼è®¾è®¡</strong>:</p><ul><li>ç¡®ä¿åœ¨ç§»åŠ¨è®¾å¤‡å’Œæ¡Œé¢è®¾å¤‡ä¸Šéƒ½æœ‰è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ</li><li>é’ˆå¯¹ä¸åŒå±å¹•å°ºå¯¸ä¼˜åŒ–å¸ƒå±€</li><li>è€ƒè™‘è§¦æ‘¸æ“ä½œçš„ä¾¿åˆ©æ€§</li></ul></li><li><p><strong>æ€§èƒ½ä¼˜åŒ–</strong>:</p><ul><li>å®æ–½æ‡’åŠ è½½æŠ€æœ¯ï¼Œç‰¹åˆ«æ˜¯å¯¹MBTIç±»å‹è¯¦æƒ…é¡µé¢</li><li>ç¼“å­˜ç”¨æˆ·å†å²æµ‹è¯•ç»“æœ</li><li>ä¼˜åŒ–å›¾ç‰‡å’Œèµ„æºåŠ è½½</li></ul></li><li><p><strong>äº¤äº’ä½“éªŒä¼˜åŒ–</strong>:</p><ul><li>æ·»åŠ é€‚å½“çš„åŠ¨ç”»å’Œè¿‡æ¸¡æ•ˆæœ</li><li>å®ç°å³æ—¶åé¦ˆæœºåˆ¶</li><li>è€ƒè™‘ç¦»çº¿æ”¯æŒï¼Œå…è®¸ç”¨æˆ·åœ¨æ— ç½‘ç»œæƒ…å†µä¸‹å®Œæˆæµ‹è¯•</li></ul></li></ol><h3 id="ç”¨æˆ·ä½“éªŒä¼˜åŒ–å»ºè®®"><a href="#ç”¨æˆ·ä½“éªŒä¼˜åŒ–å»ºè®®" class="headerlink" title="ç”¨æˆ·ä½“éªŒä¼˜åŒ–å»ºè®®"></a>ç”¨æˆ·ä½“éªŒä¼˜åŒ–å»ºè®®</h3><ul><li>ğŸ“± <strong>å¼•å¯¼å¼æµ‹è¯•æµç¨‹</strong>: æä¾›æ¸…æ™°çš„æŒ‡å¼•å’Œè¯´æ˜</li><li>ğŸ¯ <strong>ä¸ªæ€§åŒ–ç»“æœå±•ç¤º</strong>: æ ¹æ®ç”¨æˆ·çš„MBTIç±»å‹æä¾›ä¸ªæ€§åŒ–çš„ç»“æœé¡µé¢</li><li>ğŸ”„ <strong>ç¤¾äº¤åˆ†äº«åŠŸèƒ½</strong>: å…è®¸ç”¨æˆ·åˆ†äº«ä»–ä»¬çš„æµ‹è¯•ç»“æœåˆ°ç¤¾äº¤åª’ä½“</li><li>ğŸŒ“ <strong>ä¸»é¢˜å®šåˆ¶</strong>: æä¾›æµ…è‰²&#x2F;æ·±è‰²æ¨¡å¼åˆ‡æ¢</li></ul><hr><h2 id="â“-å¸¸è§é—®é¢˜æ’æŸ¥"><a href="#â“-å¸¸è§é—®é¢˜æ’æŸ¥" class="headerlink" title="â“ å¸¸è§é—®é¢˜æ’æŸ¥"></a>â“ å¸¸è§é—®é¢˜æ’æŸ¥</h2><h3 id="MongoDBè¿æ¥é—®é¢˜"><a href="#MongoDBè¿æ¥é—®é¢˜" class="headerlink" title="MongoDBè¿æ¥é—®é¢˜"></a>MongoDBè¿æ¥é—®é¢˜</h3><ul><li>ğŸ” æ£€æŸ¥URIå’Œæ•°æ®åº“åç§°é…ç½®</li><li>ğŸ” ç¡®è®¤MongoDBæœåŠ¡å™¨è¿è¡ŒçŠ¶æ€</li><li>ğŸ” æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®</li></ul><h3 id="APIè¿”å›ç©ºæ•°æ®"><a href="#APIè¿”å›ç©ºæ•°æ®" class="headerlink" title="APIè¿”å›ç©ºæ•°æ®"></a>APIè¿”å›ç©ºæ•°æ®</h3><ul><li>ğŸ” æ£€æŸ¥æ•°æ®åº“è¿æ¥</li><li>ğŸ” ç¡®è®¤é›†åˆä¸­æœ‰æ•°æ®</li><li>ğŸ” éªŒè¯æŸ¥è¯¢æ¡ä»¶æ˜¯å¦æ­£ç¡®</li></ul><h3 id="æƒé™é—®é¢˜"><a href="#æƒé™é—®é¢˜" class="headerlink" title="æƒé™é—®é¢˜"></a>æƒé™é—®é¢˜</h3><ul><li>ğŸ” ç¡®è®¤ç”¨æˆ·æœ‰æ­£ç¡®çš„æ•°æ®åº“æƒé™</li><li>ğŸ” éªŒè¯æˆæƒä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆ</li></ul><h3 id="éƒ¨ç½²ç›¸å…³é—®é¢˜"><a href="#éƒ¨ç½²ç›¸å…³é—®é¢˜" class="headerlink" title="éƒ¨ç½²ç›¸å…³é—®é¢˜"></a>éƒ¨ç½²ç›¸å…³é—®é¢˜</h3><ul><li>ğŸ” ç¡®ä¿ç›®æ ‡ç¯å¢ƒåŒ…å«æ‰€æœ‰å¿…è¦çš„ç¯å¢ƒå˜é‡</li><li>ğŸ” æ£€æŸ¥è¿è¡Œå‘½ä»¤æ˜¯å¦åŒ…å«æ‰€æœ‰å¿…è¦çš„æƒé™æ ‡å¿—</li></ul><hr><h2 id="ğŸš€-æ‰©å±•å’Œæ”¹è¿›"><a href="#ğŸš€-æ‰©å±•å’Œæ”¹è¿›" class="headerlink" title="ğŸš€ æ‰©å±•å’Œæ”¹è¿›"></a>ğŸš€ æ‰©å±•å’Œæ”¹è¿›</h2><ol><li><strong>APIæ–‡æ¡£</strong>: è€ƒè™‘æ·»åŠ Swaggeræˆ–ç±»ä¼¼å·¥å…·</li><li><strong>ç¼“å­˜å±‚</strong>: ä¸ºé¢‘ç¹è®¿é—®çš„æ•°æ®æ·»åŠ ç¼“å­˜</li><li><strong>ç›‘æ§</strong>: æ·»åŠ æ€§èƒ½ç›‘æ§å’Œå¥åº·æ£€æŸ¥</li><li><strong>CI&#x2F;CD</strong>: è®¾ç½®è‡ªåŠ¨åŒ–æµ‹è¯•å’Œéƒ¨ç½²</li></ol><hr><p>å»ºè®®åœ¨<code>deno.json</code>ä¸­é›†ä¸­ç®¡ç†æ‰€æœ‰ä¾èµ–çš„ç‰ˆæœ¬ï¼Œä¾¿äºåç»­å‡çº§å’Œç»´æŠ¤ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;imports&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;oak&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jsr:@oak/oak@^12.6.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mongoose&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npm:mongoose@^8.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;std/&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://deno.land/std@0.196.0/&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><hr><h2 id="ğŸš¢-Denoéƒ¨ç½²æŒ‡å—"><a href="#ğŸš¢-Denoéƒ¨ç½²æŒ‡å—" class="headerlink" title="ğŸš¢ Denoéƒ¨ç½²æŒ‡å—"></a>ğŸš¢ Denoéƒ¨ç½²æŒ‡å—</h2><h3 id="ä½¿ç”¨Deno-Deploy"><a href="#ä½¿ç”¨Deno-Deploy" class="headerlink" title="ä½¿ç”¨Deno Deploy"></a>ä½¿ç”¨Deno Deploy</h3><p><a href="https://deno.com/deploy">Deno Deploy</a>æ˜¯å®˜æ–¹çš„serverlesså¹³å°ï¼Œå¯ä»¥è½»æ¾éƒ¨ç½²Denoåº”ç”¨ã€‚</p><h4 id="1-ä½¿ç”¨deployctlå·¥å…·"><a href="#1-ä½¿ç”¨deployctlå·¥å…·" class="headerlink" title="1. ä½¿ç”¨deployctlå·¥å…·"></a>1. ä½¿ç”¨deployctlå·¥å…·</h4><p>é¦–å…ˆå®‰è£…deployctlå·¥å…·ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deno install --allow-read --allow-write --allow-env --allow-net --allow-run --no-check -r -f https://deno.land/x/deploy/deployctl.ts</span><br></pre></td></tr></table></figure><h4 id="2-éƒ¨ç½²é¡¹ç›®"><a href="#2-éƒ¨ç½²é¡¹ç›®" class="headerlink" title="2. éƒ¨ç½²é¡¹ç›®"></a>2. éƒ¨ç½²é¡¹ç›®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç›´æ¥éƒ¨ç½²</span></span><br><span class="line">deployctl deploy --project=your-project-name main.ts</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šç¯å¢ƒå˜é‡</span></span><br><span class="line">deployctl deploy --project=your-project-name --env-file=.<span class="built_in">env</span> main.ts</span><br></pre></td></tr></table></figure><h4 id="3-é€šè¿‡deno-jsoné…ç½®"><a href="#3-é€šè¿‡deno-jsoné…ç½®" class="headerlink" title="3. é€šè¿‡deno.jsoné…ç½®"></a>3. é€šè¿‡deno.jsoné…ç½®</h4><p>é¡¹ç›®çš„<code>deno.json</code>å¯ä»¥åŒ…å«éƒ¨ç½²é…ç½®ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;deploy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;project&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-project-id&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;exclude&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;**/node_modules&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;include&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;entrypoint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;main.ts&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>ç„¶åæ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deno task deploy</span><br></pre></td></tr></table></figure><h3 id="éƒ¨ç½²å‰çš„å‡†å¤‡"><a href="#éƒ¨ç½²å‰çš„å‡†å¤‡" class="headerlink" title="éƒ¨ç½²å‰çš„å‡†å¤‡"></a>éƒ¨ç½²å‰çš„å‡†å¤‡</h3><ol><li><p><strong>ç¡®ä¿é¡¹ç›®ç»“æ„æ­£ç¡®</strong>ï¼š</p><ul><li>å…¥å£æ–‡ä»¶åº”è¯¥æ˜¯è‡ªåŒ…å«çš„ï¼Œæˆ–è€…èƒ½å¤Ÿè®¿é—®æ‰€æœ‰ä¾èµ–</li><li>ç¡®ä¿æ‰€æœ‰è·¯å¾„æ­£ç¡®ï¼ˆç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„ï¼‰</li></ul></li><li><p><strong>ç¯å¢ƒå˜é‡å¤„ç†</strong>ï¼š</p><ul><li>éƒ¨ç½²ç¯å¢ƒéœ€è¦è®¾ç½®æ‰€æœ‰å¿…éœ€çš„ç¯å¢ƒå˜é‡</li><li>å¯ä»¥åœ¨Deno Deployæ§åˆ¶å°ä¸­é…ç½®ç¯å¢ƒå˜é‡</li><li>æ•æ„Ÿä¿¡æ¯ä¸åº”ç¡¬ç¼–ç æˆ–åŒ…å«åœ¨ç‰ˆæœ¬æ§åˆ¶ä¸­</li></ul></li><li><p><strong>æ–‡ä»¶ç³»ç»Ÿé™åˆ¶</strong>ï¼š</p><ul><li>Deno Deployä¸æ”¯æŒæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå†™å…¥</li><li>æ‰€æœ‰æ–‡ä»¶æ“ä½œåº”æ›¿æ¢ä¸ºå­˜å‚¨æœåŠ¡(å¦‚MongoDB)æˆ–å†…å­˜å­˜å‚¨</li></ul></li><li><p><strong>ç½‘ç»œè®¿é—®å’Œç¬¬ä¸‰æ–¹æœåŠ¡</strong>ï¼š</p><ul><li>ç¡®ä¿æ‰€æœ‰å¤–éƒ¨æœåŠ¡éƒ½èƒ½ä»Deno Deployè®¿é—®</li><li>ä½¿ç”¨é€‚å½“çš„è¶…æ—¶å’Œé‡è¯•ç­–ç•¥å¤„ç†é—´æ­‡æ€§è¿æ¥é—®é¢˜</li></ul></li></ol><h3 id="æ³¨æ„äº‹é¡¹å’Œé™åˆ¶"><a href="#æ³¨æ„äº‹é¡¹å’Œé™åˆ¶" class="headerlink" title="æ³¨æ„äº‹é¡¹å’Œé™åˆ¶"></a>æ³¨æ„äº‹é¡¹å’Œé™åˆ¶</h3><ol><li><p><strong>å†·å¯åŠ¨</strong>:</p><ul><li>Serverlessç¯å¢ƒå¯èƒ½æœ‰å†·å¯åŠ¨å»¶è¿Ÿ</li><li>å…³é”®æœåŠ¡åº”ä¼˜åŒ–ä»¥å¿«é€Ÿåˆå§‹åŒ–</li></ul></li><li><p><strong>æ‰§è¡Œæ—¶é—´é™åˆ¶</strong>:</p><ul><li>è¯·æ±‚å¤„ç†æ—¶é—´æœ‰é™åˆ¶ï¼Œé•¿æ—¶é—´æ“ä½œåº”æ‹†åˆ†æˆ–å¼‚æ­¥å¤„ç†</li></ul></li><li><p><strong>å†…å­˜é™åˆ¶</strong>:</p><ul><li>éµå¾ªå†…å­˜æœ€ä½³å®è·µï¼Œé¿å…å†…å­˜æ³„æ¼</li><li>å¤§å‹å¯¹è±¡åº”åˆ†å—å¤„ç†æˆ–ä½¿ç”¨æµå¤„ç†</li></ul></li><li><p><strong>ä¾èµ–é¡¹</strong>:</p><ul><li>ç¡®ä¿æ‰€æœ‰ä¾èµ–é¡¹éƒ½ä¸Deno Deployå…¼å®¹</li><li>æŸäº›ä¾èµ–äºNode.js APIçš„npmåŒ…å¯èƒ½ä¸å…¼å®¹</li><li>ä½¿ç”¨Denoæ ‡å‡†åº“æˆ–ä¸“é—¨çš„DenoåŒ…ä»¥è·å¾—æœ€ä½³ä½“éªŒ</li></ul></li><li><p><strong>æ•°æ®åº“è¿æ¥</strong>:</p><ul><li>ä½¿ç”¨è¿æ¥æ± å’Œåˆé€‚çš„è¿æ¥ç®¡ç†ç­–ç•¥</li><li>é˜²æ­¢è¿æ¥æ³„æ¼ï¼Œç¡®ä¿åœ¨è¯·æ±‚ç»“æŸæ—¶å…³é—­è¿æ¥</li></ul></li><li><p><strong>å®šæ—¶ä»»åŠ¡</strong>:</p><ul><li>Deno Deployæ”¯æŒé€šè¿‡Cronè§¦å‘å™¨è¿è¡Œå®šæ—¶ä»»åŠ¡</li><li>å¯¹äºå¤æ‚çš„è°ƒåº¦éœ€æ±‚ï¼Œå¯èƒ½éœ€è¦å¤–éƒ¨æœåŠ¡</li></ul></li></ol><h3 id="éƒ¨ç½²åçš„ç›‘æ§"><a href="#éƒ¨ç½²åçš„ç›‘æ§" class="headerlink" title="éƒ¨ç½²åçš„ç›‘æ§"></a>éƒ¨ç½²åçš„ç›‘æ§</h3><ul><li>ä½¿ç”¨Deno Deployæä¾›çš„æ—¥å¿—å’ŒæŒ‡æ ‡ç›‘æ§åº”ç”¨æ€§èƒ½</li><li>è€ƒè™‘æ·»åŠ è‡ªå®šä¹‰æ—¥å¿—è®°å½•ä»¥è·Ÿè¸ªå…³é”®æ“ä½œ</li><li>å®ç°å¥åº·æ£€æŸ¥ç«¯ç‚¹ä»¥ç›‘æ§æœåŠ¡çŠ¶æ€</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¥åº·æ£€æŸ¥ç«¯ç‚¹ç¤ºä¾‹</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/health&quot;</span>, <span class="function">(<span class="params">ctx</span>) =&gt;</span> &#123;</span><br><span class="line">  ctx.<span class="property">response</span>.<span class="property">status</span> = <span class="number">200</span>;</span><br><span class="line">  ctx.<span class="property">response</span>.<span class="property">body</span> = &#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&quot;ok&quot;</span>,</span><br><span class="line">    <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toISOString</span>(),</span><br><span class="line">    <span class="attr">version</span>: <span class="string">&quot;1.0.0&quot;</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><hr><h2 id="ğŸ“-ä»£ç è§„èŒƒ"><a href="#ğŸ“-ä»£ç è§„èŒƒ" class="headerlink" title="ğŸ“ ä»£ç è§„èŒƒ"></a>ğŸ“ ä»£ç è§„èŒƒ</h2><ul><li>ğŸ“„ ä½¿ç”¨TSDocé£æ ¼çš„æ³¨é‡Š</li><li>ğŸ”„ ä¿æŒä¸€è‡´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•æ¨¡å¼</li><li>ğŸ§© éµå¾ªæ¨¡å—åŒ–è®¾è®¡åŸåˆ™</li></ul><hr><h2 id="ğŸ“š-èµ„æºé“¾æ¥"><a href="#ğŸ“š-èµ„æºé“¾æ¥" class="headerlink" title="ğŸ“š èµ„æºé“¾æ¥"></a>ğŸ“š èµ„æºé“¾æ¥</h2><ul><li><a href="https://deno.land/manual">Denoå®˜æ–¹æ–‡æ¡£</a></li><li><a href="https://deno.land/x/oak">Oak HTTPæœåŠ¡å™¨æ¡†æ¶æ–‡æ¡£</a></li><li><a href="https://www.mongodb.com/docs/">MongoDBæ–‡æ¡£</a></li><li><a href="https://mongoosejs.com/docs/">Mongooseæ–‡æ¡£</a></li><li><a href="https://www.myersbriggs.org/">MBTIå®˜æ–¹ç½‘ç«™</a></li><li><a href="https://www.16personalities.com/">16Personalities</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Denoå­¦ä¹ è®°å½•-ğŸ“˜&quot;&gt;&lt;a href=&quot;#Denoå­¦ä¹ è®°å½•-ğŸ“˜&quot; class=&quot;headerlink&quot; title=&quot;Denoå­¦ä¹ è®°å½• ğŸ“˜&quot;&gt;&lt;/a&gt;Denoå­¦ä¹ è®°å½• ğŸ“˜&lt;/h1&gt;&lt;div align=&quot;left&quot;&gt;

&lt;p&gt;&lt;img src= &quot;/im</summary>
      
    
    
    
    
    <category term="Deno" scheme="https://aoayaoa.github.io/tags/Deno/"/>
    
  </entry>
  
  <entry>
    <title>reactæ€»ç»“</title>
    <link href="https://aoayaoa.github.io/2025/03/15/react/"/>
    <id>https://aoayaoa.github.io/2025/03/15/react/</id>
    <published>2025-03-14T16:00:00.000Z</published>
    <updated>2025-04-26T09:19:06.682Z</updated>
    
    <content type="html"><![CDATA[<h1 id="React-18-19-å­¦ä¹ æ€»ç»“"><a href="#React-18-19-å­¦ä¹ æ€»ç»“" class="headerlink" title="React 18&#x2F;19 å­¦ä¹ æ€»ç»“"></a>React 18&#x2F;19 å­¦ä¹ æ€»ç»“</h1><h2 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h2><ul><li><a href="#react-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5">React åŸºç¡€æ¦‚å¿µ</a></li><li><a href="#%E5%B8%B8%E8%A7%81%E7%94%A8%E6%B3%95%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">å¸¸è§ç”¨æ³•ä¸æœ€ä½³å®è·µ</a></li><li><a href="#hook-%E8%AF%A6%E8%A7%A3%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">Hook è¯¦è§£ä¸æœ€ä½³å®è·µ</a></li><li><a href="#%E6%98%93%E9%94%99%E7%82%B9%E4%B8%8E%E9%99%B7%E9%98%B1">æ˜“é”™ç‚¹ä¸é™·é˜±</a></li><li><a href="#%E9%A1%B9%E7%9B%AE%E5%AE%9E%E8%B7%B5%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">é¡¹ç›®å®è·µæ³¨æ„äº‹é¡¹</a></li><li><a href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A7">æ€§èƒ½ä¼˜åŒ–æŠ€å·§</a></li><li><a href="#react-18-%E6%A0%B8%E5%BF%83%E7%89%B9%E6%80%A7">React 18 æ ¸å¿ƒç‰¹æ€§</a></li><li><a href="#react-19-%E6%96%B0%E7%89%B9%E6%80%A7%E4%B8%8E%E5%B1%95%E6%9C%9B">React 19 æ–°ç‰¹æ€§ä¸å±•æœ›</a></li><li><a href="#%E9%A2%9D%E5%A4%96%E8%B5%84%E6%BA%90">é¢å¤–èµ„æº</a></li></ul><hr><h2 id="React-åŸºç¡€æ¦‚å¿µ"><a href="#React-åŸºç¡€æ¦‚å¿µ" class="headerlink" title="React åŸºç¡€æ¦‚å¿µ"></a>React åŸºç¡€æ¦‚å¿µ</h2><h3 id="ç»„ä»¶ä¸JSX"><a href="#ç»„ä»¶ä¸JSX" class="headerlink" title="ç»„ä»¶ä¸JSX"></a>ç»„ä»¶ä¸JSX</h3><p>React çš„æ ¸å¿ƒç†å¿µæ˜¯å°† UI åˆ†è§£æˆç‹¬ç«‹ã€å¯å¤ç”¨çš„ç»„ä»¶ã€‚æ¯ä¸ªç»„ä»¶éƒ½æ˜¯ä¸€ä¸ªè‡ªåŒ…å«çš„æ¨¡å—ï¼Œè´Ÿè´£æ¸²æŸ“ UI çš„ä¸€éƒ¨åˆ†ã€‚</p><div style="background-color: #f0f7fb; padding: 15px; border-left: 5px solid #3498db; margin-bottom: 15px;"><strong>å…³é”®æ¦‚å¿µ</strong>ï¼šç»„ä»¶æ˜¯ React åº”ç”¨çš„æ„å»ºå—ï¼Œå¯ä»¥ä½¿ç”¨å‡½æ•°ç»„ä»¶æˆ–ç±»ç»„ä»¶åˆ›å»ºã€‚</div><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‡½æ•°ç»„ä»¶</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Welcome</span>(<span class="params">props</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, &#123;props.name&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç±»ç»„ä»¶</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Welcome</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, &#123;this.props.name&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>JSX æ˜¯ JavaScript çš„è¯­æ³•æ‰©å±•ï¼Œå®ƒå…è®¸æˆ‘ä»¬åœ¨ JavaScript ä¸­ç¼–å†™ç±»ä¼¼ HTML çš„ä»£ç ã€‚</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JSX åŸºæœ¬è¯­æ³•</span></span><br><span class="line"><span class="keyword">const</span> element = <span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, world!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// JSX å¯ä»¥åŒ…å« JavaScript è¡¨è¾¾å¼</span></span><br><span class="line"><span class="keyword">const</span> name = <span class="string">&#x27;Josh&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> element = <span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, &#123;name&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// JSX å±æ€§ä½¿ç”¨é©¼å³°å‘½å</span></span><br><span class="line"><span class="keyword">const</span> element = <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;container&quot;</span> <span class="attr">tabIndex</span>=<span class="string">&quot;0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br></pre></td></tr></table></figure><h3 id="çŠ¶æ€ä¸ç”Ÿå‘½å‘¨æœŸ"><a href="#çŠ¶æ€ä¸ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="çŠ¶æ€ä¸ç”Ÿå‘½å‘¨æœŸ"></a>çŠ¶æ€ä¸ç”Ÿå‘½å‘¨æœŸ</h3><p>ç»„ä»¶å¯ä»¥æœ‰è‡ªå·±çš„çŠ¶æ€ï¼Œå¹¶ä¸”ä¼šéšç€æ—¶é—´æ¨ç§»è€Œæ”¹å˜ã€‚</p><div style="background-color: #fff8dc; padding: 15px; border-left: 5px solid #f1c40f; margin-bottom: 15px;"><strong>æ³¨æ„</strong>ï¼šç†è§£ç»„ä»¶ç”Ÿå‘½å‘¨æœŸå¯¹äºæ­£ç¡®ç®¡ç†çŠ¶æ€å’Œå‰¯ä½œç”¨è‡³å…³é‡è¦ã€‚</div><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç±»ç»„ä»¶ä¸­çš„çŠ¶æ€å’Œç”Ÿå‘½å‘¨æœŸ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Clock</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123; <span class="attr">date</span>: <span class="keyword">new</span> <span class="title class_">Date</span>() &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">timerID</span> = <span class="built_in">setInterval</span>(</span><br><span class="line">      <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">tick</span>(),</span><br><span class="line">      <span class="number">1000</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">componentWillUnmount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="built_in">clearInterval</span>(<span class="variable language_">this</span>.<span class="property">timerID</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">tick</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">      <span class="attr">date</span>: <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, world!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>It is &#123;this.state.date.toLocaleTimeString()&#125;.<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="äº‹ä»¶å¤„ç†"><a href="#äº‹ä»¶å¤„ç†" class="headerlink" title="äº‹ä»¶å¤„ç†"></a>äº‹ä»¶å¤„ç†</h3><p>React äº‹ä»¶ä½¿ç”¨é©¼å³°å‘½åçº¦å®šï¼Œå¹¶ä¼ é€’ä¸€ä¸ªå‡½æ•°ä½œä¸ºäº‹ä»¶å¤„ç†ç¨‹åºã€‚</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// äº‹ä»¶å¤„ç†ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Toggle</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [isToggleOn, setIsToggleOn] = <span class="title function_">useState</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½¿ç”¨ç®­å¤´å‡½æ•°é¿å…ç»‘å®š this</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleClick</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">setIsToggleOn</span>(!isToggleOn);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;isToggleOn ? &#x27;ON&#x27; : &#x27;OFF&#x27;&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¡ä»¶æ¸²æŸ“å’Œåˆ—è¡¨"><a href="#æ¡ä»¶æ¸²æŸ“å’Œåˆ—è¡¨" class="headerlink" title="æ¡ä»¶æ¸²æŸ“å’Œåˆ—è¡¨"></a>æ¡ä»¶æ¸²æŸ“å’Œåˆ—è¡¨</h3><p>å¯ä»¥ä½¿ç”¨æ¡ä»¶è¿ç®—ç¬¦ã€é€»è¾‘è¿ç®—ç¬¦æˆ– if è¯­å¥æ¥è¿›è¡Œæ¡ä»¶æ¸²æŸ“ã€‚</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¡ä»¶æ¸²æŸ“ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Greeting</span>(<span class="params">&#123; isLoggedIn &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;isLoggedIn ? <span class="tag">&lt;<span class="name">UserGreeting</span> /&gt;</span> : <span class="tag">&lt;<span class="name">GuestGreeting</span> /&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">      </span></span><br><span class="line"><span class="language-xml">      &#123;/* æˆ–ä½¿ç”¨é€»è¾‘ä¸ */&#125;</span></span><br><span class="line"><span class="language-xml">      &#123;isLoggedIn &amp;&amp; <span class="tag">&lt;<span class="name">UserGreeting</span> /&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ—è¡¨æ¸²æŸ“é€šå¸¸ä½¿ç”¨ <code>map</code> æ–¹æ³•ã€‚</p><div style="background-color: #f8e5e5; padding: 15px; border-left: 5px solid #e74c3c; margin-bottom: 15px;"><strong>é‡è¦</strong>ï¼šåœ¨åˆ—è¡¨æ¸²æŸ“æ—¶ï¼Œæ¯ä¸ªå­å…ƒç´ éƒ½éœ€è¦ä¸€ä¸ªå”¯ä¸€çš„ <code>key</code> å±æ€§ï¼Œä»¥å¸®åŠ© React è¯†åˆ«å·²æ›´æ”¹çš„é¡¹ç›®ã€‚</div><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ—è¡¨æ¸²æŸ“ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">NumberList</span>(<span class="params">&#123; numbers &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;numbers.map(number =&gt; (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;number.toString()&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          &#123;number&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      ))&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å¸¸è§ç”¨æ³•ä¸æœ€ä½³å®è·µ"><a href="#å¸¸è§ç”¨æ³•ä¸æœ€ä½³å®è·µ" class="headerlink" title="å¸¸è§ç”¨æ³•ä¸æœ€ä½³å®è·µ"></a>å¸¸è§ç”¨æ³•ä¸æœ€ä½³å®è·µ</h2><h3 id="å‡½æ•°ç»„ä»¶ä¸-Hooks"><a href="#å‡½æ•°ç»„ä»¶ä¸-Hooks" class="headerlink" title="å‡½æ•°ç»„ä»¶ä¸ Hooks"></a>å‡½æ•°ç»„ä»¶ä¸ Hooks</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¨èçš„å‡½æ•°ç»„ä»¶å†™æ³•</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">UserProfile</span>(<span class="params">&#123; userId &#125;</span>) &#123;</span><br><span class="line">  <span class="comment">// çŠ¶æ€ç®¡ç†</span></span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = <span class="title function_">useState</span>(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">const</span> [isLoading, setIsLoading] = <span class="title function_">useState</span>(<span class="literal">true</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ä½¿ç”¨ useEffect å¤„ç†å‰¯ä½œç”¨</span></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> isMounted = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchUser</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title function_">setIsLoading</span>(<span class="literal">true</span>);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">fetchUserData</span>(userId);</span><br><span class="line">        <span class="keyword">if</span> (isMounted) &#123;</span><br><span class="line">          <span class="title function_">setUser</span>(data);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(error);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isMounted) &#123;</span><br><span class="line">          <span class="title function_">setIsLoading</span>(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">fetchUser</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¸…ç†å‡½æ•°</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      isMounted = <span class="literal">false</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, [userId]); <span class="comment">// ä¾èµ–é¡¹æ•°ç»„</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (isLoading) <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Loading</span> /&gt;</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (!user) <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">NotFound</span> /&gt;</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;user.name&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;user.email&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ"><a href="#çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ" class="headerlink" title="çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ"></a>çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨é¡¶å±‚ç»„ä»¶ä¸­ç®¡ç†å…±äº«çŠ¶æ€</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [theme, setTheme] = <span class="title function_">useState</span>(<span class="string">&#x27;light&#x27;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// æä¾›çŠ¶æ€å˜æ›´å‡½æ•°</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">toggleTheme</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">setTheme</span>(<span class="function"><span class="params">prevTheme</span> =&gt;</span> prevTheme === <span class="string">&#x27;light&#x27;</span> ? <span class="string">&#x27;dark&#x27;</span> : <span class="string">&#x27;light&#x27;</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// é€šè¿‡ context æˆ– props å‘ä¸‹ä¼ é€’</span></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">ThemeContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;&#123;</span> <span class="attr">theme</span>, <span class="attr">toggleTheme</span> &#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Main</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ThemeContext.Provider</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ useReducer å¤„ç†å¤æ‚çŠ¶æ€</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">taskReducer</span>(<span class="params">state, action</span>) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.<span class="property">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;ADD_TASK&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> [...state, &#123; <span class="attr">id</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(), <span class="attr">text</span>: action.<span class="property">payload</span>, <span class="attr">completed</span>: <span class="literal">false</span> &#125;];</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;TOGGLE_TASK&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> state.<span class="title function_">map</span>(<span class="function"><span class="params">task</span> =&gt;</span> </span><br><span class="line">        task.<span class="property">id</span> === action.<span class="property">payload</span> ? &#123; ...task, <span class="attr">completed</span>: !task.<span class="property">completed</span> &#125; : task</span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;DELETE_TASK&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> state.<span class="title function_">filter</span>(<span class="function"><span class="params">task</span> =&gt;</span> task.<span class="property">id</span> !== action.<span class="property">payload</span>);</span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">TaskList</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [tasks, dispatch] = <span class="title function_">useReducer</span>(taskReducer, []);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">AddTask</span> <span class="attr">onAdd</span>=<span class="string">&#123;text</span> =&gt;</span> dispatch(&#123; type: &#x27;ADD_TASK&#x27;, payload: text &#125;)&#125; /&gt;</span></span><br><span class="line"><span class="language-xml">      &#123;tasks.map(task =&gt; (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Task</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">key</span>=<span class="string">&#123;task.id&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">task</span>=<span class="string">&#123;task&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onToggle</span>=<span class="string">&#123;()</span> =&gt;</span> dispatch(&#123; type: &#x27;TOGGLE_TASK&#x27;, payload: task.id &#125;)&#125;</span></span><br><span class="line"><span class="language-xml">          onDelete=&#123;() =&gt; dispatch(&#123; type: &#x27;DELETE_TASK&#x27;, payload: task.id &#125;)&#125;</span></span><br><span class="line"><span class="language-xml">        /&gt;</span></span><br><span class="line"><span class="language-xml">      ))&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è‡ªå®šä¹‰-Hooks"><a href="#è‡ªå®šä¹‰-Hooks" class="headerlink" title="è‡ªå®šä¹‰ Hooks"></a>è‡ªå®šä¹‰ Hooks</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºå¯å¤ç”¨çš„é€»è¾‘</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useLocalStorage</span>(<span class="params">key, initialValue</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [storedValue, setStoredValue] = <span class="title function_">useState</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> item = <span class="variable language_">window</span>.<span class="property">localStorage</span>.<span class="title function_">getItem</span>(key);</span><br><span class="line">      <span class="keyword">return</span> item ? <span class="title class_">JSON</span>.<span class="title function_">parse</span>(item) : initialValue;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(error);</span><br><span class="line">      <span class="keyword">return</span> initialValue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">setValue</span> = value =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> valueToStore = value <span class="keyword">instanceof</span> <span class="title class_">Function</span> ? <span class="title function_">value</span>(storedValue) : value;</span><br><span class="line">      <span class="title function_">setStoredValue</span>(valueToStore);</span><br><span class="line">      <span class="variable language_">window</span>.<span class="property">localStorage</span>.<span class="title function_">setItem</span>(key, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(valueToStore));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> [storedValue, setValue];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨è‡ªå®šä¹‰ Hook</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">SettingsForm</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [settings, setSettings] = <span class="title function_">useLocalStorage</span>(<span class="string">&#x27;user-settings&#x27;</span>, &#123; <span class="attr">theme</span>: <span class="string">&#x27;light&#x27;</span>, <span class="attr">notifications</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ä½¿ç”¨å’Œæ™®é€š state ä¸€æ ·</span></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">select</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">value</span>=<span class="string">&#123;settings.theme&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">onChange</span>=<span class="string">&#123;e</span> =&gt;</span> setSettings(&#123;...settings, theme: e.target.value&#125;)&#125;</span></span><br><span class="line"><span class="language-xml">      &gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;light&quot;</span>&gt;</span>æµ…è‰²<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;dark&quot;</span>&gt;</span>æ·±è‰²<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Hook-è¯¦è§£ä¸æœ€ä½³å®è·µ"><a href="#Hook-è¯¦è§£ä¸æœ€ä½³å®è·µ" class="headerlink" title="Hook è¯¦è§£ä¸æœ€ä½³å®è·µ"></a>Hook è¯¦è§£ä¸æœ€ä½³å®è·µ</h2><h3 id="å¸¸è§-Hook-ç”¨æ³•æ€»ç»“"><a href="#å¸¸è§-Hook-ç”¨æ³•æ€»ç»“" class="headerlink" title="å¸¸è§ Hook ç”¨æ³•æ€»ç»“"></a>å¸¸è§ Hook ç”¨æ³•æ€»ç»“</h3><table><tr>  <th>Hook</th>  <th>ç”¨é€”</th>  <th>ä½¿ç”¨åœºæ™¯</th></tr><tr>  <td><code>useState</code></td>  <td>ç®¡ç†ç»„ä»¶çŠ¶æ€</td>  <td>éœ€è¦å“åº”å¼æ›´æ–°çš„æ•°æ®</td></tr><tr>  <td><code>useEffect</code></td>  <td>å¤„ç†å‰¯ä½œç”¨</td>  <td>APIè¯·æ±‚ã€è®¢é˜…ã€DOMæ“ä½œ</td></tr><tr>  <td><code>useContext</code></td>  <td>æ¶ˆè´¹ä¸Šä¸‹æ–‡</td>  <td>æ·±å±‚ä¼ é€’æ•°æ®</td></tr><tr>  <td><code>useReducer</code></td>  <td>ç®¡ç†å¤æ‚çŠ¶æ€</td>  <td>å¤šä¸ªç›¸å…³çŠ¶æ€æˆ–å¤æ‚é€»è¾‘</td></tr><tr>  <td><code>useCallback</code></td>  <td>è®°å¿†åŒ–å‡½æ•°</td>  <td>ä¼˜åŒ–å­ç»„ä»¶æ¸²æŸ“</td></tr><tr>  <td><code>useMemo</code></td>  <td>è®°å¿†åŒ–è®¡ç®—å€¼</td>  <td>é¿å…å¤æ‚è®¡ç®—é‡å¤æ‰§è¡Œ</td></tr><tr>  <td><code>useRef</code></td>  <td>ä¿å­˜å¯å˜å¼•ç”¨</td>  <td>è®¿é—®DOMã€ä¿å­˜ä¸è§¦å‘æ¸²æŸ“çš„å€¼</td></tr></table><h4 id="useState"><a href="#useState" class="headerlink" title="useState"></a>useState</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸºç¡€ç”¨æ³•</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);  <span class="comment">// å£°æ˜çŠ¶æ€å˜é‡å’Œæ›´æ–°å‡½æ•°</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ä½¿ç”¨å‡½æ•°åˆå§‹åŒ–ï¼ˆæƒ°æ€§åˆå§‹åŒ–ï¼‰- é€‚ç”¨äºæ˜‚è´µè®¡ç®—</span></span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = <span class="title function_">useState</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// æ­¤å‡½æ•°åªåœ¨ç»„ä»¶é¦–æ¬¡æ¸²æŸ“æ—¶æ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">const</span> savedUser = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;user&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> savedUser ? <span class="title class_">JSON</span>.<span class="title function_">parse</span>(savedUser) : <span class="literal">null</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ç®¡ç†å¤šä¸ªçŠ¶æ€</span></span><br><span class="line">  <span class="keyword">const</span> [loading, setLoading] = <span class="title function_">useState</span>(<span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">const</span> [error, setError] = <span class="title function_">useState</span>(<span class="literal">null</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>Count: &#123;count&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setCount(count + 1)&#125;&gt;å¢åŠ <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div style="background-color: #eafaf1; padding: 15px; border-left: 5px solid #2ecc71; margin: 15px 0;"><strong>ğŸ’¡ æœ€ä½³å®è·µ</strong>ï¼šå°†ç›¸å…³çŠ¶æ€åˆ†ç»„åˆ°ä¸€ä¸ªå¯¹è±¡ä¸­ï¼Œä½†æ³¨æ„æ›´æ–°æ—¶éœ€è¦ä¿æŒä¸å¯å˜æ€§ï¼ˆä½¿ç”¨å±•å¼€è¿ç®—ç¬¦ï¼‰ã€‚</div><h4 id="useEffect"><a href="#useEffect" class="headerlink" title="useEffect"></a>useEffect</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">DataFetcher</span>(<span class="params">&#123; userId &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [data, setData] = <span class="title function_">useState</span>(<span class="literal">null</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 1ï¸âƒ£ åŸºç¡€ç”¨æ³• - ç»„ä»¶æŒ‚è½½å’Œä¾èµ–é¡¹å˜åŒ–æ—¶æ‰§è¡Œ</span></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">fetchData</span>(userId).<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> <span class="title function_">setData</span>(data));</span><br><span class="line">  &#125;, [userId]); <span class="comment">// ä¾èµ–é¡¹æ•°ç»„</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 2ï¸âƒ£ æ¸…ç†å‡½æ•° - ç»„ä»¶å¸è½½æˆ–ä¾èµ–é¡¹å˜åŒ–å‰æ‰§è¡Œ</span></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> subscription = <span class="title function_">subscribe</span>(userId);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿”å›æ¸…ç†å‡½æ•°</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">unsubscribe</span>(subscription);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, [userId]);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 3ï¸âƒ£ åªåœ¨æŒ‚è½½æ—¶æ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">logComponentMount</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">logComponentUnmount</span>();</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, []); <span class="comment">// ç©ºä¾èµ–æ•°ç»„</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 4ï¸âƒ£ æ¯æ¬¡æ¸²æŸ“åæ‰§è¡Œ</span></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">updateDocumentTitle</span>(<span class="string">`Data for <span class="subst">$&#123;userId&#125;</span>`</span>);</span><br><span class="line">  &#125;); <span class="comment">// æ²¡æœ‰ç¬¬äºŒä¸ªå‚æ•°</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;/* æ¸²æŸ“æ•°æ® */&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div style="background-color: #fff8dc; padding: 15px; border-left: 5px solid #f1c40f; margin: 15px 0;"><strong>âš ï¸ æ³¨æ„</strong>ï¼šuseEffect ä¾èµ–é¡¹æ•°ç»„å¿…é¡»åŒ…å«æ‰€æœ‰åœ¨ effect ä¸­ä½¿ç”¨çš„ç»„ä»¶ä½œç”¨åŸŸä¸­çš„å€¼ï¼Œå¦åˆ™ä¼šå¯¼è‡´é—­åŒ…é™·é˜±ã€‚</div><h4 id="useContext"><a href="#useContext" class="headerlink" title="useContext"></a>useContext</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ThemeContext</span> = <span class="title function_">createContext</span>(<span class="string">&#x27;light&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¶ˆè´¹ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ThemeButton</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> theme = <span class="title function_">useContext</span>(<span class="title class_">ThemeContext</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">background:</span> <span class="attr">theme</span> === <span class="string">&#x27;dark&#x27;</span> ? &#x27;#<span class="attr">000</span>&#x27; <span class="attr">:</span> &#x27;#<span class="attr">fff</span>&#x27; &#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">      ä¸»é¢˜æŒ‰é’®</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æä¾›ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">ThemeContext.Provider</span> <span class="attr">value</span>=<span class="string">&quot;dark&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">ThemeButton</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ThemeContext.Provider</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="useReducer"><a href="#useReducer" class="headerlink" title="useReducer"></a>useReducer</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰reducer</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">todoReducer</span>(<span class="params">state, action</span>) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.<span class="property">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;ADD_TODO&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> [...state, &#123; <span class="attr">id</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(), <span class="attr">text</span>: action.<span class="property">text</span>, <span class="attr">completed</span>: <span class="literal">false</span> &#125;];</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;TOGGLE_TODO&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> state.<span class="title function_">map</span>(<span class="function"><span class="params">todo</span> =&gt;</span></span><br><span class="line">        todo.<span class="property">id</span> === action.<span class="property">id</span> ? &#123; ...todo, <span class="attr">completed</span>: !todo.<span class="property">completed</span> &#125; : todo</span><br><span class="line">      );</span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">TodoApp</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// state: å½“å‰çŠ¶æ€, dispatch: å‘é€æ›´æ–°çš„å‡½æ•°</span></span><br><span class="line">  <span class="keyword">const</span> [todos, dispatch] = <span class="title function_">useReducer</span>(todoReducer, []); <span class="comment">// åˆå§‹çŠ¶æ€ä¸ºç©ºæ•°ç»„</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ä½¿ç”¨dispatchè§¦å‘æ›´æ–°</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleAddTodo</span> = (<span class="params">text</span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="string">&#x27;ADD_TODO&#x27;</span>, text &#125;);  <span class="comment">// å‘é€actionå¯¹è±¡</span></span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">TodoForm</span> <span class="attr">onSubmit</span>=<span class="string">&#123;handleAddTodo&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">TodoList</span> <span class="attr">todos</span>=<span class="string">&#123;todos&#125;</span> <span class="attr">dispatch</span>=<span class="string">&#123;dispatch&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div style="display: flex; margin: 20px 0; border: 1px solid #ddd; border-radius: 5px; overflow: hidden;">  <div style="background-color: #f9f9f9; padding: 15px; width: 50%; box-sizing: border-box;">    <strong>useReducer é€‚ç”¨åœºæ™¯</strong>    <ul>      <li>çŠ¶æ€é€»è¾‘å¤æ‚</li>      <li>ä¸‹ä¸€ä¸ªçŠ¶æ€ä¾èµ–å‰ä¸€ä¸ªçŠ¶æ€</li>      <li>çŠ¶æ€ç”±å¤šä¸ªå­å€¼ç»„æˆçš„å¯¹è±¡</li>    </ul>  </div>  <div style="background-color: #f0f0f0; padding: 15px; width: 50%; box-sizing: border-box;">    <strong>useState é€‚ç”¨åœºæ™¯</strong>    <ul>      <li>ç®€å•çš„çŠ¶æ€é€»è¾‘</li>      <li>ç‹¬ç«‹çš„çŠ¶æ€æ›´æ–°</li>      <li>ç®€å•åŸºæœ¬ç±»å‹çš„çŠ¶æ€</li>    </ul>  </div></div><h3 id="ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸Hookså¯¹æ¯”"><a href="#ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸Hookså¯¹æ¯”" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸Hookså¯¹æ¯”"></a>ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸Hookså¯¹æ¯”</h3><table><thead><tr><th align="left">ç±»ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ</th><th align="left">Hookæ›¿ä»£æ–¹å¼</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left"><code>constructor()</code></td><td align="left"><code>useState()</code>, <code>useReducer()</code></td><td align="left">ä½¿ç”¨useStateæˆ–useReduceråˆå§‹åŒ–çŠ¶æ€</td></tr><tr><td align="left"><code>componentDidMount()</code></td><td align="left"><code>useEffect(() =&gt; &#123;&#125;, [])</code></td><td align="left">ä¼ å…¥ç©ºä¾èµ–æ•°ç»„çš„useEffect</td></tr><tr><td align="left"><code>componentDidUpdate()</code></td><td align="left"><code>useEffect(() =&gt; &#123;&#125;, [deps])</code></td><td align="left">æœ‰ä¾èµ–é¡¹çš„useEffect</td></tr><tr><td align="left"><code>componentWillUnmount()</code></td><td align="left"><code>useEffect</code>çš„æ¸…ç†å‡½æ•°</td><td align="left"><code>useEffect(() =&gt; &#123; return () =&gt; &#123;&#125; &#125;, [])</code></td></tr><tr><td align="left"><code>shouldComponentUpdate()</code></td><td align="left"><code>React.memo</code>, <code>useMemo</code></td><td align="left">ä½¿ç”¨React.memoåŒ…è£¹ç»„ä»¶ï¼Œæˆ–useMemoä¼˜åŒ–ç‰¹å®šè®¡ç®—</td></tr><tr><td align="left"><code>getSnapshotBeforeUpdate()</code></td><td align="left">é€šå¸¸ä½¿ç”¨<code>useRef</code> + <code>useLayoutEffect</code></td><td align="left">ç»„åˆä½¿ç”¨è¿™ä¸¤ä¸ªHookæ¨¡æ‹Ÿæ­¤åŠŸèƒ½</td></tr><tr><td align="left"><code>getDerivedStateFromProps()</code></td><td align="left"><code>useMemo</code> æˆ– ç›´æ¥åœ¨æ¸²æŸ“æœŸé—´è®¡ç®—</td><td align="left">åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­è®¡ç®—æ´¾ç”Ÿå€¼</td></tr><tr><td align="left"><code>static getDerivedStateFromError()</code> <br /> <code>componentDidCatch()</code></td><td align="left">ç›®å‰ä»éœ€è¦ä½¿ç”¨ç±»ç»„ä»¶çš„é”™è¯¯è¾¹ç•Œ</td><td align="left">Reactå›¢é˜Ÿè®¡åˆ’æä¾›Hookç‰ˆæœ¬</td></tr></tbody></table><h3 id="ä¸ºä½•ç”Ÿå‘½å‘¨æœŸè¢«Hookå–ä»£ï¼Ÿ"><a href="#ä¸ºä½•ç”Ÿå‘½å‘¨æœŸè¢«Hookå–ä»£ï¼Ÿ" class="headerlink" title="ä¸ºä½•ç”Ÿå‘½å‘¨æœŸè¢«Hookå–ä»£ï¼Ÿ"></a>ä¸ºä½•ç”Ÿå‘½å‘¨æœŸè¢«Hookå–ä»£ï¼Ÿ</h3><h4 id="å¤æ‚æ€§ä¸å…³æ³¨ç‚¹åˆ†ç¦»"><a href="#å¤æ‚æ€§ä¸å…³æ³¨ç‚¹åˆ†ç¦»" class="headerlink" title="å¤æ‚æ€§ä¸å…³æ³¨ç‚¹åˆ†ç¦»"></a>å¤æ‚æ€§ä¸å…³æ³¨ç‚¹åˆ†ç¦»</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç±»ç»„ä»¶ä¸­çš„ç”Ÿå‘½å‘¨æœŸæ··æ‚é—®é¢˜</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserDashboard</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">      <span class="attr">user</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">posts</span>: [],</span><br><span class="line">      <span class="attr">isOnline</span>: <span class="literal">false</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// è·å–ç”¨æˆ·æ•°æ®</span></span><br><span class="line">    <span class="title function_">fetchUser</span>(<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">userId</span>).<span class="title function_">then</span>(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; user &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–å¸–å­æ•°æ®</span></span><br><span class="line">    <span class="title function_">fetchPosts</span>(<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">userId</span>).<span class="title function_">then</span>(<span class="function"><span class="params">posts</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; posts &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¾ç½®åœ¨çº¿çŠ¶æ€ç›‘å¬</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">onlineListener</span> = onlineStatus.<span class="title function_">subscribe</span>(<span class="function">(<span class="params">status</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">isOnline</span>: status &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">componentDidUpdate</span>(<span class="params">prevProps</span>) &#123;</span><br><span class="line">    <span class="comment">// ç”¨æˆ·IDå˜åŒ–æ—¶æ›´æ–°</span></span><br><span class="line">    <span class="keyword">if</span> (prevProps.<span class="property">userId</span> !== <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">userId</span>) &#123;</span><br><span class="line">      <span class="comment">// é‡å¤ä¸Šé¢çš„æ•°æ®è·å–é€»è¾‘</span></span><br><span class="line">      <span class="title function_">fetchUser</span>(<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">userId</span>).<span class="title function_">then</span>(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; user &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">      </span><br><span class="line">      <span class="title function_">fetchPosts</span>(<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">userId</span>).<span class="title function_">then</span>(<span class="function"><span class="params">posts</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; posts &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">componentWillUnmount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// æ¸…ç†åœ¨çº¿çŠ¶æ€ç›‘å¬</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">onlineListener</span>.<span class="title function_">unsubscribe</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// æ¸²æŸ“æ–¹æ³•...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hookæ–¹å¼ï¼šæŒ‰å…³æ³¨ç‚¹åˆ†ç¦»</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">UserDashboard</span>(<span class="params">&#123; userId &#125;</span>) &#123;</span><br><span class="line">  <span class="comment">// ç”¨æˆ·æ•°æ®é€»è¾‘</span></span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = <span class="title function_">useState</span>(<span class="literal">null</span>);</span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">fetchUser</span>(userId).<span class="title function_">then</span>(setUser);</span><br><span class="line">  &#125;, [userId]); <span class="comment">// å½“userIdå˜åŒ–æ—¶è‡ªåŠ¨é‡æ–°è·å–</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å¸–å­æ•°æ®é€»è¾‘</span></span><br><span class="line">  <span class="keyword">const</span> [posts, setPosts] = <span class="title function_">useState</span>([]);</span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">fetchPosts</span>(userId).<span class="title function_">then</span>(setPosts);</span><br><span class="line">  &#125;, [userId]);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// åœ¨çº¿çŠ¶æ€é€»è¾‘</span></span><br><span class="line">  <span class="keyword">const</span> [isOnline, setIsOnline] = <span class="title function_">useState</span>(<span class="literal">false</span>);</span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> listener = onlineStatus.<span class="title function_">subscribe</span>(setIsOnline);</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> listener.<span class="title function_">unsubscribe</span>();</span><br><span class="line">  &#125;, []); <span class="comment">// åªåœ¨æŒ‚è½½å’Œå¸è½½æ—¶å¤„ç†</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// æ¸²æŸ“...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä»£ç é‡ç”¨å’Œé€»è¾‘æå–"><a href="#ä»£ç é‡ç”¨å’Œé€»è¾‘æå–" class="headerlink" title="ä»£ç é‡ç”¨å’Œé€»è¾‘æå–"></a>ä»£ç é‡ç”¨å’Œé€»è¾‘æå–</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç±»ç»„ä»¶ä¸­é‡ç”¨é€»è¾‘å›°éš¾</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserPostsA</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="comment">// é‡å¤çš„è·å–ç”¨æˆ·å¸–å­é€»è¾‘</span></span><br><span class="line">  <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">fetchPosts</span>(<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">userId</span>).<span class="title function_">then</span>(<span class="function"><span class="params">posts</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; posts &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">componentDidUpdate</span>(<span class="params">prevProps</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (prevProps.<span class="property">userId</span> !== <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">userId</span>) &#123;</span><br><span class="line">      <span class="title function_">fetchPosts</span>(<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">userId</span>).<span class="title function_">then</span>(<span class="function"><span class="params">posts</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; posts &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// æ¸²æŸ“æ–¹æ³•...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserPostsB</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="comment">// å‡ ä¹ç›¸åŒçš„é€»è¾‘å¤åˆ¶</span></span><br><span class="line">  <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">fetchPosts</span>(<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">userId</span>).<span class="title function_">then</span>(<span class="function"><span class="params">posts</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; posts &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">componentDidUpdate</span>(<span class="params">prevProps</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (prevProps.<span class="property">userId</span> !== <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">userId</span>) &#123;</span><br><span class="line">      <span class="title function_">fetchPosts</span>(<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">userId</span>).<span class="title function_">then</span>(<span class="function"><span class="params">posts</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; posts &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ç•¥æœ‰ä¸åŒçš„æ¸²æŸ“æ–¹æ³•...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hookæ–¹å¼ï¼šé€»è¾‘æå–åˆ°è‡ªå®šä¹‰Hook</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">usePosts</span>(<span class="params">userId</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [posts, setPosts] = <span class="title function_">useState</span>([]);</span><br><span class="line">  <span class="keyword">const</span> [loading, setLoading] = <span class="title function_">useState</span>(<span class="literal">true</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setLoading</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="title function_">fetchPosts</span>(userId)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">setPosts</span>(data);</span><br><span class="line">        <span class="title function_">setLoading</span>(<span class="literal">false</span>);</span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(error);</span><br><span class="line">        <span class="title function_">setLoading</span>(<span class="literal">false</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;, [userId]);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> &#123; posts, loading &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨å¤šä¸ªç»„ä»¶ä¸­å¤ç”¨</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">UserPostsA</span>(<span class="params">&#123; userId &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; posts, loading &#125; = <span class="title function_">usePosts</span>(userId);</span><br><span class="line">  <span class="comment">// ç»„ä»¶ç‰¹å®šçš„æ¸²æŸ“é€»è¾‘...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">UserPostsB</span>(<span class="params">&#123; userId &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; posts, loading &#125; = <span class="title function_">usePosts</span>(userId);</span><br><span class="line">  <span class="comment">// ä¸åŒçš„æ¸²æŸ“é€»è¾‘...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="é—­åŒ…ä¸thisé—®é¢˜"><a href="#é—­åŒ…ä¸thisé—®é¢˜" class="headerlink" title="é—­åŒ…ä¸thisé—®é¢˜"></a>é—­åŒ…ä¸thisé—®é¢˜</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç±»ç»„ä»¶ä¸­çš„thisç»‘å®šé—®é¢˜</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Counter</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123; <span class="attr">count</span>: <span class="number">0</span> &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// éœ€è¦æ‰‹åŠ¨ç»‘å®šthis</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handleClick</span> = <span class="variable language_">this</span>.<span class="property">handleClick</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">handleClick</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">count</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">count</span> + <span class="number">1</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;this.handleClick&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        Click me: &#123;this.state.count&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hookä¸­æ²¡æœ‰thisé—®é¢˜</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ä¸éœ€è¦ç»‘å®šï¼Œé—­åŒ…è‡ªç„¶æ•è·å½“å‰å˜é‡</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleClick</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">setCount</span>(count + <span class="number">1</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      Click me: &#123;count&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä¸€è‡´æ€§ä¸å¯é¢„æµ‹æ€§"><a href="#ä¸€è‡´æ€§ä¸å¯é¢„æµ‹æ€§" class="headerlink" title="ä¸€è‡´æ€§ä¸å¯é¢„æµ‹æ€§"></a>ä¸€è‡´æ€§ä¸å¯é¢„æµ‹æ€§</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç±»ç»„ä»¶ä¸­çš„ç”Ÿå‘½å‘¨æœŸä¸ä¸€è‡´æ€§</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Example</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123; <span class="attr">count</span>: <span class="number">0</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">title</span> = <span class="string">`Count: <span class="subst">$&#123;<span class="variable language_">this</span>.state.count&#125;</span>`</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">interval</span> = <span class="built_in">setInterval</span>(<span class="variable language_">this</span>.<span class="property">tick</span>, <span class="number">1000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">componentDidUpdate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">title</span> = <span class="string">`Count: <span class="subst">$&#123;<span class="variable language_">this</span>.state.count&#125;</span>`</span>;</span><br><span class="line">    <span class="comment">// å¿˜è®°æ£€æŸ¥propsæˆ–stateå˜åŒ–å¯èƒ½å¯¼è‡´é—®é¢˜</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">componentWillUnmount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="built_in">clearInterval</span>(<span class="variable language_">this</span>.<span class="property">interval</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  tick = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">count</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">count</span> + <span class="number">1</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;this.state.count&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hookå¸¦æ¥çš„ä¸€è‡´æ€§</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Example</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ç»Ÿä¸€å¤„ç†æ ‡é¢˜æ›´æ–°æ•ˆæœ</span></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">title</span> = <span class="string">`Count: <span class="subst">$&#123;count&#125;</span>`</span>;</span><br><span class="line">  &#125;, [count]); <span class="comment">// æ˜ç¡®ä¾èµ–</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å®šæ—¶å™¨æ•ˆæœ</span></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> interval = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">setCount</span>(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="built_in">clearInterval</span>(interval);</span><br><span class="line">  &#125;, []); <span class="comment">// æ˜ç¡®åªæ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ€»ç»“ï¼šHookçš„ä¼˜åŠ¿"><a href="#æ€»ç»“ï¼šHookçš„ä¼˜åŠ¿" class="headerlink" title="æ€»ç»“ï¼šHookçš„ä¼˜åŠ¿"></a>æ€»ç»“ï¼šHookçš„ä¼˜åŠ¿</h3><ol><li><strong>å…³æ³¨ç‚¹åˆ†ç¦»</strong>ï¼šå¯ä»¥æŒ‰åŠŸèƒ½è€Œéç”Ÿå‘½å‘¨æœŸåˆ’åˆ†ä»£ç </li><li><strong>ä»£ç å¤ç”¨</strong>ï¼šè‡ªå®šä¹‰Hookä½¿é€»è¾‘å¤ç”¨å˜å¾—ç®€å•ç›´è§‚</li><li><strong>é¿å…this</strong>ï¼šä¸éœ€è¦ç†è§£JavaScriptä¸­çš„thisç»‘å®šé—®é¢˜</li><li><strong>å‡å°‘æ¨¡æ¿ä»£ç </strong>ï¼šä¸éœ€è¦ç¼–å†™ç±»ã€æ„é€ å‡½æ•°ç­‰æ¨¡æ¿ä»£ç </li><li><strong>ä¼˜åŒ–ç¼–è¯‘</strong>ï¼šå‡½æ•°ç»„ä»¶æ›´å®¹æ˜“è¢«ç¼–è¯‘å™¨ä¼˜åŒ–</li><li><strong>æ›´å¥½çš„TypeScriptæ”¯æŒ</strong>ï¼šæ³›å‹å’Œç±»å‹æ¨æ–­åœ¨å‡½æ•°ç»„ä»¶ä¸­å·¥ä½œå¾—æ›´å¥½</li><li><strong>ä¸€è‡´æ€§</strong>ï¼šä½¿ç”¨ç›¸åŒæ¨¡å¼å¤„ç†ä¸åŒç§ç±»çš„å‰¯ä½œç”¨</li><li><strong>é¿å…é‡å¤</strong>ï¼šé¿å…åœ¨ä¸åŒç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸­å¤åˆ¶ç›¸åŒçš„ä»£ç </li><li><strong>æ›´å°çš„åŒ…ä½“ç§¯</strong>ï¼šé€šå¸¸ç”Ÿæˆæ›´å°çš„ä»£ç </li></ol><h2 id="é¡¹ç›®å®è·µæ³¨æ„äº‹é¡¹"><a href="#é¡¹ç›®å®è·µæ³¨æ„äº‹é¡¹" class="headerlink" title="é¡¹ç›®å®è·µæ³¨æ„äº‹é¡¹"></a>é¡¹ç›®å®è·µæ³¨æ„äº‹é¡¹</h2><h3 id="åˆç†çš„ç»„ä»¶æ‹†åˆ†"><a href="#åˆç†çš„ç»„ä»¶æ‹†åˆ†" class="headerlink" title="åˆç†çš„ç»„ä»¶æ‹†åˆ†"></a>åˆç†çš„ç»„ä»¶æ‹†åˆ†</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ é”™è¯¯ï¼šè‡ƒè‚¿çš„ç»„ä»¶</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Dashboard</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// å¤§é‡çŠ¶æ€å’Œé€»è¾‘...</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;/* å¤§é‡ JSX... */&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… æ­£ç¡®ï¼šæ‹†åˆ†ä¸ºå°å‹ã€ä¸“æ³¨çš„ç»„ä»¶</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Dashboard</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Header</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Sidebar</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">MainContent</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Summary</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">RecentActivity</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Statistics</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">MainContent</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Footer</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ•°æ®è·å–ä¸çŠ¶æ€ç®¡ç†"><a href="#æ•°æ®è·å–ä¸çŠ¶æ€ç®¡ç†" class="headerlink" title="æ•°æ®è·å–ä¸çŠ¶æ€ç®¡ç†"></a>æ•°æ®è·å–ä¸çŠ¶æ€ç®¡ç†</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âœ… ä½¿ç”¨ React Query ç­‰åº“ç®¡ç†æ•°æ®è·å–çŠ¶æ€</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">UserList</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; data, isLoading, error &#125; = <span class="title function_">useQuery</span>(<span class="string">&#x27;users&#x27;</span>, fetchUsers);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (isLoading) <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Loading</span> /&gt;</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Error</span> <span class="attr">message</span>=<span class="string">&#123;error.message&#125;</span> /&gt;</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;data.map(user =&gt; (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;user.id&#125;</span>&gt;</span>&#123;user.name&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      ))&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… ä½¿ç”¨çŠ¶æ€ç®¡ç†åº“å¤„ç†å…¨å±€çŠ¶æ€</span></span><br><span class="line"><span class="comment">// ä¾‹å¦‚ Redux Toolkit</span></span><br><span class="line"><span class="keyword">import</span> &#123; createSlice, configureStore &#125; <span class="keyword">from</span> <span class="string">&#x27;@reduxjs/toolkit&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> counterSlice = <span class="title function_">createSlice</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;counter&#x27;</span>,</span><br><span class="line">  <span class="attr">initialState</span>: &#123; <span class="attr">value</span>: <span class="number">0</span> &#125;,</span><br><span class="line">  <span class="attr">reducers</span>: &#123;</span><br><span class="line">    <span class="attr">increment</span>: <span class="function"><span class="params">state</span> =&gt;</span> &#123;</span><br><span class="line">      state.<span class="property">value</span> += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = <span class="title function_">configureStore</span>(&#123;</span><br><span class="line">  <span class="attr">reducer</span>: &#123;</span><br><span class="line">    <span class="attr">counter</span>: counterSlice.<span class="property">reducer</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="ç»„ä»¶é€šä¿¡ç­–ç•¥"><a href="#ç»„ä»¶é€šä¿¡ç­–ç•¥" class="headerlink" title="ç»„ä»¶é€šä¿¡ç­–ç•¥"></a>ç»„ä»¶é€šä¿¡ç­–ç•¥</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âœ… å¯¹äºæ·±å±‚ç»„ä»¶é€šä¿¡ï¼Œä½¿ç”¨ Context API</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ThemeContext</span> = <span class="title function_">createContext</span>(<span class="string">&#x27;light&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [theme, setTheme] = <span class="title function_">useState</span>(<span class="string">&#x27;light&#x27;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">ThemeContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;&#123;</span> <span class="attr">theme</span>, <span class="attr">setTheme</span> &#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Main</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ThemeContext.Provider</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨æ·±å±‚ç»„ä»¶ä¸­ä½¿ç”¨</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ThemedButton</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; theme, setTheme &#125; = <span class="title function_">useContext</span>(<span class="title class_">ThemeContext</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">background:</span> <span class="attr">theme</span> === <span class="string">&#x27;light&#x27;</span> ? &#x27;#<span class="attr">fff</span>&#x27; <span class="attr">:</span> &#x27;#<span class="attr">000</span>&#x27; &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setTheme(theme === &#x27;light&#x27; ? &#x27;dark&#x27; : &#x27;light&#x27;)&#125;</span></span><br><span class="line"><span class="language-xml">    &gt;</span></span><br><span class="line"><span class="language-xml">      åˆ‡æ¢ä¸»é¢˜</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é”™è¯¯è¾¹ç•Œå¤„ç†"><a href="#é”™è¯¯è¾¹ç•Œå¤„ç†" class="headerlink" title="é”™è¯¯è¾¹ç•Œå¤„ç†"></a>é”™è¯¯è¾¹ç•Œå¤„ç†</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰é”™è¯¯è¾¹ç•Œç»„ä»¶</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ErrorBoundary</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123; <span class="attr">hasError</span>: <span class="literal">false</span>, <span class="attr">error</span>: <span class="literal">null</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">getDerivedStateFromError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">hasError</span>: <span class="literal">true</span>, error &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">componentDidCatch</span>(<span class="params">error, errorInfo</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;Caught error:&quot;</span>, error, errorInfo);</span><br><span class="line">    <span class="comment">// å¯ä»¥å‘é€åˆ°é”™è¯¯è¿½è¸ªæœåŠ¡</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">hasError</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">fallback</span> || <span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>å‡ºé”™äº†<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">children</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨é”™è¯¯è¾¹ç•ŒåŒ…è£¹å¯èƒ½å‡ºé”™çš„ç»„ä»¶</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">ErrorBoundary</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">p</span>&gt;</span>å¤´éƒ¨åŠ è½½å¤±è´¥<span class="tag">&lt;/<span class="name">p</span>&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Header</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">ErrorBoundary</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">ErrorBoundary</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">p</span>&gt;</span>å†…å®¹åŠ è½½å¤±è´¥<span class="tag">&lt;/<span class="name">p</span>&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Content</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">ErrorBoundary</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€§èƒ½ä¼˜åŒ–æŠ€å·§"><a href="#æ€§èƒ½ä¼˜åŒ–æŠ€å·§" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–æŠ€å·§"></a>æ€§èƒ½ä¼˜åŒ–æŠ€å·§</h2><div style="background-color: #eafaf1; padding: 20px; border-radius: 5px; margin: 20px 0;"><h3 style="margin-top: 0; color: #27ae60;">âš¡ æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒåŸåˆ™</h3><ol>  <li><strong>å‡å°‘æ¸²æŸ“æ¬¡æ•°</strong>ï¼šé¿å…ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“</li>  <li><strong>å‡å°‘è®¡ç®—é‡</strong>ï¼šç¼“å­˜è®¡ç®—ç»“æœå’Œå›è°ƒå‡½æ•°</li>  <li><strong>å‡å°‘æ¸²æŸ“é‡</strong>ï¼šåªæ¸²æŸ“ç”¨æˆ·å¯è§çš„å†…å®¹</li>  <li><strong>ä»£ç åˆ†å‰²</strong>ï¼šæŒ‰éœ€åŠ è½½ä»£ç </li>  <li><strong>èµ„æºä¼˜åŒ–</strong>ï¼šä¼˜åŒ–å›¾ç‰‡å’Œå…¶ä»–èµ„æº</li></ol></div><h3 id="React-memo-useMemo-å’Œ-useCallback"><a href="#React-memo-useMemo-å’Œ-useCallback" class="headerlink" title="React.memo, useMemo å’Œ useCallback"></a>React.memo, useMemo å’Œ useCallback</h3><p>è¿™äº›APIå¸®åŠ©æˆ‘ä»¬æ§åˆ¶ç»„ä»¶å’Œå€¼çš„é‡æ–°è®¡ç®—ï¼Œé¿å…ä¸å¿…è¦çš„æ¸²æŸ“å’Œè®¡ç®—ã€‚</p><div style="display: flex; flex-wrap: wrap; gap: 20px; margin: 20px 0;">  <div style="flex: 1; min-width: 300px; border: 1px solid #ddd; border-radius: 5px; padding: 15px;">    <h4>React.memo</h4>    <p>è®°å¿†åŒ–ç»„ä»¶ï¼Œå½“propsä¸å˜æ—¶è·³è¿‡é‡æ–°æ¸²æŸ“</p>    <pre><code>const MemoComponent = React.memo(MyComponent);</code></pre>  </div>  <div style="flex: 1; min-width: 300px; border: 1px solid #ddd; border-radius: 5px; padding: 15px;">    <h4>useMemo</h4>    <p>è®°å¿†åŒ–è®¡ç®—ç»“æœï¼Œä¾èµ–é¡¹ä¸å˜æ—¶è·³è¿‡é‡æ–°è®¡ç®—</p>    <pre><code>const result = useMemo(() => compute(a, b), [a, b]);</code></pre>  </div>  <div style="flex: 1; min-width: 300px; border: 1px solid #ddd; border-radius: 5px; padding: 15px;">    <h4>useCallback</h4>    <p>è®°å¿†åŒ–å›è°ƒå‡½æ•°ï¼Œä¾èµ–é¡¹ä¸å˜æ—¶ä¿æŒå‡½æ•°å¼•ç”¨ä¸å˜</p>    <pre><code>const handler = useCallback(() => doSomething(a), [a]);</code></pre>  </div></div><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨ React.memo é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MemoizedComponent</span> = <span class="title class_">React</span>.<span class="title function_">memo</span>(<span class="keyword">function</span> <span class="title function_">MyComponent</span>(<span class="params">props</span>) &#123;</span><br><span class="line">  <span class="comment">// åªæœ‰å½“ props å˜åŒ–æ—¶æ‰ä¼šé‡æ–°æ¸²æŸ“</span></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;props.name&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•° - æ·±åº¦æ§åˆ¶é‡æ–°æ¸²æŸ“çš„æ¡ä»¶</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">areEqual</span> = (<span class="params">prevProps, nextProps</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// åªæ¯”è¾ƒå…³å¿ƒçš„ props</span></span><br><span class="line">  <span class="keyword">return</span> prevProps.<span class="property">id</span> === nextProps.<span class="property">id</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MemoizedWithCustomCompare</span> = <span class="title class_">React</span>.<span class="title function_">memo</span>(<span class="title class_">MyComponent</span>, areEqual);</span><br><span class="line"></span><br><span class="line"><span class="comment">// é…åˆ useCallback ä½¿ç”¨ä»¥ç¨³å®šåŒ–ä¼ é€’ç»™å­ç»„ä»¶çš„å‡½æ•°å¼•ç”¨</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ParentComponent</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ä¸ä½¿ç”¨ useCallback æ—¶ï¼Œæ¯æ¬¡ ParentComponent é‡æ–°æ¸²æŸ“ï¼ŒhandleClick éƒ½æ˜¯æ–°å‡½æ•°</span></span><br><span class="line">  <span class="comment">// å¯¼è‡´ MemoizedComponent å°½ç®¡ä½¿ç”¨äº† React.memo ä¹Ÿä¼šé‡æ–°æ¸²æŸ“</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ä½¿ç”¨ useCallback è®°å¿†åŒ–å‡½æ•°ï¼Œä¿æŒå¼•ç”¨ç¨³å®š</span></span><br><span class="line">  <span class="keyword">const</span> handleClick = <span class="title function_">useCallback</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Button clicked&#x27;</span>);</span><br><span class="line">  &#125;, []); <span class="comment">// ä¾èµ–é¡¹ä¸ºç©ºæ•°ç»„ï¼ŒhandleClick å¼•ç”¨æ°¸è¿œä¸å˜</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">MemoizedComponent</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setCount(count + 1)&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        æ›´æ–°è®¡æ•°: &#123;count&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div style="background-color: #fff8dc; padding: 15px; border-left: 5px solid #f1c40f; margin: 15px 0;"><strong>âš ï¸ æ³¨æ„</strong>ï¼šè¿‡åº¦ä¼˜åŒ–å¯èƒ½å¯¼è‡´ä»£ç å¤æ‚æ€§å¢åŠ ã€‚åœ¨åº”ç”¨è¿™äº›æŠ€æœ¯å‰ï¼Œç¡®ä¿ä½ å·²ç»é‡åˆ°äº†çœŸæ­£çš„æ€§èƒ½é—®é¢˜ã€‚</div><h3 id="è™šæ‹Ÿåˆ—è¡¨æ¸²æŸ“"><a href="#è™šæ‹Ÿåˆ—è¡¨æ¸²æŸ“" class="headerlink" title="è™šæ‹Ÿåˆ—è¡¨æ¸²æŸ“"></a>è™šæ‹Ÿåˆ—è¡¨æ¸²æŸ“</h3><p>å½“éœ€è¦æ¸²æŸ“å¤§é‡æ•°æ®æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è™šæ‹Ÿåˆ—è¡¨æŠ€æœ¯åªæ¸²æŸ“å¯è§†åŒºåŸŸå†…çš„é¡¹ç›®ã€‚</p><div style="text-align: center; margin: 20px 0;"><pre style="display: inline-block; text-align: left; background-color: #f9f9f9; padding: 15px; border-radius: 5px;">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚    å¯è§†åŒºåŸŸ (ä¾‹å¦‚600px)   â”‚â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚ Item 1                  â”‚ â—„â”€â”€ åªæ¸²æŸ“è¿™äº›å¯è§é¡¹â”‚ Item 2                  â”‚â”‚ Item 3                  â”‚â”‚ ...                     â”‚â”‚ Item 20                 â”‚â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚                         â”‚â”‚  (å…¶ä»–1000ä¸ªé¡¹ä¸æ¸²æŸ“)     â”‚ â—„â”€â”€ èŠ‚çœå†…å­˜å’ŒCPUâ”‚                         â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</pre></div><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨ react-window å®ç°è™šæ‹Ÿåˆ—è¡¨</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">FixedSizeList</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react-window&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">VirtualizedList</span>(<span class="params">&#123; items &#125;</span>) &#123;</span><br><span class="line">  <span class="comment">// Row ç»„ä»¶å¤ç”¨ - æ ¹æ®æä¾›çš„ index æ¸²æŸ“ä¸åŒçš„å†…å®¹</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">Row</span> = (<span class="params">&#123; index, style &#125;</span>) =&gt; (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;style&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      Item &#123;items[index]&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">FixedSizeList</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">height</span>=<span class="string">&#123;500&#125;</span>        // <span class="attr">åˆ—è¡¨å¯è§†åŒºåŸŸé«˜åº¦</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">width</span>=<span class="string">&quot;100%&quot;</span>        // <span class="attr">åˆ—è¡¨å®½åº¦</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">itemCount</span>=<span class="string">&#123;items.length&#125;</span>  // <span class="attr">æ€»é¡¹ç›®æ•°é‡</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">itemSize</span>=<span class="string">&#123;35&#125;</span>       // <span class="attr">æ¯é¡¹é«˜åº¦</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    &gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;Row&#125;  // æ¸²æŸ“æ¯è¡Œçš„ç»„ä»¶</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">FixedSizeList</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä»£ç åˆ†å‰²ä¸æ‡’åŠ è½½"><a href="#ä»£ç åˆ†å‰²ä¸æ‡’åŠ è½½" class="headerlink" title="ä»£ç åˆ†å‰²ä¸æ‡’åŠ è½½"></a>ä»£ç åˆ†å‰²ä¸æ‡’åŠ è½½</h3><div style="background-color: #f0f7fb; padding: 15px; border-left: 5px solid #3498db; margin: 15px 0;"><strong>ğŸ’¡ æœ€ä½³å®è·µ</strong>ï¼šå°†åº”ç”¨æ‹†åˆ†æˆè¾ƒå°çš„ä»£ç å—ï¼Œå¹¶æŒ‰éœ€åŠ è½½ï¼Œå¯ä»¥æ˜¾è‘—å‡å°‘åˆå§‹åŠ è½½æ—¶é—´ã€‚</div><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨ React.lazy å’Œ Suspense å®ç°ä»£ç åˆ†å‰²å’Œæ‡’åŠ è½½</span></span><br><span class="line"><span class="comment">// ä¸å¯¼å…¥æ•´ä¸ªç»„ä»¶ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªåŠ¨æ€åŠ è½½ç»„ä»¶çš„Promise</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">LazyComponent</span> = <span class="title class_">React</span>.<span class="title function_">lazy</span>(<span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;./LazyComponent&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">MyComponent</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="comment">// Suspense åœ¨ç»„ä»¶åŠ è½½æ—¶æ˜¾ç¤º fallback å†…å®¹</span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">div</span>&gt;</span>Loading...<span class="tag">&lt;/<span class="name">div</span>&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">LazyComponent</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŸºäºè·¯ç”±çš„ä»£ç åˆ†å‰² - æŒ‰é¡µé¢æ‹†åˆ†ä»£ç </span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BrowserRouter</span> <span class="keyword">as</span> <span class="title class_">Router</span>, <span class="title class_">Routes</span>, <span class="title class_">Route</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Home</span> = <span class="title class_">React</span>.<span class="title function_">lazy</span>(<span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;./routes/Home&#x27;</span>));</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">About</span> = <span class="title class_">React</span>.<span class="title function_">lazy</span>(<span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;./routes/About&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Router</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">div</span>&gt;</span>Loading...<span class="tag">&lt;/<span class="name">div</span>&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Routes</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;/&quot;</span> <span class="attr">element</span>=<span class="string">&#123;</span>&lt;<span class="attr">Home</span> /&gt;</span>&#125; /&gt;</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;/about&quot;</span> <span class="attr">element</span>=<span class="string">&#123;</span>&lt;<span class="attr">About</span> /&gt;</span>&#125; /&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Routes</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Router</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨-React-DevTools-è¿›è¡Œæ€§èƒ½åˆ†æ"><a href="#ä½¿ç”¨-React-DevTools-è¿›è¡Œæ€§èƒ½åˆ†æ" class="headerlink" title="ä½¿ç”¨ React DevTools è¿›è¡Œæ€§èƒ½åˆ†æ"></a>ä½¿ç”¨ React DevTools è¿›è¡Œæ€§èƒ½åˆ†æ</h3><div style="display: flex; flex-direction: column; gap: 10px; margin: 20px 0; background-color: #f9f9f9; padding: 15px; border-radius: 5px;">  <div><strong>æ€§èƒ½åˆ†ææ­¥éª¤ï¼š</strong></div>  <div>1ï¸âƒ£ å®‰è£… React DevTools æ‰©å±•</div>  <div>2ï¸âƒ£ æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œåˆ‡æ¢åˆ° Profiler é€‰é¡¹å¡</div>  <div>3ï¸âƒ£ ç‚¹å‡»å½•åˆ¶æŒ‰é’®ï¼Œæ‰§è¡Œè¦åˆ†æçš„æ“ä½œ</div>  <div>4ï¸âƒ£ åœæ­¢å½•åˆ¶ï¼Œåˆ†æç«ç„°å›¾å’Œæ’åå›¾è¡¨</div>  <div>5ï¸âƒ£ æ‰¾å‡ºé‡æ–°æ¸²æŸ“æ¬¡æ•°è¿‡å¤šæˆ–æ¸²æŸ“æ—¶é—´è¿‡é•¿çš„ç»„ä»¶</div>  <div>6ï¸âƒ£ ä½¿ç”¨ memo, useMemo, useCallback ç­‰ä¼˜åŒ–</div></div><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨ Profiler API è¿›è¡Œç¨‹åºåŒ–æ€§èƒ½æµ‹é‡</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Profiler</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ€§èƒ½æ•°æ®å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">onRenderCallback</span>(<span class="params"></span></span><br><span class="line"><span class="params">  id,            <span class="comment">// å‘ç”Ÿæäº¤çš„ Profiler æ ‘çš„ &quot;id&quot;</span></span></span><br><span class="line"><span class="params">  phase,         <span class="comment">// &quot;mount&quot; (é¦–æ¬¡æŒ‚è½½) æˆ– &quot;update&quot; (é‡æ–°æ¸²æŸ“)</span></span></span><br><span class="line"><span class="params">  actualDuration, <span class="comment">// æœ¬æ¬¡æ›´æ–°ä¸­æ¸²æŸ“èŠ±è´¹çš„æ—¶é—´</span></span></span><br><span class="line"><span class="params">  baseDuration,  <span class="comment">// ä¼°è®¡ä¸ä½¿ç”¨ memoization çš„æƒ…å†µä¸‹æ¸²æŸ“æ•´ä¸ªå­æ ‘éœ€è¦çš„æ—¶é—´</span></span></span><br><span class="line"><span class="params">  startTime,     <span class="comment">// æœ¬æ¬¡æ›´æ–°ä¸­ React å¼€å§‹æ¸²æŸ“çš„æ—¶é—´æˆ³</span></span></span><br><span class="line"><span class="params">  commitTime,    <span class="comment">// æœ¬æ¬¡æ›´æ–°ä¸­ React æäº¤æ›´æ–°çš„æ—¶é—´æˆ³</span></span></span><br><span class="line"><span class="params">  interactions   <span class="comment">// å±äºæœ¬æ¬¡æ›´æ–°çš„ interactions é›†åˆ</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// å°†æ€§èƒ½æ•°æ®å‘é€åˆ°åˆ†ææœåŠ¡æˆ–è®°å½•åˆ°æ§åˆ¶å°</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ç»„ä»¶ <span class="subst">$&#123;id&#125;</span> <span class="subst">$&#123;phase&#125;</span> æ¸²æŸ“è€—æ—¶: <span class="subst">$&#123;actualDuration&#125;</span>ms`</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">MyApp</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Profiler</span> <span class="attr">id</span>=<span class="string">&quot;App&quot;</span> <span class="attr">onRender</span>=<span class="string">&#123;onRenderCallback&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">App</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Profiler</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="React-18-æ ¸å¿ƒç‰¹æ€§"><a href="#React-18-æ ¸å¿ƒç‰¹æ€§" class="headerlink" title="React 18 æ ¸å¿ƒç‰¹æ€§"></a>React 18 æ ¸å¿ƒç‰¹æ€§</h2><h3 id="å¹¶å‘æ¸²æŸ“-Concurrent-Rendering"><a href="#å¹¶å‘æ¸²æŸ“-Concurrent-Rendering" class="headerlink" title="å¹¶å‘æ¸²æŸ“ (Concurrent Rendering)"></a>å¹¶å‘æ¸²æŸ“ (Concurrent Rendering)</h3><p>React 18 å¼•å…¥çš„æœ€é‡è¦ç‰¹æ€§æ˜¯å¹¶å‘æ¸²æŸ“ï¼Œè¿™ä½¿ React èƒ½å¤ŸåŒæ—¶å‡†å¤‡å¤šä¸ªUIçŠ¶æ€ï¼Œè€Œä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚</p><h4 id="å®é™…åº”ç”¨"><a href="#å®é™…åº”ç”¨" class="headerlink" title="å®é™…åº”ç”¨"></a>å®é™…åº”ç”¨</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨ Transition API è¿›è¡Œéé˜»å¡æ›´æ–°</span></span><br><span class="line"><span class="keyword">import</span> &#123; startTransition, useTransition &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">SearchResults</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [query, setQuery] = <span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> [isPending, startTransition] = <span class="title function_">useTransition</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">updateQuery</span> = (<span class="params">e</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// ç´§æ€¥æ›´æ–°ï¼šç«‹å³å“åº”ç”¨æˆ·è¾“å…¥</span></span><br><span class="line">    <span class="title function_">setInputValue</span>(e.<span class="property">target</span>.<span class="property">value</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// éç´§æ€¥æ›´æ–°ï¼šå¯ä»¥è¢«ä¸­æ–­çš„æœç´¢ç»“æœæ›´æ–°</span></span><br><span class="line">    <span class="title function_">startTransition</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">setQuery</span>(e.<span class="property">target</span>.<span class="property">value</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">onChange</span>=<span class="string">&#123;updateQuery&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;isPending &amp;&amp; <span class="tag">&lt;<span class="name">div</span>&gt;</span>åŠ è½½ä¸­...<span class="tag">&lt;/<span class="name">div</span>&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">SearchResults</span> <span class="attr">query</span>=<span class="string">&#123;query&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è‡ªåŠ¨æ‰¹å¤„ç†-Automatic-Batching"><a href="#è‡ªåŠ¨æ‰¹å¤„ç†-Automatic-Batching" class="headerlink" title="è‡ªåŠ¨æ‰¹å¤„ç† (Automatic Batching)"></a>è‡ªåŠ¨æ‰¹å¤„ç† (Automatic Batching)</h3><p>React 18 é»˜è®¤å¯¹æ‰€æœ‰æ›´æ–°è¿›è¡Œæ‰¹å¤„ç†ï¼ŒåŒ…æ‹¬äº‹ä»¶å¤„ç†ç¨‹åºã€å®šæ—¶å™¨ã€promisesç­‰ï¼Œå‡å°‘ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“ã€‚</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨ React 18 ä¹‹å‰</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handleClick</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// è¿™äº›ä¼šå¯¼è‡´ä¸¤æ¬¡å•ç‹¬çš„æ¸²æŸ“</span></span><br><span class="line">  <span class="title function_">setCount</span>(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>);</span><br><span class="line">  <span class="title function_">setFlag</span>(<span class="function"><span class="params">f</span> =&gt;</span> !f);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// React 18 ä¸­è‡ªåŠ¨æ‰¹å¤„ç† - åªæœ‰ä¸€æ¬¡æ¸²æŸ“</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handleClick</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">setCount</span>(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>);</span><br><span class="line">  <span class="title function_">setFlag</span>(<span class="function"><span class="params">f</span> =&gt;</span> !f);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¦ç”¨æ‰¹å¤„ç†ï¼ˆå¦‚æœéœ€è¦ï¼‰</span></span><br><span class="line"><span class="keyword">import</span> &#123; flushSync &#125; <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handleClick</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">flushSync</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setCount</span>(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// ç«‹å³æ¸²æŸ“</span></span><br><span class="line">  <span class="title function_">flushSync</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setFlag</span>(<span class="function"><span class="params">f</span> =&gt;</span> !f);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// å†æ¬¡ç«‹å³æ¸²æŸ“</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Suspense-æ”¹è¿›"><a href="#Suspense-æ”¹è¿›" class="headerlink" title="Suspense æ”¹è¿›"></a>Suspense æ”¹è¿›</h3><p>React 18 å¯¹ Suspense ç»„ä»¶è¿›è¡Œäº†å¢å¼ºï¼Œæ”¯æŒæœåŠ¡ç«¯æ¸²æŸ“å’Œå¹¶å‘ç‰¹æ€§ã€‚</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Suspense</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">Loading</span> /&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">SomeComponent</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ–°çš„å®¢æˆ·ç«¯æ¸²æŸ“-API"><a href="#æ–°çš„å®¢æˆ·ç«¯æ¸²æŸ“-API" class="headerlink" title="æ–°çš„å®¢æˆ·ç«¯æ¸²æŸ“ API"></a>æ–°çš„å®¢æˆ·ç«¯æ¸²æŸ“ API</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// React 18 ä¹‹å‰</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ReactDOM</span> <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span>;</span><br><span class="line"><span class="title class_">ReactDOM</span>.<span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span></span>, container);</span><br><span class="line"></span><br><span class="line"><span class="comment">// React 18</span></span><br><span class="line"><span class="keyword">import</span> &#123; createRoot &#125; <span class="keyword">from</span> <span class="string">&#x27;react-dom/client&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> root = <span class="title function_">createRoot</span>(container);</span><br><span class="line">root.<span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span></span>);</span><br></pre></td></tr></table></figure><h3 id="useId-Hook"><a href="#useId-Hook" class="headerlink" title="useId Hook"></a>useId Hook</h3><p>ç”ŸæˆæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¸€è‡´çš„å”¯ä¸€ IDã€‚</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">NameFields</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> id = <span class="title function_">useId</span>();</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">label</span> <span class="attr">htmlFor</span>=<span class="string">&#123;</span>`$&#123;<span class="attr">id</span>&#125;<span class="attr">-firstName</span>`&#125;&gt;</span>First Name<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&#123;</span>`$&#123;<span class="attr">id</span>&#125;<span class="attr">-firstName</span>`&#125; /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">label</span> <span class="attr">htmlFor</span>=<span class="string">&#123;</span>`$&#123;<span class="attr">id</span>&#125;<span class="attr">-lastName</span>`&#125;&gt;</span>Last Name<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&#123;</span>`$&#123;<span class="attr">id</span>&#125;<span class="attr">-lastName</span>`&#125; /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="useDeferredValue"><a href="#useDeferredValue" class="headerlink" title="useDeferredValue"></a>useDeferredValue</h3><p>å…è®¸å»¶è¿Ÿæ›´æ–°éå…³é”®UIéƒ¨åˆ†ã€‚</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">SearchResults</span>(<span class="params">&#123; query &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> deferredQuery = <span class="title function_">useDeferredValue</span>(query);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ä½¿ç”¨ deferredQuery è¿›è¡Œæœç´¢ï¼Œè¿™éƒ¨åˆ†å¯èƒ½ä¼š&quot;æ»å&quot;äºè¾“å…¥</span></span><br><span class="line">  <span class="comment">// ä½†ä¸ä¼šé˜»å¡ç”¨æˆ·äº¤äº’</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Results</span> <span class="attr">query</span>=<span class="string">&#123;deferredQuery&#125;</span> /&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="React-19-æ–°ç‰¹æ€§ä¸å±•æœ›"><a href="#React-19-æ–°ç‰¹æ€§ä¸å±•æœ›" class="headerlink" title="React 19 æ–°ç‰¹æ€§ä¸å±•æœ›"></a>React 19 æ–°ç‰¹æ€§ä¸å±•æœ›</h2><blockquote><p>æ³¨ï¼šReact 19 ä»åœ¨å¼€å‘ä¸­ï¼Œä»¥ä¸‹å†…å®¹åŸºäºå®˜æ–¹å·²å…¬å¸ƒä¿¡æ¯å’Œå¼€å‘è·¯çº¿å›¾ã€‚</p></blockquote><h3 id="æ–°çš„-React-ç¼–è¯‘å™¨"><a href="#æ–°çš„-React-ç¼–è¯‘å™¨" class="headerlink" title="æ–°çš„ React ç¼–è¯‘å™¨"></a>æ–°çš„ React ç¼–è¯‘å™¨</h3><p>React 19 å°†å¼•å…¥ä¸€ä¸ªæ–°çš„ç¼–è¯‘å™¨ï¼Œå¯ä»¥è‡ªåŠ¨ä¼˜åŒ–ç»„ä»¶æ¸²æŸ“ï¼Œå‡å°‘ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“ã€‚</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¼–è¯‘å‰</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>You clicked &#123;count&#125; times<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setCount(count + 1)&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        Click me</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¼–è¯‘å (ç¤ºæ„ï¼Œå®é™…ç¼–è¯‘ç»“æœå¯èƒ½ä¸åŒ)</span></span><br><span class="line"><span class="comment">// ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨åˆ†æå¹¶ä¼˜åŒ–ç»„ä»¶æ¸²æŸ“é€»è¾‘</span></span><br></pre></td></tr></table></figure><h3 id="Actions"><a href="#Actions" class="headerlink" title="Actions"></a>Actions</h3><p>React 19 çš„ä¸€ä¸ªä¸»è¦æ–°ç‰¹æ€§æ˜¯ Actionsï¼Œå®ƒå°†å…è®¸ç›´æ¥åœ¨ç»„ä»¶ä¸­å®šä¹‰ä¸æœåŠ¡å™¨äº¤äº’çš„é€»è¾‘ã€‚</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// React 19 ä¸­çš„ Actions (ç¤ºä¾‹)</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">MyForm</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// å®šä¹‰ä¸€ä¸ªå¯ä»¥ç›´æ¥æäº¤åˆ°æœåŠ¡å™¨çš„åŠ¨ä½œ</span></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">saveAction</span>(<span class="params">formData</span>) &#123;</span><br><span class="line">    <span class="string">&#x27;use server&#x27;</span>;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">saveToDatabase</span>(formData);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&#123;saveAction&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>ä¿å­˜<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Hooks-çš„æ”¹è¿›"><a href="#Hooks-çš„æ”¹è¿›" class="headerlink" title="Hooks çš„æ”¹è¿›"></a>Hooks çš„æ”¹è¿›</h3><p>React 19 å°†è¿›ä¸€æ­¥æ”¹è¿› Hooks APIï¼Œä»¥è§£å†³ä¸€äº›ç°æœ‰çš„é™åˆ¶å’Œé—®é¢˜ã€‚</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// React 19 ä¸­å¯èƒ½çš„æ–° Hook (ç¤ºä¾‹)</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">MyComponent</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; value, setValue &#125; = <span class="title function_">useSignal</span>(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>å½“å‰å€¼: &#123;value&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setValue(value + 1)&#125;&gt;å¢åŠ <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Asset-Loading"><a href="#Asset-Loading" class="headerlink" title="Asset Loading"></a>Asset Loading</h3><p>æ”¹è¿›èµ„æºåŠ è½½æœºåˆ¶ï¼Œæ›´å¥½åœ°å¤„ç†å›¾ç‰‡ã€å­—ä½“ç­‰èµ„æºã€‚</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// React 19 ä¸­å¯èƒ½çš„èµ„æºåŠ è½½API</span></span><br><span class="line"><span class="keyword">import</span> &#123; useAsset &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Avatar</span>(<span class="params">&#123; src &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> imgAsset = <span class="title function_">useAsset</span>(src);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (imgAsset.<span class="property">loading</span>) <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Spinner</span> /&gt;</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (imgAsset.<span class="property">error</span>) <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">ErrorFallback</span> <span class="attr">error</span>=<span class="string">&#123;imgAsset.error&#125;</span> /&gt;</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#123;imgAsset.url&#125;</span> /&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ˜“é”™ç‚¹ä¸é™·é˜±"><a href="#æ˜“é”™ç‚¹ä¸é™·é˜±" class="headerlink" title="æ˜“é”™ç‚¹ä¸é™·é˜±"></a>æ˜“é”™ç‚¹ä¸é™·é˜±</h2><h3 id="å¸¸è§çš„é”™è¯¯å’Œé™·é˜±"><a href="#å¸¸è§çš„é”™è¯¯å’Œé™·é˜±" class="headerlink" title="å¸¸è§çš„é”™è¯¯å’Œé™·é˜±"></a>å¸¸è§çš„é”™è¯¯å’Œé™·é˜±</h3><ol><li><strong>çŠ¶æ€ç®¡ç†</strong>ï¼šä¸æ­£ç¡®çš„çŠ¶æ€ç®¡ç†å¯èƒ½å¯¼è‡´ç»„ä»¶æ— æ³•æ­£ç¡®æ¸²æŸ“æˆ–æ›´æ–°ã€‚</li><li><strong>äº‹ä»¶å¤„ç†</strong>ï¼šä¸æ­£ç¡®çš„äº‹ä»¶å¤„ç†å¯èƒ½å¯¼è‡´ç»„ä»¶æ— æ³•å“åº”ç”¨æˆ·è¾“å…¥ã€‚</li><li><strong>æ¡ä»¶æ¸²æŸ“</strong>ï¼šä¸æ­£ç¡®çš„æ¡ä»¶æ¸²æŸ“å¯èƒ½å¯¼è‡´ç»„ä»¶æ— æ³•æ­£ç¡®æ˜¾ç¤ºæˆ–éšè—ã€‚</li><li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šä¸æ­£ç¡®çš„æ€§èƒ½ä¼˜åŒ–å¯èƒ½å¯¼è‡´åº”ç”¨æ€§èƒ½ä¸‹é™ã€‚</li></ol><h3 id="è§£å†³æ–¹æ³•"><a href="#è§£å†³æ–¹æ³•" class="headerlink" title="è§£å†³æ–¹æ³•"></a>è§£å†³æ–¹æ³•</h3><ol><li><strong>ä½¿ç”¨æ­£ç¡®çš„çŠ¶æ€ç®¡ç†åº“</strong>ï¼šä¾‹å¦‚ï¼ŒRedux Toolkit æˆ– React Context APIã€‚</li><li><strong>æ­£ç¡®å¤„ç†äº‹ä»¶</strong>ï¼šç¡®ä¿äº‹ä»¶å¤„ç†ç¨‹åºæ­£ç¡®ç»‘å®šå’Œæ‰§è¡Œã€‚</li><li><strong>ä½¿ç”¨æ¡ä»¶æ¸²æŸ“</strong>ï¼šç¡®ä¿æ¡ä»¶é€»è¾‘æ­£ç¡®ï¼Œé¿å…ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“ã€‚</li><li><strong>è¿›è¡Œæ€§èƒ½æµ‹è¯•</strong>ï¼šä½¿ç”¨ React DevTools æˆ– Profiler API è¿›è¡Œæ€§èƒ½åˆ†æã€‚</li></ol><h3 id="ä¾èµ–é¡¹æ•°ç»„å¤„ç†ä¸å½“"><a href="#ä¾èµ–é¡¹æ•°ç»„å¤„ç†ä¸å½“" class="headerlink" title="ä¾èµ–é¡¹æ•°ç»„å¤„ç†ä¸å½“"></a>ä¾èµ–é¡¹æ•°ç»„å¤„ç†ä¸å½“</h3><div style="background-color: #f8e5e5; padding: 15px; border-left: 5px solid #e74c3c; margin: 15px 0;"><strong>ğŸš« å¸¸è§é”™è¯¯</strong>ï¼šåœ¨ useEffect çš„ä¾èµ–é¡¹æ•°ç»„ä¸­é—æ¼ä½¿ç”¨çš„å˜é‡ï¼Œå¯èƒ½å¯¼è‡´è¿‡æ—¶é—­åŒ…é—®é¢˜ã€‚</div><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ é”™è¯¯ï¼šç¼ºå°‘ä¾èµ–é¡¹</span></span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">fetchData</span>(userId);</span><br><span class="line">&#125;, []); <span class="comment">// åº”è¯¥åŒ…å« userId</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… æ­£ç¡®ï¼šåŒ…å«æ‰€æœ‰ä¾èµ–é¡¹</span></span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">fetchData</span>(userId);</span><br><span class="line">&#125;, [userId]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… æ›´å¥½çš„åšæ³•ï¼šä½¿ç”¨ useCallback ç¨³å®šåŒ–å‡½æ•°</span></span><br><span class="line"><span class="keyword">const</span> fetchUserData = <span class="title function_">useCallback</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">fetchData</span>(userId);</span><br><span class="line">&#125;, [userId]);</span><br><span class="line"></span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">fetchUserData</span>();</span><br><span class="line">&#125;, [fetchUserData]);</span><br></pre></td></tr></table></figure><h3 id="çŠ¶æ€æ›´æ–°åæ— æ³•ç«‹å³è·å–æœ€æ–°å€¼"><a href="#çŠ¶æ€æ›´æ–°åæ— æ³•ç«‹å³è·å–æœ€æ–°å€¼" class="headerlink" title="çŠ¶æ€æ›´æ–°åæ— æ³•ç«‹å³è·å–æœ€æ–°å€¼"></a>çŠ¶æ€æ›´æ–°åæ— æ³•ç«‹å³è·å–æœ€æ–°å€¼</h3><div style="display: flex; margin: 20px 0;">  <div style="background-color: #ffcccc; padding: 15px; border-radius: 5px 0 0 5px; width: 48%;">    <strong>âŒ é—®é¢˜</strong>    <p>React çŠ¶æ€æ›´æ–°æ˜¯å¼‚æ­¥çš„ï¼Œå› æ­¤åœ¨è°ƒç”¨ setState ä¹‹åç«‹å³å°è¯•è¯»å–çŠ¶æ€å€¼ä¼šå¾—åˆ°æ›´æ–°å‰çš„æ—§å€¼ã€‚</p>  </div>  <div style="background-color: #ccffcc; padding: 15px; border-radius: 0 5px 5px 0; width: 48%;">    <strong>âœ… è§£å†³æ–¹æ¡ˆ</strong>    <p>ä½¿ç”¨ useEffect ç›‘å¬çŠ¶æ€å˜åŒ–ï¼Œæˆ–ä½¿ç”¨å‡½æ•°å¼æ›´æ–°å›è°ƒè®¿é—®æœ€æ–°çŠ¶æ€ã€‚</p>  </div></div><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ é”™è¯¯ï¼šçŠ¶æ€æ›´æ–°åç«‹å³ä½¿ç”¨</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleClick</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">setCount</span>(count + <span class="number">1</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(count); <span class="comment">// ä»ç„¶æ˜¯æ—§å€¼ï¼Œä¸ä¼šç«‹å³æ›´æ–°</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é”™è¯¯åœ°å°è¯•åŸºäºæ›´æ–°åçš„çŠ¶æ€æ‰§è¡Œæ“ä½œ</span></span><br><span class="line">    <span class="keyword">if</span> (count === <span class="number">10</span>) &#123;</span><br><span class="line">      <span class="title function_">alert</span>(<span class="string">&#x27;è¾¾åˆ°10æ¬¡ç‚¹å‡»ï¼&#x27;</span>); <span class="comment">// æ— æ³•æ­£ç¡®è§¦å‘ï¼Œå› ä¸ºcountè¿˜æ˜¯æ—§å€¼</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      ç‚¹å‡»æ¬¡æ•°: &#123;count&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… æ­£ç¡®ï¼šä½¿ç”¨useEffectç›‘å¬çŠ¶æ€å˜åŒ–</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å½“countå˜åŒ–æ—¶è§¦å‘</span></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (count === <span class="number">10</span>) &#123;</span><br><span class="line">      <span class="title function_">alert</span>(<span class="string">&#x27;è¾¾åˆ°10æ¬¡ç‚¹å‡»ï¼&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [count]);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleClick</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">setCount</span>(count + <span class="number">1</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      ç‚¹å‡»æ¬¡æ•°: &#123;count&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… å¦ä¸€ç§æ–¹å¼ï¼šä½¿ç”¨å‡½æ•°å¼æ›´æ–°çš„å›è°ƒ</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleClick</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">setCount</span>(<span class="function"><span class="params">prevCount</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> newCount = prevCount + <span class="number">1</span>;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// åœ¨è¿™é‡Œå¯ä»¥è®¿é—®åˆ°æ›´æ–°åçš„å€¼</span></span><br><span class="line">      <span class="keyword">if</span> (newCount === <span class="number">10</span>) &#123;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&#x27;è¾¾åˆ°10æ¬¡ç‚¹å‡»ï¼&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> newCount;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      ç‚¹å‡»æ¬¡æ•°: &#123;count&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¯¹è±¡å’Œæ•°ç»„çŠ¶æ€æ›´æ–°"><a href="#å¯¹è±¡å’Œæ•°ç»„çŠ¶æ€æ›´æ–°" class="headerlink" title="å¯¹è±¡å’Œæ•°ç»„çŠ¶æ€æ›´æ–°"></a>å¯¹è±¡å’Œæ•°ç»„çŠ¶æ€æ›´æ–°</h3><div style="background-color: #f0f7fb; padding: 15px; border-left: 5px solid #3498db; margin: 15px 0;"><strong>ğŸ’¡ å…³é”®æ¦‚å¿µ</strong>ï¼šReact ä½¿ç”¨æµ…æ¯”è¾ƒæ¥æ£€æµ‹çŠ¶æ€å˜åŒ–ã€‚å½“æ›´æ–°å¯¹è±¡æˆ–æ•°ç»„çŠ¶æ€æ—¶ï¼Œå¿…é¡»åˆ›å»ºæ–°çš„å¼•ç”¨ï¼Œè€Œä¸æ˜¯ä¿®æ”¹ç°æœ‰å¼•ç”¨ã€‚</div><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ é”™è¯¯ï¼šç›´æ¥ä¿®æ”¹çŠ¶æ€å¯¹è±¡</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">UserProfile</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = <span class="title function_">useState</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;å¼ ä¸‰&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">25</span>,</span><br><span class="line">    <span class="attr">address</span>: &#123;</span><br><span class="line">      <span class="attr">city</span>: <span class="string">&#x27;åŒ—äº¬&#x27;</span>,</span><br><span class="line">      <span class="attr">street</span>: <span class="string">&#x27;æœé˜³åŒº&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">updateStreet</span> = (<span class="params">newStreet</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// ç›´æ¥ä¿®æ”¹çŠ¶æ€ï¼Œä¸ä¼šè§¦å‘é‡æ–°æ¸²æŸ“</span></span><br><span class="line">    user.<span class="property">address</span>.<span class="property">street</span> = newStreet;</span><br><span class="line">    <span class="title function_">setUser</span>(user); <span class="comment">// è¿™æ²¡ç”¨ï¼Œå› ä¸ºå¼•ç”¨æ²¡å˜</span></span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// âŒ é”™è¯¯ï¼šæ•°ç»„æ“ä½œåŒæ ·çš„é—®é¢˜</span></span><br><span class="line">  <span class="keyword">const</span> [items, setItems] = <span class="title function_">useState</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">addItem</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    items.<span class="title function_">push</span>(<span class="number">4</span>); <span class="comment">// ç›´æ¥ä¿®æ”¹æ•°ç»„</span></span><br><span class="line">    <span class="title function_">setItems</span>(items); <span class="comment">// ä¸ä¼šè§¦å‘é‡æ–°æ¸²æŸ“ï¼Œå› ä¸ºå¼•ç”¨æ²¡å˜</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… æ­£ç¡®ï¼šä½¿ç”¨å±•å¼€è¿ç®—ç¬¦åˆ›å»ºæ–°å¯¹è±¡</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">UserProfile</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = <span class="title function_">useState</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;å¼ ä¸‰&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">25</span>,</span><br><span class="line">    <span class="attr">address</span>: &#123;</span><br><span class="line">      <span class="attr">city</span>: <span class="string">&#x27;åŒ—äº¬&#x27;</span>,</span><br><span class="line">      <span class="attr">street</span>: <span class="string">&#x27;æœé˜³åŒº&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">updateStreet</span> = (<span class="params">newStreet</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// æ­£ç¡®åœ°åˆ›å»ºæ–°å¯¹è±¡</span></span><br><span class="line">    <span class="title function_">setUser</span>(&#123;</span><br><span class="line">      ...user,</span><br><span class="line">      <span class="attr">address</span>: &#123;</span><br><span class="line">        ...user.<span class="property">address</span>,</span><br><span class="line">        <span class="attr">street</span>: newStreet</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// âœ… æ­£ç¡®ï¼šæ•°ç»„æ“ä½œ</span></span><br><span class="line">  <span class="keyword">const</span> [items, setItems] = <span class="title function_">useState</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">addItem</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">setItems</span>([...items, <span class="number">4</span>]); <span class="comment">// åˆ›å»ºæ–°æ•°ç»„</span></span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ä½¿ç”¨æ•°ç»„çš„filterã€mapç­‰ä¸å¯å˜æ–¹æ³•</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">removeItem</span> = (<span class="params">index</span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">setItems</span>(items.<span class="title function_">filter</span>(<span class="function">(<span class="params">_, i</span>) =&gt;</span> i !== index));</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¡ä»¶æ¸²æŸ“ä¸­çš„Hookä½¿ç”¨"><a href="#æ¡ä»¶æ¸²æŸ“ä¸­çš„Hookä½¿ç”¨" class="headerlink" title="æ¡ä»¶æ¸²æŸ“ä¸­çš„Hookä½¿ç”¨"></a>æ¡ä»¶æ¸²æŸ“ä¸­çš„Hookä½¿ç”¨</h3><div style="background-color: #f8e5e5; padding: 15px; border: 2px dashed #e74c3c; margin: 15px 0; border-radius: 5px;"><strong>âš ï¸ Hookè§„åˆ™</strong>ï¼š<ol><li>åªåœ¨å‡½æ•°ç»„ä»¶æˆ–è‡ªå®šä¹‰Hookçš„é¡¶å±‚è°ƒç”¨Hook</li><li>ä¸è¦åœ¨å¾ªç¯ã€æ¡ä»¶æˆ–åµŒå¥—å‡½æ•°ä¸­è°ƒç”¨Hook</li><li>éµå¾ªè¿™äº›è§„åˆ™ç¡®ä¿Hookåœ¨æ¯æ¬¡æ¸²æŸ“æ—¶éƒ½ä»¥ç›¸åŒçš„é¡ºåºè¢«è°ƒç”¨</li></ol></div><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ é”™è¯¯ï¼šæ¡ä»¶æ€§è°ƒç”¨Hooks</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ConditionalHook</span>(<span class="params">&#123; isLoggedIn &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (isLoggedIn) &#123;</span><br><span class="line">    <span class="comment">// é”™è¯¯ï¼šä¸èƒ½åœ¨æ¡ä»¶è¯­å¥ä¸­è°ƒç”¨Hook</span></span><br><span class="line">    <span class="keyword">const</span> [name, setName] = <span class="title function_">useState</span>(<span class="string">&#x27;user&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// é”™è¯¯ï¼šä¸èƒ½åœ¨å¾ªç¯ä¸­è°ƒç”¨Hook</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> [item, setItem] = <span class="title function_">useState</span>(i);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// é”™è¯¯ï¼šä¸èƒ½åœ¨æ™®é€šå‡½æ•°ä¸­è°ƒç”¨Hook</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">handleClick</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> [clicked, setClicked] = <span class="title function_">useState</span>(<span class="literal">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… æ­£ç¡®ï¼šHookså¿…é¡»åœ¨ç»„ä»¶é¡¶å±‚æ— æ¡ä»¶è°ƒç”¨</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">CorrectHookUsage</span>(<span class="params">&#123; isLoggedIn &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> [name, setName] = <span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>);  <span class="comment">// å§‹ç»ˆè°ƒç”¨ï¼Œä¸ç®¡isLoggedInçš„å€¼</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// æ­£ç¡®ï¼šæ¡ä»¶è¯­å¥åœ¨Hookè°ƒç”¨ä¹‹å</span></span><br><span class="line">  <span class="keyword">if</span> (isLoggedIn) &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨å·²å£°æ˜çš„state</span></span><br><span class="line">    <span class="title function_">setName</span>(<span class="string">&#x27;user&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;isLoggedIn &amp;&amp; <span class="tag">&lt;<span class="name">p</span>&gt;</span>æ¬¢è¿, &#123;name&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>ç‚¹å‡»æ¬¡æ•°: &#123;count&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setCount(count + 1)&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        ç‚¹å‡»</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="é¢å¤–èµ„æº"><a href="#é¢å¤–èµ„æº" class="headerlink" title="é¢å¤–èµ„æº"></a>é¢å¤–èµ„æº</h2><ol><li><a href="https://react.dev/">React å®˜æ–¹æ–‡æ¡£</a></li><li><a href="https://github.com/facebook/react">React GitHub å­˜å‚¨åº“</a></li><li><a href="https://reactjs.org/blog/">React å›¢é˜Ÿåšå®¢</a></li><li><a href="https://github.com/reactwg/react-18">React 18 å·¥ä½œç»„è®¨è®º</a></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;React-18-19-å­¦ä¹ æ€»ç»“&quot;&gt;&lt;a href=&quot;#React-18-19-å­¦ä¹ æ€»ç»“&quot; class=&quot;headerlink&quot; title=&quot;React 18&amp;#x2F;19 å­¦ä¹ æ€»ç»“&quot;&gt;&lt;/a&gt;React 18&amp;#x2F;19 å­¦ä¹ æ€»ç»“&lt;/h1&gt;&lt;h2 id=</summary>
      
    
    
    
    
    <category term="react" scheme="https://aoayaoa.github.io/tags/react/"/>
    
  </entry>
  
  <entry>
    <title>nginx å­¦ä¹ é…ç½®è®°å½•</title>
    <link href="https://aoayaoa.github.io/2025/01/07/nginx/"/>
    <id>https://aoayaoa.github.io/2025/01/07/nginx/</id>
    <published>2025-01-06T16:00:00.000Z</published>
    <updated>2025-04-14T08:05:46.547Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Nginx-Web-æœåŠ¡å™¨é…ç½®"><a href="#Nginx-Web-æœåŠ¡å™¨é…ç½®" class="headerlink" title="Nginx Web æœåŠ¡å™¨é…ç½®"></a>Nginx Web æœåŠ¡å™¨é…ç½®</h1><p>ä¸€ä¸ªç”Ÿäº§ç¯å¢ƒreadyçš„Nginxé…ç½®æ¨¡æ¿ï¼ŒåŒ…å«HTTP&#x2F;2ã€SSLã€å®‰å…¨å¤´ä¿¡æ¯å’Œæ€§èƒ½ä¼˜åŒ–ã€‚</p><h2 id="ğŸ“‹-ç‰¹æ€§"><a href="#ğŸ“‹-ç‰¹æ€§" class="headerlink" title="ğŸ“‹ ç‰¹æ€§"></a>ğŸ“‹ ç‰¹æ€§</h2><ul><li>æ”¯æŒHTTP&#x2F;2ä»¥æå‡æ€§èƒ½</li><li>è‡ªåŠ¨HTTPåˆ°HTTPSé‡å®šå‘</li><li>ç°ä»£SSL&#x2F;TLSé…ç½®ä¸å®‰å…¨å¯†ç å¥—ä»¶</li><li>é™æ€æ–‡ä»¶ç¼“å­˜ä»¥æé«˜æ€§èƒ½</li><li>Gzipå‹ç¼©ä»¥å‡å°‘å¸¦å®½ä½¿ç”¨</li><li>PHP-FPMæ”¯æŒPHPåº”ç”¨</li><li>åç«¯æœåŠ¡çš„åå‘ä»£ç†é…ç½®</li><li>åŒ…æ‹¬HSTSåœ¨å†…çš„å®‰å…¨å¤´ä¿¡æ¯</li><li>ä¼˜åŒ–çš„æ€§èƒ½è®¾ç½®</li></ul><h2 id="ğŸš€-å®‰è£…"><a href="#ğŸš€-å®‰è£…" class="headerlink" title="ğŸš€ å®‰è£…"></a>ğŸš€ å®‰è£…</h2><h3 id="å‰ææ¡ä»¶"><a href="#å‰ææ¡ä»¶" class="headerlink" title="å‰ææ¡ä»¶"></a>å‰ææ¡ä»¶</h3><ul><li>Nginx (å»ºè®®1.18+ç‰ˆæœ¬)</li><li>ç”¨äºSSL&#x2F;TLSæ”¯æŒçš„OpenSSL</li><li>æœ‰æ•ˆçš„SSLè¯ä¹¦(ç”¨äºHTTPSæ”¯æŒ)</li></ul><h3 id="å®‰è£…æ­¥éª¤"><a href="#å®‰è£…æ­¥éª¤" class="headerlink" title="å®‰è£…æ­¥éª¤"></a>å®‰è£…æ­¥éª¤</h3><ol><li><p><strong>å®‰è£…Nginx:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Debian/Ubuntu</span></span><br><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS/RHEL</span></span><br><span class="line"><span class="built_in">sudo</span> yum install epel-release</span><br><span class="line"><span class="built_in">sudo</span> yum install nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># macOS</span></span><br><span class="line">brew install nginx</span><br></pre></td></tr></table></figure></li><li><p><strong>æ›¿æ¢é»˜è®¤Nginxé…ç½®:</strong></p><p>å°†<code>nginx.conf</code>æ–‡ä»¶å¤åˆ¶åˆ°Nginxé…ç½®ç›®å½•:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> nginx.conf /etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure></li><li><p><strong>åˆ›å»ºSSLè¯ä¹¦ç›®å½•:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /etc/nginx/ssl</span><br></pre></td></tr></table></figure></li><li><p><strong>å®‰è£…SSLè¯ä¹¦:</strong></p><p>å°†SSLè¯ä¹¦å’Œå¯†é’¥æ–‡ä»¶æ”¾åœ¨<code>/etc/nginx/ssl/</code>ç›®å½•ä¸­:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> example.com.crt /etc/nginx/ssl/</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> example.com.key /etc/nginx/ssl/</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ æ²¡æœ‰è¯ä¹¦ï¼Œå¯ä»¥ä½¿ç”¨Letâ€™s Encryptç”Ÿæˆ:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install certbot python3-certbot-nginx</span><br><span class="line"><span class="built_in">sudo</span> certbot --nginx -d example.com -d www.example.com</span><br></pre></td></tr></table></figure></li><li><p><strong>æ›´æ–°åŸŸå:</strong></p><p>ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼Œå°†<code>example.com</code>æ›¿æ¢ä¸ºä½ çš„å®é™…åŸŸåã€‚</p></li><li><p><strong>æµ‹è¯•é…ç½®:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nginx -t</span><br></pre></td></tr></table></figure></li><li><p><strong>é‡å¯Nginx:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl restart nginx</span><br></pre></td></tr></table></figure></li></ol><h2 id="âš™ï¸-é…ç½®è¯¦æƒ…"><a href="#âš™ï¸-é…ç½®è¯¦æƒ…" class="headerlink" title="âš™ï¸ é…ç½®è¯¦æƒ…"></a>âš™ï¸ é…ç½®è¯¦æƒ…</h2><h3 id="æ–‡ä»¶ç»“æ„"><a href="#æ–‡ä»¶ç»“æ„" class="headerlink" title="æ–‡ä»¶ç»“æ„"></a>æ–‡ä»¶ç»“æ„</h3><p>é…ç½®åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†:</p><ul><li><strong>å…¨å±€è®¾ç½®</strong>: ç”¨æˆ·ã€è¿›ç¨‹ã€æ—¥å¿—å’ŒPIDæ–‡ä»¶</li><li><strong>äº‹ä»¶å—</strong>: è¿æ¥å¤„ç†</li><li><strong>HTTPå—</strong>: MIMEç±»å‹ã€æ—¥å¿—å’Œæ€§èƒ½ä¼˜åŒ–</li><li><strong>Serverå—</strong>: å•ä¸ªç½‘ç«™é…ç½®</li></ul><h3 id="å…³é”®é…ç½®å…ƒç´ "><a href="#å…³é”®é…ç½®å…ƒç´ " class="headerlink" title="å…³é”®é…ç½®å…ƒç´ "></a>å…³é”®é…ç½®å…ƒç´ </h3><h4 id="SSL-TLSè®¾ç½®"><a href="#SSL-TLSè®¾ç½®" class="headerlink" title="SSL&#x2F;TLSè®¾ç½®"></a>SSL&#x2F;TLSè®¾ç½®</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line"><span class="attribute">ssl_ciphers</span> ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;</span><br><span class="line"><span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">off</span>;</span><br></pre></td></tr></table></figure><h4 id="HSTSè®¾ç½®"><a href="#HSTSè®¾ç½®" class="headerlink" title="HSTSè®¾ç½®"></a>HSTSè®¾ç½®</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">add_header</span> Strict-Transport-Security <span class="string">&quot;max-age=63072000&quot;</span> always;</span><br></pre></td></tr></table></figure><h4 id="åå‘ä»£ç†"><a href="#åå‘ä»£ç†" class="headerlink" title="åå‘ä»£ç†"></a>åå‘ä»£ç†</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /api/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:8080/;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    <span class="comment"># å…¶ä»–å¤´ä¿¡æ¯...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ğŸ”§-è‡ªå®šä¹‰"><a href="#ğŸ”§-è‡ªå®šä¹‰" class="headerlink" title="ğŸ”§ è‡ªå®šä¹‰"></a>ğŸ”§ è‡ªå®šä¹‰</h2><h3 id="æ·»åŠ æ–°ç«™ç‚¹"><a href="#æ·»åŠ æ–°ç«™ç‚¹" class="headerlink" title="æ·»åŠ æ–°ç«™ç‚¹"></a>æ·»åŠ æ–°ç«™ç‚¹</h3><ol><li><p>åœ¨<code>/etc/nginx/conf.d/example.conf</code>åˆ›å»ºæ–°çš„serverå—:</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl http2;</span><br><span class="line">    <span class="attribute">server_name</span> newsite.com;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/nginx/ssl/newsite.com.crt;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/nginx/ssl/newsite.com.key;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">root</span> /var/www/newsite.com;</span><br><span class="line">    <span class="comment"># å…¶ä»–é…ç½®...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºHTTPåˆ°HTTPSé‡å®šå‘:</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> newsite.com;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="è°ƒæ•´æ€§èƒ½è®¾ç½®"><a href="#è°ƒæ•´æ€§èƒ½è®¾ç½®" class="headerlink" title="è°ƒæ•´æ€§èƒ½è®¾ç½®"></a>è°ƒæ•´æ€§èƒ½è®¾ç½®</h3><p>ä½ å¯ä»¥æ ¹æ®æœåŠ¡å™¨èµ„æºè°ƒæ•´ä»¥ä¸‹è®¾ç½®:</p><ul><li><code>worker_processes</code>: è®¾ç½®ä¸ºCPUæ ¸å¿ƒæ•°</li><li><code>worker_connections</code>: é«˜æµé‡ç«™ç‚¹å¯å¢åŠ æ­¤å€¼</li><li><code>keepalive_timeout</code>: æ ¹æ®åº”ç”¨éœ€æ±‚è°ƒæ•´</li><li><code>client_max_body_size</code>: æ ¹æ®ä¸Šä¼ éœ€æ±‚è®¾ç½®</li></ul><h2 id="ğŸ›¡ï¸-å®‰å…¨è€ƒè™‘"><a href="#ğŸ›¡ï¸-å®‰å…¨è€ƒè™‘" class="headerlink" title="ğŸ›¡ï¸ å®‰å…¨è€ƒè™‘"></a>ğŸ›¡ï¸ å®‰å…¨è€ƒè™‘</h2><p>æ­¤é…ç½®åŒ…å«å‡ é¡¹å®‰å…¨å¢å¼º:</p><ul><li>ç°ä»£TLSåè®®å’Œå¯†ç å¥—ä»¶</li><li>HTTPä¸¥æ ¼ä¼ è¾“å®‰å…¨(HSTS)</li><li>é™åˆ¶è®¿é—®éšè—æ–‡ä»¶</li><li>é˜²æ­¢MIMEç±»å‹å—…æ¢çš„å¤´ä¿¡æ¯</li></ul><p>é¢å¤–å»ºè®®:</p><ul><li>ä¸ºç™»å½•é¡µé¢å’ŒAPIç«¯ç‚¹å¯ç”¨é€Ÿç‡é™åˆ¶</li><li>è€ƒè™‘æ·»åŠ ModSecurityä½œä¸ºWebåº”ç”¨é˜²ç«å¢™</li><li>å®ç°Content-Security-Policyå¤´ä¿¡æ¯</li><li>å®šæœŸæ›´æ–°Nginxåˆ°æœ€æ–°ç‰ˆæœ¬</li></ul><h2 id="ğŸ“Š-ç›‘æ§å’Œæ—¥å¿—"><a href="#ğŸ“Š-ç›‘æ§å’Œæ—¥å¿—" class="headerlink" title="ğŸ“Š ç›‘æ§å’Œæ—¥å¿—"></a>ğŸ“Š ç›‘æ§å’Œæ—¥å¿—</h2><h3 id="æ—¥å¿—ä½ç½®"><a href="#æ—¥å¿—ä½ç½®" class="headerlink" title="æ—¥å¿—ä½ç½®"></a>æ—¥å¿—ä½ç½®</h3><ul><li>è®¿é—®æ—¥å¿—: <code>/var/log/nginx/access.log</code></li><li>é”™è¯¯æ—¥å¿—: <code>/var/log/nginx/error.log</code></li></ul><h3 id="å®ç”¨å‘½ä»¤"><a href="#å®ç”¨å‘½ä»¤" class="headerlink" title="å®ç”¨å‘½ä»¤"></a>å®ç”¨å‘½ä»¤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å®æ—¶æ—¥å¿—</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/nginx/error.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥è¯­æ³•é”™è¯¯</span></span><br><span class="line">nginx -t</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡æ–°åŠ è½½é…ç½®</span></span><br><span class="line">nginx -s reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥NginxçŠ¶æ€</span></span><br><span class="line">systemctl status nginx</span><br></pre></td></tr></table></figure><h2 id="ğŸ“-è®¸å¯"><a href="#ğŸ“-è®¸å¯" class="headerlink" title="ğŸ“ è®¸å¯"></a>ğŸ“ è®¸å¯</h2><p>æ­¤é…ç½®åŸºäºMITè®¸å¯æä¾›ã€‚ä½ å¯ä»¥è‡ªç”±ä¿®æ”¹å¹¶ç”¨äºä½ çš„é¡¹ç›®ã€‚</p><h2 id="ğŸ™-è‡´è°¢"><a href="#ğŸ™-è‡´è°¢" class="headerlink" title="ğŸ™ è‡´è°¢"></a>ğŸ™ è‡´è°¢</h2><p>æ­¤é…ç½®æ•´åˆäº†ä»¥ä¸‹æ¥æºçš„æœ€ä½³å®è·µ:</p><ul><li><a href="https://ssl-config.mozilla.org/">Mozilla SSLé…ç½®ç”Ÿæˆå™¨</a></li><li><a href="https://www.acunetix.com/blog/web-security-zone/hardening-nginx/">NginxåŠ å›ºæŒ‡å—</a></li><li>å„ç§DevOpsç¤¾åŒºèµ„æº</li></ul><hr><p>â­ å¦‚æœä½ è§‰å¾—è¿™ä¸ªé…ç½®æœ‰ç”¨ï¼Œè¯·ä¸ºä»“åº“ç‚¹æ˜Ÿ â­ </p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Nginx-Web-æœåŠ¡å™¨é…ç½®&quot;&gt;&lt;a href=&quot;#Nginx-Web-æœåŠ¡å™¨é…ç½®&quot; class=&quot;headerlink&quot; title=&quot;Nginx Web æœåŠ¡å™¨é…ç½®&quot;&gt;&lt;/a&gt;Nginx Web æœåŠ¡å™¨é…ç½®&lt;/h1&gt;&lt;p&gt;ä¸€ä¸ªç”Ÿäº§ç¯å¢ƒreadyçš„Nginxé…</summary>
      
    
    
    
    
    <category term="æ€§èƒ½ä¼˜åŒ–" scheme="https://aoayaoa.github.io/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥ç†è§£Promise</title>
    <link href="https://aoayaoa.github.io/2024/12/13/Promise/"/>
    <id>https://aoayaoa.github.io/2024/12/13/Promise/</id>
    <published>2024-12-12T16:00:00.000Z</published>
    <updated>2025-03-07T03:59:37.941Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ·±å…¥ç†è§£-JavaScript-Promiseï¼šä»å…¥é—¨åˆ°ç²¾é€š"><a href="#æ·±å…¥ç†è§£-JavaScript-Promiseï¼šä»å…¥é—¨åˆ°ç²¾é€š" class="headerlink" title="æ·±å…¥ç†è§£ JavaScript Promiseï¼šä»å…¥é—¨åˆ°ç²¾é€š"></a>æ·±å…¥ç†è§£ JavaScript Promiseï¼šä»å…¥é—¨åˆ°ç²¾é€š</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>Promise æ˜¯ JavaScript ä¸­å¤„ç†å¼‚æ­¥æ“ä½œçš„æ ¸å¿ƒæœºåˆ¶ï¼Œå®ƒçš„å‡ºç°è®©æˆ‘ä»¬å‘Šåˆ«äº†å›è°ƒåœ°ç‹±ï¼Œä½¿å¼‚æ­¥ä»£ç æ›´åŠ æ¸…æ™°å’Œæ˜“äºç»´æŠ¤ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨ Promise çš„æ–¹æ–¹é¢é¢ï¼Œä»åŸºç¡€æ¦‚å¿µåˆ°é«˜çº§åº”ç”¨ï¼Œå¸®åŠ©ä½ å…¨é¢æŒæ¡è¿™ä¸€é‡è¦ç‰¹æ€§ã€‚</p><h2 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h2><ul><li><a href="#1-promise-%E5%9F%BA%E7%A1%80">1. Promise åŸºç¡€</a></li><li><a href="#2-promise-%E7%8A%B6%E6%80%81">2. Promise çŠ¶æ€</a></li><li><a href="#3-promise-%E6%96%B9%E6%B3%95">3. Promise æ–¹æ³•</a></li><li><a href="#4-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">4. é”™è¯¯å¤„ç†</a></li><li><a href="#5-promise-%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8">5. Promise é“¾å¼è°ƒç”¨</a></li><li><a href="#6-promise-%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95">6. Promise é™æ€æ–¹æ³•</a></li><li><a href="#7-asyncawait">7. async&#x2F;await</a></li><li><a href="#8-%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF">8. å®é™…åº”ç”¨åœºæ™¯</a></li><li><a href="#9-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">9. æœ€ä½³å®è·µ</a></li><li><a href="#10-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E5%92%8C%E9%99%B7%E9%98%B1">10. å¸¸è§é—®é¢˜å’Œé™·é˜±</a></li><li><a href="#11-%E6%9B%B4%E5%A4%9A%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF">11. æ›´å¤šå®é™…åº”ç”¨åœºæ™¯</a></li><li><a href="#12-%E8%AF%A6%E7%BB%86%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E6%8C%87%E5%8D%97">12. è¯¦ç»†é”™è¯¯å¤„ç†æŒ‡å—</a></li><li><a href="#13-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">13. æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ</a></li><li><a href="#14-%E8%A1%A5%E5%85%85%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E5%BB%BA%E8%AE%AE">14. è¡¥å……æœ€ä½³å®è·µå»ºè®®</a></li></ul><h2 id="1-Promise-åŸºç¡€"><a href="#1-Promise-åŸºç¡€" class="headerlink" title="1. Promise åŸºç¡€"></a>1. Promise åŸºç¡€</h2><h3 id="1-1-ä»€ä¹ˆæ˜¯-Promiseï¼Ÿ"><a href="#1-1-ä»€ä¹ˆæ˜¯-Promiseï¼Ÿ" class="headerlink" title="1.1 ä»€ä¹ˆæ˜¯ Promiseï¼Ÿ"></a>1.1 ä»€ä¹ˆæ˜¯ Promiseï¼Ÿ</h3><p>Promise æ˜¯å¼‚æ­¥ç¼–ç¨‹çš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œæ¯”ä¼ ç»Ÿçš„å›è°ƒå‡½æ•°æ›´åŠ ä¼˜é›…ã€‚å®ƒæ˜¯ä¸€ä¸ªä»£è¡¨äº†å¼‚æ­¥æ“ä½œæœ€ç»ˆå®Œæˆæˆ–å¤±è´¥çš„å¯¹è±¡ã€‚é€šè¿‡ Promiseï¼Œæˆ‘ä»¬å¯ä»¥ç”¨åŒæ­¥æ“ä½œçš„æµç¨‹å†™æ³•æ¥å¤„ç†å¼‚æ­¥æ“ä½œï¼Œé¿å…äº†å›è°ƒå‡½æ•°å±‚å±‚åµŒå¥—çš„é—®é¢˜ã€‚</p><h3 id="1-2-åŸºæœ¬è¯­æ³•"><a href="#1-2-åŸºæœ¬è¯­æ³•" class="headerlink" title="1.2 åŸºæœ¬è¯­æ³•"></a>1.2 åŸºæœ¬è¯­æ³•</h3><p>Promise çš„åŸºæœ¬è¯­æ³•éå¸¸ç®€å•ï¼Œè®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥äº†è§£ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// å¼‚æ­¥æ“ä½œ</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="comment">/* æ“ä½œæˆåŠŸ */</span>) &#123;</span><br><span class="line">        <span class="title function_">resolve</span>(value);  <span class="comment">// æˆåŠŸæ—¶è°ƒç”¨</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">reject</span>(error);   <span class="comment">// å¤±è´¥æ—¶è°ƒç”¨</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ„é€ å‡½æ•°æ¥æ”¶ä¸€ä¸ªæ‰§è¡Œå™¨ï¼ˆexecutorï¼‰å‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¯¥å‡½æ•°ä¼šç«‹å³æ‰§è¡Œã€‚æ‰§è¡Œå™¨å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼šresolve å’Œ rejectï¼Œå®ƒä»¬æ˜¯ç”± JavaScript å¼•æ“æä¾›çš„å‡½æ•°ã€‚</p><h3 id="1-3-åŸºæœ¬ç”¨æ³•"><a href="#1-3-åŸºæœ¬ç”¨æ³•" class="headerlink" title="1.3 åŸºæœ¬ç”¨æ³•"></a>1.3 åŸºæœ¬ç”¨æ³•</h3><p>Promise å¯¹è±¡åˆ›å»ºåï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒçš„æ–¹æ³•æ¥å¤„ç†å¼‚æ­¥æ“ä½œçš„ç»“æœï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">promise</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// å¤„ç†æˆåŠŸæƒ…å†µ</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æˆåŠŸï¼š&#x27;</span>, result);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// å¤„ç†é”™è¯¯æƒ…å†µ</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;é”™è¯¯ï¼š&#x27;</span>, error);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">finally</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// æ€»æ˜¯æ‰§è¡Œ</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ“ä½œå®Œæˆ&#x27;</span>);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><p>è¿™ç§é“¾å¼è°ƒç”¨çš„æ–¹å¼ä½¿å¾—å¼‚æ­¥æ“ä½œçš„æµç¨‹æ›´åŠ æ¸…æ™°ï¼Œä»£ç æ›´æ˜“äºç†è§£å’Œç»´æŠ¤ã€‚</p><h2 id="2-Promise-çŠ¶æ€"><a href="#2-Promise-çŠ¶æ€" class="headerlink" title="2. Promise çŠ¶æ€"></a>2. Promise çŠ¶æ€</h2><p>Promise çš„çŠ¶æ€æ˜¯å®ƒçš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ï¼Œç†è§£ Promise çš„çŠ¶æ€å¯¹äºæ­£ç¡®ä½¿ç”¨å®ƒè‡³å…³é‡è¦ã€‚</p><h3 id="2-1-ä¸‰ç§çŠ¶æ€"><a href="#2-1-ä¸‰ç§çŠ¶æ€" class="headerlink" title="2.1 ä¸‰ç§çŠ¶æ€"></a>2.1 ä¸‰ç§çŠ¶æ€</h3><p>Promise æœ‰ä¸”ä»…æœ‰ä¸‰ç§çŠ¶æ€ï¼š</p><ul><li><strong>pendingï¼ˆè¿›è¡Œä¸­ï¼‰</strong>ï¼šåˆå§‹çŠ¶æ€ï¼Œæ—¢ä¸æ˜¯æˆåŠŸï¼Œä¹Ÿä¸æ˜¯å¤±è´¥</li><li><strong>fulfilledï¼ˆå·²æˆåŠŸï¼‰</strong>ï¼šæ“ä½œæˆåŠŸå®Œæˆ</li><li><strong>rejectedï¼ˆå·²å¤±è´¥ï¼‰</strong>ï¼šæ“ä½œå¤±è´¥</li></ul><h3 id="2-2-çŠ¶æ€è½¬æ¢"><a href="#2-2-çŠ¶æ€è½¬æ¢" class="headerlink" title="2.2 çŠ¶æ€è½¬æ¢"></a>2.2 çŠ¶æ€è½¬æ¢</h3><p>Promise çš„çŠ¶æ€è½¬æ¢æ˜¯å•å‘çš„ï¼Œä¸€æ—¦çŠ¶æ€æ”¹å˜ï¼Œå°±ä¸ä¼šå†å˜ã€‚è¿™ç§ç‰¹æ€§ç§°ä¸ºâ€çŠ¶æ€çš„ä¸å¯é€†æ€§â€ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// çŠ¶æ€è½¬æ¢ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> successPromise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">resolve</span>(<span class="string">&#x27;æˆåŠŸ&#x27;</span>);  <span class="comment">// pending -&gt; fulfilled</span></span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> failedPromise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">reject</span>(<span class="string">&#x27;å¤±è´¥&#x27;</span>);   <span class="comment">// pending -&gt; rejected</span></span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="2-3-çŠ¶æ€çš„ä¸å¯é€†æ€§"><a href="#2-3-çŠ¶æ€çš„ä¸å¯é€†æ€§" class="headerlink" title="2.3 çŠ¶æ€çš„ä¸å¯é€†æ€§"></a>2.3 çŠ¶æ€çš„ä¸å¯é€†æ€§</h3><p>ä¸€æ—¦ Promise çš„çŠ¶æ€æ”¹å˜ï¼Œåç»­çš„çŠ¶æ€ä¿®æ”¹æ“ä½œå°†è¢«å¿½ç•¥ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">resolve</span>(<span class="string">&#x27;æˆåŠŸ&#x27;</span>);    <span class="comment">// çŠ¶æ€å˜ä¸º fulfilled</span></span><br><span class="line">    <span class="title function_">reject</span>(<span class="string">&#x27;å¤±è´¥&#x27;</span>);     <span class="comment">// è¿™è¡Œä»£ç ä¼šè¢«å¿½ç•¥</span></span><br><span class="line">    <span class="title function_">resolve</span>(<span class="string">&#x27;å†æ¬¡æˆåŠŸ&#x27;</span>); <span class="comment">// è¿™è¡Œä»£ç ä¹Ÿä¼šè¢«å¿½ç•¥</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="3-Promise-æ–¹æ³•"><a href="#3-Promise-æ–¹æ³•" class="headerlink" title="3. Promise æ–¹æ³•"></a>3. Promise æ–¹æ³•</h2><p>Promise æä¾›äº†å‡ ä¸ªå…³é”®çš„å®ä¾‹æ–¹æ³•ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿä¼˜é›…åœ°å¤„ç†å¼‚æ­¥æ“ä½œçš„ç»“æœã€‚</p><h3 id="3-1-then-æ–¹æ³•"><a href="#3-1-then-æ–¹æ³•" class="headerlink" title="3.1 then() æ–¹æ³•"></a>3.1 then() æ–¹æ³•</h3><p><code>then()</code> æ˜¯æœ€å¸¸ç”¨çš„ Promise æ–¹æ³•ï¼Œå®ƒå¯ä»¥æ¥æ”¶ä¸¤ä¸ªå›è°ƒå‡½æ•°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">promise.<span class="title function_">then</span>(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// å¤„ç†æˆåŠŸçš„æƒ…å†µ</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æˆåŠŸï¼š&#x27;</span>, result);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// å¤„ç†å¤±è´¥çš„æƒ…å†µï¼ˆå¯é€‰ï¼‰</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å¤±è´¥ï¼š&#x27;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h3 id="3-2-catch-æ–¹æ³•"><a href="#3-2-catch-æ–¹æ³•" class="headerlink" title="3.2 catch() æ–¹æ³•"></a>3.2 catch() æ–¹æ³•</h3><p><code>catch()</code> æ–¹æ³•ç”¨äºå¤„ç† Promise ä¸­çš„é”™è¯¯ï¼Œå®ƒæ˜¯ <code>.then(null, rejection)</code> çš„è¯­æ³•ç³–ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">promise.<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// å¤„ç†é”™è¯¯</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;å‘ç”Ÿé”™è¯¯ï¼š&#x27;</span>, error);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="3-3-finally-æ–¹æ³•"><a href="#3-3-finally-æ–¹æ³•" class="headerlink" title="3.3 finally() æ–¹æ³•"></a>3.3 finally() æ–¹æ³•</h3><p><code>finally()</code> æ–¹æ³•ç”¨äºæŒ‡å®šæ— è®º Promise å¯¹è±¡æœ€åçŠ¶æ€å¦‚ä½•ï¼Œéƒ½ä¼šæ‰§è¡Œçš„æ“ä½œï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">promise.<span class="title function_">finally</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// æ¸…ç†å·¥ä½œ</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Promise å·²å®Œæˆ&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="4-é”™è¯¯å¤„ç†"><a href="#4-é”™è¯¯å¤„ç†" class="headerlink" title="4. é”™è¯¯å¤„ç†"></a>4. é”™è¯¯å¤„ç†</h2><h3 id="4-1-é”™è¯¯æ•è·æ–¹å¼"><a href="#4-1-é”™è¯¯æ•è·æ–¹å¼" class="headerlink" title="4.1 é”™è¯¯æ•è·æ–¹å¼"></a>4.1 é”™è¯¯æ•è·æ–¹å¼</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–¹å¼ 1ï¼šä½¿ç”¨ catch</span></span><br><span class="line">promise</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;&#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–¹å¼ 2ï¼šä½¿ç”¨ then çš„ç¬¬äºŒä¸ªå‚æ•°</span></span><br><span class="line">promise.<span class="title function_">then</span>(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> &#123;&#125;,</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> &#123;&#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h3 id="4-2-é”™è¯¯å¤„ç†é€»è¾‘"><a href="#4-2-é”™è¯¯å¤„ç†é€»è¾‘" class="headerlink" title="4.2 é”™è¯¯å¤„ç†é€»è¾‘"></a>4.2 é”™è¯¯å¤„ç†é€»è¾‘</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">promise</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 1. è¿”å›æ™®é€šå€¼ - æ¢å¤åˆ° fulfilled çŠ¶æ€</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;recovered&#x27;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. æŠ›å‡ºé”™è¯¯ - ç»§ç»­ rejected çŠ¶æ€</span></span><br><span class="line">        <span class="keyword">throw</span> error;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. è¿”å› rejected promise - ç»§ç»­ rejected çŠ¶æ€</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><h2 id="5-Promise-é“¾å¼è°ƒç”¨"><a href="#5-Promise-é“¾å¼è°ƒç”¨" class="headerlink" title="5. Promise é“¾å¼è°ƒç”¨"></a>5. Promise é“¾å¼è°ƒç”¨</h2><h3 id="5-1-åŸºæœ¬é“¾å¼è°ƒç”¨"><a href="#5-1-åŸºæœ¬é“¾å¼è°ƒç”¨" class="headerlink" title="5.1 åŸºæœ¬é“¾å¼è°ƒç”¨"></a>5.1 åŸºæœ¬é“¾å¼è°ƒç”¨</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">promise</span><br><span class="line">    .<span class="title function_">then</span>(step1)</span><br><span class="line">    .<span class="title function_">then</span>(step2)</span><br><span class="line">    .<span class="title function_">then</span>(step3)</span><br><span class="line">    .<span class="title function_">catch</span>(handleError);</span><br></pre></td></tr></table></figure><h3 id="5-2-å€¼çš„ä¼ é€’"><a href="#5-2-å€¼çš„ä¼ é€’" class="headerlink" title="5.2 å€¼çš„ä¼ é€’"></a>5.2 å€¼çš„ä¼ é€’</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="number">1</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">x</span> =&gt;</span> x + <span class="number">1</span>)     <span class="comment">// 2</span></span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">x</span> =&gt;</span> x * <span class="number">2</span>)     <span class="comment">// 4</span></span><br><span class="line">    .<span class="title function_">then</span>(<span class="variable language_">console</span>.<span class="property">log</span>);   <span class="comment">// è¾“å‡º: 4</span></span><br></pre></td></tr></table></figure><h3 id="5-3-Promise-é“¾ä¸­çš„é”™è¯¯å¤„ç†"><a href="#5-3-Promise-é“¾ä¸­çš„é”™è¯¯å¤„ç†" class="headerlink" title="5.3 Promise é“¾ä¸­çš„é”™è¯¯å¤„ç†"></a>5.3 Promise é“¾ä¸­çš„é”™è¯¯å¤„ç†</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetchUser</span>()</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!user.<span class="property">id</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Invalid user&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">fetchProfile</span>(user.<span class="property">id</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">profile</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">updateProfile</span>(profile);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// å¤„ç†ä»»ä½•æ­¥éª¤ä¸­çš„é”™è¯¯</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><h2 id="6-Promise-é™æ€æ–¹æ³•"><a href="#6-Promise-é™æ€æ–¹æ³•" class="headerlink" title="6. Promise é™æ€æ–¹æ³•"></a>6. Promise é™æ€æ–¹æ³•</h2><h3 id="6-1-Promise-resolve"><a href="#6-1-Promise-resolve" class="headerlink" title="6.1 Promise.resolve()"></a>6.1 Promise.resolve()</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªç«‹å³ resolve çš„ Promise</span></span><br><span class="line"><span class="keyword">const</span> resolved = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(value);</span><br></pre></td></tr></table></figure><h3 id="6-2-Promise-reject"><a href="#6-2-Promise-reject" class="headerlink" title="6.2 Promise.reject()"></a>6.2 Promise.reject()</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªç«‹å³ reject çš„ Promise</span></span><br><span class="line"><span class="keyword">const</span> rejected = <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br></pre></td></tr></table></figure><h3 id="6-3-Promise-all"><a href="#6-3-Promise-all" class="headerlink" title="6.3 Promise.all()"></a>6.3 Promise.all()</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç­‰å¾…æ‰€æœ‰ Promise å®Œæˆ</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">all</span>([promise1, promise2, promise3])</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">results</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// results æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«æ‰€æœ‰ Promise çš„ç»“æœ</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><h3 id="6-4-Promise-race"><a href="#6-4-Promise-race" class="headerlink" title="6.4 Promise.race()"></a>6.4 Promise.race()</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿”å›æœ€å…ˆå®Œæˆçš„ Promise ç»“æœ</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">race</span>([promise1, promise2])</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">firstResult</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// firstResult æ˜¯æœ€å…ˆå®Œæˆçš„ Promise çš„ç»“æœ</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><h3 id="6-5-Promise-allSettled"><a href="#6-5-Promise-allSettled" class="headerlink" title="6.5 Promise.allSettled()"></a>6.5 Promise.allSettled()</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç­‰å¾…æ‰€æœ‰ Promise å®Œæˆï¼ˆæ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼‰</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">allSettled</span>([promise1, promise2])</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">results</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// results åŒ…å«æ‰€æœ‰ Promise çš„çŠ¶æ€å’Œç»“æœ</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><h2 id="7-async-await"><a href="#7-async-await" class="headerlink" title="7. async&#x2F;await"></a>7. async&#x2F;await</h2><h3 id="7-1-åŸºæœ¬ç”¨æ³•"><a href="#7-1-åŸºæœ¬ç”¨æ³•" class="headerlink" title="7.1 åŸºæœ¬ç”¨æ³•"></a>7.1 åŸºæœ¬ç”¨æ³•</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(url);</span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error:&#x27;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-2-ä¸-Promise-çš„å…³ç³»"><a href="#7-2-ä¸-Promise-çš„å…³ç³»" class="headerlink" title="7.2 ä¸ Promise çš„å…³ç³»"></a>7.2 ä¸ Promise çš„å…³ç³»</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Promise æ–¹å¼</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fetchData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(url)</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>())</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(error));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// async/await æ–¹å¼</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(url);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="8-å®é™…åº”ç”¨åœºæ™¯"><a href="#8-å®é™…åº”ç”¨åœºæ™¯" class="headerlink" title="8. å®é™…åº”ç”¨åœºæ™¯"></a>8. å®é™…åº”ç”¨åœºæ™¯</h2><h3 id="8-1-API-è¯·æ±‚"><a href="#8-1-API-è¯·æ±‚" class="headerlink" title="8.1 API è¯·æ±‚"></a>8.1 API è¯·æ±‚</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">fetchUserData</span>(<span class="params">userId</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">`/api/users/<span class="subst">$&#123;userId&#125;</span>`</span>)</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!response.<span class="property">ok</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Network response was not ok&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> response.<span class="title function_">json</span>();</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error fetching user:&#x27;</span>, error);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-2-å¹¶è¡Œè¯·æ±‚"><a href="#8-2-å¹¶è¡Œè¯·æ±‚" class="headerlink" title="8.2 å¹¶è¡Œè¯·æ±‚"></a>8.2 å¹¶è¡Œè¯·æ±‚</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchAllData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> [users, posts, comments] = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">            <span class="title function_">fetchUsers</span>(),</span><br><span class="line">            <span class="title function_">fetchPosts</span>(),</span><br><span class="line">            <span class="title function_">fetchComments</span>()</span><br><span class="line">        ]);</span><br><span class="line">        <span class="keyword">return</span> &#123; users, posts, comments &#125;;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error fetching data:&#x27;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-3-ä¸²è¡Œè¯·æ±‚"><a href="#8-3-ä¸²è¡Œè¯·æ±‚" class="headerlink" title="8.3 ä¸²è¡Œè¯·æ±‚"></a>8.3 ä¸²è¡Œè¯·æ±‚</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchUserAndPosts</span>(<span class="params">userId</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="title function_">fetchUser</span>(userId);</span><br><span class="line">        <span class="keyword">const</span> posts = <span class="keyword">await</span> <span class="title function_">fetchUserPosts</span>(user.<span class="property">id</span>);</span><br><span class="line">        <span class="keyword">return</span> &#123; user, posts &#125;;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error:&#x27;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="9-æœ€ä½³å®è·µ"><a href="#9-æœ€ä½³å®è·µ" class="headerlink" title="9. æœ€ä½³å®è·µ"></a>9. æœ€ä½³å®è·µ</h2><h3 id="9-1-é”™è¯¯å¤„ç†"><a href="#9-1-é”™è¯¯å¤„ç†" class="headerlink" title="9.1 é”™è¯¯å¤„ç†"></a>9.1 é”™è¯¯å¤„ç†</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">handleAsyncOperation</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">asyncOperation</span>();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="comment">// è®°å½•é”™è¯¯</span></span><br><span class="line">        <span class="title function_">logError</span>(error);</span><br><span class="line">        <span class="comment">// è¿”å›é»˜è®¤å€¼æˆ–é‡æ–°æŠ›å‡º</span></span><br><span class="line">        <span class="keyword">throw</span> error;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// æ¸…ç†å·¥ä½œ</span></span><br><span class="line">        <span class="title function_">cleanup</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="9-2-Promise-è¶…æ—¶å¤„ç†"><a href="#9-2-Promise-è¶…æ—¶å¤„ç†" class="headerlink" title="9.2 Promise è¶…æ—¶å¤„ç†"></a>9.2 Promise è¶…æ—¶å¤„ç†</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">timeoutPromise</span>(<span class="params">promise, timeout</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">race</span>([</span><br><span class="line">        promise,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">_, reject</span>) =&gt;</span></span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Timeout&#x27;</span>)), timeout)</span><br><span class="line">        )</span><br><span class="line">    ]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="9-3-å–æ¶ˆæ“ä½œ"><a href="#9-3-å–æ¶ˆæ“ä½œ" class="headerlink" title="9.3 å–æ¶ˆæ“ä½œ"></a>9.3 å–æ¶ˆæ“ä½œ</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createCancellablePromise</span>(<span class="params">promise</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> isCancelled = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> wrappedPromise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        promise.<span class="title function_">then</span>(</span><br><span class="line">            <span class="function"><span class="params">value</span> =&gt;</span> isCancelled ? <span class="title function_">reject</span>(<span class="string">&#x27;Cancelled&#x27;</span>) : <span class="title function_">resolve</span>(value),</span><br><span class="line">            <span class="function"><span class="params">error</span> =&gt;</span> isCancelled ? <span class="title function_">reject</span>(<span class="string">&#x27;Cancelled&#x27;</span>) : <span class="title function_">reject</span>(error)</span><br><span class="line">        );</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">promise</span>: wrappedPromise,</span><br><span class="line">        <span class="attr">cancel</span>: <span class="function">() =&gt;</span> &#123; isCancelled = <span class="literal">true</span>; &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="10-å¸¸è§é—®é¢˜å’Œé™·é˜±"><a href="#10-å¸¸è§é—®é¢˜å’Œé™·é˜±" class="headerlink" title="10. å¸¸è§é—®é¢˜å’Œé™·é˜±"></a>10. å¸¸è§é—®é¢˜å’Œé™·é˜±</h2><h3 id="10-1-Promise-æ‰§è¡Œé¡ºåº"><a href="#10-1-Promise-æ‰§è¡Œé¡ºåº" class="headerlink" title="10.1 Promise æ‰§è¡Œé¡ºåº"></a>10.1 Promise æ‰§è¡Œé¡ºåº</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ é”™è¯¯ç†è§£ï¼šè®¤ä¸º Promise ä¸­çš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2&#x27;</span>));</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;3&#x27;</span>), <span class="number">0</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;4&#x27;</span>);</span><br><span class="line"><span class="comment">// è¾“å‡º: 1, 4, 2, 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// âš ï¸ ç‰¹åˆ«æ³¨æ„ï¼šPromise ä¸­çš„åŒæ­¥å’Œå¼‚æ­¥æ“ä½œ</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å¼€å§‹&#x27;</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;åŒæ­¥ä»£ç 1&#x27;</span>); <span class="comment">// Promise æ„é€ å‡½æ•°ä¸­çš„ä»£ç æ˜¯åŒæ­¥æ‰§è¡Œçš„</span></span><br><span class="line">    <span class="title function_">resolve</span>(<span class="string">&#x27;åŒæ­¥ä»£ç 2&#x27;</span>);     <span class="comment">// resolve/reject æ˜¯åŒæ­¥æ‰§è¡Œçš„</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;åŒæ­¥ä»£ç 3&#x27;</span>); <span class="comment">// è¿™è¡Œä¹Ÿä¼šåŒæ­¥æ‰§è¡Œ</span></span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å¼‚æ­¥å¾®ä»»åŠ¡1&#x27;</span>); <span class="comment">// then å›è°ƒæ˜¯å¼‚æ­¥å¾®ä»»åŠ¡</span></span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å¼‚æ­¥å¾®ä»»åŠ¡2&#x27;</span>); <span class="comment">// é“¾å¼è°ƒç”¨çš„ then ä¹Ÿæ˜¯å¼‚æ­¥å¾®ä»»åŠ¡</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç»“æŸ&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾“å‡ºé¡ºåºï¼š</span></span><br><span class="line"><span class="comment">// å¼€å§‹</span></span><br><span class="line"><span class="comment">// åŒæ­¥ä»£ç 1</span></span><br><span class="line"><span class="comment">// åŒæ­¥ä»£ç 2</span></span><br><span class="line"><span class="comment">// åŒæ­¥ä»£ç 3</span></span><br><span class="line"><span class="comment">// ç»“æŸ</span></span><br><span class="line"><span class="comment">// å¼‚æ­¥å¾®ä»»åŠ¡1</span></span><br><span class="line"><span class="comment">// å¼‚æ­¥å¾®ä»»åŠ¡2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ›´å¤æ‚çš„æ‰§è¡Œé¡ºåºç¤ºä¾‹</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;script start&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;setTimeout&#x27;</span>); <span class="comment">// å®ä»»åŠ¡</span></span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;Promise 1&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(msg); <span class="comment">// å¾®ä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Promise 2&#x27;</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(msg); <span class="comment">// å¾®ä»»åŠ¡</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;Promise 3&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(msg); <span class="comment">// å¾®ä»»åŠ¡</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;script end&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾“å‡ºé¡ºåºï¼š</span></span><br><span class="line"><span class="comment">// script start</span></span><br><span class="line"><span class="comment">// script end</span></span><br><span class="line"><span class="comment">// Promise 1</span></span><br><span class="line"><span class="comment">// Promise 3</span></span><br><span class="line"><span class="comment">// Promise 2</span></span><br><span class="line"><span class="comment">// setTimeout</span></span><br></pre></td></tr></table></figure><h3 id="10-1-1-Promise-ä¸­çš„åŒæ­¥å’Œå¼‚æ­¥æ“ä½œ"><a href="#10-1-1-Promise-ä¸­çš„åŒæ­¥å’Œå¼‚æ­¥æ“ä½œ" class="headerlink" title="10.1.1 Promise ä¸­çš„åŒæ­¥å’Œå¼‚æ­¥æ“ä½œ"></a>10.1.1 Promise ä¸­çš„åŒæ­¥å’Œå¼‚æ­¥æ“ä½œ</h3><ol><li><p><strong>åŒæ­¥æ‰§è¡Œçš„éƒ¨åˆ†</strong>ï¼š</p><ul><li>Promise æ„é€ å‡½æ•°ä¸­çš„ä»£ç </li><li>resolve() æˆ– reject() çš„è°ƒç”¨</li><li>ç›´æ¥åœ¨ Promise ä¸­çš„ä»£ç </li></ul></li><li><p><strong>å¼‚æ­¥å¾®ä»»åŠ¡</strong>ï¼š</p><ul><li>.then() çš„å›è°ƒ</li><li>.catch() çš„å›è°ƒ</li><li>.finally() çš„å›è°ƒ</li></ul></li><li><p><strong>æ‰§è¡Œé¡ºåºè§„åˆ™</strong>ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¤ºä¾‹ï¼šæ··åˆåŒæ­¥å’Œå¼‚æ­¥æ“ä½œ</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1 - åŒæ­¥&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2 - åŒæ­¥&#x27;</span>);</span><br><span class="line">    <span class="title function_">resolve</span>(<span class="string">&#x27;3 - åŒæ­¥&#x27;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;4 - åŒæ­¥&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;5 - å¼‚æ­¥å¾®ä»»åŠ¡&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;6 - åŒæ­¥&#x27;</span>);</span><br><span class="line">        <span class="title function_">resolve</span>(<span class="string">&#x27;7 - åŒæ­¥&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;8 - å¼‚æ­¥å¾®ä»»åŠ¡&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;9 - å¼‚æ­¥å®ä»»åŠ¡&#x27;</span>);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;10 - åŒæ­¥&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾“å‡ºé¡ºåºï¼š</span></span><br><span class="line"><span class="comment">// 1 - åŒæ­¥</span></span><br><span class="line"><span class="comment">// 2 - åŒæ­¥</span></span><br><span class="line"><span class="comment">// 4 - åŒæ­¥</span></span><br><span class="line"><span class="comment">// 10 - åŒæ­¥</span></span><br><span class="line"><span class="comment">// 5 - å¼‚æ­¥å¾®ä»»åŠ¡</span></span><br><span class="line"><span class="comment">// 6 - åŒæ­¥</span></span><br><span class="line"><span class="comment">// 8 - å¼‚æ­¥å¾®ä»»åŠ¡</span></span><br><span class="line"><span class="comment">// 9 - å¼‚æ­¥å®ä»»åŠ¡</span></span><br></pre></td></tr></table></figure></li><li><p><strong>æ³¨æ„äº‹é¡¹</strong>ï¼š</p><ul><li>Promise æ„é€ å‡½æ•°æ˜¯åŒæ­¥æ‰§è¡Œçš„</li><li>resolve&#x2F;reject çš„è°ƒç”¨æ˜¯åŒæ­¥çš„ï¼Œä½†å…¶è§¦å‘çš„ then&#x2F;catch æ˜¯å¼‚æ­¥çš„</li><li>å¾®ä»»åŠ¡ä¼˜å…ˆäºå®ä»»åŠ¡æ‰§è¡Œ</li><li>åŒä¸€è½®äº‹ä»¶å¾ªç¯ä¸­çš„å¾®ä»»åŠ¡ä¼šåœ¨ä¸‹ä¸€ä¸ªå®ä»»åŠ¡ä¹‹å‰æ‰§è¡Œå®Œ</li></ul></li><li><p><strong>å®é™…åº”ç”¨ç¤ºä¾‹</strong>ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">example</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1 - åŒæ­¥&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2 - åŒæ­¥&#x27;</span>);</span><br><span class="line">        <span class="title function_">resolve</span>(<span class="string">&#x27;3 - åŒæ­¥&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;4 - åŒæ­¥&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">await</span> p; <span class="comment">// await åé¢çš„ä»£ç ä¼šè¢«è½¬æ¢æˆ then çš„å›è°ƒï¼ˆå¾®ä»»åŠ¡ï¼‰</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;5 - å¼‚æ­¥&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">example</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;6 - åŒæ­¥&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾“å‡ºé¡ºåºï¼š</span></span><br><span class="line"><span class="comment">// 1 - åŒæ­¥</span></span><br><span class="line"><span class="comment">// 2 - åŒæ­¥</span></span><br><span class="line"><span class="comment">// 4 - åŒæ­¥</span></span><br><span class="line"><span class="comment">// 6 - åŒæ­¥</span></span><br><span class="line"><span class="comment">// 5 - å¼‚æ­¥</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="10-2-Promise-é”™è¯¯å¤„ç†"><a href="#10-2-Promise-é”™è¯¯å¤„ç†" class="headerlink" title="10.2 Promise é”™è¯¯å¤„ç†"></a>10.2 Promise é”™è¯¯å¤„ç†</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é”™è¯¯ç¤ºä¾‹</span></span><br><span class="line">promise.<span class="title function_">then</span>(success).<span class="title function_">catch</span>(error).<span class="title function_">then</span>(next);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£ç¡®ç¤ºä¾‹</span></span><br><span class="line">promise</span><br><span class="line">    .<span class="title function_">then</span>(success)</span><br><span class="line">    .<span class="title function_">then</span>(next)</span><br><span class="line">    .<span class="title function_">catch</span>(error);</span><br></pre></td></tr></table></figure><h3 id="10-3-å†…å­˜æ³„æ¼"><a href="#10-3-å†…å­˜æ³„æ¼" class="headerlink" title="10.3 å†…å­˜æ³„æ¼"></a>10.3 å†…å­˜æ³„æ¼</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é¿å…è¿™æ ·</span></span><br><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// æ°¸è¿œä¸ä¼š resolve æˆ– reject</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å»ºè®®è¿™æ ·</span></span><br><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// æ·»åŠ è¶…æ—¶å¤„ç†</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Timeout&#x27;</span>)), <span class="number">5000</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="10-4-Promise-åµŒå¥—"><a href="#10-4-Promise-åµŒå¥—" class="headerlink" title="10.4 Promise åµŒå¥—"></a>10.4 Promise åµŒå¥—</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é¿å…åµŒå¥—</span></span><br><span class="line"><span class="title function_">fetchUser</span>().<span class="title function_">then</span>(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">fetchPosts</span>(user.<span class="property">id</span>).<span class="title function_">then</span>(<span class="function"><span class="params">posts</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">fetchComments</span>(posts[<span class="number">0</span>].<span class="property">id</span>).<span class="title function_">then</span>(<span class="function"><span class="params">comments</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// å¤„ç†æ•°æ®</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨é“¾å¼è°ƒç”¨</span></span><br><span class="line"><span class="title function_">fetchUser</span>()</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">user</span> =&gt;</span> <span class="title function_">fetchPosts</span>(user.<span class="property">id</span>))</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">posts</span> =&gt;</span> <span class="title function_">fetchComments</span>(posts[<span class="number">0</span>].<span class="property">id</span>))</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">comments</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// å¤„ç†æ•°æ®</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><h3 id="10-5-å¸¸è§æ˜“é”™ç‚¹å’Œç‰¹åˆ«æç¤º"><a href="#10-5-å¸¸è§æ˜“é”™ç‚¹å’Œç‰¹åˆ«æç¤º" class="headerlink" title="10.5 å¸¸è§æ˜“é”™ç‚¹å’Œç‰¹åˆ«æç¤º"></a>10.5 å¸¸è§æ˜“é”™ç‚¹å’Œç‰¹åˆ«æç¤º</h3><h4 id="1-Promise-æ„é€ å‡½æ•°ä¸­çš„ä»£ç ç«‹å³æ‰§è¡Œ"><a href="#1-Promise-æ„é€ å‡½æ•°ä¸­çš„ä»£ç ç«‹å³æ‰§è¡Œ" class="headerlink" title="1. Promise æ„é€ å‡½æ•°ä¸­çš„ä»£ç ç«‹å³æ‰§è¡Œ"></a>1. Promise æ„é€ å‡½æ•°ä¸­çš„ä»£ç ç«‹å³æ‰§è¡Œ</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ é”™è¯¯ç†è§£ï¼šè®¤ä¸º Promise ä¸­çš„ä»£ç æ˜¯å¼‚æ­¥æ‰§è¡Œ</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å¼€å§‹&#x27;</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Promise å†…éƒ¨&#x27;</span>);</span><br><span class="line">    <span class="title function_">resolve</span>(<span class="string">&#x27;å®Œæˆ&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç»“æŸ&#x27;</span>);</span><br><span class="line"><span class="comment">// å®é™…è¾“å‡ºï¼š</span></span><br><span class="line"><span class="comment">// å¼€å§‹</span></span><br><span class="line"><span class="comment">// Promise å†…éƒ¨</span></span><br><span class="line"><span class="comment">// ç»“æŸ</span></span><br></pre></td></tr></table></figure><h4 id="2-resolve-reject-åçš„ä»£ç ä»ä¼šæ‰§è¡Œ"><a href="#2-resolve-reject-åçš„ä»£ç ä»ä¼šæ‰§è¡Œ" class="headerlink" title="2. resolve&#x2F;reject åçš„ä»£ç ä»ä¼šæ‰§è¡Œ"></a>2. resolve&#x2F;reject åçš„ä»£ç ä»ä¼šæ‰§è¡Œ</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ é”™è¯¯ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">resolve</span>(<span class="string">&#x27;å®Œæˆ&#x27;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;è¿™é‡Œä»ä¼šæ‰§è¡Œ&#x27;</span>); <span class="comment">// è¿™è¡Œä»£ç ä¼šæ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">return</span>; <span class="comment">// æ˜¾å¼è¿”å›ä¹Ÿæ— æ³•é˜»æ­¢åç»­ä»£ç æ‰§è¡Œ</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… æ­£ç¡®åšæ³•</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (condition) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">resolve</span>(<span class="string">&#x27;å®Œæˆ&#x27;</span>); <span class="comment">// ä½¿ç”¨ return æ¥ç¡®ä¿åç»­ä»£ç ä¸æ‰§è¡Œ</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å…¶ä»–ä»£ç </span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="3-then-catch-è¿”å›å€¼çš„é—®é¢˜"><a href="#3-then-catch-è¿”å›å€¼çš„é—®é¢˜" class="headerlink" title="3. then&#x2F;catch è¿”å›å€¼çš„é—®é¢˜"></a>3. then&#x2F;catch è¿”å›å€¼çš„é—®é¢˜</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3.1 é”™è¯¯æ¢å¤æ¨¡å¼</span></span><br><span class="line"><span class="comment">// âŒ é”™è¯¯ç†è§£ï¼šè®¤ä¸ºé”™è¯¯ä¸€æ—¦å‘ç”Ÿï¼Œåç»­çš„ then éƒ½ä¸ä¼šæ‰§è¡Œ</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">reject</span>(<span class="string">&quot;initial error&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ä¸ä¼šæ‰§è¡Œ&quot;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;æ•è·é”™è¯¯:&quot;</span>, error);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;recovered&quot;</span>;  <span class="comment">// è¿”å›æ™®é€šå€¼ï¼ŒPromise å˜ä¸º fulfilled çŠ¶æ€</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ä¼šæ‰§è¡Œï¼Œå€¼ä¸º:&quot;</span>, result); <span class="comment">// ä¼šæ‰§è¡Œï¼Œå› ä¸ºä¸Šä¸€ä¸ª then è¿”å›äº†æ­£å¸¸å€¼</span></span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ä¸ä¼šæ‰§è¡Œï¼Œå› ä¸ºé”™è¯¯å·²ç»è¢«å¤„ç†&quot;</span>); <span class="comment">// ä¸ä¼šæ‰§è¡Œ</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.2 é”™è¯¯ä¼ æ’­æ¨¡å¼</span></span><br><span class="line"><span class="comment">// âŒ é”™è¯¯ç†è§£ï¼šè®¤ä¸ºä½¿ç”¨äº† catch å°±ä¸€å®šèƒ½æ•è·æ‰€æœ‰é”™è¯¯</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">reject</span>(<span class="string">&quot;error1&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ä¸ä¼šæ‰§è¡Œ&quot;</span>),</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;æ•è· error1&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="string">&quot;error2&quot;</span>;  <span class="comment">// æŠ›å‡ºæ–°é”™è¯¯ï¼ŒPromise å˜ä¸º rejected çŠ¶æ€</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">.<span class="title function_">then</span>(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ä¸ä¼šæ‰§è¡Œ&quot;</span>),</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;æ•è· error2&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="string">&quot;error3&quot;</span>);  <span class="comment">// è¿”å› rejected promise</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">.<span class="title function_">then</span>(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ä¸ä¼šæ‰§è¡Œ&quot;</span>),</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;æ•è· error3&quot;</span>);</span><br><span class="line">        <span class="comment">// æ²¡æœ‰è¿”å›å€¼ï¼Œé»˜è®¤è¿”å› undefinedï¼ŒPromise å˜ä¸º fulfilled çŠ¶æ€</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">.<span class="title function_">then</span>(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ä¼šæ‰§è¡Œ&quot;</span>),</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ä¸ä¼šæ‰§è¡Œ&quot;</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.3 Promise çŠ¶æ€è½¬æ¢è§„åˆ™</span></span><br><span class="line"><span class="comment">// âœ… æ­£ç¡®ç†è§£ï¼šPromise çŠ¶æ€è½¬æ¢å–å†³äºè¿”å›å€¼</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">reject</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// æƒ…å†µ1ï¼šè¿”å›æ™®é€šå€¼ï¼ˆåŒ…æ‹¬ undefinedï¼‰</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;normal&quot;</span>;  <span class="comment">// Promise å˜ä¸º fulfilled çŠ¶æ€</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// æƒ…å†µ2ï¼šæŠ›å‡ºé”™è¯¯</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>();  <span class="comment">// Promise å˜ä¸º rejected çŠ¶æ€</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// æƒ…å†µ3ï¼šè¿”å› resolved çš„ Promise</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&quot;ok&quot;</span>);  <span class="comment">// Promise å˜ä¸º fulfilled çŠ¶æ€</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// æƒ…å†µ4ï¼šè¿”å› rejected çš„ Promise</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="string">&quot;fail&quot;</span>);  <span class="comment">// Promise å˜ä¸º rejected çŠ¶æ€</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// æƒ…å†µ5ï¼šä¸è¿”å›ä»»ä½•å€¼</span></span><br><span class="line">        <span class="comment">// é»˜è®¤è¿”å› undefinedï¼ŒPromise å˜ä¸º fulfilled çŠ¶æ€</span></span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.4 é”™è¯¯å¤„ç†æœ€ä½³å®è·µ</span></span><br><span class="line"><span class="comment">// âœ… æ¨èåšæ³•ï¼šæ ¹æ®é”™è¯¯ç±»å‹å†³å®šæ˜¯æ¢å¤è¿˜æ˜¯ç»§ç»­ä¼ æ’­</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">handleError</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">riskyOperation</span>();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="keyword">if</span> (error.<span class="property">isRecoverable</span>) &#123;</span><br><span class="line">            <span class="comment">// å¯æ¢å¤é”™è¯¯ï¼Œè¿”å›é»˜è®¤å€¼</span></span><br><span class="line">            <span class="keyword">return</span> defaultValue;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ä¸å¯æ¢å¤é”™è¯¯ï¼Œç»§ç»­ä¼ æ’­</span></span><br><span class="line">            <span class="keyword">throw</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.5 æ³¨æ„äº‹é¡¹æ€»ç»“ï¼š</span></span><br><span class="line"><span class="comment">// 1. then çš„ç¬¬äºŒä¸ªå‚æ•°ï¼ˆé”™è¯¯å¤„ç†å‡½æ•°ï¼‰åªå¤„ç†å½“å‰ Promise çš„é”™è¯¯</span></span><br><span class="line"><span class="comment">// 2. é”™è¯¯å¤„ç†å‡½æ•°çš„è¿”å›å€¼å†³å®šäº†ä¸‹ä¸€ä¸ª Promise çš„çŠ¶æ€</span></span><br><span class="line"><span class="comment">// 3. è¿”å›æ™®é€šå€¼ä¼šå°† Promise è½¬ä¸º fulfilled çŠ¶æ€</span></span><br><span class="line"><span class="comment">// 4. æŠ›å‡ºé”™è¯¯æˆ–è¿”å› rejected Promise ä¼šå°† Promise è½¬ä¸º rejected çŠ¶æ€</span></span><br><span class="line"><span class="comment">// 5. ä¸è¿”å›å€¼é»˜è®¤è¿”å› undefinedï¼ŒPromise å˜ä¸º fulfilled çŠ¶æ€</span></span><br></pre></td></tr></table></figure><h4 id="4-Promise-all-çš„é”™è¯¯å¤„ç†"><a href="#4-Promise-all-çš„é”™è¯¯å¤„ç†" class="headerlink" title="4. Promise.all çš„é”™è¯¯å¤„ç†"></a>4. Promise.all çš„é”™è¯¯å¤„ç†</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ é”™è¯¯ç”¨æ³•ï¼šæœªè€ƒè™‘éƒ¨åˆ† Promise å¤±è´¥çš„æƒ…å†µ</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">all</span>([promise1, promise2, promise3])</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">results</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœä»»ä½•ä¸€ä¸ª Promise å¤±è´¥ï¼Œè¿™é‡Œéƒ½ä¸ä¼šæ‰§è¡Œ</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… æ­£ç¡®åšæ³•ï¼šä¸ºæ¯ä¸ª Promise æ·»åŠ é”™è¯¯å¤„ç†</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">    promise1.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> (&#123; <span class="attr">error</span>: err &#125;)),</span><br><span class="line">    promise2.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> (&#123; <span class="attr">error</span>: err &#125;)),</span><br><span class="line">    promise3.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> (&#123; <span class="attr">error</span>: err &#125;))</span><br><span class="line">])</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">results</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// å³ä½¿éƒ¨åˆ† Promise å¤±è´¥ï¼Œè¿™é‡Œä¹Ÿä¼šæ‰§è¡Œ</span></span><br><span class="line">    results.<span class="title function_">forEach</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (result.<span class="property">error</span>) &#123;</span><br><span class="line">            <span class="comment">// å¤„ç†é”™è¯¯æƒ…å†µ</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="5-async-await-å¸¸è§é”™è¯¯"><a href="#5-async-await-å¸¸è§é”™è¯¯" class="headerlink" title="5. async&#x2F;await å¸¸è§é”™è¯¯"></a>5. async&#x2F;await å¸¸è§é”™è¯¯</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ é”™è¯¯ï¼šåœ¨æ™®é€šå‡½æ•°ä¸­ä½¿ç”¨ await</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">fetchData</span>(); <span class="comment">// è¯­æ³•é”™è¯¯</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âŒ é”™è¯¯ï¼šå¿˜è®°é”™è¯¯å¤„ç†</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">fetchData</span>(); <span class="comment">// å¦‚æœå‡ºé”™ï¼Œå°†å¯¼è‡´æœªæ•è·çš„å¼‚å¸¸</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… æ­£ç¡®åšæ³•</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">fetchData</span>();</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error:&#x27;</span>, error);</span><br><span class="line">        <span class="comment">// å¤„ç†é”™è¯¯</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-ç‰¹åˆ«æç¤º"><a href="#6-ç‰¹åˆ«æç¤º" class="headerlink" title="6. ç‰¹åˆ«æç¤º"></a>6. ç‰¹åˆ«æç¤º</h4><ol><li><p><strong>Promise çŠ¶æ€å˜åŒ–</strong></p><ul><li>Promise çŠ¶æ€ä¸€æ—¦æ”¹å˜å°±ä¸å¯é€†</li><li>åªæœ‰ pending çŠ¶æ€å¯ä»¥å˜ä¸º fulfilled æˆ– rejected</li><li>çŠ¶æ€å˜åŒ–åçš„å€¼ä¸å¯å˜</li></ul></li><li><p><strong>é“¾å¼è°ƒç”¨æ³¨æ„äº‹é¡¹</strong></p><ul><li>æ¯ä¸ª then&#x2F;catch éƒ½è¿”å›æ–°çš„ Promise</li><li>è¿”å›å€¼ä¼šè¢«è‡ªåŠ¨åŒ…è£…æˆ Promise</li><li>æ²¡æœ‰æ˜¾å¼è¿”å›å€¼æ—¶ï¼Œé»˜è®¤è¿”å› undefined</li></ul></li><li><p><strong>é”™è¯¯å¤„ç†æœ€ä½³å®è·µ</strong></p><ul><li>æ€»æ˜¯åœ¨ Promise é“¾çš„æœ«å°¾æ·»åŠ  catch</li><li>åœ¨é€‚å½“çš„ä½ç½®ä½¿ç”¨ finally è¿›è¡Œæ¸…ç†</li><li>é¿å…åœ¨ Promise é“¾ä¸­é™é»˜å¤±è´¥</li></ul></li><li><p><strong>async&#x2F;await ä½¿ç”¨å»ºè®®</strong></p><ul><li>æ€»æ˜¯ä½¿ç”¨ try&#x2F;catch åŒ…è£¹ await</li><li>æ³¨æ„ await çš„ä½ç½®ï¼Œé¿å…ä¸å¿…è¦çš„ç­‰å¾…</li><li>å¹¶è¡Œæ“ä½œä½¿ç”¨ Promise.all</li></ul></li><li><p><strong>æ€§èƒ½è€ƒè™‘</strong></p><ul><li>é¿å…åˆ›å»ºä¸å¿…è¦çš„ Promise</li><li>æ³¨æ„å†…å­˜æ³„æ¼ï¼ˆæœªå¤„ç†çš„ Promiseï¼‰</li><li>åˆç†ä½¿ç”¨ Promise.all è¿›è¡Œå¹¶è¡Œå¤„ç†</li></ul></li></ol><h3 id="10-6-é«˜çº§æ³¨æ„äº‹é¡¹å’Œé™·é˜±"><a href="#10-6-é«˜çº§æ³¨æ„äº‹é¡¹å’Œé™·é˜±" class="headerlink" title="10.6 é«˜çº§æ³¨æ„äº‹é¡¹å’Œé™·é˜±"></a>10.6 é«˜çº§æ³¨æ„äº‹é¡¹å’Œé™·é˜±</h3><h4 id="1-Promise-resolve-reject-çš„ç‰¹æ®Šè¡Œä¸º"><a href="#1-Promise-resolve-reject-çš„ç‰¹æ®Šè¡Œä¸º" class="headerlink" title="1. Promise.resolve&#x2F;reject çš„ç‰¹æ®Šè¡Œä¸º"></a>1. Promise.resolve&#x2F;reject çš„ç‰¹æ®Šè¡Œä¸º</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ é”™è¯¯ç†è§£ï¼šè®¤ä¸º Promise.resolve æ€»æ˜¯åŒæ­¥æ‰§è¡Œ</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="number">1</span>))  <span class="comment">// Promise åµŒå¥—çš„æƒ…å†µ</span></span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(value));  <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// âš ï¸ ç‰¹åˆ«æ³¨æ„ï¼šä¼ å…¥ thenable å¯¹è±¡</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>(&#123;</span><br><span class="line">    <span class="attr">then</span>: <span class="keyword">function</span>(<span class="params">resolve</span>) &#123;</span><br><span class="line">        <span class="title function_">resolve</span>(<span class="number">42</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(value));  <span class="comment">// 42</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨æ„ï¼šPromise.resolve ä¼šå±•å¹³ Promise</span></span><br><span class="line"><span class="keyword">const</span> p1 = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">const</span> p2 = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(p1); <span class="comment">// p2 å’Œ p1 æ˜¯åŒä¸€ä¸ª Promise</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(p1 === p2); <span class="comment">// true</span></span><br></pre></td></tr></table></figure><h4 id="2-Promise-çš„å¹¶å‘æ§åˆ¶"><a href="#2-Promise-çš„å¹¶å‘æ§åˆ¶" class="headerlink" title="2. Promise çš„å¹¶å‘æ§åˆ¶"></a>2. Promise çš„å¹¶å‘æ§åˆ¶</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ é”™è¯¯åšæ³•ï¼šæ— æ§åˆ¶åœ°å¹¶å‘è¯·æ±‚</span></span><br><span class="line">urls.<span class="title function_">map</span>(<span class="function"><span class="params">url</span> =&gt;</span> <span class="title function_">fetch</span>(url));  <span class="comment">// å¯èƒ½å¯¼è‡´æœåŠ¡å™¨å‹åŠ›è¿‡å¤§</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… æ­£ç¡®åšæ³•ï¼šæ§åˆ¶å¹¶å‘æ•°é‡</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchWithConcurrency</span>(<span class="params">urls, concurrency = <span class="number">3</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> results = [];</span><br><span class="line">    <span class="keyword">const</span> executing = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> url <span class="keyword">of</span> urls) &#123;</span><br><span class="line">        <span class="keyword">const</span> promise = <span class="title function_">fetch</span>(url).<span class="title function_">then</span>(<span class="function"><span class="params">r</span> =&gt;</span> r.<span class="title function_">json</span>());</span><br><span class="line">        results.<span class="title function_">push</span>(promise);</span><br><span class="line">        </span><br><span class="line">        executing.<span class="title function_">add</span>(promise);</span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">clean</span> = (<span class="params"></span>) =&gt; executing.<span class="title function_">delete</span>(promise);</span><br><span class="line">        promise.<span class="title function_">then</span>(clean, clean);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (executing.<span class="property">size</span> &gt;= concurrency) &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">race</span>(executing);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(results);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> urls = [<span class="string">&#x27;url1&#x27;</span>, <span class="string">&#x27;url2&#x27;</span>, <span class="string">&#x27;url3&#x27;</span>, <span class="string">&#x27;url4&#x27;</span>, <span class="string">&#x27;url5&#x27;</span>];</span><br><span class="line"><span class="title function_">fetchWithConcurrency</span>(urls, <span class="number">2</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">results</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ‰€æœ‰è¯·æ±‚å®Œæˆ&#x27;</span>));</span><br></pre></td></tr></table></figure><h4 id="3-å¾ªç¯ä¸­çš„-Promise-å¤„ç†"><a href="#3-å¾ªç¯ä¸­çš„-Promise-å¤„ç†" class="headerlink" title="3. å¾ªç¯ä¸­çš„ Promise å¤„ç†"></a>3. å¾ªç¯ä¸­çš„ Promise å¤„ç†</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ é”™è¯¯åšæ³•ï¼šåœ¨å¾ªç¯ä¸­ä½¿ç”¨ await</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">wrong</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> urls = [<span class="string">&#x27;url1&#x27;</span>, <span class="string">&#x27;url2&#x27;</span>, <span class="string">&#x27;url3&#x27;</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> url <span class="keyword">of</span> urls) &#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">fetch</span>(url);  <span class="comment">// ä¸²è¡Œæ‰§è¡Œï¼Œæ•ˆç‡ä½</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… æ­£ç¡®åšæ³•ï¼šå¹¶è¡Œæ‰§è¡Œ</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">right</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> urls = [<span class="string">&#x27;url1&#x27;</span>, <span class="string">&#x27;url2&#x27;</span>, <span class="string">&#x27;url3&#x27;</span>];</span><br><span class="line">    <span class="keyword">const</span> promises = urls.<span class="title function_">map</span>(<span class="function"><span class="params">url</span> =&gt;</span> <span class="title function_">fetch</span>(url));</span><br><span class="line">    <span class="keyword">const</span> results = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(promises);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… éœ€è¦æŒ‰é¡ºåºæ‰§è¡Œæ—¶çš„æ­£ç¡®åšæ³•</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">sequential</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> urls = [<span class="string">&#x27;url1&#x27;</span>, <span class="string">&#x27;url2&#x27;</span>, <span class="string">&#x27;url3&#x27;</span>];</span><br><span class="line">    <span class="keyword">const</span> results = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> url <span class="keyword">of</span> urls) &#123;</span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">fetch</span>(url);</span><br><span class="line">        results.<span class="title function_">push</span>(<span class="keyword">await</span> result.<span class="title function_">json</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> results;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-Promise-ç«æ€é—®é¢˜å¤„ç†"><a href="#4-Promise-ç«æ€é—®é¢˜å¤„ç†" class="headerlink" title="4. Promise ç«æ€é—®é¢˜å¤„ç†"></a>4. Promise ç«æ€é—®é¢˜å¤„ç†</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ æ½œåœ¨é—®é¢˜ï¼šå¤šä¸ªè¯·æ±‚çš„å“åº”é¡ºåºä¸ç¡®å®š</span></span><br><span class="line"><span class="keyword">let</span> currentData;</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchData</span>(<span class="params">id</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">`/api/<span class="subst">$&#123;id&#125;</span>`</span>);</span><br><span class="line">    currentData = <span class="keyword">await</span> response.<span class="title function_">json</span>();  <span class="comment">// å¯èƒ½è¢«åå‘å…ˆè‡³çš„è¯·æ±‚è¦†ç›–</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… æ­£ç¡®åšæ³•ï¼šä½¿ç”¨æ ‡è®°æˆ–å–æ¶ˆæœºåˆ¶</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createFetchWithAbort</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> currentController = <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchData</span>(<span class="params">id</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (currentController) &#123;</span><br><span class="line">            currentController.<span class="title function_">abort</span>();  <span class="comment">// å–æ¶ˆä¹‹å‰çš„è¯·æ±‚</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        currentController = <span class="keyword">new</span> <span class="title class_">AbortController</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">`/api/<span class="subst">$&#123;id&#125;</span>`</span>, &#123;</span><br><span class="line">                <span class="attr">signal</span>: currentController.<span class="property">signal</span></span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="keyword">if</span> (error.<span class="property">name</span> === <span class="string">&#x27;AbortError&#x27;</span>) &#123;</span><br><span class="line">                <span class="comment">// è¯·æ±‚è¢«å–æ¶ˆï¼Œå¿½ç•¥é”™è¯¯</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> fetchWithAbort = <span class="title function_">createFetchWithAbort</span>();</span><br><span class="line"><span class="title function_">fetchWithAbort</span>(<span class="string">&#x27;id1&#x27;</span>);</span><br><span class="line"><span class="title function_">fetchWithAbort</span>(<span class="string">&#x27;id2&#x27;</span>); <span class="comment">// id1 çš„è¯·æ±‚ä¼šè¢«å–æ¶ˆ</span></span><br></pre></td></tr></table></figure><h4 id="5-async-await-ä¸-Promise-æ··ç”¨çš„é™·é˜±"><a href="#5-async-await-ä¸-Promise-æ··ç”¨çš„é™·é˜±" class="headerlink" title="5. async&#x2F;await ä¸ Promise æ··ç”¨çš„é™·é˜±"></a>5. async&#x2F;await ä¸ Promise æ··ç”¨çš„é™·é˜±</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ é”™è¯¯åšæ³•ï¼šæ··åˆä½¿ç”¨å¯èƒ½å¯¼è‡´é”™è¯¯å¤„ç†æ··ä¹±</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">mixed</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">somePromise</span>()</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> <span class="title function_">process</span>(data))  <span class="comment">// è¿™é‡Œçš„é”™è¯¯ä¸ä¼šè¢« catch æ•è·</span></span><br><span class="line">            .<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> <span class="title function_">handle</span>(err));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œæ•è·ä¸åˆ° .then ä¸­çš„é”™è¯¯</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… æ­£ç¡®åšæ³•ï¼šç»Ÿä¸€ä½¿ç”¨ async/await</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">consistent</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">somePromise</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">process</span>(data);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">handle</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… å¦‚æœå¿…é¡»æ··ç”¨ï¼Œç¡®ä¿é”™è¯¯å¤„ç†çš„å®Œæ•´æ€§</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">mixedButSafe</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">somePromise</span>()</span><br><span class="line">            .<span class="title function_">then</span>(<span class="keyword">async</span> data =&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">process</span>(data);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> error; <span class="comment">// ç¡®ä¿é”™è¯¯èƒ½è¢«å¤–å±‚ catch æ•è·</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">handle</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-Promise-å†…å­˜æ³„æ¼çš„å…¶ä»–æƒ…å†µ"><a href="#6-Promise-å†…å­˜æ³„æ¼çš„å…¶ä»–æƒ…å†µ" class="headerlink" title="6. Promise å†…å­˜æ³„æ¼çš„å…¶ä»–æƒ…å†µ"></a>6. Promise å†…å­˜æ³„æ¼çš„å…¶ä»–æƒ…å†µ</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ æ½œåœ¨é—®é¢˜ï¼šäº‹ä»¶ç›‘å¬å™¨ä¸­çš„ Promise</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataLoader</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listener</span> = <span class="variable language_">this</span>.<span class="property">handleData</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">        eventEmitter.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="variable language_">this</span>.<span class="property">listener</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">handleData</span>(<span class="params">data</span>) &#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">processData</span>(data);  <span class="comment">// å¦‚æœç»„ä»¶è¢«é”€æ¯ï¼Œè¿™ä¸ª Promise å¯èƒ½æ°¸è¿œæŒ‚ç€</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… æ­£ç¡®åšæ³•ï¼šç¡®ä¿æ¸…ç†</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataLoader</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">abortController</span> = <span class="keyword">new</span> <span class="title class_">AbortController</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listener</span> = <span class="variable language_">this</span>.<span class="property">handleData</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">        eventEmitter.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="variable language_">this</span>.<span class="property">listener</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">handleData</span>(<span class="params">data</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">abortController</span>.<span class="property">signal</span>.<span class="property">aborted</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">processData</span>(data);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">destroy</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">abortController</span>.<span class="title function_">abort</span>();</span><br><span class="line">        eventEmitter.<span class="title function_">off</span>(<span class="string">&#x27;data&#x27;</span>, <span class="variable language_">this</span>.<span class="property">listener</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨ React ç»„ä»¶ä¸­çš„ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> loader = <span class="keyword">new</span> <span class="title class_">DataLoader</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> loader.<span class="title function_">destroy</span>(); <span class="comment">// æ¸…ç†å‡½æ•°</span></span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure><h4 id="7-ç‰¹æ®Šåœºæ™¯çš„æ³¨æ„äº‹é¡¹"><a href="#7-ç‰¹æ®Šåœºæ™¯çš„æ³¨æ„äº‹é¡¹" class="headerlink" title="7. ç‰¹æ®Šåœºæ™¯çš„æ³¨æ„äº‹é¡¹"></a>7. ç‰¹æ®Šåœºæ™¯çš„æ³¨æ„äº‹é¡¹</h4><ol><li><strong>Promise é“¾ä¸­çš„å€¼ä¼ é€’</strong>ï¼š</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ é”™è¯¯åšæ³•ï¼šæ²¡æœ‰æ­£ç¡®ä¼ é€’å€¼</span></span><br><span class="line">promise</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">process</span>(value);</span><br><span class="line">        <span class="comment">// æ²¡æœ‰è¿”å›å€¼ï¼Œä¸‹ä¸€ä¸ª then å°†æ”¶åˆ° undefined</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// value æ˜¯ undefined</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… æ­£ç¡®åšæ³•ï¼šç¡®ä¿æ­£ç¡®ä¼ é€’å€¼</span></span><br><span class="line">promise</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">process</span>(value);</span><br><span class="line">        <span class="keyword">return</span> value; <span class="comment">// æ˜¾å¼è¿”å›éœ€è¦ä¼ é€’çš„å€¼</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// value æ˜¯ä¸Šä¸€æ­¥è¿”å›çš„å€¼</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><ol start="2"><li><strong>Promise çš„é”™è¯¯æ¢å¤é“¾</strong>ï¼š</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âœ… é«˜çº§é”™è¯¯æ¢å¤æ¨¡å¼</span></span><br><span class="line"><span class="title function_">fetchData</span>()</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (error.<span class="property">type</span> === <span class="string">&#x27;network&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">fetchFromCache</span>(); <span class="comment">// å°è¯•ä»ç¼“å­˜è·å–</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> error; <span class="comment">// å…¶ä»–é”™è¯¯ç»§ç»­ä¼ æ’­</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (error.<span class="property">type</span> === <span class="string">&#x27;cache&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">fetchFromBackup</span>(); <span class="comment">// å°è¯•ä»å¤‡ä»½è·å–</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> error;</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> defaultValue; <span class="comment">// æœ€åçš„é™çº§å¤„ç†</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><ol start="3"><li><strong>æ¡ä»¶ Promise æ‰§è¡Œ</strong>ï¼š</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âœ… æ ¹æ®æ¡ä»¶å†³å®šæ˜¯å¦æ‰§è¡Œ Promise</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">conditionalFetch</span>(<span class="params">condition</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!condition) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;/api/data&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Fetch failed:&#x27;</span>, error);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise">MDN Promise æ–‡æ¡£</a></li><li><a href="https://promisesaplus.com/">JavaScript Promise è§„èŒƒ</a></li><li><a href="https://tc39.es/ecma262/#sec-promise-objects">ECMAScript Promise è§„èŒƒ</a></li></ul><h2 id="11-æ›´å¤šå®é™…åº”ç”¨åœºæ™¯"><a href="#11-æ›´å¤šå®é™…åº”ç”¨åœºæ™¯" class="headerlink" title="11. æ›´å¤šå®é™…åº”ç”¨åœºæ™¯"></a>11. æ›´å¤šå®é™…åº”ç”¨åœºæ™¯</h2><h3 id="11-1-æ–‡ä»¶ä¸Šä¼ ä¸è¿›åº¦ç›‘æ§"><a href="#11-1-æ–‡ä»¶ä¸Šä¼ ä¸è¿›åº¦ç›‘æ§" class="headerlink" title="11.1 æ–‡ä»¶ä¸Šä¼ ä¸è¿›åº¦ç›‘æ§"></a>11.1 æ–‡ä»¶ä¸Šä¼ ä¸è¿›åº¦ç›‘æ§</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">uploadFileWithProgress</span>(<span class="params">file, onProgress</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">        <span class="keyword">const</span> formData = <span class="keyword">new</span> <span class="title class_">FormData</span>();</span><br><span class="line">        formData.<span class="title function_">append</span>(<span class="string">&#x27;file&#x27;</span>, file);</span><br><span class="line"></span><br><span class="line">        xhr.<span class="property">upload</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;progress&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (event.<span class="property">lengthComputable</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> progress = (event.<span class="property">loaded</span> / event.<span class="property">total</span>) * <span class="number">100</span>;</span><br><span class="line">                <span class="title function_">onProgress</span>(progress);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        xhr.<span class="title function_">addEventListener</span>(<span class="string">&#x27;load&#x27;</span>, <span class="function">() =&gt;</span> <span class="title function_">resolve</span>(xhr.<span class="property">response</span>));</span><br><span class="line">        xhr.<span class="title function_">addEventListener</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">() =&gt;</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Upload failed&#x27;</span>)));</span><br><span class="line">        xhr.<span class="title function_">addEventListener</span>(<span class="string">&#x27;abort&#x27;</span>, <span class="function">() =&gt;</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Upload aborted&#x27;</span>)));</span><br><span class="line"></span><br><span class="line">        xhr.<span class="title function_">open</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/api/upload&#x27;</span>);</span><br><span class="line">        xhr.<span class="title function_">send</span>(formData);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> fileInput = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;input[type=&quot;file&quot;]&#x27;</span>);</span><br><span class="line">fileInput.<span class="title function_">addEventListener</span>(<span class="string">&#x27;change&#x27;</span>, <span class="title function_">async</span> (e) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> file = e.<span class="property">target</span>.<span class="property">files</span>[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">uploadFileWithProgress</span>(file, <span class="function">(<span class="params">progress</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Upload progress: <span class="subst">$&#123;progress&#125;</span>%`</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Upload complete&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Upload error:&#x27;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="11-2-å¸¦é‡è¯•æœºåˆ¶çš„APIè¯·æ±‚"><a href="#11-2-å¸¦é‡è¯•æœºåˆ¶çš„APIè¯·æ±‚" class="headerlink" title="11.2 å¸¦é‡è¯•æœºåˆ¶çš„APIè¯·æ±‚"></a>11.2 å¸¦é‡è¯•æœºåˆ¶çš„APIè¯·æ±‚</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchWithRetry</span>(<span class="params">url, options = &#123;&#125;, maxRetries = <span class="number">3</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">delay</span> = (<span class="params">ms</span>) =&gt; <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(resolve, ms));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; maxRetries; i++) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(url, options);</span><br><span class="line">            <span class="keyword">if</span> (!response.<span class="property">ok</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`HTTP error! status: <span class="subst">$&#123;response.status&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i === maxRetries - <span class="number">1</span>) <span class="keyword">throw</span> error;</span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">delay</span>(<span class="title class_">Math</span>.<span class="title function_">pow</span>(<span class="number">2</span>, i) * <span class="number">1000</span>); <span class="comment">// æŒ‡æ•°é€€é¿</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Retrying... (<span class="subst">$&#123;i + <span class="number">1</span>&#125;</span>/<span class="subst">$&#123;maxRetries&#125;</span>)`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="title function_">fetchWithRetry</span>(<span class="string">&#x27;/api/data&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Success:&#x27;</span>, data))</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Final error:&#x27;</span>, error));</span><br></pre></td></tr></table></figure><h3 id="11-3-èµ„æºé¢„åŠ è½½"><a href="#11-3-èµ„æºé¢„åŠ è½½" class="headerlink" title="11.3 èµ„æºé¢„åŠ è½½"></a>11.3 èµ„æºé¢„åŠ è½½</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ResourcePreloader</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cache</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">preload</span>(<span class="params">url</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">has</span>(url)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">get</span>(url));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> promise = <span class="title function_">fetch</span>(url)</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>())</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">set</span>(url, data);</span><br><span class="line">                <span class="keyword">return</span> data;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">set</span>(url, promise);</span><br><span class="line">        <span class="keyword">return</span> promise;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">get</span>(<span class="params">url</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">get</span>(url) || <span class="variable language_">this</span>.<span class="title function_">preload</span>(url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> preloader = <span class="keyword">new</span> <span class="title class_">ResourcePreloader</span>();</span><br><span class="line"><span class="comment">// é¢„åŠ è½½èµ„æº</span></span><br><span class="line">preloader.<span class="title function_">preload</span>(<span class="string">&#x27;/api/user/1&#x27;</span>);</span><br><span class="line">preloader.<span class="title function_">preload</span>(<span class="string">&#x27;/api/user/2&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¨åä½¿ç”¨</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">displayUser</span>(<span class="params">id</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> userData = <span class="keyword">await</span> preloader.<span class="title function_">get</span>(<span class="string">`/api/user/<span class="subst">$&#123;id&#125;</span>`</span>);</span><br><span class="line">    <span class="comment">// ä½¿ç”¨é¢„åŠ è½½çš„æ•°æ®</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="11-4-å¹¶å‘è¯·æ±‚é™åˆ¶å™¨"><a href="#11-4-å¹¶å‘è¯·æ±‚é™åˆ¶å™¨" class="headerlink" title="11.4 å¹¶å‘è¯·æ±‚é™åˆ¶å™¨"></a>11.4 å¹¶å‘è¯·æ±‚é™åˆ¶å™¨</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RequestLimiter</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">maxConcurrent = <span class="number">5</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">maxConcurrent</span> = maxConcurrent;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentRequests</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">queue</span> = [];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">add</span>(<span class="params">promiseFactory</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">currentRequests</span> &gt;= <span class="variable language_">this</span>.<span class="property">maxConcurrent</span>) &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="variable language_">this</span>.<span class="property">queue</span>.<span class="title function_">push</span>(resolve));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentRequests</span>++;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">promiseFactory</span>();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">currentRequests</span>--;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">queue</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> next = <span class="variable language_">this</span>.<span class="property">queue</span>.<span class="title function_">shift</span>();</span><br><span class="line">                <span class="title function_">next</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> limiter = <span class="keyword">new</span> <span class="title class_">RequestLimiter</span>(<span class="number">3</span>);</span><br><span class="line"><span class="keyword">const</span> urls = <span class="title class_">Array</span>.<span class="title function_">from</span>(&#123; <span class="attr">length</span>: <span class="number">10</span> &#125;, <span class="function">(<span class="params">_, i</span>) =&gt;</span> <span class="string">`/api/item/<span class="subst">$&#123;i&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">all</span>(</span><br><span class="line">    urls.<span class="title function_">map</span>(<span class="function"><span class="params">url</span> =&gt;</span> </span><br><span class="line">        limiter.<span class="title function_">add</span>(<span class="function">() =&gt;</span> <span class="title function_">fetch</span>(url).<span class="title function_">then</span>(<span class="function"><span class="params">r</span> =&gt;</span> r.<span class="title function_">json</span>()))</span><br><span class="line">    )</span><br><span class="line">).<span class="title function_">then</span>(<span class="function"><span class="params">results</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;All requests completed&#x27;</span>));</span><br></pre></td></tr></table></figure><h2 id="12-è¯¦ç»†é”™è¯¯å¤„ç†æŒ‡å—"><a href="#12-è¯¦ç»†é”™è¯¯å¤„ç†æŒ‡å—" class="headerlink" title="12. è¯¦ç»†é”™è¯¯å¤„ç†æŒ‡å—"></a>12. è¯¦ç»†é”™è¯¯å¤„ç†æŒ‡å—</h2><h3 id="12-1-é”™è¯¯ç±»å‹åˆ†ç±»"><a href="#12-1-é”™è¯¯ç±»å‹åˆ†ç±»" class="headerlink" title="12.1 é”™è¯¯ç±»å‹åˆ†ç±»"></a>12.1 é”™è¯¯ç±»å‹åˆ†ç±»</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">NetworkError</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Error</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(message);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">name</span> = <span class="string">&#x27;NetworkError&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ValidationError</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Error</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(message);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">name</span> = <span class="string">&#x27;ValidationError&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TimeoutError</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Error</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(message);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">name</span> = <span class="string">&#x27;TimeoutError&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchWithErrorHandling</span>(<span class="params">url</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(url);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!response.<span class="property">ok</span>) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (response.<span class="property">status</span>) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">404</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ValidationError</span>(<span class="string">&#x27;Resource not found&#x27;</span>);</span><br><span class="line">                <span class="keyword">case</span> <span class="number">401</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ValidationError</span>(<span class="string">&#x27;Unauthorized&#x27;</span>);</span><br><span class="line">                <span class="keyword">case</span> <span class="number">503</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NetworkError</span>(<span class="string">&#x27;Service unavailable&#x27;</span>);</span><br><span class="line">                <span class="attr">default</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`HTTP error! status: <span class="subst">$&#123;response.status&#125;</span>`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="keyword">if</span> (error <span class="keyword">instanceof</span> <span class="title class_">ValidationError</span>) &#123;</span><br><span class="line">            <span class="comment">// å¤„ç†éªŒè¯é”™è¯¯</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Validation error:&#x27;</span>, error.<span class="property">message</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error <span class="keyword">instanceof</span> <span class="title class_">NetworkError</span>) &#123;</span><br><span class="line">            <span class="comment">// å¤„ç†ç½‘ç»œé”™è¯¯</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Network error:&#x27;</span>, error.<span class="property">message</span>);</span><br><span class="line">            <span class="keyword">throw</span> error; <span class="comment">// é‡æ–°æŠ›å‡ºç½‘ç»œé”™è¯¯</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¤„ç†å…¶ä»–é”™è¯¯</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Unexpected error:&#x27;</span>, error);</span><br><span class="line">            <span class="keyword">throw</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="12-2-å…¨å±€é”™è¯¯å¤„ç†"><a href="#12-2-å…¨å±€é”™è¯¯å¤„ç†" class="headerlink" title="12.2 å…¨å±€é”™è¯¯å¤„ç†"></a>12.2 å…¨å±€é”™è¯¯å¤„ç†</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ErrorHandler</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">handle</span>(<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (error <span class="keyword">instanceof</span> <span class="title class_">ValidationError</span>) &#123;</span><br><span class="line">            <span class="comment">// å¤„ç†éªŒè¯é”™è¯¯</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">handleValidationError</span>(error);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error <span class="keyword">instanceof</span> <span class="title class_">NetworkError</span>) &#123;</span><br><span class="line">            <span class="comment">// å¤„ç†ç½‘ç»œé”™è¯¯</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">handleNetworkError</span>(error);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error <span class="keyword">instanceof</span> <span class="title class_">TimeoutError</span>) &#123;</span><br><span class="line">            <span class="comment">// å¤„ç†è¶…æ—¶é”™è¯¯</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">handleTimeoutError</span>(error);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¤„ç†æœªçŸ¥é”™è¯¯</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">handleUnknownError</span>(error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">handleValidationError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Validation Error:&#x27;</span>, error.<span class="property">message</span>);</span><br><span class="line">        <span class="comment">// æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">handleNetworkError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Network Error:&#x27;</span>, error.<span class="property">message</span>);</span><br><span class="line">        <span class="comment">// å°è¯•é‡æ–°è¿æ¥</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">handleTimeoutError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Timeout Error:&#x27;</span>, error.<span class="property">message</span>);</span><br><span class="line">        <span class="comment">// æç¤ºç”¨æˆ·é‡è¯•</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">handleUnknownError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Unknown Error:&#x27;</span>, error);</span><br><span class="line">        <span class="comment">// è®°å½•é”™è¯¯å¹¶é€šçŸ¥å¼€å‘å›¢é˜Ÿ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;unhandledrejection&#x27;</span>, <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">ErrorHandler</span>.<span class="title function_">handle</span>(event.<span class="property">reason</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="13-æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ"><a href="#13-æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ" class="headerlink" title="13. æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ"></a>13. æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ</h2><h3 id="13-1-Promise-æ‰¹å¤„ç†"><a href="#13-1-Promise-æ‰¹å¤„ç†" class="headerlink" title="13.1 Promise æ‰¹å¤„ç†"></a>13.1 Promise æ‰¹å¤„ç†</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PromiseBatcher</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">batchSize = <span class="number">100</span>, interval = <span class="number">50</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">batchSize</span> = batchSize;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">interval</span> = interval;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">queue</span> = [];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">pending</span> = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">add</span>(<span class="params">item</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">queue</span>.<span class="title function_">push</span>(&#123; item, resolve, reject &#125;);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">process</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">process</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">pending</span> || <span class="variable language_">this</span>.<span class="property">queue</span>.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">pending</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(resolve, <span class="variable language_">this</span>.<span class="property">interval</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> batch = <span class="variable language_">this</span>.<span class="property">queue</span>.<span class="title function_">splice</span>(<span class="number">0</span>, <span class="variable language_">this</span>.<span class="property">batchSize</span>);</span><br><span class="line">        <span class="keyword">const</span> items = batch.<span class="title function_">map</span>(<span class="function">(<span class="params">&#123; item &#125;</span>) =&gt;</span> item);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> results = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">processBatch</span>(items);</span><br><span class="line">            batch.<span class="title function_">forEach</span>(<span class="function">(<span class="params">&#123; resolve &#125;, index</span>) =&gt;</span> <span class="title function_">resolve</span>(results[index]));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            batch.<span class="title function_">forEach</span>(<span class="function">(<span class="params">&#123; reject &#125;</span>) =&gt;</span> <span class="title function_">reject</span>(error));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">pending</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">queue</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">process</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">processBatch</span>(<span class="params">items</span>) &#123;</span><br><span class="line">        <span class="comment">// å®ç°æ‰¹å¤„ç†é€»è¾‘</span></span><br><span class="line">        <span class="keyword">return</span> items.<span class="title function_">map</span>(<span class="function"><span class="params">item</span> =&gt;</span> <span class="string">`Processed <span class="subst">$&#123;item&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> batcher = <span class="keyword">new</span> <span class="title class_">PromiseBatcher</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">    batcher.<span class="title function_">add</span>(i).<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(result));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="13-2-Promise-ç¼“å­˜ä¼˜åŒ–"><a href="#13-2-Promise-ç¼“å­˜ä¼˜åŒ–" class="headerlink" title="13.2 Promise ç¼“å­˜ä¼˜åŒ–"></a>13.2 Promise ç¼“å­˜ä¼˜åŒ–</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PromiseCache</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">ttl = <span class="number">60000</span></span>) &#123; <span class="comment">// é»˜è®¤ç¼“å­˜æ—¶é—´ 1 åˆ†é’Ÿ</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cache</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ttl</span> = ttl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">get</span>(<span class="params">key, promiseFactory</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> cached = <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">get</span>(key);</span><br><span class="line">        <span class="keyword">if</span> (cached &amp;&amp; <span class="title class_">Date</span>.<span class="title function_">now</span>() - cached.<span class="property">timestamp</span> &lt; <span class="variable language_">this</span>.<span class="property">ttl</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> cached.<span class="property">data</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">promiseFactory</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">set</span>(key, &#123;</span><br><span class="line">            data,</span><br><span class="line">            <span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">invalidate</span>(<span class="params">key</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">delete</span>(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">clear</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">clear</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> cache = <span class="keyword">new</span> <span class="title class_">PromiseCache</span>();</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchUserWithCache</span>(<span class="params">userId</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cache.<span class="title function_">get</span>(</span><br><span class="line">        <span class="string">`user_<span class="subst">$&#123;userId&#125;</span>`</span>,</span><br><span class="line">        <span class="function">() =&gt;</span> <span class="title function_">fetch</span>(<span class="string">`/api/users/<span class="subst">$&#123;userId&#125;</span>`</span>).<span class="title function_">then</span>(<span class="function"><span class="params">r</span> =&gt;</span> r.<span class="title function_">json</span>())</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="13-3-å†…å­˜ä¼˜åŒ–"><a href="#13-3-å†…å­˜ä¼˜åŒ–" class="headerlink" title="13.3 å†…å­˜ä¼˜åŒ–"></a>13.3 å†…å­˜ä¼˜åŒ–</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MemoryEfficientPromise</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">async</span> <span class="title function_">batch</span>(<span class="params">items, processor, batchSize = <span class="number">100</span></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> results = [];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; items.<span class="property">length</span>; i += batchSize) &#123;</span><br><span class="line">            <span class="keyword">const</span> batch = items.<span class="title function_">slice</span>(i, i + batchSize);</span><br><span class="line">            <span class="keyword">const</span> batchResults = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(</span><br><span class="line">                batch.<span class="title function_">map</span>(processor)</span><br><span class="line">            );</span><br><span class="line">            results.<span class="title function_">push</span>(...batchResults);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å…è®¸åƒåœ¾å›æ”¶</span></span><br><span class="line">            <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(resolve, <span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> results;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">async</span> <span class="title function_">stream</span>(<span class="params">asyncIterable, processor</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> results = [];</span><br><span class="line">        <span class="keyword">for</span> <span class="title function_">await</span> (<span class="keyword">const</span> item <span class="keyword">of</span> asyncIterable) &#123;</span><br><span class="line">            results.<span class="title function_">push</span>(<span class="keyword">await</span> <span class="title function_">processor</span>(item));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å®šæœŸæ¸…ç†</span></span><br><span class="line">            <span class="keyword">if</span> (results.<span class="property">length</span> % <span class="number">1000</span> === <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(resolve, <span class="number">0</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> results;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> items = <span class="title class_">Array</span>.<span class="title function_">from</span>(&#123; <span class="attr">length</span>: <span class="number">10000</span> &#125;, <span class="function">(<span class="params">_, i</span>) =&gt;</span> i);</span><br><span class="line"><span class="title class_">MemoryEfficientPromise</span>.<span class="title function_">batch</span>(items, <span class="title function_">async</span> (item) =&gt; &#123;</span><br><span class="line">    <span class="comment">// å¤„ç†æ¯ä¸ªé¡¹ç›®</span></span><br><span class="line">    <span class="keyword">return</span> item * <span class="number">2</span>;</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">results</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Processed items:&#x27;</span>, results.<span class="property">length</span>));</span><br></pre></td></tr></table></figure><h2 id="14-è¡¥å……æœ€ä½³å®è·µå»ºè®®"><a href="#14-è¡¥å……æœ€ä½³å®è·µå»ºè®®" class="headerlink" title="14. è¡¥å……æœ€ä½³å®è·µå»ºè®®"></a>14. è¡¥å……æœ€ä½³å®è·µå»ºè®®</h2><h3 id="14-1-Promise-é“¾ä¼˜åŒ–"><a href="#14-1-Promise-é“¾ä¼˜åŒ–" class="headerlink" title="14.1 Promise é“¾ä¼˜åŒ–"></a>14.1 Promise é“¾ä¼˜åŒ–</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âœ… ä¼˜åŒ– Promise é“¾</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">optimizedChain</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1. å¹¶è¡Œæ‰§è¡Œæ— ä¾èµ–çš„ Promise</span></span><br><span class="line">        <span class="keyword">const</span> [data1, data2] = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">            <span class="title function_">fetchData1</span>(),</span><br><span class="line">            <span class="title function_">fetchData2</span>()</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. ä¸²è¡Œæ‰§è¡Œæœ‰ä¾èµ–çš„ Promise</span></span><br><span class="line">        <span class="keyword">const</span> result1 = <span class="keyword">await</span> <span class="title function_">processData</span>(data1);</span><br><span class="line">        <span class="keyword">const</span> result2 = <span class="keyword">await</span> <span class="title function_">processData</span>(data2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. æ¡ä»¶æ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">needsExtra</span>(result1)) &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">extraProcessing</span>(result1);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [result1, result2];</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="comment">// ç»Ÿä¸€é”™è¯¯å¤„ç†</span></span><br><span class="line">        <span class="title class_">ErrorHandler</span>.<span class="title function_">handle</span>(error);</span><br><span class="line">        <span class="keyword">throw</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="14-2-èµ„æºç®¡ç†"><a href="#14-2-èµ„æºç®¡ç†" class="headerlink" title="14.2 èµ„æºç®¡ç†"></a>14.2 èµ„æºç®¡ç†</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ResourceManager</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">resources</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">locks</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">acquire</span>(<span class="params">key</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">locks</span>.<span class="title function_">has</span>(key)) &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">locks</span>.<span class="title function_">get</span>(key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> lock = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">locks</span>.<span class="title function_">set</span>(key, resolve);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">resources</span>.<span class="title function_">has</span>(key)) &#123;</span><br><span class="line">                <span class="keyword">const</span> resource = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">createResource</span>(key);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">resources</span>.<span class="title function_">set</span>(key, resource);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">resources</span>.<span class="title function_">get</span>(key);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">locks</span>.<span class="title function_">delete</span>(key);</span><br><span class="line">            lock.<span class="title function_">resolve</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">release</span>(<span class="params">key</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">resources</span>.<span class="title function_">has</span>(key)) &#123;</span><br><span class="line">            <span class="keyword">const</span> resource = <span class="variable language_">this</span>.<span class="property">resources</span>.<span class="title function_">get</span>(key);</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">cleanupResource</span>(resource);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">resources</span>.<span class="title function_">delete</span>(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">createResource</span>(<span class="params">key</span>) &#123;</span><br><span class="line">        <span class="comment">// å®ç°èµ„æºåˆ›å»ºé€»è¾‘</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">cleanupResource</span>(<span class="params">resource</span>) &#123;</span><br><span class="line">        <span class="comment">// å®ç°èµ„æºæ¸…ç†é€»è¾‘</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="14-3-ç›‘æ§å’Œæ—¥å¿—"><a href="#14-3-ç›‘æ§å’Œæ—¥å¿—" class="headerlink" title="14.3 ç›‘æ§å’Œæ—¥å¿—"></a>14.3 ç›‘æ§å’Œæ—¥å¿—</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PromiseMonitor</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">metrics</span> = &#123;</span><br><span class="line">            <span class="attr">total</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">success</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">failure</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">timing</span>: []</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">track</span>(<span class="params">promise, metadata = &#123;&#125;</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> startTime = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">total</span>++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> result = <span class="keyword">await</span> promise;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">success</span>++;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">recordTiming</span>(startTime, metadata);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">failure</span>++;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">recordError</span>(error, metadata);</span><br><span class="line">            <span class="keyword">throw</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">recordTiming</span>(<span class="params">startTime, metadata</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> duration = <span class="title class_">Date</span>.<span class="title function_">now</span>() - startTime;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">timing</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">            duration,</span><br><span class="line">            ...metadata,</span><br><span class="line">            <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">recordError</span>(<span class="params">error, metadata</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Promise Error:&#x27;</span>, &#123;</span><br><span class="line">            <span class="attr">error</span>: error.<span class="property">message</span>,</span><br><span class="line">            <span class="attr">stack</span>: error.<span class="property">stack</span>,</span><br><span class="line">            ...metadata,</span><br><span class="line">            <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">getMetrics</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            ...<span class="variable language_">this</span>.<span class="property">metrics</span>,</span><br><span class="line">            <span class="attr">successRate</span>: <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">success</span> / <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">total</span>,</span><br><span class="line">            <span class="attr">averageDuration</span>: <span class="variable language_">this</span>.<span class="title function_">calculateAverageDuration</span>()</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">calculateAverageDuration</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">timing</span>.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">const</span> sum = <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">timing</span>.<span class="title function_">reduce</span>(<span class="function">(<span class="params">acc, &#123; duration &#125;</span>) =&gt;</span> acc + duration, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> sum / <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">timing</span>.<span class="property">length</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> monitor = <span class="keyword">new</span> <span class="title class_">PromiseMonitor</span>();</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">monitoredOperation</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> monitor.<span class="title function_">track</span>(</span><br><span class="line">        <span class="title function_">fetch</span>(<span class="string">&#x27;/api/data&#x27;</span>),</span><br><span class="line">        &#123; <span class="attr">operation</span>: <span class="string">&#x27;fetchData&#x27;</span>, <span class="attr">priority</span>: <span class="string">&#x27;high&#x27;</span> &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="14-4-æµ‹è¯•æœ€ä½³å®è·µ"><a href="#14-4-æµ‹è¯•æœ€ä½³å®è·µ" class="headerlink" title="14.4 æµ‹è¯•æœ€ä½³å®è·µ"></a>14.4 æµ‹è¯•æœ€ä½³å®è·µ</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Promise æµ‹è¯•è¾…åŠ©å‡½æ•°</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PromiseTestUtils</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">async</span> <span class="title function_">expectResolve</span>(<span class="params">promise</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> error;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> promise;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            error = e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">expect</span>(error).<span class="title function_">toBeUndefined</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">async</span> <span class="title function_">expectReject</span>(<span class="params">promise</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> error;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> promise;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            error = e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">expect</span>(error).<span class="title function_">toBeDefined</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">createDeferred</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> resolve, reject;</span><br><span class="line">        <span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">            resolve = res;</span><br><span class="line">            reject = rej;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> &#123; promise, resolve, reject &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•ç¤ºä¾‹</span></span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;Promise Tests&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">it</span>(<span class="string">&#x27;should handle successful operations&#x27;</span>, <span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; promise, resolve &#125; = <span class="title class_">PromiseTestUtils</span>.<span class="title function_">createDeferred</span>();</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">resolve</span>(<span class="string">&#x27;success&#x27;</span>), <span class="number">100</span>);</span><br><span class="line">        <span class="keyword">await</span> <span class="title class_">PromiseTestUtils</span>.<span class="title function_">expectResolve</span>(promise);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">it</span>(<span class="string">&#x27;should handle failures&#x27;</span>, <span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; promise, reject &#125; = <span class="title class_">PromiseTestUtils</span>.<span class="title function_">createDeferred</span>();</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;fail&#x27;</span>)), <span class="number">100</span>);</span><br><span class="line">        <span class="keyword">await</span> <span class="title class_">PromiseTestUtils</span>.<span class="title function_">expectReject</span>(promise);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;æ·±å…¥ç†è§£-JavaScript-Promiseï¼šä»å…¥é—¨åˆ°ç²¾é€š&quot;&gt;&lt;a href=&quot;#æ·±å…¥ç†è§£-JavaScript-Promiseï¼šä»å…¥é—¨åˆ°ç²¾é€š&quot; class=&quot;headerlink&quot; title=&quot;æ·±å…¥ç†è§£ JavaScript Promiseï¼šä»å…¥é—¨åˆ°ç²¾é€š&quot;&gt;</summary>
      
    
    
    
    <category term="æ•™ç¨‹" scheme="https://aoayaoa.github.io/categories/%E6%95%99%E7%A8%8B/"/>
    
    
    <category term="Promise" scheme="https://aoayaoa.github.io/tags/Promise/"/>
    
    <category term="å…¥é—¨" scheme="https://aoayaoa.github.io/tags/%E5%85%A5%E9%97%A8/"/>
    
  </entry>
  
  <entry>
    <title>Taroä½¿ç”¨è®°å½•</title>
    <link href="https://aoayaoa.github.io/2024/09/08/taro/"/>
    <id>https://aoayaoa.github.io/2024/09/08/taro/</id>
    <published>2024-09-07T16:00:00.000Z</published>
    <updated>2025-04-16T04:30:22.713Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Denoå­¦ä¹ è®°å½•-ğŸ“˜"><a href="#Denoå­¦ä¹ è®°å½•-ğŸ“˜" class="headerlink" title="Denoå­¦ä¹ è®°å½• ğŸ“˜"></a>Denoå­¦ä¹ è®°å½• ğŸ“˜</h1><h1 id="ğŸ“±-Taro-å­¦ä¹ æ€»ç»“"><a href="#ğŸ“±-Taro-å­¦ä¹ æ€»ç»“" class="headerlink" title="ğŸ“± Taro å­¦ä¹ æ€»ç»“"></a>ğŸ“± Taro å­¦ä¹ æ€»ç»“</h1><p>Taro æ˜¯ä¸€ä¸ªå¼€æ”¾å¼è·¨ç«¯è·¨æ¡†æ¶è§£å†³æ–¹æ¡ˆï¼ŒåŠ©åŠ›å¼€å‘è€…å¿«é€Ÿæ„å»ºå°ç¨‹åºã€H5å’ŒåŸç”Ÿåº”ç”¨</p><h2 id="ğŸ“‘-ç›®å½•"><a href="#ğŸ“‘-ç›®å½•" class="headerlink" title="ğŸ“‘ ç›®å½•"></a>ğŸ“‘ ç›®å½•</h2><ul><li><a href="#-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5">åŸºç¡€æ¦‚å¿µ</a></li><li><a href="#-%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84">é¡¹ç›®ç»“æ„</a></li><li><a href="#-%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8">åŸºç¡€ä½¿ç”¨</a></li><li><a href="#-%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">å°ç¨‹åºå¼€å‘æ³¨æ„äº‹é¡¹</a></li><li><a href="#-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</a></li><li><a href="#-%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%89%93%E5%8C%85%E4%B8%8E%E5%8F%91%E5%B8%83">å°ç¨‹åºæ‰“åŒ…ä¸å‘å¸ƒ</a></li><li><a href="#-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ</a></li><li><a href="#-%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%89%B9%E6%9C%89%E5%8A%9F%E8%83%BD">å°ç¨‹åºç‰¹æœ‰åŠŸèƒ½</a></li><li><a href="#-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">æœ€ä½³å®è·µ</a></li></ul><hr><h2 id="ğŸ”°-åŸºç¡€æ¦‚å¿µ"><a href="#ğŸ”°-åŸºç¡€æ¦‚å¿µ" class="headerlink" title="ğŸ”° åŸºç¡€æ¦‚å¿µ"></a>ğŸ”° åŸºç¡€æ¦‚å¿µ</h2><p>Taro æ˜¯ä¸€ä¸ªå¼€æ”¾å¼è·¨ç«¯è·¨æ¡†æ¶è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒä½¿ç”¨ React&#x2F;Vue&#x2F;Nerv ç­‰æ¡†æ¶æ¥å¼€å‘å°ç¨‹åºã€H5ã€RN ç­‰åº”ç”¨ã€‚</p><hr><h2 id="ğŸ“‚-é¡¹ç›®ç»“æ„"><a href="#ğŸ“‚-é¡¹ç›®ç»“æ„" class="headerlink" title="ğŸ“‚ é¡¹ç›®ç»“æ„"></a>ğŸ“‚ é¡¹ç›®ç»“æ„</h2><p>ä¸€ä¸ªå…¸å‹çš„ Taro é¡¹ç›®ç»“æ„ï¼š</p><table><thead><tr><th align="left">ç›®å½•&#x2F;æ–‡ä»¶</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">ğŸ“ <code>config/</code></td><td align="left">é¡¹ç›®ç¼–è¯‘é…ç½®ç›®å½•</td></tr><tr><td align="left">ğŸ“ <code>src/</code></td><td align="left">æºç ç›®å½•</td></tr><tr><td align="left">â”œâ”€ ğŸ“„ <code>app.config.ts</code></td><td align="left">å…¨å±€é…ç½®æ–‡ä»¶</td></tr><tr><td align="left">â”œâ”€ ğŸ“„ <code>app.ts</code></td><td align="left">å…¥å£æ–‡ä»¶</td></tr><tr><td align="left">â”œâ”€ ğŸ“„ <code>app.scss</code></td><td align="left">å…¨å±€æ ·å¼æ–‡ä»¶</td></tr><tr><td align="left">â”œâ”€ ğŸ“ <code>pages/</code></td><td align="left">é¡µé¢æ–‡ä»¶ç›®å½•</td></tr><tr><td align="left">â”œâ”€ ğŸ“ <code>components/</code></td><td align="left">ç»„ä»¶ç›®å½•</td></tr><tr><td align="left">â”œâ”€ ğŸ“ <code>assets/</code></td><td align="left">é™æ€èµ„æºç›®å½•</td></tr><tr><td align="left">â”œâ”€ ğŸ“ <code>utils/</code></td><td align="left">å·¥å…·å‡½æ•°ç›®å½•</td></tr><tr><td align="left">â”œâ”€ ğŸ“ <code>stores/</code></td><td align="left">çŠ¶æ€ç®¡ç†ç›®å½•</td></tr><tr><td align="left">â””â”€ ğŸ“ <code>services/</code></td><td align="left">æœåŠ¡æ¥å£ç›®å½•</td></tr></tbody></table><hr><h2 id="ğŸš€-åŸºç¡€ä½¿ç”¨"><a href="#ğŸš€-åŸºç¡€ä½¿ç”¨" class="headerlink" title="ğŸš€ åŸºç¡€ä½¿ç”¨"></a>ğŸš€ åŸºç¡€ä½¿ç”¨</h2><h3 id="1ï¸âƒ£-é¡¹ç›®åˆ›å»ºå’Œå¯åŠ¨"><a href="#1ï¸âƒ£-é¡¹ç›®åˆ›å»ºå’Œå¯åŠ¨" class="headerlink" title="1ï¸âƒ£ é¡¹ç›®åˆ›å»ºå’Œå¯åŠ¨"></a>1ï¸âƒ£ é¡¹ç›®åˆ›å»ºå’Œå¯åŠ¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… Taro CLI</span></span><br><span class="line">npm install -g @tarojs/cli</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºé¡¹ç›®</span></span><br><span class="line">taro init myApp</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å‘å¾®ä¿¡å°ç¨‹åº</span></span><br><span class="line">npm run dev:weapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“åŒ…å¾®ä¿¡å°ç¨‹åº</span></span><br><span class="line">npm run build:weapp</span><br></pre></td></tr></table></figure><h3 id="2ï¸âƒ£-é…ç½®æ–‡ä»¶"><a href="#2ï¸âƒ£-é…ç½®æ–‡ä»¶" class="headerlink" title="2ï¸âƒ£ é…ç½®æ–‡ä»¶"></a>2ï¸âƒ£ é…ç½®æ–‡ä»¶</h3><p><code>app.config.ts</code> ç”¨äºé¡¹ç›®å…¨å±€é…ç½®ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// é¡µé¢è·¯å¾„åˆ—è¡¨</span></span><br><span class="line">  <span class="attr">pages</span>: [</span><br><span class="line">    <span class="string">&#x27;pages/home/index&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;pages/mine/index&#x27;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="comment">// å…¨å±€çª—å£é…ç½®</span></span><br><span class="line">  <span class="attr">window</span>: &#123;</span><br><span class="line">    <span class="attr">backgroundTextStyle</span>: <span class="string">&#x27;light&#x27;</span>,</span><br><span class="line">    <span class="attr">navigationBarBackgroundColor</span>: <span class="string">&#x27;#fff&#x27;</span>,</span><br><span class="line">    <span class="attr">navigationBarTitleText</span>: <span class="string">&#x27;WeChat&#x27;</span>,</span><br><span class="line">    <span class="attr">navigationBarTextStyle</span>: <span class="string">&#x27;black&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// åº•éƒ¨ TabBar é…ç½®</span></span><br><span class="line">  <span class="attr">tabBar</span>: &#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&#x27;#999&#x27;</span>,</span><br><span class="line">    <span class="attr">selectedColor</span>: <span class="string">&#x27;#dc2743&#x27;</span>,</span><br><span class="line">    <span class="attr">backgroundColor</span>: <span class="string">&#x27;#fff&#x27;</span>,</span><br><span class="line">    <span class="attr">list</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">pagePath</span>: <span class="string">&#x27;pages/home/index&#x27;</span>,</span><br><span class="line">        <span class="attr">text</span>: <span class="string">&#x27;é¦–é¡µ&#x27;</span>,</span><br><span class="line">        <span class="attr">iconPath</span>: <span class="string">&#x27;./assets/images/home.png&#x27;</span>,</span><br><span class="line">        <span class="attr">selectedIconPath</span>: <span class="string">&#x27;./assets/images/home-active.png&#x27;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">pagePath</span>: <span class="string">&#x27;pages/mine/index&#x27;</span>,</span><br><span class="line">        <span class="attr">text</span>: <span class="string">&#x27;æˆ‘çš„&#x27;</span>,</span><br><span class="line">        <span class="attr">iconPath</span>: <span class="string">&#x27;./assets/images/mine.png&#x27;</span>,</span><br><span class="line">        <span class="attr">selectedIconPath</span>: <span class="string">&#x27;./assets/images/mine-active.png&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3ï¸âƒ£-åº”ç”¨å…¥å£"><a href="#3ï¸âƒ£-åº”ç”¨å…¥å£" class="headerlink" title="3ï¸âƒ£ åº”ç”¨å…¥å£"></a>3ï¸âƒ£ åº”ç”¨å…¥å£</h3><p><code>app.ts</code> æ˜¯åº”ç”¨å…¥å£æ–‡ä»¶ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; createPinia &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./app.scss&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºåº”ç”¨å®ä¾‹</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">App</span> = <span class="title function_">createApp</span>(&#123;</span><br><span class="line">  <span class="title function_">onLaunch</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// åº”ç”¨å¯åŠ¨æ—¶è§¦å‘</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;App launched&#x27;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">onShow</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="comment">// åº”ç”¨æ˜¾ç¤ºæ—¶è§¦å‘</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;App shown&#x27;</span>, options)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨çŠ¶æ€ç®¡ç†</span></span><br><span class="line"><span class="keyword">const</span> pinia = <span class="title function_">createPinia</span>()</span><br><span class="line"><span class="title class_">App</span>.<span class="title function_">use</span>(pinia)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span></span><br></pre></td></tr></table></figure><h3 id="4ï¸âƒ£-é¡µé¢å¼€å‘"><a href="#4ï¸âƒ£-é¡µé¢å¼€å‘" class="headerlink" title="4ï¸âƒ£ é¡µé¢å¼€å‘"></a>4ï¸âƒ£ é¡µé¢å¼€å‘</h3><p>æ¯ä¸ªé¡µé¢é€šå¸¸åŒ…å«ä¸‰ä¸ªæ–‡ä»¶ï¼š</p><ul><li><code>index.vue</code> - é¡µé¢ç»„ä»¶</li><li><code>index.scss</code> - é¡µé¢æ ·å¼</li><li><code>index.config.ts</code> - é¡µé¢é…ç½®</li></ul><p><strong>é¡µé¢ç»„ä»¶ç¤ºä¾‹ï¼ˆVue3ï¼‰ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;view class=&quot;page&quot;&gt;</span><br><span class="line">    &lt;text&gt;&#123;&#123; message &#125;&#125;&lt;/text&gt;</span><br><span class="line">    &lt;button @tap=&quot;handleClick&quot;&gt;ç‚¹å‡»æˆ‘&lt;/button&gt;</span><br><span class="line">  &lt;/view&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref &#125; from &#x27;vue&#x27;</span><br><span class="line">import Taro from &#x27;@tarojs/taro&#x27;</span><br><span class="line"></span><br><span class="line">const message = ref(&#x27;Hello World&#x27;)</span><br><span class="line"></span><br><span class="line">const handleClick = () =&gt; &#123;</span><br><span class="line">  Taro.showToast(&#123;</span><br><span class="line">    title: &#x27;ç‚¹å‡»æˆåŠŸ&#x27;,</span><br><span class="line">    icon: &#x27;success&#x27;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;scss&quot;&gt;</span><br><span class="line">.page &#123;</span><br><span class="line">  padding: 20px;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure><p><strong>é¡µé¢é…ç½®ç¤ºä¾‹ï¼š</strong></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">navigationBarTitleText</span>: <span class="string">&#x27;é¡µé¢æ ‡é¢˜&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="âš ï¸-å°ç¨‹åºå¼€å‘æ³¨æ„äº‹é¡¹"><a href="#âš ï¸-å°ç¨‹åºå¼€å‘æ³¨æ„äº‹é¡¹" class="headerlink" title="âš ï¸ å°ç¨‹åºå¼€å‘æ³¨æ„äº‹é¡¹"></a>âš ï¸ å°ç¨‹åºå¼€å‘æ³¨æ„äº‹é¡¹</h2><h3 id="ğŸ“Œ-ç”Ÿå‘½å‘¨æœŸ"><a href="#ğŸ“Œ-ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="ğŸ“Œ ç”Ÿå‘½å‘¨æœŸ"></a>ğŸ“Œ ç”Ÿå‘½å‘¨æœŸ</h3><h4 id="Taro-æ¡†æ¶ç”Ÿå‘½å‘¨æœŸï¼š"><a href="#Taro-æ¡†æ¶ç”Ÿå‘½å‘¨æœŸï¼š" class="headerlink" title="Taro æ¡†æ¶ç”Ÿå‘½å‘¨æœŸï¼š"></a>Taro æ¡†æ¶ç”Ÿå‘½å‘¨æœŸï¼š</h4><table><thead><tr><th align="left">ç”Ÿå‘½å‘¨æœŸ</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">ğŸ”„ <code>onLaunch</code></td><td align="left">åº”ç”¨åˆå§‹åŒ–</td></tr><tr><td align="left">ğŸ‘ï¸ <code>onShow</code></td><td align="left">åº”ç”¨æ˜¾ç¤º</td></tr><tr><td align="left">ğŸ™ˆ <code>onHide</code></td><td align="left">åº”ç”¨éšè—</td></tr><tr><td align="left">âŒ <code>onError</code></td><td align="left">åº”ç”¨å‘ç”Ÿé”™è¯¯</td></tr></tbody></table><h4 id="é¡µé¢ç”Ÿå‘½å‘¨æœŸï¼š"><a href="#é¡µé¢ç”Ÿå‘½å‘¨æœŸï¼š" class="headerlink" title="é¡µé¢ç”Ÿå‘½å‘¨æœŸï¼š"></a>é¡µé¢ç”Ÿå‘½å‘¨æœŸï¼š</h4><table><thead><tr><th align="left">ç”Ÿå‘½å‘¨æœŸ</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">ğŸ“¥ <code>onLoad</code></td><td align="left">é¡µé¢åŠ è½½</td></tr><tr><td align="left">âœ… <code>onReady</code></td><td align="left">é¡µé¢åˆæ¬¡æ¸²æŸ“å®Œæˆ</td></tr><tr><td align="left">ğŸ‘ï¸ <code>onShow</code></td><td align="left">é¡µé¢æ˜¾ç¤º</td></tr><tr><td align="left">ğŸ™ˆ <code>onHide</code></td><td align="left">é¡µé¢éšè—</td></tr><tr><td align="left">ğŸ“¤ <code>onUnload</code></td><td align="left">é¡µé¢å¸è½½</td></tr><tr><td align="left">â¬‡ï¸ <code>onPullDownRefresh</code></td><td align="left">ä¸‹æ‹‰åˆ·æ–°</td></tr><tr><td align="left">â¬†ï¸ <code>onReachBottom</code></td><td align="left">ä¸Šæ‹‰è§¦åº•</td></tr><tr><td align="left">ğŸ“œ <code>onPageScroll</code></td><td align="left">é¡µé¢æ»šåŠ¨</td></tr><tr><td align="left">ğŸ“¤ <code>onShareAppMessage</code></td><td align="left">ç”¨æˆ·ç‚¹å‡»å³ä¸Šè§’åˆ†äº«</td></tr></tbody></table><h4 id="ç»„åˆå¼-API-ä¸­ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸï¼š"><a href="#ç»„åˆå¼-API-ä¸­ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸï¼š" class="headerlink" title="ç»„åˆå¼ API ä¸­ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸï¼š"></a>ç»„åˆå¼ API ä¸­ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸï¼š</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; onMounted, onUnmounted &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; useDidShow, useDidHide &#125; <span class="keyword">from</span> <span class="string">&#x27;@tarojs/taro&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Vue ç”Ÿå‘½å‘¨æœŸ</span></span><br><span class="line"><span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç»„ä»¶æŒ‚è½½&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">onUnmounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç»„ä»¶å¸è½½&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Taro é¡µé¢ç”Ÿå‘½å‘¨æœŸ</span></span><br><span class="line"><span class="title function_">useDidShow</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;é¡µé¢æ˜¾ç¤º&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">useDidHide</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;é¡µé¢éšè—&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="ğŸ“Œ-è·¯ç”±ä¸å¯¼èˆª"><a href="#ğŸ“Œ-è·¯ç”±ä¸å¯¼èˆª" class="headerlink" title="ğŸ“Œ è·¯ç”±ä¸å¯¼èˆª"></a>ğŸ“Œ è·¯ç”±ä¸å¯¼èˆª</h3><p>Taro å¯¼èˆª APIï¼š</p><table><thead><tr><th align="left">API</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">ğŸ”€ <code>Taro.navigateTo</code></td><td align="left">ä¿ç•™å½“å‰é¡µé¢ï¼Œè·³è½¬åˆ°åº”ç”¨å†…çš„æŸä¸ªé¡µé¢</td></tr><tr><td align="left">ğŸ”„ <code>Taro.redirectTo</code></td><td align="left">å…³é—­å½“å‰é¡µé¢ï¼Œè·³è½¬åˆ°åº”ç”¨å†…çš„æŸä¸ªé¡µé¢</td></tr><tr><td align="left">ğŸ“‘ <code>Taro.switchTab</code></td><td align="left">è·³è½¬åˆ° tabBar é¡µé¢ï¼Œå¹¶å…³é—­å…¶ä»–æ‰€æœ‰é tabBar é¡µé¢</td></tr><tr><td align="left">â—€ï¸ <code>Taro.navigateBack</code></td><td align="left">å…³é—­å½“å‰é¡µé¢ï¼Œè¿”å›ä¸Šä¸€é¡µé¢æˆ–å¤šçº§é¡µé¢</td></tr><tr><td align="left">ğŸ”ƒ <code>Taro.reLaunch</code></td><td align="left">å…³é—­æ‰€æœ‰é¡µé¢ï¼Œæ‰“å¼€åˆ°åº”ç”¨å†…çš„æŸä¸ªé¡µé¢</td></tr></tbody></table><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¤ºä¾‹ç”¨æ³•</span></span><br><span class="line"><span class="title class_">Taro</span>.<span class="title function_">navigateTo</span>(&#123;</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;/pages/detail/index?id=123&#x27;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="ğŸ“Œ-çŠ¶æ€ç®¡ç†"><a href="#ğŸ“Œ-çŠ¶æ€ç®¡ç†" class="headerlink" title="ğŸ“Œ çŠ¶æ€ç®¡ç†"></a>ğŸ“Œ çŠ¶æ€ç®¡ç†</h3><p><strong>Pinia (Vue3)ï¼š</strong></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»º store</span></span><br><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useCounterStore = <span class="title function_">defineStore</span>(<span class="string">&#x27;counter&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">state</span>: <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">count</span>: <span class="number">0</span></span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    <span class="title function_">increment</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">count</span>++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ store</span></span><br><span class="line"><span class="keyword">import</span> &#123; useCounterStore &#125; <span class="keyword">from</span> <span class="string">&#x27;../stores/counter&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> counterStore = <span class="title function_">useCounterStore</span>()</span><br><span class="line">counterStore.<span class="title function_">increment</span>()</span><br></pre></td></tr></table></figure><h3 id="ğŸ“Œ-æ•°æ®å­˜å‚¨"><a href="#ğŸ“Œ-æ•°æ®å­˜å‚¨" class="headerlink" title="ğŸ“Œ æ•°æ®å­˜å‚¨"></a>ğŸ“Œ æ•°æ®å­˜å‚¨</h3><p>å°ç¨‹åºæ•°æ®å­˜å‚¨ APIï¼š</p><table><thead><tr><th align="left">API</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">ğŸ’¾ <code>Taro.setStorage</code></td><td align="left">å¼‚æ­¥å­˜å‚¨æ•°æ®</td></tr><tr><td align="left">ğŸ’¾ <code>Taro.setStorageSync</code></td><td align="left">åŒæ­¥å­˜å‚¨æ•°æ®</td></tr><tr><td align="left">ğŸ“‚ <code>Taro.getStorage</code></td><td align="left">å¼‚æ­¥è·å–æ•°æ®</td></tr><tr><td align="left">ğŸ“‚ <code>Taro.getStorageSync</code></td><td align="left">åŒæ­¥è·å–æ•°æ®</td></tr><tr><td align="left">ğŸ—‘ï¸ <code>Taro.removeStorage</code></td><td align="left">å¼‚æ­¥ç§»é™¤æ•°æ®</td></tr><tr><td align="left">ğŸ—‘ï¸ <code>Taro.removeStorageSync</code></td><td align="left">åŒæ­¥ç§»é™¤æ•°æ®</td></tr><tr><td align="left">ğŸ§¹ <code>Taro.clearStorage</code></td><td align="left">æ¸…é™¤æ‰€æœ‰æ•°æ®</td></tr></tbody></table><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¤ºä¾‹ç”¨æ³•</span></span><br><span class="line"><span class="title class_">Taro</span>.<span class="title function_">setStorageSync</span>(<span class="string">&#x27;token&#x27;</span>, <span class="string">&#x27;abc123&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> token = <span class="title class_">Taro</span>.<span class="title function_">getStorageSync</span>(<span class="string">&#x27;token&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="ğŸ“Œ-ç½‘ç»œè¯·æ±‚"><a href="#ğŸ“Œ-ç½‘ç»œè¯·æ±‚" class="headerlink" title="ğŸ“Œ ç½‘ç»œè¯·æ±‚"></a>ğŸ“Œ ç½‘ç»œè¯·æ±‚</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸºæœ¬ç”¨æ³•</span></span><br><span class="line"><span class="title class_">Taro</span>.<span class="title function_">request</span>(&#123;</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;https://api.example.com/data&#x27;</span>,</span><br><span class="line">  <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">  <span class="attr">data</span>: &#123; <span class="attr">id</span>: <span class="number">123</span> &#125;,</span><br><span class="line">  <span class="attr">header</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">&#x27;Bearer token&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">success</span>: <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;è¯·æ±‚æˆåŠŸï¼š&#x27;</span>, res.<span class="property">data</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">fail</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;è¯·æ±‚å¤±è´¥ï¼š&#x27;</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Promise ç”¨æ³•</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">Taro</span>.<span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;https://api.example.com/data&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;è¯·æ±‚æˆåŠŸï¼š&#x27;</span>, res.<span class="property">data</span>)</span><br><span class="line">&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;è¯·æ±‚å¤±è´¥ï¼š&#x27;</span>, err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ğŸ“Œ-UI-ç»„ä»¶ä½¿ç”¨"><a href="#ğŸ“Œ-UI-ç»„ä»¶ä½¿ç”¨" class="headerlink" title="ğŸ“Œ UI ç»„ä»¶ä½¿ç”¨"></a>ğŸ“Œ UI ç»„ä»¶ä½¿ç”¨</h3><p>Taro å†…ç½®åŸºç¡€ç»„ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;view class=&quot;container&quot;&gt;</span><br><span class="line">    &lt;!-- æ–‡æœ¬ --&gt;</span><br><span class="line">    &lt;text&gt;æ–‡æœ¬å†…å®¹&lt;/text&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!-- æŒ‰é’® --&gt;</span><br><span class="line">    &lt;button type=&quot;primary&quot; @tap=&quot;handleClick&quot;&gt;æŒ‰é’®&lt;/button&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!-- å›¾ç‰‡ --&gt;</span><br><span class="line">    &lt;image src=&quot;/assets/logo.png&quot; mode=&quot;aspectFit&quot; /&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!-- æ»šåŠ¨è§†å›¾ --&gt;</span><br><span class="line">    &lt;scroll-view scroll-y style=&quot;height: 300px&quot;&gt;</span><br><span class="line">      &lt;view v-for=&quot;item in list&quot; :key=&quot;item.id&quot;&gt;&#123;&#123; item.name &#125;&#125;&lt;/view&gt;</span><br><span class="line">    &lt;/scroll-view&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!-- è¡¨å•ç»„ä»¶ --&gt;</span><br><span class="line">    &lt;input type=&quot;text&quot; v-model=&quot;inputValue&quot; placeholder=&quot;è¯·è¾“å…¥&quot; /&gt;</span><br><span class="line">  &lt;/view&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure><h3 id="ğŸ“Œ-å°ç¨‹åºåˆ†äº«åŠŸèƒ½"><a href="#ğŸ“Œ-å°ç¨‹åºåˆ†äº«åŠŸèƒ½" class="headerlink" title="ğŸ“Œ å°ç¨‹åºåˆ†äº«åŠŸèƒ½"></a>ğŸ“Œ å°ç¨‹åºåˆ†äº«åŠŸèƒ½</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é¡µé¢å†…è®¾ç½®åˆ†äº«</span></span><br><span class="line"><span class="title class_">Taro</span>.<span class="title function_">useShareAppMessage</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;åˆ†äº«æ ‡é¢˜&#x27;</span>,</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/pages/home/index?share=true&#x27;</span>,</span><br><span class="line">    <span class="attr">imageUrl</span>: <span class="string">&#x27;/assets/share.png&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ†äº«åˆ°æœ‹å‹åœˆ</span></span><br><span class="line"><span class="title class_">Taro</span>.<span class="title function_">useShareTimeline</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;åˆ†äº«åˆ°æœ‹å‹åœˆçš„æ ‡é¢˜&#x27;</span>,</span><br><span class="line">    <span class="attr">query</span>: <span class="string">&#x27;share=true&#x27;</span>,</span><br><span class="line">    <span class="attr">imageUrl</span>: <span class="string">&#x27;/assets/share.png&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><hr><h2 id="ğŸš«-æ˜“é”™ç‚¹ä¸å¼€å‘é™·é˜±"><a href="#ğŸš«-æ˜“é”™ç‚¹ä¸å¼€å‘é™·é˜±" class="headerlink" title="ğŸš« æ˜“é”™ç‚¹ä¸å¼€å‘é™·é˜±"></a>ğŸš« æ˜“é”™ç‚¹ä¸å¼€å‘é™·é˜±</h2><h3 id="â›”-ç”Ÿå‘½å‘¨æœŸä½¿ç”¨é”™è¯¯"><a href="#â›”-ç”Ÿå‘½å‘¨æœŸä½¿ç”¨é”™è¯¯" class="headerlink" title="â›” ç”Ÿå‘½å‘¨æœŸä½¿ç”¨é”™è¯¯"></a>â›” ç”Ÿå‘½å‘¨æœŸä½¿ç”¨é”™è¯¯</h3><blockquote><p>âŒ <strong>ä¸è¦åœ¨ <code>onLoad</code> ä¸­ä½¿ç”¨ <code>useState</code> ç­‰ hooks</strong><br>åº”åœ¨å‡½æ•°ç»„ä»¶é¡¶å±‚ä½¿ç”¨</p></blockquote><blockquote><p>âŒ <strong>ä¸è¦åœ¨ <code>onLoad</code> ä¸­ç›´æ¥ä¿®æ”¹ data</strong><br>å¯èƒ½å¯¼è‡´è§†å›¾ä¸æ›´æ–°</p></blockquote><blockquote><p>âŒ <strong>ä¸è¦åœ¨å°ç¨‹åº App çš„ <code>onLaunch</code> é‡Œè°ƒç”¨é¡µé¢è·³è½¬ç›¸å…³çš„ API</strong></p></blockquote><h3 id="â›”-JSX-æ¨¡æ¿è¯­æ³•å·®å¼‚"><a href="#â›”-JSX-æ¨¡æ¿è¯­æ³•å·®å¼‚" class="headerlink" title="â›” JSX&#x2F;æ¨¡æ¿è¯­æ³•å·®å¼‚"></a>â›” JSX&#x2F;æ¨¡æ¿è¯­æ³•å·®å¼‚</h3><p>æ¡ä»¶æ¸²æŸ“ï¼šå°ç¨‹åºä¸æ”¯æŒ <code>&amp;&amp;</code> çŸ­è·¯è¿ç®—ç¬¦æ¡ä»¶æ¸²æŸ“ï¼Œåº”ä½¿ç”¨ä¸‰å…ƒè¿ç®—ç¬¦</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* âŒ é”™è¯¯ */</span></span><br><span class="line">&#123; isShow &amp;&amp; <span class="language-xml"><span class="tag">&lt;<span class="name">View</span>&gt;</span>å†…å®¹<span class="tag">&lt;/<span class="name">View</span>&gt;</span></span> &#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">/* âœ… æ­£ç¡® */</span></span><br><span class="line">&#123; isShow ? <span class="language-xml"><span class="tag">&lt;<span class="name">View</span>&gt;</span>å†…å®¹<span class="tag">&lt;/<span class="name">View</span>&gt;</span></span> : <span class="literal">null</span> &#125;</span><br></pre></td></tr></table></figure><h3 id="â›”-äº‹ä»¶å¤„ç†"><a href="#â›”-äº‹ä»¶å¤„ç†" class="headerlink" title="â›” äº‹ä»¶å¤„ç†"></a>â›” äº‹ä»¶å¤„ç†</h3><blockquote><p>âœ… <strong>äº‹ä»¶åç§°ä½¿ç”¨å°é©¼å³°</strong>ï¼ˆonTapï¼‰ï¼Œè€ŒéåŸç”Ÿå°ç¨‹åºçš„è¿å­—ç¬¦å†™æ³•ï¼ˆbind:tapï¼‰<br>âœ… <strong>é˜»æ­¢äº‹ä»¶å†’æ³¡éœ€ä½¿ç”¨ <code>stopPropagation</code></strong>ï¼Œè€Œé <code>return false</code></p></blockquote><h3 id="â›”-æ ·å¼é—®é¢˜"><a href="#â›”-æ ·å¼é—®é¢˜" class="headerlink" title="â›” æ ·å¼é—®é¢˜"></a>â›” æ ·å¼é—®é¢˜</h3><blockquote><p>âŒ <strong>é€‰æ‹©å™¨é”™è¯¯</strong>ï¼šå°ç¨‹åºä¸æ”¯æŒæ‰€æœ‰ CSS é€‰æ‹©å™¨ï¼ˆå¦‚ä¸€äº›ä¼ªç±»é€‰æ‹©å™¨ï¼‰<br>âš ï¸ <strong>æ ·å¼éš”ç¦»</strong>ï¼šé¡µé¢æ ·å¼ä¼šå½±å“åˆ°ç»„ä»¶ï¼Œéœ€æ³¨æ„ä½œç”¨åŸŸ<br>âš ï¸ <strong>rpx è®¡ç®—</strong>ï¼šè®¾è®¡ç¨¿å°ºå¯¸é 750px æ—¶ï¼Œéœ€è¦åšç­‰æ¯”ä¾‹æ¢ç®—</p></blockquote><h3 id="â›”-API-ä½¿ç”¨è¯¯åŒº"><a href="#â›”-API-ä½¿ç”¨è¯¯åŒº" class="headerlink" title="â›” API ä½¿ç”¨è¯¯åŒº"></a>â›” API ä½¿ç”¨è¯¯åŒº</h3><blockquote><p>âš ï¸ <code>Taro.navigateTo</code> æœ€å¤šåªèƒ½æ‰“å¼€ 10 å±‚é¡µé¢<br>âš ï¸ <code>Taro.setStorage</code> å­˜å‚¨çš„æ•°æ®ä¸èƒ½è¶…è¿‡ 10MB<br>âš ï¸ å¾®ä¿¡å°ç¨‹åºå•ä¸ªé¡µé¢çš„é€»è¾‘å±‚åˆå§‹åŒ–è€—æ—¶ä¸èƒ½è¶…è¿‡ 20s</p></blockquote><hr><h2 id="ğŸ› ï¸-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ"><a href="#ğŸ› ï¸-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ" class="headerlink" title="ğŸ› ï¸ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ"></a>ğŸ› ï¸ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</h2><h3 id="ğŸ¨-æ ·å¼é—®é¢˜"><a href="#ğŸ¨-æ ·å¼é—®é¢˜" class="headerlink" title="ğŸ¨ æ ·å¼é—®é¢˜"></a>ğŸ¨ æ ·å¼é—®é¢˜</h3><ul><li>Taro ä¸­ä½¿ç”¨ <code>px</code> å•ä½ä¼šè‡ªåŠ¨è½¬æ¢ä¸ºå°ç¨‹åºçš„ <code>rpx</code></li><li>å¦‚éœ€ä½¿ç”¨åŸç”Ÿå•ä½ï¼Œå¯ä½¿ç”¨ <code>Px</code> æˆ– <code>PX</code></li><li>æ¨èä½¿ç”¨ SCSS&#x2F;SASS é¢„å¤„ç†å™¨</li></ul><h3 id="ğŸ”„-å¹³å°å·®å¼‚å¤„ç†"><a href="#ğŸ”„-å¹³å°å·®å¼‚å¤„ç†" class="headerlink" title="ğŸ”„ å¹³å°å·®å¼‚å¤„ç†"></a>ğŸ”„ å¹³å°å·®å¼‚å¤„ç†</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Taro</span> <span class="keyword">from</span> <span class="string">&#x27;@tarojs/taro&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å½“å‰ç¯å¢ƒ</span></span><br><span class="line"><span class="keyword">const</span> env = <span class="title class_">Taro</span>.<span class="title function_">getEnv</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ¤æ–­å¹³å°</span></span><br><span class="line"><span class="keyword">if</span> (env === <span class="title class_">Taro</span>.<span class="property">ENV_TYPE</span>.<span class="property">WEAPP</span>) &#123;</span><br><span class="line">  <span class="comment">// å¾®ä¿¡å°ç¨‹åºç¯å¢ƒ</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å½“å‰æ˜¯å¾®ä¿¡å°ç¨‹åºç¯å¢ƒ&#x27;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (env === <span class="title class_">Taro</span>.<span class="property">ENV_TYPE</span>.<span class="property">ALIPAY</span>) &#123;</span><br><span class="line">  <span class="comment">// æ”¯ä»˜å®å°ç¨‹åºç¯å¢ƒ</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å½“å‰æ˜¯æ”¯ä»˜å®å°ç¨‹åºç¯å¢ƒ&#x27;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (env === <span class="title class_">Taro</span>.<span class="property">ENV_TYPE</span>.<span class="property">H5</span>) &#123;</span><br><span class="line">  <span class="comment">// H5ç¯å¢ƒ</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å½“å‰æ˜¯H5ç¯å¢ƒ&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="âš¡-æ€§èƒ½ä¼˜åŒ–"><a href="#âš¡-æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="âš¡ æ€§èƒ½ä¼˜åŒ–"></a>âš¡ æ€§èƒ½ä¼˜åŒ–</h3><ul><li>é¿å…é¢‘ç¹çš„æ•°æ®æ›´æ–°å¯¼è‡´ä¸å¿…è¦çš„æ¸²æŸ“</li><li>åˆ—è¡¨ç»„ä»¶ä½¿ç”¨å”¯ä¸€ä¸”ç¨³å®šçš„ key</li><li>åˆç†ä½¿ç”¨ç¼“å­˜æœºåˆ¶</li><li>æŒ‰éœ€åŠ è½½èµ„æº</li></ul><h3 id="â³-å¼‚æ­¥-API-çš„å¤„ç†"><a href="#â³-å¼‚æ­¥-API-çš„å¤„ç†" class="headerlink" title="â³ å¼‚æ­¥ API çš„å¤„ç†"></a>â³ å¼‚æ­¥ API çš„å¤„ç†</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Promise åŒ–</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">Taro</span>.<span class="title function_">showModal</span>(&#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;æç¤º&#x27;</span>,</span><br><span class="line">    <span class="attr">content</span>: <span class="string">&#x27;ç¡®è®¤åˆ é™¤ï¼Ÿ&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">if</span> (res.<span class="property">confirm</span>) &#123;</span><br><span class="line">    <span class="comment">// ç”¨æˆ·ç‚¹å‡»ç¡®å®š</span></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">deleteItem</span>()</span><br><span class="line">    <span class="title class_">Taro</span>.<span class="title function_">showToast</span>(&#123; <span class="attr">title</span>: <span class="string">&#x27;åˆ é™¤æˆåŠŸ&#x27;</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;æ“ä½œå¤±è´¥&#x27;</span>, error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="ğŸ“¦-å°ç¨‹åºæ‰“åŒ…ä¸å‘å¸ƒ"><a href="#ğŸ“¦-å°ç¨‹åºæ‰“åŒ…ä¸å‘å¸ƒ" class="headerlink" title="ğŸ“¦ å°ç¨‹åºæ‰“åŒ…ä¸å‘å¸ƒ"></a>ğŸ“¦ å°ç¨‹åºæ‰“åŒ…ä¸å‘å¸ƒ</h2><h3 id="ğŸ“±-åˆ†åŒ…é…ç½®"><a href="#ğŸ“±-åˆ†åŒ…é…ç½®" class="headerlink" title="ğŸ“± åˆ†åŒ…é…ç½®"></a>ğŸ“± åˆ†åŒ…é…ç½®</h3><blockquote><p>å°ç¨‹åºæœ‰ä½“ç§¯é™åˆ¶ï¼Œä¸»åŒ…æœ€å¤§ 2MBï¼Œå•ä¸ªåˆ†åŒ…æœ€å¤§ 2MBï¼Œæ€»ä½“ç§¯ä¸è¶…è¿‡ 20MB</p></blockquote><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.config.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">pages</span>: [</span><br><span class="line">    <span class="string">&#x27;pages/index/index&#x27;</span>, <span class="comment">// ä¸»åŒ…é¡µé¢</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">subPackages</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">root</span>: <span class="string">&#x27;packageA&#x27;</span>, <span class="comment">// åˆ†åŒ…æ ¹ç›®å½•</span></span><br><span class="line">      <span class="attr">pages</span>: [</span><br><span class="line">        <span class="string">&#x27;pages/detail/index&#x27;</span>, <span class="comment">// å®é™…è·¯å¾„: packageA/pages/detail/index</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">root</span>: <span class="string">&#x27;packageB&#x27;</span>,</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;pack2&#x27;</span>, <span class="comment">// åˆ†åŒ…åˆ«åï¼Œå¯é€‰</span></span><br><span class="line">      <span class="attr">pages</span>: [</span><br><span class="line">        <span class="string">&#x27;pages/list/index&#x27;</span>,</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ğŸ“Š-åˆ†åŒ…ä¼˜åŒ–ç­–ç•¥"><a href="#ğŸ“Š-åˆ†åŒ…ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="ğŸ“Š åˆ†åŒ…ä¼˜åŒ–ç­–ç•¥"></a>ğŸ“Š åˆ†åŒ…ä¼˜åŒ–ç­–ç•¥</h3><table><thead><tr><th align="left">ç­–ç•¥</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">ğŸ“‹ <strong>æŒ‰åŠŸèƒ½æ‹†åˆ†</strong></td><td align="left">å°†åŠŸèƒ½ç›¸è¿‘çš„é¡µé¢æ”¾å…¥åŒä¸€åˆ†åŒ…</td></tr><tr><td align="left">ğŸ”„ <strong>æŒ‰è®¿é—®é¢‘ç‡æ‹†åˆ†</strong></td><td align="left">é«˜é¢‘é¡µé¢æ”¾ä¸»åŒ…ï¼Œä½é¢‘é¡µé¢æ”¾åˆ†åŒ…</td></tr><tr><td align="left">ğŸ”— <strong>å…¬å…±èµ„æºå¤„ç†</strong></td><td align="left">é…ç½®é¢„åŠ è½½è§„åˆ™æé«˜ä½“éªŒ</td></tr></tbody></table><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.config.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">preloadRule</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;pages/index/index&#x27;</span>: &#123; <span class="comment">// é¡µé¢è·¯å¾„</span></span><br><span class="line">      <span class="attr">network</span>: <span class="string">&#x27;all&#x27;</span>, <span class="comment">// åœ¨æŒ‡å®šç½‘ç»œä¸‹é¢„ä¸‹è½½ï¼Œallè¡¨ç¤ºä¸é™ç½‘ç»œ</span></span><br><span class="line">      <span class="attr">packages</span>: [<span class="string">&#x27;packageA&#x27;</span>] <span class="comment">// è¿›å…¥é¡µé¢åé¢„ä¸‹è½½åˆ†åŒ…</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ğŸï¸-ç‹¬ç«‹åˆ†åŒ…"><a href="#ğŸï¸-ç‹¬ç«‹åˆ†åŒ…" class="headerlink" title="ğŸï¸ ç‹¬ç«‹åˆ†åŒ…"></a>ğŸï¸ ç‹¬ç«‹åˆ†åŒ…</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.config.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">subPackages</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">root</span>: <span class="string">&#x27;independentPackage&#x27;</span>,</span><br><span class="line">      <span class="attr">pages</span>: [</span><br><span class="line">        <span class="string">&#x27;pages/independent/index&#x27;</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">independent</span>: <span class="literal">true</span> <span class="comment">// è®¾ç½®ä¸ºç‹¬ç«‹åˆ†åŒ…</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç‹¬ç«‹åˆ†åŒ…ç‰¹ç‚¹ï¼š</strong></p><ul><li>âœ… ä¸ä¾èµ–ä¸»åŒ…å³å¯è¿è¡Œ</li><li>âœ… é€‚åˆå¹¿å‘Šé¡µã€æ´»åŠ¨é¡µç­‰ä¸´æ—¶é¡µé¢</li><li>âœ… å¯å‡å°‘å¯åŠ¨æ—¶åŠ è½½æ—¶é—´</li></ul><h3 id="ğŸ”„-åˆ†åŒ…é¢„åŠ è½½"><a href="#ğŸ”„-åˆ†åŒ…é¢„åŠ è½½" class="headerlink" title="ğŸ”„ åˆ†åŒ…é¢„åŠ è½½"></a>ğŸ”„ åˆ†åŒ…é¢„åŠ è½½</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.config.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">preloadRule</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;pages/index/index&#x27;</span>: &#123;</span><br><span class="line">      <span class="attr">network</span>: <span class="string">&#x27;all&#x27;</span>,</span><br><span class="line">      <span class="attr">packages</span>: [<span class="string">&#x27;packageA&#x27;</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;packageA/pages/detail/index&#x27;</span>: &#123;</span><br><span class="line">      <span class="attr">network</span>: <span class="string">&#x27;wifi&#x27;</span>, <span class="comment">// ä»…åœ¨WiFiç¯å¢ƒä¸‹é¢„åŠ è½½</span></span><br><span class="line">      <span class="attr">packages</span>: [<span class="string">&#x27;packageB&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ğŸ“‰-åŒ…ä½“ç§¯ä¼˜åŒ–"><a href="#ğŸ“‰-åŒ…ä½“ç§¯ä¼˜åŒ–" class="headerlink" title="ğŸ“‰ åŒ…ä½“ç§¯ä¼˜åŒ–"></a>ğŸ“‰ åŒ…ä½“ç§¯ä¼˜åŒ–</h3><h4 id="ğŸ—œï¸-ä»£ç å‹ç¼©"><a href="#ğŸ—œï¸-ä»£ç å‹ç¼©" class="headerlink" title="ğŸ—œï¸ ä»£ç å‹ç¼©"></a>ğŸ—œï¸ ä»£ç å‹ç¼©</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config/index.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">mini</span>: &#123;</span><br><span class="line">    <span class="comment">// å‹ç¼©é…ç½®</span></span><br><span class="line">    <span class="attr">optimizeMainPackage</span>: &#123;</span><br><span class="line">      <span class="attr">enable</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// æ··æ·†é…ç½®</span></span><br><span class="line">    <span class="title function_">webpackChain</span>(<span class="params">chain</span>) &#123;</span><br><span class="line">      chain.<span class="property">optimization</span>.<span class="title function_">minimizer</span>(<span class="string">&#x27;terser&#x27;</span>)</span><br><span class="line">        .<span class="title function_">tap</span>(<span class="function"><span class="params">args</span> =&gt;</span> &#123;</span><br><span class="line">          args[<span class="number">0</span>].<span class="property">terserOptions</span> = &#123;</span><br><span class="line">            <span class="attr">compress</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">keep_classnames</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">keep_fnames</span>: <span class="literal">true</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> args</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ğŸ–¼ï¸-èµ„æºä¼˜åŒ–"><a href="#ğŸ–¼ï¸-èµ„æºä¼˜åŒ–" class="headerlink" title="ğŸ–¼ï¸ èµ„æºä¼˜åŒ–"></a>ğŸ–¼ï¸ èµ„æºä¼˜åŒ–</h4><table><thead><tr><th align="left">ä¼˜åŒ–æ–¹å¼</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">ğŸ—œï¸ å‹ç¼©å›¾ç‰‡</td><td align="left">ä½¿ç”¨ WebP ç­‰é«˜å‹ç¼©æ¯”æ ¼å¼</td></tr><tr><td align="left">â˜ï¸ CDN åŠ è½½</td><td align="left">å¤§å›¾ç‰‡æ”¾ CDNï¼Œé€šè¿‡ç½‘ç»œåŠ è½½</td></tr><tr><td align="left">ğŸ“ ä½¿ç”¨å›¾æ ‡å­—ä½“</td><td align="left">æ›¿ä»£å›¾ç‰‡å›¾æ ‡ï¼Œå‡å°‘ä½“ç§¯</td></tr><tr><td align="left">ğŸ”— èµ„æºåˆå¹¶</td><td align="left">å‡å°‘ç½‘ç»œè¯·æ±‚æ•°é‡</td></tr></tbody></table><h4 id="ğŸ“¥-æŒ‰éœ€å¼•å…¥"><a href="#ğŸ“¥-æŒ‰éœ€å¼•å…¥" class="headerlink" title="ğŸ“¥ æŒ‰éœ€å¼•å…¥"></a>ğŸ“¥ æŒ‰éœ€å¼•å…¥</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ é”™è¯¯ï¼šå…¨é‡å¼•å…¥</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Button</span>, <span class="title class_">Input</span>, <span class="title class_">Form</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@tarojs/components&#x27;</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">// âœ… æ­£ç¡®ï¼šæŒ‰éœ€å¼•å…¥</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Button</span> <span class="keyword">from</span> <span class="string">&#x27;@tarojs/components/button&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Input</span> <span class="keyword">from</span> <span class="string">&#x27;@tarojs/components/input&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="ğŸš€-å‘å¸ƒæµç¨‹ä¸å®¡æ ¸"><a href="#ğŸš€-å‘å¸ƒæµç¨‹ä¸å®¡æ ¸" class="headerlink" title="ğŸš€ å‘å¸ƒæµç¨‹ä¸å®¡æ ¸"></a>ğŸš€ å‘å¸ƒæµç¨‹ä¸å®¡æ ¸</h3><h4 id="ğŸ“‹-ç‰ˆæœ¬å·ç®¡ç†"><a href="#ğŸ“‹-ç‰ˆæœ¬å·ç®¡ç†" class="headerlink" title="ğŸ“‹ ç‰ˆæœ¬å·ç®¡ç†"></a>ğŸ“‹ ç‰ˆæœ¬å·ç®¡ç†</h4><p>éµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬è§„èŒƒï¼ˆSemVerï¼‰</p><h4 id="ğŸ“-æå®¡ææ–™å‡†å¤‡"><a href="#ğŸ“-æå®¡ææ–™å‡†å¤‡" class="headerlink" title="ğŸ“ æå®¡ææ–™å‡†å¤‡"></a>ğŸ“ æå®¡ææ–™å‡†å¤‡</h4><ul><li>ğŸ“‹ å®Œæ•´çš„å°ç¨‹åºåŠŸèƒ½ä»‹ç»</li><li>ğŸ”‘ æµ‹è¯•è´¦å·ï¼ˆå¦‚éœ€ç™»å½•ï¼‰</li><li>ğŸ“œ ç›¸å…³èµ„è´¨ææ–™</li><li>ğŸ“‘ éšç§åè®®å’Œç”¨æˆ·åè®®</li></ul><h4 id="âš ï¸-å¸¸è§å®¡æ ¸é—®é¢˜"><a href="#âš ï¸-å¸¸è§å®¡æ ¸é—®é¢˜" class="headerlink" title="âš ï¸ å¸¸è§å®¡æ ¸é—®é¢˜"></a>âš ï¸ å¸¸è§å®¡æ ¸é—®é¢˜</h4><ul><li>âŒ è¯±å¯¼åˆ†äº«&#x2F;è¯„ä»·</li><li>âŒ ä¸åˆè§„å†…å®¹å’ŒåŠŸèƒ½</li><li>âŒ ä¸ªäººä¿¡æ¯æ”¶é›†ä¸è§„èŒƒ</li><li>âŒ UIä¸ä½“éªŒä¸ç¬¦åˆå¹³å°è§„èŒƒ</li></ul><h3 id="ğŸ”„-CI-CD-è‡ªåŠ¨åŒ–å‘å¸ƒ"><a href="#ğŸ”„-CI-CD-è‡ªåŠ¨åŒ–å‘å¸ƒ" class="headerlink" title="ğŸ”„ CI&#x2F;CD è‡ªåŠ¨åŒ–å‘å¸ƒ"></a>ğŸ”„ CI&#x2F;CD è‡ªåŠ¨åŒ–å‘å¸ƒ</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .github/workflows/deploy.yml</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">Deploy</span> <span class="string">Mini</span> <span class="string">Program</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span> [ <span class="string">main</span> ]</span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Use</span> <span class="string">Node.js</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-node@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">node-version:</span> <span class="string">&#x27;16&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">npm</span> <span class="string">ci</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build:weapp</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Upload</span> <span class="string">to</span> <span class="string">WeChat</span> <span class="string">DevTools</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">zhuowenli/taro-build-action@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">project-path:</span> <span class="string">&#x27;./dist&#x27;</span></span><br><span class="line">          <span class="attr">private-key:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PRIVATE_KEY</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">private-key-id:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PRIVATE_KEY_ID</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">upload-desc:</span> <span class="string">&#x27;Auto deploy from Github Actions&#x27;</span></span><br></pre></td></tr></table></figure><hr><h2 id="âš¡-æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ"><a href="#âš¡-æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ" class="headerlink" title="âš¡ æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ"></a>âš¡ æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ</h2><h3 id="ğŸš€-å¯åŠ¨æ€§èƒ½ä¼˜åŒ–"><a href="#ğŸš€-å¯åŠ¨æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="ğŸš€ å¯åŠ¨æ€§èƒ½ä¼˜åŒ–"></a>ğŸš€ å¯åŠ¨æ€§èƒ½ä¼˜åŒ–</h3><table><thead><tr><th align="left">ä¼˜åŒ–æ–¹å¼</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">ğŸ“¦ ç²¾ç®€ä¸»åŒ…</td><td align="left">å°†éå¿…è¦é¡µé¢ç§»è‡³åˆ†åŒ…</td></tr><tr><td align="left">ğŸ”„ é¢„ä¸‹è½½åˆ†åŒ…</td><td align="left">æå‰åŠ è½½å¯èƒ½éœ€è¦çš„åˆ†åŒ…</td></tr><tr><td align="left">âš¡ å¯ç”¨åˆå§‹æ¸²æŸ“ç¼“å­˜</td><td align="left">æé«˜é¡µé¢æ˜¾ç¤ºé€Ÿåº¦</td></tr></tbody></table><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.config.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">window</span>: &#123;</span><br><span class="line">    <span class="attr">initialRenderingCache</span>: <span class="string">&#x27;static&#x27;</span> <span class="comment">// å¼€å¯é™æ€åˆå§‹æ¸²æŸ“ç¼“å­˜</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="â±ï¸-è¿è¡Œæ—¶æ€§èƒ½ä¼˜åŒ–"><a href="#â±ï¸-è¿è¡Œæ—¶æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="â±ï¸ è¿è¡Œæ—¶æ€§èƒ½ä¼˜åŒ–"></a>â±ï¸ è¿è¡Œæ—¶æ€§èƒ½ä¼˜åŒ–</h3><h4 id="ğŸ›‘-é¿å…ä¸å¿…è¦çš„æ¸²æŸ“"><a href="#ğŸ›‘-é¿å…ä¸å¿…è¦çš„æ¸²æŸ“" class="headerlink" title="ğŸ›‘ é¿å…ä¸å¿…è¦çš„æ¸²æŸ“"></a>ğŸ›‘ é¿å…ä¸å¿…è¦çš„æ¸²æŸ“</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; throttle &#125; <span class="keyword">from</span> <span class="string">&#x27;../utils/tools&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// èŠ‚æµå¤„ç†</span></span><br><span class="line"><span class="keyword">const</span> handleScroll = <span class="title function_">throttle</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// å¤„ç†æ»šåŠ¨é€»è¾‘</span></span><br><span class="line">&#125;, <span class="number">200</span>)</span><br></pre></td></tr></table></figure><h4 id="ğŸ“œ-é•¿åˆ—è¡¨ä¼˜åŒ–"><a href="#ğŸ“œ-é•¿åˆ—è¡¨ä¼˜åŒ–" class="headerlink" title="ğŸ“œ é•¿åˆ—è¡¨ä¼˜åŒ–"></a>ğŸ“œ é•¿åˆ—è¡¨ä¼˜åŒ–</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;scroll-view </span><br><span class="line">  scroll-y </span><br><span class="line">  style=&quot;height: 500px&quot;</span><br><span class="line">  virtual-item-height=&quot;50&quot; </span><br><span class="line">  enableVirtualList&gt;</span><br><span class="line">  &lt;virtual-item v-for=&quot;item in list&quot; :key=&quot;item.id&quot;&gt;</span><br><span class="line">    &#123;&#123; item.name &#125;&#125;</span><br><span class="line">  &lt;/virtual-item&gt;</span><br><span class="line">&lt;/scroll-view&gt;</span><br></pre></td></tr></table></figure><h4 id="ğŸ–¼ï¸-å›¾ç‰‡æ‡’åŠ è½½"><a href="#ğŸ–¼ï¸-å›¾ç‰‡æ‡’åŠ è½½" class="headerlink" title="ğŸ–¼ï¸ å›¾ç‰‡æ‡’åŠ è½½"></a>ğŸ–¼ï¸ å›¾ç‰‡æ‡’åŠ è½½</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;image lazy-load src=&quot;&#123;&#123;imageUrl&#125;&#125;&quot; /&gt;</span><br></pre></td></tr></table></figure><h3 id="ğŸ’€-éª¨æ¶å±ä¼˜åŒ–"><a href="#ğŸ’€-éª¨æ¶å±ä¼˜åŒ–" class="headerlink" title="ğŸ’€ éª¨æ¶å±ä¼˜åŒ–"></a>ğŸ’€ éª¨æ¶å±ä¼˜åŒ–</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.config.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">initialRenderingCache</span>: &#123;</span><br><span class="line">    <span class="attr">skeleton</span>: &#123; <span class="comment">// é…ç½®éª¨æ¶å±</span></span><br><span class="line">      <span class="attr">mode</span>: <span class="string">&#x27;fullscreen&#x27;</span>, <span class="comment">// å…¨å±éª¨æ¶å±</span></span><br><span class="line">      <span class="attr">source</span>: <span class="string">&#x27;native&#x27;</span>, <span class="comment">// ä½¿ç”¨åŸç”Ÿéª¨æ¶å±</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ğŸŒ-ç½‘ç»œè¯·æ±‚ä¼˜åŒ–"><a href="#ğŸŒ-ç½‘ç»œè¯·æ±‚ä¼˜åŒ–" class="headerlink" title="ğŸŒ ç½‘ç»œè¯·æ±‚ä¼˜åŒ–"></a>ğŸŒ ç½‘ç»œè¯·æ±‚ä¼˜åŒ–</h3><table><thead><tr><th align="left">ä¼˜åŒ–æ–¹å¼</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">ğŸ”— åˆå¹¶è¯·æ±‚</td><td align="left">å‡å°‘è¯·æ±‚æ¬¡æ•°</td></tr><tr><td align="left">ğŸ“‹ è¯·æ±‚é˜Ÿåˆ—</td><td align="left">é¿å…åŒæ—¶å‘èµ·è¿‡å¤šè¯·æ±‚</td></tr><tr><td align="left">â±ï¸ è¶…æ—¶ä¸é‡è¯•</td><td align="left">åˆç†è®¾ç½®è¯·æ±‚è¶…æ—¶å’Œé‡è¯•ç­–ç•¥</td></tr><tr><td align="left">ğŸš€ HTTP&#x2F;2</td><td align="left">å¯ç”¨ HTTP&#x2F;2 ä¼˜åŒ–è¿æ¥</td></tr></tbody></table><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Taro</span>.<span class="title function_">request</span>(&#123;</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;https://api.example.com/data&#x27;</span>,</span><br><span class="line">  <span class="attr">enableHttp2</span>: <span class="literal">true</span>, <span class="comment">// å¼€å¯HTTP/2</span></span><br><span class="line">  <span class="attr">enableQuic</span>: <span class="literal">true</span>, <span class="comment">// å¼€å¯QUIC</span></span><br><span class="line">  <span class="attr">enableCache</span>: <span class="literal">true</span>, <span class="comment">// å¼€å¯ç¼“å­˜</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><hr><h2 id="ğŸ”-å°ç¨‹åºç‰¹æœ‰åŠŸèƒ½"><a href="#ğŸ”-å°ç¨‹åºç‰¹æœ‰åŠŸèƒ½" class="headerlink" title="ğŸ” å°ç¨‹åºç‰¹æœ‰åŠŸèƒ½"></a>ğŸ” å°ç¨‹åºç‰¹æœ‰åŠŸèƒ½</h2><h3 id="ğŸ”‘-å°ç¨‹åºç™»å½•æµç¨‹ä¼˜åŒ–"><a href="#ğŸ”‘-å°ç¨‹åºç™»å½•æµç¨‹ä¼˜åŒ–" class="headerlink" title="ğŸ”‘ å°ç¨‹åºç™»å½•æµç¨‹ä¼˜åŒ–"></a>ğŸ”‘ å°ç¨‹åºç™»å½•æµç¨‹ä¼˜åŒ–</h3><h4 id="å®Œæ•´ç™»å½•æµç¨‹å›¾"><a href="#å®Œæ•´ç™»å½•æµç¨‹å›¾" class="headerlink" title="å®Œæ•´ç™»å½•æµç¨‹å›¾"></a>å®Œæ•´ç™»å½•æµç¨‹å›¾</h4><p><img src= "/img/loading.gif" data-lazy-src="/img/taroLogin.png"      srcset="/img/taroLogin.png 480w, /img/taroLogin.png 1200w"      sizes="(max-width:600px) 100vw, 50vw"></p><h4 id="ç™»å½•æµç¨‹è¯´æ˜"><a href="#ç™»å½•æµç¨‹è¯´æ˜" class="headerlink" title="ç™»å½•æµç¨‹è¯´æ˜"></a>ç™»å½•æµç¨‹è¯´æ˜</h4><ol><li><p><strong>æœ¬åœ°éªŒè¯é˜¶æ®µ</strong>ï¼š</p><ul><li>æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰ç™»å½•å‡­è¯(token)</li><li>è‹¥æœ‰tokenï¼ŒéªŒè¯å…¶æœ‰æ•ˆæ€§</li><li>è‹¥æ— tokenæˆ–tokenæ— æ•ˆï¼Œè¿›å…¥å¾®ä¿¡ç™»å½•æµç¨‹</li></ul></li><li><p><strong>è·å–å‡­è¯é˜¶æ®µ</strong>ï¼š</p><ul><li>è°ƒç”¨<code>Taro.login()</code>è·å–ä¸´æ—¶ç™»å½•å‡­è¯code</li><li>å°†codeå‘é€è‡³åº”ç”¨æœåŠ¡å™¨</li></ul></li><li><p><strong>æœåŠ¡ç«¯èº«ä»½éªŒè¯</strong>ï¼š</p><ul><li>åº”ç”¨æœåŠ¡å™¨æºå¸¦codeã€appidå’Œsecretè¯·æ±‚å¾®ä¿¡æœåŠ¡å™¨</li><li>å¾®ä¿¡æœåŠ¡å™¨è¿”å›openidå’Œsession_key</li><li>åº”ç”¨æœåŠ¡å™¨æ ¹æ®openidæŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å­˜åœ¨</li></ul></li><li><p><strong>ç”¨æˆ·å¤„ç†é˜¶æ®µ</strong>ï¼š</p><ul><li>è‹¥ç”¨æˆ·å·²å­˜åœ¨ï¼šæ›´æ–°ç”¨æˆ·ç™»å½•æ—¶é—´ï¼Œç”Ÿæˆæ–°token</li><li>è‹¥ç”¨æˆ·ä¸å­˜åœ¨ï¼šåˆ›å»ºæ–°ç”¨æˆ·è®°å½•ï¼Œç”Ÿæˆtoken</li><li>å°†tokenå’Œç”¨æˆ·åŸºæœ¬ä¿¡æ¯è¿”å›å°ç¨‹åºå‰ç«¯</li></ul></li><li><p><strong>ç™»å½•å®Œæˆé˜¶æ®µ</strong>ï¼š</p><ul><li>å°ç¨‹åºä¿å­˜tokenåˆ°æœ¬åœ°å­˜å‚¨</li><li>ä¿å­˜å¿…è¦çš„ç”¨æˆ·ä¿¡æ¯</li><li>æ›´æ–°åº”ç”¨çš„ç™»å½•çŠ¶æ€</li><li>è¿›å…¥å°ç¨‹åºä¸»ç•Œé¢</li></ul></li></ol><h4 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h4><h5 id="å‰ç«¯å®ç°ï¼ˆTaroï¼‰"><a href="#å‰ç«¯å®ç°ï¼ˆTaroï¼‰" class="headerlink" title="å‰ç«¯å®ç°ï¼ˆTaroï¼‰"></a>å‰ç«¯å®ç°ï¼ˆTaroï¼‰</h5><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// login.ts</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Taro</span> <span class="keyword">from</span> <span class="string">&#x27;@tarojs/taro&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; login <span class="keyword">as</span> apiLogin &#125; <span class="keyword">from</span> <span class="string">&#x27;../services/auth&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç™»å½•çŠ¶æ€æ£€æŸ¥ä¸ç™»å½•æµç¨‹</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">ensureLogin</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 1. æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰æœ‰æ•ˆçš„ token</span></span><br><span class="line">  <span class="keyword">const</span> token = <span class="title class_">Taro</span>.<span class="title function_">getStorageSync</span>(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (token) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 2. éªŒè¯ token æ˜¯å¦æœ‰æ•ˆ</span></span><br><span class="line">      <span class="keyword">const</span> checkResult = <span class="keyword">await</span> <span class="title function_">checkTokenValidity</span>(token)</span><br><span class="line">      <span class="keyword">if</span> (checkResult.<span class="property">valid</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;token æœ‰æ•ˆï¼Œå·²ç™»å½•&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;token æ ¡éªŒå¤±è´¥ï¼Œéœ€è¦é‡æ–°ç™»å½•&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 3. token æ— æ•ˆæˆ–ä¸å­˜åœ¨ï¼Œè¿›è¡Œç™»å½•æµç¨‹</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">wxLogin</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¾®ä¿¡ç™»å½•æµç¨‹</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">wxLogin</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// æ˜¾ç¤ºåŠ è½½æç¤º</span></span><br><span class="line">    <span class="title class_">Taro</span>.<span class="title function_">showLoading</span>(&#123; <span class="attr">title</span>: <span class="string">&#x27;ç™»å½•ä¸­...&#x27;</span> &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. è°ƒç”¨å¾®ä¿¡ç™»å½•ï¼Œè·å– code</span></span><br><span class="line">    <span class="keyword">const</span> &#123; code &#125; = <span class="keyword">await</span> <span class="title class_">Taro</span>.<span class="title function_">login</span>()</span><br><span class="line">    <span class="keyword">if</span> (!code) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;å¾®ä¿¡ç™»å½•å¤±è´¥ï¼Œè·å– code å¤±è´¥&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. å°† code å‘é€ç»™åç«¯</span></span><br><span class="line">    <span class="keyword">const</span> loginResult = <span class="keyword">await</span> <span class="title function_">apiLogin</span>(&#123; code &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. å­˜å‚¨ç™»å½•çŠ¶æ€å’Œç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">    <span class="title class_">Taro</span>.<span class="title function_">setStorageSync</span>(<span class="string">&#x27;token&#x27;</span>, loginResult.<span class="property">token</span>)</span><br><span class="line">    <span class="title class_">Taro</span>.<span class="title function_">setStorageSync</span>(<span class="string">&#x27;userInfo&#x27;</span>, loginResult.<span class="property">userInfo</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦æ˜¯æ–°ç”¨æˆ·ï¼Œå¦‚æœæ˜¯æ–°ç”¨æˆ·å¯ä»¥å¼•å¯¼å®Œå–„èµ„æ–™</span></span><br><span class="line">    <span class="keyword">if</span> (loginResult.<span class="property">isNewUser</span>) &#123;</span><br><span class="line">      <span class="title class_">Taro</span>.<span class="title function_">navigateTo</span>(&#123; <span class="attr">url</span>: <span class="string">&#x27;/pages/user-profile/index&#x27;</span> &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">Taro</span>.<span class="title function_">hideLoading</span>()</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;ç™»å½•å¤±è´¥&#x27;</span>, error)</span><br><span class="line">    <span class="title class_">Taro</span>.<span class="title function_">hideLoading</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">Taro</span>.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&#x27;ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•&#x27;</span>,</span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¡éªŒ token æœ‰æ•ˆæ€§</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">checkTokenValidity</span>(<span class="params">token</span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">Taro</span>.<span class="title function_">request</span>(&#123;</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&#x27;/api/auth/check-token&#x27;</span>,</span><br><span class="line">      <span class="attr">header</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">`Bearer <span class="subst">$&#123;token&#125;</span>`</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">valid</span>: res.<span class="property">data</span>.<span class="property">valid</span> &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">valid</span>: <span class="literal">false</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="æœåŠ¡ç«¯å®ç°ï¼ˆNode-jsï¼‰"><a href="#æœåŠ¡ç«¯å®ç°ï¼ˆNode-jsï¼‰" class="headerlink" title="æœåŠ¡ç«¯å®ç°ï¼ˆNode.jsï¼‰"></a>æœåŠ¡ç«¯å®ç°ï¼ˆNode.jsï¼‰</h5><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// auth.controller.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Request</span>, <span class="title class_">Response</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span></span><br><span class="line"><span class="keyword">import</span> jwt <span class="keyword">from</span> <span class="string">&#x27;jsonwebtoken&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">User</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../models/user.model&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¾®ä¿¡ç™»å½•é…ç½®</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">WX_CONFIG</span> = &#123;</span><br><span class="line">  <span class="attr">appId</span>: process.<span class="property">env</span>.<span class="property">WX_APP_ID</span>,</span><br><span class="line">  <span class="attr">appSecret</span>: process.<span class="property">env</span>.<span class="property">WX_APP_SECRET</span>,</span><br><span class="line">  <span class="attr">loginUrl</span>: <span class="string">&#x27;https://api.weixin.qq.com/sns/jscode2session&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç™»å½•æ¥å£</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">login</span>(<span class="params"><span class="attr">req</span>: <span class="title class_">Request</span>, <span class="attr">res</span>: <span class="title class_">Response</span></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; code &#125; = req.<span class="property">body</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!code) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">json</span>(&#123; </span><br><span class="line">        <span class="attr">success</span>: <span class="literal">false</span>, </span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;ç¼ºå°‘ç™»å½•code&#x27;</span> </span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. è¯·æ±‚å¾®ä¿¡APIè·å–openidå’Œsession_key</span></span><br><span class="line">    <span class="keyword">const</span> wxResponse = <span class="keyword">await</span> axios.<span class="title function_">get</span>(<span class="variable constant_">WX_CONFIG</span>.<span class="property">loginUrl</span>, &#123;</span><br><span class="line">      <span class="attr">params</span>: &#123;</span><br><span class="line">        <span class="attr">appid</span>: <span class="variable constant_">WX_CONFIG</span>.<span class="property">appId</span>,</span><br><span class="line">        <span class="attr">secret</span>: <span class="variable constant_">WX_CONFIG</span>.<span class="property">appSecret</span>,</span><br><span class="line">        <span class="attr">js_code</span>: code,</span><br><span class="line">        <span class="attr">grant_type</span>: <span class="string">&#x27;authorization_code&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> &#123; openid, session_key &#125; = wxResponse.<span class="property">data</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!openid) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">json</span>(&#123; </span><br><span class="line">        <span class="attr">success</span>: <span class="literal">false</span>, </span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;è·å–openidå¤±è´¥&#x27;</span> </span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. æ ¹æ®openidæŸ¥è¯¢æ•°æ®åº“ï¼Œåˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">let</span> user = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findOne</span>(&#123; openid &#125;)</span><br><span class="line">    <span class="keyword">let</span> isNewUser = <span class="literal">false</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–°ç”¨æˆ·</span></span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      isNewUser = <span class="literal">true</span></span><br><span class="line">      user = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">        openid,</span><br><span class="line">        <span class="attr">createdAt</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">        <span class="comment">// å…¶ä»–é»˜è®¤æ•°æ®</span></span><br><span class="line">        <span class="attr">nickname</span>: <span class="string">`ç”¨æˆ·<span class="subst">$&#123;<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">10000</span>)&#125;</span>`</span>,</span><br><span class="line">        <span class="attr">avatarUrl</span>: <span class="string">&#x27;&#x27;</span>, <span class="comment">// é»˜è®¤å¤´åƒ</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ç”Ÿæˆtoken</span></span><br><span class="line">    <span class="keyword">const</span> token = jwt.<span class="title function_">sign</span>(</span><br><span class="line">      &#123; <span class="attr">userId</span>: user.<span class="property">_id</span>, openid &#125;,</span><br><span class="line">      process.<span class="property">env</span>.<span class="property">JWT_SECRET</span>,</span><br><span class="line">      &#123; <span class="attr">expiresIn</span>: <span class="string">&#x27;7d&#x27;</span> &#125;</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. æ›´æ–°ç”¨æˆ·çš„æœ€åç™»å½•æ—¶é—´</span></span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">updateOne</span>(</span><br><span class="line">      &#123; <span class="attr">_id</span>: user.<span class="property">_id</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">$set</span>: &#123; <span class="attr">lastLoginAt</span>: <span class="keyword">new</span> <span class="title class_">Date</span>() &#125; &#125;</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. è¿”å›ç™»å½•ç»“æœ</span></span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">success</span>: <span class="literal">true</span>,</span><br><span class="line">      token,</span><br><span class="line">      <span class="attr">userInfo</span>: &#123;</span><br><span class="line">        <span class="attr">_id</span>: user.<span class="property">_id</span>,</span><br><span class="line">        <span class="attr">nickname</span>: user.<span class="property">nickname</span>,</span><br><span class="line">        <span class="attr">avatarUrl</span>: user.<span class="property">avatarUrl</span>,</span><br><span class="line">        <span class="comment">// å…¶ä»–éœ€è¦çš„ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">      &#125;,</span><br><span class="line">      isNewUser</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;ç™»å½•å¼‚å¸¸:&#x27;</span>, error)</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&#x27;æœåŠ¡å™¨é”™è¯¯&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// éªŒè¯tokenæ¥å£</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">checkToken</span>(<span class="params"><span class="attr">req</span>: <span class="title class_">Request</span>, <span class="attr">res</span>: <span class="title class_">Response</span></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// tokenå·²ç»åœ¨ä¸­é—´ä»¶ä¸­éªŒè¯è¿‡ï¼Œèƒ½åˆ°è¿™é‡Œè¯´æ˜tokenæœ‰æ•ˆ</span></span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">valid</span>: <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">valid</span>: <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è¯·æ±‚å°è£…"><a href="#è¯·æ±‚å°è£…" class="headerlink" title="è¯·æ±‚å°è£…"></a>è¯·æ±‚å°è£…</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// request.ts</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Taro</span> <span class="keyword">from</span> <span class="string">&#x27;@tarojs/taro&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; ensureLogin &#125; <span class="keyword">from</span> <span class="string">&#x27;./login&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å°è£…è¯·æ±‚æ–¹æ³•ï¼Œè‡ªåŠ¨æºå¸¦tokenå’Œå¤„ç†ç™»å½•æ€</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">request</span>(<span class="params">options</span>) &#123;</span><br><span class="line">  <span class="comment">// è·å–å­˜å‚¨çš„token</span></span><br><span class="line">  <span class="keyword">const</span> token = <span class="title class_">Taro</span>.<span class="title function_">getStorageSync</span>(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// åˆå¹¶è¯·æ±‚å¤´</span></span><br><span class="line">  <span class="keyword">const</span> header = &#123;</span><br><span class="line">    <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">    ...options.<span class="property">header</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å¦‚æœæœ‰tokenï¼Œåˆ™æ·»åŠ åˆ°è¯·æ±‚å¤´</span></span><br><span class="line">  <span class="keyword">if</span> (token) &#123;</span><br><span class="line">    header[<span class="string">&#x27;Authorization&#x27;</span>] = <span class="string">`Bearer <span class="subst">$&#123;token&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title class_">Taro</span>.<span class="title function_">request</span>(&#123;</span><br><span class="line">      ...options,</span><br><span class="line">      header</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¯·æ±‚æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span> (response.<span class="property">statusCode</span> &gt;= <span class="number">200</span> &amp;&amp; response.<span class="property">statusCode</span> &lt; <span class="number">300</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> response.<span class="property">data</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// token å¤±æ•ˆï¼ˆ401ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (response.<span class="property">statusCode</span> === <span class="number">401</span>) &#123;</span><br><span class="line">      <span class="comment">// æ¸…é™¤å·²å¤±æ•ˆçš„token</span></span><br><span class="line">      <span class="title class_">Taro</span>.<span class="title function_">removeStorageSync</span>(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// é‡æ–°ç™»å½•</span></span><br><span class="line">      <span class="keyword">const</span> loginSuccess = <span class="keyword">await</span> <span class="title function_">ensureLogin</span>()</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (loginSuccess) &#123;</span><br><span class="line">        <span class="comment">// ç™»å½•æˆåŠŸï¼Œé‡è¯•åŸè¯·æ±‚</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">request</span>(options)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;ç™»å½•å¤±è´¥ï¼Œæ— æ³•å®Œæˆè¯·æ±‚&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å…¶ä»–é”™è¯¯</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(response.<span class="property">data</span>.<span class="property">message</span> || <span class="string">&#x27;è¯·æ±‚å¤±è´¥&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;è¯·æ±‚å¼‚å¸¸:&#x27;</span>, error)</span><br><span class="line">    <span class="keyword">throw</span> error</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç™»å½•çŠ¶æ€ç®¡ç†ï¼ˆä½¿ç”¨Piniaï¼‰"><a href="#ç™»å½•çŠ¶æ€ç®¡ç†ï¼ˆä½¿ç”¨Piniaï¼‰" class="headerlink" title="ç™»å½•çŠ¶æ€ç®¡ç†ï¼ˆä½¿ç”¨Piniaï¼‰"></a>ç™»å½•çŠ¶æ€ç®¡ç†ï¼ˆä½¿ç”¨Piniaï¼‰</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// stores/user.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Taro</span> <span class="keyword">from</span> <span class="string">&#x27;@tarojs/taro&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; ensureLogin &#125; <span class="keyword">from</span> <span class="string">&#x27;../utils/login&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; getUserInfo &#125; <span class="keyword">from</span> <span class="string">&#x27;../services/user&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useUserStore = <span class="title function_">defineStore</span>(<span class="string">&#x27;user&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">state</span>: <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">token</span>: <span class="title class_">Taro</span>.<span class="title function_">getStorageSync</span>(<span class="string">&#x27;token&#x27;</span>) || <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">userInfo</span>: <span class="title class_">Taro</span>.<span class="title function_">getStorageSync</span>(<span class="string">&#x27;userInfo&#x27;</span>) || <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">isLoggedIn</span>: !!<span class="title class_">Taro</span>.<span class="title function_">getStorageSync</span>(<span class="string">&#x27;token&#x27;</span>),</span><br><span class="line">    <span class="attr">isLoading</span>: <span class="literal">false</span></span><br><span class="line">  &#125;),</span><br><span class="line">  </span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æ£€æŸ¥ç™»å½•çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">checkLoginStatus</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isLoggedIn</span>) &#123;</span><br><span class="line">          <span class="comment">// åˆ·æ–°ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">          <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">fetchUserInfo</span>()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="comment">// å‡ºé”™åˆ™ç½®ä¸ºæœªç™»å½•çŠ¶æ€</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isLoggedIn</span> = <span class="literal">false</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">token</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">userInfo</span> = <span class="literal">null</span></span><br><span class="line">        <span class="title class_">Taro</span>.<span class="title function_">removeStorageSync</span>(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">        <span class="title class_">Taro</span>.<span class="title function_">removeStorageSync</span>(<span class="string">&#x27;userInfo&#x27;</span>)</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç™»å½•</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> success = <span class="keyword">await</span> <span class="title function_">ensureLogin</span>()</span><br><span class="line">        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">token</span> = <span class="title class_">Taro</span>.<span class="title function_">getStorageSync</span>(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">userInfo</span> = <span class="title class_">Taro</span>.<span class="title function_">getStorageSync</span>(<span class="string">&#x27;userInfo&#x27;</span>)</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">isLoggedIn</span> = <span class="literal">true</span></span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;ç™»å½•å¤±è´¥&#x27;</span>, error)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">fetchUserInfo</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">token</span>) <span class="keyword">return</span></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> userInfo = <span class="keyword">await</span> <span class="title function_">getUserInfo</span>()</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">userInfo</span> = userInfo</span><br><span class="line">        <span class="title class_">Taro</span>.<span class="title function_">setStorageSync</span>(<span class="string">&#x27;userInfo&#x27;</span>, userInfo)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥&#x27;</span>, error)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é€€å‡ºç™»å½•</span></span><br><span class="line">    <span class="title function_">logout</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">token</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">userInfo</span> = <span class="literal">null</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">isLoggedIn</span> = <span class="literal">false</span></span><br><span class="line">      <span class="title class_">Taro</span>.<span class="title function_">removeStorageSync</span>(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">      <span class="title class_">Taro</span>.<span class="title function_">removeStorageSync</span>(<span class="string">&#x27;userInfo&#x27;</span>)</span><br><span class="line">      <span class="title class_">Taro</span>.<span class="title function_">showToast</span>(&#123; <span class="attr">title</span>: <span class="string">&#x27;å·²é€€å‡ºç™»å½•&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;success&#x27;</span> &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="ç™»å½•æµç¨‹ä½¿ç”¨ç¤ºä¾‹"><a href="#ç™»å½•æµç¨‹ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="ç™»å½•æµç¨‹ä½¿ç”¨ç¤ºä¾‹"></a>ç™»å½•æµç¨‹ä½¿ç”¨ç¤ºä¾‹</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;view class=&quot;login-page&quot;&gt;</span><br><span class="line">    &lt;view v-if=&quot;!userStore.isLoggedIn&quot;&gt;</span><br><span class="line">      &lt;button @tap=&quot;handleLogin&quot; :loading=&quot;userStore.isLoading&quot;&gt;</span><br><span class="line">        å¾®ä¿¡ä¸€é”®ç™»å½•</span><br><span class="line">      &lt;/button&gt;</span><br><span class="line">    &lt;/view&gt;</span><br><span class="line">    &lt;view v-else&gt;</span><br><span class="line">      &lt;view class=&quot;user-info&quot;&gt;</span><br><span class="line">        &lt;image :src=&quot;userStore.userInfo?.avatarUrl || defaultAvatar&quot; class=&quot;avatar&quot; /&gt;</span><br><span class="line">        &lt;text class=&quot;nickname&quot;&gt;&#123;&#123; userStore.userInfo?.nickname || &#x27;æœªè®¾ç½®æ˜µç§°&#x27; &#125;&#125;&lt;/text&gt;</span><br><span class="line">      &lt;/view&gt;</span><br><span class="line">      &lt;button @tap=&quot;userStore.logout&quot; type=&quot;default&quot;&gt;é€€å‡ºç™»å½•&lt;/button&gt;</span><br><span class="line">    &lt;/view&gt;</span><br><span class="line">  &lt;/view&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">import &#123; onLoad &#125; from &#x27;@tarojs/taro&#x27;</span><br><span class="line">import &#123; useUserStore &#125; from &#x27;../../stores/user&#x27;</span><br><span class="line"></span><br><span class="line">const userStore = useUserStore()</span><br><span class="line">const defaultAvatar = &#x27;../../assets/default-avatar.png&#x27;</span><br><span class="line"></span><br><span class="line">// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€</span><br><span class="line">onLoad(() =&gt; &#123;</span><br><span class="line">  userStore.checkLoginStatus()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// å¤„ç†ç™»å½•</span><br><span class="line">const handleLogin = async () =&gt; &#123;</span><br><span class="line">  const success = await userStore.login()</span><br><span class="line">  if (success) &#123;</span><br><span class="line">    console.log(&#x27;ç™»å½•æˆåŠŸ&#x27;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h4 id="ç™»å½•å®‰å…¨æœ€ä½³å®è·µ"><a href="#ç™»å½•å®‰å…¨æœ€ä½³å®è·µ" class="headerlink" title="ç™»å½•å®‰å…¨æœ€ä½³å®è·µ"></a>ç™»å½•å®‰å…¨æœ€ä½³å®è·µ</h4><ol><li><p><strong>ä½¿ç”¨ HTTPS</strong>ï¼šæ‰€æœ‰æ¥å£é€šä¿¡å¿…é¡»ä½¿ç”¨ HTTPS åŠ å¯†ä¼ è¾“</p></li><li><p><strong>TOKEN å¤„ç†</strong>ï¼š</p><ul><li>è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ï¼ˆé€šå¸¸7å¤©ä»¥å†…ï¼‰</li><li>æ”¯æŒä¸»åŠ¨åˆ·æ–° TOKEN</li><li>é€€å‡ºç™»å½•æ—¶æ¸…é™¤ TOKEN</li></ul></li><li><p><strong>æ•æ„Ÿä¿¡æ¯å­˜å‚¨</strong>ï¼š</p><ul><li>ä¸åœ¨å®¢æˆ·ç«¯å­˜å‚¨ç”¨æˆ·æ•æ„Ÿä¿¡æ¯</li><li>ä½¿ç”¨å°ç¨‹åºæä¾›çš„å®‰å…¨å­˜å‚¨ API</li></ul></li><li><p><strong>é˜²åˆ·é˜²æš´åŠ›</strong>ï¼š</p><ul><li>ç™»å½•æ¥å£å¢åŠ é¢‘ç‡é™åˆ¶</li><li>å¤šæ¬¡å¤±è´¥åè¦æ±‚å›¾å½¢éªŒè¯ç æˆ–å»¶æ—¶</li></ul></li><li><p><strong>ç”¨æˆ·ä¿¡æ¯ä¿æŠ¤</strong>ï¼š</p><ul><li>åªè¿”å›å¿…è¦çš„ç”¨æˆ·ä¿¡æ¯</li><li>æ•æ„Ÿæ“ä½œéœ€è¦äºŒæ¬¡éªŒè¯</li></ul></li></ol><h3 id="ğŸ‘¤-è·å–ç”¨æˆ·ä¿¡æ¯"><a href="#ğŸ‘¤-è·å–ç”¨æˆ·ä¿¡æ¯" class="headerlink" title="ğŸ‘¤ è·å–ç”¨æˆ·ä¿¡æ¯"></a>ğŸ‘¤ è·å–ç”¨æˆ·ä¿¡æ¯</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;button </span><br><span class="line">    open-type=&quot;chooseAvatar&quot; </span><br><span class="line">    @chooseavatar=&quot;onChooseAvatar&quot;&gt;</span><br><span class="line">    é€‰æ‹©å¤´åƒ</span><br><span class="line">  &lt;/button&gt;</span><br><span class="line">  </span><br><span class="line">  &lt;input </span><br><span class="line">    type=&quot;nickname&quot; </span><br><span class="line">    placeholder=&quot;è¯·è¾“å…¥æ˜µç§°&quot; </span><br><span class="line">    @change=&quot;onNicknameChange&quot; </span><br><span class="line">  /&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">import &#123; ref &#125; from &#x27;vue&#x27;</span><br><span class="line">import Taro from &#x27;@tarojs/taro&#x27;</span><br><span class="line"></span><br><span class="line">const avatarUrl = ref(&#x27;&#x27;)</span><br><span class="line">const nickname = ref(&#x27;&#x27;)</span><br><span class="line"></span><br><span class="line">const onChooseAvatar = (e) =&gt; &#123;</span><br><span class="line">  avatarUrl.value = e.detail.avatarUrl</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const onNicknameChange = (e) =&gt; &#123;</span><br><span class="line">  nickname.value = e.detail.value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const saveUserInfo = async () =&gt; &#123;</span><br><span class="line">  if (!avatarUrl.value || !nickname.value) &#123;</span><br><span class="line">    Taro.showToast(&#123;</span><br><span class="line">      title: &#x27;è¯·å®Œå–„ä¿¡æ¯&#x27;,</span><br><span class="line">      icon: &#x27;none&#x27;</span><br><span class="line">    &#125;)</span><br><span class="line">    return</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  // ä¸Šä¼ å¤´åƒåˆ°æœåŠ¡å™¨</span><br><span class="line">  const uploadRes = await uploadFile(avatarUrl.value)</span><br><span class="line">  </span><br><span class="line">  // ä¿å­˜ç”¨æˆ·ä¿¡æ¯</span><br><span class="line">  await updateUserInfo(&#123;</span><br><span class="line">    avatarUrl: uploadRes.url,</span><br><span class="line">    nickname: nickname.value</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h3 id="ğŸ“±-å°ç¨‹åºé€‚é…ä¸å…¼å®¹æ€§"><a href="#ğŸ“±-å°ç¨‹åºé€‚é…ä¸å…¼å®¹æ€§" class="headerlink" title="ğŸ“± å°ç¨‹åºé€‚é…ä¸å…¼å®¹æ€§"></a>ğŸ“± å°ç¨‹åºé€‚é…ä¸å…¼å®¹æ€§</h3><h4 id="ğŸ“Š-åŸºç¡€åº“ç‰ˆæœ¬"><a href="#ğŸ“Š-åŸºç¡€åº“ç‰ˆæœ¬" class="headerlink" title="ğŸ“Š åŸºç¡€åº“ç‰ˆæœ¬"></a>ğŸ“Š åŸºç¡€åº“ç‰ˆæœ¬</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.config.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">miniprogramRoot</span>: <span class="string">&#x27;./&#x27;</span>,</span><br><span class="line">  <span class="attr">projectname</span>: <span class="string">&#x27;MyApp&#x27;</span>,</span><br><span class="line">  <span class="attr">setting</span>: &#123;</span><br><span class="line">    <span class="attr">minified</span>: <span class="literal">true</span>, <span class="comment">// å‹ç¼©ä»£ç </span></span><br><span class="line">    <span class="attr">es6</span>: <span class="literal">true</span>, <span class="comment">// å¼€å¯ES6è½¬æ¢</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">libVersion</span>: <span class="string">&#x27;2.24.7&#x27;</span>, <span class="comment">// æŒ‡å®šåŸºç¡€åº“ç‰ˆæœ¬</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ğŸ”„-ç‰ˆæœ¬æ£€æµ‹ä¸æç¤º"><a href="#ğŸ”„-ç‰ˆæœ¬æ£€æµ‹ä¸æç¤º" class="headerlink" title="ğŸ”„ ç‰ˆæœ¬æ£€æµ‹ä¸æç¤º"></a>ğŸ”„ ç‰ˆæœ¬æ£€æµ‹ä¸æç¤º</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">checkVersion</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// è·å–å¾®ä¿¡ç‰ˆæœ¬ä¿¡æ¯</span></span><br><span class="line">  <span class="keyword">const</span> version = <span class="title class_">Taro</span>.<span class="title function_">getSystemInfoSync</span>().<span class="property">SDKVersion</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// æ¯”è¾ƒç‰ˆæœ¬å·</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Taro</span>.<span class="title function_">compareVersion</span>(version, <span class="string">&#x27;2.21.0&#x27;</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="title class_">Taro</span>.<span class="title function_">showModal</span>(&#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&#x27;æç¤º&#x27;</span>,</span><br><span class="line">      <span class="attr">content</span>: <span class="string">&#x27;å½“å‰å¾®ä¿¡ç‰ˆæœ¬è¿‡ä½ï¼Œè¯·æ›´æ–°è‡³æœ€æ–°ç‰ˆæœ¬&#x27;</span>,</span><br><span class="line">      <span class="attr">showCancel</span>: <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ğŸ¨-WeUI-ç»„ä»¶ä½¿ç”¨"><a href="#ğŸ¨-WeUI-ç»„ä»¶ä½¿ç”¨" class="headerlink" title="ğŸ¨ WeUI ç»„ä»¶ä½¿ç”¨"></a>ğŸ¨ WeUI ç»„ä»¶ä½¿ç”¨</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.config.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">useExtendedLib</span>: &#123;</span><br><span class="line">    <span class="attr">weui</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;weui-form&gt;</span><br><span class="line">    &lt;weui-cells title=&quot;è¡¨å•&quot;&gt;</span><br><span class="line">      &lt;weui-cell&gt;</span><br><span class="line">        &lt;weui-input placeholder=&quot;è¯·è¾“å…¥&quot; /&gt;</span><br><span class="line">      &lt;/weui-cell&gt;</span><br><span class="line">    &lt;/weui-cells&gt;</span><br><span class="line">    &lt;weui-button type=&quot;primary&quot;&gt;æäº¤&lt;/weui-button&gt;</span><br><span class="line">  &lt;/weui-form&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure><hr><h2 id="âœ¨-æœ€ä½³å®è·µ"><a href="#âœ¨-æœ€ä½³å®è·µ" class="headerlink" title="âœ¨ æœ€ä½³å®è·µ"></a>âœ¨ æœ€ä½³å®è·µ</h2><table><thead><tr><th align="left">å®è·µ</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">ğŸ“ <strong>ä»£ç ç»„ç»‡</strong></td><td align="left">æŒ‰åŠŸèƒ½æ¨¡å—æ‹†åˆ†ç»„ä»¶ï¼Œé¿å…è¿‡å¤§çš„é¡µé¢æ–‡ä»¶</td></tr><tr><td align="left">ğŸ”„ <strong>çŠ¶æ€ç®¡ç†</strong></td><td align="left">å¤æ‚åº”ç”¨ä½¿ç”¨ Pinia ç­‰çŠ¶æ€ç®¡ç†å·¥å…·</td></tr><tr><td align="left">ğŸ¨ <strong>æ ·å¼ç®¡ç†</strong></td><td align="left">ä½¿ç”¨é¢„å¤„ç†å™¨ï¼Œæ¨¡å—åŒ–CSS</td></tr><tr><td align="left">ğŸ”„ <strong>å…¼å®¹æ€§</strong></td><td align="left">æ³¨æ„å°ç¨‹åºå¹³å°å·®å¼‚ï¼Œåšå¥½å…¼å®¹å¤„ç†</td></tr><tr><td align="left">ğŸ”’ <strong>å®‰å…¨æ€§</strong></td><td align="left">æ•æ„Ÿæ•°æ®ä¸å­˜å‚¨åœ¨æœ¬åœ°ï¼Œä½¿ç”¨tokenéªŒè¯è¯·æ±‚</td></tr><tr><td align="left">âš ï¸ <strong>é”™è¯¯å¤„ç†</strong></td><td align="left">å®Œå–„çš„é”™è¯¯æ•è·å’Œæç¤ºæœºåˆ¶</td></tr><tr><td align="left">ğŸ”„ <strong>ä»£ç å¤ç”¨</strong></td><td align="left">æŠ½å–å…¬å…±é€»è¾‘åˆ° hooks&#x2F;composables ä¸­</td></tr><tr><td align="left">ğŸ”Œ <strong>æ¥å£å°è£…</strong></td><td align="left">ç»Ÿä¸€å°è£…ç½‘ç»œè¯·æ±‚ï¼Œä¾¿äºç®¡ç†</td></tr></tbody></table>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Denoå­¦ä¹ è®°å½•-ğŸ“˜&quot;&gt;&lt;a href=&quot;#Denoå­¦ä¹ è®°å½•-ğŸ“˜&quot; class=&quot;headerlink&quot; title=&quot;Denoå­¦ä¹ è®°å½• ğŸ“˜&quot;&gt;&lt;/a&gt;Denoå­¦ä¹ è®°å½• ğŸ“˜&lt;/h1&gt;&lt;h1 id=&quot;ğŸ“±-Taro-å­¦ä¹ æ€»ç»“&quot;&gt;&lt;a href=&quot;#ğŸ“±-Ta</summary>
      
    
    
    
    
    <category term="Taro" scheme="https://aoayaoa.github.io/tags/Taro/"/>
    
  </entry>
  
  <entry>
    <title>æ€§èƒ½ä¼˜åŒ–</title>
    <link href="https://aoayaoa.github.io/2024/07/07/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"/>
    <id>https://aoayaoa.github.io/2024/07/07/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/</id>
    <published>2024-07-06T16:00:00.000Z</published>
    <updated>2025-04-16T04:38:58.278Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Web-æ€§èƒ½ä¼˜åŒ–å®Œå…¨æŒ‡å—"><a href="#Web-æ€§èƒ½ä¼˜åŒ–å®Œå…¨æŒ‡å—" class="headerlink" title="Web æ€§èƒ½ä¼˜åŒ–å®Œå…¨æŒ‡å—"></a>Web æ€§èƒ½ä¼˜åŒ–å®Œå…¨æŒ‡å—</h1><h2 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h2><ul><li><a href="#1-%E5%8A%A0%E8%BD%BD%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">1. åŠ è½½æ€§èƒ½ä¼˜åŒ–</a></li><li><a href="#2-%E6%B8%B2%E6%9F%93%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">2. æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–</a></li><li><a href="#3-%E8%B5%84%E6%BA%90%E4%BC%98%E5%8C%96">3. èµ„æºä¼˜åŒ–</a></li><li><a href="#4-%E7%BD%91%E7%BB%9C%E5%B1%82%E4%BC%98%E5%8C%96">4. ç½‘ç»œå±‚ä¼˜åŒ–</a></li><li><a href="#5-%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5">5. ç¼“å­˜ç­–ç•¥</a></li><li><a href="#6-%E6%A1%86%E6%9E%B6%E7%BA%A7%E4%BC%98%E5%8C%96">6. æ¡†æ¶çº§ä¼˜åŒ–</a></li><li><a href="#7-%E7%A7%BB%E5%8A%A8%E7%AB%AF%E4%B8%93%E9%A1%B9%E4%BC%98%E5%8C%96">7. ç§»åŠ¨ç«¯ä¸“é¡¹ä¼˜åŒ–</a></li><li><a href="#8-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%88%86%E6%9E%90">8. æ€§èƒ½ç›‘æ§ä¸åˆ†æ</a></li><li><a href="#9-%E8%BF%9B%E9%98%B6%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5">9. è¿›é˜¶ä¼˜åŒ–ç­–ç•¥</a></li><li><a href="#10-%E5%B7%A5%E5%85%B7%E9%93%BE%E6%8E%A8%E8%8D%90">10. å·¥å…·é“¾æ¨è</a></li></ul><p><a id="1-åŠ è½½æ€§èƒ½ä¼˜åŒ–"></a></p><h2 id="1-åŠ è½½æ€§èƒ½ä¼˜åŒ–"><a href="#1-åŠ è½½æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="1. åŠ è½½æ€§èƒ½ä¼˜åŒ–"></a>1. åŠ è½½æ€§èƒ½ä¼˜åŒ–</h2><h3 id="1-1-å…³é”®æ¸²æŸ“è·¯å¾„ä¼˜åŒ–"><a href="#1-1-å…³é”®æ¸²æŸ“è·¯å¾„ä¼˜åŒ–" class="headerlink" title="1.1 å…³é”®æ¸²æŸ“è·¯å¾„ä¼˜åŒ–"></a>1.1 å…³é”®æ¸²æŸ“è·¯å¾„ä¼˜åŒ–</h3><h4 id="1-1-1-CSSä¼˜åŒ–"><a href="#1-1-1-CSSä¼˜åŒ–" class="headerlink" title="1.1.1 CSSä¼˜åŒ–"></a>1.1.1 CSSä¼˜åŒ–</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. å†…è”å…³é”®CSS</span></span><br><span class="line">&lt;style&gt;</span><br><span class="line">  <span class="comment">/* é¦–å±å…³é”®æ ·å¼ */</span></span><br><span class="line">  .<span class="property">header</span> &#123; ... &#125;</span><br><span class="line">  .<span class="property">hero</span>-section &#123; ... &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. å¼‚æ­¥åŠ è½½éå…³é”®CSS</span></span><br><span class="line">&lt;link rel=&quot;preload&quot; href=&quot;critical.css&quot; as=&quot;style&quot; onload=&quot;this.rel=&#x27;stylesheet&#x27;&quot;&gt;</span><br><span class="line">&lt;noscript&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;critical.css&quot;&gt;&lt;/noscript&gt;</span><br><span class="line"></span><br><span class="line">// 3. åª’ä½“æŸ¥è¯¢ä¼˜åŒ–</span><br><span class="line">&lt;link rel=&quot;stylesheet&quot; href=&quot;print.css&quot; media=&quot;print&quot;&gt;</span><br><span class="line">&lt;link rel=&quot;stylesheet&quot; href=&quot;desktop.css&quot; media=&quot;(min-width: 1024px)&quot;&gt;</span><br></pre></td></tr></table></figure><h4 id="1-1-2-JavaScriptä¼˜åŒ–"><a href="#1-1-2-JavaScriptä¼˜åŒ–" class="headerlink" title="1.1.2 JavaScriptä¼˜åŒ–"></a>1.1.2 JavaScriptä¼˜åŒ–</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. è„šæœ¬åŠ è½½ç­–ç•¥</span></span><br><span class="line">&lt;script src=<span class="string">&quot;critical.js&quot;</span>&gt;&lt;<span class="regexp">/script&gt;           /</span>/ å…³é”®è„šæœ¬</span><br><span class="line">&lt;script src=<span class="string">&quot;app.js&quot;</span> defer&gt;&lt;<span class="regexp">/script&gt;          /</span>/ å»¶è¿Ÿæ‰§è¡Œ</span><br><span class="line">&lt;script src=<span class="string">&quot;analytics.js&quot;</span> <span class="keyword">async</span>&gt;&lt;<span class="regexp">/script&gt;    /</span>/ å¼‚æ­¥åŠ è½½</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. æ¨¡å—åŒ–åŠ è½½</span></span><br><span class="line">&lt;script type=<span class="string">&quot;module&quot;</span> src=<span class="string">&quot;app.mjs&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. æ¡ä»¶åŠ è½½</span></span><br><span class="line"><span class="keyword">if</span> (<span class="string">&#x27;IntersectionObserver&#x27;</span> <span class="keyword">in</span> <span class="variable language_">window</span>) &#123;</span><br><span class="line">  <span class="keyword">import</span>(<span class="string">&#x27;./lazyload.js&#x27;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">module</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// å®ç°æ‡’åŠ è½½</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-2-èµ„æºé¢„åŠ è½½ç­–ç•¥"><a href="#1-2-èµ„æºé¢„åŠ è½½ç­–ç•¥" class="headerlink" title="1.2 èµ„æºé¢„åŠ è½½ç­–ç•¥"></a>1.2 èµ„æºé¢„åŠ è½½ç­–ç•¥</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 1. DNSé¢„è§£æ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;dns-prefetch&quot;</span> <span class="attr">href</span>=<span class="string">&quot;//api.example.com&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 2. é¢„è¿æ¥ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;preconnect&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://cdn.example.com&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 3. é¢„åŠ è½½å…³é”®èµ„æº --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;preload&quot;</span> <span class="attr">href</span>=<span class="string">&quot;font.woff2&quot;</span> <span class="attr">as</span>=<span class="string">&quot;font&quot;</span> <span class="attr">type</span>=<span class="string">&quot;font/woff2&quot;</span> <span class="attr">crossorigin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;preload&quot;</span> <span class="attr">href</span>=<span class="string">&quot;hero-image.jpg&quot;</span> <span class="attr">as</span>=<span class="string">&quot;image&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 4. é¢„è·å–ä¸‹ä¸€é¡µèµ„æº --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;prefetch&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/next-page.js&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 5. é¢„æ¸²æŸ“ä¸‹ä¸€é¡µ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;prerender&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/likely-next-page.html&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="1-3-æ™ºèƒ½ä»£ç åˆ†å‰²"><a href="#1-3-æ™ºèƒ½ä»£ç åˆ†å‰²" class="headerlink" title="1.3 æ™ºèƒ½ä»£ç åˆ†å‰²"></a>1.3 æ™ºèƒ½ä»£ç åˆ†å‰²</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. è·¯ç”±çº§åˆ«åˆ†å‰²</span></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/dashboard&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(</span><br><span class="line">      <span class="comment">/* webpackChunkName: &quot;dashboard&quot; */</span></span><br><span class="line">      <span class="string">&#x27;./views/Dashboard.vue&#x27;</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. ç»„ä»¶çº§åˆ«åˆ†å‰²</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">HeavyComponent</span> = <span class="title class_">React</span>.<span class="title function_">lazy</span>(<span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;./HeavyComponent&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. æ¡ä»¶åˆ†å‰²</span></span><br><span class="line"><span class="keyword">if</span> (user.<span class="property">isPremium</span>) &#123;</span><br><span class="line">  <span class="keyword">import</span>(<span class="string">&#x27;./premium-features&#x27;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">module</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">module</span>.<span class="title function_">initPremiumFeatures</span>();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. åº“åˆ†å‰²</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">loadLuxuryFeatures</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">    <span class="keyword">import</span>(<span class="string">&#x27;chart.js&#x27;</span>),</span><br><span class="line">    <span class="keyword">import</span>(<span class="string">&#x27;@google/model-viewer&#x27;</span>)</span><br><span class="line">  ]).<span class="title function_">then</span>(<span class="function">(<span class="params">[Chart, ModelViewer]</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–é«˜çº§åŠŸèƒ½</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><a id="2-æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–"></a></p><h2 id="2-æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–"><a href="#2-æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="2. æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–"></a>2. æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–</h2><h3 id="2-1-DOMæ“ä½œä¼˜åŒ–"><a href="#2-1-DOMæ“ä½œä¼˜åŒ–" class="headerlink" title="2.1 DOMæ“ä½œä¼˜åŒ–"></a>2.1 DOMæ“ä½œä¼˜åŒ–</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. æ‰¹é‡DOMæ“ä½œ</span></span><br><span class="line"><span class="keyword">const</span> container = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;list&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fragment = <span class="variable language_">document</span>.<span class="title function_">createDocumentFragment</span>();</span><br><span class="line"><span class="keyword">const</span> items = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">1000</span>).<span class="title function_">fill</span>(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">requestAnimationFrame</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  items.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> li = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;li&#x27;</span>);</span><br><span class="line">    li.<span class="property">textContent</span> = <span class="string">`Item <span class="subst">$&#123;item&#125;</span>`</span>;</span><br><span class="line">    fragment.<span class="title function_">appendChild</span>(li);</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  container.<span class="title function_">appendChild</span>(fragment);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. è™šæ‹Ÿåˆ—è¡¨å®ç°</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VirtualList</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">container, items, rowHeight</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">container</span> = container;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">items</span> = items;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">rowHeight</span> = rowHeight;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">visibleItems</span> = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(container.<span class="property">clientHeight</span> / rowHeight);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scrollTop</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">startIndex</span> = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">init</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">container</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;scroll&#x27;</span>, <span class="variable language_">this</span>.<span class="property">onScroll</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>));</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">render</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">onScroll</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scrollTop</span> = <span class="variable language_">this</span>.<span class="property">container</span>.<span class="property">scrollTop</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">startIndex</span> = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="variable language_">this</span>.<span class="property">scrollTop</span> / <span class="variable language_">this</span>.<span class="property">rowHeight</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">render</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> visibleItems = <span class="variable language_">this</span>.<span class="property">items</span>.<span class="title function_">slice</span>(</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">startIndex</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">startIndex</span> + <span class="variable language_">this</span>.<span class="property">visibleItems</span></span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¸²æŸ“å¯è§†åŒºåŸŸå†…å®¹</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-CSSæ€§èƒ½ä¼˜åŒ–"><a href="#2-2-CSSæ€§èƒ½ä¼˜åŒ–" class="headerlink" title="2.2 CSSæ€§èƒ½ä¼˜åŒ–"></a>2.2 CSSæ€§èƒ½ä¼˜åŒ–</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 1. é€‰æ‹©å™¨ä¼˜åŒ– */</span></span><br><span class="line"><span class="comment">/* é¿å… */</span></span><br><span class="line"><span class="selector-tag">div</span><span class="selector-class">.header</span> <span class="selector-tag">ul</span> <span class="selector-tag">li</span> <span class="selector-tag">a</span> &#123; ... &#125;</span><br><span class="line"><span class="selector-id">#nav</span> <span class="selector-class">.list</span> <span class="selector-class">.item</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ¨è */</span></span><br><span class="line"><span class="selector-class">.nav-link</span> &#123; ... &#125;</span><br><span class="line"><span class="selector-class">.list-item</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 2. ç¡¬ä»¶åŠ é€Ÿ */</span></span><br><span class="line"><span class="selector-class">.hardware-accelerated</span> &#123;</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">translateZ</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="attribute">will-change</span>: transform;</span><br><span class="line">  <span class="attribute">backface-visibility</span>: hidden;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 3. åŠ¨ç”»æ€§èƒ½ä¼˜åŒ– */</span></span><br><span class="line"><span class="keyword">@keyframes</span> optimized-animation &#123;</span><br><span class="line">  <span class="selector-tag">from</span> &#123;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translateX</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="attribute">opacity</span>: <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-tag">to</span> &#123;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translateX</span>(<span class="number">100px</span>);</span><br><span class="line">    <span class="attribute">opacity</span>: <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.smooth-animation</span> &#123;</span><br><span class="line">  <span class="attribute">animation</span>: optimized-animation <span class="number">300ms</span> ease-out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 4. å…³é”®CSSå±æ€§ */</span></span><br><span class="line"><span class="selector-class">.performance-critical</span> &#123;</span><br><span class="line">  <span class="attribute">contain</span>: content;  <span class="comment">/* éš”ç¦»DOMå­æ ‘ */</span></span><br><span class="line">  <span class="attribute">content-visibility</span>: auto;  <span class="comment">/* æ™ºèƒ½æ¸²æŸ“ */</span></span><br><span class="line">  <span class="attribute">contain-intrinsic-size</span>: <span class="number">0</span> <span class="number">500px</span>;  <span class="comment">/* é¢„ä¼°å¤§å° */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-3-æ¸²æŸ“ä¼˜åŒ–ç­–ç•¥"><a href="#2-3-æ¸²æŸ“ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="2.3 æ¸²æŸ“ä¼˜åŒ–ç­–ç•¥"></a>2.3 æ¸²æŸ“ä¼˜åŒ–ç­–ç•¥</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. é¿å…å¼ºåˆ¶åŒæ­¥å¸ƒå±€</span></span><br><span class="line"><span class="keyword">const</span> cards = <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.card&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> heights = [];</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸å¥½çš„åšæ³•</span></span><br><span class="line">cards.<span class="title function_">forEach</span>(<span class="function"><span class="params">card</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> height = card.<span class="property">offsetHeight</span>;  <span class="comment">// å¼ºåˆ¶é‡æ’</span></span><br><span class="line">  card.<span class="property">style</span>.<span class="property">height</span> = <span class="string">`<span class="subst">$&#123;height * <span class="number">1.5</span>&#125;</span>px`</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¼˜åŒ–åçš„åšæ³•</span></span><br><span class="line"><span class="title function_">requestAnimationFrame</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// è¯»å–</span></span><br><span class="line">  cards.<span class="title function_">forEach</span>(<span class="function"><span class="params">card</span> =&gt;</span> &#123;</span><br><span class="line">    heights.<span class="title function_">push</span>(card.<span class="property">offsetHeight</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å†™å…¥</span></span><br><span class="line">  cards.<span class="title function_">forEach</span>(<span class="function">(<span class="params">card, i</span>) =&gt;</span> &#123;</span><br><span class="line">    card.<span class="property">style</span>.<span class="property">height</span> = <span class="string">`<span class="subst">$&#123;heights[i] * <span class="number">1.5</span>&#125;</span>px`</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. ä½¿ç”¨IntersectionObserverä¼˜åŒ–æ»šåŠ¨</span></span><br><span class="line"><span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">IntersectionObserver</span>(<span class="function">(<span class="params">entries</span>) =&gt;</span> &#123;</span><br><span class="line">  entries.<span class="title function_">forEach</span>(<span class="function"><span class="params">entry</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (entry.<span class="property">isIntersecting</span>) &#123;</span><br><span class="line">      entry.<span class="property">target</span>.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;visible&#x27;</span>);</span><br><span class="line">      observer.<span class="title function_">unobserve</span>(entry.<span class="property">target</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  <span class="attr">threshold</span>: <span class="number">0.1</span>,</span><br><span class="line">  <span class="attr">rootMargin</span>: <span class="string">&#x27;50px&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.lazy-load&#x27;</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">el</span> =&gt;</span> observer.<span class="title function_">observe</span>(el));</span><br></pre></td></tr></table></figure><p><a id="3-èµ„æºä¼˜åŒ–"></a></p><h2 id="3-èµ„æºä¼˜åŒ–"><a href="#3-èµ„æºä¼˜åŒ–" class="headerlink" title="3. èµ„æºä¼˜åŒ–"></a>3. èµ„æºä¼˜åŒ–</h2><h3 id="3-1-å›¾ç‰‡ä¼˜åŒ–ç­–ç•¥"><a href="#3-1-å›¾ç‰‡ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="3.1 å›¾ç‰‡ä¼˜åŒ–ç­–ç•¥"></a>3.1 å›¾ç‰‡ä¼˜åŒ–ç­–ç•¥</h3><table><thead><tr><th>æ ¼å¼</th><th>é€‚ç”¨åœºæ™¯</th><th>ä¼˜åŒ–å·¥å…·</th></tr></thead><tbody><tr><td>WebP</td><td>å…¨å¹³å°æ”¯æŒåœºæ™¯</td><td>cwebp</td></tr><tr><td>AVIF</td><td>ç°ä»£æµè§ˆå™¨</td><td>avifenc</td></tr><tr><td>æ¸è¿›å¼JPEG</td><td>å¤§å›¾åŠ è½½ä½“éªŒä¼˜åŒ–</td><td>jpegtran</td></tr></tbody></table><h3 id="3-2-å­—ä½“ä¼˜åŒ–"><a href="#3-2-å­—ä½“ä¼˜åŒ–" class="headerlink" title="3.2 å­—ä½“ä¼˜åŒ–"></a>3.2 å­—ä½“ä¼˜åŒ–</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@font-face</span> &#123;</span><br><span class="line">  <span class="attribute">font-family</span>: <span class="string">&#x27;CustomFont&#x27;</span>;</span><br><span class="line">  <span class="attribute">src</span>: <span class="built_in">url</span>(<span class="string">&#x27;font.woff2&#x27;</span>) <span class="built_in">format</span>(<span class="string">&#x27;woff2&#x27;</span>),</span><br><span class="line">       <span class="built_in">url</span>(<span class="string">&#x27;font.woff&#x27;</span>) <span class="built_in">format</span>(<span class="string">&#x27;woff&#x27;</span>);</span><br><span class="line">  <span class="attribute">font-display</span>: swap;</span><br><span class="line">  unicode-range: U+<span class="number">000</span>-<span class="number">5</span>FF;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a id="4-ç½‘ç»œå±‚ä¼˜åŒ–"></a></p><h2 id="4-ç½‘ç»œå±‚ä¼˜åŒ–"><a href="#4-ç½‘ç»œå±‚ä¼˜åŒ–" class="headerlink" title="4. ç½‘ç»œå±‚ä¼˜åŒ–"></a>4. ç½‘ç»œå±‚ä¼˜åŒ–</h2><h3 id="4-1-HTTP-2ä¼˜åŒ–"><a href="#4-1-HTTP-2ä¼˜åŒ–" class="headerlink" title="4.1 HTTP&#x2F;2ä¼˜åŒ–"></a>4.1 HTTP&#x2F;2ä¼˜åŒ–</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Nginxé…ç½®</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">443</span> ssl http2;</span><br><span class="line">  <span class="attribute">ssl_certificate</span> /path/to/cert.pem;</span><br><span class="line">  <span class="attribute">ssl_certificate_key</span> /path/to/key.pem;</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># å¯ç”¨æœåŠ¡å™¨æ¨é€</span></span><br><span class="line">  <span class="attribute">http2_push</span> /style.css;</span><br><span class="line">  <span class="attribute">http2_push</span> /app.js;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-CDNç­–ç•¥"><a href="#4-2-CDNç­–ç•¥" class="headerlink" title="4.2 CDNç­–ç•¥"></a>4.2 CDNç­–ç•¥</h3><pre><code class="highlight mermaid">graph TD  A[ç”¨æˆ·] --&gt; B[è¾¹ç¼˜èŠ‚ç‚¹]  B --&gt;|ç¼“å­˜å‘½ä¸­| C[å¿«é€Ÿå“åº”]  B --&gt;|ç¼“å­˜æœªå‘½ä¸­| D[å›æºæ‹‰å–]  D --&gt; E[æºç«™æœåŠ¡å™¨]</code></pre><p><a id="5-ç¼“å­˜ç­–ç•¥"></a></p><h2 id="5-ç¼“å­˜ç­–ç•¥"><a href="#5-ç¼“å­˜ç­–ç•¥" class="headerlink" title="5. ç¼“å­˜ç­–ç•¥"></a>5. ç¼“å­˜ç­–ç•¥</h2><h3 id="5-1-ç¼“å­˜å¤´è®¾ç½®"><a href="#5-1-ç¼“å­˜å¤´è®¾ç½®" class="headerlink" title="5.1 ç¼“å­˜å¤´è®¾ç½®"></a>5.1 ç¼“å­˜å¤´è®¾ç½®</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>public, max-age=31536000, immutable</span><br><span class="line"><span class="attribute">ETag</span><span class="punctuation">: </span>&quot;xyzzy&quot;</span><br><span class="line"><span class="attribute">Vary</span><span class="punctuation">: </span>Accept-Encoding</span><br></pre></td></tr></table></figure><h3 id="5-2-Service-Workerç¼“å­˜"><a href="#5-2-Service-Workerç¼“å­˜" class="headerlink" title="5.2 Service Workerç¼“å­˜"></a>5.2 Service Workerç¼“å­˜</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">CACHE_NAME</span> = <span class="string">&#x27;v1&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">ASSETS</span> = [<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;/app.js&#x27;</span>,<span class="string">&#x27;/style.css&#x27;</span>];</span><br><span class="line"></span><br><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;install&#x27;</span>, <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">  e.<span class="title function_">waitUntil</span>(</span><br><span class="line">    caches.<span class="title function_">open</span>(<span class="variable constant_">CACHE_NAME</span>)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function"><span class="params">cache</span> =&gt;</span> cache.<span class="title function_">addAll</span>(<span class="variable constant_">ASSETS</span>))</span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><a id="6-æ¡†æ¶çº§ä¼˜åŒ–"></a></p><h2 id="6-æ¡†æ¶çº§ä¼˜åŒ–"><a href="#6-æ¡†æ¶çº§ä¼˜åŒ–" class="headerlink" title="6. æ¡†æ¶çº§ä¼˜åŒ–"></a>6. æ¡†æ¶çº§ä¼˜åŒ–</h2><h3 id="6-1-Reactä¼˜åŒ–"><a href="#6-1-Reactä¼˜åŒ–" class="headerlink" title="6.1 Reactä¼˜åŒ–"></a>6.1 Reactä¼˜åŒ–</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨memoä¼˜åŒ–ç»„ä»¶</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MemoComponent</span> = <span class="title class_">React</span>.<span class="title function_">memo</span>(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> (</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;data&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">));</span><br><span class="line"></span><br><span class="line"><span class="comment">// è™šæ‹Ÿåˆ—è¡¨å®ç°</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">FixedSizeList</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react-window&#x27;</span>;</span><br></pre></td></tr></table></figure><h3 id="6-2-Vueä¼˜åŒ–"><a href="#6-2-Vueä¼˜åŒ–" class="headerlink" title="6.2 Vueä¼˜åŒ–"></a>6.2 Vueä¼˜åŒ–</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç»„ä»¶æ‡’åŠ è½½</span></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>, <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;./Home.vue&#x27;</span>) &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// å†»ç»“å¤§æ•°æ®</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">largeData</span> = <span class="title class_">Object</span>.<span class="title function_">freeze</span>(bigData);</span><br></pre></td></tr></table></figure><p><a id="7-ç§»åŠ¨ç«¯ä¸“é¡¹ä¼˜åŒ–"></a></p><h2 id="7-ç§»åŠ¨ç«¯ä¸“é¡¹ä¼˜åŒ–"><a href="#7-ç§»åŠ¨ç«¯ä¸“é¡¹ä¼˜åŒ–" class="headerlink" title="7. ç§»åŠ¨ç«¯ä¸“é¡¹ä¼˜åŒ–"></a>7. ç§»åŠ¨ç«¯ä¸“é¡¹ä¼˜åŒ–</h2><h3 id="7-1-é¦–å±åŠ é€Ÿ"><a href="#7-1-é¦–å±åŠ é€Ÿ" class="headerlink" title="7.1 é¦–å±åŠ é€Ÿ"></a>7.1 é¦–å±åŠ é€Ÿ</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- éª¨æ¶å± --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;skeleton&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;skeleton-header&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;skeleton-content&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="7-2-æ‰‹åŠ¿ä¼˜åŒ–"><a href="#7-2-æ‰‹åŠ¿ä¼˜åŒ–" class="headerlink" title="7.2 æ‰‹åŠ¿ä¼˜åŒ–"></a>7.2 æ‰‹åŠ¿ä¼˜åŒ–</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é˜²æŠ–å¤„ç†</span></span><br><span class="line"><span class="keyword">let</span> tapTimer;</span><br><span class="line">element.<span class="title function_">addEventListener</span>(<span class="string">&#x27;touchstart&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  tapTimer = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// å¤„ç†ç‚¹å‡»</span></span><br><span class="line">  &#125;, <span class="number">300</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">element.<span class="title function_">addEventListener</span>(<span class="string">&#x27;touchend&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">clearTimeout</span>(tapTimer);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><a id="8-æ€§èƒ½ç›‘æ§ä¸åˆ†æ"></a></p><h2 id="8-æ€§èƒ½ç›‘æ§ä¸åˆ†æ"><a href="#8-æ€§èƒ½ç›‘æ§ä¸åˆ†æ" class="headerlink" title="8. æ€§èƒ½ç›‘æ§ä¸åˆ†æ"></a>8. æ€§èƒ½ç›‘æ§ä¸åˆ†æ</h2><h3 id="8-1-æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡è¯¦è§£"><a href="#8-1-æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡è¯¦è§£" class="headerlink" title="8.1 æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡è¯¦è§£"></a>8.1 æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡è¯¦è§£</h3><table><thead><tr><th>æŒ‡æ ‡</th><th>å…¨ç§°</th><th>ä¸­æ–‡è§£é‡Š</th><th>ä¼˜åŒ–å»ºè®®</th><th>è¾¾æ ‡æ ‡å‡†</th><th>æµ‹é‡æ–¹å¼</th></tr></thead><tbody><tr><td><strong>FCP</strong></td><td>First Contentful Paint</td><td>é¦–æ¬¡å†…å®¹æ¸²æŸ“æ—¶é—´</td><td>1. ä¼˜åŒ–æœåŠ¡å™¨å“åº”æ—¶é—´<br>2. ç§»é™¤é˜»å¡æ¸²æŸ“çš„èµ„æº<br>3. å‹ç¼©CSS&#x2F;JSæ–‡ä»¶</td><td>&lt;1.8s</td><td><code>performance.getEntriesByName(&#39;first-contentful-paint&#39;)[0]</code></td></tr><tr><td><strong>LCP</strong></td><td>Largest Contentful Paint</td><td>æœ€å¤§å†…å®¹æ¸²æŸ“æ—¶é—´</td><td>1. ä¼˜åŒ–å›¾ç‰‡åŠ è½½<br>2. é¢„åŠ è½½å…³é”®èµ„æº<br>3. ä½¿ç”¨CDN</td><td>&lt;2.5s</td><td>PerformanceObserver API</td></tr><tr><td><strong>CLS</strong></td><td>Cumulative Layout Shift</td><td>ç´¯è®¡å¸ƒå±€åç§»</td><td>1. è®¾ç½®å›¾ç‰‡å°ºå¯¸<br>2. é¢„ç•™å¹¿å‘Šä½ç½®<br>3. ä½¿ç”¨transformåŠ¨ç”»</td><td>&lt;0.1</td><td>Layout Instability API</td></tr><tr><td><strong>TTI</strong></td><td>Time to Interactive</td><td>å¯äº¤äº’æ—¶é—´</td><td>1. å‡å°‘JavaScriptæ‰§è¡Œæ—¶é—´<br>2. å»¶è¿ŸåŠ è½½éå…³é”®èµ„æº<br>3. ä»£ç åˆ†å‰²</td><td>&lt;3.9s</td><td>web-vitalsåº“</td></tr><tr><td><strong>FID</strong></td><td>First Input Delay</td><td>é¦–æ¬¡è¾“å…¥å»¶è¿Ÿ</td><td>1. å‡å°‘ä¸»çº¿ç¨‹é˜»å¡<br>2. ä½¿ç”¨Web Workers<br>3. ä»£ç åˆ†å‰²</td><td>&lt;100ms</td><td>PerformanceObserver API</td></tr><tr><td><strong>TBT</strong></td><td>Total Blocking Time</td><td>æ€»é˜»å¡æ—¶é—´</td><td>1. ä¼˜åŒ–é•¿ä»»åŠ¡<br>2. ä½¿ç”¨requestIdleCallback<br>3. ä»£ç ä¼˜åŒ–</td><td>&lt;300ms</td><td>Performance API</td></tr><tr><td><strong>FMP</strong></td><td>First Meaningful Paint</td><td>é¦–æ¬¡æœ‰æ•ˆç»˜åˆ¶</td><td>1. æœåŠ¡ç«¯æ¸²æŸ“<br>2. é¢„æ¸²æŸ“<br>3. éª¨æ¶å±</td><td>&lt;2.0s</td><td>Chrome DevTools</td></tr></tbody></table><h3 id="8-2-å…¨é¢æ€§èƒ½ç›‘æ§å®ç°"><a href="#8-2-å…¨é¢æ€§èƒ½ç›‘æ§å®ç°" class="headerlink" title="8.2 å…¨é¢æ€§èƒ½ç›‘æ§å®ç°"></a>8.2 å…¨é¢æ€§èƒ½ç›‘æ§å®ç°</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. æ€§èƒ½æŒ‡æ ‡ç›‘æ§</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PerformanceMonitor</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">metrics</span> = &#123;&#125;;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">init</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// FCPå’ŒLCPç›‘æ§</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">PerformanceObserver</span>(<span class="function">(<span class="params">entryList</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> entry <span class="keyword">of</span> entryList.<span class="title function_">getEntries</span>()) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">metrics</span>[entry.<span class="property">name</span>] = entry.<span class="property">startTime</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">sendToAnalytics</span>(&#123;</span><br><span class="line">          <span class="attr">metric</span>: entry.<span class="property">name</span>,</span><br><span class="line">          <span class="attr">value</span>: entry.<span class="property">startTime</span></span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).<span class="title function_">observe</span>(&#123; <span class="attr">entryTypes</span>: [<span class="string">&#x27;paint&#x27;</span>, <span class="string">&#x27;largest-contentful-paint&#x27;</span>] &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CLSç›‘æ§</span></span><br><span class="line">    <span class="keyword">let</span> clsValue = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">PerformanceObserver</span>(<span class="function">(<span class="params">entryList</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> entry <span class="keyword">of</span> entryList.<span class="title function_">getEntries</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!entry.<span class="property">hadRecentInput</span>) &#123;</span><br><span class="line">          clsValue += entry.<span class="property">value</span>;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">CLS</span> = clsValue;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).<span class="title function_">observe</span>(&#123; <span class="attr">entryTypes</span>: [<span class="string">&#x27;layout-shift&#x27;</span>] &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é•¿ä»»åŠ¡ç›‘æ§</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">PerformanceObserver</span>(<span class="function">(<span class="params">entryList</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> entry <span class="keyword">of</span> entryList.<span class="title function_">getEntries</span>()) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">longTasks</span> = (<span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">longTasks</span> || <span class="number">0</span>) + <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).<span class="title function_">observe</span>(&#123; <span class="attr">entryTypes</span>: [<span class="string">&#x27;longtask&#x27;</span>] &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è‡ªå®šä¹‰æ€§èƒ½æ ‡è®°</span></span><br><span class="line">  <span class="title function_">mark</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    performance.<span class="title function_">mark</span>(name);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æµ‹é‡ä¸¤ä¸ªæ ‡è®°ä¹‹é—´çš„æ—¶é—´</span></span><br><span class="line">  <span class="title function_">measure</span>(<span class="params">name, startMark, endMark</span>) &#123;</span><br><span class="line">    performance.<span class="title function_">measure</span>(name, startMark, endMark);</span><br><span class="line">    <span class="keyword">const</span> duration = performance.<span class="title function_">getEntriesByName</span>(name)[<span class="number">0</span>].<span class="property">duration</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">sendToAnalytics</span>(&#123;</span><br><span class="line">      <span class="attr">metric</span>: name,</span><br><span class="line">      <span class="attr">value</span>: duration</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å‘é€æ•°æ®åˆ°åˆ†ææœåŠ¡</span></span><br><span class="line">  <span class="title function_">sendToAnalytics</span>(<span class="params">data</span>) &#123;</span><br><span class="line">    <span class="comment">// å®ç°æ•°æ®ä¸ŠæŠ¥é€»è¾‘</span></span><br><span class="line">    navigator.<span class="title function_">sendBeacon</span>(<span class="string">&#x27;/analytics&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. é”™è¯¯ç›‘æ§</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// é”™è¯¯ä¸ŠæŠ¥</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;JavaScript Error:&#x27;</span>, event.<span class="property">error</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;unhandledrejection&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// Promiseé”™è¯¯ä¸ŠæŠ¥</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Unhandled Promise Rejection:&#x27;</span>, event.<span class="property">reason</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. èµ„æºåŠ è½½ç›‘æ§</span></span><br><span class="line"><span class="keyword">const</span> resourceObserver = <span class="keyword">new</span> <span class="title class_">PerformanceObserver</span>(<span class="function">(<span class="params">list</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> entry <span class="keyword">of</span> list.<span class="title function_">getEntries</span>()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (entry.<span class="property">initiatorType</span> === <span class="string">&#x27;img&#x27;</span> || entry.<span class="property">initiatorType</span> === <span class="string">&#x27;script&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Resource <span class="subst">$&#123;entry.name&#125;</span> took <span class="subst">$&#123;entry.duration&#125;</span>ms to load`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">resourceObserver.<span class="title function_">observe</span>(&#123; <span class="attr">entryTypes</span>: [<span class="string">&#x27;resource&#x27;</span>] &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. ç½‘ç»œçŠ¶æ€ç›‘æ§</span></span><br><span class="line">navigator.<span class="property">connection</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;change&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> connection = navigator.<span class="property">connection</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Network type changed: <span class="subst">$&#123;connection.effectiveType&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><a id="9-è¿›é˜¶ä¼˜åŒ–ç­–ç•¥"></a></p><h2 id="9-è¿›é˜¶ä¼˜åŒ–ç­–ç•¥"><a href="#9-è¿›é˜¶ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="9. è¿›é˜¶ä¼˜åŒ–ç­–ç•¥"></a>9. è¿›é˜¶ä¼˜åŒ–ç­–ç•¥</h2><h3 id="9-1-é¢„æ¸²æŸ“"><a href="#9-1-é¢„æ¸²æŸ“" class="headerlink" title="9.1 é¢„æ¸²æŸ“"></a>9.1 é¢„æ¸²æŸ“</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Next.jsé™æ€ç”Ÿæˆ</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getStaticProps</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">fetchData</span>();</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">props</span>: &#123; data &#125; &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="9-2-è¾¹ç¼˜è®¡ç®—"><a href="#9-2-è¾¹ç¼˜è®¡ç®—" class="headerlink" title="9.2 è¾¹ç¼˜è®¡ç®—"></a>9.2 è¾¹ç¼˜è®¡ç®—</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cloudflare Workersç¤ºä¾‹</span></span><br><span class="line"><span class="title function_">addEventListener</span>(<span class="string">&#x27;fetch&#x27;</span>, <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">  event.<span class="title function_">respondWith</span>(<span class="title function_">handleRequest</span>(event.<span class="property">request</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">handleRequest</span>(<span class="params">request</span>) &#123;</span><br><span class="line">  <span class="comment">// è¾¹ç¼˜èŠ‚ç‚¹å¤„ç†é€»è¾‘</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a id="10-å·¥å…·é“¾æ¨è"></a></p><h2 id="10-å·¥å…·é“¾æ¨è"><a href="#10-å·¥å…·é“¾æ¨è" class="headerlink" title="10. å·¥å…·é“¾æ¨è"></a>10. å·¥å…·é“¾æ¨è</h2><h3 id="10-1-æ€§èƒ½åˆ†æå·¥å…·"><a href="#10-1-æ€§èƒ½åˆ†æå·¥å…·" class="headerlink" title="10.1 æ€§èƒ½åˆ†æå·¥å…·"></a>10.1 æ€§èƒ½åˆ†æå·¥å…·</h3><ul><li><strong>Lighthouse</strong>: å…¨é¢æ€§èƒ½å®¡è®¡</li><li><strong>WebPageTest</strong>: å¤šåœ°ç‚¹æµ‹è¯•</li><li><strong>Chrome DevTools</strong>: æ€§èƒ½é¢æ¿</li></ul><h3 id="10-2-æ„å»ºä¼˜åŒ–å·¥å…·"><a href="#10-2-æ„å»ºä¼˜åŒ–å·¥å…·" class="headerlink" title="10.2 æ„å»ºä¼˜åŒ–å·¥å…·"></a>10.2 æ„å»ºä¼˜åŒ–å·¥å…·</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨Viteè¿›è¡Œæ„å»º</span></span><br><span class="line">npm create vite@latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨Brotliå‹ç¼©</span></span><br><span class="line">npm install compression-webpack-plugin --save-dev</span><br></pre></td></tr></table></figure><h2 id="æœ€ä½³å®è·µåŸåˆ™"><a href="#æœ€ä½³å®è·µåŸåˆ™" class="headerlink" title="æœ€ä½³å®è·µåŸåˆ™"></a>æœ€ä½³å®è·µåŸåˆ™</h2><ol><li><p><strong>æ€§èƒ½é¢„ç®—åˆ¶å®š</strong></p><ul><li>è®¾ç½®å…·ä½“çš„æ€§èƒ½æŒ‡æ ‡ç›®æ ‡</li><li>å»ºç«‹CI&#x2F;CDä¸­çš„æ€§èƒ½æ£€æŸ¥ç‚¹</li><li>å®šæœŸè¿›è¡Œæ€§èƒ½å®¡è®¡</li></ul></li><li><p><strong>ç›‘æ§ä¸æŠ¥è­¦</strong></p><ul><li>å®æ—¶ç›‘æ§å…³é”®æ€§èƒ½æŒ‡æ ‡</li><li>è®¾ç½®åˆç†çš„æŠ¥è­¦é˜ˆå€¼</li><li>å»ºç«‹æ€§èƒ½åŠ£åŒ–é¢„è­¦æœºåˆ¶</li></ul></li><li><p><strong>ä¼˜åŒ–ç­–ç•¥åˆ†å±‚</strong></p><ul><li>ç½‘ç»œå±‚ï¼šCDNã€HTTP&#x2F;2ã€å‹ç¼©</li><li>èµ„æºå±‚ï¼šä»£ç åˆ†å‰²ã€å›¾ç‰‡ä¼˜åŒ–</li><li>æ¸²æŸ“å±‚ï¼šCSSä¼˜åŒ–ã€DOMæ“ä½œä¼˜åŒ–</li><li>è¿è¡Œæ—¶ï¼šJavaScriptæ‰§è¡Œä¼˜åŒ–</li></ul></li><li><p><strong>æŒç»­ä¼˜åŒ–æµç¨‹</strong></p><ul><li>æ€§èƒ½æ•°æ®æ”¶é›†</li><li>é—®é¢˜åˆ†æå®šä½</li><li>ä¼˜åŒ–æ–¹æ¡ˆå®æ–½</li><li>æ•ˆæœè¯„ä¼°å¤ç›˜</li></ul></li></ol><h2 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><p>âš ï¸ æ€§èƒ½ä¼˜åŒ–éœ€è¦æ•°æ®æ”¯æ’‘ï¼Œé¿å…ä¸»è§‚è‡†æ–­<br>âš ï¸ ä¼˜åŒ–æªæ–½è¦è€ƒè™‘æŠ•å…¥äº§å‡ºæ¯”<br>âš ï¸ ä¿æŒä»£ç å¯ç»´æŠ¤æ€§ï¼Œé¿å…è¿‡åº¦ä¼˜åŒ–<br>âš ï¸ ä¼˜å…ˆè§£å†³å¯¹ç”¨æˆ·ä½“éªŒå½±å“æœ€å¤§çš„é—®é¢˜<br>âš ï¸ å®šæœŸå›é¡¾å’Œæ›´æ–°ä¼˜åŒ–ç­–ç•¥</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Web-æ€§èƒ½ä¼˜åŒ–å®Œå…¨æŒ‡å—&quot;&gt;&lt;a href=&quot;#Web-æ€§èƒ½ä¼˜åŒ–å®Œå…¨æŒ‡å—&quot; class=&quot;headerlink&quot; title=&quot;Web æ€§èƒ½ä¼˜åŒ–å®Œå…¨æŒ‡å—&quot;&gt;&lt;/a&gt;Web æ€§èƒ½ä¼˜åŒ–å®Œå…¨æŒ‡å—&lt;/h1&gt;&lt;h2 id=&quot;ç›®å½•&quot;&gt;&lt;a href=&quot;#ç›®å½•&quot; class=&quot;</summary>
      
    
    
    
    
    <category term="æ€§èƒ½ä¼˜åŒ–" scheme="https://aoayaoa.github.io/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>Qiankun å¾®å‰ç«¯çš„ä½¿ç”¨</title>
    <link href="https://aoayaoa.github.io/2024/04/08/qiankun/"/>
    <id>https://aoayaoa.github.io/2024/04/08/qiankun/</id>
    <published>2024-04-07T16:00:00.000Z</published>
    <updated>2025-03-07T03:59:53.389Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Qiankun-å¾®å‰ç«¯ä¼ä¸šçº§å®è·µæŒ‡å—"><a href="#Qiankun-å¾®å‰ç«¯ä¼ä¸šçº§å®è·µæŒ‡å—" class="headerlink" title="Qiankun å¾®å‰ç«¯ä¼ä¸šçº§å®è·µæŒ‡å—"></a>Qiankun å¾®å‰ç«¯ä¼ä¸šçº§å®è·µæŒ‡å—</h1><h2 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h2><ol><li><a href="#%E4%B8%80%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE">åŸºç¡€é…ç½®</a></li><li><a href="#%E4%BA%8C%E9%80%9A%E4%BF%A1%E6%96%B9%E6%A1%88">é€šä¿¡æ–¹æ¡ˆ</a></li><li><a href="#%E4%B8%89%E8%B7%AF%E7%94%B1%E7%AE%A1%E7%90%86">è·¯ç”±ç®¡ç†</a></li><li><a href="#%E5%9B%9B%E6%A0%B7%E5%BC%8F%E9%9A%94%E7%A6%BB">æ ·å¼éš”ç¦»</a></li><li><a href="#%E4%BA%94%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">æ€§èƒ½ä¼˜åŒ–</a></li><li><a href="#%E5%85%AD%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">é—®é¢˜è§£å†³æ–¹æ¡ˆ</a></li><li><a href="#%E4%B8%83%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">æœ€ä½³å®è·µ</a></li><li><a href="#%E5%85%AB%E5%AD%90%E5%BA%94%E7%94%A8%E9%97%B4%E8%B7%B3%E8%BD%AC%E4%B8%8E%E4%BC%A0%E5%80%BC">å­åº”ç”¨é—´è·³è½¬ä¸ä¼ å€¼</a></li><li><a href="#%E4%B9%9D%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</a></li><li><a href="#%E5%8D%81%E6%80%BB%E7%BB%93%E4%B8%8E%E5%B1%95%E6%9C%9B">æ€»ç»“ä¸å±•æœ›</a></li><li><a href="#%E5%8D%81%E4%B8%80%E5%AD%90%E5%BA%94%E7%94%A8%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5">å­åº”ç”¨ä¼˜åŒ–ç­–ç•¥</a></li></ol><p><a id="ä¸€åŸºç¡€é…ç½®"></a></p><h2 id="ä¸€ã€åŸºç¡€é…ç½®"><a href="#ä¸€ã€åŸºç¡€é…ç½®" class="headerlink" title="ä¸€ã€åŸºç¡€é…ç½®"></a>ä¸€ã€åŸºç¡€é…ç½®</h2><h3 id="1-1-ä¸»åº”ç”¨åˆå§‹åŒ–"><a href="#1-1-ä¸»åº”ç”¨åˆå§‹åŒ–" class="headerlink" title="1.1 ä¸»åº”ç”¨åˆå§‹åŒ–"></a>1.1 ä¸»åº”ç”¨åˆå§‹åŒ–</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main-app.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; registerMicroApps, start &#125; <span class="keyword">from</span> <span class="string">&#x27;qiankun&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> apps = [</span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">name</span>: <span class="string">&#x27;sub-app&#x27;</span>,</span><br><span class="line"><span class="attr">entry</span>: process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;development&#x27;</span></span><br><span class="line">? <span class="string">&#x27;//localhost:7100&#x27;</span></span><br><span class="line">: <span class="string">&#x27;/sub-app/&#x27;</span>,</span><br><span class="line"><span class="attr">container</span>: <span class="string">&#x27;#subContainer&#x27;</span>,</span><br><span class="line"><span class="attr">activeRule</span>: <span class="string">&#x27;/sub&#x27;</span>,</span><br><span class="line"><span class="attr">props</span>: &#123;</span><br><span class="line"><span class="attr">basePath</span>: <span class="string">&#x27;/main-app/sub&#x27;</span>,</span><br><span class="line"><span class="attr">mainToken</span>: <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">];</span><br><span class="line"><span class="title function_">registerMicroApps</span>(apps);</span><br><span class="line"><span class="title function_">start</span>(&#123;</span><br><span class="line"><span class="attr">sandbox</span>: &#123;</span><br><span class="line"><span class="attr">strictStyleIsolation</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">experimentalStyleIsolation</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">speedy</span>: <span class="literal">false</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">prefetch</span>: <span class="string">&#x27;all&#x27;</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="1-2-å­åº”ç”¨æ¥å…¥è§„èŒƒ"><a href="#1-2-å­åº”ç”¨æ¥å…¥è§„èŒƒ" class="headerlink" title="1.2 å­åº”ç”¨æ¥å…¥è§„èŒƒ"></a>1.2 å­åº”ç”¨æ¥å…¥è§„èŒƒ</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sub-app.js</span></span><br><span class="line"><span class="keyword">let</span> vueInstance = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">bootstrap</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[SubApp] Bootstrap&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">mount</span>(<span class="params">props</span>) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[SubApp] Mount&#x27;</span>, props);</span><br><span class="line">vueInstance = <span class="title function_">createApp</span>(&#123;</span><br><span class="line"><span class="attr">router</span>: <span class="title function_">createRouter</span>(&#123;</span><br><span class="line"><span class="attr">history</span>: <span class="title function_">createWebHistory</span>(props.<span class="property">basePath</span>),</span><br><span class="line"><span class="attr">routes</span>: [</span><br><span class="line">&#123; <span class="attr">path</span>: <span class="string">&#x27;/page1&#x27;</span>, <span class="attr">component</span>: <span class="title class_">Page1</span> &#125;,</span><br><span class="line">&#123; <span class="attr">path</span>: <span class="string">&#x27;/page2&#x27;</span>, <span class="attr">component</span>: <span class="title class_">Page2</span> &#125;</span><br><span class="line">]</span><br><span class="line">&#125;)</span><br><span class="line">&#125;).<span class="title function_">mount</span>(props.<span class="property">container</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#app&#x27;</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">unmount</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[SubApp] Unmount&#x27;</span>);</span><br><span class="line">vueInstance.$destroy();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a id="äºŒé€šä¿¡æ–¹æ¡ˆ"></a></p><h2 id="äºŒã€é€šä¿¡æ–¹æ¡ˆ"><a href="#äºŒã€é€šä¿¡æ–¹æ¡ˆ" class="headerlink" title="äºŒã€é€šä¿¡æ–¹æ¡ˆ"></a>äºŒã€é€šä¿¡æ–¹æ¡ˆ</h2><h3 id="2-1-å…¨å±€çŠ¶æ€ç®¡ç†"><a href="#2-1-å…¨å±€çŠ¶æ€ç®¡ç†" class="headerlink" title="2.1 å…¨å±€çŠ¶æ€ç®¡ç†"></a>2.1 å…¨å±€çŠ¶æ€ç®¡ç†</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸»åº”ç”¨çŠ¶æ€åˆå§‹åŒ–</span></span><br><span class="line"><span class="keyword">const</span> actions = <span class="title function_">initGlobalState</span>(&#123;</span><br><span class="line"><span class="attr">user</span>: <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;user&#x27;</span>)),</span><br><span class="line"><span class="attr">token</span>: &#123;</span><br><span class="line"><span class="attr">value</span>: <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;token&#x27;</span>),</span><br><span class="line"><span class="attr">expire</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>() + <span class="number">3600000</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">systemTime</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// å­åº”ç”¨çŠ¶æ€åŒæ­¥</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">mount</span>(<span class="params">props</span>) &#123;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–åŒæ­¥</span></span><br><span class="line"><span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;token&#x27;</span>, props.<span class="title function_">getGlobalState</span>().<span class="property">token</span>.<span class="property">value</span>);</span><br><span class="line"><span class="comment">// åŠ¨æ€æ›´æ–°</span></span><br><span class="line">props.<span class="title function_">onGlobalStateChange</span>(<span class="function">(<span class="params">state, prev</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (state.<span class="property">token</span>.<span class="property">expire</span> !== prev.<span class="property">token</span>.<span class="property">expire</span>) &#123;</span><br><span class="line"><span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;token_expire&#x27;</span>, state.<span class="property">token</span>.<span class="property">expire</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-è·¨åº”ç”¨äº‹ä»¶æ€»çº¿"><a href="#2-2-è·¨åº”ç”¨äº‹ä»¶æ€»çº¿" class="headerlink" title="2.2 è·¨åº”ç”¨äº‹ä»¶æ€»çº¿"></a>2.2 è·¨åº”ç”¨äº‹ä»¶æ€»çº¿</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// event-bus.js</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CrossAppEvent</span> &#123;</span><br><span class="line"><span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">events</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">on</span>(<span class="params">eventName, callback</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> handlers = <span class="variable language_">this</span>.<span class="property">events</span>.<span class="title function_">get</span>(eventName) || [];</span><br><span class="line">handlers.<span class="title function_">push</span>(callback);</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">events</span>.<span class="title function_">set</span>(eventName, handlers);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">emit</span>(<span class="params">eventName, payload</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> handlers = <span class="variable language_">this</span>.<span class="property">events</span>.<span class="title function_">get</span>(eventName) || [];</span><br><span class="line">handlers.<span class="title function_">forEach</span>(<span class="function"><span class="params">handler</span> =&gt;</span> <span class="title function_">handler</span>(payload));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä¸»åº”ç”¨åˆå§‹åŒ–</span></span><br><span class="line"><span class="keyword">const</span> eventBus = <span class="keyword">new</span> <span class="title class_">CrossAppEvent</span>();</span><br><span class="line"><span class="comment">// å­åº”ç”¨Aå‘é€äº‹ä»¶</span></span><br><span class="line">eventBus.<span class="title function_">emit</span>(<span class="string">&#x27;ORDER_CREATED&#x27;</span>, &#123; <span class="attr">orderId</span>: <span class="number">12345</span> &#125;);</span><br><span class="line"><span class="comment">// å­åº”ç”¨Bç›‘å¬äº‹ä»¶</span></span><br><span class="line">eventBus.<span class="title function_">on</span>(<span class="string">&#x27;ORDER_CREATED&#x27;</span>, <span class="function">(<span class="params">payload</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ”¶åˆ°è®¢å•åˆ›å»ºäº‹ä»¶:&#x27;</span>, payload);</span><br><span class="line"><span class="title function_">refreshOrderList</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><a id="ä¸‰è·¯ç”±ç®¡ç†"></a></p><h2 id="ä¸‰ã€è·¯ç”±ç®¡ç†"><a href="#ä¸‰ã€è·¯ç”±ç®¡ç†" class="headerlink" title="ä¸‰ã€è·¯ç”±ç®¡ç†"></a>ä¸‰ã€è·¯ç”±ç®¡ç†</h2><h3 id="3-1-è·¯ç”±é…ç½®è§„èŒƒ"><a href="#3-1-è·¯ç”±é…ç½®è§„èŒƒ" class="headerlink" title="3.1 è·¯ç”±é…ç½®è§„èŒƒ"></a>3.1 è·¯ç”±é…ç½®è§„èŒƒ</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å­åº”ç”¨è·¯ç”±å®ˆå«</span></span><br><span class="line">router.<span class="title function_">beforeEach</span>(<span class="function">(<span class="params">to, <span class="keyword">from</span>, next</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">__POWERED_BY_QIANKUN__</span>) &#123;</span><br><span class="line"><span class="comment">// éªŒè¯è·¯ç”±åˆæ³•æ€§</span></span><br><span class="line"><span class="keyword">const</span> validPaths = [<span class="string">&#x27;/page1&#x27;</span>, <span class="string">&#x27;/page2&#x27;</span>, <span class="string">&#x27;/detail&#x27;</span>];</span><br><span class="line"><span class="keyword">const</span> isValid = validPaths.<span class="title function_">some</span>(<span class="function"><span class="params">path</span> =&gt;</span> to.<span class="property">path</span>.<span class="title function_">startsWith</span>(path));</span><br><span class="line"><span class="comment">// éªŒè¯Tokenæœ‰æ•ˆæ€§</span></span><br><span class="line"><span class="keyword">const</span> isAuthenticated = <span class="title function_">checkToken</span>(<span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;token&#x27;</span>));</span><br><span class="line"><span class="keyword">if</span> (!isValid || !isAuthenticated) &#123;</span><br><span class="line"><span class="title function_">next</span>(<span class="string">&#x27;/error&#x27;</span>);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">next</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸»åº”ç”¨è·¯ç”±è·³è½¬å°è£…</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">microAppNavigate</span> = (<span class="params">appName, path</span>) =&gt; &#123;</span><br><span class="line"><span class="keyword">const</span> appConfig = qiankunApps.<span class="title function_">find</span>(<span class="function"><span class="params">app</span> =&gt;</span> app.<span class="property">name</span> === appName);</span><br><span class="line"><span class="keyword">if</span> (appConfig) &#123;</span><br><span class="line">router.<span class="title function_">push</span>(<span class="string">`<span class="subst">$&#123;appConfig.activeRule&#125;</span><span class="subst">$&#123;path&#125;</span>`</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`æœªæ‰¾åˆ°åº”ç”¨ <span class="subst">$&#123;appName&#125;</span> çš„é…ç½®`</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="title function_">microAppNavigate</span>(<span class="string">&#x27;sub-app&#x27;</span>, <span class="string">&#x27;/page1&#x27;</span>);</span><br></pre></td></tr></table></figure><p><a id="å››æ ·å¼éš”ç¦»"></a></p><h2 id="å››ã€æ ·å¼éš”ç¦»"><a href="#å››ã€æ ·å¼éš”ç¦»" class="headerlink" title="å››ã€æ ·å¼éš”ç¦»"></a>å››ã€æ ·å¼éš”ç¦»</h2><h3 id="4-1-ç»„ä»¶åº“è§£å†³æ–¹æ¡ˆ"><a href="#4-1-ç»„ä»¶åº“è§£å†³æ–¹æ¡ˆ" class="headerlink" title="4.1 ç»„ä»¶åº“è§£å†³æ–¹æ¡ˆ"></a>4.1 ç»„ä»¶åº“è§£å†³æ–¹æ¡ˆ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- Element UI ç»„ä»¶ --&gt;</span><br><span class="line">&lt;el-date-picker</span><br><span class="line">:popper-append-to-body=&quot;false&quot;</span><br><span class="line">popper-class=&quot;micro-app-picker&quot;</span><br><span class="line">/&gt;</span><br><span class="line">&lt;!-- Ant Design ç»„ä»¶ --&gt;</span><br><span class="line">&lt;a-select</span><br><span class="line">:getPopupContainer=&quot;trigger =&gt; trigger.parentElement&quot;</span><br><span class="line">popupClassName=&quot;micro-app-select&quot;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure><h3 id="4-2-å…¨å±€æ ·å¼ç­–ç•¥"><a href="#4-2-å…¨å±€æ ·å¼ç­–ç•¥" class="headerlink" title="4.2 å…¨å±€æ ·å¼ç­–ç•¥"></a>4.2 å…¨å±€æ ·å¼ç­–ç•¥</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å¾®åº”ç”¨å®¹å™¨æ ·å¼éš”ç¦» */</span></span><br><span class="line"><span class="selector-id">#sub-container</span> &#123;</span><br><span class="line"><span class="attribute">all</span>: initial; <span class="comment">/* é‡ç½®ç»§æ‰¿æ ·å¼ */</span></span><br><span class="line"><span class="comment">/* é™åˆ¶æ ·å¼ä½œç”¨åŸŸ */</span></span><br><span class="line">* &#123;</span><br><span class="line"><span class="attribute">box-sizing</span>: border-box;</span><br><span class="line"><span class="attribute">font-family</span>: inherit;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* å¼¹å‡ºå±‚æ ·å¼é‡ç½® */</span></span><br><span class="line"><span class="selector-class">.micro-app-picker</span> &#123;</span><br><span class="line"><span class="attribute">z-index</span>: <span class="number">1000</span> <span class="meta">!important</span>;</span><br><span class="line"><span class="attribute">position</span>: absolute <span class="meta">!important</span>;</span><br><span class="line"><span class="selector-class">.el-picker__popper</span> &#123;</span><br><span class="line"><span class="attribute">transform</span>: none <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a id="äº”æ€§èƒ½ä¼˜åŒ–"></a></p><h2 id="äº”ã€æ€§èƒ½ä¼˜åŒ–"><a href="#äº”ã€æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="äº”ã€æ€§èƒ½ä¼˜åŒ–"></a>äº”ã€æ€§èƒ½ä¼˜åŒ–</h2><h3 id="5-1-èµ„æºåŠ è½½ç­–ç•¥"><a href="#5-1-èµ„æºåŠ è½½ç­–ç•¥" class="headerlink" title="5.1 èµ„æºåŠ è½½ç­–ç•¥"></a>5.1 èµ„æºåŠ è½½ç­–ç•¥</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŒ‰éœ€åŠ è½½é…ç½®</span></span><br><span class="line"><span class="title function_">start</span>(&#123;</span><br><span class="line"><span class="attr">prefetch</span>: <span class="function">(<span class="params">apps</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">const</span> hotApps = [<span class="string">&#x27;dashboard&#x27;</span>, <span class="string">&#x27;monitor&#x27;</span>];</span><br><span class="line"><span class="keyword">return</span> apps.<span class="title function_">filter</span>(<span class="function"><span class="params">app</span> =&gt;</span> hotApps.<span class="title function_">includes</span>(app.<span class="property">name</span>));</span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">sandbox</span>: &#123;</span><br><span class="line"><span class="attr">experimentalStyleIsolation</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="5-2-å†…å­˜ä¼˜åŒ–æ–¹æ¡ˆ"><a href="#5-2-å†…å­˜ä¼˜åŒ–æ–¹æ¡ˆ" class="headerlink" title="5.2 å†…å­˜ä¼˜åŒ–æ–¹æ¡ˆ"></a>5.2 å†…å­˜ä¼˜åŒ–æ–¹æ¡ˆ</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å­åº”ç”¨å¸è½½å¤„ç†</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">unmount</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="comment">// æ¸…ç†äº‹ä»¶ç›‘å¬</span></span><br><span class="line">eventBus.<span class="title function_">offAll</span>();</span><br><span class="line"><span class="comment">// é‡Šæ”¾å†…å­˜</span></span><br><span class="line">vueInstance.$destroy();</span><br><span class="line">vueInstance = <span class="literal">null</span>;</span><br><span class="line"><span class="comment">// æ¸…ç†å…¨å±€çŠ¶æ€</span></span><br><span class="line">actions.<span class="title function_">offGlobalStateChange</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a id="å…­é—®é¢˜è§£å†³æ–¹æ¡ˆ"></a></p><h2 id="å…­ã€é—®é¢˜è§£å†³æ–¹æ¡ˆ"><a href="#å…­ã€é—®é¢˜è§£å†³æ–¹æ¡ˆ" class="headerlink" title="å…­ã€é—®é¢˜è§£å†³æ–¹æ¡ˆ"></a>å…­ã€é—®é¢˜è§£å†³æ–¹æ¡ˆ</h2><h3 id="6-1-å¸¸è§é—®é¢˜é€ŸæŸ¥è¡¨"><a href="#6-1-å¸¸è§é—®é¢˜é€ŸæŸ¥è¡¨" class="headerlink" title="6.1 å¸¸è§é—®é¢˜é€ŸæŸ¥è¡¨"></a>6.1 å¸¸è§é—®é¢˜é€ŸæŸ¥è¡¨</h3><table><thead><tr><th>é—®é¢˜ç°è±¡</th><th>è§£å†³æ–¹æ¡ˆ</th><th>ç›¸å…³æ–‡ä»¶</th></tr></thead><tbody><tr><td>æ ·å¼æ±¡æŸ“</td><td>ä¸¥æ ¼æ ·å¼éš”ç¦» + ç»„ä»¶çº§é…ç½®</td><td><code>src/styles/global.css</code></td></tr><tr><td>è·¯ç”±è·³è½¬å¤±æ•ˆ</td><td>åŠ¨æ€basePath + è·¯ç”±å®ˆå«å¢å¼º</td><td><code>src/router/index.js</code></td></tr><tr><td>Tokenä¸åŒæ­¥</td><td>å…¨å±€çŠ¶æ€ç®¡ç† + å®šæ—¶åˆ·æ–°</td><td><code>src/utils/auth.js</code></td></tr><tr><td>å†…å­˜æ³„æ¼</td><td>ä¸¥æ ¼å¸è½½å¤„ç† + å†…å­˜åˆ†æå·¥å…·</td><td><code>src/main.js</code></td></tr></tbody></table><h3 id="6-2-é”™è¯¯ç›‘æ§æ–¹æ¡ˆ"><a href="#6-2-é”™è¯¯ç›‘æ§æ–¹æ¡ˆ" class="headerlink" title="6.2 é”™è¯¯ç›‘æ§æ–¹æ¡ˆ"></a>6.2 é”™è¯¯ç›‘æ§æ–¹æ¡ˆ</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…¨å±€é”™è¯¯å¤„ç†</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="title function_">trackError</span>(&#123;</span><br><span class="line"><span class="attr">type</span>: <span class="string">&#x27;RUNTIME_ERROR&#x27;</span>,</span><br><span class="line"><span class="attr">message</span>: event.<span class="property">message</span>,</span><br><span class="line"><span class="attr">stack</span>: event.<span class="property">error</span>.<span class="property">stack</span>,</span><br><span class="line"><span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Qiankuné”™è¯¯æ•è·</span></span><br><span class="line"><span class="title function_">start</span>(&#123;</span><br><span class="line"><span class="attr">onError</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;å¾®åº”ç”¨åŠ è½½å¤±è´¥:&#x27;</span>, err);</span><br><span class="line"><span class="title function_">showErrorNotification</span>(&#123;</span><br><span class="line"><span class="attr">title</span>: <span class="string">&#x27;ç³»ç»ŸåŠ è½½å¤±è´¥&#x27;</span>,</span><br><span class="line"><span class="attr">content</span>: <span class="string">&#x27;è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><a id="ä¸ƒæœ€ä½³å®è·µ"></a></p><h2 id="ä¸ƒã€æœ€ä½³å®è·µ"><a href="#ä¸ƒã€æœ€ä½³å®è·µ" class="headerlink" title="ä¸ƒã€æœ€ä½³å®è·µ"></a>ä¸ƒã€æœ€ä½³å®è·µ</h2><h3 id="7-1-æ¶æ„è§„èŒƒ"><a href="#7-1-æ¶æ„è§„èŒƒ" class="headerlink" title="7.1 æ¶æ„è§„èŒƒ"></a>7.1 æ¶æ„è§„èŒƒ</h3><pre><code class="highlight mermaid">graph TDA[ä¸»åº”ç”¨] --&gt; B(ç”¨æˆ·ä¸­å¿ƒ)A --&gt; C(è®¢å•ç³»ç»Ÿ)A --&gt; D(ç›‘æ§å¹³å°)B --&gt; E(æƒé™ç®¡ç†)C --&gt; F(æ”¯ä»˜æ¨¡å—)D --&gt; G(æ—¥å¿—åˆ†æ)F --&gt; H(ç¬¬ä¸‰æ–¹æ”¯ä»˜)G --&gt; I(æ•°æ®åˆ†æ)</code></pre><h3 id="7-2-æ€§èƒ½æŒ‡æ ‡"><a href="#7-2-æ€§èƒ½æŒ‡æ ‡" class="headerlink" title="7.2 æ€§èƒ½æŒ‡æ ‡"></a>7.2 æ€§èƒ½æŒ‡æ ‡</h3><table><thead><tr><th>æŒ‡æ ‡</th><th>æ ‡å‡†å€¼</th><th>ç›‘æ§å·¥å…·</th><th>æŠ¥è­¦é˜ˆå€¼</th></tr></thead><tbody><tr><td>åŠ è½½æ—¶é—´</td><td>&lt;1.5s</td><td>Lighthouse</td><td>&gt;3s</td></tr><tr><td>å†…å­˜å ç”¨</td><td>&lt;200MB</td><td>Chrome DevTools</td><td>&gt;300MB</td></tr><tr><td>FCP</td><td>&lt;1.2s</td><td>Web Vitals</td><td>&gt;2s</td></tr><tr><td>APIæˆåŠŸç‡</td><td>&gt;99.9%</td><td>Prometheus</td><td>&lt;99%</td></tr></tbody></table><h3 id="7-3-æœªæ¥æ¼”è¿›"><a href="#7-3-æœªæ¥æ¼”è¿›" class="headerlink" title="7.3 æœªæ¥æ¼”è¿›"></a>7.3 æœªæ¥æ¼”è¿›</h3><ol><li><strong>åŠ¨æ€æ¨¡å—åŠ è½½</strong></li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŠ¨æ€åŠ è½½ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">loadModule</span> = <span class="keyword">async</span> (<span class="params">moduleName</span>) =&gt; &#123;</span><br><span class="line"><span class="keyword">const</span> &#123; bootstrap, mount, unmount &#125; = <span class="keyword">await</span> <span class="keyword">import</span>(<span class="string">`./modules/<span class="subst">$&#123;moduleName&#125;</span>`</span>);</span><br><span class="line"><span class="keyword">return</span> &#123; bootstrap, mount, unmount &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title function_">registerMicroApps</span>([</span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">name</span>: <span class="string">&#x27;dynamic-module&#x27;</span>,</span><br><span class="line"><span class="attr">entry</span>: <span class="function">() =&gt;</span> <span class="title function_">loadModule</span>(<span class="string">&#x27;analytics&#x27;</span>),</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line">]);</span><br></pre></td></tr></table></figure><ol start="2"><li><strong>å¾®å‰ç«¯DevTools</strong></li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¼€å‘å·¥å…·é›†æˆ</span></span><br><span class="line"><span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;development&#x27;</span>) &#123;</span><br><span class="line"><span class="keyword">import</span>(<span class="string">&#x27;qiankun-devtools&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; init &#125;</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="title function_">init</span>(&#123;</span><br><span class="line"><span class="attr">traceDeps</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">logComm</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">perfMonitor</span>: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a id="å…«å­åº”ç”¨é—´è·³è½¬ä¸ä¼ å€¼"></a></p><h2 id="å…«ã€å­åº”ç”¨é—´è·³è½¬ä¸ä¼ å€¼"><a href="#å…«ã€å­åº”ç”¨é—´è·³è½¬ä¸ä¼ å€¼" class="headerlink" title="å…«ã€å­åº”ç”¨é—´è·³è½¬ä¸ä¼ å€¼"></a>å…«ã€å­åº”ç”¨é—´è·³è½¬ä¸ä¼ å€¼</h2><h3 id="8-1-å­åº”ç”¨é—´è·³è½¬æ–¹æ¡ˆ"><a href="#8-1-å­åº”ç”¨é—´è·³è½¬æ–¹æ¡ˆ" class="headerlink" title="8.1 å­åº”ç”¨é—´è·³è½¬æ–¹æ¡ˆ"></a>8.1 å­åº”ç”¨é—´è·³è½¬æ–¹æ¡ˆ</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸»åº”ç”¨ä¸­å®šä¹‰ç»Ÿä¸€è·³è½¬æœåŠ¡</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AppNavigationService</span> &#123;</span><br><span class="line"><span class="title function_">constructor</span>(<span class="params">apps, router</span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">apps</span> = apps;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">router</span> = router;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·³è½¬åˆ°æŒ‡å®šåº”ç”¨çš„æŒ‡å®šè·¯å¾„</span></span><br><span class="line"><span class="title function_">navigateTo</span>(<span class="params">appName, path, query = &#123;&#125;</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> app = <span class="variable language_">this</span>.<span class="property">apps</span>.<span class="title function_">find</span>(<span class="function"><span class="params">a</span> =&gt;</span> a.<span class="property">name</span> === appName);</span><br><span class="line"><span class="keyword">if</span> (!app) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`åº”ç”¨ <span class="subst">$&#123;appName&#125;</span> ä¸å­˜åœ¨`</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ„å»ºå®Œæ•´è·¯å¾„</span></span><br><span class="line"><span class="keyword">const</span> queryString = <span class="title class_">Object</span>.<span class="title function_">keys</span>(query).<span class="property">length</span></span><br><span class="line">? <span class="string">`?<span class="subst">$&#123;<span class="keyword">new</span> URLSearchParams(query)&#125;</span>`</span></span><br><span class="line">: <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> fullPath = <span class="string">`<span class="subst">$&#123;app.activeRule&#125;</span><span class="subst">$&#123;path&#125;</span><span class="subst">$&#123;queryString&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">router</span>.<span class="title function_">push</span>(fullPath);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ä¾‹åŒ–å¯¼èˆªæœåŠ¡</span></span><br><span class="line"><span class="keyword">const</span> navigationService = <span class="keyword">new</span> <span class="title class_">AppNavigationService</span>(apps, router);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å­åº”ç”¨ä¸­æ³¨å…¥å¯¼èˆªæœåŠ¡</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">mount</span>(<span class="params">props</span>) &#123;</span><br><span class="line">props.<span class="property">navigationService</span> = navigationService;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å­åº”ç”¨ä¸­ä½¿ç”¨</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">jumpToAnotherApp</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">props.<span class="property">navigationService</span>.<span class="title function_">navigateTo</span>(<span class="string">&#x27;another-app&#x27;</span>, <span class="string">&#x27;/dashboard&#x27;</span>, &#123; <span class="attr">id</span>: <span class="number">123</span> &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="8-2-å­åº”ç”¨é—´æ•°æ®ä¼ é€’"><a href="#8-2-å­åº”ç”¨é—´æ•°æ®ä¼ é€’" class="headerlink" title="8.2 å­åº”ç”¨é—´æ•°æ®ä¼ é€’"></a>8.2 å­åº”ç”¨é—´æ•°æ®ä¼ é€’</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–¹æ¡ˆä¸€ï¼šé€šè¿‡å…¨å±€çŠ¶æ€</span></span><br><span class="line"><span class="comment">// å­åº”ç”¨Aä¸­è®¾ç½®æ•°æ®</span></span><br><span class="line">props.<span class="title function_">setGlobalState</span>(&#123;</span><br><span class="line"><span class="attr">transferData</span>: &#123;</span><br><span class="line"><span class="attr">type</span>: <span class="string">&#x27;ORDER_DATA&#x27;</span>,</span><br><span class="line"><span class="attr">payload</span>: &#123; <span class="attr">orderId</span>: <span class="number">12345</span> &#125;,</span><br><span class="line"><span class="attr">targetApp</span>: <span class="string">&#x27;another-app&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å­åº”ç”¨Bä¸­æ¥æ”¶æ•°æ®</span></span><br><span class="line">props.<span class="title function_">onGlobalStateChange</span>(<span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (state.<span class="property">transferData</span> &amp;&amp; state.<span class="property">transferData</span>.<span class="property">targetApp</span> === <span class="string">&#x27;another-app&#x27;</span>) &#123;</span><br><span class="line"><span class="title function_">handleReceivedData</span>(state.<span class="property">transferData</span>.<span class="property">payload</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–¹æ¡ˆäºŒï¼šé€šè¿‡URLå‚æ•°</span></span><br><span class="line"><span class="comment">// å­åº”ç”¨Aè·³è½¬æ—¶æºå¸¦æ•°æ®</span></span><br><span class="line">props.<span class="property">navigationService</span>.<span class="title function_">navigateTo</span>(<span class="string">&#x27;another-app&#x27;</span>, <span class="string">&#x27;/detail&#x27;</span>, &#123;</span><br><span class="line"><span class="attr">orderId</span>: <span class="number">12345</span>,</span><br><span class="line"><span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å­åº”ç”¨Bæ¥æ”¶URLå‚æ•°</span></span><br><span class="line"><span class="keyword">const</span> route = <span class="title function_">useRoute</span>();</span><br><span class="line"><span class="keyword">const</span> orderId = route.<span class="property">query</span>.<span class="property">orderId</span>;</span><br></pre></td></tr></table></figure><h3 id="8-3-æ•°æ®æŒä¹…åŒ–ç­–ç•¥"><a href="#8-3-æ•°æ®æŒä¹…åŒ–ç­–ç•¥" class="headerlink" title="8.3 æ•°æ®æŒä¹…åŒ–ç­–ç•¥"></a>8.3 æ•°æ®æŒä¹…åŒ–ç­–ç•¥</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨localStorageä¸sessionStorage</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">saveAppState</span> = (<span class="params">appName, state</span>) =&gt; &#123;</span><br><span class="line"><span class="keyword">const</span> key = <span class="string">`MICRO_APP_<span class="subst">$&#123;appName&#125;</span>_STATE`</span>;</span><br><span class="line"><span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(key, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line"><span class="attr">data</span>: state,</span><br><span class="line"><span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">&#125;));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getAppState</span> = (<span class="params">appName</span>) =&gt; &#123;</span><br><span class="line"><span class="keyword">const</span> key = <span class="string">`MICRO_APP_<span class="subst">$&#123;appName&#125;</span>_STATE`</span>;</span><br><span class="line"><span class="keyword">const</span> stateStr = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(key);</span><br><span class="line"><span class="keyword">if</span> (!stateStr) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">const</span> state = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(stateStr);</span><br><span class="line"><span class="comment">// æ£€æŸ¥æ•°æ®æ˜¯å¦è¿‡æœŸï¼ˆ30åˆ†é’Ÿï¼‰</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title class_">Date</span>.<span class="title function_">now</span>() - state.<span class="property">timestamp</span> &gt; <span class="number">30</span> * <span class="number">60</span> * <span class="number">1000</span>) &#123;</span><br><span class="line"><span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(key);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> state.<span class="property">data</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><a id="ä¹å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ"></a></p><h2 id="ä¹ã€å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ"><a href="#ä¹ã€å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ" class="headerlink" title="ä¹ã€å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ"></a>ä¹ã€å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</h2><h3 id="9-1-å­åº”ç”¨åŠ è½½ä¸»åº”ç”¨è·¯ç”±çš„é—®é¢˜"><a href="#9-1-å­åº”ç”¨åŠ è½½ä¸»åº”ç”¨è·¯ç”±çš„é—®é¢˜" class="headerlink" title="9.1 å­åº”ç”¨åŠ è½½ä¸»åº”ç”¨è·¯ç”±çš„é—®é¢˜"></a>9.1 å­åº”ç”¨åŠ è½½ä¸»åº”ç”¨è·¯ç”±çš„é—®é¢˜</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é—®é¢˜ï¼šå­åº”ç”¨é”™è¯¯åŠ è½½äº†ä¸»åº”ç”¨çš„è·¯ç”±ç»„ä»¶</span></span><br><span class="line"><span class="comment">// åŸå› ï¼šè·¯ç”±å‰ç¼€é…ç½®ä¸æ­£ç¡®ï¼Œå¯¼è‡´è·¯å¾„åŒ¹é…æ··ä¹±</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è§£å†³æ–¹æ¡ˆä¸€ï¼šä¸¥æ ¼çš„è·¯ç”±å®ˆå«</span></span><br><span class="line">router.<span class="title function_">beforeEach</span>(<span class="function">(<span class="params">to, <span class="keyword">from</span>, next</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// æ£€æµ‹æ˜¯å¦åœ¨qiankunç¯å¢ƒä¸­</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">__POWERED_BY_QIANKUN__</span>) &#123;</span><br><span class="line"><span class="comment">// æ£€æµ‹å½“å‰è·¯å¾„æ˜¯å¦åˆæ³•</span></span><br><span class="line"><span class="keyword">const</span> appPrefix = <span class="string">&#x27;/sub-app&#x27;</span>; <span class="comment">// å­åº”ç”¨è·¯å¾„å‰ç¼€</span></span><br><span class="line"><span class="keyword">if</span> (!to.<span class="property">path</span>.<span class="title function_">startsWith</span>(appPrefix)) &#123;</span><br><span class="line"><span class="comment">// è·¯å¾„ä¸åˆæ³•ï¼Œé‡å®šå‘åˆ°å­åº”ç”¨é¦–é¡µ</span></span><br><span class="line"><span class="title function_">next</span>(<span class="string">`<span class="subst">$&#123;appPrefix&#125;</span>/home`</span>);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">next</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§£å†³æ–¹æ¡ˆäºŒï¼šä¿®æ­£è·¯ç”±baseé…ç½®</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line"><span class="attr">history</span>: <span class="title function_">createWebHistory</span>(</span><br><span class="line"><span class="variable language_">window</span>.<span class="property">__POWERED_BY_QIANKUN__</span></span><br><span class="line">? <span class="variable language_">window</span>.<span class="property">__INJECTED_PUBLIC_PATH_BY_QIANKUN__</span> <span class="comment">// ä½¿ç”¨qiankunæ³¨å…¥çš„è·¯å¾„</span></span><br><span class="line">: <span class="string">&#x27;/&#x27;</span></span><br><span class="line">),</span><br><span class="line"><span class="attr">routes</span>: [...]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="9-2-Tokenæ—¶é—´ä¸ç»Ÿä¸€é—®é¢˜"><a href="#9-2-Tokenæ—¶é—´ä¸ç»Ÿä¸€é—®é¢˜" class="headerlink" title="9.2 Tokenæ—¶é—´ä¸ç»Ÿä¸€é—®é¢˜"></a>9.2 Tokenæ—¶é—´ä¸ç»Ÿä¸€é—®é¢˜</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é—®é¢˜ï¼šå¤šä¸ªå­åº”ç”¨çš„tokenè¿‡æœŸæ—¶é—´ä¸ä¸€è‡´</span></span><br><span class="line"><span class="comment">// è§£å†³æ–¹æ¡ˆï¼šä¸»åº”ç”¨ç»´æŠ¤ç»Ÿä¸€çš„tokenåˆ·æ–°æœºåˆ¶</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸»åº”ç”¨ä¸­å®šä¹‰tokenç®¡ç†æœåŠ¡</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TokenService</span> &#123;</span><br><span class="line"><span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">tokenInfo</span> = &#123;</span><br><span class="line"><span class="attr">value</span>: <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;token&#x27;</span>),</span><br><span class="line"><span class="attr">expire</span>: <span class="built_in">parseInt</span>(<span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;token_expire&#x27;</span>) || <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šæ—¶æ£€æŸ¥tokenæ˜¯å¦å³å°†è¿‡æœŸ</span></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">checkTokenExpiration</span>(), <span class="number">60000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸ</span></span><br><span class="line"><span class="title function_">checkTokenExpiration</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> now = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line"><span class="keyword">const</span> timeToExpire = <span class="variable language_">this</span>.<span class="property">tokenInfo</span>.<span class="property">expire</span> - now;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœtokenå°†åœ¨15åˆ†é’Ÿå†…è¿‡æœŸï¼Œåˆ·æ–°token</span></span><br><span class="line"><span class="keyword">if</span> (timeToExpire &gt; <span class="number">0</span> &amp;&amp; timeToExpire &lt; <span class="number">15</span> * <span class="number">60</span> * <span class="number">1000</span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">refreshToken</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ·æ–°token</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">refreshToken</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;/api/refresh-token&#x27;</span>, &#123;</span><br><span class="line"><span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line"><span class="attr">headers</span>: &#123;</span><br><span class="line"><span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Authorization&#x27;</span>: <span class="string">`Bearer <span class="subst">$&#123;<span class="variable language_">this</span>.tokenInfo.value&#125;</span>`</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line"><span class="keyword">if</span> (data.<span class="property">success</span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">updateToken</span>(data.<span class="property">token</span>, data.<span class="property">expire</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;åˆ·æ–°tokenå¤±è´¥:&#x27;</span>, error);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ›´æ–°token</span></span><br><span class="line"><span class="title function_">updateToken</span>(<span class="params">token, expire</span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">tokenInfo</span> = &#123; <span class="attr">value</span>: token, expire &#125;;</span><br><span class="line"><span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;token&#x27;</span>, token);</span><br><span class="line"><span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;token_expire&#x27;</span>, expire.<span class="title function_">toString</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šçŸ¥æ‰€æœ‰åº”ç”¨tokenå·²æ›´æ–°</span></span><br><span class="line">actions.<span class="title function_">setGlobalState</span>(&#123;</span><br><span class="line"><span class="attr">tokenUpdated</span>: &#123;</span><br><span class="line"><span class="attr">value</span>: token,</span><br><span class="line"><span class="attr">expire</span>: expire,</span><br><span class="line"><span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–tokenæœåŠ¡</span></span><br><span class="line"><span class="keyword">const</span> tokenService = <span class="keyword">new</span> <span class="title class_">TokenService</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// å­åº”ç”¨ä¸­ç›‘å¬tokenæ›´æ–°</span></span><br><span class="line">props.<span class="title function_">onGlobalStateChange</span>(<span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (state.<span class="property">tokenUpdated</span> &amp;&amp; state.<span class="property">tokenUpdated</span>.<span class="property">timestamp</span>) &#123;</span><br><span class="line"><span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;token&#x27;</span>, state.<span class="property">tokenUpdated</span>.<span class="property">value</span>);</span><br><span class="line"><span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;token_expire&#x27;</span>, state.<span class="property">tokenUpdated</span>.<span class="property">expire</span>.<span class="title function_">toString</span>());</span><br><span class="line">&#125;</span><br><span class="line">&#125;, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure><p><a id="åæ€»ç»“ä¸å±•æœ›"></a></p><h2 id="åã€æ€»ç»“ä¸å±•æœ›"><a href="#åã€æ€»ç»“ä¸å±•æœ›" class="headerlink" title="åã€æ€»ç»“ä¸å±•æœ›"></a>åã€æ€»ç»“ä¸å±•æœ›</h2><h3 id="10-1-QiankunæŠ€æœ¯ä¼˜åŠ¿"><a href="#10-1-QiankunæŠ€æœ¯ä¼˜åŠ¿" class="headerlink" title="10.1 QiankunæŠ€æœ¯ä¼˜åŠ¿"></a>10.1 QiankunæŠ€æœ¯ä¼˜åŠ¿</h3><ol><li><strong>æŠ€æœ¯æ ˆæ— å…³</strong> - æ”¯æŒä¸åŒå‰ç«¯æ¡†æ¶æ··åˆä½¿ç”¨</li><li><strong>ç‹¬ç«‹å¼€å‘éƒ¨ç½²</strong> - å­åº”ç”¨å¯ç‹¬ç«‹ç»´æŠ¤è¿­ä»£</li><li><strong>æ²™ç®±éš”ç¦»</strong> - ç¡®ä¿åº”ç”¨é—´ä¸ä¼šäº’ç›¸å¹²æ‰°</li><li><strong>èµ„æºé¢„åŠ è½½</strong> - æå‡å¤šåº”ç”¨åŠ è½½æ€§èƒ½</li></ol><h3 id="10-2-æ¶æ„æœ€ä½³å®è·µ"><a href="#10-2-æ¶æ„æœ€ä½³å®è·µ" class="headerlink" title="10.2 æ¶æ„æœ€ä½³å®è·µ"></a>10.2 æ¶æ„æœ€ä½³å®è·µ</h3><ol><li><strong>æ ‡å‡†åŒ–è·¯ç”±é…ç½®</strong> - ç»Ÿä¸€åº”ç”¨é—´è·¯ç”±è§„åˆ™</li><li><strong>ç»Ÿä¸€è®¤è¯æˆæƒ</strong> - ä¸€å¤„ç™»å½•ï¼Œå¤„å¤„ç”Ÿæ•ˆ</li><li><strong>æ€§èƒ½ä¼˜å…ˆç­–ç•¥</strong> - æŒ‰éœ€åŠ è½½ã€é¢„åŠ è½½ç»“åˆ</li><li><strong>å®Œå–„çš„ç›‘æ§ä½“ç³»</strong> - åŠæ—¶å‘ç°å¹¶è§£å†³é—®é¢˜</li></ol><h3 id="10-3-æœªæ¥å‘å±•æ–¹å‘"><a href="#10-3-æœªæ¥å‘å±•æ–¹å‘" class="headerlink" title="10.3 æœªæ¥å‘å±•æ–¹å‘"></a>10.3 æœªæ¥å‘å±•æ–¹å‘</h3><ol><li><strong>å¾®æ¨¡å—åŒ–</strong> - è¿›ä¸€æ­¥ç»†åŒ–åº”ç”¨é¢—ç²’åº¦</li><li><strong>AIè¾…åŠ©åŠ è½½</strong> - åŸºäºç”¨æˆ·è¡Œä¸ºæ™ºèƒ½é¢„æµ‹éœ€è¦åŠ è½½çš„åº”ç”¨</li><li><strong>æ›´å¼ºå¤§çš„éš”ç¦»</strong> - éš”ç¦»æ›´å½»åº•çš„åŒæ—¶ä¿æŒæ›´é«˜æ•ˆçš„æ€§èƒ½</li></ol><p><a id="åä¸€å­åº”ç”¨ä¼˜åŒ–ç­–ç•¥"></a></p><h2 id="åä¸€ã€å­åº”ç”¨ä¼˜åŒ–ç­–ç•¥ï¼ˆå¢å¼ºç‰ˆï¼‰"><a href="#åä¸€ã€å­åº”ç”¨ä¼˜åŒ–ç­–ç•¥ï¼ˆå¢å¼ºç‰ˆï¼‰" class="headerlink" title="åä¸€ã€å­åº”ç”¨ä¼˜åŒ–ç­–ç•¥ï¼ˆå¢å¼ºç‰ˆï¼‰"></a>åä¸€ã€å­åº”ç”¨ä¼˜åŒ–ç­–ç•¥ï¼ˆå¢å¼ºç‰ˆï¼‰</h2><h3 id="11-1-æ™ºèƒ½é¢„åŠ è½½ç­–ç•¥"><a href="#11-1-æ™ºèƒ½é¢„åŠ è½½ç­–ç•¥" class="headerlink" title="11.1 æ™ºèƒ½é¢„åŠ è½½ç­–ç•¥"></a>11.1 æ™ºèƒ½é¢„åŠ è½½ç­–ç•¥</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸»åº”ç”¨æ™ºèƒ½é¢„åŠ è½½æ§åˆ¶å™¨</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PreloadController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">usageStats</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">observer</span> = <span class="keyword">new</span> <span class="title class_">IntersectionObserver</span>(<span class="variable language_">this</span>.<span class="property">handleIntersection</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®°å½•åº”ç”¨ä½¿ç”¨é¢‘ç‡</span></span><br><span class="line">  <span class="title function_">trackAppUsage</span>(<span class="params">appName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> count = <span class="variable language_">this</span>.<span class="property">usageStats</span>.<span class="title function_">get</span>(appName) || <span class="number">0</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">usageStats</span>.<span class="title function_">set</span>(appName, count + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŸºäºå¯è§†åŒºåŸŸé¢„åŠ è½½</span></span><br><span class="line">  <span class="title function_">handleIntersection</span>(<span class="params">entries</span>) &#123;</span><br><span class="line">    entries.<span class="title function_">forEach</span>(<span class="function"><span class="params">entry</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (entry.<span class="property">isIntersecting</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> appName = entry.<span class="property">target</span>.<span class="property">dataset</span>.<span class="property">appName</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">preloadApp</span>(appName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ™ºèƒ½é¢„åŠ è½½ç®—æ³•</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">preloadApp</span>(<span class="params">appName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> appConfig = qiankunApps.<span class="title function_">find</span>(<span class="function"><span class="params">app</span> =&gt;</span> app.<span class="property">name</span> === appName);</span><br><span class="line">    <span class="keyword">if</span> (!appConfig || appConfig.<span class="property">preloaded</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®ä½¿ç”¨é¢‘ç‡å†³å®šé¢„åŠ è½½ä¼˜å…ˆçº§</span></span><br><span class="line">    <span class="keyword">const</span> priority = <span class="variable language_">this</span>.<span class="property">usageStats</span>.<span class="title function_">get</span>(appName) &gt; <span class="number">5</span> ? <span class="string">&#x27;high&#x27;</span> : <span class="string">&#x27;low&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ requestIdleCallback ä¼˜åŒ–æ€§èƒ½</span></span><br><span class="line">    <span class="keyword">if</span> (priority === <span class="string">&#x27;high&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">loadMicroApp</span>(appConfig);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">requestIdleCallback</span>(<span class="function">() =&gt;</span> <span class="title function_">loadMicroApp</span>(appConfig));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    appConfig.<span class="property">preloaded</span> = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ³¨å†Œå¯è§‚å¯Ÿå…ƒç´ </span></span><br><span class="line">  <span class="title function_">registerTrigger</span>(<span class="params">element</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">observer</span>.<span class="title function_">observe</span>(element);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> preloader = <span class="keyword">new</span> <span class="title class_">PreloadController</span>();</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;[data-app-trigger]&#x27;</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">el</span> =&gt;</span> &#123;</span><br><span class="line">  preloader.<span class="title function_">registerTrigger</span>(el);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="11-2-é«˜çº§åŠ è½½çŠ¶æ€ç®¡ç†ï¼ˆæ”¯æŒSLAç›‘æ§ï¼‰"><a href="#11-2-é«˜çº§åŠ è½½çŠ¶æ€ç®¡ç†ï¼ˆæ”¯æŒSLAç›‘æ§ï¼‰" class="headerlink" title="11.2 é«˜çº§åŠ è½½çŠ¶æ€ç®¡ç†ï¼ˆæ”¯æŒSLAç›‘æ§ï¼‰"></a>11.2 é«˜çº§åŠ è½½çŠ¶æ€ç®¡ç†ï¼ˆæ”¯æŒSLAç›‘æ§ï¼‰</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¢å¼ºç‰ˆåŠ è½½çŠ¶æ€ç®¡ç†å™¨</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AdvancedLoadingManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">states</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">slaThresholds</span> = &#123;</span><br><span class="line">      <span class="attr">loadTime</span>: <span class="number">3000</span>,  <span class="comment">// 3ç§’åŠ è½½é˜ˆå€¼</span></span><br><span class="line">      <span class="attr">successRate</span>: <span class="number">0.95</span> <span class="comment">// 95%æˆåŠŸç‡</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®°å½•åŠ è½½æŒ‡æ ‡</span></span><br><span class="line">  <span class="title function_">recordMetric</span>(<span class="params">appName, metric</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> appState = <span class="variable language_">this</span>.<span class="property">states</span>.<span class="title function_">get</span>(appName) || &#123;</span><br><span class="line">      <span class="attr">loadCount</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">successCount</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">totalLoadTime</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">errors</span>: []</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    appState.<span class="property">loadCount</span>++;</span><br><span class="line">    appState.<span class="property">totalLoadTime</span> += metric.<span class="property">duration</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (metric.<span class="property">success</span>) &#123;</span><br><span class="line">      appState.<span class="property">successCount</span>++;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      appState.<span class="property">errors</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">        <span class="attr">error</span>: metric.<span class="property">error</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">states</span>.<span class="title function_">set</span>(appName, appState);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">checkSLA</span>(appName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ£€æŸ¥SLAåˆè§„æ€§</span></span><br><span class="line">  <span class="title function_">checkSLA</span>(<span class="params">appName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> state = <span class="variable language_">this</span>.<span class="property">states</span>.<span class="title function_">get</span>(appName);</span><br><span class="line">    <span class="keyword">const</span> avgLoadTime = state.<span class="property">totalLoadTime</span> / state.<span class="property">loadCount</span>;</span><br><span class="line">    <span class="keyword">const</span> successRate = state.<span class="property">successCount</span> / state.<span class="property">loadCount</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (avgLoadTime &gt; <span class="variable language_">this</span>.<span class="property">slaThresholds</span>.<span class="property">loadTime</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`[SLAå‘Šè­¦] <span class="subst">$&#123;appName&#125;</span> å¹³å‡åŠ è½½æ—¶é—´ <span class="subst">$&#123;avgLoadTime&#125;</span>ms`</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (successRate &lt; <span class="variable language_">this</span>.<span class="property">slaThresholds</span>.<span class="property">successRate</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`[SLAè¿è§„] <span class="subst">$&#123;appName&#125;</span> æˆåŠŸç‡ <span class="subst">$&#123;successRate * <span class="number">100</span>&#125;</span>%`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š</span></span><br><span class="line">  <span class="title function_">generateReport</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="variable language_">this</span>.<span class="property">states</span>.<span class="title function_">entries</span>()).<span class="title function_">map</span>(<span class="function">(<span class="params">[name, state]</span>) =&gt;</span> (&#123;</span><br><span class="line">      <span class="attr">app</span>: name,</span><br><span class="line">      <span class="attr">avgLoadTime</span>: state.<span class="property">totalLoadTime</span> / state.<span class="property">loadCount</span>,</span><br><span class="line">      <span class="attr">successRate</span>: state.<span class="property">successCount</span> / state.<span class="property">loadCount</span>,</span><br><span class="line">      <span class="attr">errorCount</span>: state.<span class="property">errors</span>.<span class="property">length</span></span><br><span class="line">    &#125;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é›†æˆåˆ°å¾®åº”ç”¨é…ç½®</span></span><br><span class="line"><span class="keyword">const</span> loadingManager = <span class="keyword">new</span> <span class="title class_">AdvancedLoadingManager</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_">registerMicroApps</span>(apps.<span class="title function_">map</span>(<span class="function"><span class="params">app</span> =&gt;</span> (&#123;</span><br><span class="line">  ...app,</span><br><span class="line">  <span class="title function_">loader</span>(<span class="params">loading</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> startTime = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">    <span class="keyword">let</span> metric = &#123; <span class="attr">duration</span>: <span class="number">0</span>, <span class="attr">success</span>: <span class="literal">false</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!loading) &#123;</span><br><span class="line">      metric.<span class="property">duration</span> = <span class="title class_">Date</span>.<span class="title function_">now</span>() - startTime;</span><br><span class="line">      metric.<span class="property">success</span> = <span class="literal">true</span>;</span><br><span class="line">      loadingManager.<span class="title function_">recordMetric</span>(app.<span class="property">name</span>, metric);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="title function_">errorHandler</span> = (<span class="params">err</span>) =&gt; &#123;</span><br><span class="line">        metric.<span class="property">duration</span> = <span class="title class_">Date</span>.<span class="title function_">now</span>() - startTime;</span><br><span class="line">        metric.<span class="property">error</span> = err;</span><br><span class="line">        loadingManager.<span class="title function_">recordMetric</span>(app.<span class="property">name</span>, metric);</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;error&#x27;</span>, errorHandler);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)));</span><br></pre></td></tr></table></figure><h3 id="11-3-åŠ¨æ€èµ„æºè°ƒé…ï¼ˆæ ¹æ®ç½‘ç»œçŠ¶å†µï¼‰"><a href="#11-3-åŠ¨æ€èµ„æºè°ƒé…ï¼ˆæ ¹æ®ç½‘ç»œçŠ¶å†µï¼‰" class="headerlink" title="11.3 åŠ¨æ€èµ„æºè°ƒé…ï¼ˆæ ¹æ®ç½‘ç»œçŠ¶å†µï¼‰"></a>11.3 åŠ¨æ€èµ„æºè°ƒé…ï¼ˆæ ¹æ®ç½‘ç»œçŠ¶å†µï¼‰</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç½‘ç»œæ„ŸçŸ¥å‹èµ„æºåŠ è½½</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NetworkAwareLoader</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">connection</span> = navigator.<span class="property">connection</span> || &#123;</span><br><span class="line">      <span class="attr">effectiveType</span>: <span class="string">&#x27;4g&#x27;</span>,</span><br><span class="line">      <span class="attr">saveData</span>: <span class="literal">false</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">presets</span> = &#123;</span><br><span class="line">      <span class="string">&#x27;4g&#x27;</span>: &#123; <span class="attr">prefetch</span>: <span class="string">&#x27;all&#x27;</span>, <span class="attr">sandbox</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      <span class="string">&#x27;3g&#x27;</span>: &#123; <span class="attr">prefetch</span>: <span class="string">&#x27;current&#x27;</span>, <span class="attr">sandbox</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">      <span class="string">&#x27;2g&#x27;</span>: &#123; <span class="attr">prefetch</span>: <span class="string">&#x27;none&#x27;</span>, <span class="attr">sandbox</span>: <span class="literal">false</span> &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–åŠ è½½ç­–ç•¥</span></span><br><span class="line">  <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">updateStrategy</span>();</span><br><span class="line">    navigator.<span class="property">connection</span>?.<span class="title function_">addEventListener</span>(<span class="string">&#x27;change&#x27;</span>, <span class="variable language_">this</span>.<span class="property">updateStrategy</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ›´æ–°åŠ è½½ç­–ç•¥</span></span><br><span class="line">  updateStrategy = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; effectiveType, saveData &#125; = <span class="variable language_">this</span>.<span class="property">connection</span>;</span><br><span class="line">    <span class="keyword">const</span> strategy = saveData ? <span class="variable language_">this</span>.<span class="property">presets</span>[<span class="string">&#x27;2g&#x27;</span>] : <span class="variable language_">this</span>.<span class="property">presets</span>[effectiveType];</span><br><span class="line"></span><br><span class="line">    <span class="title function_">start</span>(&#123;</span><br><span class="line">      <span class="attr">prefetch</span>: strategy.<span class="property">prefetch</span>,</span><br><span class="line">      <span class="attr">sandbox</span>: &#123;</span><br><span class="line">        <span class="attr">strictStyleIsolation</span>: strategy.<span class="property">sandbox</span>,</span><br><span class="line">        <span class="attr">experimentalStyleIsolation</span>: strategy.<span class="property">sandbox</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŠ¨æ€è°ƒæ•´èµ„æºè´¨é‡</span></span><br><span class="line">  <span class="title function_">adjustResourceQuality</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> imgQuality = <span class="variable language_">this</span>.<span class="property">connection</span>.<span class="property">saveData</span> ? <span class="string">&#x27;low&#x27;</span> : <span class="string">&#x27;high&#x27;</span>;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="property">style</span>.<span class="title function_">setProperty</span>(</span><br><span class="line">      <span class="string">&#x27;--image-quality&#x27;</span>,</span><br><span class="line">      <span class="string">`url(?quality=<span class="subst">$&#123;imgQuality&#125;</span>)`</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> networkLoader = <span class="keyword">new</span> <span class="title class_">NetworkAwareLoader</span>();</span><br><span class="line">networkLoader.<span class="title function_">init</span>();</span><br></pre></td></tr></table></figure><h3 id="11-4-å®‰å…¨å¢å¼ºç­–ç•¥"><a href="#11-4-å®‰å…¨å¢å¼ºç­–ç•¥" class="headerlink" title="11.4 å®‰å…¨å¢å¼ºç­–ç•¥"></a>11.4 å®‰å…¨å¢å¼ºç­–ç•¥</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å­åº”ç”¨å®‰å…¨æ²™ç®±å¢å¼º</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">createSecureSandbox</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="variable language_">window</span>, &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">target, prop</span>) &#123;</span><br><span class="line">      <span class="comment">// æ‹¦æˆªå±é™©API</span></span><br><span class="line">      <span class="keyword">if</span> ([<span class="string">&#x27;localStorage&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;Function&#x27;</span>].<span class="title function_">includes</span>(prop)) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`ç¦æ­¢è®¿é—® <span class="subst">$&#123;prop&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> target[prop];</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">target, prop, value</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (prop === <span class="string">&#x27;document&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;ç¦æ­¢ä¿®æ”¹documentå¯¹è±¡&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      target[prop] = value;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">bootstrap</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å®‰å…¨æ²™ç®±å¯åŠ¨&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">mount</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">window</span>.<span class="property">__SANDBOX_PROXY__</span> = proxy;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">unmount</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">delete</span> <span class="variable language_">window</span>.<span class="property">__SANDBOX_PROXY__</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é›†æˆåˆ°å¯åŠ¨é…ç½®</span></span><br><span class="line"><span class="title function_">start</span>(&#123;</span><br><span class="line">  <span class="attr">sandbox</span>: <span class="title function_">createSecureSandbox</span>()</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="11-5-æ€§èƒ½è¿½è¸ªä¸å¯è§†åŒ–"><a href="#11-5-æ€§èƒ½è¿½è¸ªä¸å¯è§†åŒ–" class="headerlink" title="11.5 æ€§èƒ½è¿½è¸ªä¸å¯è§†åŒ–"></a>11.5 æ€§èƒ½è¿½è¸ªä¸å¯è§†åŒ–</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ€§èƒ½è¿½è¸ªè£…é¥°å™¨</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">tracePerformance</span>(<span class="params">target, name, descriptor</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> original = descriptor.<span class="property">value</span>;</span><br><span class="line"></span><br><span class="line">  descriptor.<span class="property">value</span> = <span class="keyword">async</span> <span class="keyword">function</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> start = performance.<span class="title function_">now</span>();</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> original.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args);</span><br><span class="line">    <span class="keyword">const</span> duration = performance.<span class="title function_">now</span>() - start;</span><br><span class="line"></span><br><span class="line">    performanceTrack.<span class="title function_">addEntry</span>(&#123;</span><br><span class="line">      name,</span><br><span class="line">      duration,</span><br><span class="line">      <span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">      <span class="attr">args</span>: args.<span class="property">length</span> &gt; <span class="number">0</span> ? args : <span class="literal">undefined</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> descriptor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨å…³é”®ç”Ÿå‘½å‘¨æœŸä½¿ç”¨</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AppController</span> &#123;</span><br><span class="line">  @tracePerformance</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadApp</span>(<span class="params">config</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">loadMicroApp</span>(config);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @tracePerformance</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">unloadApp</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> app = <span class="variable language_">this</span>.<span class="property">apps</span>.<span class="title function_">get</span>(name);</span><br><span class="line">    <span class="keyword">return</span> app.<span class="title function_">unmount</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ€§èƒ½æ•°æ®å¯è§†åŒ–</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">renderPerformanceDashboard</span> = (<span class="params">data</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> metrics = &#123;</span><br><span class="line">    <span class="attr">loadTime</span>: data.<span class="title function_">filter</span>(<span class="function"><span class="params">d</span> =&gt;</span> d.<span class="property">name</span> === <span class="string">&#x27;loadApp&#x27;</span>),</span><br><span class="line">    <span class="attr">unloadTime</span>: data.<span class="title function_">filter</span>(<span class="function"><span class="params">d</span> =&gt;</span> d.<span class="property">name</span> === <span class="string">&#x27;unloadApp&#x27;</span>)</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½¿ç”¨å›¾è¡¨åº“æ¸²æŸ“å¯è§†åŒ–è§†å›¾</span></span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Chart</span>(<span class="string">&#x27;#load-times&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;line&#x27;</span>,</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">      <span class="attr">labels</span>: metrics.<span class="property">loadTime</span>.<span class="title function_">map</span>(<span class="function"><span class="params">d</span> =&gt;</span> <span class="keyword">new</span> <span class="title class_">Date</span>(d.<span class="property">timestamp</span>).<span class="title function_">toLocaleTimeString</span>()),</span><br><span class="line">      <span class="attr">datasets</span>: [&#123;</span><br><span class="line">        <span class="attr">label</span>: <span class="string">&#x27;åº”ç”¨åŠ è½½æ—¶é—´ (ms)&#x27;</span>,</span><br><span class="line">        <span class="attr">data</span>: metrics.<span class="property">loadTime</span>.<span class="title function_">map</span>(<span class="function"><span class="params">d</span> =&gt;</span> d.<span class="property">duration</span>),</span><br><span class="line">        <span class="attr">borderColor</span>: <span class="string">&#x27;#4CAF50&#x27;</span></span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><hr><blockquote><p>æœ¬æ¬¡ä¼˜åŒ–é‡ç‚¹å¢å¼ºä»¥ä¸‹æ–¹é¢ï¼š</p><ol><li><strong>æ™ºèƒ½é¢„åŠ è½½</strong> - åŸºäºç”¨æˆ·è¡Œä¸ºå’Œå¯è§†åŒºåŸŸé¢„æµ‹åŠ è½½</li><li><strong>SLAç›‘æ§</strong> - å®æ—¶è·Ÿè¸ªæ€§èƒ½æŒ‡æ ‡å¹¶é¢„è­¦</li><li><strong>ç½‘ç»œé€‚é…</strong> - æ ¹æ®ç½‘ç»œçŠ¶å†µåŠ¨æ€è°ƒæ•´ç­–ç•¥</li><li><strong>å®‰å…¨å¢å¼º</strong> - ä¸¥æ ¼é™åˆ¶æ•æ„ŸAPIè®¿é—®</li><li><strong>æ€§èƒ½å¯è§†åŒ–</strong> - æä¾›ç›´è§‚çš„æ€§èƒ½åˆ†æè§†å›¾</li></ol></blockquote><p>[ğŸ”— æ€§èƒ½ç›‘æ§ç¤ºä¾‹] | [ğŸ“Š å¯è§†åŒ–æ¨¡æ¿] | [ğŸ›¡ï¸ å®‰å…¨å®¡è®¡æŒ‡å—]</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Qiankun-å¾®å‰ç«¯ä¼ä¸šçº§å®è·µæŒ‡å—&quot;&gt;&lt;a href=&quot;#Qiankun-å¾®å‰ç«¯ä¼ä¸šçº§å®è·µæŒ‡å—&quot; class=&quot;headerlink&quot; title=&quot;Qiankun å¾®å‰ç«¯ä¼ä¸šçº§å®è·µæŒ‡å—&quot;&gt;&lt;/a&gt;Qiankun å¾®å‰ç«¯ä¼ä¸šçº§å®è·µæŒ‡å—&lt;/h1&gt;&lt;h2 id=&quot;ç›®</summary>
      
    
    
    
    <category term="æ•™ç¨‹" scheme="https://aoayaoa.github.io/categories/%E6%95%99%E7%A8%8B/"/>
    
    
    <category term="å…¥é—¨" scheme="https://aoayaoa.github.io/tags/%E5%85%A5%E9%97%A8/"/>
    
    <category term="Hexo" scheme="https://aoayaoa.github.io/tags/Hexo/"/>
    
  </entry>
  
  <entry>
    <title>vite</title>
    <link href="https://aoayaoa.github.io/2024/02/01/vite/"/>
    <id>https://aoayaoa.github.io/2024/02/01/vite/</id>
    <published>2024-01-31T16:00:00.000Z</published>
    <updated>2025-03-07T04:00:05.349Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Vite-å®Œå…¨æŒ‡å—ï¼šä»å…¥é—¨åˆ°ç²¾é€š"><a href="#Vite-å®Œå…¨æŒ‡å—ï¼šä»å…¥é—¨åˆ°ç²¾é€š" class="headerlink" title="Vite å®Œå…¨æŒ‡å—ï¼šä»å…¥é—¨åˆ°ç²¾é€š"></a>Vite å®Œå…¨æŒ‡å—ï¼šä»å…¥é—¨åˆ°ç²¾é€š</h1><h2 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h2><h3 id="ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºç¡€å…¥é—¨"><a href="#ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºç¡€å…¥é—¨" class="headerlink" title="ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºç¡€å…¥é—¨"></a>ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºç¡€å…¥é—¨</h3><ol><li><p><a href="#1-%E8%AE%A4%E8%AF%86-vite">è®¤è¯† Vite</a></p><ul><li>1.1 ä»€ä¹ˆæ˜¯ Vite</li><li>1.2 æ ¸å¿ƒä¼˜åŠ¿</li><li>1.3 åŸºæœ¬åŸç†</li><li>1.4 åº”ç”¨åœºæ™¯</li></ul></li><li><p><a href="#2-%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B">å¿«é€Ÿå¼€å§‹</a></p><ul><li>2.1 ç¯å¢ƒå‡†å¤‡</li><li>2.2 åˆ›å»ºé¡¹ç›®</li><li>2.3 é¡¹ç›®ç»“æ„</li><li>2.4 åŸºæœ¬å‘½ä»¤</li><li>2.5 å¼€å‘è°ƒè¯•</li></ul></li></ol><h3 id="ç¬¬äºŒéƒ¨åˆ†ï¼šæ ¸å¿ƒæ¦‚å¿µ"><a href="#ç¬¬äºŒéƒ¨åˆ†ï¼šæ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="ç¬¬äºŒéƒ¨åˆ†ï¼šæ ¸å¿ƒæ¦‚å¿µ"></a>ç¬¬äºŒéƒ¨åˆ†ï¼šæ ¸å¿ƒæ¦‚å¿µ</h3><ol start="3"><li><p><a href="#3-%E6%9E%84%E5%BB%BA%E5%9F%BA%E7%A1%80">æ„å»ºåŸºç¡€</a></p><ul><li>3.1 å¼€å‘æœåŠ¡å™¨</li><li>3.2 æ„å»ºè¿‡ç¨‹</li><li>3.3 ä¾èµ–é¢„æ„å»º</li><li>3.4 HMR æœºåˆ¶</li></ul></li><li><p><a href="#4-%E8%B5%84%E6%BA%90%E5%A4%84%E7%90%86">èµ„æºå¤„ç†</a></p><ul><li>4.1 é™æ€èµ„æº</li><li>4.2 æ ·å¼å¤„ç†</li><li>4.3 JavaScript&#x2F;TypeScript</li><li>4.4 JSON å’Œ Web Workers</li><li>4.5 åŠ¨æ€å¯¼å…¥</li></ul></li></ol><h3 id="ç¬¬ä¸‰éƒ¨åˆ†ï¼šè¿›é˜¶ä½¿ç”¨"><a href="#ç¬¬ä¸‰éƒ¨åˆ†ï¼šè¿›é˜¶ä½¿ç”¨" class="headerlink" title="ç¬¬ä¸‰éƒ¨åˆ†ï¼šè¿›é˜¶ä½¿ç”¨"></a>ç¬¬ä¸‰éƒ¨åˆ†ï¼šè¿›é˜¶ä½¿ç”¨</h3><ol start="5"><li><p><a href="#5-%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3">é…ç½®è¯¦è§£</a></p><ul><li>5.1 åŸºç¡€é…ç½®</li><li>5.2 å¼€å‘æœåŠ¡å™¨é…ç½®</li><li>5.3 æ„å»ºé…ç½®</li><li>5.4 ä¾èµ–ä¼˜åŒ–</li><li>5.5 ç¯å¢ƒå˜é‡</li></ul></li><li><p><a href="#6-%E6%8F%92%E4%BB%B6%E7%B3%BB%E7%BB%9F">æ’ä»¶ç³»ç»Ÿ</a></p><ul><li>6.1 æ’ä»¶æœºåˆ¶</li><li>6.2 å¸¸ç”¨æ’ä»¶</li><li>6.3 æ’ä»¶å¼€å‘</li><li>6.4 æ’ä»¶é’©å­</li><li>6.5 æœ€ä½³å®è·µ</li></ul></li></ol><h3 id="ç¬¬å››éƒ¨åˆ†ï¼šæ¡†æ¶é›†æˆ"><a href="#ç¬¬å››éƒ¨åˆ†ï¼šæ¡†æ¶é›†æˆ" class="headerlink" title="ç¬¬å››éƒ¨åˆ†ï¼šæ¡†æ¶é›†æˆ"></a>ç¬¬å››éƒ¨åˆ†ï¼šæ¡†æ¶é›†æˆ</h3><ol start="7"><li><p><a href="#7-%E4%B8%BB%E6%B5%81%E6%A1%86%E6%9E%B6">ä¸»æµæ¡†æ¶</a></p><ul><li>7.1 Vue ç”Ÿæ€</li><li>7.2 React ç”Ÿæ€</li><li>7.3 å…¶ä»–æ¡†æ¶</li><li>7.4 è¿ç§»æŒ‡å—</li></ul></li><li><p><a href="#8-%E5%B7%A5%E5%85%B7%E9%93%BE%E9%9B%86%E6%88%90">å·¥å…·é“¾é›†æˆ</a></p><ul><li>8.1 TypeScript</li><li>8.2 CSS é¢„å¤„ç†å™¨</li><li>8.3 PostCSS</li><li>8.4 ESLint&#x2F;Prettier</li><li>8.5 å•å…ƒæµ‹è¯•</li></ul></li></ol><h3 id="ç¬¬äº”éƒ¨åˆ†ï¼šç”Ÿäº§ä¼˜åŒ–"><a href="#ç¬¬äº”éƒ¨åˆ†ï¼šç”Ÿäº§ä¼˜åŒ–" class="headerlink" title="ç¬¬äº”éƒ¨åˆ†ï¼šç”Ÿäº§ä¼˜åŒ–"></a>ç¬¬äº”éƒ¨åˆ†ï¼šç”Ÿäº§ä¼˜åŒ–</h3><ol start="9"><li><p><a href="#9-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">æ€§èƒ½ä¼˜åŒ–</a></p><ul><li>9.1 æ„å»ºä¼˜åŒ–</li><li>9.2 ä»£ç åˆ†å‰²</li><li>9.3 æ‡’åŠ è½½</li><li>9.4 é¢„åŠ è½½</li><li>9.5 ç¼“å­˜ç­–ç•¥</li></ul></li><li><p><a href="#10-%E9%83%A8%E7%BD%B2%E8%BF%90%E7%BB%B4">éƒ¨ç½²è¿ç»´</a></p><ul><li>10.1 æ„å»ºç­–ç•¥</li><li>10.2 éƒ¨ç½²æ–¹æ¡ˆ</li><li>10.3 CI&#x2F;CD</li><li>10.4 ç›‘æ§åˆ†æ</li><li>10.5 å®‰å…¨è€ƒè™‘</li></ul></li></ol><h2 id="1-è®¤è¯†-Vite"><a href="#1-è®¤è¯†-Vite" class="headerlink" title="1. è®¤è¯† Vite"></a>1. è®¤è¯† Vite</h2><h3 id="1-1-ä»€ä¹ˆæ˜¯-Vite"><a href="#1-1-ä»€ä¹ˆæ˜¯-Vite" class="headerlink" title="1.1 ä»€ä¹ˆæ˜¯ Vite"></a>1.1 ä»€ä¹ˆæ˜¯ Vite</h3><p>Viteï¼ˆæ³•è¯­æ„ä¸ºâ€å¿«é€Ÿâ€ï¼‰æ˜¯æ–°ä¸€ä»£å‰ç«¯æ„å»ºå·¥å…·ï¼Œç”± Vue.js çš„ä½œè€…å°¤é›¨æºªå¼€å‘ã€‚å®ƒé’ˆå¯¹ç°ä»£ Web å¼€å‘çš„ç—›ç‚¹ï¼Œæä¾›äº†ä¸€å¥—å®Œæ•´çš„å¼€å‘è§£å†³æ–¹æ¡ˆã€‚</p><h4 id="æ ¸å¿ƒç‰¹ç‚¹"><a href="#æ ¸å¿ƒç‰¹ç‚¹" class="headerlink" title="æ ¸å¿ƒç‰¹ç‚¹"></a>æ ¸å¿ƒç‰¹ç‚¹</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. æé€Ÿçš„æœåŠ¡å™¨å¯åŠ¨</span></span><br><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"><span class="comment">// Vite ç›´æ¥æä¾› ESM æºç </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. è½»é‡å¿«é€Ÿçš„çƒ­æ›´æ–°</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">hot</span>) &#123;</span><br><span class="line">  <span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">hot</span>.<span class="title function_">accept</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. å¼€ç®±å³ç”¨çš„å„ç§åŠŸèƒ½</span></span><br><span class="line"><span class="keyword">import</span> styles <span class="keyword">from</span> <span class="string">&#x27;./style.module.css&#x27;</span></span><br><span class="line"><span class="keyword">import</span> data <span class="keyword">from</span> <span class="string">&#x27;./data.json&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="1-2-æ ¸å¿ƒä¼˜åŠ¿"><a href="#1-2-æ ¸å¿ƒä¼˜åŠ¿" class="headerlink" title="1.2 æ ¸å¿ƒä¼˜åŠ¿"></a>1.2 æ ¸å¿ƒä¼˜åŠ¿</h3><h4 id="å¼€å‘ç¯å¢ƒ"><a href="#å¼€å‘ç¯å¢ƒ" class="headerlink" title="å¼€å‘ç¯å¢ƒ"></a>å¼€å‘ç¯å¢ƒ</h4><pre><code class="highlight mermaid">graph LR    A[æºä»£ç ] --&gt; B[Vite Dev Server]    B --&gt; C[æµè§ˆå™¨åŸç”Ÿ ESM]    C --&gt; D[å³æ—¶ç¼–è¯‘]    D --&gt; E[å¿«é€Ÿæ›´æ–°]</code></pre><h4 id="ç”Ÿäº§ç¯å¢ƒ"><a href="#ç”Ÿäº§ç¯å¢ƒ" class="headerlink" title="ç”Ÿäº§ç¯å¢ƒ"></a>ç”Ÿäº§ç¯å¢ƒ</h4><pre><code class="highlight mermaid">graph LR    A[æºä»£ç ] --&gt; B[Rollup]    B --&gt; C[ä¼˜åŒ–æ‰“åŒ…]    C --&gt; D[é«˜æ€§èƒ½äº§ç‰©]</code></pre><h3 id="1-3-åŸºæœ¬åŸç†"><a href="#1-3-åŸºæœ¬åŸç†" class="headerlink" title="1.3 åŸºæœ¬åŸç†"></a>1.3 åŸºæœ¬åŸç†</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¼€å‘æœåŠ¡å™¨åŸç†</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">server</span>: &#123;</span><br><span class="line">    <span class="comment">// 1. åŸºäº ESM çš„å¼€å‘æœåŠ¡å™¨</span></span><br><span class="line">    <span class="attr">middlewareMode</span>: <span class="literal">false</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. æ™ºèƒ½çš„ HMR</span></span><br><span class="line">    <span class="attr">hmr</span>: &#123;</span><br><span class="line">      <span class="attr">protocol</span>: <span class="string">&#x27;ws&#x27;</span>,</span><br><span class="line">      <span class="attr">timeout</span>: <span class="number">1000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. æŒ‰éœ€ç¼–è¯‘</span></span><br><span class="line">    <span class="attr">fs</span>: &#123;</span><br><span class="line">      <span class="attr">strict</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">allow</span>: [<span class="string">&#x27;..&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="1-4-åº”ç”¨åœºæ™¯"><a href="#1-4-åº”ç”¨åœºæ™¯" class="headerlink" title="1.4 åº”ç”¨åœºæ™¯"></a>1.4 åº”ç”¨åœºæ™¯</h3><table><thead><tr><th>åœºæ™¯</th><th>ç‰¹ç‚¹</th><th>é€‚ç”¨æ€§</th></tr></thead><tbody><tr><td>SPA</td><td>å¿«é€Ÿå¼€å‘ã€å³æ—¶åé¦ˆ</td><td>æä½³</td></tr><tr><td>SSR</td><td>æ”¯æŒæœåŠ¡ç«¯æ¸²æŸ“</td><td>è‰¯å¥½</td></tr><tr><td>åº“å¼€å‘</td><td>æ’ä»¶åŒ–ã€å¯æ‰©å±•</td><td>é€‚ä¸­</td></tr><tr><td>MPA</td><td>å¤šé¡µé¢åº”ç”¨æ”¯æŒ</td><td>è‰¯å¥½</td></tr></tbody></table><h2 id="2-å¿«é€Ÿå¼€å§‹"><a href="#2-å¿«é€Ÿå¼€å§‹" class="headerlink" title="2. å¿«é€Ÿå¼€å§‹"></a>2. å¿«é€Ÿå¼€å§‹</h2><h3 id="2-1-ç¯å¢ƒå‡†å¤‡"><a href="#2-1-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="2.1 ç¯å¢ƒå‡†å¤‡"></a>2.1 ç¯å¢ƒå‡†å¤‡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥ Node.js ç‰ˆæœ¬ï¼ˆéœ€è¦ 14.18+ / 16+ï¼‰</span></span><br><span class="line">node -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŒ…ç®¡ç†å™¨é€‰æ‹©</span></span><br><span class="line">npm -v  <span class="comment"># npm 6.14.0+</span></span><br><span class="line">yarn -v <span class="comment"># yarn 1.22.0+</span></span><br><span class="line">pnpm -v <span class="comment"># pnpm 7.0.0+</span></span><br></pre></td></tr></table></figure><h3 id="2-2-åˆ›å»ºé¡¹ç›®"><a href="#2-2-åˆ›å»ºé¡¹ç›®" class="headerlink" title="2.2 åˆ›å»ºé¡¹ç›®"></a>2.2 åˆ›å»ºé¡¹ç›®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ npm</span></span><br><span class="line">npm create vite@latest my-vite-app -- --template vue</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ yarn</span></span><br><span class="line">yarn create vite my-vite-app --template vue</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ pnpm</span></span><br><span class="line">pnpm create vite my-vite-app -- --template vue</span><br></pre></td></tr></table></figure><h4 id="æ”¯æŒçš„æ¨¡æ¿"><a href="#æ”¯æŒçš„æ¨¡æ¿" class="headerlink" title="æ”¯æŒçš„æ¨¡æ¿"></a>æ”¯æŒçš„æ¨¡æ¿</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">TEMPLATES</span> = &#123;</span><br><span class="line">  <span class="attr">vanilla</span>: <span class="string">&#x27;åŸç”Ÿ JavaScript&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;vanilla-ts&#x27;</span>: <span class="string">&#x27;åŸç”Ÿ TypeScript&#x27;</span>,</span><br><span class="line">  <span class="attr">vue</span>: <span class="string">&#x27;Vue&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;vue-ts&#x27;</span>: <span class="string">&#x27;Vue + TypeScript&#x27;</span>,</span><br><span class="line">  <span class="attr">react</span>: <span class="string">&#x27;React&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;react-ts&#x27;</span>: <span class="string">&#x27;React + TypeScript&#x27;</span>,</span><br><span class="line">  <span class="attr">preact</span>: <span class="string">&#x27;Preact&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;preact-ts&#x27;</span>: <span class="string">&#x27;Preact + TypeScript&#x27;</span>,</span><br><span class="line">  <span class="attr">lit</span>: <span class="string">&#x27;Lit&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;lit-ts&#x27;</span>: <span class="string">&#x27;Lit + TypeScript&#x27;</span>,</span><br><span class="line">  <span class="attr">svelte</span>: <span class="string">&#x27;Svelte&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;svelte-ts&#x27;</span>: <span class="string">&#x27;Svelte + TypeScript&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-3-é¡¹ç›®ç»“æ„"><a href="#2-3-é¡¹ç›®ç»“æ„" class="headerlink" title="2.3 é¡¹ç›®ç»“æ„"></a>2.3 é¡¹ç›®ç»“æ„</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ node_modules/</span><br><span class="line">â”œâ”€â”€ public/</span><br><span class="line">â”‚   â””â”€â”€ favicon.ico</span><br><span class="line">â”œâ”€â”€ src/</span><br><span class="line">â”‚   â”œâ”€â”€ assets/</span><br><span class="line">â”‚   â”œâ”€â”€ components/</span><br><span class="line">â”‚   â”œâ”€â”€ views/</span><br><span class="line">â”‚   â”œâ”€â”€ App.vue</span><br><span class="line">â”‚   â””â”€â”€ main.js</span><br><span class="line">â”œâ”€â”€ .gitignore</span><br><span class="line">â”œâ”€â”€ index.html</span><br><span class="line">â”œâ”€â”€ package.json</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â””â”€â”€ vite.config.js</span><br></pre></td></tr></table></figure><h1 id=""><a href="#" class="headerlink" title=""></a></h1><h2 id="3-æ„å»ºåŸºç¡€"><a href="#3-æ„å»ºåŸºç¡€" class="headerlink" title="3. æ„å»ºåŸºç¡€"></a>3. æ„å»ºåŸºç¡€</h2><h3 id="3-1-å¼€å‘æœåŠ¡å™¨"><a href="#3-1-å¼€å‘æœåŠ¡å™¨" class="headerlink" title="3.1 å¼€å‘æœåŠ¡å™¨"></a>3.1 å¼€å‘æœåŠ¡å™¨</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">server</span>: &#123;</span><br><span class="line">    <span class="attr">port</span>: <span class="number">3000</span>,</span><br><span class="line">    <span class="attr">open</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">proxy</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;/api&#x27;</span>: &#123;</span><br><span class="line">        <span class="attr">target</span>: <span class="string">&#x27;http://localhost:8080&#x27;</span>,</span><br><span class="line">        <span class="attr">changeOrigin</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">rewrite</span>: <span class="function">(<span class="params">path</span>) =&gt;</span> path.<span class="title function_">replace</span>(<span class="regexp">/^\/api/</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="3-2-æ„å»ºé…ç½®"><a href="#3-2-æ„å»ºé…ç½®" class="headerlink" title="3.2 æ„å»ºé…ç½®"></a>3.2 æ„å»ºé…ç½®</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">build</span>: &#123;</span><br><span class="line">    <span class="attr">target</span>: <span class="string">&#x27;modules&#x27;</span>,</span><br><span class="line">    <span class="attr">outDir</span>: <span class="string">&#x27;dist&#x27;</span>,</span><br><span class="line">    <span class="attr">assetsDir</span>: <span class="string">&#x27;assets&#x27;</span>,</span><br><span class="line">    <span class="attr">minify</span>: <span class="string">&#x27;terser&#x27;</span>,</span><br><span class="line">    <span class="attr">rollupOptions</span>: &#123;</span><br><span class="line">      <span class="attr">output</span>: &#123;</span><br><span class="line">        <span class="attr">manualChunks</span>: &#123;</span><br><span class="line">          <span class="string">&#x27;vendor&#x27;</span>: [<span class="string">&#x27;vue&#x27;</span>, <span class="string">&#x27;vue-router&#x27;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="4-èµ„æºå¤„ç†"><a href="#4-èµ„æºå¤„ç†" class="headerlink" title="4. èµ„æºå¤„ç†"></a>4. èµ„æºå¤„ç†</h2><h3 id="4-1-é™æ€èµ„æº"><a href="#4-1-é™æ€èµ„æº" class="headerlink" title="4.1 é™æ€èµ„æº"></a>4.1 é™æ€èµ„æº</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å›¾ç‰‡èµ„æº</span></span><br><span class="line"><span class="keyword">import</span> imgUrl <span class="keyword">from</span> <span class="string">&#x27;./img.png&#x27;</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;hero&#x27;</span>).<span class="property">src</span> = imgUrl</span><br><span class="line"></span><br><span class="line"><span class="comment">// CSS æ¨¡å—</span></span><br><span class="line"><span class="keyword">import</span> styles <span class="keyword">from</span> <span class="string">&#x27;./style.module.css&#x27;</span></span><br><span class="line">element.<span class="property">className</span> = styles.<span class="property">heading</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// JSON</span></span><br><span class="line"><span class="keyword">import</span> data <span class="keyword">from</span> <span class="string">&#x27;./data.json&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(data)</span><br></pre></td></tr></table></figure><h3 id="4-2-æ ·å¼å¤„ç†"><a href="#4-2-æ ·å¼å¤„ç†" class="headerlink" title="4.2 æ ·å¼å¤„ç†"></a>4.2 æ ·å¼å¤„ç†</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CSS é¢„å¤„ç†å™¨</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./style.scss&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// PostCSS é…ç½®</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">css</span>: &#123;</span><br><span class="line">    <span class="attr">postcss</span>: &#123;</span><br><span class="line">      <span class="attr">plugins</span>: [</span><br><span class="line">        <span class="title function_">autoprefixer</span>(),</span><br><span class="line">        <span class="title function_">postcssPresetEnv</span>()</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">modules</span>: &#123;</span><br><span class="line">      <span class="attr">localsConvention</span>: <span class="string">&#x27;camelCase&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-é…ç½®è¯¦è§£"><a href="#5-é…ç½®è¯¦è§£" class="headerlink" title="5. é…ç½®è¯¦è§£"></a>5. é…ç½®è¯¦è§£</h2><h3 id="5-1-åŸºç¡€é…ç½®"><a href="#5-1-åŸºç¡€é…ç½®" class="headerlink" title="5.1 åŸºç¡€é…ç½®"></a>5.1 åŸºç¡€é…ç½®</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; defineConfig &#125; <span class="keyword">from</span> <span class="string">&#x27;vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> vue <span class="keyword">from</span> <span class="string">&#x27;@vitejs/plugin-vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">root</span>: process.<span class="title function_">cwd</span>(),</span><br><span class="line">  <span class="attr">base</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">  <span class="attr">mode</span>: <span class="string">&#x27;development&#x27;</span>,</span><br><span class="line">  </span><br><span class="line">  <span class="attr">resolve</span>: &#123;</span><br><span class="line">    <span class="attr">alias</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;@&#x27;</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./src&#x27;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">extensions</span>: [<span class="string">&#x27;.mjs&#x27;</span>, <span class="string">&#x27;.js&#x27;</span>, <span class="string">&#x27;.ts&#x27;</span>, <span class="string">&#x27;.jsx&#x27;</span>, <span class="string">&#x27;.tsx&#x27;</span>, <span class="string">&#x27;.json&#x27;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="attr">plugins</span>: [<span class="title function_">vue</span>()]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="5-2-ç¯å¢ƒå˜é‡"><a href="#5-2-ç¯å¢ƒå˜é‡" class="headerlink" title="5.2 ç¯å¢ƒå˜é‡"></a>5.2 ç¯å¢ƒå˜é‡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .env</span></span><br><span class="line">VITE_APP_TITLE=My App</span><br><span class="line">VITE_API_URL=http://api.example.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># .env.development</span></span><br><span class="line">VITE_APP_TITLE=Dev App</span><br><span class="line">VITE_API_URL=http://dev-api.example.com</span><br></pre></td></tr></table></figure><h2 id="6-æ’ä»¶ç³»ç»Ÿ"><a href="#6-æ’ä»¶ç³»ç»Ÿ" class="headerlink" title="6. æ’ä»¶ç³»ç»Ÿ"></a>6. æ’ä»¶ç³»ç»Ÿ</h2><h3 id="6-1-æ’ä»¶å¼€å‘"><a href="#6-1-æ’ä»¶å¼€å‘" class="headerlink" title="6.1 æ’ä»¶å¼€å‘"></a>6.1 æ’ä»¶å¼€å‘</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">myPlugin</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;my-plugin&#x27;</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">configureServer</span>(<span class="params">server</span>) &#123;</span><br><span class="line">      <span class="comment">// æœåŠ¡å™¨é…ç½®</span></span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">transform</span>(<span class="params">code, id</span>) &#123;</span><br><span class="line">      <span class="comment">// ä»£ç è½¬æ¢</span></span><br><span class="line">      <span class="keyword">if</span> (id.<span class="title function_">endsWith</span>(<span class="string">&#x27;.vue&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          <span class="attr">code</span>: transformedCode,</span><br><span class="line">          <span class="attr">map</span>: sourceMap</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-2-å¸¸ç”¨æ’ä»¶"><a href="#6-2-å¸¸ç”¨æ’ä»¶" class="headerlink" title="6.2 å¸¸ç”¨æ’ä»¶"></a>6.2 å¸¸ç”¨æ’ä»¶</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> vue <span class="keyword">from</span> <span class="string">&#x27;@vitejs/plugin-vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> vueJsx <span class="keyword">from</span> <span class="string">&#x27;@vitejs/plugin-vue-jsx&#x27;</span></span><br><span class="line"><span class="keyword">import</span> legacy <span class="keyword">from</span> <span class="string">&#x27;@vitejs/plugin-legacy&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="title function_">vue</span>(),</span><br><span class="line">    <span class="title function_">vueJsx</span>(),</span><br><span class="line">    <span class="title function_">legacy</span>(&#123;</span><br><span class="line">      <span class="attr">targets</span>: [<span class="string">&#x27;defaults&#x27;</span>, <span class="string">&#x27;not IE 11&#x27;</span>]</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="7-ä¸»æµæ¡†æ¶"><a href="#7-ä¸»æµæ¡†æ¶" class="headerlink" title="7. ä¸»æµæ¡†æ¶"></a>7. ä¸»æµæ¡†æ¶</h2><h3 id="7-1-Vue-é›†æˆ"><a href="#7-1-Vue-é›†æˆ" class="headerlink" title="7.1 Vue é›†æˆ"></a>7.1 Vue é›†æˆ</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.js</span></span><br><span class="line"><span class="keyword">import</span> vue <span class="keyword">from</span> <span class="string">&#x27;@vitejs/plugin-vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="title function_">vue</span>(&#123;</span><br><span class="line">      <span class="attr">template</span>: &#123;</span><br><span class="line">        <span class="attr">compilerOptions</span>: &#123;</span><br><span class="line">          <span class="attr">isCustomElement</span>: <span class="function"><span class="params">tag</span> =&gt;</span> tag.<span class="title function_">startsWith</span>(<span class="string">&#x27;ion-&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="7-2-React-é›†æˆ"><a href="#7-2-React-é›†æˆ" class="headerlink" title="7.2 React é›†æˆ"></a>7.2 React é›†æˆ</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.js</span></span><br><span class="line"><span class="keyword">import</span> react <span class="keyword">from</span> <span class="string">&#x27;@vitejs/plugin-react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="title function_">react</span>(&#123;</span><br><span class="line">      <span class="attr">babel</span>: &#123;</span><br><span class="line">        <span class="attr">plugins</span>: [</span><br><span class="line">          [<span class="string">&#x27;@babel/plugin-proposal-decorators&#x27;</span>, &#123; <span class="attr">legacy</span>: <span class="literal">true</span> &#125;]</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="8-å·¥å…·é“¾é›†æˆ"><a href="#8-å·¥å…·é“¾é›†æˆ" class="headerlink" title="8. å·¥å…·é“¾é›†æˆ"></a>8. å·¥å…·é“¾é›†æˆ</h2><h3 id="8-1-TypeScript"><a href="#8-1-TypeScript" class="headerlink" title="8.1 TypeScript"></a>8.1 TypeScript</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">build</span>: &#123;</span><br><span class="line">    <span class="attr">target</span>: <span class="string">&#x27;esnext&#x27;</span>,</span><br><span class="line">    <span class="attr">rollupOptions</span>: &#123;</span><br><span class="line">      <span class="attr">input</span>: &#123;</span><br><span class="line">        <span class="attr">main</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// tsconfig.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;compilerOptions&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;target&quot;</span>: <span class="string">&quot;esnext&quot;</span>,</span><br><span class="line">    <span class="string">&quot;module&quot;</span>: <span class="string">&quot;esnext&quot;</span>,</span><br><span class="line">    <span class="string">&quot;moduleResolution&quot;</span>: <span class="string">&quot;node&quot;</span>,</span><br><span class="line">    <span class="string">&quot;strict&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;jsx&quot;</span>: <span class="string">&quot;preserve&quot;</span>,</span><br><span class="line">    <span class="string">&quot;sourceMap&quot;</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="9-æ€§èƒ½ä¼˜åŒ–"><a href="#9-æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="9. æ€§èƒ½ä¼˜åŒ–"></a>9. æ€§èƒ½ä¼˜åŒ–</h2><h3 id="9-1-æ„å»ºä¼˜åŒ–"><a href="#9-1-æ„å»ºä¼˜åŒ–" class="headerlink" title="9.1 æ„å»ºä¼˜åŒ–"></a>9.1 æ„å»ºä¼˜åŒ–</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">build</span>: &#123;</span><br><span class="line">    <span class="attr">target</span>: <span class="string">&#x27;modules&#x27;</span>,</span><br><span class="line">    <span class="attr">minify</span>: <span class="string">&#x27;terser&#x27;</span>,</span><br><span class="line">    <span class="attr">terserOptions</span>: &#123;</span><br><span class="line">      <span class="attr">compress</span>: &#123;</span><br><span class="line">        <span class="attr">drop_console</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">drop_debugger</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">rollupOptions</span>: &#123;</span><br><span class="line">      <span class="attr">output</span>: &#123;</span><br><span class="line">        <span class="title function_">manualChunks</span>(<span class="params">id</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (id.<span class="title function_">includes</span>(<span class="string">&#x27;node_modules&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;vendor&#x27;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="9-2-ä»£ç åˆ†å‰²"><a href="#9-2-ä»£ç åˆ†å‰²" class="headerlink" title="9.2 ä»£ç åˆ†å‰²"></a>9.2 ä»£ç åˆ†å‰²</h3><h4 id="9-2-1-åŸºç¡€é…ç½®"><a href="#9-2-1-åŸºç¡€é…ç½®" class="headerlink" title="9.2.1 åŸºç¡€é…ç½®"></a>9.2.1 åŸºç¡€é…ç½®</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">build</span>: &#123;</span><br><span class="line">    <span class="attr">rollupOptions</span>: &#123;</span><br><span class="line">      <span class="attr">output</span>: &#123;</span><br><span class="line">        <span class="comment">// 1. æ‰‹åŠ¨åˆ†å—ç­–ç•¥</span></span><br><span class="line">        <span class="attr">manualChunks</span>: &#123;</span><br><span class="line">          <span class="comment">// å°† Vue å…¨å®¶æ¡¶æ‹†åˆ†æˆå•ç‹¬çš„ chunk</span></span><br><span class="line">          <span class="string">&#x27;vue-vendor&#x27;</span>: [<span class="string">&#x27;vue&#x27;</span>, <span class="string">&#x27;vue-router&#x27;</span>, <span class="string">&#x27;pinia&#x27;</span>],</span><br><span class="line">          <span class="comment">// å°† UI æ¡†æ¶æ‹†åˆ†</span></span><br><span class="line">          <span class="string">&#x27;element-plus&#x27;</span>: [<span class="string">&#x27;element-plus&#x27;</span>],</span><br><span class="line">          <span class="comment">// å°†å¤§å‹ä¾èµ–æ‹†åˆ†</span></span><br><span class="line">          <span class="string">&#x27;lodash&#x27;</span>: [<span class="string">&#x27;lodash-es&#x27;</span>],</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 2. è‡ªå®šä¹‰ chunk æ–‡ä»¶å</span></span><br><span class="line">        <span class="attr">chunkFileNames</span>: <span class="function">(<span class="params">chunkInfo</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> facadeModuleId = chunkInfo.<span class="property">facadeModuleId</span></span><br><span class="line">          <span class="keyword">if</span> (facadeModuleId) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">`js/[name]-[hash].js`</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> <span class="string">&#x27;js/vendor-[hash].js&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 3. è‡ªå®šä¹‰èµ„æºæ–‡ä»¶å</span></span><br><span class="line">        <span class="attr">assetFileNames</span>: <span class="function">(<span class="params">assetInfo</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (assetInfo.<span class="property">name</span>.<span class="title function_">endsWith</span>(<span class="string">&#x27;.css&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;css/[name]-[hash][extname]&#x27;</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> <span class="string">&#x27;assets/[name]-[hash][extname]&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="9-2-2-åŠ¨æ€å¯¼å…¥"><a href="#9-2-2-åŠ¨æ€å¯¼å…¥" class="headerlink" title="9.2.2 åŠ¨æ€å¯¼å…¥"></a>9.2.2 åŠ¨æ€å¯¼å…¥</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. è·¯ç”±çº§åˆ«ä»£ç åˆ†å‰²</span></span><br><span class="line"><span class="comment">// router/index.js</span></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;../views/Home.vue&#x27;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/about&#x27;</span>,</span><br><span class="line">    <span class="comment">// æ·»åŠ æ³¨é‡Šä»¥æ§åˆ¶ chunk åç§°</span></span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="comment">/* webpackChunkName: &quot;about&quot; */</span> <span class="string">&#x27;../views/About.vue&#x27;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/dashboard&#x27;</span>,</span><br><span class="line">    <span class="comment">// é¢„åŠ è½½é‡è¦è·¯ç”±</span></span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="comment">/* webpackPrefetch: true */</span> <span class="string">&#x27;../views/Dashboard.vue&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. ç»„ä»¶çº§åˆ«ä»£ç åˆ†å‰²</span></span><br><span class="line"><span class="comment">// æŒ‰éœ€åŠ è½½ç»„ä»¶</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MyHeavyComponent</span> = <span class="title function_">defineAsyncComponent</span>(<span class="function">() =&gt;</span> </span><br><span class="line">  <span class="keyword">import</span>(<span class="string">&#x27;../components/MyHeavyComponent.vue&#x27;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. æ¡ä»¶å¯¼å…¥</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">loadAnalytics</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> analytics = <span class="keyword">await</span> <span class="keyword">import</span>(<span class="string">&#x27;./analytics&#x27;</span>)</span><br><span class="line">    analytics.<span class="title function_">init</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9-2-3-åˆ†å‰²ç­–ç•¥"><a href="#9-2-3-åˆ†å‰²ç­–ç•¥" class="headerlink" title="9.2.3 åˆ†å‰²ç­–ç•¥"></a>9.2.3 åˆ†å‰²ç­–ç•¥</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">build</span>: &#123;</span><br><span class="line">    <span class="attr">rollupOptions</span>: &#123;</span><br><span class="line">      <span class="attr">output</span>: &#123;</span><br><span class="line">        <span class="title function_">manualChunks</span>(<span class="params">id</span>) &#123;</span><br><span class="line">          <span class="comment">// 1. å°† node_modules ä¸­çš„ä»£ç å•ç‹¬æ‰“åŒ…</span></span><br><span class="line">          <span class="keyword">if</span> (id.<span class="title function_">includes</span>(<span class="string">&#x27;node_modules&#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">// è·å–åŒ…å</span></span><br><span class="line">            <span class="keyword">const</span> packageName = id.<span class="title function_">toString</span>().<span class="title function_">split</span>(<span class="string">&#x27;node_modules/&#x27;</span>)[<span class="number">1</span>].<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="comment">// å°†æ¯ä¸ªåŒ…å•ç‹¬æ‰“åŒ…</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">`vendor-<span class="subst">$&#123;packageName&#125;</span>`</span></span><br><span class="line">          &#125;</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 2. å°†å…¬å…±ç»„ä»¶æ‰“åŒ…åˆ°ä¸€èµ·</span></span><br><span class="line">          <span class="keyword">if</span> (id.<span class="title function_">includes</span>(<span class="string">&#x27;src/components&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;components&#x27;</span></span><br><span class="line">          &#125;</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 3. å°†å·¥å…·å‡½æ•°æ‰“åŒ…åˆ°ä¸€èµ·</span></span><br><span class="line">          <span class="keyword">if</span> (id.<span class="title function_">includes</span>(<span class="string">&#x27;src/utils&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;utils&#x27;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="9-2-4-é¢„åŠ è½½å’Œé¢„è·å–"><a href="#9-2-4-é¢„åŠ è½½å’Œé¢„è·å–" class="headerlink" title="9.2.4 é¢„åŠ è½½å’Œé¢„è·å–"></a>9.2.4 é¢„åŠ è½½å’Œé¢„è·å–</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. ä½¿ç”¨ vite-plugin-imagemin ä¼˜åŒ–å›¾ç‰‡</span></span><br><span class="line"><span class="keyword">import</span> viteImagemin <span class="keyword">from</span> <span class="string">&#x27;vite-plugin-imagemin&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="title function_">viteImagemin</span>(&#123;</span><br><span class="line">      <span class="attr">gifsicle</span>: &#123; <span class="attr">optimizationLevel</span>: <span class="number">3</span> &#125;,</span><br><span class="line">      <span class="attr">mozjpeg</span>: &#123; <span class="attr">quality</span>: <span class="number">75</span> &#125;,</span><br><span class="line">      <span class="attr">pngquant</span>: &#123; <span class="attr">quality</span>: [<span class="number">0.7</span>, <span class="number">0.8</span>] &#125;,</span><br><span class="line">      <span class="attr">svgo</span>: &#123;</span><br><span class="line">        <span class="attr">plugins</span>: [</span><br><span class="line">          &#123; <span class="attr">removeViewBox</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">          &#123; <span class="attr">removeDimensions</span>: <span class="literal">true</span> &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. èµ„æºé¢„åŠ è½½</span></span><br><span class="line"><span class="comment">// index.html</span></span><br><span class="line">&lt;link rel=<span class="string">&quot;modulepreload&quot;</span> href=<span class="string">&quot;/src/heavy-module.js&quot;</span>&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;preload&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/assets/large-image.jpg&quot;</span> <span class="attr">as</span>=<span class="string">&quot;image&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">// 3. åŠ¨æ€é¢„åŠ è½½</span></span><br><span class="line"><span class="language-xml">const preloadComponent = () =&gt; &#123;</span></span><br><span class="line"><span class="language-xml">  const component = import(&#x27;./BigComponent.vue&#x27;)</span></span><br><span class="line"><span class="language-xml">  requestIdleCallback(() =&gt; &#123;</span></span><br><span class="line"><span class="language-xml">    // åœ¨ç©ºé—²æ—¶é—´é¢„åŠ è½½å…¶ä»–èµ„æº</span></span><br><span class="line"><span class="language-xml">    import(&#x27;./non-critical-module.js&#x27;)</span></span><br><span class="line"><span class="language-xml">  &#125;)</span></span><br><span class="line"><span class="language-xml">  return component</span></span><br><span class="line"><span class="language-xml">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="9-2-5-åˆ†å‰²ä¼˜åŒ–å»ºè®®"><a href="#9-2-5-åˆ†å‰²ä¼˜åŒ–å»ºè®®" class="headerlink" title="9.2.5 åˆ†å‰²ä¼˜åŒ–å»ºè®®"></a>9.2.5 åˆ†å‰²ä¼˜åŒ–å»ºè®®</h4><ol><li><strong>åˆç†çš„åˆ†å‰²ç²’åº¦</strong></li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸å¥½çš„å®è·µ - è¿‡åº¦åˆ†å‰²</span></span><br><span class="line"><span class="attr">manualChunks</span>: &#123;</span><br><span class="line">  <span class="string">&#x27;tiny-lib&#x27;</span>: [<span class="string">&#x27;tiny-lib&#x27;</span>], <span class="comment">// è¿™ä¸ªåº“å¤ªå°ï¼Œä¸å€¼å¾—å•ç‹¬åˆ†å‰²</span></span><br><span class="line">  <span class="string">&#x27;utils&#x27;</span>: [<span class="string">&#x27;./src/utils/format.js&#x27;</span>] <span class="comment">// å·¥å…·å‡½æ•°å¤ªå°ï¼Œåº”è¯¥åˆå¹¶</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¥½çš„å®è·µ - é€‚å½“åˆ†å‰²</span></span><br><span class="line"><span class="attr">manualChunks</span>: &#123;</span><br><span class="line">  <span class="string">&#x27;core-vendor&#x27;</span>: [<span class="string">&#x27;vue&#x27;</span>, <span class="string">&#x27;vue-router&#x27;</span>, <span class="string">&#x27;pinia&#x27;</span>], <span class="comment">// æ ¸å¿ƒä¾èµ–æ‰“åŒ…åœ¨ä¸€èµ·</span></span><br><span class="line">  <span class="string">&#x27;ui-vendor&#x27;</span>: [<span class="string">&#x27;element-plus&#x27;</span>], <span class="comment">// UI æ¡†æ¶å•ç‹¬æ‰“åŒ…</span></span><br><span class="line">  <span class="string">&#x27;big-vendor&#x27;</span>: [<span class="string">&#x27;echarts&#x27;</span>, <span class="string">&#x27;three.js&#x27;</span>] <span class="comment">// å¤§å‹ä¾èµ–å•ç‹¬æ‰“åŒ…</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li><strong>åŠ¨æ€å¯¼å…¥æœ€ä½³å®è·µ</strong></li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç»„ä»¶åŠ¨æ€å¯¼å…¥</span></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/dashboard&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;./views/Dashboard.vue&#x27;</span>),</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ webpackPreload ç¡®ä¿å…³é”®è·¯ç”±å¿«é€ŸåŠ è½½</span></span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;overview&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="comment">/* webpackPrefetch: true */</span> <span class="string">&#x27;./views/Overview.vue&#x27;</span>)</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;analysis&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="comment">/* webpackPreload: true */</span> <span class="string">&#x27;./views/Analysis.vue&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><ol start="3"><li><strong>æ€§èƒ½ç›‘æ§</strong></li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç›‘æ§ä»£ç åˆ†å‰²æ€§èƒ½</span></span><br><span class="line"><span class="keyword">import</span> &#123; onLCP, onFID &#125; <span class="keyword">from</span> <span class="string">&#x27;web-vitals&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘æ§åŠ è½½æ€§èƒ½</span></span><br><span class="line"><span class="title function_">onLCP</span>(<span class="variable language_">console</span>.<span class="property">log</span>)</span><br><span class="line"><span class="title function_">onFID</span>(<span class="variable language_">console</span>.<span class="property">log</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘æ§ chunk åŠ è½½å¤±è´¥</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (event.<span class="property">target</span>.<span class="property">tagName</span> === <span class="string">&#x27;SCRIPT&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// å¤„ç† chunk åŠ è½½å¤±è´¥</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Chunk load failed:&#x27;</span>, event.<span class="property">target</span>.<span class="property">src</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="literal">true</span>)</span><br></pre></td></tr></table></figure><p>è¿™æ ·çš„ä»£ç åˆ†å‰²å†…å®¹æ›´åŠ å®Œæ•´å’Œå‡†ç¡®ï¼Œæ¶µç›–äº†ï¼š</p><ul><li>åŸºç¡€é…ç½®</li><li>åŠ¨æ€å¯¼å…¥</li><li>åˆ†å‰²ç­–ç•¥</li><li>é¢„åŠ è½½å’Œé¢„è·å–</li><li>æœ€ä½³å®è·µå’Œæ€§èƒ½ç›‘æ§</li></ul><p>æ¯ä¸ªéƒ¨åˆ†éƒ½æä¾›äº†å…·ä½“çš„ä»£ç ç¤ºä¾‹å’Œå®è·µå»ºè®®ï¼Œæ›´æœ‰åŠ©äºç†è§£å’Œå®æ–½ä»£ç åˆ†å‰²ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 10. éƒ¨ç½²è¿ç»´</span><br><span class="line"></span><br><span class="line">### 10.1 é™æ€éƒ¨ç½²</span><br><span class="line">```javascript</span><br><span class="line">// vite.config.js</span><br><span class="line">export default defineConfig(&#123;</span><br><span class="line">  base: production ? &#x27;/your-repo/&#x27; : &#x27;/&#x27;,</span><br><span class="line">  build: &#123;</span><br><span class="line">    outDir: &#x27;dist&#x27;,</span><br><span class="line">    emptyOutDir: true,</span><br><span class="line">    sourcemap: true,</span><br><span class="line">    manifest: true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="10-2-CI-CD-é…ç½®"><a href="#10-2-CI-CD-é…ç½®" class="headerlink" title="10.2 CI&#x2F;CD é…ç½®"></a>10.2 CI&#x2F;CD é…ç½®</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .github/workflows/deploy.yml</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">Deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span> [<span class="string">main</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build-and-deploy:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/setup-node@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">node-version:</span> <span class="string">&#x27;16&#x27;</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">and</span> <span class="string">Build</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          npm ci</span></span><br><span class="line"><span class="string">          npm run build</span></span><br><span class="line"><span class="string"></span>      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">peaceiris/actions-gh-pages@v3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">github_token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">publish_dir:</span> <span class="string">./dist</span></span><br></pre></td></tr></table></figure><h3 id="10-3-æ€§èƒ½ç›‘æ§"><a href="#10-3-æ€§èƒ½ç›‘æ§" class="headerlink" title="10.3 æ€§èƒ½ç›‘æ§"></a>10.3 æ€§èƒ½ç›‘æ§</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ€§èƒ½æŒ‡æ ‡ç›‘æ§</span></span><br><span class="line"><span class="keyword">import</span> &#123; onCLS, onFID, onLCP &#125; <span class="keyword">from</span> <span class="string">&#x27;web-vitals&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sendToAnalytics</span>(<span class="params">&#123; name, delta, id &#125;</span>) &#123;</span><br><span class="line">  <span class="comment">// å‘é€æ€§èƒ½æ•°æ®åˆ°åˆ†ææœåŠ¡</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Metric: <span class="subst">$&#123;name&#125;</span> ID: <span class="subst">$&#123;id&#125;</span> Value: <span class="subst">$&#123;delta&#125;</span>`</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">onCLS</span>(sendToAnalytics)</span><br><span class="line"><span class="title function_">onFID</span>(sendToAnalytics)</span><br><span class="line"><span class="title function_">onLCP</span>(sendToAnalytics)</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Vite-å®Œå…¨æŒ‡å—ï¼šä»å…¥é—¨åˆ°ç²¾é€š&quot;&gt;&lt;a href=&quot;#Vite-å®Œå…¨æŒ‡å—ï¼šä»å…¥é—¨åˆ°ç²¾é€š&quot; class=&quot;headerlink&quot; title=&quot;Vite å®Œå…¨æŒ‡å—ï¼šä»å…¥é—¨åˆ°ç²¾é€š&quot;&gt;&lt;/a&gt;Vite å®Œå…¨æŒ‡å—ï¼šä»å…¥é—¨åˆ°ç²¾é€š&lt;/h1&gt;&lt;h2 id=&quot;ç›®å½•&quot;&gt;&lt;a hr</summary>
      
    
    
    
    
    <category term="å…¥é—¨" scheme="https://aoayaoa.github.io/tags/%E5%85%A5%E9%97%A8/"/>
    
    <category term="vite" scheme="https://aoayaoa.github.io/tags/vite/"/>
    
  </entry>
  
  <entry>
    <title>webpack</title>
    <link href="https://aoayaoa.github.io/2023/05/26/webpack/"/>
    <id>https://aoayaoa.github.io/2023/05/26/webpack/</id>
    <published>2023-05-25T16:00:00.000Z</published>
    <updated>2025-03-07T03:53:32.519Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Webpack-å®Œå…¨æŒ‡å—ï¼šä»å…¥é—¨åˆ°ç²¾é€š"><a href="#Webpack-å®Œå…¨æŒ‡å—ï¼šä»å…¥é—¨åˆ°ç²¾é€š" class="headerlink" title="Webpack å®Œå…¨æŒ‡å—ï¼šä»å…¥é—¨åˆ°ç²¾é€š"></a>Webpack å®Œå…¨æŒ‡å—ï¼šä»å…¥é—¨åˆ°ç²¾é€š</h1><h2 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h2><ul><li><a href="#1-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5">1. åŸºç¡€æ¦‚å¿µ</a></li><li><a href="#2-%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD">2. æ ¸å¿ƒåŠŸèƒ½</a></li><li><a href="#3-%E6%89%93%E5%8C%85%E5%8E%9F%E7%90%86">3. æ‰“åŒ…åŸç†</a></li><li><a href="#4-%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3">4. é…ç½®è¯¦è§£</a></li><li><a href="#5-loader-%E4%BD%93%E7%B3%BB">5. Loader ä½“ç³»</a></li><li><a href="#6-plugin-%E4%BD%93%E7%B3%BB">6. Plugin ä½“ç³»</a></li><li><a href="#7-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">7. æ€§èƒ½ä¼˜åŒ–</a></li><li><a href="#8-%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8">8. å®æˆ˜åº”ç”¨</a></li><li><a href="#9-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7">9. é«˜çº§ç‰¹æ€§</a></li><li><a href="#10-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">10. æœ€ä½³å®è·µ</a></li></ul><h2 id="1-åŸºç¡€æ¦‚å¿µ"><a href="#1-åŸºç¡€æ¦‚å¿µ" class="headerlink" title="1. åŸºç¡€æ¦‚å¿µ"></a>1. åŸºç¡€æ¦‚å¿µ</h2><h3 id="1-1-ä»€ä¹ˆæ˜¯-Webpackï¼Ÿ"><a href="#1-1-ä»€ä¹ˆæ˜¯-Webpackï¼Ÿ" class="headerlink" title="1.1 ä»€ä¹ˆæ˜¯ Webpackï¼Ÿ"></a>1.1 ä»€ä¹ˆæ˜¯ Webpackï¼Ÿ</h3><p><img src= "/img/loading.gif" data-lazy-src="https://webpack.js.org/assets/what-is-webpack.png" alt="Webpackå·¥ä½œåŸç†"></p><p>Webpack æ˜¯ä¸€ä¸ªç°ä»£ JavaScript åº”ç”¨ç¨‹åºçš„é™æ€æ¨¡å—æ‰“åŒ…å·¥å…·ã€‚å®ƒå°†é¡¹ç›®ä¸­çš„æ‰€æœ‰èµ„æºè§†ä¸ºæ¨¡å—ï¼Œé€šè¿‡ä¾èµ–å…³ç³»å›¾æ„å»ºåº”ç”¨ã€‚</p><h3 id="1-2-æ ¸å¿ƒæ¦‚å¿µ"><a href="#1-2-æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="1.2 æ ¸å¿ƒæ¦‚å¿µ"></a>1.2 æ ¸å¿ƒæ¦‚å¿µ</h3><h4 id="1-2-1-å…¥å£-Entry"><a href="#1-2-1-å…¥å£-Entry" class="headerlink" title="1.2.1 å…¥å£(Entry)"></a>1.2.1 å…¥å£(Entry)</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å•å…¥å£</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&#x27;./src/index.js&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤šå…¥å£</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">entry</span>: &#123;</span><br><span class="line">    <span class="attr">main</span>: <span class="string">&#x27;./src/main.js&#x27;</span>,</span><br><span class="line">    <span class="attr">vendor</span>: <span class="string">&#x27;./src/vendor.js&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-2-2-è¾“å‡º-Output"><a href="#1-2-2-è¾“å‡º-Output" class="headerlink" title="1.2.2 è¾“å‡º(Output)"></a>1.2.2 è¾“å‡º(Output)</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;dist&#x27;</span>),</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&#x27;[name].[contenthash].js&#x27;</span>,</span><br><span class="line">    <span class="attr">clean</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">publicPath</span>: <span class="string">&#x27;/&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-2-3-æ¨¡å—-Module"><a href="#1-2-3-æ¨¡å—-Module" class="headerlink" title="1.2.3 æ¨¡å—(Module)"></a>1.2.3 æ¨¡å—(Module)</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="attr">use</span>: <span class="string">&#x27;babel-loader&#x27;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [<span class="string">&#x27;style-loader&#x27;</span>, <span class="string">&#x27;css-loader&#x27;</span>]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-2-4-æ’ä»¶-Plugin"><a href="#1-2-4-æ’ä»¶-Plugin" class="headerlink" title="1.2.4 æ’ä»¶(Plugin)"></a>1.2.4 æ’ä»¶(Plugin)</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">HtmlWebpackPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;html-webpack-plugin&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MiniCssExtractPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;mini-css-extract-plugin&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HtmlWebpackPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">template</span>: <span class="string">&#x27;./src/index.html&#x27;</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">MiniCssExtractPlugin</span>()</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-æ ¸å¿ƒåŠŸèƒ½"><a href="#2-æ ¸å¿ƒåŠŸèƒ½" class="headerlink" title="2. æ ¸å¿ƒåŠŸèƒ½"></a>2. æ ¸å¿ƒåŠŸèƒ½</h2><h3 id="2-1-æ¨¡å—è§£æ"><a href="#2-1-æ¨¡å—è§£æ" class="headerlink" title="2.1 æ¨¡å—è§£æ"></a>2.1 æ¨¡å—è§£æ</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">resolve</span>: &#123;</span><br><span class="line">    <span class="comment">// æ¨¡å—åˆ«å</span></span><br><span class="line">    <span class="attr">alias</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;@&#x27;</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;src&#x27;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// æ‰©å±•å</span></span><br><span class="line">    <span class="attr">extensions</span>: [<span class="string">&#x27;.js&#x27;</span>, <span class="string">&#x27;.jsx&#x27;</span>, <span class="string">&#x27;.ts&#x27;</span>, <span class="string">&#x27;.tsx&#x27;</span>],</span><br><span class="line">    <span class="comment">// æ¨¡å—æŸ¥æ‰¾ç›®å½•</span></span><br><span class="line">    <span class="attr">modules</span>: [<span class="string">&#x27;node_modules&#x27;</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-ä»£ç åˆ†å‰²"><a href="#2-2-ä»£ç åˆ†å‰²" class="headerlink" title="2.2 ä»£ç åˆ†å‰²"></a>2.2 ä»£ç åˆ†å‰²</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">optimization</span>: &#123;</span><br><span class="line">    <span class="attr">splitChunks</span>: &#123;</span><br><span class="line">      <span class="attr">chunks</span>: <span class="string">&#x27;all&#x27;</span>,</span><br><span class="line">      <span class="attr">minSize</span>: <span class="number">20000</span>,</span><br><span class="line">      <span class="attr">minChunks</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">maxAsyncRequests</span>: <span class="number">30</span>,</span><br><span class="line">      <span class="attr">maxInitialRequests</span>: <span class="number">30</span>,</span><br><span class="line">      <span class="attr">cacheGroups</span>: &#123;</span><br><span class="line">        <span class="attr">defaultVendors</span>: &#123;</span><br><span class="line">          <span class="attr">test</span>: <span class="regexp">/[\\/]node_modules[\\/]/</span>,</span><br><span class="line">          <span class="attr">priority</span>: -<span class="number">10</span>,</span><br><span class="line">          <span class="attr">reuseExistingChunk</span>: <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">default</span>: &#123;</span><br><span class="line">          <span class="attr">minChunks</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">priority</span>: -<span class="number">20</span>,</span><br><span class="line">          <span class="attr">reuseExistingChunk</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-3-èµ„æºæ¨¡å—"><a href="#2-3-èµ„æºæ¨¡å—" class="headerlink" title="2.3 èµ„æºæ¨¡å—"></a>2.3 èµ„æºæ¨¡å—</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      <span class="comment">// å›¾ç‰‡å¤„ç†</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.(png|svg|jpg|jpeg|gif)$/i</span>,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;asset&#x27;</span>,</span><br><span class="line">        <span class="attr">parser</span>: &#123;</span><br><span class="line">          <span class="attr">dataUrlCondition</span>: &#123;</span><br><span class="line">            <span class="attr">maxSize</span>: <span class="number">4</span> * <span class="number">1024</span> <span class="comment">// 4kb</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">generator</span>: &#123;</span><br><span class="line">          <span class="attr">filename</span>: <span class="string">&#x27;images/[hash][ext][query]&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// å­—ä½“å¤„ç†</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.(woff|woff2|eot|ttf|otf)$/i</span>,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;asset/resource&#x27;</span>,</span><br><span class="line">        <span class="attr">generator</span>: &#123;</span><br><span class="line">          <span class="attr">filename</span>: <span class="string">&#x27;fonts/[hash][ext][query]&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-æ‰“åŒ…åŸç†"><a href="#3-æ‰“åŒ…åŸç†" class="headerlink" title="3. æ‰“åŒ…åŸç†"></a>3. æ‰“åŒ…åŸç†</h2><h3 id="3-1-æ„å»ºæµç¨‹"><a href="#3-1-æ„å»ºæµç¨‹" class="headerlink" title="3.1 æ„å»ºæµç¨‹"></a>3.1 æ„å»ºæµç¨‹</h3><p><img src= "/img/loading.gif" data-lazy-src="https://webpack.js.org/assets/compilation.png" alt="Webpackæ„å»ºæµç¨‹"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Compiler</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span> = options;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hooks</span> = &#123;</span><br><span class="line">      <span class="attr">run</span>: <span class="keyword">new</span> <span class="title class_">SyncHook</span>(),</span><br><span class="line">      <span class="attr">emit</span>: <span class="keyword">new</span> <span class="title class_">AsyncSeriesHook</span>([<span class="string">&#x27;compilation&#x27;</span>]),</span><br><span class="line">      <span class="attr">done</span>: <span class="keyword">new</span> <span class="title class_">AsyncSeriesHook</span>([<span class="string">&#x27;stats&#x27;</span>])</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 1. åˆå§‹åŒ–å‚æ•°</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">run</span>.<span class="title function_">call</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. å¼€å§‹ç¼–è¯‘</span></span><br><span class="line">    <span class="keyword">const</span> compilation = <span class="keyword">new</span> <span class="title class_">Compilation</span>(<span class="variable language_">this</span>.<span class="property">options</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. æ„å»ºæ¨¡å—</span></span><br><span class="line">    compilation.<span class="title function_">build</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. ä¼˜åŒ–</span></span><br><span class="line">    compilation.<span class="title function_">optimize</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. è¾“å‡ºèµ„æº</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">emit</span>.<span class="title function_">callAsync</span>(compilation, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="title function_">callback</span>(err);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 6. å®Œæˆæ„å»º</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">done</span>.<span class="title function_">callAsync</span>(compilation.<span class="title function_">getStats</span>(), <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="title function_">callback</span>(err);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-2-æ¨¡å—ä¾èµ–å›¾"><a href="#3-2-æ¨¡å—ä¾èµ–å›¾" class="headerlink" title="3.2 æ¨¡å—ä¾èµ–å›¾"></a>3.2 æ¨¡å—ä¾èµ–å›¾</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DependencyGraph</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">modules</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">addModule</span>(<span class="params"><span class="variable language_">module</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">modules</span>.<span class="title function_">set</span>(<span class="variable language_">module</span>.<span class="property">id</span>, &#123;</span><br><span class="line">      <span class="attr">id</span>: <span class="variable language_">module</span>.<span class="property">id</span>,</span><br><span class="line">      <span class="attr">dependencies</span>: <span class="variable language_">module</span>.<span class="property">dependencies</span>,</span><br><span class="line">      <span class="attr">code</span>: <span class="variable language_">module</span>.<span class="property">code</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createBundle</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> modules = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">modules</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">module</span> =&gt;</span> &#123;</span><br><span class="line">      modules += <span class="string">`</span></span><br><span class="line"><span class="string">        <span class="subst">$&#123;<span class="variable language_">module</span>.id&#125;</span>: function(module, exports, require) &#123;</span></span><br><span class="line"><span class="string">          <span class="subst">$&#123;<span class="variable language_">module</span>.code&#125;</span></span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">      `</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">      (function(modules) &#123;</span></span><br><span class="line"><span class="string">        function require(id) &#123;</span></span><br><span class="line"><span class="string">          const module = &#123; exports: &#123;&#125; &#125;;</span></span><br><span class="line"><span class="string">          modules[id](module, module.exports, require);</span></span><br><span class="line"><span class="string">          return module.exports;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        require(0);</span></span><br><span class="line"><span class="string">      &#125;)(&#123;<span class="subst">$&#123;modules&#125;</span>&#125;)</span></span><br><span class="line"><span class="string">    `</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-é…ç½®è¯¦è§£"><a href="#4-é…ç½®è¯¦è§£" class="headerlink" title="4. é…ç½®è¯¦è§£"></a>4. é…ç½®è¯¦è§£</h2><h3 id="4-1-åŸºç¡€é…ç½®"><a href="#4-1-åŸºç¡€é…ç½®" class="headerlink" title="4.1 åŸºç¡€é…ç½®"></a>4.1 åŸºç¡€é…ç½®</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">HtmlWebpackPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;html-webpack-plugin&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MiniCssExtractPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;mini-css-extract-plugin&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">// æ¨¡å¼</span></span><br><span class="line">  <span class="attr">mode</span>: <span class="string">&#x27;production&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å…¥å£</span></span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&#x27;./src/index.js&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¾“å‡º</span></span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;dist&#x27;</span>),</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&#x27;[name].[contenthash].js&#x27;</span>,</span><br><span class="line">    <span class="attr">clean</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¨¡å—å¤„ç†</span></span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="attr">exclude</span>: <span class="regexp">/node_modules/</span>,</span><br><span class="line">        <span class="attr">use</span>: &#123;</span><br><span class="line">          <span class="attr">loader</span>: <span class="string">&#x27;babel-loader&#x27;</span>,</span><br><span class="line">          <span class="attr">options</span>: &#123;</span><br><span class="line">            <span class="attr">presets</span>: [<span class="string">&#x27;@babel/preset-env&#x27;</span>]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [</span><br><span class="line">          <span class="title class_">MiniCssExtractPlugin</span>.<span class="property">loader</span>,</span><br><span class="line">          <span class="string">&#x27;css-loader&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;postcss-loader&#x27;</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ’ä»¶</span></span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HtmlWebpackPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">template</span>: <span class="string">&#x27;./src/index.html&#x27;</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">MiniCssExtractPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">filename</span>: <span class="string">&#x27;css/[name].[contenthash].css&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¼˜åŒ–</span></span><br><span class="line">  <span class="attr">optimization</span>: &#123;</span><br><span class="line">    <span class="attr">minimize</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">minimizer</span>: [</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">TerserPlugin</span>(),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">CssMinimizerPlugin</span>()</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="5-Loader-ä½“ç³»"><a href="#5-Loader-ä½“ç³»" class="headerlink" title="5. Loader ä½“ç³»"></a>5. Loader ä½“ç³»</h2><h3 id="5-1-Loader-åŸç†"><a href="#5-1-Loader-åŸç†" class="headerlink" title="5.1 Loader åŸç†"></a>5.1 Loader åŸç†</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è‡ªå®šä¹‰ loader ç¤ºä¾‹</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span>(<span class="params">source</span>) &#123;</span><br><span class="line">  <span class="comment">// loader ä¸Šä¸‹æ–‡</span></span><br><span class="line">  <span class="keyword">const</span> options = <span class="variable language_">this</span>.<span class="title function_">getOptions</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å¼‚æ­¥å¤„ç†</span></span><br><span class="line">  <span class="keyword">const</span> callback = <span class="variable language_">this</span>.<span class="title function_">async</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// æºç è½¬æ¢</span></span><br><span class="line">  <span class="keyword">const</span> transformedSource = <span class="title function_">transform</span>(source, options);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// è¿”å›è½¬æ¢åçš„ä»£ç </span></span><br><span class="line">  <span class="title function_">callback</span>(<span class="literal">null</span>, transformedSource);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="5-2-å¸¸ç”¨-Loader"><a href="#5-2-å¸¸ç”¨-Loader" class="headerlink" title="5.2 å¸¸ç”¨ Loader"></a>5.2 å¸¸ç”¨ Loader</h3><h4 id="5-2-1-æ ·å¼å¤„ç†"><a href="#5-2-1-æ ·å¼å¤„ç†" class="headerlink" title="5.2.1 æ ·å¼å¤„ç†"></a>5.2.1 æ ·å¼å¤„ç†</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      <span class="comment">// CSSå¤„ç†</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [</span><br><span class="line">          <span class="string">&#x27;style-loader&#x27;</span>,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&#x27;css-loader&#x27;</span>,</span><br><span class="line">            <span class="attr">options</span>: &#123;</span><br><span class="line">              <span class="attr">modules</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">importLoaders</span>: <span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&#x27;postcss-loader&#x27;</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// SASSå¤„ç†</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.scss$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [</span><br><span class="line">          <span class="string">&#x27;style-loader&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;css-loader&#x27;</span>,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&#x27;sass-loader&#x27;</span>,</span><br><span class="line">            <span class="attr">options</span>: &#123;</span><br><span class="line">              <span class="attr">implementation</span>: <span class="built_in">require</span>(<span class="string">&#x27;sass&#x27;</span>),</span><br><span class="line">              <span class="attr">sassOptions</span>: &#123;</span><br><span class="line">                <span class="attr">fiber</span>: <span class="literal">false</span>,</span><br><span class="line">              &#125;,</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-2-2-æ–‡ä»¶å¤„ç†"><a href="#5-2-2-æ–‡ä»¶å¤„ç†" class="headerlink" title="5.2.2 æ–‡ä»¶å¤„ç†"></a>5.2.2 æ–‡ä»¶å¤„ç†</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      <span class="comment">// å›¾ç‰‡ä¼˜åŒ–</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.(png|jpg|gif)$/i</span>,</span><br><span class="line">        <span class="attr">use</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&#x27;image-webpack-loader&#x27;</span>,</span><br><span class="line">            <span class="attr">options</span>: &#123;</span><br><span class="line">              <span class="attr">mozjpeg</span>: &#123;</span><br><span class="line">                <span class="attr">progressive</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">quality</span>: <span class="number">65</span></span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="attr">optipng</span>: &#123;</span><br><span class="line">                <span class="attr">enabled</span>: <span class="literal">false</span>,</span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="attr">pngquant</span>: &#123;</span><br><span class="line">                <span class="attr">quality</span>: [<span class="number">0.65</span>, <span class="number">0.90</span>],</span><br><span class="line">                <span class="attr">speed</span>: <span class="number">4</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// SVGå¤„ç†</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.svg$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [<span class="string">&#x27;@svgr/webpack&#x27;</span>]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="6-Plugin-ä½“ç³»"><a href="#6-Plugin-ä½“ç³»" class="headerlink" title="6. Plugin ä½“ç³»"></a>6. Plugin ä½“ç³»</h2><h3 id="6-1-Plugin-åŸç†"><a href="#6-1-Plugin-åŸç†" class="headerlink" title="6.1 Plugin åŸç†"></a>6.1 Plugin åŸç†</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyPlugin</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span> = options;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">apply</span>(<span class="params">compiler</span>) &#123;</span><br><span class="line">    <span class="comment">// æ³¨å†Œé’©å­</span></span><br><span class="line">    compiler.<span class="property">hooks</span>.<span class="property">emit</span>.<span class="title function_">tapAsync</span>(</span><br><span class="line">      <span class="string">&#x27;MyPlugin&#x27;</span>,</span><br><span class="line">      <span class="function">(<span class="params">compilation, callback</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// æ·»åŠ èµ„æº</span></span><br><span class="line">        compilation.<span class="property">assets</span>[<span class="string">&#x27;file.txt&#x27;</span>] = &#123;</span><br><span class="line">          <span class="attr">source</span>: <span class="function">() =&gt;</span> <span class="string">&#x27;generated content&#x27;</span>,</span><br><span class="line">          <span class="attr">size</span>: <span class="function">() =&gt;</span> <span class="string">&#x27;generated content&#x27;</span>.<span class="property">length</span></span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="title function_">callback</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">MyPlugin</span>;</span><br></pre></td></tr></table></figure><h3 id="6-2-å¸¸ç”¨-Plugin"><a href="#6-2-å¸¸ç”¨-Plugin" class="headerlink" title="6.2 å¸¸ç”¨ Plugin"></a>6.2 å¸¸ç”¨ Plugin</h3><h4 id="6-2-1-ä¼˜åŒ–ç±»"><a href="#6-2-1-ä¼˜åŒ–ç±»" class="headerlink" title="6.2.1 ä¼˜åŒ–ç±»"></a>6.2.1 ä¼˜åŒ–ç±»</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">CompressionPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;compression-webpack-plugin&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">BundleAnalyzerPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;webpack-bundle-analyzer&#x27;</span>).<span class="property">BundleAnalyzerPlugin</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="comment">// Gzipå‹ç¼©</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">CompressionPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">algorithm</span>: <span class="string">&#x27;gzip&#x27;</span>,</span><br><span class="line">      <span class="attr">test</span>: <span class="regexp">/\.(js|css|html|svg)$/</span>,</span><br><span class="line">      <span class="attr">threshold</span>: <span class="number">10240</span>,</span><br><span class="line">      <span class="attr">minRatio</span>: <span class="number">0.8</span></span><br><span class="line">    &#125;),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åŒ…åˆ†æ</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">BundleAnalyzerPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">analyzerMode</span>: <span class="string">&#x27;static&#x27;</span>,</span><br><span class="line">      <span class="attr">openAnalyzer</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">reportFilename</span>: <span class="string">&#x27;bundle-report.html&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-2-2-åŠŸèƒ½å¢å¼ºç±»"><a href="#6-2-2-åŠŸèƒ½å¢å¼ºç±»" class="headerlink" title="6.2.2 åŠŸèƒ½å¢å¼ºç±»"></a>6.2.2 åŠŸèƒ½å¢å¼ºç±»</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">CopyPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;copy-webpack-plugin&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">WorkboxPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;workbox-webpack-plugin&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="comment">// å¤åˆ¶é™æ€èµ„æº</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">CopyPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">patterns</span>: [</span><br><span class="line">        &#123; <span class="attr">from</span>: <span class="string">&#x27;public&#x27;</span>, <span class="attr">to</span>: <span class="string">&#x27;assets&#x27;</span> &#125;</span><br><span class="line">      ],</span><br><span class="line">    &#125;),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// PWAæ”¯æŒ</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">WorkboxPlugin</span>.<span class="title class_">GenerateSW</span>(&#123;</span><br><span class="line">      <span class="attr">clientsClaim</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">skipWaiting</span>: <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="7-æ€§èƒ½ä¼˜åŒ–"><a href="#7-æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="7. æ€§èƒ½ä¼˜åŒ–"></a>7. æ€§èƒ½ä¼˜åŒ–</h2><h3 id="7-1-æ„å»ºæ€§èƒ½ä¼˜åŒ–"><a href="#7-1-æ„å»ºæ€§èƒ½ä¼˜åŒ–" class="headerlink" title="7.1 æ„å»ºæ€§èƒ½ä¼˜åŒ–"></a>7.1 æ„å»ºæ€§èƒ½ä¼˜åŒ–</h3><h4 id="7-1-1-ç¼“å­˜ä¼˜åŒ–"><a href="#7-1-1-ç¼“å­˜ä¼˜åŒ–" class="headerlink" title="7.1.1 ç¼“å­˜ä¼˜åŒ–"></a>7.1.1 ç¼“å­˜ä¼˜åŒ–</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">cache</span>: &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;filesystem&#x27;</span>,</span><br><span class="line">    <span class="attr">buildDependencies</span>: &#123;</span><br><span class="line">      <span class="attr">config</span>: [__filename]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;production-cache&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&#x27;babel-loader&#x27;</span>,</span><br><span class="line">            <span class="attr">options</span>: &#123;</span><br><span class="line">              <span class="attr">cacheDirectory</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">cacheCompression</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7-1-2-å¤šè¿›ç¨‹æ„å»º"><a href="#7-1-2-å¤šè¿›ç¨‹æ„å»º" class="headerlink" title="7.1.2 å¤šè¿›ç¨‹æ„å»º"></a>7.1.2 å¤šè¿›ç¨‹æ„å»º</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> thread = <span class="built_in">require</span>(<span class="string">&#x27;thread-loader&#x27;</span>);</span><br><span class="line"></span><br><span class="line">thread.<span class="title function_">warmup</span>(&#123;</span><br><span class="line">  <span class="attr">workers</span>: <span class="number">4</span>,</span><br><span class="line">  <span class="attr">workerParallelJobs</span>: <span class="number">50</span>,</span><br><span class="line">&#125;, [</span><br><span class="line">  <span class="string">&#x27;babel-loader&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;css-loader&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;vue-loader&#x27;</span></span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&#x27;thread-loader&#x27;</span>,</span><br><span class="line">            <span class="attr">options</span>: &#123;</span><br><span class="line">              <span class="attr">workers</span>: <span class="number">4</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&#x27;babel-loader&#x27;</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-2-è¿è¡Œæ—¶æ€§èƒ½ä¼˜åŒ–"><a href="#7-2-è¿è¡Œæ—¶æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="7.2 è¿è¡Œæ—¶æ€§èƒ½ä¼˜åŒ–"></a>7.2 è¿è¡Œæ—¶æ€§èƒ½ä¼˜åŒ–</h3><h4 id="7-2-1-ä»£ç åˆ†å‰²"><a href="#7-2-1-ä»£ç åˆ†å‰²" class="headerlink" title="7.2.1 ä»£ç åˆ†å‰²"></a>7.2.1 ä»£ç åˆ†å‰²</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">optimization</span>: &#123;</span><br><span class="line">    <span class="attr">moduleIds</span>: <span class="string">&#x27;deterministic&#x27;</span>,</span><br><span class="line">    <span class="attr">runtimeChunk</span>: <span class="string">&#x27;single&#x27;</span>,</span><br><span class="line">    <span class="attr">splitChunks</span>: &#123;</span><br><span class="line">      <span class="attr">cacheGroups</span>: &#123;</span><br><span class="line">        <span class="attr">vendor</span>: &#123;</span><br><span class="line">          <span class="attr">test</span>: <span class="regexp">/[\\/]node_modules[\\/]/</span>,</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&#x27;vendors&#x27;</span>,</span><br><span class="line">          <span class="attr">chunks</span>: <span class="string">&#x27;all&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7-2-2-æ‡’åŠ è½½"><a href="#7-2-2-æ‡’åŠ è½½" class="headerlink" title="7.2.2 æ‡’åŠ è½½"></a>7.2.2 æ‡’åŠ è½½</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·¯ç”±æ‡’åŠ è½½</span></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/dashboard&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(</span><br><span class="line">      <span class="comment">/* webpackChunkName: &quot;dashboard&quot; */</span></span><br><span class="line">      <span class="comment">/* webpackPrefetch: true */</span></span><br><span class="line">      <span class="string">&#x27;./views/Dashboard.vue&#x27;</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»„ä»¶æ‡’åŠ è½½</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">MyComponent</span> = (<span class="params"></span>) =&gt; <span class="keyword">import</span>(<span class="string">&#x27;./components/MyComponent.vue&#x27;</span>);</span><br></pre></td></tr></table></figure><h2 id="8-å®æˆ˜åº”ç”¨"><a href="#8-å®æˆ˜åº”ç”¨" class="headerlink" title="8. å®æˆ˜åº”ç”¨"></a>8. å®æˆ˜åº”ç”¨</h2><h3 id="8-1-Vueé¡¹ç›®é…ç½®"><a href="#8-1-Vueé¡¹ç›®é…ç½®" class="headerlink" title="8.1 Vueé¡¹ç›®é…ç½®"></a>8.1 Vueé¡¹ç›®é…ç½®</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">VueLoaderPlugin</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;vue-loader&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.vue$/</span>,</span><br><span class="line">        <span class="attr">loader</span>: <span class="string">&#x27;vue-loader&#x27;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="attr">loader</span>: <span class="string">&#x27;babel-loader&#x27;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [<span class="string">&#x27;vue-style-loader&#x27;</span>, <span class="string">&#x27;css-loader&#x27;</span>]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">VueLoaderPlugin</span>(),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">DefinePlugin</span>(&#123;</span><br><span class="line">      <span class="attr">__VUE_OPTIONS_API__</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">__VUE_PROD_DEVTOOLS__</span>: <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-2-Reacté¡¹ç›®é…ç½®"><a href="#8-2-Reacté¡¹ç›®é…ç½®" class="headerlink" title="8.2 Reacté¡¹ç›®é…ç½®"></a>8.2 Reacté¡¹ç›®é…ç½®</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.(js|jsx)$/</span>,</span><br><span class="line">        <span class="attr">exclude</span>: <span class="regexp">/node_modules/</span>,</span><br><span class="line">        <span class="attr">use</span>: &#123;</span><br><span class="line">          <span class="attr">loader</span>: <span class="string">&#x27;babel-loader&#x27;</span>,</span><br><span class="line">          <span class="attr">options</span>: &#123;</span><br><span class="line">            <span class="attr">presets</span>: [</span><br><span class="line">              <span class="string">&#x27;@babel/preset-env&#x27;</span>,</span><br><span class="line">              <span class="string">&#x27;@babel/preset-react&#x27;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">plugins</span>: [</span><br><span class="line">              <span class="string">&#x27;@babel/plugin-transform-runtime&#x27;</span></span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="9-é«˜çº§ç‰¹æ€§"><a href="#9-é«˜çº§ç‰¹æ€§" class="headerlink" title="9. é«˜çº§ç‰¹æ€§"></a>9. é«˜çº§ç‰¹æ€§</h2><h3 id="9-1-æ¨¡å—è”é‚¦"><a href="#9-1-æ¨¡å—è”é‚¦" class="headerlink" title="9.1 æ¨¡å—è”é‚¦"></a>9.1 æ¨¡å—è”é‚¦</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">ModuleFederationPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;webpack&#x27;</span>).<span class="property">container</span>.<span class="property">ModuleFederationPlugin</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ModuleFederationPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;host&#x27;</span>,</span><br><span class="line">      <span class="attr">filename</span>: <span class="string">&#x27;remoteEntry.js&#x27;</span>,</span><br><span class="line">      <span class="attr">remotes</span>: &#123;</span><br><span class="line">        <span class="attr">app1</span>: <span class="string">&#x27;app1@http://localhost:3001/remoteEntry.js&#x27;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">shared</span>: &#123;</span><br><span class="line">        <span class="attr">react</span>: &#123; <span class="attr">singleton</span>: <span class="literal">true</span> &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="9-2-Tree-Shaking-å¢å¼º"><a href="#9-2-Tree-Shaking-å¢å¼º" class="headerlink" title="9.2 Tree Shaking å¢å¼º"></a>9.2 Tree Shaking å¢å¼º</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">optimization</span>: &#123;</span><br><span class="line">    <span class="attr">usedExports</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">sideEffects</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">innerGraph</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">concatenateModules</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="10-æœ€ä½³å®è·µ"><a href="#10-æœ€ä½³å®è·µ" class="headerlink" title="10. æœ€ä½³å®è·µ"></a>10. æœ€ä½³å®è·µ</h2><h3 id="10-1-é¡¹ç›®ç»“æ„"><a href="#10-1-é¡¹ç›®ç»“æ„" class="headerlink" title="10.1 é¡¹ç›®ç»“æ„"></a>10.1 é¡¹ç›®ç»“æ„</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">project/</span><br><span class="line">â”œâ”€â”€ build/                # webpacké…ç½®</span><br><span class="line">â”œâ”€â”€ public/              # é™æ€èµ„æº</span><br><span class="line">â”œâ”€â”€ src/                 # æºä»£ç </span><br><span class="line">â”‚   â”œâ”€â”€ assets/         # èµ„æºæ–‡ä»¶</span><br><span class="line">â”‚   â”œâ”€â”€ components/     # ç»„ä»¶</span><br><span class="line">â”‚   â”œâ”€â”€ views/          # é¡µé¢</span><br><span class="line">â”‚   â”œâ”€â”€ router/         # è·¯ç”±</span><br><span class="line">â”‚   â”œâ”€â”€ store/          # çŠ¶æ€ç®¡ç†</span><br><span class="line">â”‚   â”œâ”€â”€ utils/          # å·¥å…·å‡½æ•°</span><br><span class="line">â”‚   â”œâ”€â”€ App.vue         # æ ¹ç»„ä»¶</span><br><span class="line">â”‚   â””â”€â”€ main.js         # å…¥å£æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ tests/              # æµ‹è¯•æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ .env.*              # ç¯å¢ƒå˜é‡</span><br><span class="line">â”œâ”€â”€ package.json        # é¡¹ç›®é…ç½®</span><br><span class="line">â””â”€â”€ README.md           # é¡¹ç›®è¯´æ˜</span><br></pre></td></tr></table></figure><h3 id="10-2-æ€§èƒ½æ£€æŸ¥æ¸…å•"><a href="#10-2-æ€§èƒ½æ£€æŸ¥æ¸…å•" class="headerlink" title="10.2 æ€§èƒ½æ£€æŸ¥æ¸…å•"></a>10.2 æ€§èƒ½æ£€æŸ¥æ¸…å•</h3><ul><li><input disabled="" type="checkbox"> ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ Webpack</li><li><input disabled="" type="checkbox"> é…ç½®åˆé€‚çš„ sourceMap</li><li><input disabled="" type="checkbox"> å¯ç”¨å‹ç¼©å’Œä»£ç åˆ†å‰²</li><li><input disabled="" type="checkbox"> åˆ©ç”¨ç¼“å­˜æœºåˆ¶</li><li><input disabled="" type="checkbox"> ä¼˜åŒ–å›¾ç‰‡èµ„æº</li><li><input disabled="" type="checkbox"> é…ç½® CDN</li><li><input disabled="" type="checkbox"> ä½¿ç”¨ Tree Shaking</li><li><input disabled="" type="checkbox"> é…ç½®åˆç†çš„ splitChunks</li><li><input disabled="" type="checkbox"> ä½¿ç”¨åŠ¨æ€å¯¼å…¥</li><li><input disabled="" type="checkbox"> ä¼˜åŒ–ç¬¬ä¸‰æ–¹åº“çš„ä½¿ç”¨</li></ul><h2 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><p>âš ï¸ å®šæœŸæ›´æ–°ä¾èµ–åŒ…<br>âš ï¸ å…³æ³¨æ„å»ºæ€§èƒ½æŒ‡æ ‡<br>âš ï¸ é¿å…è¿‡åº¦ä¼˜åŒ–<br>âš ï¸ ä¿æŒé…ç½®çš„å¯ç»´æŠ¤æ€§<br>âš ï¸ åšå¥½é”™è¯¯å¤„ç†å’Œé™çº§ç­–ç•¥</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Webpack-å®Œå…¨æŒ‡å—ï¼šä»å…¥é—¨åˆ°ç²¾é€š&quot;&gt;&lt;a href=&quot;#Webpack-å®Œå…¨æŒ‡å—ï¼šä»å…¥é—¨åˆ°ç²¾é€š&quot; class=&quot;headerlink&quot; title=&quot;Webpack å®Œå…¨æŒ‡å—ï¼šä»å…¥é—¨åˆ°ç²¾é€š&quot;&gt;&lt;/a&gt;Webpack å®Œå…¨æŒ‡å—ï¼šä»å…¥é—¨åˆ°ç²¾é€š&lt;/h1&gt;&lt;h2 i</summary>
      
    
    
    
    
    <category term="å…¥é—¨" scheme="https://aoayaoa.github.io/tags/%E5%85%A5%E9%97%A8/"/>
    
    <category term="webpack" scheme="https://aoayaoa.github.io/tags/webpack/"/>
    
  </entry>
  
</feed>
