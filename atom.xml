<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>aoaYaoa</title>
  
  <subtitle>灰色随想：记录生活，探索技术的个人空间</subtitle>
  <link href="https://aoayaoa.github.io/atom.xml" rel="self"/>
  
  <link href="https://aoayaoa.github.io/"/>
  <updated>2025-08-08T03:24:51.301Z</updated>
  <id>https://aoayaoa.github.io/</id>
  
  <author>
    <name>aoaYaoa</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>BabylonJS</title>
    <link href="https://aoayaoa.github.io/2025/07/31/babylonjs/"/>
    <id>https://aoayaoa.github.io/2025/07/31/babylonjs/</id>
    <published>2025-07-30T16:00:00.000Z</published>
    <updated>2025-08-08T03:24:51.301Z</updated>
    
    <content type="html"><![CDATA[<h1 id="BabylonJS-完整离线开发指南"><a href="#BabylonJS-完整离线开发指南" class="headerlink" title="BabylonJS 完整离线开发指南"></a>BabylonJS 完整离线开发指南</h1><h2 id="📋-目录"><a href="#📋-目录" class="headerlink" title="📋 目录"></a>📋 目录</h2><ul><li><a href="#babylonjs-%E5%AE%8C%E6%95%B4%E7%A6%BB%E7%BA%BF%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97">BabylonJS 完整离线开发指南</a><ul><li><a href="#-%E7%9B%AE%E5%BD%95">📋 目录</a></li><li><a href="#-babylonjs-%E7%AE%80%E4%BB%8B">🚀 BabylonJS 简介</a></li><li><a href="#-%E7%A6%BB%E7%BA%BF%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE">💻 离线环境配置</a></li><li><a href="#-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5">🎯 核心概念</a></li><li><a href="#-engine-%E5%BC%95%E6%93%8E%E8%AF%A6%E8%A7%A3">🎬 Engine 引擎详解</a></li><li><a href="#-scene-%E5%9C%BA%E6%99%AF%E8%AF%A6%E8%A7%A3">🎭 Scene 场景详解</a></li><li><a href="#-camera-%E7%9B%B8%E6%9C%BA%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">📷 Camera 相机系统详解</a></li><li><a href="#-light-%E5%85%89%E7%85%A7%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">💡 Light 光照系统详解</a></li><li><a href="#-material-%E6%9D%90%E8%B4%A8%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">🎨 Material 材质系统详解</a></li><li><a href="#-mesh-%E7%BD%91%E6%A0%BC%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">🎭 Mesh 网格系统详解</a></li><li><a href="#-animation-%E5%8A%A8%E7%94%BB%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">🎬 Animation 动画系统详解</a></li><li><a href="#-particlesystem-%E7%B2%92%E5%AD%90%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">🎆 ParticleSystem 粒子系统详解</a></li><li><a href="#-audio-%E9%9F%B3%E9%A2%91%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">🔊 Audio 音频系统详解</a></li><li><a href="#-input-%E8%BE%93%E5%85%A5%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">🎮 Input 输入系统详解</a></li><li><a href="#-asset-%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E8%AF%A6%E8%A7%A3">🔧 Asset 资源管理详解</a></li><li><a href="#-performance-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E8%AF%A6%E8%A7%A3">⚡ Performance 性能优化详解</a></li><li><a href="#-%E4%B8%8E-cesium-%E5%90%8C%E5%B1%8F%E5%8F%A0%E5%8A%A0%E5%8D%95%E5%9B%BE%E5%B1%82%E5%AE%9E%E7%8E%B0">🤝 与 Cesium 同屏叠加（单图层）实现</a></li></ul></li><li><a href="#-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">🎯 最佳实践</a></li></ul><h2 id="🚀-BabylonJS-简介"><a href="#🚀-BabylonJS-简介" class="headerlink" title="🚀 BabylonJS 简介"></a>🚀 BabylonJS 简介</h2><p>BabylonJS 是一个强大的 3D JavaScript 引擎，用于在浏览器中创建令人惊叹的 3D 体验。它支持 WebGL、WebGPU 和 WebXR，为开发者提供了完整的 3D 开发工具链。</p><h3 id="核心特性"><a href="#核心特性" class="headerlink" title="核心特性"></a>核心特性</h3><ul><li><strong>跨平台支持</strong> - Web、移动端、桌面应用</li><li><strong>现代渲染</strong> - WebGL 2.0、WebGPU 支持</li><li><strong>完整工具链</strong> - 编辑器、调试器、优化工具</li><li><strong>丰富生态</strong> - 插件系统、社区资源</li><li><strong>高性能</strong> - 优化的渲染管线和内存管理</li></ul><h2 id="💻-离线环境配置"><a href="#💻-离线环境配置" class="headerlink" title="💻 离线环境配置"></a>💻 离线环境配置</h2><h3 id="Vite-配置"><a href="#Vite-配置" class="headerlink" title="Vite 配置"></a>Vite 配置</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.js - BabylonJS离线开发配置</span></span><br><span class="line"><span class="keyword">import</span> &#123; defineConfig &#125; <span class="keyword">from</span> <span class="string">&#x27;vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; resolve &#125; <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">define</span>: &#123;</span><br><span class="line">    <span class="attr">BABYLON_BASE_URL</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="string">&#x27;/babylon/&#x27;</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">publicDir</span>: <span class="string">&#x27;public&#x27;</span>,</span><br><span class="line">  <span class="attr">build</span>: &#123;</span><br><span class="line">    <span class="attr">rollupOptions</span>: &#123;</span><br><span class="line">      <span class="attr">external</span>: [],</span><br><span class="line">      <span class="attr">input</span>: &#123;</span><br><span class="line">        <span class="attr">main</span>: <span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;index.html&#x27;</span>),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">server</span>: &#123;</span><br><span class="line">    <span class="attr">fs</span>: &#123;</span><br><span class="line">      <span class="attr">allow</span>: [<span class="string">&#x27;..&#x27;</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;Cross-Origin-Embedder-Policy&#x27;</span>: <span class="string">&#x27;require-corp&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;Cross-Origin-Opener-Policy&#x27;</span>: <span class="string">&#x27;same-origin&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">optimizeDeps</span>: &#123;</span><br><span class="line">    <span class="attr">include</span>: [</span><br><span class="line">      <span class="string">&#x27;@babylonjs/core&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;@babylonjs/loaders&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;@babylonjs/materials&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;@babylonjs/post-processes&#x27;</span>,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">worker</span>: &#123;</span><br><span class="line">    <span class="attr">format</span>: <span class="string">&#x27;es&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">project/</span><br><span class="line">├── public/</span><br><span class="line">│   ├── models/          # 3D模型文件</span><br><span class="line">│   ├── textures/        # 纹理贴图</span><br><span class="line">│   ├── sounds/          # 音频文件</span><br><span class="line">│   └── environments/    # 环境贴图</span><br><span class="line">├── src/</span><br><span class="line">│   ├── babylon/</span><br><span class="line">│   │   ├── engine.js    # 引擎配置</span><br><span class="line">│   │   ├── scene.js     # 场景管理</span><br><span class="line">│   │   ├── cameras.js   # 相机控制</span><br><span class="line">│   │   ├── lights.js    # 光照设置</span><br><span class="line">│   │   ├── materials.js # 材质管理</span><br><span class="line">│   │   ├── meshes.js    # 网格操作</span><br><span class="line">│   │   └── animations.js # 动画控制</span><br><span class="line">│   └── main.js</span><br><span class="line">└── package.json</span><br></pre></td></tr></table></figure><h3 id="依赖安装"><a href="#依赖安装" class="headerlink" title="依赖安装"></a>依赖安装</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;dependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@babylonjs/core&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^6.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@babylonjs/loaders&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^6.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@babylonjs/materials&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^6.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@babylonjs/post-processes&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^6.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@babylonjs/procedural-textures&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^6.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@babylonjs/serializers&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^6.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@babylonjs/node-geometry-editor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^6.0.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;devDependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;vite&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^4.0.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="基础初始化"><a href="#基础初始化" class="headerlink" title="基础初始化"></a>基础初始化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js - BabylonJS基础初始化</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Engine</span>, <span class="title class_">Scene</span>, <span class="title class_">FreeCamera</span>, <span class="title class_">HemisphericLight</span>, <span class="title class_">Vector3</span>, <span class="title class_">MeshBuilder</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@babylonjs/core&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;@babylonjs/loaders/glTF&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 离线环境配置</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">BABYLON_BASE_URL</span> = <span class="string">&#x27;/babylon/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BabylonApp</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">canvasId</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(canvasId)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span> = <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">init</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 创建引擎</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span> = <span class="keyword">new</span> <span class="title class_">Engine</span>(<span class="variable language_">this</span>.<span class="property">canvas</span>, <span class="literal">true</span>, &#123;</span><br><span class="line">      <span class="attr">preserveDrawingBuffer</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">stencil</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">disableWebGL2Support</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建场景</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = <span class="keyword">new</span> <span class="title class_">Scene</span>(<span class="variable language_">this</span>.<span class="property">engine</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置基础场景</span></span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">createScene</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动渲染循环</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">startRenderLoop</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理窗口大小变化</span></span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;resize&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">resize</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">createScene</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 创建相机</span></span><br><span class="line">    <span class="keyword">const</span> camera = <span class="keyword">new</span> <span class="title class_">FreeCamera</span>(<span class="string">&#x27;camera&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">5</span>, -<span class="number">10</span>), <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    camera.<span class="title function_">setTarget</span>(<span class="title class_">Vector3</span>.<span class="title class_">Zero</span>())</span><br><span class="line">    camera.<span class="title function_">attachControls</span>(<span class="variable language_">this</span>.<span class="property">canvas</span>, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建光源</span></span><br><span class="line">    <span class="keyword">const</span> light = <span class="keyword">new</span> <span class="title class_">HemisphericLight</span>(<span class="string">&#x27;light&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>), <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    light.<span class="property">intensity</span> = <span class="number">0.7</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建基础几何体</span></span><br><span class="line">    <span class="keyword">const</span> sphere = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateSphere</span>(<span class="string">&#x27;sphere&#x27;</span>, &#123; <span class="attr">diameter</span>: <span class="number">2</span> &#125;, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    sphere.<span class="property">position</span>.<span class="property">y</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> ground = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateGround</span>(<span class="string">&#x27;ground&#x27;</span>, &#123; <span class="attr">width</span>: <span class="number">6</span>, <span class="attr">height</span>: <span class="number">6</span> &#125;, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">startRenderLoop</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">runRenderLoop</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">render</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>?.<span class="title function_">dispose</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>?.<span class="title function_">dispose</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动应用</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">BabylonApp</span>(<span class="string">&#x27;babylonCanvas&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="🎯-核心概念"><a href="#🎯-核心概念" class="headerlink" title="🎯 核心概念"></a>🎯 核心概念</h2><h3 id="坐标系统"><a href="#坐标系统" class="headerlink" title="坐标系统"></a>坐标系统</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BabylonJS坐标系统详解</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CoordinateSystem</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 右手坐标系</span></span><br><span class="line">  <span class="comment">// X轴: 向右为正</span></span><br><span class="line">  <span class="comment">// Y轴: 向上为正</span></span><br><span class="line">  <span class="comment">// Z轴: 向前为正（朝向观察者）</span></span><br><span class="line">  <span class="title function_">createCoordinateAxes</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> axisLength = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// X轴 - 红色</span></span><br><span class="line">    <span class="keyword">const</span> xAxis = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateCylinder</span>(</span><br><span class="line">      <span class="string">&#x27;xAxis&#x27;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">height</span>: axisLength,</span><br><span class="line">        <span class="attr">diameterTop</span>: <span class="number">0.1</span>,</span><br><span class="line">        <span class="attr">diameterBottom</span>: <span class="number">0.1</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">    )</span><br><span class="line">    xAxis.<span class="property">rotation</span>.<span class="property">z</span> = -<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">2</span></span><br><span class="line">    xAxis.<span class="property">position</span>.<span class="property">x</span> = axisLength / <span class="number">2</span></span><br><span class="line">    xAxis.<span class="property">material</span> = <span class="variable language_">this</span>.<span class="title function_">createAxisMaterial</span>(<span class="string">&#x27;red&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Y轴 - 绿色</span></span><br><span class="line">    <span class="keyword">const</span> yAxis = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateCylinder</span>(</span><br><span class="line">      <span class="string">&#x27;yAxis&#x27;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">height</span>: axisLength,</span><br><span class="line">        <span class="attr">diameterTop</span>: <span class="number">0.1</span>,</span><br><span class="line">        <span class="attr">diameterBottom</span>: <span class="number">0.1</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">    )</span><br><span class="line">    yAxis.<span class="property">position</span>.<span class="property">y</span> = axisLength / <span class="number">2</span></span><br><span class="line">    yAxis.<span class="property">material</span> = <span class="variable language_">this</span>.<span class="title function_">createAxisMaterial</span>(<span class="string">&#x27;green&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Z轴 - 蓝色</span></span><br><span class="line">    <span class="keyword">const</span> zAxis = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateCylinder</span>(</span><br><span class="line">      <span class="string">&#x27;zAxis&#x27;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">height</span>: axisLength,</span><br><span class="line">        <span class="attr">diameterTop</span>: <span class="number">0.1</span>,</span><br><span class="line">        <span class="attr">diameterBottom</span>: <span class="number">0.1</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">    )</span><br><span class="line">    zAxis.<span class="property">rotation</span>.<span class="property">x</span> = <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">2</span></span><br><span class="line">    zAxis.<span class="property">position</span>.<span class="property">z</span> = axisLength / <span class="number">2</span></span><br><span class="line">    zAxis.<span class="property">material</span> = <span class="variable language_">this</span>.<span class="title function_">createAxisMaterial</span>(<span class="string">&#x27;blue&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; xAxis, yAxis, zAxis &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createAxisMaterial</span>(<span class="params">color</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">StandardMaterial</span>(<span class="string">`<span class="subst">$&#123;color&#125;</span>Material`</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    material.<span class="property">diffuseColor</span> = <span class="title class_">Color3</span>.<span class="title class_">FromHexString</span>(</span><br><span class="line">      color === <span class="string">&#x27;red&#x27;</span> ? <span class="string">&#x27;#ff0000&#x27;</span> : color === <span class="string">&#x27;green&#x27;</span> ? <span class="string">&#x27;#00ff00&#x27;</span> : <span class="string">&#x27;#0000ff&#x27;</span>,</span><br><span class="line">    )</span><br><span class="line">    material.<span class="property">emissiveColor</span> = material.<span class="property">diffuseColor</span>.<span class="title function_">clone</span>()</span><br><span class="line">    <span class="keyword">return</span> material</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 位置变换</span></span><br><span class="line">  <span class="title function_">transformPosition</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 本地坐标到世界坐标</span></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateBox</span>(<span class="string">&#x27;box&#x27;</span>, &#123; <span class="attr">size</span>: <span class="number">1</span> &#125;, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="keyword">const</span> localPosition = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">const</span> worldPosition = <span class="title class_">Vector3</span>.<span class="title class_">TransformCoordinates</span>(localPosition, mesh.<span class="title function_">getWorldMatrix</span>())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 世界坐标到本地坐标</span></span><br><span class="line">    <span class="keyword">const</span> worldToLocal = <span class="title class_">Vector3</span>.<span class="title class_">TransformCoordinates</span>(</span><br><span class="line">      worldPosition,</span><br><span class="line">      <span class="title class_">Matrix</span>.<span class="title class_">Invert</span>(mesh.<span class="title function_">getWorldMatrix</span>()),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Local:&#x27;</span>, localPosition)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;World:&#x27;</span>, worldPosition)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Back to Local:&#x27;</span>, worldToLocal)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; localPosition, worldPosition, worldToLocal &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 旋转变换</span></span><br><span class="line">  <span class="title function_">transformRotation</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateBox</span>(<span class="string">&#x27;rotatedBox&#x27;</span>, &#123; <span class="attr">size</span>: <span class="number">1</span> &#125;, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 欧拉角设置</span></span><br><span class="line">    mesh.<span class="property">rotation</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>, <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">6</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 四元数设置</span></span><br><span class="line">    mesh.<span class="property">rotationQuaternion</span> = <span class="title class_">Quaternion</span>.<span class="title class_">FromEulerAngles</span>(<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>, <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">6</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从一个方向旋转到另一个方向</span></span><br><span class="line">    <span class="keyword">const</span> fromDirection = <span class="title class_">Vector3</span>.<span class="title class_">Forward</span>()</span><br><span class="line">    <span class="keyword">const</span> toDirection = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>).<span class="title function_">normalize</span>()</span><br><span class="line">    <span class="keyword">const</span> rotation = <span class="title class_">Quaternion</span>.<span class="title class_">FromLookRotation</span>(toDirection, <span class="title class_">Vector3</span>.<span class="title class_">Up</span>())</span><br><span class="line">    mesh.<span class="property">rotationQuaternion</span> = rotation</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 缩放变换</span></span><br><span class="line">  <span class="title function_">transformScale</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateBox</span>(<span class="string">&#x27;scaledBox&#x27;</span>, &#123; <span class="attr">size</span>: <span class="number">1</span> &#125;, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 统一缩放</span></span><br><span class="line">    mesh.<span class="property">scaling</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 非统一缩放</span></span><br><span class="line">    mesh.<span class="property">scaling</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">2</span>, <span class="number">1</span>, <span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="数学工具"><a href="#数学工具" class="headerlink" title="数学工具"></a>数学工具</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BabylonJS数学工具集</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MathUtils</span> &#123;</span><br><span class="line">  <span class="comment">// Vector3 详解</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">vector3Examples</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 创建向量</span></span><br><span class="line">    <span class="keyword">const</span> v1 = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">const</span> v2 = <span class="title class_">Vector3</span>.<span class="title class_">Zero</span>() <span class="comment">// (0, 0, 0)</span></span><br><span class="line">    <span class="keyword">const</span> v3 = <span class="title class_">Vector3</span>.<span class="title class_">One</span>() <span class="comment">// (1, 1, 1)</span></span><br><span class="line">    <span class="keyword">const</span> v4 = <span class="title class_">Vector3</span>.<span class="title class_">Up</span>() <span class="comment">// (0, 1, 0)</span></span><br><span class="line">    <span class="keyword">const</span> v5 = <span class="title class_">Vector3</span>.<span class="title class_">Forward</span>() <span class="comment">// (0, 0, 1)</span></span><br><span class="line">    <span class="keyword">const</span> v6 = <span class="title class_">Vector3</span>.<span class="title class_">Right</span>() <span class="comment">// (1, 0, 0)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向量运算</span></span><br><span class="line">    <span class="keyword">const</span> sum = v1.<span class="title function_">add</span>(v2) <span class="comment">// 向量加法</span></span><br><span class="line">    <span class="keyword">const</span> diff = v1.<span class="title function_">subtract</span>(v2) <span class="comment">// 向量减法</span></span><br><span class="line">    <span class="keyword">const</span> scaled = v1.<span class="title function_">scale</span>(<span class="number">2</span>) <span class="comment">// 标量乘法</span></span><br><span class="line">    <span class="keyword">const</span> dot = <span class="title class_">Vector3</span>.<span class="title class_">Dot</span>(v1, v2) <span class="comment">// 点积</span></span><br><span class="line">    <span class="keyword">const</span> cross = <span class="title class_">Vector3</span>.<span class="title class_">Cross</span>(v1, v2) <span class="comment">// 叉积</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向量属性</span></span><br><span class="line">    <span class="keyword">const</span> length = v1.<span class="title function_">length</span>() <span class="comment">// 向量长度</span></span><br><span class="line">    <span class="keyword">const</span> lengthSq = v1.<span class="title function_">lengthSquared</span>() <span class="comment">// 长度平方</span></span><br><span class="line">    <span class="keyword">const</span> normalized = v1.<span class="title function_">normalize</span>() <span class="comment">// 单位向量</span></span><br><span class="line">    <span class="keyword">const</span> distance = <span class="title class_">Vector3</span>.<span class="title class_">Distance</span>(v1, v2) <span class="comment">// 两点距离</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向量插值</span></span><br><span class="line">    <span class="keyword">const</span> lerp = <span class="title class_">Vector3</span>.<span class="title class_">Lerp</span>(v1, v2, <span class="number">0.5</span>) <span class="comment">// 线性插值</span></span><br><span class="line">    <span class="keyword">const</span> slerp = <span class="title class_">Vector3</span>.<span class="title class_">Slerp</span>(v1, v2, <span class="number">0.5</span>) <span class="comment">// 球面插值</span></span><br><span class="line">    <span class="keyword">const</span> hermite = <span class="title class_">Vector3</span>.<span class="title class_">Hermite</span>(v1, v2, v3, v4, <span class="number">0.5</span>) <span class="comment">// Hermite插值</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; v1, v2, sum, diff, scaled, dot, cross, length, normalized, lerp &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Matrix 详解</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">matrixExamples</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 创建矩阵</span></span><br><span class="line">    <span class="keyword">const</span> identity = <span class="title class_">Matrix</span>.<span class="title class_">Identity</span>() <span class="comment">// 单位矩阵</span></span><br><span class="line">    <span class="keyword">const</span> translation = <span class="title class_">Matrix</span>.<span class="title class_">Translation</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>) <span class="comment">// 平移矩阵</span></span><br><span class="line">    <span class="keyword">const</span> rotationX = <span class="title class_">Matrix</span>.<span class="title class_">RotationX</span>(<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>) <span class="comment">// X轴旋转</span></span><br><span class="line">    <span class="keyword">const</span> rotationY = <span class="title class_">Matrix</span>.<span class="title class_">RotationY</span>(<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>) <span class="comment">// Y轴旋转</span></span><br><span class="line">    <span class="keyword">const</span> rotationZ = <span class="title class_">Matrix</span>.<span class="title class_">RotationZ</span>(<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>) <span class="comment">// Z轴旋转</span></span><br><span class="line">    <span class="keyword">const</span> scaling = <span class="title class_">Matrix</span>.<span class="title class_">Scaling</span>(<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>) <span class="comment">// 缩放矩阵</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复合变换</span></span><br><span class="line">    <span class="keyword">const</span> trs = <span class="title class_">Matrix</span>.<span class="title class_">Compose</span>(</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>), <span class="comment">// 缩放</span></span><br><span class="line">      <span class="title class_">Quaternion</span>.<span class="title class_">FromEulerAngles</span>(<span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>, <span class="number">0</span>), <span class="comment">// 旋转</span></span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>), <span class="comment">// 平移</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 矩阵运算</span></span><br><span class="line">    <span class="keyword">const</span> multiplied = translation.<span class="title function_">multiply</span>(rotationY)</span><br><span class="line">    <span class="keyword">const</span> inverted = <span class="title class_">Matrix</span>.<span class="title class_">Invert</span>(trs)</span><br><span class="line">    <span class="keyword">const</span> transposed = <span class="title class_">Matrix</span>.<span class="title class_">Transpose</span>(trs)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从矩阵提取信息</span></span><br><span class="line">    <span class="keyword">const</span> decomposed = trs.<span class="title function_">decompose</span>()</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="attr">scaling</span>: s, <span class="attr">rotation</span>: r, <span class="attr">translation</span>: t &#125; = decomposed</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; identity, translation, trs, multiplied, inverted, decomposed &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Quaternion 详解</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">quaternionExamples</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 创建四元数</span></span><br><span class="line">    <span class="keyword">const</span> identity = <span class="title class_">Quaternion</span>.<span class="title class_">Identity</span>() <span class="comment">// 单位四元数</span></span><br><span class="line">    <span class="keyword">const</span> fromEuler = <span class="title class_">Quaternion</span>.<span class="title class_">FromEulerAngles</span>(<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>, <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">6</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">const</span> fromAxis = <span class="title class_">Quaternion</span>.<span class="title class_">RotationAxis</span>(<span class="title class_">Vector3</span>.<span class="title class_">Up</span>(), <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>)</span><br><span class="line">    <span class="keyword">const</span> fromYawPitchRoll = <span class="title class_">Quaternion</span>.<span class="title class_">RotationYawPitchRoll</span>(<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>, <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">6</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 四元数运算</span></span><br><span class="line">    <span class="keyword">const</span> multiplied = fromEuler.<span class="title function_">multiply</span>(fromAxis)</span><br><span class="line">    <span class="keyword">const</span> conjugate = <span class="title class_">Quaternion</span>.<span class="title class_">Conjugate</span>(fromEuler)</span><br><span class="line">    <span class="keyword">const</span> inverse = <span class="title class_">Quaternion</span>.<span class="title class_">Inverse</span>(fromEuler)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 四元数插值</span></span><br><span class="line">    <span class="keyword">const</span> slerp = <span class="title class_">Quaternion</span>.<span class="title class_">Slerp</span>(fromEuler, fromAxis, <span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转换</span></span><br><span class="line">    <span class="keyword">const</span> toEuler = fromEuler.<span class="title function_">toEulerAngles</span>()</span><br><span class="line">    <span class="keyword">const</span> toMatrix = fromEuler.<span class="title function_">toRotationMatrix</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 方向计算</span></span><br><span class="line">    <span class="keyword">const</span> forward = <span class="title class_">Vector3</span>.<span class="title class_">Forward</span>()</span><br><span class="line">    <span class="keyword">const</span> rotatedForward = forward.<span class="title function_">applyRotationQuaternion</span>(fromEuler)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; identity, fromEuler, multiplied, slerp, toEuler, rotatedForward &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Color 详解</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">colorExamples</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 创建颜色</span></span><br><span class="line">    <span class="keyword">const</span> red = <span class="title class_">Color3</span>.<span class="title class_">Red</span>() <span class="comment">// (1, 0, 0)</span></span><br><span class="line">    <span class="keyword">const</span> green = <span class="title class_">Color3</span>.<span class="title class_">Green</span>() <span class="comment">// (0, 1, 0)</span></span><br><span class="line">    <span class="keyword">const</span> blue = <span class="title class_">Color3</span>.<span class="title class_">Blue</span>() <span class="comment">// (0, 0, 1)</span></span><br><span class="line">    <span class="keyword">const</span> white = <span class="title class_">Color3</span>.<span class="title class_">White</span>() <span class="comment">// (1, 1, 1)</span></span><br><span class="line">    <span class="keyword">const</span> black = <span class="title class_">Color3</span>.<span class="title class_">Black</span>() <span class="comment">// (0, 0, 0)</span></span><br><span class="line">    <span class="keyword">const</span> custom = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.5</span>, <span class="number">0.7</span>, <span class="number">0.9</span>) <span class="comment">// 自定义RGB</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从十六进制创建</span></span><br><span class="line">    <span class="keyword">const</span> fromHex = <span class="title class_">Color3</span>.<span class="title class_">FromHexString</span>(<span class="string">&#x27;#ff6600&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从HSV创建</span></span><br><span class="line">    <span class="keyword">const</span> fromHSV = <span class="title class_">Color3</span>.<span class="title class_">FromHSV</span>(<span class="number">120</span>, <span class="number">0.8</span>, <span class="number">0.9</span>) <span class="comment">// 色相、饱和度、明度</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 颜色运算</span></span><br><span class="line">    <span class="keyword">const</span> added = red.<span class="title function_">add</span>(green) <span class="comment">// 颜色加法</span></span><br><span class="line">    <span class="keyword">const</span> scaled = red.<span class="title function_">scale</span>(<span class="number">0.5</span>) <span class="comment">// 颜色缩放</span></span><br><span class="line">    <span class="keyword">const</span> lerp = <span class="title class_">Color3</span>.<span class="title class_">Lerp</span>(red, blue, <span class="number">0.5</span>) <span class="comment">// 颜色插值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Color4 (带透明度)</span></span><br><span class="line">    <span class="keyword">const</span> transparent = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.5</span>) <span class="comment">// 半透明红色</span></span><br><span class="line">    <span class="keyword">const</span> fromColor3 = <span class="keyword">new</span> <span class="title class_">Color4</span>(red.<span class="property">r</span>, red.<span class="property">g</span>, red.<span class="property">b</span>, <span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 颜色转换</span></span><br><span class="line">    <span class="keyword">const</span> toHex = red.<span class="title function_">toHexString</span>() <span class="comment">// 转为十六进制</span></span><br><span class="line">    <span class="keyword">const</span> toHSV = red.<span class="title function_">toHSV</span>() <span class="comment">// 转为HSV</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; red, fromHex, fromHSV, added, lerp, transparent, toHex &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="🎬-Engine-引擎详解"><a href="#🎬-Engine-引擎详解" class="headerlink" title="🎬 Engine 引擎详解"></a>🎬 Engine 引擎详解</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Engine 引擎系统完整配置</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EngineManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">canvas, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span> = canvas</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span> = <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engineOptions</span> = <span class="variable language_">this</span>.<span class="title function_">getDefaultOptions</span>(options)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">init</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getDefaultOptions</span>(<span class="params">userOptions</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// antialias: boolean - 抗锯齿</span></span><br><span class="line">        <span class="attr">antialias</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// preserveDrawingBuffer: boolean - 保留绘制缓冲区</span></span><br><span class="line">        <span class="attr">preserveDrawingBuffer</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// stencil: boolean - 启用模板缓冲区</span></span><br><span class="line">        <span class="attr">stencil</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// alpha: boolean - 启用透明度</span></span><br><span class="line">        <span class="attr">alpha</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// premultipliedAlpha: boolean - 预乘透明度</span></span><br><span class="line">        <span class="attr">premultipliedAlpha</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// powerPreference: string - GPU功耗偏好</span></span><br><span class="line">        <span class="attr">powerPreference</span>: <span class="string">&#x27;high-performance&#x27;</span>, <span class="comment">// &#x27;default&#x27;, &#x27;high-performance&#x27;, &#x27;low-power&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// failIfMajorPerformanceCaveat: boolean - 性能警告时失败</span></span><br><span class="line">        <span class="attr">failIfMajorPerformanceCaveat</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// doNotHandleContextLost: boolean - 不处理上下文丢失</span></span><br><span class="line">        <span class="attr">doNotHandleContextLost</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// audioEngine: boolean - 启用音频引擎</span></span><br><span class="line">        <span class="attr">audioEngine</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// disableWebGL2Support: boolean - 禁用WebGL2</span></span><br><span class="line">        <span class="attr">disableWebGL2Support</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// xrCompatible: boolean - WebXR兼容</span></span><br><span class="line">        <span class="attr">xrCompatible</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// useHighPrecisionFloats: boolean - 使用高精度浮点数</span></span><br><span class="line">        <span class="attr">useHighPrecisionFloats</span>: <span class="literal">false</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      userOptions,</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 创建引擎</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">engine</span> = <span class="keyword">new</span> <span class="title class_">Engine</span>(<span class="variable language_">this</span>.<span class="property">canvas</span>, <span class="variable language_">this</span>.<span class="property">engineOptions</span>.<span class="property">antialias</span>, <span class="variable language_">this</span>.<span class="property">engineOptions</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 设置引擎属性</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">configureEngine</span>()</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 绑定事件</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">bindEvents</span>()</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;BabylonJS Engine 初始化成功&#x27;</span>)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;WebGL版本:&#x27;</span>, <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">webGLVersion</span>)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;GPU信息:&#x27;</span>, <span class="variable language_">this</span>.<span class="title function_">getGPUInfo</span>())</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;引擎初始化失败:&#x27;</span>, error)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleInitError</span>(error)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">configureEngine</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 设置渲染精度</span></span><br><span class="line">    <span class="comment">// 作用: 控制渲染精度，影响性能和质量</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">setHardwareScalingLevel</span>(<span class="number">1.0</span>) <span class="comment">// 1.0 = 原生分辨率，0.5 = 一半分辨率</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置视口</span></span><br><span class="line">    <span class="comment">// 作用: 定义渲染区域</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">setViewport</span>(<span class="keyword">new</span> <span class="title class_">Viewport</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启用自适应设备像素比</span></span><br><span class="line">    <span class="comment">// 作用: 自动适配高DPI显示器</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">enableAdaptiveDevicePixelRatio</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置最大纹理大小</span></span><br><span class="line">    <span class="comment">// 作用: 限制纹理大小，防止内存溢出</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">getCaps</span>().<span class="property">maxTextureSize</span> = <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">getCaps</span>().<span class="property">maxTextureSize</span>, <span class="number">4096</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启用深度测试</span></span><br><span class="line">    <span class="comment">// 作用: 正确处理物体前后关系</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">setDepthFunction</span>(<span class="title class_">Engine</span>.<span class="property">LEQUAL</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置默认材质</span></span><br><span class="line">    <span class="comment">// 作用: 为没有材质的网格提供默认材质</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">createDefaultRenderingPipeline</span> = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">bindEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 上下文丢失事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">onContextLostObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;WebGL上下文丢失&#x27;</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleContextLost</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 上下文恢复事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">onContextRestoredObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;WebGL上下文已恢复&#x27;</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleContextRestored</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开始渲染事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">onBeginFrameObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onBeginFrame</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 结束渲染事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">onEndFrameObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onEndFrame</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 窗口大小变化</span></span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;resize&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleResize</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 页面可见性变化</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;visibilitychange&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleVisibilityChange</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 渲染循环管理</span></span><br><span class="line">  <span class="title function_">startRenderLoop</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">runRenderLoop</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (scene.<span class="property">activeCamera</span>) &#123;</span><br><span class="line">        scene.<span class="title function_">render</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">stopRenderLoop</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">stopRenderLoop</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 性能监控</span></span><br><span class="line">  <span class="title function_">enablePerformanceMonitoring</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// FPS监控</span></span><br><span class="line">    <span class="keyword">const</span> fpsCounter = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    fpsCounter.<span class="property">style</span>.<span class="property">position</span> = <span class="string">&#x27;absolute&#x27;</span></span><br><span class="line">    fpsCounter.<span class="property">style</span>.<span class="property">top</span> = <span class="string">&#x27;10px&#x27;</span></span><br><span class="line">    fpsCounter.<span class="property">style</span>.<span class="property">left</span> = <span class="string">&#x27;10px&#x27;</span></span><br><span class="line">    fpsCounter.<span class="property">style</span>.<span class="property">color</span> = <span class="string">&#x27;white&#x27;</span></span><br><span class="line">    fpsCounter.<span class="property">style</span>.<span class="property">fontFamily</span> = <span class="string">&#x27;monospace&#x27;</span></span><br><span class="line">    fpsCounter.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;rgba(0,0,0,0.5)&#x27;</span></span><br><span class="line">    fpsCounter.<span class="property">style</span>.<span class="property">padding</span> = <span class="string">&#x27;5px&#x27;</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(fpsCounter)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">onEndFrameObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> fps = <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">getFps</span>()</span><br><span class="line">      <span class="keyword">const</span> deltaTime = <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">getDeltaTime</span>()</span><br><span class="line">      fpsCounter.<span class="property">textContent</span> = <span class="string">`FPS: <span class="subst">$&#123;fps.toFixed(<span class="number">1</span>)&#125;</span> | Delta: <span class="subst">$&#123;deltaTime.toFixed(<span class="number">2</span>)&#125;</span>ms`</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 性能分析</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">enablePerformanceMonitoring</span> = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取引擎信息</span></span><br><span class="line">  <span class="title function_">getEngineInfo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> caps = <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">getCaps</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="comment">// 基础信息</span></span><br><span class="line">      <span class="attr">webGLVersion</span>: <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">webGLVersion</span>,</span><br><span class="line">      <span class="attr">isWebGL2</span>: <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">isWebGL2</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 硬件信息</span></span><br><span class="line">      <span class="attr">maxTextureSize</span>: caps.<span class="property">maxTextureSize</span>,</span><br><span class="line">      <span class="attr">maxCubeTextureSize</span>: caps.<span class="property">maxCubeTextureSize</span>,</span><br><span class="line">      <span class="attr">maxRenderTextureSize</span>: caps.<span class="property">maxRenderTextureSize</span>,</span><br><span class="line">      <span class="attr">maxVertexAttribs</span>: caps.<span class="property">maxVertexAttribs</span>,</span><br><span class="line">      <span class="attr">maxVaryingVectors</span>: caps.<span class="property">maxVaryingVectors</span>,</span><br><span class="line">      <span class="attr">maxFragmentUniformVectors</span>: caps.<span class="property">maxFragmentUniformVectors</span>,</span><br><span class="line">      <span class="attr">maxVertexUniformVectors</span>: caps.<span class="property">maxVertexUniformVectors</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 扩展支持</span></span><br><span class="line">      <span class="attr">standardDerivatives</span>: caps.<span class="property">standardDerivatives</span>,</span><br><span class="line">      <span class="attr">textureFloat</span>: caps.<span class="property">textureFloat</span>,</span><br><span class="line">      <span class="attr">textureHalfFloat</span>: caps.<span class="property">textureHalfFloat</span>,</span><br><span class="line">      <span class="attr">textureAnisotropicFilterExtension</span>: caps.<span class="property">textureAnisotropicFilterExtension</span>,</span><br><span class="line">      <span class="attr">instancedArrays</span>: caps.<span class="property">instancedArrays</span>,</span><br><span class="line">      <span class="attr">uintIndices</span>: caps.<span class="property">uintIndices</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 渲染信息</span></span><br><span class="line">      <span class="attr">hardwareScalingLevel</span>: <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">getHardwareScalingLevel</span>(),</span><br><span class="line">      <span class="attr">loadedTexturesCache</span>: <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">getLoadedTexturesCache</span>().<span class="property">length</span>,</span><br><span class="line">      <span class="attr">activeRenderLoops</span>: <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">activeRenderLoops</span>.<span class="property">length</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// GPU信息</span></span><br><span class="line">  <span class="title function_">getGPUInfo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> gl = <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">_gl</span></span><br><span class="line">    <span class="keyword">const</span> debugInfo = gl.<span class="title function_">getExtension</span>(<span class="string">&#x27;WEBGL_debug_renderer_info&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (debugInfo) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">vendor</span>: gl.<span class="title function_">getParameter</span>(debugInfo.<span class="property">UNMASKED_VENDOR_WEBGL</span>),</span><br><span class="line">        <span class="attr">renderer</span>: gl.<span class="title function_">getParameter</span>(debugInfo.<span class="property">UNMASKED_RENDERER_WEBGL</span>),</span><br><span class="line">        <span class="attr">version</span>: gl.<span class="title function_">getParameter</span>(gl.<span class="property">VERSION</span>),</span><br><span class="line">        <span class="attr">shadingLanguageVersion</span>: gl.<span class="title function_">getParameter</span>(gl.<span class="property">SHADING_LANGUAGE_VERSION</span>),</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">vendor</span>: gl.<span class="title function_">getParameter</span>(gl.<span class="property">VENDOR</span>),</span><br><span class="line">      <span class="attr">renderer</span>: gl.<span class="title function_">getParameter</span>(gl.<span class="property">RENDERER</span>),</span><br><span class="line">      <span class="attr">version</span>: gl.<span class="title function_">getParameter</span>(gl.<span class="property">VERSION</span>),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 事件处理</span></span><br><span class="line">  <span class="title function_">handleContextLost</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 停止渲染循环</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">stopRenderLoop</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 显示加载提示</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">showContextLostMessage</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">handleContextRestored</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 隐藏加载提示</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">hideContextLostMessage</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重新开始渲染</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">scene</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">startRenderLoop</span>(<span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">handleResize</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 延迟执行，避免频繁调用</span></span><br><span class="line">    <span class="built_in">clearTimeout</span>(<span class="variable language_">this</span>.<span class="property">resizeTimeout</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">resizeTimeout</span> = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">resize</span>()</span><br><span class="line">    &#125;, <span class="number">100</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">handleVisibilityChange</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">hidden</span>) &#123;</span><br><span class="line">      <span class="comment">// 页面隐藏时暂停渲染</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">stopRenderLoop</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 页面显示时恢复渲染</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">scene</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">startRenderLoop</span>(<span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">handleInitError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 显示错误信息</span></span><br><span class="line">    <span class="keyword">const</span> errorDiv = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    errorDiv.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">      &lt;div style=&quot;position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); </span></span><br><span class="line"><span class="string">                  background: rgba(255,0,0,0.8); color: white; padding: 20px; border-radius: 10px;&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;h3&gt;BabylonJS 初始化失败&lt;/h3&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;错误信息: <span class="subst">$&#123;error.message&#125;</span>&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;请检查浏览器是否支持WebGL&lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;/div&gt;</span></span><br><span class="line"><span class="string">    `</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(errorDiv)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onBeginFrame</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 每帧开始时的处理</span></span><br><span class="line">    <span class="comment">// 可以在这里进行性能统计、资源管理等</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onEndFrame</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 每帧结束时的处理</span></span><br><span class="line">    <span class="comment">// 可以在这里进行清理工作、统计信息更新等</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">showContextLostMessage</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> messageDiv = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    messageDiv.<span class="property">id</span> = <span class="string">&#x27;context-lost-message&#x27;</span></span><br><span class="line">    messageDiv.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">      &lt;div style=&quot;position: fixed; top: 0; left: 0; width: 100%; height: 100%; </span></span><br><span class="line"><span class="string">                  background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999;&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div style=&quot;background: white; padding: 20px; border-radius: 10px; text-align: center;&quot;&gt;</span></span><br><span class="line"><span class="string">          &lt;h3&gt;连接丢失&lt;/h3&gt;</span></span><br><span class="line"><span class="string">          &lt;p&gt;正在尝试重新连接...&lt;/p&gt;</span></span><br><span class="line"><span class="string">          &lt;div class=&quot;spinner&quot; style=&quot;margin: 10px auto; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 2s linear infinite;&quot;&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">      &lt;/div&gt;</span></span><br><span class="line"><span class="string">    `</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(messageDiv)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">hideContextLostMessage</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> messageDiv = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;context-lost-message&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> (messageDiv) &#123;</span><br><span class="line">      messageDiv.<span class="title function_">remove</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 资源清理</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 停止渲染循环</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">stopRenderLoop</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 移除事件监听</span></span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;resize&#x27;</span>, <span class="variable language_">this</span>.<span class="property">handleResize</span>)</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;visibilitychange&#x27;</span>, <span class="variable language_">this</span>.<span class="property">handleVisibilityChange</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理引擎</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">engine</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">dispose</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">engine</span> = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> canvas = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;babylonCanvas&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> engineManager = <span class="keyword">new</span> <span class="title class_">EngineManager</span>(canvas, &#123;</span><br><span class="line">  <span class="attr">antialias</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">preserveDrawingBuffer</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">powerPreference</span>: <span class="string">&#x27;high-performance&#x27;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启用性能监控</span></span><br><span class="line">engineManager.<span class="title function_">enablePerformanceMonitoring</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取引擎信息</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;引擎信息:&#x27;</span>, engineManager.<span class="title function_">getEngineInfo</span>())</span><br></pre></td></tr></table></figure><h2 id="🎭-Scene-场景详解"><a href="#🎭-Scene-场景详解" class="headerlink" title="🎭 Scene 场景详解"></a>🎭 Scene 场景详解</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Scene 场景系统完整管理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SceneManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">engine</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span> = engine</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sceneOptions</span> = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">init</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 创建场景</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = <span class="keyword">new</span> <span class="title class_">Scene</span>(<span class="variable language_">this</span>.<span class="property">engine</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置场景</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">configureScene</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置环境</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupEnvironment</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绑定事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">bindEvents</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">configureScene</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 物理引擎配置</span></span><br><span class="line">    <span class="comment">// 作用: 启用物理模拟</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">enablePhysics</span>(<span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, -<span class="number">9.81</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">CannonJSPlugin</span>())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 碰撞检测</span></span><br><span class="line">    <span class="comment">// 作用: 启用网格间碰撞检测</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">collisionsEnabled</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重力设置</span></span><br><span class="line">    <span class="comment">// 作用: 设置场景重力</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">gravity</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, -<span class="number">0.9</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 动画速度</span></span><br><span class="line">    <span class="comment">// 作用: 控制动画播放速度倍率</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">animationTimeScale</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 渲染组</span></span><br><span class="line">    <span class="comment">// 作用: 控制渲染顺序</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">setRenderingOrder</span>(</span><br><span class="line">      <span class="number">0</span>, <span class="comment">// opaque sorting</span></span><br><span class="line">      <span class="number">1</span>, <span class="comment">// alpha test sorting</span></span><br><span class="line">      <span class="number">2</span>,</span><br><span class="line">    ) <span class="comment">// transparent sorting</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自动清理</span></span><br><span class="line">    <span class="comment">// 作用: 自动清理未使用的资源</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">autoClear</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">autoClearDepthAndStencil</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// LOD (Level of Detail) 配置</span></span><br><span class="line">    <span class="comment">// 作用: 距离相关的细节层次</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">lodGenerationOffset</span> = <span class="number">0.5</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">lodGenerationTransitionTime</span> = <span class="number">250</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupEnvironment</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 环境纹理</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupEnvironmentTexture</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 雾效</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupFog</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 天空盒</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupSkybox</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 全局光照</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupGlobalIllumination</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupEnvironmentTexture</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// HDR环境纹理</span></span><br><span class="line">    <span class="comment">// 作用: 提供真实的环境光照和反射</span></span><br><span class="line">    <span class="keyword">const</span> hdrTexture = <span class="title class_">CubeTexture</span>.<span class="title class_">CreateFromPrefilteredData</span>(</span><br><span class="line">      <span class="string">&#x27;/environments/environment.dds&#x27;</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">    )</span><br><span class="line">    hdrTexture.<span class="property">name</span> = <span class="string">&#x27;environmentTexture&#x27;</span></span><br><span class="line">    hdrTexture.<span class="property">gammaSpace</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">environmentTexture</span> = hdrTexture</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">createDefaultSkybox</span>(hdrTexture, <span class="literal">true</span>, <span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 环境强度</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">environmentIntensity</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// IBL (Image Based Lighting)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">imageProcessingConfiguration</span>.<span class="property">exposure</span> = <span class="number">1.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">imageProcessingConfiguration</span>.<span class="property">contrast</span> = <span class="number">1.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">imageProcessingConfiguration</span>.<span class="property">toneMappingEnabled</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">imageProcessingConfiguration</span>.<span class="property">toneMappingType</span> =</span><br><span class="line">      <span class="title class_">ImageProcessingConfiguration</span>.<span class="property">TONEMAPPING_ACES</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupFog</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 雾效类型</span></span><br><span class="line">    <span class="comment">// FOG_NONE: 无雾</span></span><br><span class="line">    <span class="comment">// FOG_EXP: 指数雾</span></span><br><span class="line">    <span class="comment">// FOG_EXP2: 二次指数雾</span></span><br><span class="line">    <span class="comment">// FOG_LINEAR: 线性雾</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">fogMode</span> = <span class="title class_">Scene</span>.<span class="property">FOGMODE_LINEAR</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 雾的颜色</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">fogColor</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.9</span>, <span class="number">0.9</span>, <span class="number">0.85</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 线性雾参数</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">fogStart</span> = <span class="number">20.0</span> <span class="comment">// 雾开始距离</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">fogEnd</span> = <span class="number">60.0</span> <span class="comment">// 雾结束距离</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指数雾参数（当使用指数雾时）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">fogDensity</span> = <span class="number">0.01</span> <span class="comment">// 雾密度</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupSkybox</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 程序化天空盒</span></span><br><span class="line">    <span class="keyword">const</span> skybox = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateSphere</span>(<span class="string">&#x27;skyBox&#x27;</span>, &#123; <span class="attr">diameter</span>: <span class="number">1000</span> &#125;, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="keyword">const</span> skyboxMaterial = <span class="keyword">new</span> <span class="title class_">StandardMaterial</span>(<span class="string">&#x27;skyBox&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 天空盒材质配置</span></span><br><span class="line">    skyboxMaterial.<span class="property">backFaceCulling</span> = <span class="literal">false</span></span><br><span class="line">    skyboxMaterial.<span class="property">reflectionTexture</span> = <span class="keyword">new</span> <span class="title class_">CubeTexture</span>(<span class="string">&#x27;/textures/skybox/skybox&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    skyboxMaterial.<span class="property">reflectionTexture</span>.<span class="property">coordinatesMode</span> = <span class="title class_">Texture</span>.<span class="property">SKYBOX_MODE</span></span><br><span class="line">    skyboxMaterial.<span class="property">diffuseColor</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    skyboxMaterial.<span class="property">specularColor</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    skybox.<span class="property">material</span> = skyboxMaterial</span><br><span class="line">    skybox.<span class="property">infiniteDistance</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> skybox</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupGlobalIllumination</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 图像处理配置</span></span><br><span class="line">    <span class="keyword">const</span> imageProcessing = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">imageProcessingConfiguration</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 色调映射</span></span><br><span class="line">    imageProcessing.<span class="property">toneMappingEnabled</span> = <span class="literal">true</span></span><br><span class="line">    imageProcessing.<span class="property">toneMappingType</span> = <span class="title class_">ImageProcessingConfiguration</span>.<span class="property">TONEMAPPING_ACES</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 曝光度</span></span><br><span class="line">    imageProcessing.<span class="property">exposure</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对比度</span></span><br><span class="line">    imageProcessing.<span class="property">contrast</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 色彩平衡</span></span><br><span class="line">    imageProcessing.<span class="property">colorGradingEnabled</span> = <span class="literal">true</span></span><br><span class="line">    imageProcessing.<span class="property">colorGradingTexture</span> = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;/textures/colorgrading_lut.png&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Bloom效果</span></span><br><span class="line">    imageProcessing.<span class="property">vignetteEnabled</span> = <span class="literal">true</span></span><br><span class="line">    imageProcessing.<span class="property">vignetteWeight</span> = <span class="number">1.5</span></span><br><span class="line">    imageProcessing.<span class="property">vignetteStretch</span> = <span class="number">0.5</span></span><br><span class="line">    imageProcessing.<span class="property">vignetteCameraFov</span> = <span class="number">0.5</span></span><br><span class="line">    imageProcessing.<span class="property">vignetteColor</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">bindEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 场景准备就绪</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onReadyObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;场景准备就绪&#x27;</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onSceneReady</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 渲染前事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onBeforeRender</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 渲染后事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onAfterRenderObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onAfterRender</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 相机变化事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onActiveCameraChanged</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onActiveCameraChanged</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新网格添加事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onNewMeshAddedObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onNewMeshAdded</span>(mesh)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 网格移除事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onMeshRemovedObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onMeshRemoved</span>(mesh)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指针事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">actionManager</span> = <span class="keyword">new</span> <span class="title class_">ActionManager</span>(<span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupPointerEvents</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupPointerEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 鼠标点击事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onPointerObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">pointerInfo</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">switch</span> (pointerInfo.<span class="property">type</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">PointerEventTypes</span>.<span class="property">POINTERDOWN</span>:</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onPointerDown</span>(pointerInfo)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">PointerEventTypes</span>.<span class="property">POINTERUP</span>:</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onPointerUp</span>(pointerInfo)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">PointerEventTypes</span>.<span class="property">POINTERMOVE</span>:</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onPointerMove</span>(pointerInfo)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">PointerEventTypes</span>.<span class="property">POINTERWHEEL</span>:</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onPointerWheel</span>(pointerInfo)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拾取信息</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onPointerPick</span> = <span class="function">(<span class="params">evt, pickInfo</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (pickInfo.<span class="property">hit</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;拾取到网格:&#x27;</span>, pickInfo.<span class="property">pickedMesh</span>?.<span class="property">name</span>)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">onMeshPicked</span>(pickInfo.<span class="property">pickedMesh</span>, pickInfo.<span class="property">pickedPoint</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 场景优化</span></span><br><span class="line">  <span class="title function_">optimizeScene</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 合并网格</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">mergeMeshes</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置渲染组</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupRenderingGroups</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启用实例化</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">enableInstancing</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置LOD</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupLevelOfDetail</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 冻结变换矩阵</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">freezeTransformMatrices</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">mergeMeshes</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 合并静态网格以减少绘制调用</span></span><br><span class="line">    <span class="keyword">const</span> staticMeshes = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">meshes</span>.<span class="title function_">filter</span>(</span><br><span class="line">      <span class="function">(<span class="params">mesh</span>) =&gt;</span> mesh.<span class="property">name</span>.<span class="title function_">startsWith</span>(<span class="string">&#x27;static_&#x27;</span>) &amp;&amp; !mesh.<span class="property">skeleton</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (staticMeshes.<span class="property">length</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> merged = <span class="title class_">Mesh</span>.<span class="title class_">MergeMeshes</span>(staticMeshes, <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">true</span>)</span><br><span class="line">      <span class="keyword">if</span> (merged) &#123;</span><br><span class="line">        merged.<span class="property">name</span> = <span class="string">&#x27;merged_static_meshes&#x27;</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`合并了 <span class="subst">$&#123;staticMeshes.length&#125;</span> 个静态网格`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupRenderingGroups</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 渲染组：0-不透明物体，1-透明物体，2-UI元素</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (mesh.<span class="property">material</span> &amp;&amp; mesh.<span class="property">material</span>.<span class="property">alpha</span> &lt; <span class="number">1.0</span>) &#123;</span><br><span class="line">        mesh.<span class="property">renderingGroupId</span> = <span class="number">1</span> <span class="comment">// 透明物体</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mesh.<span class="property">renderingGroupId</span> = <span class="number">0</span> <span class="comment">// 不透明物体</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">enableInstancing</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 为重复的网格启用实例化</span></span><br><span class="line">    <span class="keyword">const</span> trees = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">meshes</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> mesh.<span class="property">name</span>.<span class="title function_">includes</span>(<span class="string">&#x27;tree&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> (trees.<span class="property">length</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> sourceMesh = trees[<span class="number">0</span>]</span><br><span class="line">      <span class="keyword">const</span> instances = []</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; trees.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> instance = sourceMesh.<span class="title function_">createInstance</span>(<span class="string">`tree_instance_<span class="subst">$&#123;i&#125;</span>`</span>)</span><br><span class="line">        instance.<span class="property">position</span> = trees[i].<span class="property">position</span></span><br><span class="line">        instance.<span class="property">rotation</span> = trees[i].<span class="property">rotation</span></span><br><span class="line">        instance.<span class="property">scaling</span> = trees[i].<span class="property">scaling</span></span><br><span class="line">        instances.<span class="title function_">push</span>(instance)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 移除原始网格</span></span><br><span class="line">        trees[i].<span class="title function_">dispose</span>()</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`创建了 <span class="subst">$&#123;instances.length&#125;</span> 个树木实例`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupLevelOfDetail</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 为大型网格设置LOD</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (mesh.<span class="title function_">getTotalVertices</span>() &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">        <span class="comment">// 创建简化版本</span></span><br><span class="line">        <span class="keyword">const</span> lod1 = mesh.<span class="title function_">clone</span>(<span class="string">`<span class="subst">$&#123;mesh.name&#125;</span>_lod1`</span>)</span><br><span class="line">        <span class="keyword">const</span> lod2 = mesh.<span class="title function_">clone</span>(<span class="string">`<span class="subst">$&#123;mesh.name&#125;</span>_lod2`</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里应该使用简化算法创建低模</span></span><br><span class="line">        <span class="comment">// 示例：可以集成第三方简化库</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置LOD距离</span></span><br><span class="line">        mesh.<span class="title function_">addLODLevel</span>(<span class="number">50</span>, lod1)</span><br><span class="line">        mesh.<span class="title function_">addLODLevel</span>(<span class="number">100</span>, lod2)</span><br><span class="line">        mesh.<span class="title function_">addLODLevel</span>(<span class="number">200</span>, <span class="literal">null</span>) <span class="comment">// 完全隐藏</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">freezeTransformMatrices</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 冻结不再移动的网格的变换矩阵</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (mesh.<span class="property">name</span>.<span class="title function_">includes</span>(<span class="string">&#x27;static_&#x27;</span>) || mesh.<span class="property">name</span>.<span class="title function_">includes</span>(<span class="string">&#x27;building_&#x27;</span>)) &#123;</span><br><span class="line">        mesh.<span class="title function_">freezeWorldMatrix</span>()</span><br><span class="line">        mesh.<span class="property">doNotSyncBoundingInfo</span> = <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 场景序列化和加载</span></span><br><span class="line">  <span class="title function_">serializeScene</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 序列化场景为JSON</span></span><br><span class="line">    <span class="keyword">const</span> serializedScene = <span class="title class_">SceneSerializer</span>.<span class="title class_">Serialize</span>(<span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存到本地存储</span></span><br><span class="line">    <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;babylonjs_scene&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(serializedScene))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> serializedScene</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadScene</span>(<span class="params">sceneData</span>) &#123;</span><br><span class="line">    <span class="comment">// 从序列化数据加载场景</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> sceneData === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">      sceneData = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(sceneData)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理当前场景</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">dispose</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建新场景</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = <span class="keyword">new</span> <span class="title class_">Scene</span>(<span class="variable language_">this</span>.<span class="property">engine</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 导入序列化数据</span></span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">SceneLoader</span>.<span class="title class_">ImportMeshAsync</span>(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, sceneData, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重新配置场景</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">configureScene</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">bindEvents</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 事件回调</span></span><br><span class="line">  <span class="title function_">onSceneReady</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 场景准备就绪后的处理</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">optimizeScene</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onBeforeRender</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 每帧渲染前的处理</span></span><br><span class="line">    <span class="comment">// 可以在这里更新动画、物理等</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onAfterRender</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 每帧渲染后的处理</span></span><br><span class="line">    <span class="comment">// 可以在这里进行后处理、UI更新等</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onActiveCameraChanged</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 相机切换时的处理</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;活动相机已切换:&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">activeCamera</span>?.<span class="property">name</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onNewMeshAdded</span>(<span class="params">mesh</span>) &#123;</span><br><span class="line">    <span class="comment">// 新网格添加时的处理</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;新网格已添加:&#x27;</span>, mesh.<span class="property">name</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自动设置物理属性</span></span><br><span class="line">    <span class="keyword">if</span> (mesh.<span class="property">name</span>.<span class="title function_">includes</span>(<span class="string">&#x27;physics_&#x27;</span>)) &#123;</span><br><span class="line">      mesh.<span class="property">physicsImpostor</span> = <span class="keyword">new</span> <span class="title class_">PhysicsImpostor</span>(</span><br><span class="line">        mesh,</span><br><span class="line">        <span class="title class_">PhysicsImpostor</span>.<span class="property">BoxImpostor</span>,</span><br><span class="line">        &#123; <span class="attr">mass</span>: <span class="number">1</span> &#125;,</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onMeshRemoved</span>(<span class="params">mesh</span>) &#123;</span><br><span class="line">    <span class="comment">// 网格移除时的处理</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;网格已移除:&#x27;</span>, mesh.<span class="property">name</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onPointerDown</span>(<span class="params">pointerInfo</span>) &#123;</span><br><span class="line">    <span class="comment">// 鼠标按下事件处理</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onPointerUp</span>(<span class="params">pointerInfo</span>) &#123;</span><br><span class="line">    <span class="comment">// 鼠标释放事件处理</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onPointerMove</span>(<span class="params">pointerInfo</span>) &#123;</span><br><span class="line">    <span class="comment">// 鼠标移动事件处理</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onPointerWheel</span>(<span class="params">pointerInfo</span>) &#123;</span><br><span class="line">    <span class="comment">// 鼠标滚轮事件处理</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onMeshPicked</span>(<span class="params">mesh, pickPoint</span>) &#123;</span><br><span class="line">    <span class="comment">// 网格拾取事件处理</span></span><br><span class="line">    <span class="keyword">if</span> (mesh) &#123;</span><br><span class="line">      <span class="comment">// 高亮被拾取的网格</span></span><br><span class="line">      mesh.<span class="property">renderOutline</span> = <span class="literal">true</span></span><br><span class="line">      mesh.<span class="property">outlineColor</span> = <span class="title class_">Color3</span>.<span class="title class_">Red</span>()</span><br><span class="line">      mesh.<span class="property">outlineWidth</span> = <span class="number">0.02</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 取消其他网格的高亮</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">m</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (m !== mesh) &#123;</span><br><span class="line">          m.<span class="property">renderOutline</span> = <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 资源清理</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">scene</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">dispose</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span> = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> sceneManager = <span class="keyword">new</span> <span class="title class_">SceneManager</span>(engine)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 序列化场景</span></span><br><span class="line"><span class="keyword">const</span> sceneData = sceneManager.<span class="title function_">serializeScene</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载场景</span></span><br><span class="line"><span class="comment">// sceneManager.loadScene(sceneData)</span></span><br></pre></td></tr></table></figure><h2 id="📷-Camera-相机系统详解"><a href="#📷-Camera-相机系统详解" class="headerlink" title="📷 Camera 相机系统详解"></a>📷 Camera 相机系统详解</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Camera 相机系统完整管理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CameraManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cameras</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">activeCamera</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupDefaultCameras</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupDefaultCameras</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 自由相机 - 第一人称视角</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createFreeCamera</span>(<span class="string">&#x27;freeCamera&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">5</span>, -<span class="number">10</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 弧形旋转相机 - 第三人称视角</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createArcRotateCamera</span>(<span class="string">&#x27;arcCamera&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通用相机 - 混合模式</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createUniversalCamera</span>(<span class="string">&#x27;universalCamera&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">5</span>, -<span class="number">10</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置默认相机</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setActiveCamera</span>(<span class="string">&#x27;arcCamera&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 自由相机 (FreeCamera)</span></span><br><span class="line">  <span class="title function_">createFreeCamera</span>(<span class="params">name, position</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="keyword">new</span> <span class="title class_">FreeCamera</span>(name, position, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 基础配置</span></span><br><span class="line">    camera.<span class="title function_">setTarget</span>(<span class="title class_">Vector3</span>.<span class="title class_">Zero</span>())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 移动速度配置</span></span><br><span class="line">    <span class="comment">// speed: number - 移动速度</span></span><br><span class="line">    camera.<span class="property">speed</span> = <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// angularSensibility: number - 鼠标灵敏度</span></span><br><span class="line">    camera.<span class="property">angularSensibility</span> = <span class="number">2000</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 键盘控制配置</span></span><br><span class="line">    camera.<span class="property">keysUp</span> = [<span class="number">87</span>] <span class="comment">// W键</span></span><br><span class="line">    camera.<span class="property">keysDown</span> = [<span class="number">83</span>] <span class="comment">// S键</span></span><br><span class="line">    camera.<span class="property">keysLeft</span> = [<span class="number">65</span>] <span class="comment">// A键</span></span><br><span class="line">    camera.<span class="property">keysRight</span> = [<span class="number">68</span>] <span class="comment">// D键</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 惯性配置</span></span><br><span class="line">    <span class="comment">// inertia: number - 惯性系数 (0-1)</span></span><br><span class="line">    camera.<span class="property">inertia</span> = <span class="number">0.9</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 碰撞检测</span></span><br><span class="line">    camera.<span class="property">checkCollisions</span> = <span class="literal">true</span></span><br><span class="line">    camera.<span class="property">collisionRadius</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0.5</span>, <span class="number">1.8</span>, <span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重力</span></span><br><span class="line">    camera.<span class="property">applyGravity</span> = <span class="literal">true</span></span><br><span class="line">    camera.<span class="property">needMoveForGravity</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 椭球体碰撞</span></span><br><span class="line">    camera.<span class="property">ellipsoid</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0.5</span>, <span class="number">1</span>, <span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跳跃</span></span><br><span class="line">    camera.<span class="property">setUpVector</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">set</span>(name, camera)</span><br><span class="line">    <span class="keyword">return</span> camera</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 弧形旋转相机 (ArcRotateCamera)</span></span><br><span class="line">  <span class="title function_">createArcRotateCamera</span>(<span class="params">name, target, radius</span>) &#123;</span><br><span class="line">    <span class="comment">// alpha: 水平角度 (弧度)</span></span><br><span class="line">    <span class="comment">// beta: 垂直角度 (弧度)</span></span><br><span class="line">    <span class="comment">// radius: 距离目标的距离</span></span><br><span class="line">    <span class="keyword">const</span> camera = <span class="keyword">new</span> <span class="title class_">ArcRotateCamera</span>(</span><br><span class="line">      name,</span><br><span class="line">      -<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">2</span>,</span><br><span class="line">      <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">2.5</span>,</span><br><span class="line">      radius,</span><br><span class="line">      target,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 角度限制</span></span><br><span class="line">    camera.<span class="property">lowerAlphaLimit</span> = -<span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span> <span class="comment">// 水平最小角度</span></span><br><span class="line">    camera.<span class="property">upperAlphaLimit</span> = <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span> <span class="comment">// 水平最大角度</span></span><br><span class="line">    camera.<span class="property">lowerBetaLimit</span> = <span class="number">0.1</span> <span class="comment">// 垂直最小角度</span></span><br><span class="line">    camera.<span class="property">upperBetaLimit</span> = <span class="title class_">Math</span>.<span class="property">PI</span> - <span class="number">0.1</span> <span class="comment">// 垂直最大角度</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 距离限制</span></span><br><span class="line">    camera.<span class="property">lowerRadiusLimit</span> = <span class="number">2</span> <span class="comment">// 最小距离</span></span><br><span class="line">    camera.<span class="property">upperRadiusLimit</span> = <span class="number">50</span> <span class="comment">// 最大距离</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 平移限制</span></span><br><span class="line">    camera.<span class="property">lowerTargetOffsetLimit</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">10</span>, -<span class="number">10</span>, -<span class="number">10</span>)</span><br><span class="line">    camera.<span class="property">upperTargetOffsetLimit</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 鼠标控制配置</span></span><br><span class="line">    camera.<span class="property">angularSensibilityX</span> = <span class="number">1000</span> <span class="comment">// 水平灵敏度</span></span><br><span class="line">    camera.<span class="property">angularSensibilityY</span> = <span class="number">1000</span> <span class="comment">// 垂直灵敏度</span></span><br><span class="line">    camera.<span class="property">wheelDeltaPercentage</span> = <span class="number">0.01</span> <span class="comment">// 滚轮缩放速度</span></span><br><span class="line">    camera.<span class="property">pinchDeltaPercentage</span> = <span class="number">0.01</span> <span class="comment">// 触摸缩放速度</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 惯性</span></span><br><span class="line">    camera.<span class="property">inertia</span> = <span class="number">0.9</span></span><br><span class="line">    camera.<span class="property">panningInertia</span> = <span class="number">0.9</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自动旋转</span></span><br><span class="line">    camera.<span class="property">useAutoRotationBehavior</span> = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">if</span> (camera.<span class="property">useAutoRotationBehavior</span>) &#123;</span><br><span class="line">      camera.<span class="property">autoRotationBehavior</span>.<span class="property">idleRotationSpeed</span> = <span class="number">0.2</span></span><br><span class="line">      camera.<span class="property">autoRotationBehavior</span>.<span class="property">idleRotationWaitTime</span> = <span class="number">2000</span></span><br><span class="line">      camera.<span class="property">autoRotationBehavior</span>.<span class="property">idleRotationSpinupTime</span> = <span class="number">2000</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 边界行为</span></span><br><span class="line">    camera.<span class="property">useBouncingBehavior</span> = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> (camera.<span class="property">useBouncingBehavior</span>) &#123;</span><br><span class="line">      camera.<span class="property">bouncingBehavior</span>.<span class="property">transitionDuration</span> = <span class="number">450</span></span><br><span class="line">      camera.<span class="property">bouncingBehavior</span>.<span class="property">lowerRadiusTransitionRange</span> = <span class="number">2</span></span><br><span class="line">      camera.<span class="property">bouncingBehavior</span>.<span class="property">upperRadiusTransitionRange</span> = -<span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 框选行为</span></span><br><span class="line">    camera.<span class="property">useFramingBehavior</span> = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> (camera.<span class="property">useFramingBehavior</span>) &#123;</span><br><span class="line">      camera.<span class="property">framingBehavior</span>.<span class="property">mode</span> = <span class="title class_">FramingBehavior</span>.<span class="property">FitFrustumSidesMode</span></span><br><span class="line">      camera.<span class="property">framingBehavior</span>.<span class="property">radiusScale</span> = <span class="number">1.0</span></span><br><span class="line">      camera.<span class="property">framingBehavior</span>.<span class="property">positionScale</span> = <span class="number">0.5</span></span><br><span class="line">      camera.<span class="property">framingBehavior</span>.<span class="property">defaultElevation</span> = <span class="number">0.3</span></span><br><span class="line">      camera.<span class="property">framingBehavior</span>.<span class="property">elevationReturnTime</span> = <span class="number">1500</span></span><br><span class="line">      camera.<span class="property">framingBehavior</span>.<span class="property">elevationReturnWaitTime</span> = <span class="number">1000</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">set</span>(name, camera)</span><br><span class="line">    <span class="keyword">return</span> camera</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通用相机 (UniversalCamera)</span></span><br><span class="line">  <span class="title function_">createUniversalCamera</span>(<span class="params">name, position</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="keyword">new</span> <span class="title class_">UniversalCamera</span>(name, position, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 继承自FreeCamera的所有属性</span></span><br><span class="line">    camera.<span class="title function_">setTarget</span>(<span class="title class_">Vector3</span>.<span class="title class_">Zero</span>())</span><br><span class="line">    camera.<span class="property">speed</span> = <span class="number">0.5</span></span><br><span class="line">    camera.<span class="property">angularSensibility</span> = <span class="number">2000</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 触摸控制 (移动设备)</span></span><br><span class="line">    camera.<span class="property">touchAngularSensibility</span> = <span class="number">20000</span></span><br><span class="line">    camera.<span class="property">touchMoveSensibility</span> = <span class="number">250</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 游戏手柄支持</span></span><br><span class="line">    camera.<span class="property">gamepadAngularSensibility</span> = <span class="number">200</span></span><br><span class="line">    camera.<span class="property">gamepadMoveSensibility</span> = <span class="number">40</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">set</span>(name, camera)</span><br><span class="line">    <span class="keyword">return</span> camera</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// VR相机</span></span><br><span class="line">  <span class="title function_">createVRCamera</span>(<span class="params">name, position</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="keyword">new</span> <span class="title class_">WebVRFreeCamera</span>(name, position, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// VR设备检测</span></span><br><span class="line">    camera.<span class="property">deviceOrientationCamera</span>.<span class="property">angularSensibility</span> = <span class="number">2000</span></span><br><span class="line">    camera.<span class="property">deviceOrientationCamera</span>.<span class="property">moveSensibility</span> = <span class="number">50</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">set</span>(name, camera)</span><br><span class="line">    <span class="keyword">return</span> camera</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 跟随相机 (FollowCamera)</span></span><br><span class="line">  <span class="title function_">createFollowCamera</span>(<span class="params">name, target</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="keyword">new</span> <span class="title class_">FollowCamera</span>(name, <span class="title class_">Vector3</span>.<span class="title class_">Zero</span>(), <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跟随目标</span></span><br><span class="line">    camera.<span class="property">lockedTarget</span> = target</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跟随参数</span></span><br><span class="line">    camera.<span class="property">radius</span> = <span class="number">10</span> <span class="comment">// 跟随距离</span></span><br><span class="line">    camera.<span class="property">heightOffset</span> = <span class="number">5</span> <span class="comment">// 高度偏移</span></span><br><span class="line">    camera.<span class="property">rotationOffset</span> = <span class="number">0</span> <span class="comment">// 旋转偏移</span></span><br><span class="line">    camera.<span class="property">cameraAcceleration</span> = <span class="number">0.05</span> <span class="comment">// 加速度</span></span><br><span class="line">    camera.<span class="property">maxCameraSpeed</span> = <span class="number">20</span> <span class="comment">// 最大速度</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">set</span>(name, camera)</span><br><span class="line">    <span class="keyword">return</span> camera</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置活动相机</span></span><br><span class="line">  <span class="title function_">setActiveCamera</span>(<span class="params">cameraName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">get</span>(cameraName)</span><br><span class="line">    <span class="keyword">if</span> (camera) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">activeCamera</span> = camera</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">activeCamera</span> = camera</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 附加控制</span></span><br><span class="line">      camera.<span class="title function_">attachControls</span>(<span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>().<span class="title function_">getRenderingCanvas</span>(), <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 取消其他相机的控制</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">cam, name</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (name !== cameraName) &#123;</span><br><span class="line">          cam.<span class="title function_">detachControls</span>(<span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>().<span class="title function_">getRenderingCanvas</span>())</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`切换到相机: <span class="subst">$&#123;cameraName&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 相机动画</span></span><br><span class="line">  <span class="title function_">animateCameraTo</span>(<span class="params">targetPosition, targetTarget, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">activeCamera</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> camera = <span class="variable language_">this</span>.<span class="property">activeCamera</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 位置动画</span></span><br><span class="line">    <span class="keyword">const</span> positionAnimation = <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">      <span class="string">&#x27;cameraPosition&#x27;</span>,</span><br><span class="line">      camera,</span><br><span class="line">      <span class="string">&#x27;position&#x27;</span>,</span><br><span class="line">      <span class="number">30</span>, <span class="comment">// FPS</span></span><br><span class="line">      (duration / <span class="number">1000</span>) * <span class="number">30</span>, <span class="comment">// 总帧数</span></span><br><span class="line">      camera.<span class="property">position</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      targetPosition,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果是FreeCamera或UniversalCamera，也要动画目标</span></span><br><span class="line">    <span class="keyword">if</span> (camera <span class="keyword">instanceof</span> <span class="title class_">FreeCamera</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> targetAnimation = <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraTarget&#x27;</span>,</span><br><span class="line">        camera,</span><br><span class="line">        <span class="string">&#x27;target&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">        camera.<span class="title function_">getTarget</span>().<span class="title function_">clone</span>(),</span><br><span class="line">        targetTarget,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果是ArcRotateCamera，需要计算alpha、beta、radius</span></span><br><span class="line">    <span class="keyword">if</span> (camera <span class="keyword">instanceof</span> <span class="title class_">ArcRotateCamera</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> direction = targetPosition.<span class="title function_">subtract</span>(targetTarget)</span><br><span class="line">      <span class="keyword">const</span> radius = direction.<span class="title function_">length</span>()</span><br><span class="line">      <span class="keyword">const</span> alpha = <span class="title class_">Math</span>.<span class="title function_">atan2</span>(direction.<span class="property">x</span>, direction.<span class="property">z</span>)</span><br><span class="line">      <span class="keyword">const</span> beta = <span class="title class_">Math</span>.<span class="title function_">acos</span>(direction.<span class="property">y</span> / radius)</span><br><span class="line"></span><br><span class="line">      <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraAlpha&#x27;</span>,</span><br><span class="line">        camera,</span><br><span class="line">        <span class="string">&#x27;alpha&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">        camera.<span class="property">alpha</span>,</span><br><span class="line">        alpha,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraBeta&#x27;</span>,</span><br><span class="line">        camera,</span><br><span class="line">        <span class="string">&#x27;beta&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">        camera.<span class="property">beta</span>,</span><br><span class="line">        beta,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraRadius&#x27;</span>,</span><br><span class="line">        camera,</span><br><span class="line">        <span class="string">&#x27;radius&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">        camera.<span class="property">radius</span>,</span><br><span class="line">        radius,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraTarget&#x27;</span>,</span><br><span class="line">        camera,</span><br><span class="line">        <span class="string">&#x27;target&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">        camera.<span class="property">target</span>.<span class="title function_">clone</span>(),</span><br><span class="line">        targetTarget,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 相机聚焦到网格</span></span><br><span class="line">  <span class="title function_">focusOnMesh</span>(<span class="params">mesh, offset = <span class="keyword">new</span> Vector3(<span class="number">0</span>, <span class="number">5</span>, -<span class="number">10</span>)</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">activeCamera</span> || !mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> boundingInfo = mesh.<span class="title function_">getBoundingInfo</span>()</span><br><span class="line">    <span class="keyword">const</span> center = boundingInfo.<span class="property">boundingBox</span>.<span class="property">centerWorld</span></span><br><span class="line">    <span class="keyword">const</span> size = boundingInfo.<span class="property">boundingBox</span>.<span class="property">extendSizeWorld</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算合适的距离</span></span><br><span class="line">    <span class="keyword">const</span> maxSize = <span class="title class_">Math</span>.<span class="title function_">max</span>(size.<span class="property">x</span>, size.<span class="property">y</span>, size.<span class="property">z</span>)</span><br><span class="line">    <span class="keyword">const</span> distance = maxSize * <span class="number">2.5</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> targetPosition = center.<span class="title function_">add</span>(offset.<span class="title function_">normalize</span>().<span class="title function_">scale</span>(distance))</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">animateCameraTo</span>(targetPosition, center)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 保存相机状态</span></span><br><span class="line">  <span class="title function_">saveCameraState</span>(<span class="params">cameraName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">get</span>(cameraName)</span><br><span class="line">    <span class="keyword">if</span> (!camera) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> state = &#123;</span><br><span class="line">      <span class="attr">name</span>: cameraName,</span><br><span class="line">      <span class="attr">type</span>: camera.<span class="title function_">getClassName</span>(),</span><br><span class="line">      <span class="attr">position</span>: camera.<span class="property">position</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">target</span>: camera.<span class="title function_">getTarget</span>().<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">upVector</span>: camera.<span class="property">upVector</span>.<span class="title function_">clone</span>(),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ArcRotateCamera额外状态</span></span><br><span class="line">    <span class="keyword">if</span> (camera <span class="keyword">instanceof</span> <span class="title class_">ArcRotateCamera</span>) &#123;</span><br><span class="line">      state.<span class="property">alpha</span> = camera.<span class="property">alpha</span></span><br><span class="line">      state.<span class="property">beta</span> = camera.<span class="property">beta</span></span><br><span class="line">      state.<span class="property">radius</span> = camera.<span class="property">radius</span></span><br><span class="line">      state.<span class="property">target</span> = camera.<span class="property">target</span>.<span class="title function_">clone</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 恢复相机状态</span></span><br><span class="line">  <span class="title function_">restoreCameraState</span>(<span class="params">state</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">get</span>(state.<span class="property">name</span>)</span><br><span class="line">    <span class="keyword">if</span> (!camera) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    camera.<span class="property">position</span> = state.<span class="property">position</span>.<span class="title function_">clone</span>()</span><br><span class="line">    camera.<span class="property">upVector</span> = state.<span class="property">upVector</span>.<span class="title function_">clone</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (camera <span class="keyword">instanceof</span> <span class="title class_">ArcRotateCamera</span> &amp;&amp; state.<span class="property">alpha</span> !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      camera.<span class="property">alpha</span> = state.<span class="property">alpha</span></span><br><span class="line">      camera.<span class="property">beta</span> = state.<span class="property">beta</span></span><br><span class="line">      camera.<span class="property">radius</span> = state.<span class="property">radius</span></span><br><span class="line">      camera.<span class="property">target</span> = state.<span class="property">target</span>.<span class="title function_">clone</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (camera <span class="keyword">instanceof</span> <span class="title class_">FreeCamera</span>) &#123;</span><br><span class="line">      camera.<span class="title function_">setTarget</span>(state.<span class="property">target</span>.<span class="title function_">clone</span>())</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 相机摇晃效果</span></span><br><span class="line">  <span class="title function_">addShakeEffect</span>(<span class="params">intensity = <span class="number">0.1</span>, duration = <span class="number">1000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">activeCamera</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> camera = <span class="variable language_">this</span>.<span class="property">activeCamera</span></span><br><span class="line">    <span class="keyword">const</span> originalPosition = camera.<span class="property">position</span>.<span class="title function_">clone</span>()</span><br><span class="line">    <span class="keyword">const</span> shakeAnimation = <span class="keyword">new</span> <span class="title class_">Animation</span>(</span><br><span class="line">      <span class="string">&#x27;cameraShake&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;position&#x27;</span>,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> frameCount = (duration / <span class="number">1000</span>) * <span class="number">30</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= frameCount; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> progress = i / frameCount</span><br><span class="line">      <span class="keyword">const</span> shakeIntensity = intensity * (<span class="number">1</span> - progress) <span class="comment">// 逐渐减弱</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> shake = <span class="keyword">new</span> <span class="title class_">Vector3</span>(</span><br><span class="line">        (<span class="title class_">Math</span>.<span class="title function_">random</span>() - <span class="number">0.5</span>) * shakeIntensity,</span><br><span class="line">        (<span class="title class_">Math</span>.<span class="title function_">random</span>() - <span class="number">0.5</span>) * shakeIntensity,</span><br><span class="line">        (<span class="title class_">Math</span>.<span class="title function_">random</span>() - <span class="number">0.5</span>) * shakeIntensity,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: i,</span><br><span class="line">        <span class="attr">value</span>: originalPosition.<span class="title function_">add</span>(shake),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最后回到原位置</span></span><br><span class="line">    keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">      <span class="attr">frame</span>: frameCount,</span><br><span class="line">      <span class="attr">value</span>: originalPosition,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    shakeAnimation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> animatable = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">beginDirectAnimation</span>(</span><br><span class="line">      camera,</span><br><span class="line">      [shakeAnimation],</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      frameCount,</span><br><span class="line">      <span class="literal">false</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> animatable</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 第一人称射击游戏相机设置</span></span><br><span class="line">  <span class="title function_">setupFPSCamera</span>(<span class="params">cameraName = <span class="string">&#x27;fpsCamera&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="variable language_">this</span>.<span class="title function_">createFreeCamera</span>(cameraName, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">1.8</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// FPS专用设置</span></span><br><span class="line">    camera.<span class="property">speed</span> = <span class="number">0.2</span></span><br><span class="line">    camera.<span class="property">angularSensibility</span> = <span class="number">1500</span></span><br><span class="line">    camera.<span class="property">minZ</span> = <span class="number">0.1</span> <span class="comment">// 近裁剪面</span></span><br><span class="line">    camera.<span class="property">maxZ</span> = <span class="number">1000</span> <span class="comment">// 远裁剪面</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跳跃设置</span></span><br><span class="line">    camera.<span class="property">jumpSpeed</span> = <span class="number">0.3</span></span><br><span class="line">    camera.<span class="property">gravity</span> = <span class="number">0.9</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 鼠标锁定</span></span><br><span class="line">    camera.<span class="title function_">attachControls</span>(<span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>().<span class="title function_">getRenderingCanvas</span>(), <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 武器摇摆效果</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupWeaponSway</span>(camera)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> camera</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupWeaponSway</span>(<span class="params">camera</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> swayTime = <span class="number">0</span></span><br><span class="line">    <span class="keyword">const</span> swaySpeed = <span class="number">0.005</span></span><br><span class="line">    <span class="keyword">const</span> swayAmount = <span class="number">0.002</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (camera === <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">activeCamera</span>) &#123;</span><br><span class="line">        swayTime += <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>().<span class="title function_">getDeltaTime</span>() * swaySpeed</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算摇摆偏移</span></span><br><span class="line">        <span class="keyword">const</span> swayX = <span class="title class_">Math</span>.<span class="title function_">sin</span>(swayTime * <span class="number">2</span>) * swayAmount</span><br><span class="line">        <span class="keyword">const</span> swayY = <span class="title class_">Math</span>.<span class="title function_">sin</span>(swayTime) * swayAmount * <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 应用到相机</span></span><br><span class="line">        camera.<span class="property">position</span>.<span class="property">x</span> += swayX</span><br><span class="line">        camera.<span class="property">position</span>.<span class="property">y</span> += swayY</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 电影级相机运动</span></span><br><span class="line">  <span class="title function_">createCinematicPath</span>(<span class="params">waypoints, duration = <span class="number">10000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (waypoints.<span class="property">length</span> &lt; <span class="number">2</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建路径</span></span><br><span class="line">    <span class="keyword">const</span> path = []</span><br><span class="line">    waypoints.<span class="title function_">forEach</span>(<span class="function">(<span class="params">waypoint</span>) =&gt;</span> &#123;</span><br><span class="line">      path.<span class="title function_">push</span>(waypoint.<span class="property">position</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建平滑曲线</span></span><br><span class="line">    <span class="keyword">const</span> curve = <span class="title class_">Curve3</span>.<span class="title class_">CreateCatmullRomSpline</span>(path, path.<span class="property">length</span> * <span class="number">10</span>, <span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">const</span> curvePoints = curve.<span class="title function_">getPoints</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建动画</span></span><br><span class="line">    <span class="keyword">const</span> positionAnimation = <span class="keyword">new</span> <span class="title class_">Animation</span>(</span><br><span class="line">      <span class="string">&#x27;cinematicPosition&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;position&#x27;</span>,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">const</span> targetAnimation = <span class="keyword">new</span> <span class="title class_">Animation</span>(</span><br><span class="line">      <span class="string">&#x27;cinematicTarget&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;target&#x27;</span>,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * <span class="number">30</span></span><br><span class="line">    <span class="keyword">const</span> positionKeys = []</span><br><span class="line">    <span class="keyword">const</span> targetKeys = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= totalFrames; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> progress = i / totalFrames</span><br><span class="line">      <span class="keyword">const</span> pointIndex = <span class="title class_">Math</span>.<span class="title function_">floor</span>(progress * (curvePoints.<span class="property">length</span> - <span class="number">1</span>))</span><br><span class="line">      <span class="keyword">const</span> nextPointIndex = <span class="title class_">Math</span>.<span class="title function_">min</span>(pointIndex + <span class="number">1</span>, curvePoints.<span class="property">length</span> - <span class="number">1</span>)</span><br><span class="line">      <span class="keyword">const</span> localProgress = progress * (curvePoints.<span class="property">length</span> - <span class="number">1</span>) - pointIndex</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 插值位置</span></span><br><span class="line">      <span class="keyword">const</span> position = <span class="title class_">Vector3</span>.<span class="title class_">Lerp</span>(</span><br><span class="line">        curvePoints[pointIndex],</span><br><span class="line">        curvePoints[nextPointIndex],</span><br><span class="line">        localProgress,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 计算目标（向前看）</span></span><br><span class="line">      <span class="keyword">const</span> lookAheadIndex = <span class="title class_">Math</span>.<span class="title function_">min</span>(pointIndex + <span class="number">5</span>, curvePoints.<span class="property">length</span> - <span class="number">1</span>)</span><br><span class="line">      <span class="keyword">const</span> target = curvePoints[lookAheadIndex]</span><br><span class="line"></span><br><span class="line">      positionKeys.<span class="title function_">push</span>(&#123; <span class="attr">frame</span>: i, <span class="attr">value</span>: position &#125;)</span><br><span class="line">      targetKeys.<span class="title function_">push</span>(&#123; <span class="attr">frame</span>: i, <span class="attr">value</span>: target &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    positionAnimation.<span class="title function_">setKeys</span>(positionKeys)</span><br><span class="line">    targetAnimation.<span class="title function_">setKeys</span>(targetKeys)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [positionAnimation, targetAnimation]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取相机信息</span></span><br><span class="line">  <span class="title function_">getCameraInfo</span>(<span class="params">cameraName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">get</span>(cameraName)</span><br><span class="line">    <span class="keyword">if</span> (!camera) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> info = &#123;</span><br><span class="line">      <span class="attr">name</span>: cameraName,</span><br><span class="line">      <span class="attr">type</span>: camera.<span class="title function_">getClassName</span>(),</span><br><span class="line">      <span class="attr">position</span>: camera.<span class="property">position</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">target</span>: camera.<span class="title function_">getTarget</span>(),</span><br><span class="line">      <span class="attr">fov</span>: camera.<span class="property">fov</span>,</span><br><span class="line">      <span class="attr">minZ</span>: camera.<span class="property">minZ</span>,</span><br><span class="line">      <span class="attr">maxZ</span>: camera.<span class="property">maxZ</span>,</span><br><span class="line">      <span class="attr">isActive</span>: camera === <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">activeCamera</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (camera <span class="keyword">instanceof</span> <span class="title class_">ArcRotateCamera</span>) &#123;</span><br><span class="line">      info.<span class="property">alpha</span> = camera.<span class="property">alpha</span></span><br><span class="line">      info.<span class="property">beta</span> = camera.<span class="property">beta</span></span><br><span class="line">      info.<span class="property">radius</span> = camera.<span class="property">radius</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 资源清理</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">camera</span>) =&gt;</span> &#123;</span><br><span class="line">      camera.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> cameraManager = <span class="keyword">new</span> <span class="title class_">CameraManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 切换相机</span></span><br><span class="line">cameraManager.<span class="title function_">setActiveCamera</span>(<span class="string">&#x27;arcCamera&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 聚焦到网格</span></span><br><span class="line">cameraManager.<span class="title function_">focusOnMesh</span>(someMesh)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加摇晃效果</span></span><br><span class="line">cameraManager.<span class="title function_">addShakeEffect</span>(<span class="number">0.2</span>, <span class="number">2000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置FPS相机</span></span><br><span class="line"><span class="keyword">const</span> fpsCamera = cameraManager.<span class="title function_">setupFPSCamera</span>()</span><br></pre></td></tr></table></figure><h2 id="💡-Light-光照系统详解"><a href="#💡-Light-光照系统详解" class="headerlink" title="💡 Light 光照系统详解"></a>💡 Light 光照系统详解</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Light 光照系统完整管理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LightManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadowGenerators</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupDefaultLighting</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupDefaultLighting</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 环境光</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createHemisphericLight</span>(<span class="string">&#x27;ambientLight&#x27;</span>, <span class="title class_">Vector3</span>.<span class="title class_">Up</span>(), <span class="number">0.3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 主光源</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createDirectionalLight</span>(<span class="string">&#x27;sunLight&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>), <span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 补光</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createSpotLight</span>(<span class="string">&#x27;fillLight&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">5</span>, <span class="number">10</span>, <span class="number">5</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, -<span class="number">1</span>, <span class="number">0</span>), <span class="number">0.5</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 半球光 (HemisphericLight) - 环境光</span></span><br><span class="line">  <span class="title function_">createHemisphericLight</span>(<span class="params">name, direction, intensity = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> light = <span class="keyword">new</span> <span class="title class_">HemisphericLight</span>(name, direction, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 基础属性</span></span><br><span class="line">    light.<span class="property">intensity</span> = intensity</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 颜色配置</span></span><br><span class="line">    <span class="comment">// diffuse: Color3 - 漫反射颜色</span></span><br><span class="line">    light.<span class="property">diffuse</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// specular: Color3 - 镜面反射颜色</span></span><br><span class="line">    light.<span class="property">specular</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// groundColor: Color3 - 地面颜色（半球光特有）</span></span><br><span class="line">    light.<span class="property">groundColor</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.2</span>, <span class="number">0.2</span>, <span class="number">0.3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 影响范围</span></span><br><span class="line">    light.<span class="property">range</span> = <span class="title class_">Number</span>.<span class="property">MAX_VALUE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 包含/排除网格</span></span><br><span class="line">    light.<span class="property">includedOnlyMeshes</span> = [] <span class="comment">// 只影响指定网格</span></span><br><span class="line">    light.<span class="property">excludedMeshes</span> = [] <span class="comment">// 排除指定网格</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">set</span>(name, light)</span><br><span class="line">    <span class="keyword">return</span> light</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 方向光 (DirectionalLight) - 太阳光</span></span><br><span class="line">  <span class="title function_">createDirectionalLight</span>(<span class="params">name, direction, intensity = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> light = <span class="keyword">new</span> <span class="title class_">DirectionalLight</span>(name, direction, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    light.<span class="property">intensity</span> = intensity</span><br><span class="line">    light.<span class="property">diffuse</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">0.9</span>, <span class="number">0.7</span>) <span class="comment">// 暖白色</span></span><br><span class="line">    light.<span class="property">specular</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0.8</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 方向光特有属性</span></span><br><span class="line">    <span class="comment">// direction: Vector3 - 光照方向</span></span><br><span class="line">    light.<span class="property">direction</span> = direction.<span class="title function_">normalize</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阴影配置</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupShadowGenerator</span>(name, light, &#123;</span><br><span class="line">      <span class="attr">mapSize</span>: <span class="number">2048</span>,</span><br><span class="line">      <span class="attr">useExponentialShadowMap</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">useBlurExponentialShadowMap</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">blurScale</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">blurBoxOffset</span>: <span class="number">1</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">set</span>(name, light)</span><br><span class="line">    <span class="keyword">return</span> light</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 点光源 (PointLight)</span></span><br><span class="line">  <span class="title function_">createPointLight</span>(<span class="params">name, position, intensity = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> light = <span class="keyword">new</span> <span class="title class_">PointLight</span>(name, position, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    light.<span class="property">intensity</span> = intensity</span><br><span class="line">    light.<span class="property">diffuse</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">0.8</span>, <span class="number">0.4</span>) <span class="comment">// 温暖的橙色</span></span><br><span class="line">    light.<span class="property">specular</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 点光源特有属性</span></span><br><span class="line">    <span class="comment">// range: number - 光照范围</span></span><br><span class="line">    light.<span class="property">range</span> = <span class="number">50</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 衰减函数: intensity / (1 + linear * d + quadratic * d^2)</span></span><br><span class="line">    <span class="comment">// 其中 d 是距离</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 线性衰减</span></span><br><span class="line">    light.<span class="property">diffuseLinearAttenuation</span> = <span class="number">0.1</span></span><br><span class="line">    light.<span class="property">specularLinearAttenuation</span> = <span class="number">0.1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 二次衰减</span></span><br><span class="line">    light.<span class="property">diffuseQuadraticAttenuation</span> = <span class="number">0.01</span></span><br><span class="line">    light.<span class="property">specularQuadraticAttenuation</span> = <span class="number">0.01</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阴影配置（可选）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupShadowGenerator</span>(name, light, &#123;</span><br><span class="line">      <span class="attr">mapSize</span>: <span class="number">1024</span>,</span><br><span class="line">      <span class="attr">useExponentialShadowMap</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">set</span>(name, light)</span><br><span class="line">    <span class="keyword">return</span> light</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 聚光灯 (SpotLight)</span></span><br><span class="line">  <span class="title function_">createSpotLight</span>(<span class="params">name, position, direction, intensity = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="comment">// angle: 聚光灯锥角（弧度）</span></span><br><span class="line">    <span class="comment">// exponent: 边缘衰减指数</span></span><br><span class="line">    <span class="keyword">const</span> light = <span class="keyword">new</span> <span class="title class_">SpotLight</span>(name, position, direction, <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">3</span>, <span class="number">2</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    light.<span class="property">intensity</span> = intensity</span><br><span class="line">    light.<span class="property">diffuse</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0.9</span>)</span><br><span class="line">    light.<span class="property">specular</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 聚光灯特有属性</span></span><br><span class="line">    <span class="comment">// angle: number - 锥角（弧度）</span></span><br><span class="line">    light.<span class="property">angle</span> = <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">3</span> <span class="comment">// 60度</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// exponent: number - 边缘衰减</span></span><br><span class="line">    light.<span class="property">exponent</span> = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 方向</span></span><br><span class="line">    light.<span class="property">direction</span> = direction.<span class="title function_">normalize</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内角和外角（用于平滑过渡）</span></span><br><span class="line">    light.<span class="property">innerAngle</span> = <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">6</span> <span class="comment">// 30度</span></span><br><span class="line">    light.<span class="property">outerAngle</span> = <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">3</span> <span class="comment">// 60度</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 距离衰减</span></span><br><span class="line">    light.<span class="property">range</span> = <span class="number">100</span></span><br><span class="line">    light.<span class="property">diffuseLinearAttenuation</span> = <span class="number">0.05</span></span><br><span class="line">    light.<span class="property">diffuseQuadraticAttenuation</span> = <span class="number">0.005</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阴影配置</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupShadowGenerator</span>(name, light, &#123;</span><br><span class="line">      <span class="attr">mapSize</span>: <span class="number">1024</span>,</span><br><span class="line">      <span class="attr">useExponentialShadowMap</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">useCloseExponentialShadowMap</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">set</span>(name, light)</span><br><span class="line">    <span class="keyword">return</span> light</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 阴影生成器配置</span></span><br><span class="line">  <span class="title function_">setupShadowGenerator</span>(<span class="params">lightName, light, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!light.<span class="property">canGenerateShadows</span>) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="attr">mapSize</span>: <span class="number">1024</span>,</span><br><span class="line">      <span class="attr">useExponentialShadowMap</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">useBlurExponentialShadowMap</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">useCloseExponentialShadowMap</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">usePoissonSampling</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">usePercentageCloserFiltering</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">filteringQuality</span>: <span class="title class_">ShadowGenerator</span>.<span class="property">QUALITY_HIGH</span>,</span><br><span class="line">      <span class="attr">blurScale</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">blurBoxOffset</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">bias</span>: <span class="number">0.00005</span>,</span><br><span class="line">      <span class="attr">normalBias</span>: <span class="number">0.0</span>,</span><br><span class="line">      <span class="attr">darkness</span>: <span class="number">0.0</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> config = <span class="title class_">Object</span>.<span class="title function_">assign</span>(defaultOptions, options)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建阴影生成器</span></span><br><span class="line">    <span class="keyword">const</span> shadowGenerator = <span class="keyword">new</span> <span class="title class_">ShadowGenerator</span>(config.<span class="property">mapSize</span>, light)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阴影映射类型</span></span><br><span class="line">    <span class="keyword">if</span> (config.<span class="property">useExponentialShadowMap</span>) &#123;</span><br><span class="line">      shadowGenerator.<span class="property">useExponentialShadowMap</span> = <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config.<span class="property">useBlurExponentialShadowMap</span>) &#123;</span><br><span class="line">      shadowGenerator.<span class="property">useBlurExponentialShadowMap</span> = <span class="literal">true</span></span><br><span class="line">      shadowGenerator.<span class="property">blurScale</span> = config.<span class="property">blurScale</span></span><br><span class="line">      shadowGenerator.<span class="property">blurBoxOffset</span> = config.<span class="property">blurBoxOffset</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config.<span class="property">useCloseExponentialShadowMap</span>) &#123;</span><br><span class="line">      shadowGenerator.<span class="property">useCloseExponentialShadowMap</span> = <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config.<span class="property">usePoissonSampling</span>) &#123;</span><br><span class="line">      shadowGenerator.<span class="property">usePoissonSampling</span> = <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config.<span class="property">usePercentageCloserFiltering</span>) &#123;</span><br><span class="line">      shadowGenerator.<span class="property">usePercentageCloserFiltering</span> = <span class="literal">true</span></span><br><span class="line">      shadowGenerator.<span class="property">filteringQuality</span> = config.<span class="property">filteringQuality</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阴影参数</span></span><br><span class="line">    shadowGenerator.<span class="property">bias</span> = config.<span class="property">bias</span></span><br><span class="line">    shadowGenerator.<span class="property">normalBias</span> = config.<span class="property">normalBias</span></span><br><span class="line">    shadowGenerator.<span class="property">darkness</span> = config.<span class="property">darkness</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 透明度阈值</span></span><br><span class="line">    shadowGenerator.<span class="property">transparencyShadow</span> = <span class="literal">true</span></span><br><span class="line">    shadowGenerator.<span class="property">forceBackFacesOnly</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 级联阴影（方向光）</span></span><br><span class="line">    <span class="keyword">if</span> (light <span class="keyword">instanceof</span> <span class="title class_">DirectionalLight</span>) &#123;</span><br><span class="line">      shadowGenerator.<span class="property">autoCalcDepthBounds</span> = <span class="literal">true</span></span><br><span class="line">      shadowGenerator.<span class="property">stabilizeCascades</span> = <span class="literal">true</span></span><br><span class="line">      shadowGenerator.<span class="property">lambda</span> = <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 多级联配置</span></span><br><span class="line">      <span class="keyword">if</span> (config.<span class="property">cascadeCount</span> &amp;&amp; config.<span class="property">cascadeCount</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        shadowGenerator.<span class="property">numCascades</span> = config.<span class="property">cascadeCount</span></span><br><span class="line">        shadowGenerator.<span class="property">cascadeBlendPercentage</span> = <span class="number">0.1</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadowGenerators</span>.<span class="title function_">set</span>(lightName, shadowGenerator)</span><br><span class="line">    <span class="keyword">return</span> shadowGenerator</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加投射阴影的网格</span></span><br><span class="line">  <span class="title function_">addShadowCaster</span>(<span class="params">lightName, mesh</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> shadowGenerator = <span class="variable language_">this</span>.<span class="property">shadowGenerators</span>.<span class="title function_">get</span>(lightName)</span><br><span class="line">    <span class="keyword">if</span> (shadowGenerator) &#123;</span><br><span class="line">      shadowGenerator.<span class="title function_">addShadowCaster</span>(mesh)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 批量添加阴影投射者</span></span><br><span class="line">  <span class="title function_">addShadowCasters</span>(<span class="params">lightName, meshes</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> shadowGenerator = <span class="variable language_">this</span>.<span class="property">shadowGenerators</span>.<span class="title function_">get</span>(lightName)</span><br><span class="line">    <span class="keyword">if</span> (shadowGenerator) &#123;</span><br><span class="line">      meshes.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">        shadowGenerator.<span class="title function_">addShadowCaster</span>(mesh)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置网格接收阴影</span></span><br><span class="line">  <span class="title function_">enableShadowReceiver</span>(<span class="params">mesh</span>) &#123;</span><br><span class="line">    mesh.<span class="property">receiveShadows</span> = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 光照动画</span></span><br><span class="line">  <span class="title function_">animateLight</span>(<span class="params">lightName, property, targetValue, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> light = <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">get</span>(lightName)</span><br><span class="line">    <span class="keyword">if</span> (!light) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> animation = <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;lightName&#125;</span>_<span class="subst">$&#123;property&#125;</span>`</span>,</span><br><span class="line">      light,</span><br><span class="line">      property,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">      light[property],</span><br><span class="line">      targetValue,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 光照闪烁效果</span></span><br><span class="line">  <span class="title function_">addFlickerEffect</span>(<span class="params">lightName, intensity = <span class="number">0.2</span>, speed = <span class="number">5</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> light = <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">get</span>(lightName)</span><br><span class="line">    <span class="keyword">if</span> (!light) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> baseIntensity = light.<span class="property">intensity</span></span><br><span class="line">    <span class="keyword">let</span> time = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> flickerObserver = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      time += <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>().<span class="title function_">getDeltaTime</span>() * <span class="number">0.001</span> * speed</span><br><span class="line">      <span class="keyword">const</span> flicker = <span class="title class_">Math</span>.<span class="title function_">sin</span>(time * <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>) * intensity + <span class="title class_">Math</span>.<span class="title function_">random</span>() * intensity * <span class="number">0.5</span></span><br><span class="line">      light.<span class="property">intensity</span> = baseIntensity + flicker</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">dispose</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">remove</span>(flickerObserver)</span><br><span class="line">        light.<span class="property">intensity</span> = baseIntensity</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 昼夜循环</span></span><br><span class="line">  <span class="title function_">setupDayNightCycle</span>(<span class="params">duration = <span class="number">120000</span></span>) &#123;</span><br><span class="line">    <span class="comment">// 2分钟一个周期</span></span><br><span class="line">    <span class="keyword">const</span> sunLight = <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">get</span>(<span class="string">&#x27;sunLight&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> ambientLight = <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">get</span>(<span class="string">&#x27;ambientLight&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!sunLight || !ambientLight) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> time = <span class="number">0</span></span><br><span class="line">    <span class="keyword">const</span> cycleSpeed = (<span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>) / duration <span class="comment">// 弧度/毫秒</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> cycleObserver = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      time += <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>().<span class="title function_">getDeltaTime</span>() * cycleSpeed</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 太阳高度角 (-90° 到 +90°)</span></span><br><span class="line">      <span class="keyword">const</span> sunElevation = (<span class="title class_">Math</span>.<span class="title function_">sin</span>(time) * <span class="title class_">Math</span>.<span class="property">PI</span>) / <span class="number">2</span></span><br><span class="line">      <span class="keyword">const</span> sunAzimuth = time</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 计算太阳方向</span></span><br><span class="line">      <span class="keyword">const</span> sunDirection = <span class="keyword">new</span> <span class="title class_">Vector3</span>(</span><br><span class="line">        <span class="title class_">Math</span>.<span class="title function_">cos</span>(sunElevation) * <span class="title class_">Math</span>.<span class="title function_">sin</span>(sunAzimuth),</span><br><span class="line">        <span class="title class_">Math</span>.<span class="title function_">sin</span>(sunElevation),</span><br><span class="line">        <span class="title class_">Math</span>.<span class="title function_">cos</span>(sunElevation) * <span class="title class_">Math</span>.<span class="title function_">cos</span>(sunAzimuth),</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      sunLight.<span class="property">direction</span> = sunDirection.<span class="title function_">negate</span>()</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 根据太阳高度调整光照强度和颜色</span></span><br><span class="line">      <span class="keyword">const</span> dayFactor = <span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="number">0</span>, <span class="title class_">Math</span>.<span class="title function_">sin</span>(time)) <span class="comment">// 0-1，白天为1，夜晚为0</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 太阳光强度</span></span><br><span class="line">      sunLight.<span class="property">intensity</span> = dayFactor * <span class="number">2.0</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 太阳光颜色（日出日落时偏红）</span></span><br><span class="line">      <span class="keyword">const</span> sunColor = <span class="variable language_">this</span>.<span class="title function_">calculateSunColor</span>(sunElevation)</span><br><span class="line">      sunLight.<span class="property">diffuse</span> = sunColor</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 环境光强度</span></span><br><span class="line">      ambientLight.<span class="property">intensity</span> = <span class="number">0.1</span> + dayFactor * <span class="number">0.4</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 环境光颜色</span></span><br><span class="line">      <span class="keyword">const</span> ambientColor = <span class="variable language_">this</span>.<span class="title function_">calculateAmbientColor</span>(dayFactor)</span><br><span class="line">      ambientLight.<span class="property">diffuse</span> = ambientColor</span><br><span class="line">      ambientLight.<span class="property">groundColor</span> = ambientColor.<span class="title function_">scale</span>(<span class="number">0.5</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">dispose</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">remove</span>(cycleObserver)</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">calculateSunColor</span>(<span class="params">elevation</span>) &#123;</span><br><span class="line">    <span class="comment">// 根据太阳高度角计算颜色</span></span><br><span class="line">    <span class="keyword">const</span> factor = <span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="number">0</span>, <span class="title class_">Math</span>.<span class="title function_">sin</span>(elevation))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (factor &gt; <span class="number">0.8</span>) &#123;</span><br><span class="line">      <span class="comment">// 正午 - 白色</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Color3</span>.<span class="title class_">White</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (factor &gt; <span class="number">0.3</span>) &#123;</span><br><span class="line">      <span class="comment">// 白天 - 暖白色</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Color3</span>.<span class="title class_">Lerp</span>(<span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">0.9</span>, <span class="number">0.7</span>), <span class="title class_">Color3</span>.<span class="title class_">White</span>(), (factor - <span class="number">0.3</span>) / <span class="number">0.5</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (factor &gt; <span class="number">0.1</span>) &#123;</span><br><span class="line">      <span class="comment">// 日出日落 - 橙红色</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Color3</span>.<span class="title class_">Lerp</span>(<span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">0.3</span>, <span class="number">0.1</span>), <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">0.9</span>, <span class="number">0.7</span>), (factor - <span class="number">0.1</span>) / <span class="number">0.2</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 夜晚 - 深蓝色</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.1</span>, <span class="number">0.1</span>, <span class="number">0.3</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">calculateAmbientColor</span>(<span class="params">dayFactor</span>) &#123;</span><br><span class="line">    <span class="comment">// 白天：浅蓝色天空光</span></span><br><span class="line">    <span class="keyword">const</span> dayColor = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.5</span>, <span class="number">0.7</span>, <span class="number">1.0</span>)</span><br><span class="line">    <span class="comment">// 夜晚：深蓝紫色</span></span><br><span class="line">    <span class="keyword">const</span> nightColor = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.1</span>, <span class="number">0.1</span>, <span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Color3</span>.<span class="title class_">Lerp</span>(nightColor, dayColor, dayFactor)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 体积光效果 (Volumetric Light)</span></span><br><span class="line">  <span class="title function_">setupVolumetricLight</span>(<span class="params">lightName, density = <span class="number">0.1</span>, decay = <span class="number">0.95</span>, weight = <span class="number">0.5</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> light = <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">get</span>(lightName)</span><br><span class="line">    <span class="keyword">if</span> (!light || !(light <span class="keyword">instanceof</span> <span class="title class_">SpotLight</span> || light <span class="keyword">instanceof</span> <span class="title class_">DirectionalLight</span>)) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;体积光只支持聚光灯和方向光&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建体积光后处理</span></span><br><span class="line">    <span class="keyword">const</span> volumetricLightPostProcess = <span class="keyword">new</span> <span class="title class_">VolumetricLightScatteringPostProcess</span>(</span><br><span class="line">      <span class="string">&#x27;volumetricLight&#x27;</span>,</span><br><span class="line">      <span class="number">1.0</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">activeCamera</span>,</span><br><span class="line">      <span class="literal">undefined</span>, <span class="comment">// 使用光源自身</span></span><br><span class="line">      <span class="number">100</span>,</span><br><span class="line">      <span class="title class_">Texture</span>.<span class="property">BILINEAR_SAMPLINGMODE</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>(),</span><br><span class="line">      <span class="literal">false</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置参数</span></span><br><span class="line">    volumetricLightPostProcess.<span class="property">density</span> = density</span><br><span class="line">    volumetricLightPostProcess.<span class="property">decay</span> = decay</span><br><span class="line">    volumetricLightPostProcess.<span class="property">weight</span> = weight</span><br><span class="line">    volumetricLightPostProcess.<span class="property">samples</span> = <span class="number">50</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> volumetricLightPostProcess</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// IES光度文件支持（真实光源分布）</span></span><br><span class="line">  <span class="title function_">loadIESProfile</span>(<span class="params">lightName, iesUrl</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> light = <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">get</span>(lightName)</span><br><span class="line">    <span class="keyword">if</span> (!light || !(light <span class="keyword">instanceof</span> <span class="title class_">SpotLight</span>)) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;IES光度文件只支持聚光灯&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载IES文件并创建纹理</span></span><br><span class="line">    <span class="keyword">const</span> iesTexture = <span class="keyword">new</span> <span class="title class_">Texture</span>(iesUrl, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    iesTexture.<span class="property">wrapU</span> = <span class="title class_">Texture</span>.<span class="property">CLAMP_ADDRESSMODE</span></span><br><span class="line">    iesTexture.<span class="property">wrapV</span> = <span class="title class_">Texture</span>.<span class="property">CLAMP_ADDRESSMODE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 应用到光源</span></span><br><span class="line">    light.<span class="property">projectionTexture</span> = iesTexture</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> iesTexture</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 光源调试工具</span></span><br><span class="line">  <span class="title function_">enableLightGizmos</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">light, name</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> lightGizmo = <span class="keyword">new</span> <span class="title class_">LightGizmo</span>()</span><br><span class="line">      lightGizmo.<span class="property">light</span> = light</span><br><span class="line">      lightGizmo.<span class="property">material</span>.<span class="property">emissiveColor</span> = light.<span class="property">diffuse</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 显示光源方向</span></span><br><span class="line">      <span class="keyword">if</span> (light <span class="keyword">instanceof</span> <span class="title class_">DirectionalLight</span> || light <span class="keyword">instanceof</span> <span class="title class_">SpotLight</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> helper = <span class="variable language_">this</span>.<span class="title function_">createLightHelper</span>(light)</span><br><span class="line">        helper.<span class="property">name</span> = <span class="string">`<span class="subst">$&#123;name&#125;</span>_helper`</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createLightHelper</span>(<span class="params">light</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (light <span class="keyword">instanceof</span> <span class="title class_">DirectionalLight</span>) &#123;</span><br><span class="line">      <span class="comment">// 方向光帮助器</span></span><br><span class="line">      <span class="keyword">const</span> helper = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateLines</span>(</span><br><span class="line">        <span class="string">&#x27;lightHelper&#x27;</span>,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">points</span>: [<span class="title class_">Vector3</span>.<span class="title class_">Zero</span>(), light.<span class="property">direction</span>.<span class="title function_">scale</span>(<span class="number">10</span>)],</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">      )</span><br><span class="line">      helper.<span class="property">color</span> = light.<span class="property">diffuse</span></span><br><span class="line">      <span class="keyword">return</span> helper</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (light <span class="keyword">instanceof</span> <span class="title class_">SpotLight</span>) &#123;</span><br><span class="line">      <span class="comment">// 聚光灯锥形帮助器</span></span><br><span class="line">      <span class="keyword">const</span> angle = light.<span class="property">angle</span></span><br><span class="line">      <span class="keyword">const</span> range = light.<span class="property">range</span> || <span class="number">20</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> helper = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateCylinder</span>(</span><br><span class="line">        <span class="string">&#x27;lightHelper&#x27;</span>,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">diameterTop</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="attr">diameterBottom</span>: <span class="title class_">Math</span>.<span class="title function_">tan</span>(angle / <span class="number">2</span>) * range * <span class="number">2</span>,</span><br><span class="line">          <span class="attr">height</span>: range,</span><br><span class="line">          <span class="attr">tessellation</span>: <span class="number">8</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      helper.<span class="property">position</span> = light.<span class="property">position</span>.<span class="title function_">clone</span>()</span><br><span class="line">      helper.<span class="title function_">lookAt</span>(light.<span class="property">position</span>.<span class="title function_">add</span>(light.<span class="property">direction</span>))</span><br><span class="line">      helper.<span class="property">material</span> = <span class="keyword">new</span> <span class="title class_">StandardMaterial</span>(<span class="string">&#x27;lightHelperMat&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">      helper.<span class="property">material</span>.<span class="property">wireframe</span> = <span class="literal">true</span></span><br><span class="line">      helper.<span class="property">material</span>.<span class="property">emissiveColor</span> = light.<span class="property">diffuse</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> helper</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取光照信息</span></span><br><span class="line">  <span class="title function_">getLightInfo</span>(<span class="params">lightName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> light = <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">get</span>(lightName)</span><br><span class="line">    <span class="keyword">if</span> (!light) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> info = &#123;</span><br><span class="line">      <span class="attr">name</span>: lightName,</span><br><span class="line">      <span class="attr">type</span>: light.<span class="title function_">getClassName</span>(),</span><br><span class="line">      <span class="attr">intensity</span>: light.<span class="property">intensity</span>,</span><br><span class="line">      <span class="attr">diffuse</span>: light.<span class="property">diffuse</span>,</span><br><span class="line">      <span class="attr">specular</span>: light.<span class="property">specular</span>,</span><br><span class="line">      <span class="attr">range</span>: light.<span class="property">range</span>,</span><br><span class="line">      <span class="attr">enabled</span>: light.<span class="title function_">isEnabled</span>(),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (light <span class="keyword">instanceof</span> <span class="title class_">DirectionalLight</span>) &#123;</span><br><span class="line">      info.<span class="property">direction</span> = light.<span class="property">direction</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (light <span class="keyword">instanceof</span> <span class="title class_">PointLight</span>) &#123;</span><br><span class="line">      info.<span class="property">position</span> = light.<span class="property">position</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (light <span class="keyword">instanceof</span> <span class="title class_">SpotLight</span>) &#123;</span><br><span class="line">      info.<span class="property">position</span> = light.<span class="property">position</span></span><br><span class="line">      info.<span class="property">direction</span> = light.<span class="property">direction</span></span><br><span class="line">      info.<span class="property">angle</span> = light.<span class="property">angle</span></span><br><span class="line">      info.<span class="property">exponent</span> = light.<span class="property">exponent</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (light <span class="keyword">instanceof</span> <span class="title class_">HemisphericLight</span>) &#123;</span><br><span class="line">      info.<span class="property">direction</span> = light.<span class="property">direction</span></span><br><span class="line">      info.<span class="property">groundColor</span> = light.<span class="property">groundColor</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 保存光照设置</span></span><br><span class="line">  <span class="title function_">saveLightingSetup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> setup = &#123;</span><br><span class="line">      <span class="attr">lights</span>: [],</span><br><span class="line">      <span class="attr">shadows</span>: [],</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">light, name</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">lights</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: name,</span><br><span class="line">        ...<span class="variable language_">this</span>.<span class="title function_">getLightInfo</span>(name),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadowGenerators</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">generator, lightName</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">shadows</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">lightName</span>: lightName,</span><br><span class="line">        <span class="attr">mapSize</span>: generator.<span class="property">mapSize</span>,</span><br><span class="line">        <span class="attr">bias</span>: generator.<span class="property">bias</span>,</span><br><span class="line">        <span class="attr">darkness</span>: generator.<span class="property">darkness</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> setup</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 资源清理</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadowGenerators</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">generator</span>) =&gt;</span> &#123;</span><br><span class="line">      generator.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadowGenerators</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">light</span>) =&gt;</span> &#123;</span><br><span class="line">      light.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> lightManager = <span class="keyword">new</span> <span class="title class_">LightManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建自定义光源</span></span><br><span class="line"><span class="keyword">const</span> fireLight = lightManager.<span class="title function_">createPointLight</span>(<span class="string">&#x27;fireLight&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>), <span class="number">2.0</span>)</span><br><span class="line">fireLight.<span class="property">diffuse</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">0.5</span>, <span class="number">0.1</span>) <span class="comment">// 橙色火光</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加闪烁效果</span></span><br><span class="line"><span class="keyword">const</span> flicker = lightManager.<span class="title function_">addFlickerEffect</span>(<span class="string">&#x27;fireLight&#x27;</span>, <span class="number">0.3</span>, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置昼夜循环</span></span><br><span class="line"><span class="keyword">const</span> dayNight = lightManager.<span class="title function_">setupDayNightCycle</span>(<span class="number">60000</span>) <span class="comment">// 1分钟周期</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加阴影投射者</span></span><br><span class="line">lightManager.<span class="title function_">addShadowCasters</span>(<span class="string">&#x27;sunLight&#x27;</span>, scene.<span class="property">meshes</span>)</span><br></pre></td></tr></table></figure><h2 id="🎨-Material-材质系统详解"><a href="#🎨-Material-材质系统详解" class="headerlink" title="🎨 Material 材质系统详解"></a>🎨 Material 材质系统详解</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Material 材质系统完整管理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MaterialManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">textures</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">nodeMaterials</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupDefaultMaterials</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupDefaultMaterials</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 标准材质</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createStandardMaterial</span>(<span class="string">&#x27;defaultStandard&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// PBR材质</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createPBRMaterial</span>(<span class="string">&#x27;defaultPBR&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 无光材质</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createUnlitMaterial</span>(<span class="string">&#x27;defaultUnlit&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 标准材质 (StandardMaterial)</span></span><br><span class="line">  <span class="title function_">createStandardMaterial</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">StandardMaterial</span>(name, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 基础颜色属性</span></span><br><span class="line">    <span class="comment">// diffuseColor: Color3 - 漫反射颜色</span></span><br><span class="line">    material.<span class="property">diffuseColor</span> = options.<span class="property">diffuseColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// specularColor: Color3 - 镜面反射颜色</span></span><br><span class="line">    material.<span class="property">specularColor</span> = options.<span class="property">specularColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// emissiveColor: Color3 - 自发光颜色</span></span><br><span class="line">    material.<span class="property">emissiveColor</span> = options.<span class="property">emissiveColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ambientColor: Color3 - 环境光颜色</span></span><br><span class="line">    material.<span class="property">ambientColor</span> = options.<span class="property">ambientColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 纹理属性</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">diffuseTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">diffuseTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">diffuseTexture</span>, name + <span class="string">&#x27;_diffuse&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">specularTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">specularTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">specularTexture</span>, name + <span class="string">&#x27;_specular&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">normalTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">bumpTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">normalTexture</span>, name + <span class="string">&#x27;_normal&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">emissiveTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">emissiveTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">emissiveTexture</span>, name + <span class="string">&#x27;_emissive&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">ambientTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">ambientTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">ambientTexture</span>, name + <span class="string">&#x27;_ambient&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 光照属性</span></span><br><span class="line">    <span class="comment">// specularPower: number - 镜面反射强度 (1-128)</span></span><br><span class="line">    material.<span class="property">specularPower</span> = options.<span class="property">specularPower</span> || <span class="number">64</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 透明度设置</span></span><br><span class="line">    <span class="comment">// alpha: number - 透明度 (0-1)</span></span><br><span class="line">    material.<span class="property">alpha</span> = options.<span class="property">alpha</span> !== <span class="literal">undefined</span> ? options.<span class="property">alpha</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 背面剔除</span></span><br><span class="line">    <span class="comment">// backFaceCulling: boolean - 是否剔除背面</span></span><br><span class="line">    material.<span class="property">backFaceCulling</span> =</span><br><span class="line">      options.<span class="property">backFaceCulling</span> !== <span class="literal">undefined</span> ? options.<span class="property">backFaceCulling</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 双面材质</span></span><br><span class="line">    <span class="comment">// twoSidedLighting: boolean - 双面光照</span></span><br><span class="line">    material.<span class="property">twoSidedLighting</span> = options.<span class="property">twoSidedLighting</span> || <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 线框模式</span></span><br><span class="line">    <span class="comment">// wireframe: boolean - 线框显示</span></span><br><span class="line">    material.<span class="property">wireframe</span> = options.<span class="property">wireframe</span> || <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 点模式</span></span><br><span class="line">    <span class="comment">// pointsCloud: boolean - 点云显示</span></span><br><span class="line">    material.<span class="property">pointsCloud</span> = options.<span class="property">pointsCloud</span> || <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// UV变换</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">uOffset</span> || options.<span class="property">vOffset</span> || options.<span class="property">uScale</span> || options.<span class="property">vScale</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setupUVTransform</span>(material.<span class="property">diffuseTexture</span>, options)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">set</span>(name, material)</span><br><span class="line">    <span class="keyword">return</span> material</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// PBR材质 (PBRMaterial) - 基于物理的渲染</span></span><br><span class="line">  <span class="title function_">createPBRMaterial</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">PBRMaterial</span>(name, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 基础颜色</span></span><br><span class="line">    <span class="comment">// baseColor: Color3 - 基础颜色</span></span><br><span class="line">    material.<span class="property">baseColor</span> = options.<span class="property">baseColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// baseTexture: Texture - 基础颜色纹理</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">baseTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">baseTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">baseTexture</span>, name + <span class="string">&#x27;_base&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 金属度和粗糙度</span></span><br><span class="line">    <span class="comment">// metallicFactor: number - 金属度 (0-1)</span></span><br><span class="line">    material.<span class="property">metallicFactor</span> = options.<span class="property">metallicFactor</span> !== <span class="literal">undefined</span> ? options.<span class="property">metallicFactor</span> : <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// roughnessFactor: number - 粗糙度 (0-1)</span></span><br><span class="line">    material.<span class="property">roughnessFactor</span> = options.<span class="property">roughnessFactor</span> !== <span class="literal">undefined</span> ? options.<span class="property">roughnessFactor</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// metallicRoughnessTexture: Texture - 金属度粗糙度纹理 (R通道-未使用, G通道-粗糙度, B通道-金属度)</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">metallicRoughnessTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">metallicRoughnessTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(</span><br><span class="line">        options.<span class="property">metallicRoughnessTexture</span>,</span><br><span class="line">        name + <span class="string">&#x27;_metallic_roughness&#x27;</span>,</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 法线贴图</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">normalTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">normalTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">normalTexture</span>, name + <span class="string">&#x27;_normal&#x27;</span>)</span><br><span class="line">      material.<span class="property">normalTextureScale</span> = options.<span class="property">normalScale</span> || <span class="number">1.0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 环境遮蔽</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">occlusionTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">ambientTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">occlusionTexture</span>, name + <span class="string">&#x27;_occlusion&#x27;</span>)</span><br><span class="line">      material.<span class="property">ambientTextureStrength</span> = options.<span class="property">occlusionStrength</span> || <span class="number">1.0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自发光</span></span><br><span class="line">    <span class="comment">// emissiveColor: Color3 - 自发光颜色</span></span><br><span class="line">    material.<span class="property">emissiveColor</span> = options.<span class="property">emissiveColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">emissiveTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">emissiveTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">emissiveTexture</span>, name + <span class="string">&#x27;_emissive&#x27;</span>)</span><br><span class="line">      material.<span class="property">emissiveIntensity</span> = options.<span class="property">emissiveIntensity</span> || <span class="number">1.0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 透明度</span></span><br><span class="line">    material.<span class="property">alpha</span> = options.<span class="property">alpha</span> !== <span class="literal">undefined</span> ? options.<span class="property">alpha</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 透明度模式</span></span><br><span class="line">    <span class="comment">// alphaMode: number - 透明度模式</span></span><br><span class="line">    <span class="comment">// ALPHA_DISABLE: 不透明</span></span><br><span class="line">    <span class="comment">// ALPHA_BLEND: 透明混合</span></span><br><span class="line">    <span class="comment">// ALPHA_MASK: 透明裁剪</span></span><br><span class="line">    material.<span class="property">transparencyMode</span> = options.<span class="property">transparencyMode</span> || <span class="title class_">PBRMaterial</span>.<span class="property">PBRMATERIAL_OPAQUE</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (material.<span class="property">transparencyMode</span> === <span class="title class_">PBRMaterial</span>.<span class="property">PBRMATERIAL_ALPHATEST</span>) &#123;</span><br><span class="line">      material.<span class="property">alphaCutOff</span> = options.<span class="property">alphaCutOff</span> || <span class="number">0.5</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 折射率</span></span><br><span class="line">    <span class="comment">// indexOfRefraction: number - 折射率</span></span><br><span class="line">    material.<span class="property">indexOfRefraction</span> = options.<span class="property">indexOfRefraction</span> || <span class="number">1.5</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清漆层 (Clear Coat)</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">clearCoat</span>) &#123;</span><br><span class="line">      material.<span class="property">clearCoat</span>.<span class="property">isEnabled</span> = <span class="literal">true</span></span><br><span class="line">      material.<span class="property">clearCoat</span>.<span class="property">intensity</span> = options.<span class="property">clearCoat</span>.<span class="property">intensity</span> || <span class="number">1.0</span></span><br><span class="line">      material.<span class="property">clearCoat</span>.<span class="property">roughness</span> = options.<span class="property">clearCoat</span>.<span class="property">roughness</span> || <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">clearCoat</span>.<span class="property">texture</span>) &#123;</span><br><span class="line">        material.<span class="property">clearCoat</span>.<span class="property">texture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(</span><br><span class="line">          options.<span class="property">clearCoat</span>.<span class="property">texture</span>,</span><br><span class="line">          name + <span class="string">&#x27;_clearcoat&#x27;</span>,</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">clearCoat</span>.<span class="property">normalTexture</span>) &#123;</span><br><span class="line">        material.<span class="property">clearCoat</span>.<span class="property">bumpTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(</span><br><span class="line">          options.<span class="property">clearCoat</span>.<span class="property">normalTexture</span>,</span><br><span class="line">          name + <span class="string">&#x27;_clearcoat_normal&#x27;</span>,</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 次表面散射 (Subsurface)</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">subsurface</span>) &#123;</span><br><span class="line">      material.<span class="property">subSurface</span>.<span class="property">isScatteringEnabled</span> = <span class="literal">true</span></span><br><span class="line">      material.<span class="property">subSurface</span>.<span class="property">scatteringColor</span> = options.<span class="property">subsurface</span>.<span class="property">color</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">      material.<span class="property">subSurface</span>.<span class="property">scatteringDistance</span> = options.<span class="property">subsurface</span>.<span class="property">distance</span> || <span class="number">1.0</span></span><br><span class="line">      material.<span class="property">subSurface</span>.<span class="property">scatteringIntensity</span> = options.<span class="property">subsurface</span>.<span class="property">intensity</span> || <span class="number">1.0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 光泽 (Sheen)</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">sheen</span>) &#123;</span><br><span class="line">      material.<span class="property">sheen</span>.<span class="property">isEnabled</span> = <span class="literal">true</span></span><br><span class="line">      material.<span class="property">sheen</span>.<span class="property">color</span> = options.<span class="property">sheen</span>.<span class="property">color</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">      material.<span class="property">sheen</span>.<span class="property">intensity</span> = options.<span class="property">sheen</span>.<span class="property">intensity</span> || <span class="number">1.0</span></span><br><span class="line">      material.<span class="property">sheen</span>.<span class="property">roughness</span> = options.<span class="property">sheen</span>.<span class="property">roughness</span> || <span class="number">0.0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 各向异性 (Anisotropy)</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">anisotropy</span>) &#123;</span><br><span class="line">      material.<span class="property">anisotropy</span>.<span class="property">isEnabled</span> = <span class="literal">true</span></span><br><span class="line">      material.<span class="property">anisotropy</span>.<span class="property">intensity</span> = options.<span class="property">anisotropy</span>.<span class="property">intensity</span> || <span class="number">1.0</span></span><br><span class="line">      material.<span class="property">anisotropy</span>.<span class="property">direction</span> = options.<span class="property">anisotropy</span>.<span class="property">direction</span> || <span class="keyword">new</span> <span class="title class_">Vector2</span>(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">set</span>(name, material)</span><br><span class="line">    <span class="keyword">return</span> material</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 无光材质 (UnlitMaterial) - 不受光照影响</span></span><br><span class="line">  <span class="title function_">createUnlitMaterial</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">UnlitMaterial</span>(name, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 基础颜色</span></span><br><span class="line">    material.<span class="property">diffuseColor</span> = options.<span class="property">diffuseColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 纹理</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">diffuseTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">diffuseTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">diffuseTexture</span>, name + <span class="string">&#x27;_diffuse&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 透明度</span></span><br><span class="line">    material.<span class="property">alpha</span> = options.<span class="property">alpha</span> !== <span class="literal">undefined</span> ? options.<span class="property">alpha</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 背面剔除</span></span><br><span class="line">    material.<span class="property">backFaceCulling</span> =</span><br><span class="line">      options.<span class="property">backFaceCulling</span> !== <span class="literal">undefined</span> ? options.<span class="property">backFaceCulling</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">set</span>(name, material)</span><br><span class="line">    <span class="keyword">return</span> material</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 节点材质 (NodeMaterial) - 可视化节点编辑器材质</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">createNodeMaterial</span>(<span class="params">name, nodeJsonUrl</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">NodeMaterial</span>(name, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从JSON加载节点材质</span></span><br><span class="line">    <span class="keyword">await</span> material.<span class="title function_">loadFromUrl</span>(nodeJsonUrl)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建材质</span></span><br><span class="line">    material.<span class="title function_">build</span>(<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">nodeMaterials</span>.<span class="title function_">set</span>(name, material)</span><br><span class="line">    <span class="keyword">return</span> material</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 自定义着色器材质 (ShaderMaterial)</span></span><br><span class="line">  <span class="title function_">createShaderMaterial</span>(<span class="params">name, vertexShader, fragmentShader, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> shaderMaterial = <span class="keyword">new</span> <span class="title class_">ShaderMaterial</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">vertex</span>: vertexShader,</span><br><span class="line">        <span class="attr">fragment</span>: fragmentShader,</span><br><span class="line">      &#125;,</span><br><span class="line">      options,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置uniforms</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">uniforms</span>) &#123;</span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">keys</span>(options.<span class="property">uniforms</span>).<span class="title function_">forEach</span>(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">        shaderMaterial.<span class="title function_">setFloat</span>(key, options.<span class="property">uniforms</span>[key])</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置纹理</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">textures</span>) &#123;</span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">keys</span>(options.<span class="property">textures</span>).<span class="title function_">forEach</span>(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> texture = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">textures</span>[key], <span class="string">`<span class="subst">$&#123;name&#125;</span>_<span class="subst">$&#123;key&#125;</span>`</span>)</span><br><span class="line">        shaderMaterial.<span class="title function_">setTexture</span>(key, texture)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">set</span>(name, shaderMaterial)</span><br><span class="line">    <span class="keyword">return</span> shaderMaterial</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 程序化材质</span></span><br><span class="line">  <span class="title function_">createProceduralMaterial</span>(<span class="params">name, type, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> material</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;wood&#x27;</span>:</span><br><span class="line">        material = <span class="variable language_">this</span>.<span class="title function_">createWoodMaterial</span>(name, options)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;marble&#x27;</span>:</span><br><span class="line">        material = <span class="variable language_">this</span>.<span class="title function_">createMarbleMaterial</span>(name, options)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;fire&#x27;</span>:</span><br><span class="line">        material = <span class="variable language_">this</span>.<span class="title function_">createFireMaterial</span>(name, options)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;water&#x27;</span>:</span><br><span class="line">        material = <span class="variable language_">this</span>.<span class="title function_">createWaterMaterial</span>(name, options)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;grass&#x27;</span>:</span><br><span class="line">        material = <span class="variable language_">this</span>.<span class="title function_">createGrassMaterial</span>(name, options)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;未知的程序化材质类型:&#x27;</span>, type)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">set</span>(name, material)</span><br><span class="line">    <span class="keyword">return</span> material</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 木材材质</span></span><br><span class="line">  <span class="title function_">createWoodMaterial</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">WoodProceduralTexture</span>.<span class="title class_">WoodProceduralTexture</span>(name, <span class="number">256</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 木材参数</span></span><br><span class="line">    material.<span class="property">woodColor</span> = options.<span class="property">woodColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.49</span>, <span class="number">0.25</span>, <span class="number">0</span>)</span><br><span class="line">    material.<span class="property">ringColor</span> = options.<span class="property">ringColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.4</span>, <span class="number">0.1</span>, <span class="number">0.1</span>)</span><br><span class="line">    material.<span class="property">textureSize</span> = options.<span class="property">textureSize</span> || <span class="keyword">new</span> <span class="title class_">Vector2</span>(<span class="number">256</span>, <span class="number">256</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> standardMaterial = <span class="keyword">new</span> <span class="title class_">StandardMaterial</span>(name + <span class="string">&#x27;_standard&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    standardMaterial.<span class="property">diffuseTexture</span> = material</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> standardMaterial</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 大理石材质</span></span><br><span class="line">  <span class="title function_">createMarbleMaterial</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">MarbleProceduralTexture</span>.<span class="title class_">MarbleProceduralTexture</span>(name, <span class="number">256</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 大理石参数</span></span><br><span class="line">    material.<span class="property">marbleColor</span> = options.<span class="property">marbleColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.77</span>, <span class="number">0.47</span>, <span class="number">0.38</span>)</span><br><span class="line">    material.<span class="property">jointColor</span> = options.<span class="property">jointColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.72</span>, <span class="number">0.72</span>, <span class="number">0.72</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> standardMaterial = <span class="keyword">new</span> <span class="title class_">StandardMaterial</span>(name + <span class="string">&#x27;_standard&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    standardMaterial.<span class="property">diffuseTexture</span> = material</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> standardMaterial</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 火焰材质</span></span><br><span class="line">  <span class="title function_">createFireMaterial</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">FireProceduralTexture</span>.<span class="title class_">FireProceduralTexture</span>(name, <span class="number">256</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 火焰参数</span></span><br><span class="line">    material.<span class="property">fireColors</span> = options.<span class="property">fireColors</span> || <span class="title class_">FireProceduralTexture</span>.<span class="property">RedFireColors</span></span><br><span class="line">    material.<span class="property">speed</span> = options.<span class="property">speed</span> || <span class="keyword">new</span> <span class="title class_">Vector2</span>(<span class="number">1.0</span>, <span class="number">1.0</span>)</span><br><span class="line">    material.<span class="property">shift</span> = options.<span class="property">shift</span> || <span class="number">1.6</span></span><br><span class="line">    material.<span class="property">alpha</span> = options.<span class="property">alpha</span> || <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> unlitMaterial = <span class="keyword">new</span> <span class="title class_">UnlitMaterial</span>(name + <span class="string">&#x27;_unlit&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    unlitMaterial.<span class="property">diffuseTexture</span> = material</span><br><span class="line">    unlitMaterial.<span class="property">hasAlpha</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> unlitMaterial</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 水材质</span></span><br><span class="line">  <span class="title function_">createWaterMaterial</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> waterMesh = options.<span class="property">waterMesh</span></span><br><span class="line">    <span class="keyword">const</span> skybox = options.<span class="property">skybox</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> waterMaterial = <span class="keyword">new</span> <span class="title class_">WaterMaterial</span>(name, <span class="variable language_">this</span>.<span class="property">scene</span>, <span class="keyword">new</span> <span class="title class_">Vector2</span>(<span class="number">512</span>, <span class="number">512</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 水面参数</span></span><br><span class="line">    waterMaterial.<span class="property">backFaceCulling</span> = <span class="literal">true</span></span><br><span class="line">    waterMaterial.<span class="property">bumpTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(</span><br><span class="line">      options.<span class="property">bumpTexture</span> || <span class="string">&#x27;/textures/water_normal.jpg&#x27;</span>,</span><br><span class="line">      name + <span class="string">&#x27;_bump&#x27;</span>,</span><br><span class="line">    )</span><br><span class="line">    waterMaterial.<span class="property">windForce</span> = options.<span class="property">windForce</span> || -<span class="number">10</span></span><br><span class="line">    waterMaterial.<span class="property">waveHeight</span> = options.<span class="property">waveHeight</span> || <span class="number">0.5</span></span><br><span class="line">    waterMaterial.<span class="property">bumpHeight</span> = options.<span class="property">bumpHeight</span> || <span class="number">0.4</span></span><br><span class="line">    waterMaterial.<span class="property">windDirection</span> = options.<span class="property">windDirection</span> || <span class="keyword">new</span> <span class="title class_">Vector2</span>(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">    waterMaterial.<span class="property">waterColor</span> = options.<span class="property">waterColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.1</span>, <span class="number">0.1</span>, <span class="number">0.6</span>)</span><br><span class="line">    waterMaterial.<span class="property">colorBlendFactor</span> = options.<span class="property">colorBlendFactor</span> || <span class="number">0.2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加到渲染列表</span></span><br><span class="line">    <span class="keyword">if</span> (waterMesh) &#123;</span><br><span class="line">      waterMaterial.<span class="title function_">addToRenderList</span>(waterMesh)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (skybox) &#123;</span><br><span class="line">      waterMaterial.<span class="title function_">addToRenderList</span>(skybox)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> waterMaterial</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 草地材质</span></span><br><span class="line">  <span class="title function_">createGrassMaterial</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">GrassProceduralTexture</span>.<span class="title class_">GrassProceduralTexture</span>(name, <span class="number">256</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 草地参数</span></span><br><span class="line">    material.<span class="property">grassColors</span> = options.<span class="property">grassColors</span> || [</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.29</span>, <span class="number">0.38</span>, <span class="number">0.02</span>),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.36</span>, <span class="number">0.49</span>, <span class="number">0.09</span>),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.51</span>, <span class="number">0.6</span>, <span class="number">0.28</span>),</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> standardMaterial = <span class="keyword">new</span> <span class="title class_">StandardMaterial</span>(name + <span class="string">&#x27;_standard&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    standardMaterial.<span class="property">diffuseTexture</span> = material</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> standardMaterial</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 纹理加载和管理</span></span><br><span class="line">  <span class="title function_">loadTexture</span>(<span class="params">url, name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// 检查是否已加载</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">has</span>(name)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> texture = <span class="keyword">new</span> <span class="title class_">Texture</span>(url, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 纹理设置</span></span><br><span class="line">    texture.<span class="property">name</span> = name</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 包装模式</span></span><br><span class="line">    <span class="comment">// WRAP_ADDRESSMODE: 重复</span></span><br><span class="line">    <span class="comment">// CLAMP_ADDRESSMODE: 钳制</span></span><br><span class="line">    <span class="comment">// MIRROR_ADDRESSMODE: 镜像</span></span><br><span class="line">    texture.<span class="property">wrapU</span> = options.<span class="property">wrapU</span> || <span class="title class_">Texture</span>.<span class="property">WRAP_ADDRESSMODE</span></span><br><span class="line">    texture.<span class="property">wrapV</span> = options.<span class="property">wrapV</span> || <span class="title class_">Texture</span>.<span class="property">WRAP_ADDRESSMODE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 过滤模式</span></span><br><span class="line">    <span class="comment">// NEAREST_SAMPLINGMODE: 最近邻</span></span><br><span class="line">    <span class="comment">// BILINEAR_SAMPLINGMODE: 双线性</span></span><br><span class="line">    <span class="comment">// TRILINEAR_SAMPLINGMODE: 三线性</span></span><br><span class="line">    texture.<span class="property">samplingMode</span> = options.<span class="property">samplingMode</span> || <span class="title class_">Texture</span>.<span class="property">TRILINEAR_SAMPLINGMODE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Mipmap</span></span><br><span class="line">    texture.<span class="property">generateMipMaps</span> = options.<span class="property">generateMipMaps</span> !== <span class="literal">undefined</span> ? options.<span class="property">generateMipMaps</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 各向异性过滤</span></span><br><span class="line">    texture.<span class="property">anisotropicFilteringLevel</span> = options.<span class="property">anisotropicFilteringLevel</span> || <span class="number">4</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// UV偏移和缩放</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">uOffset</span> !== <span class="literal">undefined</span>) texture.<span class="property">uOffset</span> = options.<span class="property">uOffset</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">vOffset</span> !== <span class="literal">undefined</span>) texture.<span class="property">vOffset</span> = options.<span class="property">vOffset</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">uScale</span> !== <span class="literal">undefined</span>) texture.<span class="property">uScale</span> = options.<span class="property">uScale</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">vScale</span> !== <span class="literal">undefined</span>) texture.<span class="property">vScale</span> = options.<span class="property">vScale</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// UV旋转</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">uAng</span> !== <span class="literal">undefined</span>) texture.<span class="property">uAng</span> = options.<span class="property">uAng</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">vAng</span> !== <span class="literal">undefined</span>) texture.<span class="property">vAng</span> = options.<span class="property">vAng</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">wAng</span> !== <span class="literal">undefined</span>) texture.<span class="property">wAng</span> = options.<span class="property">wAng</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 级别调整</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">level</span> !== <span class="literal">undefined</span>) texture.<span class="property">level</span> = options.<span class="property">level</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">set</span>(name, texture)</span><br><span class="line">    <span class="keyword">return</span> texture</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 立方体纹理加载 (Skybox/Environment)</span></span><br><span class="line">  <span class="title function_">loadCubeTexture</span>(<span class="params">urls, name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">has</span>(name)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> cubeTexture</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(urls)) &#123;</span><br><span class="line">      <span class="comment">// 6个面的纹理</span></span><br><span class="line">      cubeTexture = <span class="keyword">new</span> <span class="title class_">CubeTexture</span>.<span class="title class_">CreateFromImages</span>(urls, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// DDS或HDR格式</span></span><br><span class="line">      cubeTexture = <span class="keyword">new</span> <span class="title class_">CubeTexture</span>(urls, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cubeTexture.<span class="property">name</span> = name</span><br><span class="line">    cubeTexture.<span class="property">coordinatesMode</span> = options.<span class="property">coordinatesMode</span> || <span class="title class_">Texture</span>.<span class="property">SKYBOX_MODE</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">set</span>(name, cubeTexture)</span><br><span class="line">    <span class="keyword">return</span> cubeTexture</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// UV变换设置</span></span><br><span class="line">  <span class="title function_">setupUVTransform</span>(<span class="params">texture, options</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!texture) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">uOffset</span> !== <span class="literal">undefined</span>) texture.<span class="property">uOffset</span> = options.<span class="property">uOffset</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">vOffset</span> !== <span class="literal">undefined</span>) texture.<span class="property">vOffset</span> = options.<span class="property">vOffset</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">uScale</span> !== <span class="literal">undefined</span>) texture.<span class="property">uScale</span> = options.<span class="property">uScale</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">vScale</span> !== <span class="literal">undefined</span>) texture.<span class="property">vScale</span> = options.<span class="property">vScale</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">uAng</span> !== <span class="literal">undefined</span>) texture.<span class="property">uAng</span> = options.<span class="property">uAng</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">vAng</span> !== <span class="literal">undefined</span>) texture.<span class="property">vAng</span> = options.<span class="property">vAng</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// UV动画</span></span><br><span class="line">  <span class="title function_">animateUV</span>(<span class="params">textureName, property, targetValue, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> texture = <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">get</span>(textureName)</span><br><span class="line">    <span class="keyword">if</span> (!texture) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> animation = <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;textureName&#125;</span>_<span class="subst">$&#123;property&#125;</span>`</span>,</span><br><span class="line">      texture,</span><br><span class="line">      property,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">      texture[property],</span><br><span class="line">      targetValue,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 滚动UV效果</span></span><br><span class="line">  <span class="title function_">addScrollingUV</span>(<span class="params">textureName, speedU = <span class="number">0.01</span>, speedV = <span class="number">0.01</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> texture = <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">get</span>(textureName)</span><br><span class="line">    <span class="keyword">if</span> (!texture) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> observer = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      texture.<span class="property">uOffset</span> += speedU * <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>().<span class="title function_">getDeltaTime</span>() * <span class="number">0.001</span></span><br><span class="line">      texture.<span class="property">vOffset</span> += speedV * <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>().<span class="title function_">getDeltaTime</span>() * <span class="number">0.001</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 防止数值过大</span></span><br><span class="line">      <span class="keyword">if</span> (texture.<span class="property">uOffset</span> &gt; <span class="number">1</span>) texture.<span class="property">uOffset</span> -= <span class="number">1</span></span><br><span class="line">      <span class="keyword">if</span> (texture.<span class="property">vOffset</span> &gt; <span class="number">1</span>) texture.<span class="property">vOffset</span> -= <span class="number">1</span></span><br><span class="line">      <span class="keyword">if</span> (texture.<span class="property">uOffset</span> &lt; <span class="number">0</span>) texture.<span class="property">uOffset</span> += <span class="number">1</span></span><br><span class="line">      <span class="keyword">if</span> (texture.<span class="property">vOffset</span> &lt; <span class="number">0</span>) texture.<span class="property">vOffset</span> += <span class="number">1</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">dispose</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">remove</span>(observer)</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 材质混合</span></span><br><span class="line">  <span class="title function_">blendMaterials</span>(<span class="params">name, material1, material2, blendFactor = <span class="number">0.5</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> blendedMaterial = <span class="keyword">new</span> <span class="title class_">StandardMaterial</span>(name, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 混合颜色</span></span><br><span class="line">    blendedMaterial.<span class="property">diffuseColor</span> = <span class="title class_">Color3</span>.<span class="title class_">Lerp</span>(</span><br><span class="line">      material1.<span class="property">diffuseColor</span> || <span class="title class_">Color3</span>.<span class="title class_">White</span>(),</span><br><span class="line">      material2.<span class="property">diffuseColor</span> || <span class="title class_">Color3</span>.<span class="title class_">White</span>(),</span><br><span class="line">      blendFactor,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    blendedMaterial.<span class="property">specularColor</span> = <span class="title class_">Color3</span>.<span class="title class_">Lerp</span>(</span><br><span class="line">      material1.<span class="property">specularColor</span> || <span class="title class_">Color3</span>.<span class="title class_">White</span>(),</span><br><span class="line">      material2.<span class="property">specularColor</span> || <span class="title class_">Color3</span>.<span class="title class_">White</span>(),</span><br><span class="line">      blendFactor,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 混合纹理（通过混合着色器）</span></span><br><span class="line">    <span class="keyword">if</span> (material1.<span class="property">diffuseTexture</span> &amp;&amp; material2.<span class="property">diffuseTexture</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> mixedShader = <span class="variable language_">this</span>.<span class="title function_">createTextureBlendShader</span>(</span><br><span class="line">        name + <span class="string">&#x27;_blend&#x27;</span>,</span><br><span class="line">        material1.<span class="property">diffuseTexture</span>,</span><br><span class="line">        material2.<span class="property">diffuseTexture</span>,</span><br><span class="line">        blendFactor,</span><br><span class="line">      )</span><br><span class="line">      blendedMaterial.<span class="property">diffuseTexture</span> = mixedShader</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">set</span>(name, blendedMaterial)</span><br><span class="line">    <span class="keyword">return</span> blendedMaterial</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 纹理混合着色器</span></span><br><span class="line">  <span class="title function_">createTextureBlendShader</span>(<span class="params">name, texture1, texture2, blendFactor</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> shaderMaterial = <span class="keyword">new</span> <span class="title class_">ShaderMaterial</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">vertex</span>: <span class="string">`</span></span><br><span class="line"><span class="string">        precision highp float;</span></span><br><span class="line"><span class="string">        attribute vec3 position;</span></span><br><span class="line"><span class="string">        attribute vec2 uv;</span></span><br><span class="line"><span class="string">        uniform mat4 worldViewProjection;</span></span><br><span class="line"><span class="string">        varying vec2 vUV;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        void main(void) &#123;</span></span><br><span class="line"><span class="string">          gl_Position = worldViewProjection * vec4(position, 1.0);</span></span><br><span class="line"><span class="string">          vUV = uv;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      `</span>,</span><br><span class="line">        <span class="attr">fragment</span>: <span class="string">`</span></span><br><span class="line"><span class="string">        precision highp float;</span></span><br><span class="line"><span class="string">        varying vec2 vUV;</span></span><br><span class="line"><span class="string">        uniform sampler2D texture1;</span></span><br><span class="line"><span class="string">        uniform sampler2D texture2;</span></span><br><span class="line"><span class="string">        uniform float blendFactor;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        void main(void) &#123;</span></span><br><span class="line"><span class="string">          vec4 color1 = texture2D(texture1, vUV);</span></span><br><span class="line"><span class="string">          vec4 color2 = texture2D(texture2, vUV);</span></span><br><span class="line"><span class="string">          gl_FragColor = mix(color1, color2, blendFactor);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      `</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">attributes</span>: [<span class="string">&#x27;position&#x27;</span>, <span class="string">&#x27;uv&#x27;</span>],</span><br><span class="line">        <span class="attr">uniforms</span>: [<span class="string">&#x27;worldViewProjection&#x27;</span>, <span class="string">&#x27;blendFactor&#x27;</span>],</span><br><span class="line">        <span class="attr">samplers</span>: [<span class="string">&#x27;texture1&#x27;</span>, <span class="string">&#x27;texture2&#x27;</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    shaderMaterial.<span class="title function_">setTexture</span>(<span class="string">&#x27;texture1&#x27;</span>, texture1)</span><br><span class="line">    shaderMaterial.<span class="title function_">setTexture</span>(<span class="string">&#x27;texture2&#x27;</span>, texture2)</span><br><span class="line">    shaderMaterial.<span class="title function_">setFloat</span>(<span class="string">&#x27;blendFactor&#x27;</span>, blendFactor)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> shaderMaterial</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 材质动画</span></span><br><span class="line">  <span class="title function_">animateMaterial</span>(<span class="params">materialName, property, targetValue, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">get</span>(materialName)</span><br><span class="line">    <span class="keyword">if</span> (!material) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> animation = <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;materialName&#125;</span>_<span class="subst">$&#123;property&#125;</span>`</span>,</span><br><span class="line">      material,</span><br><span class="line">      property,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">      material[property],</span><br><span class="line">      targetValue,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 材质切换动画</span></span><br><span class="line">  <span class="title function_">createMaterialTransition</span>(<span class="params">mesh, fromMaterial, toMaterial, duration = <span class="number">1000</span></span>) &#123;</span><br><span class="line">    <span class="comment">// 创建过渡材质</span></span><br><span class="line">    <span class="keyword">const</span> transitionMaterial = fromMaterial.<span class="title function_">clone</span>(mesh.<span class="property">name</span> + <span class="string">&#x27;_transition&#x27;</span>)</span><br><span class="line">    mesh.<span class="property">material</span> = transitionMaterial</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果是StandardMaterial，可以动画颜色属性</span></span><br><span class="line">    <span class="keyword">if</span> (transitionMaterial <span class="keyword">instanceof</span> <span class="title class_">StandardMaterial</span> &amp;&amp; toMaterial <span class="keyword">instanceof</span> <span class="title class_">StandardMaterial</span>) &#123;</span><br><span class="line">      <span class="comment">// 颜色过渡</span></span><br><span class="line">      <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;materialTransition_diffuse&#x27;</span>,</span><br><span class="line">        transitionMaterial,</span><br><span class="line">        <span class="string">&#x27;diffuseColor&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">        fromMaterial.<span class="property">diffuseColor</span>.<span class="title function_">clone</span>(),</span><br><span class="line">        toMaterial.<span class="property">diffuseColor</span>.<span class="title function_">clone</span>(),</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// 动画完成后切换到目标材质</span></span><br><span class="line">          mesh.<span class="property">material</span> = toMaterial</span><br><span class="line">          transitionMaterial.<span class="title function_">dispose</span>()</span><br><span class="line">        &#125;,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;materialTransition_specular&#x27;</span>,</span><br><span class="line">        transitionMaterial,</span><br><span class="line">        <span class="string">&#x27;specularColor&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">        fromMaterial.<span class="property">specularColor</span>.<span class="title function_">clone</span>(),</span><br><span class="line">        toMaterial.<span class="property">specularColor</span>.<span class="title function_">clone</span>(),</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取材质信息</span></span><br><span class="line">  <span class="title function_">getMaterialInfo</span>(<span class="params">materialName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">get</span>(materialName)</span><br><span class="line">    <span class="keyword">if</span> (!material) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> info = &#123;</span><br><span class="line">      <span class="attr">name</span>: materialName,</span><br><span class="line">      <span class="attr">type</span>: material.<span class="title function_">getClassName</span>(),</span><br><span class="line">      <span class="attr">alpha</span>: material.<span class="property">alpha</span>,</span><br><span class="line">      <span class="attr">backFaceCulling</span>: material.<span class="property">backFaceCulling</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (material <span class="keyword">instanceof</span> <span class="title class_">StandardMaterial</span>) &#123;</span><br><span class="line">      info.<span class="property">diffuseColor</span> = material.<span class="property">diffuseColor</span></span><br><span class="line">      info.<span class="property">specularColor</span> = material.<span class="property">specularColor</span></span><br><span class="line">      info.<span class="property">emissiveColor</span> = material.<span class="property">emissiveColor</span></span><br><span class="line">      info.<span class="property">specularPower</span> = material.<span class="property">specularPower</span></span><br><span class="line">      info.<span class="property">hasTextures</span> = &#123;</span><br><span class="line">        <span class="attr">diffuse</span>: !!material.<span class="property">diffuseTexture</span>,</span><br><span class="line">        <span class="attr">specular</span>: !!material.<span class="property">specularTexture</span>,</span><br><span class="line">        <span class="attr">normal</span>: !!material.<span class="property">bumpTexture</span>,</span><br><span class="line">        <span class="attr">emissive</span>: !!material.<span class="property">emissiveTexture</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (material <span class="keyword">instanceof</span> <span class="title class_">PBRMaterial</span>) &#123;</span><br><span class="line">      info.<span class="property">baseColor</span> = material.<span class="property">baseColor</span></span><br><span class="line">      info.<span class="property">metallicFactor</span> = material.<span class="property">metallicFactor</span></span><br><span class="line">      info.<span class="property">roughnessFactor</span> = material.<span class="property">roughnessFactor</span></span><br><span class="line">      info.<span class="property">emissiveColor</span> = material.<span class="property">emissiveColor</span></span><br><span class="line">      info.<span class="property">hasTextures</span> = &#123;</span><br><span class="line">        <span class="attr">base</span>: !!material.<span class="property">baseTexture</span>,</span><br><span class="line">        <span class="attr">metallicRoughness</span>: !!material.<span class="property">metallicRoughnessTexture</span>,</span><br><span class="line">        <span class="attr">normal</span>: !!material.<span class="property">normalTexture</span>,</span><br><span class="line">        <span class="attr">emissive</span>: !!material.<span class="property">emissiveTexture</span>,</span><br><span class="line">        <span class="attr">occlusion</span>: !!material.<span class="property">ambientTexture</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 批量应用材质</span></span><br><span class="line">  <span class="title function_">applyMaterialToMeshes</span>(<span class="params">materialName, meshes</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">get</span>(materialName)</span><br><span class="line">    <span class="keyword">if</span> (!material) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    meshes.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      mesh.<span class="property">material</span> = material</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据距离切换材质LOD</span></span><br><span class="line">  <span class="title function_">setupMaterialLOD</span>(<span class="params">meshName, materials</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getMeshByName</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// materials: [&#123; distance: number, material: string &#125;, ...]</span></span><br><span class="line">    <span class="keyword">const</span> sortedMaterials = materials.<span class="title function_">sort</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a.<span class="property">distance</span> - b.<span class="property">distance</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> observer = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">activeCamera</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> distance = <span class="title class_">Vector3</span>.<span class="title class_">Distance</span>(mesh.<span class="property">position</span>, <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">activeCamera</span>.<span class="property">position</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = sortedMaterials.<span class="property">length</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">if</span> (distance &gt;= sortedMaterials[i].<span class="property">distance</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> material = <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">get</span>(sortedMaterials[i].<span class="property">material</span>)</span><br><span class="line">          <span class="keyword">if</span> (material &amp;&amp; mesh.<span class="property">material</span> !== material) &#123;</span><br><span class="line">            mesh.<span class="property">material</span> = material</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">dispose</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">remove</span>(observer)</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 保存材质设置</span></span><br><span class="line">  <span class="title function_">saveMaterialSetup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> setup = &#123;</span><br><span class="line">      <span class="attr">materials</span>: [],</span><br><span class="line">      <span class="attr">textures</span>: [],</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">material, name</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">materials</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: name,</span><br><span class="line">        ...<span class="variable language_">this</span>.<span class="title function_">getMaterialInfo</span>(name),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">texture, name</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">textures</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: name,</span><br><span class="line">        <span class="attr">url</span>: texture.<span class="property">url</span>,</span><br><span class="line">        <span class="attr">wrapU</span>: texture.<span class="property">wrapU</span>,</span><br><span class="line">        <span class="attr">wrapV</span>: texture.<span class="property">wrapV</span>,</span><br><span class="line">        <span class="attr">uOffset</span>: texture.<span class="property">uOffset</span>,</span><br><span class="line">        <span class="attr">vOffset</span>: texture.<span class="property">vOffset</span>,</span><br><span class="line">        <span class="attr">uScale</span>: texture.<span class="property">uScale</span>,</span><br><span class="line">        <span class="attr">vScale</span>: texture.<span class="property">vScale</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> setup</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 资源清理</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">nodeMaterials</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">material</span>) =&gt;</span> &#123;</span><br><span class="line">      material.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">nodeMaterials</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">material</span>) =&gt;</span> &#123;</span><br><span class="line">      material.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">texture</span>) =&gt;</span> &#123;</span><br><span class="line">      texture.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> materialManager = <span class="keyword">new</span> <span class="title class_">MaterialManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建PBR金属材质</span></span><br><span class="line"><span class="keyword">const</span> metalMaterial = materialManager.<span class="title function_">createPBRMaterial</span>(<span class="string">&#x27;metal&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">baseColor</span>: <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.7</span>, <span class="number">0.7</span>, <span class="number">0.7</span>),</span><br><span class="line">  <span class="attr">metallicFactor</span>: <span class="number">1.0</span>,</span><br><span class="line">  <span class="attr">roughnessFactor</span>: <span class="number">0.2</span>,</span><br><span class="line">  <span class="attr">baseTexture</span>: <span class="string">&#x27;/textures/metal_base.jpg&#x27;</span>,</span><br><span class="line">  <span class="attr">normalTexture</span>: <span class="string">&#x27;/textures/metal_normal.jpg&#x27;</span>,</span><br><span class="line">  <span class="attr">metallicRoughnessTexture</span>: <span class="string">&#x27;/textures/metal_metallic_roughness.jpg&#x27;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建程序化木材材质</span></span><br><span class="line"><span class="keyword">const</span> woodMaterial = materialManager.<span class="title function_">createProceduralMaterial</span>(<span class="string">&#x27;wood&#x27;</span>, <span class="string">&#x27;wood&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">woodColor</span>: <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.6</span>, <span class="number">0.3</span>, <span class="number">0.1</span>),</span><br><span class="line">  <span class="attr">ringColor</span>: <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.4</span>, <span class="number">0.2</span>, <span class="number">0.05</span>),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 应用材质到网格</span></span><br><span class="line"><span class="keyword">const</span> sphere = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateSphere</span>(<span class="string">&#x27;sphere&#x27;</span>, &#123; <span class="attr">diameter</span>: <span class="number">2</span> &#125;, scene)</span><br><span class="line">sphere.<span class="property">material</span> = metalMaterial</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加UV滚动效果</span></span><br><span class="line"><span class="keyword">const</span> scrollEffect = materialManager.<span class="title function_">addScrollingUV</span>(<span class="string">&#x27;metal_metal_base&#x27;</span>, <span class="number">0.02</span>, <span class="number">0</span>)</span><br></pre></td></tr></table></figure><h2 id="🎭-Mesh-网格系统详解"><a href="#🎭-Mesh-网格系统详解" class="headerlink" title="🎭 Mesh 网格系统详解"></a>🎭 Mesh 网格系统详解</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Mesh 网格系统完整管理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MeshManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">instancedMeshes</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mergedMeshes</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupBuiltInGeometries</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupBuiltInGeometries</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 注册基础几何体创建器</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">geometryCreators</span> = &#123;</span><br><span class="line">      <span class="attr">box</span>: <span class="variable language_">this</span>.<span class="property">createBox</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">sphere</span>: <span class="variable language_">this</span>.<span class="property">createSphere</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">cylinder</span>: <span class="variable language_">this</span>.<span class="property">createCylinder</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">plane</span>: <span class="variable language_">this</span>.<span class="property">createPlane</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">ground</span>: <span class="variable language_">this</span>.<span class="property">createGround</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">torus</span>: <span class="variable language_">this</span>.<span class="property">createTorus</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">cone</span>: <span class="variable language_">this</span>.<span class="property">createCone</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">polyhedron</span>: <span class="variable language_">this</span>.<span class="property">createPolyhedron</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">ribbon</span>: <span class="variable language_">this</span>.<span class="property">createRibbon</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">tube</span>: <span class="variable language_">this</span>.<span class="property">createTube</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">lines</span>: <span class="variable language_">this</span>.<span class="property">createLines</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">dashedLines</span>: <span class="variable language_">this</span>.<span class="property">createDashedLines</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 立方体创建</span></span><br><span class="line">  <span class="title function_">createBox</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// size: number - 统一尺寸</span></span><br><span class="line">      <span class="attr">size</span>: options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// width, height, depth: number - 分别设置宽高深</span></span><br><span class="line">      <span class="attr">width</span>: options.<span class="property">width</span> || options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">height</span>: options.<span class="property">height</span> || options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">depth</span>: options.<span class="property">depth</span> || options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// faceUV: Vector4[] - 每个面的UV坐标</span></span><br><span class="line">      <span class="attr">faceUV</span>: options.<span class="property">faceUV</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// faceColors: Color4[] - 每个面的颜色</span></span><br><span class="line">      <span class="attr">faceColors</span>: options.<span class="property">faceColors</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number - 面朝向</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// frontUVs, backUVs: Vector4 - 正面背面UV</span></span><br><span class="line">      <span class="attr">frontUVs</span>: options.<span class="property">frontUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">      <span class="attr">backUVs</span>: options.<span class="property">backUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line"></span><br><span class="line">      <span class="comment">// wrap: boolean - 是否环绕</span></span><br><span class="line">      <span class="attr">wrap</span>: options.<span class="property">wrap</span> || <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// topBaseAt: number - 顶部位置</span></span><br><span class="line">      <span class="attr">topBaseAt</span>: options.<span class="property">topBaseAt</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// bottomBaseAt: number - 底部位置</span></span><br><span class="line">      <span class="attr">bottomBaseAt</span>: options.<span class="property">bottomBaseAt</span> || <span class="number">0</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateBox</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 球体创建</span></span><br><span class="line">  <span class="title function_">createSphere</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// diameter: number - 直径</span></span><br><span class="line">      <span class="attr">diameter</span>: options.<span class="property">diameter</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// diameterX, diameterY, diameterZ: number - 椭球参数</span></span><br><span class="line">      <span class="attr">diameterX</span>: options.<span class="property">diameterX</span> || options.<span class="property">diameter</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">diameterY</span>: options.<span class="property">diameterY</span> || options.<span class="property">diameter</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">diameterZ</span>: options.<span class="property">diameterZ</span> || options.<span class="property">diameter</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// segments: number - 分段数</span></span><br><span class="line">      <span class="attr">segments</span>: options.<span class="property">segments</span> || <span class="number">32</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// arc: number - 弧度（0-1，1为完整球体）</span></span><br><span class="line">      <span class="attr">arc</span>: options.<span class="property">arc</span> || <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// slice: number - 切片（0-1，1为完整球体）</span></span><br><span class="line">      <span class="attr">slice</span>: options.<span class="property">slice</span> || <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number - 面朝向</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// frontUVs, backUVs: Vector4</span></span><br><span class="line">      <span class="attr">frontUVs</span>: options.<span class="property">frontUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">      <span class="attr">backUVs</span>: options.<span class="property">backUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateSphere</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 圆柱体创建</span></span><br><span class="line">  <span class="title function_">createCylinder</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// height: number - 高度</span></span><br><span class="line">      <span class="attr">height</span>: options.<span class="property">height</span> || <span class="number">2</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// diameterTop: number - 顶部直径</span></span><br><span class="line">      <span class="attr">diameterTop</span>: options.<span class="property">diameterTop</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// diameterBottom: number - 底部直径</span></span><br><span class="line">      <span class="attr">diameterBottom</span>: options.<span class="property">diameterBottom</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// tessellation: number - 圆周分段数</span></span><br><span class="line">      <span class="attr">tessellation</span>: options.<span class="property">tessellation</span> || <span class="number">24</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// subdivisions: number - 高度细分数</span></span><br><span class="line">      <span class="attr">subdivisions</span>: options.<span class="property">subdivisions</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// arc: number - 弧度（0-1）</span></span><br><span class="line">      <span class="attr">arc</span>: options.<span class="property">arc</span> || <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// faceUV: Vector4[] - 面UV</span></span><br><span class="line">      <span class="attr">faceUV</span>: options.<span class="property">faceUV</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// faceColors: Color4[] - 面颜色</span></span><br><span class="line">      <span class="attr">faceColors</span>: options.<span class="property">faceColors</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// hasRings: boolean - 是否有环</span></span><br><span class="line">      <span class="attr">hasRings</span>: options.<span class="property">hasRings</span> || <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// enclose: boolean - 是否封闭</span></span><br><span class="line">      <span class="attr">enclose</span>: options.<span class="property">enclose</span> || <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateCylinder</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 平面创建</span></span><br><span class="line">  <span class="title function_">createPlane</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// size: number - 统一尺寸</span></span><br><span class="line">      <span class="attr">size</span>: options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// width, height: number - 宽度和高度</span></span><br><span class="line">      <span class="attr">width</span>: options.<span class="property">width</span> || options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">height</span>: options.<span class="property">height</span> || options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// frontUVs, backUVs: Vector4</span></span><br><span class="line">      <span class="attr">frontUVs</span>: options.<span class="property">frontUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">      <span class="attr">backUVs</span>: options.<span class="property">backUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sourcePlane: Plane - 源平面</span></span><br><span class="line">      <span class="attr">sourcePlane</span>: options.<span class="property">sourcePlane</span> || <span class="literal">undefined</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreatePlane</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 地面创建</span></span><br><span class="line">  <span class="title function_">createGround</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// width, height: number - 地面尺寸</span></span><br><span class="line">      <span class="attr">width</span>: options.<span class="property">width</span> || <span class="number">10</span>,</span><br><span class="line">      <span class="attr">height</span>: options.<span class="property">height</span> || <span class="number">10</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// subdivisions: number - 细分数</span></span><br><span class="line">      <span class="attr">subdivisions</span>: options.<span class="property">subdivisions</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// subdivisionsX, subdivisionsY: number - XY方向细分</span></span><br><span class="line">      <span class="attr">subdivisionsX</span>: options.<span class="property">subdivisionsX</span> || options.<span class="property">subdivisions</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">subdivisionsY</span>: options.<span class="property">subdivisionsY</span> || options.<span class="property">subdivisions</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// updatable: boolean - 是否可更新</span></span><br><span class="line">      <span class="attr">updatable</span>: options.<span class="property">updatable</span> || <span class="literal">false</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateGround</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 环面创建</span></span><br><span class="line">  <span class="title function_">createTorus</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// diameter: number - 外直径</span></span><br><span class="line">      <span class="attr">diameter</span>: options.<span class="property">diameter</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// thickness: number - 管子粗细</span></span><br><span class="line">      <span class="attr">thickness</span>: options.<span class="property">thickness</span> || <span class="number">0.5</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// tessellation: number - 分段数</span></span><br><span class="line">      <span class="attr">tessellation</span>: options.<span class="property">tessellation</span> || <span class="number">16</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// frontUVs, backUVs: Vector4</span></span><br><span class="line">      <span class="attr">frontUVs</span>: options.<span class="property">frontUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">      <span class="attr">backUVs</span>: options.<span class="property">backUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateTorus</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 圆锥创建</span></span><br><span class="line">  <span class="title function_">createCone</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// diameter: number - 底面直径</span></span><br><span class="line">      <span class="attr">diameter</span>: options.<span class="property">diameter</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// diameterTop: number - 顶面直径（0为尖锥）</span></span><br><span class="line">      <span class="attr">diameterTop</span>: options.<span class="property">diameterTop</span> || <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// diameterBottom: number - 底面直径</span></span><br><span class="line">      <span class="attr">diameterBottom</span>: options.<span class="property">diameterBottom</span> || options.<span class="property">diameter</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// height: number - 高度</span></span><br><span class="line">      <span class="attr">height</span>: options.<span class="property">height</span> || <span class="number">2</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// tessellation: number - 圆周分段</span></span><br><span class="line">      <span class="attr">tessellation</span>: options.<span class="property">tessellation</span> || <span class="number">24</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// subdivisions: number - 高度细分</span></span><br><span class="line">      <span class="attr">subdivisions</span>: options.<span class="property">subdivisions</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// arc: number - 弧度</span></span><br><span class="line">      <span class="attr">arc</span>: options.<span class="property">arc</span> || <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// faceUV: Vector4[]</span></span><br><span class="line">      <span class="attr">faceUV</span>: options.<span class="property">faceUV</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// faceColors: Color4[]</span></span><br><span class="line">      <span class="attr">faceColors</span>: options.<span class="property">faceColors</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateCylinder</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 多面体创建</span></span><br><span class="line">  <span class="title function_">createPolyhedron</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// type: number - 多面体类型</span></span><br><span class="line">      <span class="comment">// 0: 四面体, 1: 八面体, 2: 十二面体, 3: 二十面体, 4: 八面体, 5: 十二面体</span></span><br><span class="line">      <span class="attr">type</span>: options.<span class="property">type</span> || <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// size: number - 尺寸</span></span><br><span class="line">      <span class="attr">size</span>: options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sizeX, sizeY, sizeZ: number - 各轴尺寸</span></span><br><span class="line">      <span class="attr">sizeX</span>: options.<span class="property">sizeX</span> || options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">sizeY</span>: options.<span class="property">sizeY</span> || options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">sizeZ</span>: options.<span class="property">sizeZ</span> || options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// custom: object - 自定义多面体数据</span></span><br><span class="line">      <span class="attr">custom</span>: options.<span class="property">custom</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// faceUV: Vector4[]</span></span><br><span class="line">      <span class="attr">faceUV</span>: options.<span class="property">faceUV</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// faceColors: Color4[]</span></span><br><span class="line">      <span class="attr">faceColors</span>: options.<span class="property">faceColors</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// flat: boolean - 是否平面着色</span></span><br><span class="line">      <span class="attr">flat</span>: options.<span class="property">flat</span> || <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreatePolyhedron</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 带状网格创建</span></span><br><span class="line">  <span class="title function_">createRibbon</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// pathArray: Vector3[][] - 路径数组</span></span><br><span class="line">      <span class="attr">pathArray</span>: options.<span class="property">pathArray</span> || [</span><br><span class="line">        [<span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)],</span><br><span class="line">        [<span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>)],</span><br><span class="line">      ],</span><br><span class="line"></span><br><span class="line">      <span class="comment">// closeArray: boolean - 是否闭合数组</span></span><br><span class="line">      <span class="attr">closeArray</span>: options.<span class="property">closeArray</span> || <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// closePath: boolean - 是否闭合路径</span></span><br><span class="line">      <span class="attr">closePath</span>: options.<span class="property">closePath</span> || <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// offset: number - 偏移</span></span><br><span class="line">      <span class="attr">offset</span>: options.<span class="property">offset</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// frontUVs, backUVs: Vector4</span></span><br><span class="line">      <span class="attr">frontUVs</span>: options.<span class="property">frontUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">      <span class="attr">backUVs</span>: options.<span class="property">backUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line"></span><br><span class="line">      <span class="comment">// invertUV: boolean - 是否反转UV</span></span><br><span class="line">      <span class="attr">invertUV</span>: options.<span class="property">invertUV</span> || <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// uvs: Vector2[] - UV坐标数组</span></span><br><span class="line">      <span class="attr">uvs</span>: options.<span class="property">uvs</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// colors: Color4[] - 颜色数组</span></span><br><span class="line">      <span class="attr">colors</span>: options.<span class="property">colors</span> || <span class="literal">undefined</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateRibbon</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 管状网格创建</span></span><br><span class="line">  <span class="title function_">createTube</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// path: Vector3[] - 路径点</span></span><br><span class="line">      <span class="attr">path</span>: options.<span class="property">path</span> || [<span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>)],</span><br><span class="line"></span><br><span class="line">      <span class="comment">// radius: number - 半径</span></span><br><span class="line">      <span class="attr">radius</span>: options.<span class="property">radius</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// tessellation: number - 圆周分段</span></span><br><span class="line">      <span class="attr">tessellation</span>: options.<span class="property">tessellation</span> || <span class="number">8</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// radiusFunction: function - 半径函数</span></span><br><span class="line">      <span class="attr">radiusFunction</span>: options.<span class="property">radiusFunction</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// cap: number - 端盖类型</span></span><br><span class="line">      <span class="attr">cap</span>: options.<span class="property">cap</span> || <span class="title class_">Mesh</span>.<span class="property">NO_CAP</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// arc: number - 弧度</span></span><br><span class="line">      <span class="attr">arc</span>: options.<span class="property">arc</span> || <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// frontUVs, backUVs: Vector4</span></span><br><span class="line">      <span class="attr">frontUVs</span>: options.<span class="property">frontUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">      <span class="attr">backUVs</span>: options.<span class="property">backUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line"></span><br><span class="line">      <span class="comment">// invertUV: boolean</span></span><br><span class="line">      <span class="attr">invertUV</span>: options.<span class="property">invertUV</span> || <span class="literal">false</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateTube</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 线条创建</span></span><br><span class="line">  <span class="title function_">createLines</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// points: Vector3[] - 点数组</span></span><br><span class="line">      <span class="attr">points</span>: options.<span class="property">points</span> || [<span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)],</span><br><span class="line"></span><br><span class="line">      <span class="comment">// colors: Color4[] - 颜色数组</span></span><br><span class="line">      <span class="attr">colors</span>: options.<span class="property">colors</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// useVertexAlpha: boolean - 是否使用顶点透明度</span></span><br><span class="line">      <span class="attr">useVertexAlpha</span>: options.<span class="property">useVertexAlpha</span> || <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateLines</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 虚线创建</span></span><br><span class="line">  <span class="title function_">createDashedLines</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// points: Vector3[] - 点数组</span></span><br><span class="line">      <span class="attr">points</span>: options.<span class="property">points</span> || [<span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)],</span><br><span class="line"></span><br><span class="line">      <span class="comment">// dashSize: number - 虚线长度</span></span><br><span class="line">      <span class="attr">dashSize</span>: options.<span class="property">dashSize</span> || <span class="number">3</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// gapSize: number - 间隙长度</span></span><br><span class="line">      <span class="attr">gapSize</span>: options.<span class="property">gapSize</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// dashNb: number - 虚线数量</span></span><br><span class="line">      <span class="attr">dashNb</span>: options.<span class="property">dashNb</span> || <span class="number">200</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// useVertexAlpha: boolean</span></span><br><span class="line">      <span class="attr">useVertexAlpha</span>: options.<span class="property">useVertexAlpha</span> || <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateDashedLines</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置网格默认属性</span></span><br><span class="line">  <span class="title function_">setupMeshDefaults</span>(<span class="params">mesh, options</span>) &#123;</span><br><span class="line">    <span class="comment">// 位置变换</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">position</span>) mesh.<span class="property">position</span> = options.<span class="property">position</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">rotation</span>) mesh.<span class="property">rotation</span> = options.<span class="property">rotation</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">scaling</span>) mesh.<span class="property">scaling</span> = options.<span class="property">scaling</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 材质</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">material</span>) mesh.<span class="property">material</span> = options.<span class="property">material</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可见性</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">visibility</span> !== <span class="literal">undefined</span>) mesh.<span class="property">visibility</span> = options.<span class="property">visibility</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">isVisible</span> !== <span class="literal">undefined</span>) mesh.<span class="property">isVisible</span> = options.<span class="property">isVisible</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 渲染属性</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">receiveShadows</span> !== <span class="literal">undefined</span>) mesh.<span class="property">receiveShadows</span> = options.<span class="property">receiveShadows</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">checkCollisions</span> !== <span class="literal">undefined</span>) mesh.<span class="property">checkCollisions</span> = options.<span class="property">checkCollisions</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">isPickable</span> !== <span class="literal">undefined</span>) mesh.<span class="property">isPickable</span> = options.<span class="property">isPickable</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 渲染组</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">renderingGroupId</span> !== <span class="literal">undefined</span>) mesh.<span class="property">renderingGroupId</span> = options.<span class="property">renderingGroupId</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自定义属性</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">metadata</span>) mesh.<span class="property">metadata</span> = options.<span class="property">metadata</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 网格实例化</span></span><br><span class="line">  <span class="title function_">createInstances</span>(<span class="params">sourceMeshName, count, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> sourceMesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(sourceMeshName)</span><br><span class="line">    <span class="keyword">if</span> (!sourceMesh) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;源网格不存在:&#x27;</span>, sourceMeshName)</span><br><span class="line">      <span class="keyword">return</span> []</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> instances = []</span><br><span class="line">    <span class="keyword">const</span> instanceName = options.<span class="property">namePrefix</span> || sourceMeshName + <span class="string">&#x27;_instance&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> instance = sourceMesh.<span class="title function_">createInstance</span>(<span class="string">`<span class="subst">$&#123;instanceName&#125;</span>_<span class="subst">$&#123;i&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 随机或指定位置</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">positions</span> &amp;&amp; options.<span class="property">positions</span>[i]) &#123;</span><br><span class="line">        instance.<span class="property">position</span> = options.<span class="property">positions</span>[i]</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options.<span class="property">randomPosition</span>) &#123;</span><br><span class="line">        instance.<span class="property">position</span> = <span class="variable language_">this</span>.<span class="title function_">generateRandomPosition</span>(options.<span class="property">randomPosition</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 随机或指定旋转</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">rotations</span> &amp;&amp; options.<span class="property">rotations</span>[i]) &#123;</span><br><span class="line">        instance.<span class="property">rotation</span> = options.<span class="property">rotations</span>[i]</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options.<span class="property">randomRotation</span>) &#123;</span><br><span class="line">        instance.<span class="property">rotation</span> = <span class="variable language_">this</span>.<span class="title function_">generateRandomRotation</span>(options.<span class="property">randomRotation</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 随机或指定缩放</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">scalings</span> &amp;&amp; options.<span class="property">scalings</span>[i]) &#123;</span><br><span class="line">        instance.<span class="property">scaling</span> = options.<span class="property">scalings</span>[i]</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options.<span class="property">randomScaling</span>) &#123;</span><br><span class="line">        instance.<span class="property">scaling</span> = <span class="variable language_">this</span>.<span class="title function_">generateRandomScaling</span>(options.<span class="property">randomScaling</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      instances.<span class="title function_">push</span>(instance)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">instancedMeshes</span>.<span class="title function_">set</span>(sourceMeshName, instances)</span><br><span class="line">    <span class="keyword">return</span> instances</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 生成随机位置</span></span><br><span class="line">  <span class="title function_">generateRandomPosition</span>(<span class="params">bounds</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; min = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">10</span>, <span class="number">0</span>, -<span class="number">10</span>), max = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>) &#125; = bounds</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Vector3</span>(</span><br><span class="line">      min.<span class="property">x</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">x</span> - min.<span class="property">x</span>),</span><br><span class="line">      min.<span class="property">y</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">y</span> - min.<span class="property">y</span>),</span><br><span class="line">      min.<span class="property">z</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">z</span> - min.<span class="property">z</span>),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 生成随机旋转</span></span><br><span class="line">  <span class="title function_">generateRandomRotation</span>(<span class="params">bounds</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; min = <span class="title class_">Vector3</span>.<span class="title class_">Zero</span>(), max = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>) &#125; =</span><br><span class="line">      bounds</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Vector3</span>(</span><br><span class="line">      min.<span class="property">x</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">x</span> - min.<span class="property">x</span>),</span><br><span class="line">      min.<span class="property">y</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">y</span> - min.<span class="property">y</span>),</span><br><span class="line">      min.<span class="property">z</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">z</span> - min.<span class="property">z</span>),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 生成随机缩放</span></span><br><span class="line">  <span class="title function_">generateRandomScaling</span>(<span class="params">bounds</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; min = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>), max = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1.5</span>, <span class="number">1.5</span>, <span class="number">1.5</span>) &#125; = bounds</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Vector3</span>(</span><br><span class="line">      min.<span class="property">x</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">x</span> - min.<span class="property">x</span>),</span><br><span class="line">      min.<span class="property">y</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">y</span> - min.<span class="property">y</span>),</span><br><span class="line">      min.<span class="property">z</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">z</span> - min.<span class="property">z</span>),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 网格合并</span></span><br><span class="line">  <span class="title function_">mergeMeshes</span>(<span class="params">meshNames, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> meshesToMerge = meshNames.<span class="title function_">map</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(name)).<span class="title function_">filter</span>(<span class="title class_">Boolean</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (meshesToMerge.<span class="property">length</span> &lt; <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;至少需要2个网格进行合并&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mergedMesh = <span class="title class_">Mesh</span>.<span class="title class_">MergeMeshes</span>(</span><br><span class="line">      meshesToMerge,</span><br><span class="line">      options.<span class="property">disposeSource</span> !== <span class="literal">false</span>, <span class="comment">// 默认销毁源网格</span></span><br><span class="line">      options.<span class="property">allow32BitsIndices</span> !== <span class="literal">false</span>, <span class="comment">// 允许32位索引</span></span><br><span class="line">      options.<span class="property">meshSubclass</span> || <span class="literal">undefined</span>,</span><br><span class="line">      options.<span class="property">subdivideWithSubMeshes</span> || <span class="literal">false</span>,</span><br><span class="line">      options.<span class="property">multiMultiMaterials</span> || <span class="literal">false</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mergedMesh) &#123;</span><br><span class="line">      <span class="keyword">const</span> mergedName = options.<span class="property">name</span> || <span class="string">&#x27;merged_&#x27;</span> + meshNames.<span class="title function_">join</span>(<span class="string">&#x27;_&#x27;</span>)</span><br><span class="line">      mergedMesh.<span class="property">name</span> = mergedName</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">mergedMeshes</span>.<span class="title function_">set</span>(mergedName, mergedMesh)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 从原始网格映射中移除已合并的网格</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">disposeSource</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">        meshNames.<span class="title function_">forEach</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">delete</span>(name))</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(mergedName, mergedMesh)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mergedMesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 网格简化</span></span><br><span class="line">  <span class="title function_">simplifyMesh</span>(<span class="params">meshName, settings = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> simplificationSettings = [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">quality</span>: settings.<span class="property">quality</span> || <span class="number">0.5</span>,</span><br><span class="line">        <span class="attr">distance</span>: settings.<span class="property">distance</span> || <span class="number">10</span>,</span><br><span class="line">        <span class="attr">optimizeMesh</span>: settings.<span class="property">optimizeMesh</span> !== <span class="literal">false</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用四边形简化</span></span><br><span class="line">    <span class="keyword">const</span> task = mesh.<span class="title function_">simplify</span>(</span><br><span class="line">      simplificationSettings,</span><br><span class="line">      settings.<span class="property">parallelProcessing</span> !== <span class="literal">false</span>,</span><br><span class="line">      <span class="title class_">SimplificationType</span>.<span class="property">QUADRATIC</span>,</span><br><span class="line">      <span class="function">(<span class="params">simplifiedMesh</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;网格简化完成:&#x27;</span>, meshName)</span><br><span class="line">        <span class="keyword">if</span> (settings.<span class="property">onSuccess</span>) settings.<span class="title function_">onSuccess</span>(simplifiedMesh)</span><br><span class="line">      &#125;,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> task</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 网格优化</span></span><br><span class="line">  <span class="title function_">optimizeMesh</span>(<span class="params">meshName, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 冻结世界矩阵</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">freezeWorldMatrix</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">      mesh.<span class="title function_">freezeWorldMatrix</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 冻结法线</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">freezeNormals</span>) &#123;</span><br><span class="line">      mesh.<span class="title function_">freezeNormals</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置为不可更新</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">makeGeometryUnique</span>) &#123;</span><br><span class="line">      mesh.<span class="title function_">makeGeometryUnique</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转换为实例化</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">convertToInstancedMesh</span> &amp;&amp; mesh.<span class="property">instances</span>.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 创建单个实例以启用实例化优化</span></span><br><span class="line">      <span class="keyword">const</span> instance = mesh.<span class="title function_">createInstance</span>(mesh.<span class="property">name</span> + <span class="string">&#x27;_instance_0&#x27;</span>)</span><br><span class="line">      instance.<span class="property">position</span> = mesh.<span class="property">position</span>.<span class="title function_">clone</span>()</span><br><span class="line">      instance.<span class="property">rotation</span> = mesh.<span class="property">rotation</span>.<span class="title function_">clone</span>()</span><br><span class="line">      instance.<span class="property">scaling</span> = mesh.<span class="property">scaling</span>.<span class="title function_">clone</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;网格优化完成:&#x27;</span>, meshName)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 网格动画</span></span><br><span class="line">  <span class="title function_">animateMesh</span>(<span class="params">meshName, property, targetValue, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> animation = <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;meshName&#125;</span>_<span class="subst">$&#123;property&#125;</span>`</span>,</span><br><span class="line">      mesh,</span><br><span class="line">      property,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">      mesh[property],</span><br><span class="line">      targetValue,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 网格变形</span></span><br><span class="line">  <span class="title function_">morphMesh</span>(<span class="params">meshName, targetPositions, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> positions = mesh.<span class="title function_">getVerticesData</span>(<span class="title class_">VertexBuffer</span>.<span class="property">PositionKind</span>)</span><br><span class="line">    <span class="keyword">if</span> (!positions || positions.<span class="property">length</span> !== targetPositions.<span class="property">length</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;目标位置数据长度不匹配&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建变形动画</span></span><br><span class="line">    <span class="keyword">const</span> morphAnimation = <span class="keyword">new</span> <span class="title class_">Animation</span>(</span><br><span class="line">      <span class="string">&#x27;meshMorph&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;position&#x27;</span>,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> frameCount = (duration / <span class="number">1000</span>) * <span class="number">30</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= frameCount; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> progress = i / frameCount</span><br><span class="line">      <span class="keyword">const</span> interpolatedPositions = []</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; positions.<span class="property">length</span>; j += <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> startPos = <span class="keyword">new</span> <span class="title class_">Vector3</span>(positions[j], positions[j + <span class="number">1</span>], positions[j + <span class="number">2</span>])</span><br><span class="line">        <span class="keyword">const</span> endPos = <span class="keyword">new</span> <span class="title class_">Vector3</span>(</span><br><span class="line">          targetPositions[j],</span><br><span class="line">          targetPositions[j + <span class="number">1</span>],</span><br><span class="line">          targetPositions[j + <span class="number">2</span>],</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">const</span> interpolated = <span class="title class_">Vector3</span>.<span class="title class_">Lerp</span>(startPos, endPos, progress)</span><br><span class="line"></span><br><span class="line">        interpolatedPositions.<span class="title function_">push</span>(interpolated.<span class="property">x</span>, interpolated.<span class="property">y</span>, interpolated.<span class="property">z</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: i,</span><br><span class="line">        <span class="attr">value</span>: interpolatedPositions,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    morphAnimation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行动画</span></span><br><span class="line">    <span class="keyword">const</span> animatable = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">beginDirectAnimation</span>(</span><br><span class="line">      mesh,</span><br><span class="line">      [morphAnimation],</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      frameCount,</span><br><span class="line">      <span class="literal">false</span>,</span><br><span class="line">      <span class="number">1</span>,</span><br><span class="line">      <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 动画完成后更新顶点数据</span></span><br><span class="line">        mesh.<span class="title function_">updateVerticesData</span>(<span class="title class_">VertexBuffer</span>.<span class="property">PositionKind</span>, targetPositions)</span><br><span class="line">        mesh.<span class="title function_">refreshBoundingInfo</span>()</span><br><span class="line">      &#125;,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> animatable</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 网格碰撞检测</span></span><br><span class="line">  <span class="title function_">setupCollision</span>(<span class="params">meshName, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启用碰撞检测</span></span><br><span class="line">    mesh.<span class="property">checkCollisions</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置椭球体碰撞器</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">ellipsoid</span>) &#123;</span><br><span class="line">      mesh.<span class="property">ellipsoid</span> = options.<span class="property">ellipsoid</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置椭球体偏移</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">ellipsoidOffset</span>) &#123;</span><br><span class="line">      mesh.<span class="property">ellipsoidOffset</span> = options.<span class="property">ellipsoidOffset</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 移动碰撞回调</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">onCollide</span>) &#123;</span><br><span class="line">      mesh.<span class="property">onCollide</span> = options.<span class="property">onCollide</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 碰撞位置回调</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">onCollisionPositionChange</span>) &#123;</span><br><span class="line">      mesh.<span class="property">onCollisionPositionChange</span> = options.<span class="property">onCollisionPositionChange</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 网格物理设置</span></span><br><span class="line">  <span class="title function_">setupPhysics</span>(<span class="params">meshName, impostor, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> physicsOptions = &#123;</span><br><span class="line">      <span class="attr">mass</span>: options.<span class="property">mass</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">restitution</span>: options.<span class="property">restitution</span> || <span class="number">0.7</span>,</span><br><span class="line">      <span class="attr">friction</span>: options.<span class="property">friction</span> || <span class="number">0.2</span>,</span><br><span class="line">      ...options,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mesh.<span class="property">physicsImpostor</span> = <span class="keyword">new</span> <span class="title class_">PhysicsImpostor</span>(mesh, impostor, physicsOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh.<span class="property">physicsImpostor</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 网格LOD系统</span></span><br><span class="line">  <span class="title function_">setupLOD</span>(<span class="params">meshName, lodMeshes</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// lodMeshes: [&#123; distance: number, mesh: string &#125;, ...]</span></span><br><span class="line">    lodMeshes.<span class="title function_">forEach</span>(<span class="function">(<span class="params">lod</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> lodMesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(lod.<span class="property">mesh</span>)</span><br><span class="line">      <span class="keyword">if</span> (lodMesh) &#123;</span><br><span class="line">        mesh.<span class="title function_">addLODLevel</span>(lod.<span class="property">distance</span>, lodMesh)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加完全隐藏级别</span></span><br><span class="line">    <span class="keyword">if</span> (lodMeshes.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> maxDistance = <span class="title class_">Math</span>.<span class="title function_">max</span>(...lodMeshes.<span class="title function_">map</span>(<span class="function">(<span class="params">lod</span>) =&gt;</span> lod.<span class="property">distance</span>))</span><br><span class="line">      mesh.<span class="title function_">addLODLevel</span>(maxDistance * <span class="number">2</span>, <span class="literal">null</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取网格信息</span></span><br><span class="line">  <span class="title function_">getMeshInfo</span>(<span class="params">meshName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> info = &#123;</span><br><span class="line">      <span class="attr">name</span>: meshName,</span><br><span class="line">      <span class="attr">id</span>: mesh.<span class="property">id</span>,</span><br><span class="line">      <span class="attr">uniqueId</span>: mesh.<span class="property">uniqueId</span>,</span><br><span class="line">      <span class="attr">position</span>: mesh.<span class="property">position</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">rotation</span>: mesh.<span class="property">rotation</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">scaling</span>: mesh.<span class="property">scaling</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">visibility</span>: mesh.<span class="property">visibility</span>,</span><br><span class="line">      <span class="attr">isVisible</span>: mesh.<span class="property">isVisible</span>,</span><br><span class="line">      <span class="attr">isEnabled</span>: mesh.<span class="title function_">isEnabled</span>(),</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 几何信息</span></span><br><span class="line">      <span class="attr">totalVertices</span>: mesh.<span class="title function_">getTotalVertices</span>(),</span><br><span class="line">      <span class="attr">totalIndices</span>: mesh.<span class="title function_">getTotalIndices</span>(),</span><br><span class="line">      <span class="attr">boundingInfo</span>: &#123;</span><br><span class="line">        <span class="attr">boundingBox</span>: mesh.<span class="title function_">getBoundingInfo</span>().<span class="property">boundingBox</span>,</span><br><span class="line">        <span class="attr">boundingSphere</span>: mesh.<span class="title function_">getBoundingInfo</span>().<span class="property">boundingSphere</span>,</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 材质信息</span></span><br><span class="line">      <span class="attr">material</span>: mesh.<span class="property">material</span> ? mesh.<span class="property">material</span>.<span class="property">name</span> : <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 实例信息</span></span><br><span class="line">      <span class="attr">hasInstances</span>: mesh.<span class="property">instances</span>.<span class="property">length</span> &gt; <span class="number">0</span>,</span><br><span class="line">      <span class="attr">instanceCount</span>: mesh.<span class="property">instances</span>.<span class="property">length</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 物理信息</span></span><br><span class="line">      <span class="attr">hasPhysics</span>: !!mesh.<span class="property">physicsImpostor</span>,</span><br><span class="line">      <span class="attr">checkCollisions</span>: mesh.<span class="property">checkCollisions</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// LOD信息</span></span><br><span class="line">      <span class="attr">hasLODLevels</span>: mesh.<span class="title function_">getLODLevels</span>().<span class="property">length</span> &gt; <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 性能信息</span></span><br><span class="line">      <span class="attr">isWorldMatrixFrozen</span>: mesh.<span class="property">isWorldMatrixFrozen</span>,</span><br><span class="line">      <span class="attr">doNotSyncBoundingInfo</span>: mesh.<span class="property">doNotSyncBoundingInfo</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 网格搜索和过滤</span></span><br><span class="line">  <span class="title function_">findMeshes</span>(<span class="params">filter</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> results = []</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh, name</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> match = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (filter.<span class="property">name</span> &amp;&amp; !name.<span class="title function_">includes</span>(filter.<span class="property">name</span>)) match = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">if</span> (filter.<span class="property">tag</span> &amp;&amp; (!mesh.<span class="property">metadata</span> || !mesh.<span class="property">metadata</span>.<span class="property">tag</span> || mesh.<span class="property">metadata</span>.<span class="property">tag</span> !== filter.<span class="property">tag</span>))</span><br><span class="line">        match = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">if</span> (filter.<span class="property">material</span> &amp;&amp; (!mesh.<span class="property">material</span> || mesh.<span class="property">material</span>.<span class="property">name</span> !== filter.<span class="property">material</span>))</span><br><span class="line">        match = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">if</span> (filter.<span class="property">hasPhysics</span> !== <span class="literal">undefined</span> &amp;&amp; !!mesh.<span class="property">physicsImpostor</span> !== filter.<span class="property">hasPhysics</span>)</span><br><span class="line">        match = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">if</span> (filter.<span class="property">isVisible</span> !== <span class="literal">undefined</span> &amp;&amp; mesh.<span class="property">isVisible</span> !== filter.<span class="property">isVisible</span>) match = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (match) &#123;</span><br><span class="line">        results.<span class="title function_">push</span>(&#123; name, mesh &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 批量操作</span></span><br><span class="line">  <span class="title function_">batchOperation</span>(<span class="params">meshNames, operation, ...args</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> results = []</span><br><span class="line"></span><br><span class="line">    meshNames.<span class="title function_">forEach</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(name)</span><br><span class="line">      <span class="keyword">if</span> (mesh &amp;&amp; <span class="keyword">typeof</span> mesh[operation] === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> result = mesh[operation](...args)</span><br><span class="line">        results.<span class="title function_">push</span>(&#123; name, result &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 保存网格设置</span></span><br><span class="line">  <span class="title function_">saveMeshSetup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> setup = &#123;</span><br><span class="line">      <span class="attr">meshes</span>: [],</span><br><span class="line">      <span class="attr">instances</span>: [],</span><br><span class="line">      <span class="attr">merged</span>: [],</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh, name</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">meshes</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: name,</span><br><span class="line">        ...<span class="variable language_">this</span>.<span class="title function_">getMeshInfo</span>(name),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">instancedMeshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">instances, sourceName</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">instances</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">sourceName</span>: sourceName,</span><br><span class="line">        <span class="attr">count</span>: instances.<span class="property">length</span>,</span><br><span class="line">        <span class="attr">instances</span>: instances.<span class="title function_">map</span>(<span class="function">(<span class="params">instance</span>) =&gt;</span> (&#123;</span><br><span class="line">          <span class="attr">position</span>: instance.<span class="property">position</span>,</span><br><span class="line">          <span class="attr">rotation</span>: instance.<span class="property">rotation</span>,</span><br><span class="line">          <span class="attr">scaling</span>: instance.<span class="property">scaling</span>,</span><br><span class="line">        &#125;)),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mergedMeshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh, name</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">merged</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: name,</span><br><span class="line">        <span class="attr">info</span>: <span class="variable language_">this</span>.<span class="title function_">getMeshInfo</span>(name),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> setup</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 资源清理</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">instancedMeshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">instances</span>) =&gt;</span> &#123;</span><br><span class="line">      instances.<span class="title function_">forEach</span>(<span class="function">(<span class="params">instance</span>) =&gt;</span> instance.<span class="title function_">dispose</span>())</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">instancedMeshes</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mergedMeshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      mesh.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mergedMeshes</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      mesh.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> meshManager = <span class="keyword">new</span> <span class="title class_">MeshManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建基础几何体</span></span><br><span class="line"><span class="keyword">const</span> box = meshManager.<span class="title function_">createBox</span>(<span class="string">&#x27;myBox&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">size</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">position</span>: <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">  <span class="attr">material</span>: someMaterial,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sphere = meshManager.<span class="title function_">createSphere</span>(<span class="string">&#x27;mySphere&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">diameter</span>: <span class="number">1.5</span>,</span><br><span class="line">  <span class="attr">segments</span>: <span class="number">32</span>,</span><br><span class="line">  <span class="attr">position</span>: <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建实例化网格</span></span><br><span class="line"><span class="keyword">const</span> treeInstances = meshManager.<span class="title function_">createInstances</span>(<span class="string">&#x27;tree&#x27;</span>, <span class="number">100</span>, &#123;</span><br><span class="line">  <span class="attr">randomPosition</span>: &#123;</span><br><span class="line">    <span class="attr">min</span>: <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">50</span>, <span class="number">0</span>, -<span class="number">50</span>),</span><br><span class="line">    <span class="attr">max</span>: <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">50</span>, <span class="number">0</span>, <span class="number">50</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">randomRotation</span>: &#123;</span><br><span class="line">    <span class="attr">min</span>: <span class="title class_">Vector3</span>.<span class="title class_">Zero</span>(),</span><br><span class="line">    <span class="attr">max</span>: <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>, <span class="number">0</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">randomScaling</span>: &#123;</span><br><span class="line">    <span class="attr">min</span>: <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0.8</span>, <span class="number">0.8</span>, <span class="number">0.8</span>),</span><br><span class="line">    <span class="attr">max</span>: <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1.2</span>, <span class="number">1.2</span>, <span class="number">1.2</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置物理属性</span></span><br><span class="line">meshManager.<span class="title function_">setupPhysics</span>(<span class="string">&#x27;myBox&#x27;</span>, <span class="title class_">PhysicsImpostor</span>.<span class="property">BoxImpostor</span>, &#123;</span><br><span class="line">  <span class="attr">mass</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">restitution</span>: <span class="number">0.8</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 网格动画</span></span><br><span class="line">meshManager.<span class="title function_">animateMesh</span>(<span class="string">&#x27;mySphere&#x27;</span>, <span class="string">&#x27;position.y&#x27;</span>, <span class="number">5</span>, <span class="number">3000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 合并网格</span></span><br><span class="line"><span class="keyword">const</span> mergedMesh = meshManager.<span class="title function_">mergeMeshes</span>([<span class="string">&#x27;box1&#x27;</span>, <span class="string">&#x27;box2&#x27;</span>, <span class="string">&#x27;box3&#x27;</span>], &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;combinedBoxes&#x27;</span>,</span><br><span class="line">  <span class="attr">disposeSource</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="🎬-Animation-动画系统详解"><a href="#🎬-Animation-动画系统详解" class="headerlink" title="🎬 Animation 动画系统详解"></a>🎬 Animation 动画系统详解</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Animation 动画系统完整管理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AnimationManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animations</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animationGroups</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animatables</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupDefaultAnimations</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupDefaultAnimations</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 预定义常用动画类型</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animationTypes</span> = &#123;</span><br><span class="line">      <span class="attr">FLOAT</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_FLOAT</span>,</span><br><span class="line">      <span class="title class_">VECTOR2</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR2</span>,</span><br><span class="line">      <span class="title class_">VECTOR3</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      <span class="title class_">COLOR3</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_COLOR3</span>,</span><br><span class="line">      <span class="title class_">COLOR4</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_COLOR4</span>,</span><br><span class="line">      <span class="attr">QUATERNION</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_QUATERNION</span>,</span><br><span class="line">      <span class="attr">MATRIX</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_MATRIX</span>,</span><br><span class="line">      <span class="attr">SIZE</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_SIZE</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 预定义循环模式</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loopModes</span> = &#123;</span><br><span class="line">      <span class="attr">RELATIVE</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_RELATIVE</span>,</span><br><span class="line">      <span class="attr">CYCLE</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">      <span class="attr">CONSTANT</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建基础动画</span></span><br><span class="line">  <span class="title function_">createAnimation</span>(<span class="params">name, targetProperty, frameRate, animationType, loopMode</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="keyword">new</span> <span class="title class_">Animation</span>(</span><br><span class="line">      name,</span><br><span class="line">      targetProperty,</span><br><span class="line">      frameRate || <span class="number">30</span>,</span><br><span class="line">      animationType || <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_FLOAT</span>,</span><br><span class="line">      loopMode || <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animations</span>.<span class="title function_">set</span>(name, animation)</span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 位置动画</span></span><br><span class="line">  <span class="title function_">createPositionAnimation</span>(<span class="params">name, positions, frameRate = <span class="number">30</span>, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="string">&#x27;position&#x27;</span>,</span><br><span class="line">      frameRate,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * frameRate</span><br><span class="line"></span><br><span class="line">    positions.<span class="title function_">forEach</span>(<span class="function">(<span class="params">position, index</span>) =&gt;</span> &#123;</span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: (totalFrames / (positions.<span class="property">length</span> - <span class="number">1</span>)) * index,</span><br><span class="line">        <span class="attr">value</span>: position,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    animation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置缓动函数</span></span><br><span class="line">    animation.<span class="title function_">setEasingFunction</span>(<span class="keyword">new</span> <span class="title class_">CubicEase</span>())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 旋转动画</span></span><br><span class="line">  <span class="title function_">createRotationAnimation</span>(<span class="params">name, rotations, frameRate = <span class="number">30</span>, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="string">&#x27;rotation&#x27;</span>,</span><br><span class="line">      frameRate,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * frameRate</span><br><span class="line"></span><br><span class="line">    rotations.<span class="title function_">forEach</span>(<span class="function">(<span class="params">rotation, index</span>) =&gt;</span> &#123;</span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: (totalFrames / (rotations.<span class="property">length</span> - <span class="number">1</span>)) * index,</span><br><span class="line">        <span class="attr">value</span>: rotation,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    animation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 缩放动画</span></span><br><span class="line">  <span class="title function_">createScalingAnimation</span>(<span class="params">name, scalings, frameRate = <span class="number">30</span>, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="string">&#x27;scaling&#x27;</span>,</span><br><span class="line">      frameRate,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * frameRate</span><br><span class="line"></span><br><span class="line">    scalings.<span class="title function_">forEach</span>(<span class="function">(<span class="params">scaling, index</span>) =&gt;</span> &#123;</span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: (totalFrames / (scalings.<span class="property">length</span> - <span class="number">1</span>)) * index,</span><br><span class="line">        <span class="attr">value</span>: scaling,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    animation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 透明度动画</span></span><br><span class="line">  <span class="title function_">createAlphaAnimation</span>(<span class="params">name, alphaValues, frameRate = <span class="number">30</span>, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="string">&#x27;visibility&#x27;</span>,</span><br><span class="line">      frameRate,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_FLOAT</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * frameRate</span><br><span class="line"></span><br><span class="line">    alphaValues.<span class="title function_">forEach</span>(<span class="function">(<span class="params">alpha, index</span>) =&gt;</span> &#123;</span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: (totalFrames / (alphaValues.<span class="property">length</span> - <span class="number">1</span>)) * index,</span><br><span class="line">        <span class="attr">value</span>: alpha,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    animation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 颜色动画（材质）</span></span><br><span class="line">  <span class="title function_">createColorAnimation</span>(<span class="params">name, colors, frameRate = <span class="number">30</span>, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="string">&#x27;material.diffuseColor&#x27;</span>,</span><br><span class="line">      frameRate,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_COLOR3</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * frameRate</span><br><span class="line"></span><br><span class="line">    colors.<span class="title function_">forEach</span>(<span class="function">(<span class="params">color, index</span>) =&gt;</span> &#123;</span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: (totalFrames / (colors.<span class="property">length</span> - <span class="number">1</span>)) * index,</span><br><span class="line">        <span class="attr">value</span>: color,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    animation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 纹理偏移动画</span></span><br><span class="line">  <span class="title function_">createTextureOffsetAnimation</span>(<span class="params">name, property = <span class="string">&#x27;uOffset&#x27;</span>, speed = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="string">`material.diffuseTexture.<span class="subst">$&#123;property&#125;</span>`</span>,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_FLOAT</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = [</span><br><span class="line">      &#123; <span class="attr">frame</span>: <span class="number">0</span>, <span class="attr">value</span>: <span class="number">0</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">frame</span>: <span class="number">30</span>, <span class="attr">value</span>: speed &#125;,</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    animation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 相机动画</span></span><br><span class="line">  <span class="title function_">createCameraAnimation</span>(<span class="params">camera, targetPosition, targetTarget, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animationGroup = <span class="keyword">new</span> <span class="title class_">AnimationGroup</span>(<span class="string">&#x27;cameraAnimation&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 位置动画</span></span><br><span class="line">    <span class="keyword">const</span> positionAnimation = <span class="variable language_">this</span>.<span class="title function_">createPositionAnimation</span>(</span><br><span class="line">      <span class="string">&#x27;cameraPosition&#x27;</span>,</span><br><span class="line">      [camera.<span class="property">position</span>.<span class="title function_">clone</span>(), targetPosition],</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      duration,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 目标动画（对于FreeCamera）</span></span><br><span class="line">    <span class="keyword">if</span> (camera <span class="keyword">instanceof</span> <span class="title class_">FreeCamera</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> targetAnimation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraTarget&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;target&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      targetAnimation.<span class="title function_">setKeys</span>([</span><br><span class="line">        &#123; <span class="attr">frame</span>: <span class="number">0</span>, <span class="attr">value</span>: camera.<span class="title function_">getTarget</span>().<span class="title function_">clone</span>() &#125;,</span><br><span class="line">        &#123; <span class="attr">frame</span>: (duration / <span class="number">1000</span>) * <span class="number">30</span>, <span class="attr">value</span>: targetTarget &#125;,</span><br><span class="line">      ])</span><br><span class="line"></span><br><span class="line">      animationGroup.<span class="title function_">addTargetedAnimation</span>(targetAnimation, camera)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ArcRotateCamera特殊处理</span></span><br><span class="line">    <span class="keyword">if</span> (camera <span class="keyword">instanceof</span> <span class="title class_">ArcRotateCamera</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> direction = targetPosition.<span class="title function_">subtract</span>(targetTarget)</span><br><span class="line">      <span class="keyword">const</span> radius = direction.<span class="title function_">length</span>()</span><br><span class="line">      <span class="keyword">const</span> alpha = <span class="title class_">Math</span>.<span class="title function_">atan2</span>(direction.<span class="property">x</span>, direction.<span class="property">z</span>)</span><br><span class="line">      <span class="keyword">const</span> beta = <span class="title class_">Math</span>.<span class="title function_">acos</span>(direction.<span class="property">y</span> / radius)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> alphaAnimation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraAlpha&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;alpha&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_FLOAT</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> betaAnimation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraBeta&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;beta&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_FLOAT</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> radiusAnimation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraRadius&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;radius&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_FLOAT</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> targetAnimation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraTarget&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;target&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * <span class="number">30</span></span><br><span class="line"></span><br><span class="line">      alphaAnimation.<span class="title function_">setKeys</span>([</span><br><span class="line">        &#123; <span class="attr">frame</span>: <span class="number">0</span>, <span class="attr">value</span>: camera.<span class="property">alpha</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">frame</span>: totalFrames, <span class="attr">value</span>: alpha &#125;,</span><br><span class="line">      ])</span><br><span class="line"></span><br><span class="line">      betaAnimation.<span class="title function_">setKeys</span>([</span><br><span class="line">        &#123; <span class="attr">frame</span>: <span class="number">0</span>, <span class="attr">value</span>: camera.<span class="property">beta</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">frame</span>: totalFrames, <span class="attr">value</span>: beta &#125;,</span><br><span class="line">      ])</span><br><span class="line"></span><br><span class="line">      radiusAnimation.<span class="title function_">setKeys</span>([</span><br><span class="line">        &#123; <span class="attr">frame</span>: <span class="number">0</span>, <span class="attr">value</span>: camera.<span class="property">radius</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">frame</span>: totalFrames, <span class="attr">value</span>: radius &#125;,</span><br><span class="line">      ])</span><br><span class="line"></span><br><span class="line">      targetAnimation.<span class="title function_">setKeys</span>([</span><br><span class="line">        &#123; <span class="attr">frame</span>: <span class="number">0</span>, <span class="attr">value</span>: camera.<span class="property">target</span>.<span class="title function_">clone</span>() &#125;,</span><br><span class="line">        &#123; <span class="attr">frame</span>: totalFrames, <span class="attr">value</span>: targetTarget &#125;,</span><br><span class="line">      ])</span><br><span class="line"></span><br><span class="line">      animationGroup.<span class="title function_">addTargetedAnimation</span>(alphaAnimation, camera)</span><br><span class="line">      animationGroup.<span class="title function_">addTargetedAnimation</span>(betaAnimation, camera)</span><br><span class="line">      animationGroup.<span class="title function_">addTargetedAnimation</span>(radiusAnimation, camera)</span><br><span class="line">      animationGroup.<span class="title function_">addTargetedAnimation</span>(targetAnimation, camera)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    animationGroup.<span class="title function_">addTargetedAnimation</span>(positionAnimation, camera)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">set</span>(<span class="string">&#x27;cameraAnimation&#x27;</span>, animationGroup)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> animationGroup</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 骨骼动画</span></span><br><span class="line">  <span class="title function_">createSkeletonAnimation</span>(<span class="params">skeleton, animationName</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!skeleton || !skeleton.<span class="property">animations</span>) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> skeletonAnimation = skeleton.<span class="property">animations</span>.<span class="title function_">find</span>(<span class="function">(<span class="params">anim</span>) =&gt;</span> anim.<span class="property">name</span> === animationName)</span><br><span class="line">    <span class="keyword">if</span> (!skeletonAnimation) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`骨骼动画 <span class="subst">$&#123;animationName&#125;</span> 未找到`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> skeletonAnimation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 变形目标动画</span></span><br><span class="line">  <span class="title function_">createMorphTargetAnimation</span>(<span class="params">mesh, morphTargetIndex, influences, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!mesh.<span class="property">morphTargetManager</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;网格没有变形目标管理器&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">      <span class="string">`morphTarget_<span class="subst">$&#123;morphTargetIndex&#125;</span>`</span>,</span><br><span class="line">      <span class="string">`morphTargetManager.getTarget(<span class="subst">$&#123;morphTargetIndex&#125;</span>).influence`</span>,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_FLOAT</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * <span class="number">30</span></span><br><span class="line"></span><br><span class="line">    influences.<span class="title function_">forEach</span>(<span class="function">(<span class="params">influence, index</span>) =&gt;</span> &#123;</span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: (totalFrames / (influences.<span class="property">length</span> - <span class="number">1</span>)) * index,</span><br><span class="line">        <span class="attr">value</span>: influence,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    animation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 路径动画</span></span><br><span class="line">  <span class="title function_">createPathAnimation</span>(<span class="params">name, path, duration = <span class="number">5000</span>, loop = <span class="literal">true</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="string">&#x27;position&#x27;</span>,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      loop ? <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span> : <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * <span class="number">30</span></span><br><span class="line"></span><br><span class="line">    path.<span class="title function_">forEach</span>(<span class="function">(<span class="params">point, index</span>) =&gt;</span> &#123;</span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: (totalFrames / (path.<span class="property">length</span> - <span class="number">1</span>)) * index,</span><br><span class="line">        <span class="attr">value</span>: point,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    animation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加插值器以平滑路径</span></span><br><span class="line">    animation.<span class="title function_">setEasingFunction</span>(<span class="keyword">new</span> <span class="title class_">BezierCurveEase</span>(<span class="number">0.25</span>, <span class="number">0.1</span>, <span class="number">0.25</span>, <span class="number">1.0</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 动画组管理</span></span><br><span class="line">  <span class="title function_">createAnimationGroup</span>(<span class="params">name, targetedAnimations = []</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animationGroup = <span class="keyword">new</span> <span class="title class_">AnimationGroup</span>(name, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    targetedAnimations.<span class="title function_">forEach</span>(<span class="function">(<span class="params">&#123; animation, target &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      animationGroup.<span class="title function_">addTargetedAnimation</span>(animation, target)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">set</span>(name, animationGroup)</span><br><span class="line">    <span class="keyword">return</span> animationGroup</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 播放动画</span></span><br><span class="line">  <span class="title function_">playAnimation</span>(<span class="params">target, animationName, loop = <span class="literal">true</span>, speed = <span class="number">1.0</span>, onComplete = <span class="literal">null</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="property">animations</span>.<span class="title function_">get</span>(animationName)</span><br><span class="line">    <span class="keyword">if</span> (!animation) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`动画 <span class="subst">$&#123;animationName&#125;</span> 未找到`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 停止现有动画</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">stopAnimation</span>(target)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开始新动画</span></span><br><span class="line">    <span class="keyword">const</span> animatable = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">beginAnimation</span>(</span><br><span class="line">      target,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      animation.<span class="title function_">getKeys</span>()[animation.<span class="title function_">getKeys</span>().<span class="property">length</span> - <span class="number">1</span>].<span class="property">frame</span>,</span><br><span class="line">      loop,</span><br><span class="line">      speed,</span><br><span class="line">      onComplete,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animatables</span>.<span class="title function_">set</span>(<span class="string">`<span class="subst">$&#123;target.name&#125;</span>_<span class="subst">$&#123;animationName&#125;</span>`</span>, animatable)</span><br><span class="line">    <span class="keyword">return</span> animatable</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 播放动画组</span></span><br><span class="line">  <span class="title function_">playAnimationGroup</span>(<span class="params">groupName, loop = <span class="literal">true</span>, speed = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> group = <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">get</span>(groupName)</span><br><span class="line">    <span class="keyword">if</span> (!group) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`动画组 <span class="subst">$&#123;groupName&#125;</span> 未找到`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    group.<span class="title function_">play</span>(loop)</span><br><span class="line">    group.<span class="property">speedRatio</span> = speed</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> group</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 暂停动画</span></span><br><span class="line">  <span class="title function_">pauseAnimation</span>(<span class="params">target, animationName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = <span class="string">`<span class="subst">$&#123;target.name&#125;</span>_<span class="subst">$&#123;animationName&#125;</span>`</span></span><br><span class="line">    <span class="keyword">const</span> animatable = <span class="variable language_">this</span>.<span class="property">animatables</span>.<span class="title function_">get</span>(key)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (animatable) &#123;</span><br><span class="line">      animatable.<span class="title function_">pause</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 恢复动画</span></span><br><span class="line">  <span class="title function_">resumeAnimation</span>(<span class="params">target, animationName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = <span class="string">`<span class="subst">$&#123;target.name&#125;</span>_<span class="subst">$&#123;animationName&#125;</span>`</span></span><br><span class="line">    <span class="keyword">const</span> animatable = <span class="variable language_">this</span>.<span class="property">animatables</span>.<span class="title function_">get</span>(key)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (animatable) &#123;</span><br><span class="line">      animatable.<span class="title function_">restart</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 停止动画</span></span><br><span class="line">  <span class="title function_">stopAnimation</span>(<span class="params">target, animationName = <span class="literal">null</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (animationName) &#123;</span><br><span class="line">      <span class="keyword">const</span> key = <span class="string">`<span class="subst">$&#123;target.name&#125;</span>_<span class="subst">$&#123;animationName&#125;</span>`</span></span><br><span class="line">      <span class="keyword">const</span> animatable = <span class="variable language_">this</span>.<span class="property">animatables</span>.<span class="title function_">get</span>(key)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (animatable) &#123;</span><br><span class="line">        animatable.<span class="title function_">stop</span>()</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">animatables</span>.<span class="title function_">delete</span>(key)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 停止目标对象的所有动画</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">stopAnimation</span>(target)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 清理相关的animatable记录</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> [key, animatable] <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">animatables</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key.<span class="title function_">startsWith</span>(target.<span class="property">name</span> + <span class="string">&#x27;_&#x27;</span>)) &#123;</span><br><span class="line">          animatable.<span class="title function_">stop</span>()</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">animatables</span>.<span class="title function_">delete</span>(key)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 缓动函数</span></span><br><span class="line">  <span class="title function_">createEasingFunction</span>(<span class="params">type, ...params</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;linear&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span> <span class="comment">// 默认线性</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;cubic&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CubicEase</span>()</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;quadratic&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">QuadraticEase</span>()</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;quartic&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">QuarticEase</span>()</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;quintic&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">QuinticEase</span>()</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;sine&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SineEase</span>()</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;exponential&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ExponentialEase</span>()</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;circle&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CircleEase</span>()</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;back&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BackEase</span>(params[<span class="number">0</span>] || <span class="number">1.7</span>)</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;elastic&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ElasticEase</span>(params[<span class="number">0</span>] || <span class="number">3</span>, params[<span class="number">1</span>] || <span class="number">1</span>)</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;bounce&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BounceEase</span>(params[<span class="number">0</span>] || <span class="number">3</span>, params[<span class="number">1</span>] || <span class="number">2</span>)</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;bezier&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BezierCurveEase</span>(</span><br><span class="line">          params[<span class="number">0</span>] || <span class="number">0.25</span>,</span><br><span class="line">          params[<span class="number">1</span>] || <span class="number">0.1</span>,</span><br><span class="line">          params[<span class="number">2</span>] || <span class="number">0.25</span>,</span><br><span class="line">          params[<span class="number">3</span>] || <span class="number">1.0</span>,</span><br><span class="line">        )</span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CubicEase</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 动画事件</span></span><br><span class="line">  <span class="title function_">addAnimationEvent</span>(<span class="params">animation, frame, action</span>) &#123;</span><br><span class="line">    animation.<span class="title function_">addEvent</span>(</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">AnimationEvent</span>(</span><br><span class="line">        frame,</span><br><span class="line">        action,</span><br><span class="line">        <span class="literal">false</span>, <span class="comment">// 只执行一次</span></span><br><span class="line">      ),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取动画信息</span></span><br><span class="line">  <span class="title function_">getAnimationInfo</span>(<span class="params">animationName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="property">animations</span>.<span class="title function_">get</span>(animationName)</span><br><span class="line">    <span class="keyword">if</span> (!animation) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = animation.<span class="title function_">getKeys</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">name</span>: animationName,</span><br><span class="line">      <span class="attr">targetProperty</span>: animation.<span class="property">targetProperty</span>,</span><br><span class="line">      <span class="attr">framePerSecond</span>: animation.<span class="property">framePerSecond</span>,</span><br><span class="line">      <span class="attr">dataType</span>: animation.<span class="property">dataType</span>,</span><br><span class="line">      <span class="attr">loopMode</span>: animation.<span class="property">loopBehavior</span>,</span><br><span class="line">      <span class="attr">keyFrameCount</span>: keys.<span class="property">length</span>,</span><br><span class="line">      <span class="attr">duration</span>: keys.<span class="property">length</span> &gt; <span class="number">0</span> ? keys[keys.<span class="property">length</span> - <span class="number">1</span>].<span class="property">frame</span> / animation.<span class="property">framePerSecond</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">hasEasing</span>: !!animation.<span class="title function_">getEasingFunction</span>(),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 从Babylon文件加载动画</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadAnimationsFromFile</span>(<span class="params">url, targetMesh</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> importResult = <span class="keyword">await</span> <span class="title class_">SceneLoader</span>.<span class="title class_">ImportMeshAsync</span>(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, url, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (importResult.<span class="property">animationGroups</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        importResult.<span class="property">animationGroups</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">group</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">set</span>(group.<span class="property">name</span>, group)</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`加载了 <span class="subst">$&#123;importResult.animationGroups.length&#125;</span> 个动画组`</span>)</span><br><span class="line">        <span class="keyword">return</span> importResult.<span class="property">animationGroups</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> []</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;加载动画文件失败:&#x27;</span>, error)</span><br><span class="line">      <span class="keyword">return</span> []</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 混合动画</span></span><br><span class="line">  <span class="title function_">blendAnimations</span>(<span class="params">target, animation1Name, animation2Name, blendFactor</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> anim1 = <span class="variable language_">this</span>.<span class="property">animations</span>.<span class="title function_">get</span>(animation1Name)</span><br><span class="line">    <span class="keyword">const</span> anim2 = <span class="variable language_">this</span>.<span class="property">animations</span>.<span class="title function_">get</span>(animation2Name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!anim1 || !anim2) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;找不到要混合的动画&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里需要自定义混合逻辑</span></span><br><span class="line">    <span class="comment">// BabylonJS的动画混合通常通过AnimationGroup的weight属性实现</span></span><br><span class="line">    <span class="keyword">const</span> group1 = <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">get</span>(animation1Name + <span class="string">&#x27;_group&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> group2 = <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">get</span>(animation2Name + <span class="string">&#x27;_group&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (group1 &amp;&amp; group2) &#123;</span><br><span class="line">      group1.<span class="property">weight</span> = <span class="number">1</span> - blendFactor</span><br><span class="line">      group2.<span class="property">weight</span> = blendFactor</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 保存动画设置</span></span><br><span class="line">  <span class="title function_">saveAnimationSetup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> setup = &#123;</span><br><span class="line">      <span class="attr">animations</span>: [],</span><br><span class="line">      <span class="attr">animationGroups</span>: [],</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animations</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">animation, name</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">animations</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: name,</span><br><span class="line">        ...<span class="variable language_">this</span>.<span class="title function_">getAnimationInfo</span>(name),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">group, name</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">animationGroups</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: name,</span><br><span class="line">        <span class="attr">isPlaying</span>: group.<span class="property">isPlaying</span>,</span><br><span class="line">        <span class="attr">speedRatio</span>: group.<span class="property">speedRatio</span>,</span><br><span class="line">        <span class="attr">weight</span>: group.<span class="property">weight</span>,</span><br><span class="line">        <span class="attr">targetedAnimations</span>: group.<span class="property">targetedAnimations</span>.<span class="property">length</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> setup</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 资源清理</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 停止所有动画</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animatables</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">animatable</span>) =&gt;</span> &#123;</span><br><span class="line">      animatable.<span class="title function_">stop</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animatables</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理动画组</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">group</span>) =&gt;</span> &#123;</span><br><span class="line">      group.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理动画</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animations</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">animation</span>) =&gt;</span> &#123;</span><br><span class="line">      animation.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animations</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> animationManager = <span class="keyword">new</span> <span class="title class_">AnimationManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建位置动画</span></span><br><span class="line"><span class="keyword">const</span> positionAnim = animationManager.<span class="title function_">createPositionAnimation</span>(</span><br><span class="line">  <span class="string">&#x27;boxMove&#x27;</span>,</span><br><span class="line">  [<span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">5</span>, <span class="number">2</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">10</span>, <span class="number">0</span>, <span class="number">5</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)],</span><br><span class="line">  <span class="number">30</span>,</span><br><span class="line">  <span class="number">4000</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加缓动函数</span></span><br><span class="line">positionAnim.<span class="title function_">setEasingFunction</span>(animationManager.<span class="title function_">createEasingFunction</span>(<span class="string">&#x27;bounce&#x27;</span>, <span class="number">3</span>, <span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建旋转动画</span></span><br><span class="line"><span class="keyword">const</span> rotationAnim = animationManager.<span class="title function_">createRotationAnimation</span>(</span><br><span class="line">  <span class="string">&#x27;boxRotate&#x27;</span>,</span><br><span class="line">  [<span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>, <span class="number">0</span>)],</span><br><span class="line">  <span class="number">30</span>,</span><br><span class="line">  <span class="number">3000</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建动画组</span></span><br><span class="line"><span class="keyword">const</span> boxAnimGroup = animationManager.<span class="title function_">createAnimationGroup</span>(<span class="string">&#x27;boxAnimations&#x27;</span>, [</span><br><span class="line">  &#123; <span class="attr">animation</span>: positionAnim, <span class="attr">target</span>: myBox &#125;,</span><br><span class="line">  &#123; <span class="attr">animation</span>: rotationAnim, <span class="attr">target</span>: myBox &#125;,</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment">// 播放动画组</span></span><br><span class="line">animationManager.<span class="title function_">playAnimationGroup</span>(<span class="string">&#x27;boxAnimations&#x27;</span>, <span class="literal">true</span>, <span class="number">1.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 相机动画</span></span><br><span class="line"><span class="keyword">const</span> cameraAnim = animationManager.<span class="title function_">createCameraAnimation</span>(</span><br><span class="line">  scene.<span class="property">activeCamera</span>,</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>),</span><br><span class="line">  <span class="title class_">Vector3</span>.<span class="title class_">Zero</span>(),</span><br><span class="line">  <span class="number">2000</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 播放相机动画</span></span><br><span class="line">animationManager.<span class="title function_">playAnimationGroup</span>(<span class="string">&#x27;cameraAnimation&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="🎆-ParticleSystem-粒子系统详解"><a href="#🎆-ParticleSystem-粒子系统详解" class="headerlink" title="🎆 ParticleSystem 粒子系统详解"></a>🎆 ParticleSystem 粒子系统详解</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ParticleSystem 粒子系统完整管理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ParticleSystemManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">particleSystems</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gpuParticleSystems</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupDefaultParticleSystems</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupDefaultParticleSystems</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 检查GPU粒子系统支持</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">supportsGPUParticles</span> = <span class="title class_">GPUParticleSystem</span>.<span class="property">IsSupported</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;GPU粒子系统支持:&#x27;</span>, <span class="variable language_">this</span>.<span class="property">supportsGPUParticles</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建基础CPU粒子系统</span></span><br><span class="line">  <span class="title function_">createParticleSystem</span>(<span class="params">name, capacity = <span class="number">2000</span>, emitter = <span class="literal">null</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> particleSystem = <span class="keyword">new</span> <span class="title class_">ParticleSystem</span>(name, capacity, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 基础发射器设置</span></span><br><span class="line">    <span class="keyword">if</span> (emitter) &#123;</span><br><span class="line">      particleSystem.<span class="property">emitter</span> = emitter</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      particleSystem.<span class="property">emitter</span> = <span class="title class_">Vector3</span>.<span class="title class_">Zero</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 粒子纹理</span></span><br><span class="line">    particleSystem.<span class="property">particleTexture</span> = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;/textures/flare.png&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发射属性</span></span><br><span class="line">    particleSystem.<span class="property">emitRate</span> = <span class="number">300</span> <span class="comment">// 每秒发射粒子数</span></span><br><span class="line">    particleSystem.<span class="property">maxEmitPower</span> = <span class="number">1.5</span> <span class="comment">// 最大发射力度</span></span><br><span class="line">    particleSystem.<span class="property">minEmitPower</span> = <span class="number">1.0</span> <span class="comment">// 最小发射力度</span></span><br><span class="line">    particleSystem.<span class="property">updateSpeed</span> = <span class="number">0.005</span> <span class="comment">// 更新速度</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生命周期</span></span><br><span class="line">    particleSystem.<span class="property">minLifeTime</span> = <span class="number">0.3</span> <span class="comment">// 最小生命时间</span></span><br><span class="line">    particleSystem.<span class="property">maxLifeTime</span> = <span class="number">1.5</span> <span class="comment">// 最大生命时间</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 尺寸</span></span><br><span class="line">    particleSystem.<span class="property">minSize</span> = <span class="number">0.1</span> <span class="comment">// 最小尺寸</span></span><br><span class="line">    particleSystem.<span class="property">maxSize</span> = <span class="number">0.5</span> <span class="comment">// 最大尺寸</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 角度范围</span></span><br><span class="line">    particleSystem.<span class="property">minAngularSpeed</span> = <span class="number">0</span> <span class="comment">// 最小角速度</span></span><br><span class="line">    particleSystem.<span class="property">maxAngularSpeed</span> = <span class="title class_">Math</span>.<span class="property">PI</span> <span class="comment">// 最大角速度</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 方向</span></span><br><span class="line">    particleSystem.<span class="property">direction1</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">7</span>, <span class="number">8</span>, <span class="number">3</span>) <span class="comment">// 方向1</span></span><br><span class="line">    particleSystem.<span class="property">direction2</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">7</span>, <span class="number">8</span>, -<span class="number">3</span>) <span class="comment">// 方向2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重力</span></span><br><span class="line">    particleSystem.<span class="property">gravity</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, -<span class="number">9.81</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 颜色变化</span></span><br><span class="line">    particleSystem.<span class="property">color1</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.7</span>, <span class="number">0.8</span>, <span class="number">1.0</span>, <span class="number">1.0</span>) <span class="comment">// 起始颜色</span></span><br><span class="line">    particleSystem.<span class="property">color2</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.2</span>, <span class="number">0.5</span>, <span class="number">1.0</span>, <span class="number">1.0</span>) <span class="comment">// 中间颜色</span></span><br><span class="line">    particleSystem.<span class="property">colorDead</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.2</span>, <span class="number">0.0</span>) <span class="comment">// 消失颜色</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发射形状</span></span><br><span class="line">    particleSystem.<span class="property">minEmitBox</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>) <span class="comment">// 发射盒最小值</span></span><br><span class="line">    particleSystem.<span class="property">maxEmitBox</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>) <span class="comment">// 发射盒最大值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 混合模式</span></span><br><span class="line">    particleSystem.<span class="property">blendMode</span> = <span class="title class_">ParticleSystem</span>.<span class="property">BLENDMODE_ONEONE</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">particleSystems</span>.<span class="title function_">set</span>(name, particleSystem)</span><br><span class="line">    <span class="keyword">return</span> particleSystem</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建GPU粒子系统</span></span><br><span class="line">  <span class="title function_">createGPUParticleSystem</span>(<span class="params">name, capacity = <span class="number">50000</span>, emitter = <span class="literal">null</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">supportsGPUParticles</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;当前设备不支持GPU粒子系统，使用CPU粒子系统代替&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">createParticleSystem</span>(name, <span class="title class_">Math</span>.<span class="title function_">min</span>(capacity, <span class="number">5000</span>), emitter)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> particleSystem = <span class="keyword">new</span> <span class="title class_">GPUParticleSystem</span>(name, &#123; <span class="attr">capacity</span>: capacity &#125;, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 基础发射器设置</span></span><br><span class="line">    <span class="keyword">if</span> (emitter) &#123;</span><br><span class="line">      particleSystem.<span class="property">emitter</span> = emitter</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      particleSystem.<span class="property">emitter</span> = <span class="title class_">Vector3</span>.<span class="title class_">Zero</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 粒子纹理</span></span><br><span class="line">    particleSystem.<span class="property">particleTexture</span> = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;/textures/flare.png&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// GPU特有的发射属性</span></span><br><span class="line">    particleSystem.<span class="property">emitRate</span> = <span class="number">5000</span> <span class="comment">// GPU可以处理更多粒子</span></span><br><span class="line">    particleSystem.<span class="property">maxEmitPower</span> = <span class="number">1.5</span></span><br><span class="line">    particleSystem.<span class="property">minEmitPower</span> = <span class="number">1.0</span></span><br><span class="line">    particleSystem.<span class="property">updateSpeed</span> = <span class="number">0.005</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生命周期</span></span><br><span class="line">    particleSystem.<span class="property">minLifeTime</span> = <span class="number">0.3</span></span><br><span class="line">    particleSystem.<span class="property">maxLifeTime</span> = <span class="number">1.5</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 尺寸</span></span><br><span class="line">    particleSystem.<span class="property">minSize</span> = <span class="number">0.1</span></span><br><span class="line">    particleSystem.<span class="property">maxSize</span> = <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 角度范围</span></span><br><span class="line">    particleSystem.<span class="property">minAngularSpeed</span> = <span class="number">0</span></span><br><span class="line">    particleSystem.<span class="property">maxAngularSpeed</span> = <span class="title class_">Math</span>.<span class="property">PI</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 方向</span></span><br><span class="line">    particleSystem.<span class="property">direction1</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">7</span>, <span class="number">8</span>, <span class="number">3</span>)</span><br><span class="line">    particleSystem.<span class="property">direction2</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">7</span>, <span class="number">8</span>, -<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重力</span></span><br><span class="line">    particleSystem.<span class="property">gravity</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, -<span class="number">9.81</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 颜色变化</span></span><br><span class="line">    particleSystem.<span class="property">color1</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.7</span>, <span class="number">0.8</span>, <span class="number">1.0</span>, <span class="number">1.0</span>)</span><br><span class="line">    particleSystem.<span class="property">color2</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.2</span>, <span class="number">0.5</span>, <span class="number">1.0</span>, <span class="number">1.0</span>)</span><br><span class="line">    particleSystem.<span class="property">colorDead</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.2</span>, <span class="number">0.0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发射形状</span></span><br><span class="line">    particleSystem.<span class="property">minEmitBox</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    particleSystem.<span class="property">maxEmitBox</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 混合模式</span></span><br><span class="line">    particleSystem.<span class="property">blendMode</span> = <span class="title class_">ParticleSystem</span>.<span class="property">BLENDMODE_ONEONE</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gpuParticleSystems</span>.<span class="title function_">set</span>(name, particleSystem)</span><br><span class="line">    <span class="keyword">return</span> particleSystem</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建火焰效果</span></span><br><span class="line">  <span class="title function_">createFireEffect</span>(<span class="params">name, emitter, intensity = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fireSystem = <span class="variable language_">this</span>.<span class="title function_">createParticleSystem</span>(name + <span class="string">&#x27;_fire&#x27;</span>, <span class="number">2000</span>, emitter)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 火焰特效参数</span></span><br><span class="line">    fireSystem.<span class="property">particleTexture</span> = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;/textures/fire.jpg&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    fireSystem.<span class="property">emitRate</span> = <span class="number">300</span> * intensity</span><br><span class="line">    fireSystem.<span class="property">maxEmitPower</span> = <span class="number">1.0</span></span><br><span class="line">    fireSystem.<span class="property">minEmitPower</span> = <span class="number">0.8</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 火焰生命周期</span></span><br><span class="line">    fireSystem.<span class="property">minLifeTime</span> = <span class="number">0.5</span></span><br><span class="line">    fireSystem.<span class="property">maxLifeTime</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 火焰尺寸</span></span><br><span class="line">    fireSystem.<span class="property">minSize</span> = <span class="number">0.5</span> * intensity</span><br><span class="line">    fireSystem.<span class="property">maxSize</span> = <span class="number">1.0</span> * intensity</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 火焰方向（向上）</span></span><br><span class="line">    fireSystem.<span class="property">direction1</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">0.5</span>, <span class="number">1</span>, -<span class="number">0.5</span>)</span><br><span class="line">    fireSystem.<span class="property">direction2</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0.5</span>, <span class="number">1</span>, <span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 无重力（火焰向上飘）</span></span><br><span class="line">    fireSystem.<span class="property">gravity</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 火焰颜色渐变</span></span><br><span class="line">    fireSystem.<span class="property">color1</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1.0</span>) <span class="comment">// 黄色</span></span><br><span class="line">    fireSystem.<span class="property">color2</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">1</span>, <span class="number">0.5</span>, <span class="number">0</span>, <span class="number">1.0</span>) <span class="comment">// 橙色</span></span><br><span class="line">    fireSystem.<span class="property">colorDead</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.5</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.0</span>) <span class="comment">// 红色渐隐</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 火焰发射形状</span></span><br><span class="line">    fireSystem.<span class="property">minEmitBox</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">0.3</span>, <span class="number">0</span>, -<span class="number">0.3</span>)</span><br><span class="line">    fireSystem.<span class="property">maxEmitBox</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0.3</span>, <span class="number">0</span>, <span class="number">0.3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 混合模式（叠加发光）</span></span><br><span class="line">    fireSystem.<span class="property">blendMode</span> = <span class="title class_">ParticleSystem</span>.<span class="property">BLENDMODE_ADD</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fireSystem</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建烟雾效果</span></span><br><span class="line">  <span class="title function_">createSmokeEffect</span>(<span class="params">name, emitter, intensity = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> smokeSystem = <span class="variable language_">this</span>.<span class="title function_">createParticleSystem</span>(name + <span class="string">&#x27;_smoke&#x27;</span>, <span class="number">1000</span>, emitter)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 烟雾特效参数</span></span><br><span class="line">    smokeSystem.<span class="property">particleTexture</span> = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;/textures/smoke.png&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    smokeSystem.<span class="property">emitRate</span> = <span class="number">50</span> * intensity</span><br><span class="line">    smokeSystem.<span class="property">maxEmitPower</span> = <span class="number">0.5</span></span><br><span class="line">    smokeSystem.<span class="property">minEmitPower</span> = <span class="number">0.2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 烟雾生命周期（较长）</span></span><br><span class="line">    smokeSystem.<span class="property">minLifeTime</span> = <span class="number">2.0</span></span><br><span class="line">    smokeSystem.<span class="property">maxLifeTime</span> = <span class="number">4.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 烟雾尺寸（逐渐增大）</span></span><br><span class="line">    smokeSystem.<span class="property">minSize</span> = <span class="number">1.0</span> * intensity</span><br><span class="line">    smokeSystem.<span class="property">maxSize</span> = <span class="number">3.0</span> * intensity</span><br><span class="line">    smokeSystem.<span class="property">minScaleX</span> = <span class="number">1.0</span></span><br><span class="line">    smokeSystem.<span class="property">maxScaleX</span> = <span class="number">3.0</span></span><br><span class="line">    smokeSystem.<span class="property">minScaleY</span> = <span class="number">1.0</span></span><br><span class="line">    smokeSystem.<span class="property">maxScaleY</span> = <span class="number">3.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 烟雾方向（向上扩散）</span></span><br><span class="line">    smokeSystem.<span class="property">direction1</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">1</span>, -<span class="number">1</span>)</span><br><span class="line">    smokeSystem.<span class="property">direction2</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 轻微重力</span></span><br><span class="line">    smokeSystem.<span class="property">gravity</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, -<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 烟雾颜色（灰色渐隐）</span></span><br><span class="line">    smokeSystem.<span class="property">color1</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.8</span>, <span class="number">0.8</span>, <span class="number">0.8</span>, <span class="number">0.8</span>)</span><br><span class="line">    smokeSystem.<span class="property">color2</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>)</span><br><span class="line">    smokeSystem.<span class="property">colorDead</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.3</span>, <span class="number">0.3</span>, <span class="number">0.3</span>, <span class="number">0.0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 烟雾发射形状</span></span><br><span class="line">    smokeSystem.<span class="property">minEmitBox</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">0.5</span>, <span class="number">0</span>, -<span class="number">0.5</span>)</span><br><span class="line">    smokeSystem.<span class="property">maxEmitBox</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0.5</span>, <span class="number">0.2</span>, <span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 混合模式（透明）</span></span><br><span class="line">    smokeSystem.<span class="property">blendMode</span> = <span class="title class_">ParticleSystem</span>.<span class="property">BLENDMODE_STANDARD</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> smokeSystem</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建爆炸效果</span></span><br><span class="line">  <span class="title function_">createExplosionEffect</span>(<span class="params">name, position, size = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> explosionSystem = <span class="variable language_">this</span>.<span class="title function_">createParticleSystem</span>(name + <span class="string">&#x27;_explosion&#x27;</span>, <span class="number">5000</span>, position)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 爆炸特效参数</span></span><br><span class="line">    explosionSystem.<span class="property">particleTexture</span> = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;/textures/explosion.png&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    explosionSystem.<span class="property">emitRate</span> = <span class="number">10000</span> <span class="comment">// 瞬间大量发射</span></span><br><span class="line">    explosionSystem.<span class="property">maxEmitPower</span> = <span class="number">10.0</span> * size</span><br><span class="line">    explosionSystem.<span class="property">minEmitPower</span> = <span class="number">5.0</span> * size</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 爆炸生命周期（短暂）</span></span><br><span class="line">    explosionSystem.<span class="property">minLifeTime</span> = <span class="number">0.1</span></span><br><span class="line">    explosionSystem.<span class="property">maxLifeTime</span> = <span class="number">0.8</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 爆炸尺寸</span></span><br><span class="line">    explosionSystem.<span class="property">minSize</span> = <span class="number">0.5</span> * size</span><br><span class="line">    explosionSystem.<span class="property">maxSize</span> = <span class="number">2.0</span> * size</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 全方向爆炸</span></span><br><span class="line">    explosionSystem.<span class="title function_">createSphereEmitter</span>(<span class="number">0.1</span>, <span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重力影响</span></span><br><span class="line">    explosionSystem.<span class="property">gravity</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, -<span class="number">5</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 爆炸颜色</span></span><br><span class="line">    explosionSystem.<span class="property">color1</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1.0</span>) <span class="comment">// 白色闪光</span></span><br><span class="line">    explosionSystem.<span class="property">color2</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">1</span>, <span class="number">0.8</span>, <span class="number">0.2</span>, <span class="number">1.0</span>) <span class="comment">// 橙黄色</span></span><br><span class="line">    explosionSystem.<span class="property">colorDead</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.3</span>, <span class="number">0.1</span>, <span class="number">0</span>, <span class="number">0.0</span>) <span class="comment">// 暗红色消散</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 混合模式（叠加）</span></span><br><span class="line">    explosionSystem.<span class="property">blendMode</span> = <span class="title class_">ParticleSystem</span>.<span class="property">BLENDMODE_ADD</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 限制发射时间（爆炸是瞬间的）</span></span><br><span class="line">    explosionSystem.<span class="property">targetStopDuration</span> = <span class="number">0.1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> explosionSystem</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建雨雪效果</span></span><br><span class="line">  <span class="title function_">createWeatherEffect</span>(<span class="params"></span></span><br><span class="line"><span class="params">    name,</span></span><br><span class="line"><span class="params">    type = <span class="string">&#x27;rain&#x27;</span>,</span></span><br><span class="line"><span class="params">    intensity = <span class="number">1.0</span>,</span></span><br><span class="line"><span class="params">    area = &#123; width: <span class="number">50</span>, height: <span class="number">20</span>, depth: <span class="number">50</span> &#125;,</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> weatherSystem = <span class="variable language_">this</span>.<span class="title function_">createParticleSystem</span>(name + <span class="string">&#x27;_weather&#x27;</span>, <span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (type === <span class="string">&#x27;rain&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// 雨效果</span></span><br><span class="line">      weatherSystem.<span class="property">particleTexture</span> = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;/textures/raindrop.png&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">      weatherSystem.<span class="property">emitRate</span> = <span class="number">1000</span> * intensity</span><br><span class="line">      weatherSystem.<span class="property">minLifeTime</span> = <span class="number">1.0</span></span><br><span class="line">      weatherSystem.<span class="property">maxLifeTime</span> = <span class="number">3.0</span></span><br><span class="line">      weatherSystem.<span class="property">minSize</span> = <span class="number">0.1</span></span><br><span class="line">      weatherSystem.<span class="property">maxSize</span> = <span class="number">0.3</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 雨滴方向（向下）</span></span><br><span class="line">      weatherSystem.<span class="property">direction1</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">0.2</span>, -<span class="number">1</span>, -<span class="number">0.1</span>)</span><br><span class="line">      weatherSystem.<span class="property">direction2</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0.2</span>, -<span class="number">1</span>, <span class="number">0.1</span>)</span><br><span class="line">      weatherSystem.<span class="property">gravity</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, -<span class="number">15</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 雨滴颜色</span></span><br><span class="line">      weatherSystem.<span class="property">color1</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.7</span>, <span class="number">0.8</span>, <span class="number">1.0</span>, <span class="number">0.8</span>)</span><br><span class="line">      weatherSystem.<span class="property">color2</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.5</span>, <span class="number">0.6</span>, <span class="number">0.8</span>, <span class="number">0.6</span>)</span><br><span class="line">      weatherSystem.<span class="property">colorDead</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.3</span>, <span class="number">0.4</span>, <span class="number">0.6</span>, <span class="number">0.0</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">&#x27;snow&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// 雪效果</span></span><br><span class="line">      weatherSystem.<span class="property">particleTexture</span> = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;/textures/snowflake.png&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">      weatherSystem.<span class="property">emitRate</span> = <span class="number">500</span> * intensity</span><br><span class="line">      weatherSystem.<span class="property">minLifeTime</span> = <span class="number">3.0</span></span><br><span class="line">      weatherSystem.<span class="property">maxLifeTime</span> = <span class="number">8.0</span></span><br><span class="line">      weatherSystem.<span class="property">minSize</span> = <span class="number">0.3</span></span><br><span class="line">      weatherSystem.<span class="property">maxSize</span> = <span class="number">0.8</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 雪花飘落</span></span><br><span class="line">      weatherSystem.<span class="property">direction1</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, -<span class="number">0.5</span>, -<span class="number">1</span>)</span><br><span class="line">      weatherSystem.<span class="property">direction2</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, -<span class="number">0.5</span>, <span class="number">1</span>)</span><br><span class="line">      weatherSystem.<span class="property">gravity</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, -<span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 雪花颜色</span></span><br><span class="line">      weatherSystem.<span class="property">color1</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0.9</span>)</span><br><span class="line">      weatherSystem.<span class="property">color2</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.9</span>, <span class="number">0.9</span>, <span class="number">1</span>, <span class="number">0.8</span>)</span><br><span class="line">      weatherSystem.<span class="property">colorDead</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.8</span>, <span class="number">0.8</span>, <span class="number">0.9</span>, <span class="number">0.0</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置发射区域</span></span><br><span class="line">    weatherSystem.<span class="title function_">createBoxEmitter</span>(</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Vector3</span>(-area.<span class="property">width</span> / <span class="number">2</span>, area.<span class="property">height</span>, -area.<span class="property">depth</span> / <span class="number">2</span>),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Vector3</span>(area.<span class="property">width</span> / <span class="number">2</span>, area.<span class="property">height</span>, area.<span class="property">depth</span> / <span class="number">2</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> weatherSystem</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置发射器形状</span></span><br><span class="line">  <span class="title function_">setupEmitterShape</span>(<span class="params">particleSystem, shapeType, ...params</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (shapeType) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;box&#x27;</span>:</span><br><span class="line">        <span class="keyword">const</span> [minEmitBox, maxEmitBox] = params</span><br><span class="line">        particleSystem.<span class="property">minEmitBox</span> = minEmitBox || <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>)</span><br><span class="line">        particleSystem.<span class="property">maxEmitBox</span> = maxEmitBox || <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;sphere&#x27;</span>:</span><br><span class="line">        <span class="keyword">const</span> [radius, radiusRange] = params</span><br><span class="line">        particleSystem.<span class="title function_">createSphereEmitter</span>(radius || <span class="number">1.0</span>, radiusRange || <span class="number">1.0</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;cone&#x27;</span>:</span><br><span class="line">        <span class="keyword">const</span> [coneRadius, coneAngle, coneHeight] = params</span><br><span class="line">        particleSystem.<span class="title function_">createConeEmitter</span>(</span><br><span class="line">          coneRadius || <span class="number">1.0</span>,</span><br><span class="line">          coneAngle || <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>,</span><br><span class="line">          coneHeight || <span class="number">1.0</span>,</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;cylinder&#x27;</span>:</span><br><span class="line">        <span class="keyword">const</span> [cylRadius, cylHeight, cylRadiusRange] = params</span><br><span class="line">        particleSystem.<span class="title function_">createCylinderEmitter</span>(</span><br><span class="line">          cylRadius || <span class="number">1.0</span>,</span><br><span class="line">          cylHeight || <span class="number">1.0</span>,</span><br><span class="line">          cylRadiusRange || <span class="number">1.0</span>,</span><br><span class="line">          <span class="number">0</span>, <span class="comment">// directionRandomizer</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;hemisphere&#x27;</span>:</span><br><span class="line">        <span class="keyword">const</span> [hemiRadius, hemiRadiusRange] = params</span><br><span class="line">        particleSystem.<span class="title function_">createHemisphericEmitter</span>(hemiRadius || <span class="number">1.0</span>, hemiRadiusRange || <span class="number">1.0</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;未知的发射器形状:&#x27;</span>, shapeType)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 启动粒子系统</span></span><br><span class="line">  <span class="title function_">startParticleSystem</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> cpuSystem = <span class="variable language_">this</span>.<span class="property">particleSystems</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">const</span> gpuSystem = <span class="variable language_">this</span>.<span class="property">gpuParticleSystems</span>.<span class="title function_">get</span>(name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cpuSystem) &#123;</span><br><span class="line">      cpuSystem.<span class="title function_">start</span>()</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`CPU粒子系统 <span class="subst">$&#123;name&#125;</span> 已启动`</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (gpuSystem) &#123;</span><br><span class="line">      gpuSystem.<span class="title function_">start</span>()</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`GPU粒子系统 <span class="subst">$&#123;name&#125;</span> 已启动`</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`粒子系统 <span class="subst">$&#123;name&#125;</span> 未找到`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 停止粒子系统</span></span><br><span class="line">  <span class="title function_">stopParticleSystem</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> cpuSystem = <span class="variable language_">this</span>.<span class="property">particleSystems</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">const</span> gpuSystem = <span class="variable language_">this</span>.<span class="property">gpuParticleSystems</span>.<span class="title function_">get</span>(name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cpuSystem) &#123;</span><br><span class="line">      cpuSystem.<span class="title function_">stop</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (gpuSystem) &#123;</span><br><span class="line">      gpuSystem.<span class="title function_">stop</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 重置粒子系统</span></span><br><span class="line">  <span class="title function_">resetParticleSystem</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> cpuSystem = <span class="variable language_">this</span>.<span class="property">particleSystems</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">const</span> gpuSystem = <span class="variable language_">this</span>.<span class="property">gpuParticleSystems</span>.<span class="title function_">get</span>(name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cpuSystem) &#123;</span><br><span class="line">      cpuSystem.<span class="title function_">reset</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (gpuSystem) &#123;</span><br><span class="line">      gpuSystem.<span class="title function_">reset</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取粒子系统信息</span></span><br><span class="line">  <span class="title function_">getParticleSystemInfo</span>(<span class="params">particleSystemName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> particleSystem = <span class="variable language_">this</span>.<span class="property">particleSystems</span>.<span class="title function_">get</span>(particleSystemName)</span><br><span class="line">    <span class="keyword">if</span> (!particleSystem) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> info = &#123;</span><br><span class="line">      <span class="attr">name</span>: particleSystemName,</span><br><span class="line">      <span class="attr">type</span>: particleSystem.<span class="title function_">getClassName</span>(),</span><br><span class="line">      <span class="attr">emitRate</span>: particleSystem.<span class="property">emitRate</span>,</span><br><span class="line">      <span class="attr">lifeTime</span>: particleSystem.<span class="property">lifeTime</span>,</span><br><span class="line">      <span class="attr">size</span>: particleSystem.<span class="property">size</span>,</span><br><span class="line">      <span class="attr">color</span>: particleSystem.<span class="property">color</span>,</span><br><span class="line">      <span class="attr">color2</span>: particleSystem.<span class="property">color2</span>,</span><br><span class="line">      <span class="attr">colorDead</span>: particleSystem.<span class="property">colorDead</span>,</span><br><span class="line">      <span class="attr">gravity</span>: particleSystem.<span class="property">gravity</span>,</span><br><span class="line">      <span class="attr">direction</span>: particleSystem.<span class="property">direction</span>,</span><br><span class="line">      <span class="attr">direction2</span>: particleSystem.<span class="property">direction2</span>,</span><br><span class="line">      <span class="attr">minEmitPower</span>: particleSystem.<span class="property">minEmitPower</span>,</span><br><span class="line">      <span class="attr">maxEmitPower</span>: particleSystem.<span class="property">maxEmitPower</span>,</span><br><span class="line">      <span class="attr">minLifeTime</span>: particleSystem.<span class="property">minLifeTime</span>,</span><br><span class="line">      <span class="attr">maxLifeTime</span>: particleSystem.<span class="property">maxLifeTime</span>,</span><br><span class="line">      <span class="attr">minSize</span>: particleSystem.<span class="property">minSize</span>,</span><br><span class="line">      <span class="attr">maxSize</span>: particleSystem.<span class="property">maxSize</span>,</span><br><span class="line">      <span class="attr">minEmitBox</span>: particleSystem.<span class="property">minEmitBox</span>,</span><br><span class="line">      <span class="attr">maxEmitBox</span>: particleSystem.<span class="property">maxEmitBox</span>,</span><br><span class="line">      <span class="attr">emitBox</span>: particleSystem.<span class="property">emitBox</span>,</span><br><span class="line">      <span class="attr">particles</span>: particleSystem.<span class="property">particles</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">particle</span>) =&gt;</span> (&#123;</span><br><span class="line">        <span class="attr">position</span>: particle.<span class="property">position</span>.<span class="title function_">clone</span>(),</span><br><span class="line">        <span class="attr">velocity</span>: particle.<span class="property">velocity</span>.<span class="title function_">clone</span>(),</span><br><span class="line">        <span class="attr">color</span>: particle.<span class="property">color</span>.<span class="title function_">clone</span>(),</span><br><span class="line">        <span class="attr">size</span>: particle.<span class="property">size</span>,</span><br><span class="line">        <span class="attr">lifeTime</span>: particle.<span class="property">lifeTime</span>,</span><br><span class="line">      &#125;)),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 批量应用粒子系统</span></span><br><span class="line">  <span class="title function_">applyParticleSystems</span>(<span class="params">particleSystems</span>) &#123;</span><br><span class="line">    particleSystems.<span class="title function_">forEach</span>(<span class="function">(<span class="params">particleSystem, name</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">applyParticleSystem</span>(name, particleSystem)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 应用粒子系统</span></span><br><span class="line">  <span class="title function_">applyParticleSystem</span>(<span class="params">particleSystemName, particleSystem</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> currentParticleSystem = <span class="variable language_">this</span>.<span class="property">particleSystems</span>.<span class="title function_">get</span>(particleSystemName)</span><br><span class="line">    <span class="keyword">if</span> (!currentParticleSystem) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    currentParticleSystem.<span class="property">emitRate</span> = particleSystem.<span class="property">emitRate</span></span><br><span class="line">    currentParticleSystem.<span class="property">lifeTime</span> = particleSystem.<span class="property">lifeTime</span></span><br><span class="line">    currentParticleSystem.<span class="property">size</span> = particleSystem.<span class="property">size</span></span><br><span class="line">    currentParticleSystem.<span class="property">color</span> = particleSystem.<span class="property">color</span></span><br><span class="line">    currentParticleSystem.<span class="property">color2</span> = particleSystem.<span class="property">color2</span></span><br><span class="line">    currentParticleSystem.<span class="property">colorDead</span> = particleSystem.<span class="property">colorDead</span></span><br><span class="line">    currentParticleSystem.<span class="property">gravity</span> = particleSystem.<span class="property">gravity</span></span><br><span class="line">    currentParticleSystem.<span class="property">direction</span> = particleSystem.<span class="property">direction</span></span><br><span class="line">    currentParticleSystem.<span class="property">direction2</span> = particleSystem.<span class="property">direction2</span></span><br><span class="line">    currentParticleSystem.<span class="property">minEmitPower</span> = particleSystem.<span class="property">minEmitPower</span></span><br><span class="line">    currentParticleSystem.<span class="property">maxEmitPower</span> = particleSystem.<span class="property">maxEmitPower</span></span><br><span class="line">    currentParticleSystem.<span class="property">minLifeTime</span> = particleSystem.<span class="property">minLifeTime</span></span><br><span class="line">    currentParticleSystem.<span class="property">maxLifeTime</span> = particleSystem.<span class="property">maxLifeTime</span></span><br><span class="line">    currentParticleSystem.<span class="property">minSize</span> = particleSystem.<span class="property">minSize</span></span><br><span class="line">    currentParticleSystem.<span class="property">maxSize</span> = particleSystem.<span class="property">maxSize</span></span><br><span class="line">    currentParticleSystem.<span class="property">minEmitBox</span> = particleSystem.<span class="property">minEmitBox</span></span><br><span class="line">    currentParticleSystem.<span class="property">maxEmitBox</span> = particleSystem.<span class="property">maxEmitBox</span></span><br><span class="line">    currentParticleSystem.<span class="property">emitBox</span> = particleSystem.<span class="property">emitBox</span></span><br><span class="line">    currentParticleSystem.<span class="property">particles</span> = particleSystem.<span class="property">particles</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">particle</span>) =&gt;</span> (&#123;</span><br><span class="line">      <span class="attr">position</span>: particle.<span class="property">position</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">velocity</span>: particle.<span class="property">velocity</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">color</span>: particle.<span class="property">color</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">size</span>: particle.<span class="property">size</span>,</span><br><span class="line">      <span class="attr">lifeTime</span>: particle.<span class="property">lifeTime</span>,</span><br><span class="line">    &#125;))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 资源清理</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">particleSystems</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">particleSystem</span>) =&gt;</span> &#123;</span><br><span class="line">      particleSystem.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">particleSystems</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> particleSystemManager = <span class="keyword">new</span> <span class="title class_">ParticleSystemManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建基础粒子系统</span></span><br><span class="line"><span class="keyword">const</span> basicParticleSystem = particleSystemManager.<span class="title function_">createBasicParticleSystem</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建复合粒子系统</span></span><br><span class="line"><span class="keyword">const</span> complexParticleSystem = particleSystemManager.<span class="title function_">createComplexParticleSystem</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加粒子系统到场景</span></span><br><span class="line">scene.<span class="title function_">addParticleSystem</span>(basicParticleSystem)</span><br><span class="line">scene.<span class="title function_">addParticleSystem</span>(complexParticleSystem)</span><br></pre></td></tr></table></figure><h2 id="🔊-Audio-音频系统详解"><a href="#🔊-Audio-音频系统详解" class="headerlink" title="🔊 Audio 音频系统详解"></a>🔊 Audio 音频系统详解</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Audio 音频系统完整管理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AudioManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sounds</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">soundTracks</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">audioEngine</span> = <span class="title class_">Engine</span>.<span class="property">audioEngine</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupDefaultAudio</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupDefaultAudio</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 检查音频引擎是否可用</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">audioEngine</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;音频引擎不可用&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;音频引擎已初始化&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置全局音频参数</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setGlobalVolume</span>(<span class="number">1.0</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建音效</span></span><br><span class="line">  <span class="title function_">createSound</span>(<span class="params">name, url, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> soundOptions = &#123;</span><br><span class="line">      <span class="comment">// 基础属性</span></span><br><span class="line">      <span class="attr">autoplay</span>: options.<span class="property">autoplay</span> || <span class="literal">false</span>, <span class="comment">// 自动播放</span></span><br><span class="line">      <span class="attr">loop</span>: options.<span class="property">loop</span> || <span class="literal">false</span>, <span class="comment">// 循环播放</span></span><br><span class="line">      <span class="attr">volume</span>: options.<span class="property">volume</span> || <span class="number">1.0</span>, <span class="comment">// 音量</span></span><br><span class="line">      <span class="attr">playbackRate</span>: options.<span class="property">playbackRate</span> || <span class="number">1.0</span>, <span class="comment">// 播放速率</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 3D音频属性</span></span><br><span class="line">      <span class="attr">spatialSound</span>: options.<span class="property">spatialSound</span> || <span class="literal">false</span>, <span class="comment">// 3D空间音效</span></span><br><span class="line">      <span class="attr">maxDistance</span>: options.<span class="property">maxDistance</span> || <span class="number">100</span>, <span class="comment">// 最大距离</span></span><br><span class="line">      <span class="attr">rolloffFactor</span>: options.<span class="property">rolloffFactor</span> || <span class="number">1.0</span>, <span class="comment">// 衰减因子</span></span><br><span class="line">      <span class="attr">refDistance</span>: options.<span class="property">refDistance</span> || <span class="number">1.0</span>, <span class="comment">// 参考距离</span></span><br><span class="line">      <span class="attr">distanceModel</span>: options.<span class="property">distanceModel</span> || <span class="string">&#x27;linear&#x27;</span>, <span class="comment">// 距离模型</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 回调函数</span></span><br><span class="line">      <span class="attr">onended</span>: options.<span class="property">onended</span> || <span class="literal">null</span>, <span class="comment">// 播放结束回调</span></span><br><span class="line">      <span class="attr">onload</span>: options.<span class="property">onload</span> || <span class="literal">null</span>, <span class="comment">// 加载完成回调</span></span><br><span class="line">      <span class="attr">onerror</span>: options.<span class="property">onerror</span> || <span class="literal">null</span>, <span class="comment">// 错误回调</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 其他选项</span></span><br><span class="line">      <span class="attr">streaming</span>: options.<span class="property">streaming</span> || <span class="literal">false</span>, <span class="comment">// 流式播放</span></span><br><span class="line">      <span class="attr">length</span>: options.<span class="property">length</span> || <span class="number">0</span>, <span class="comment">// 音频长度（秒）</span></span><br><span class="line">      <span class="attr">offset</span>: options.<span class="property">offset</span> || <span class="number">0</span>, <span class="comment">// 播放偏移</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sound = <span class="keyword">new</span> <span class="title class_">Sound</span>(name, url, <span class="variable language_">this</span>.<span class="property">scene</span>, soundOptions.<span class="property">onload</span>, soundOptions)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">set</span>(name, sound)</span><br><span class="line">    <span class="keyword">return</span> sound</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建背景音乐</span></span><br><span class="line">  <span class="title function_">createBackgroundMusic</span>(<span class="params">name, url, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> musicOptions = &#123;</span><br><span class="line">      <span class="attr">autoplay</span>: options.<span class="property">autoplay</span> || <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">loop</span>: options.<span class="property">loop</span> || <span class="literal">true</span>, <span class="comment">// 背景音乐通常循环播放</span></span><br><span class="line">      <span class="attr">volume</span>: options.<span class="property">volume</span> || <span class="number">0.5</span>, <span class="comment">// 背景音乐音量较低</span></span><br><span class="line">      <span class="attr">spatialSound</span>: <span class="literal">false</span>, <span class="comment">// 背景音乐不使用3D音效</span></span><br><span class="line">      <span class="attr">streaming</span>: options.<span class="property">streaming</span> || <span class="literal">true</span>, <span class="comment">// 大文件使用流式播放</span></span><br><span class="line">      ...options,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">createSound</span>(name, url, musicOptions)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建3D音效</span></span><br><span class="line">  <span class="title function_">createSpatialSound</span>(<span class="params">name, url, mesh, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> spatialOptions = &#123;</span><br><span class="line">      <span class="attr">spatialSound</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">maxDistance</span>: options.<span class="property">maxDistance</span> || <span class="number">50</span>,</span><br><span class="line">      <span class="attr">rolloffFactor</span>: options.<span class="property">rolloffFactor</span> || <span class="number">2.0</span>,</span><br><span class="line">      <span class="attr">refDistance</span>: options.<span class="property">refDistance</span> || <span class="number">1.0</span>,</span><br><span class="line">      <span class="attr">distanceModel</span>: options.<span class="property">distanceModel</span> || <span class="string">&#x27;exponential&#x27;</span>,</span><br><span class="line">      ...options,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="title function_">createSound</span>(name, url, spatialOptions)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将音效附加到网格</span></span><br><span class="line">    <span class="keyword">if</span> (mesh) &#123;</span><br><span class="line">      sound.<span class="title function_">attachToMesh</span>(mesh)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sound</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建音轨组</span></span><br><span class="line">  <span class="title function_">createSoundTrack</span>(<span class="params">name, sounds = []</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> soundTrack = <span class="keyword">new</span> <span class="title class_">SoundTrack</span>(<span class="variable language_">this</span>.<span class="property">scene</span>, &#123;</span><br><span class="line">      <span class="attr">volume</span>: <span class="number">1.0</span>,</span><br><span class="line">      <span class="attr">mainTrack</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加音效到音轨</span></span><br><span class="line">    sounds.<span class="title function_">forEach</span>(<span class="function">(<span class="params">soundName</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">get</span>(soundName)</span><br><span class="line">      <span class="keyword">if</span> (sound) &#123;</span><br><span class="line">        soundTrack.<span class="title function_">addSound</span>(sound)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">soundTracks</span>.<span class="title function_">set</span>(name, soundTrack)</span><br><span class="line">    <span class="keyword">return</span> soundTrack</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 播放音效</span></span><br><span class="line">  <span class="title function_">playSound</span>(<span class="params">name, when = <span class="number">0</span>, offset = <span class="number">0</span>, length = <span class="number">0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">if</span> (!sound) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`音效 <span class="subst">$&#123;name&#125;</span> 未找到`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (when &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 延迟播放</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          sound.<span class="title function_">play</span>(when, offset, length)</span><br><span class="line">        &#125;, when * <span class="number">1000</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sound.<span class="title function_">play</span>(when, offset, length)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`播放音效 <span class="subst">$&#123;name&#125;</span> 失败:`</span>, error)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 停止音效</span></span><br><span class="line">  <span class="title function_">stopSound</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">if</span> (sound) &#123;</span><br><span class="line">      sound.<span class="title function_">stop</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 暂停音效</span></span><br><span class="line">  <span class="title function_">pauseSound</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">if</span> (sound) &#123;</span><br><span class="line">      sound.<span class="title function_">pause</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置音效音量</span></span><br><span class="line">  <span class="title function_">setSoundVolume</span>(<span class="params">name, volume</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">if</span> (sound) &#123;</span><br><span class="line">      sound.<span class="title function_">setVolume</span>(volume)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 淡入效果</span></span><br><span class="line">  <span class="title function_">fadeInSound</span>(<span class="params">name, duration = <span class="number">1.0</span>, targetVolume = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">if</span> (!sound) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> startVolume = <span class="number">0</span></span><br><span class="line">    <span class="keyword">const</span> steps = <span class="number">60</span> <span class="comment">// 60帧</span></span><br><span class="line">    <span class="keyword">const</span> stepDuration = (duration * <span class="number">1000</span>) / steps</span><br><span class="line">    <span class="keyword">const</span> volumeStep = (targetVolume - startVolume) / steps</span><br><span class="line"></span><br><span class="line">    sound.<span class="title function_">setVolume</span>(startVolume)</span><br><span class="line">    sound.<span class="title function_">play</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> currentStep = <span class="number">0</span></span><br><span class="line">    <span class="keyword">const</span> fadeInterval = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      currentStep++</span><br><span class="line">      <span class="keyword">const</span> currentVolume = startVolume + volumeStep * currentStep</span><br><span class="line">      sound.<span class="title function_">setVolume</span>(currentVolume)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (currentStep &gt;= steps) &#123;</span><br><span class="line">        <span class="built_in">clearInterval</span>(fadeInterval)</span><br><span class="line">        sound.<span class="title function_">setVolume</span>(targetVolume)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, stepDuration)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 淡出效果</span></span><br><span class="line">  <span class="title function_">fadeOutSound</span>(<span class="params">name, duration = <span class="number">1.0</span>, stopAfterFade = <span class="literal">true</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">if</span> (!sound) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> startVolume = sound.<span class="title function_">getVolume</span>()</span><br><span class="line">    <span class="keyword">const</span> targetVolume = <span class="number">0</span></span><br><span class="line">    <span class="keyword">const</span> steps = <span class="number">60</span></span><br><span class="line">    <span class="keyword">const</span> stepDuration = (duration * <span class="number">1000</span>) / steps</span><br><span class="line">    <span class="keyword">const</span> volumeStep = (startVolume - targetVolume) / steps</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> currentStep = <span class="number">0</span></span><br><span class="line">    <span class="keyword">const</span> fadeInterval = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      currentStep++</span><br><span class="line">      <span class="keyword">const</span> currentVolume = startVolume - volumeStep * currentStep</span><br><span class="line">      sound.<span class="title function_">setVolume</span>(<span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="number">0</span>, currentVolume))</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (currentStep &gt;= steps) &#123;</span><br><span class="line">        <span class="built_in">clearInterval</span>(fadeInterval)</span><br><span class="line">        sound.<span class="title function_">setVolume</span>(targetVolume)</span><br><span class="line">        <span class="keyword">if</span> (stopAfterFade) &#123;</span><br><span class="line">          sound.<span class="title function_">stop</span>()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, stepDuration)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置全局音量</span></span><br><span class="line">  <span class="title function_">setGlobalVolume</span>(<span class="params">volume</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">audioEngine</span>) &#123;</span><br><span class="line">      <span class="title class_">Engine</span>.<span class="property">audioEngine</span>.<span class="title function_">setGlobalVolume</span>(volume)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 预加载音频</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">preloadSound</span>(<span class="params">name, url</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> sound = <span class="keyword">new</span> <span class="title class_">Sound</span>(</span><br><span class="line">        name,</span><br><span class="line">        url,</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">        <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">set</span>(name, sound)</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`音效 <span class="subst">$&#123;name&#125;</span> 预加载完成`</span>)</span><br><span class="line">          <span class="title function_">resolve</span>(sound)</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">autoplay</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">onError</span>: <span class="function">(<span class="params">sound, error</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`音效 <span class="subst">$&#123;name&#125;</span> 加载失败:`</span>, error)</span><br><span class="line">            <span class="title function_">reject</span>(error)</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取音效信息</span></span><br><span class="line">  <span class="title function_">getSoundInfo</span>(<span class="params">soundName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">get</span>(soundName)</span><br><span class="line">    <span class="keyword">if</span> (!sound) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">name</span>: soundName,</span><br><span class="line">      <span class="attr">isPlaying</span>: sound.<span class="property">isPlaying</span>,</span><br><span class="line">      <span class="attr">isPaused</span>: sound.<span class="property">isPaused</span>,</span><br><span class="line">      <span class="attr">volume</span>: sound.<span class="title function_">getVolume</span>(),</span><br><span class="line">      <span class="attr">playbackRate</span>: sound.<span class="property">playbackRate</span>,</span><br><span class="line">      <span class="attr">spatialSound</span>: sound.<span class="property">spatialSound</span>,</span><br><span class="line">      <span class="attr">loop</span>: sound.<span class="property">loop</span>,</span><br><span class="line">      <span class="attr">autoplay</span>: sound.<span class="property">autoplay</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 资源清理</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">sound</span>) =&gt;</span> &#123;</span><br><span class="line">      sound.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">soundTracks</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">track</span>) =&gt;</span> &#123;</span><br><span class="line">      track.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">soundTracks</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> audioManager = <span class="keyword">new</span> <span class="title class_">AudioManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建背景音乐</span></span><br><span class="line">audioManager.<span class="title function_">createBackgroundMusic</span>(<span class="string">&#x27;bgMusic&#x27;</span>, <span class="string">&#x27;/audio/background.mp3&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">volume</span>: <span class="number">0.3</span>,</span><br><span class="line">  <span class="attr">autoplay</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建3D音效</span></span><br><span class="line"><span class="keyword">const</span> fireSound = audioManager.<span class="title function_">createSpatialSound</span>(<span class="string">&#x27;fire&#x27;</span>, <span class="string">&#x27;/audio/fire.wav&#x27;</span>, fireMesh, &#123;</span><br><span class="line">  <span class="attr">loop</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">volume</span>: <span class="number">0.8</span>,</span><br><span class="line">  <span class="attr">maxDistance</span>: <span class="number">50</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 播放音效</span></span><br><span class="line">audioManager.<span class="title function_">playSound</span>(<span class="string">&#x27;fire&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 淡入背景音乐</span></span><br><span class="line">audioManager.<span class="title function_">fadeInSound</span>(<span class="string">&#x27;bgMusic&#x27;</span>, <span class="number">2.0</span>, <span class="number">0.5</span>)</span><br></pre></td></tr></table></figure><h2 id="🎮-Input-输入系统详解"><a href="#🎮-Input-输入系统详解" class="headerlink" title="🎮 Input 输入系统详解"></a>🎮 Input 输入系统详解</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Input 输入系统完整管理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InputManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span> = scene.<span class="title function_">getEngine</span>().<span class="title function_">getRenderingCanvas</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">actionManager</span> = <span class="keyword">new</span> <span class="title class_">ActionManager</span>(scene)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输入状态</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">keys</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mouseButtons</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mousePosition</span> = &#123; <span class="attr">x</span>: <span class="number">0</span>, <span class="attr">y</span>: <span class="number">0</span> &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gamepads</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 事件监听器</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">keyboardObservables</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pointerObservables</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupDefaultInput</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupDefaultInput</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 设置键盘输入</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupKeyboardInput</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置鼠标输入</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupPointerInput</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置游戏手柄输入</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupGamepadInput</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置场景ActionManager</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">actionManager</span> = <span class="variable language_">this</span>.<span class="property">actionManager</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置键盘输入</span></span><br><span class="line">  <span class="title function_">setupKeyboardInput</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 监听键盘按下</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">keyboardObservables</span>.<span class="title function_">set</span>(</span><br><span class="line">      <span class="string">&#x27;keydown&#x27;</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onKeyboardObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">kbInfo</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (kbInfo.<span class="property">type</span> === <span class="title class_">KeyboardEventTypes</span>.<span class="property">KEYDOWN</span>) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">keys</span>.<span class="title function_">set</span>(kbInfo.<span class="property">event</span>.<span class="property">code</span>, &#123;</span><br><span class="line">            <span class="attr">key</span>: kbInfo.<span class="property">event</span>.<span class="property">key</span>,</span><br><span class="line">            <span class="attr">code</span>: kbInfo.<span class="property">event</span>.<span class="property">code</span>,</span><br><span class="line">            <span class="attr">pressed</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">          &#125;)</span><br><span class="line"></span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onKeyDown</span>(kbInfo.<span class="property">event</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听键盘释放</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">keyboardObservables</span>.<span class="title function_">set</span>(</span><br><span class="line">      <span class="string">&#x27;keyup&#x27;</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onKeyboardObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">kbInfo</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (kbInfo.<span class="property">type</span> === <span class="title class_">KeyboardEventTypes</span>.<span class="property">KEYUP</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> keyData = <span class="variable language_">this</span>.<span class="property">keys</span>.<span class="title function_">get</span>(kbInfo.<span class="property">event</span>.<span class="property">code</span>)</span><br><span class="line">          <span class="keyword">if</span> (keyData) &#123;</span><br><span class="line">            keyData.<span class="property">pressed</span> = <span class="literal">false</span></span><br><span class="line">            keyData.<span class="property">releasedTimestamp</span> = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onKeyUp</span>(kbInfo.<span class="property">event</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置指针（鼠标/触摸）输入</span></span><br><span class="line">  <span class="title function_">setupPointerInput</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 监听指针按下</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pointerObservables</span>.<span class="title function_">set</span>(</span><br><span class="line">      <span class="string">&#x27;pointerdown&#x27;</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onPointerObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">pointerInfo</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (pointerInfo.<span class="property">type</span> === <span class="title class_">PointerEventTypes</span>.<span class="property">POINTERDOWN</span>) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">mouseButtons</span>.<span class="title function_">set</span>(pointerInfo.<span class="property">event</span>.<span class="property">button</span>, &#123;</span><br><span class="line">            <span class="attr">button</span>: pointerInfo.<span class="property">event</span>.<span class="property">button</span>,</span><br><span class="line">            <span class="attr">pressed</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">position</span>: &#123; <span class="attr">x</span>: pointerInfo.<span class="property">event</span>.<span class="property">clientX</span>, <span class="attr">y</span>: pointerInfo.<span class="property">event</span>.<span class="property">clientY</span> &#125;,</span><br><span class="line">            <span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">          &#125;)</span><br><span class="line"></span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onPointerDown</span>(pointerInfo.<span class="property">event</span>, pointerInfo)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听指针释放</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pointerObservables</span>.<span class="title function_">set</span>(</span><br><span class="line">      <span class="string">&#x27;pointerup&#x27;</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onPointerObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">pointerInfo</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (pointerInfo.<span class="property">type</span> === <span class="title class_">PointerEventTypes</span>.<span class="property">POINTERUP</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> buttonData = <span class="variable language_">this</span>.<span class="property">mouseButtons</span>.<span class="title function_">get</span>(pointerInfo.<span class="property">event</span>.<span class="property">button</span>)</span><br><span class="line">          <span class="keyword">if</span> (buttonData) &#123;</span><br><span class="line">            buttonData.<span class="property">pressed</span> = <span class="literal">false</span></span><br><span class="line">            buttonData.<span class="property">releasedTimestamp</span> = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onPointerUp</span>(pointerInfo.<span class="property">event</span>, pointerInfo)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听指针移动</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pointerObservables</span>.<span class="title function_">set</span>(</span><br><span class="line">      <span class="string">&#x27;pointermove&#x27;</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onPointerObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">pointerInfo</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (pointerInfo.<span class="property">type</span> === <span class="title class_">PointerEventTypes</span>.<span class="property">POINTERMOVE</span>) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">mousePosition</span>.<span class="property">x</span> = pointerInfo.<span class="property">event</span>.<span class="property">clientX</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">mousePosition</span>.<span class="property">y</span> = pointerInfo.<span class="property">event</span>.<span class="property">clientY</span></span><br><span class="line"></span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onPointerMove</span>(pointerInfo.<span class="property">event</span>, pointerInfo)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听鼠标滚轮</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pointerObservables</span>.<span class="title function_">set</span>(</span><br><span class="line">      <span class="string">&#x27;wheel&#x27;</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onPointerObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">pointerInfo</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (pointerInfo.<span class="property">type</span> === <span class="title class_">PointerEventTypes</span>.<span class="property">POINTERWHEEL</span>) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onWheel</span>(pointerInfo.<span class="property">event</span>, pointerInfo)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置游戏手柄输入</span></span><br><span class="line">  <span class="title function_">setupGamepadInput</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 检查游戏手柄支持</span></span><br><span class="line">    <span class="keyword">if</span> (navigator.<span class="property">getGamepads</span>) &#123;</span><br><span class="line">      <span class="comment">// 监听游戏手柄连接</span></span><br><span class="line">      <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;gamepadconnected&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">onGamepadConnected</span>(event.<span class="property">gamepad</span>)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 监听游戏手柄断开</span></span><br><span class="line">      <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;gamepaddisconnected&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">onGamepadDisconnected</span>(event.<span class="property">gamepad</span>)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 定期检查游戏手柄状态</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">gamepadCheckInterval</span> = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">updateGamepadState</span>()</span><br><span class="line">      &#125;, <span class="number">16</span>) <span class="comment">// 60fps</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 键盘事件处理器（可重写）</span></span><br><span class="line">  <span class="title function_">onKeyDown</span>(<span class="params">event</span>) &#123;</span><br><span class="line">    <span class="comment">// 默认实现 - 可被子类重写</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Key pressed: <span class="subst">$&#123;event.key&#125;</span> (<span class="subst">$&#123;event.code&#125;</span>)`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onKeyUp</span>(<span class="params">event</span>) &#123;</span><br><span class="line">    <span class="comment">// 默认实现 - 可被子类重写</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Key released: <span class="subst">$&#123;event.key&#125;</span> (<span class="subst">$&#123;event.code&#125;</span>)`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 指针事件处理器（可重写）</span></span><br><span class="line">  <span class="title function_">onPointerDown</span>(<span class="params">event, pointerInfo</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Pointer down: button <span class="subst">$&#123;event.button&#125;</span> at (<span class="subst">$&#123;event.clientX&#125;</span>, <span class="subst">$&#123;event.clientY&#125;</span>)`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onPointerUp</span>(<span class="params">event, pointerInfo</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Pointer up: button <span class="subst">$&#123;event.button&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onPointerMove</span>(<span class="params">event, pointerInfo</span>) &#123;</span><br><span class="line">    <span class="comment">// 通常不打印移动事件，频率太高</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onWheel</span>(<span class="params">event, pointerInfo</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Wheel: <span class="subst">$&#123;pointerInfo.event.deltaY&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 游戏手柄事件处理器</span></span><br><span class="line">  <span class="title function_">onGamepadConnected</span>(<span class="params">gamepad</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Gamepad connected: <span class="subst">$&#123;gamepad.id&#125;</span>`</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="title function_">set</span>(gamepad.<span class="property">index</span>, &#123;</span><br><span class="line">      <span class="attr">gamepad</span>: gamepad,</span><br><span class="line">      <span class="attr">lastState</span>: &#123;</span><br><span class="line">        <span class="attr">buttons</span>: <span class="title class_">Array</span>(gamepad.<span class="property">buttons</span>.<span class="property">length</span>).<span class="title function_">fill</span>(<span class="literal">false</span>),</span><br><span class="line">        <span class="attr">axes</span>: <span class="title class_">Array</span>(gamepad.<span class="property">axes</span>.<span class="property">length</span>).<span class="title function_">fill</span>(<span class="number">0</span>),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onGamepadDisconnected</span>(<span class="params">gamepad</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Gamepad disconnected: <span class="subst">$&#123;gamepad.id&#125;</span>`</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="title function_">delete</span>(gamepad.<span class="property">index</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">updateGamepadState</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> gamepads = navigator.<span class="title function_">getGamepads</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> gamepad <span class="keyword">of</span> gamepads) &#123;</span><br><span class="line">      <span class="keyword">if</span> (gamepad &amp;&amp; <span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="title function_">has</span>(gamepad.<span class="property">index</span>)) &#123;</span><br><span class="line">        <span class="keyword">const</span> gamepadData = <span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="title function_">get</span>(gamepad.<span class="property">index</span>)</span><br><span class="line">        <span class="keyword">const</span> lastState = gamepadData.<span class="property">lastState</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查按钮状态变化</span></span><br><span class="line">        gamepad.<span class="property">buttons</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">button, index</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> wasPressed = lastState.<span class="property">buttons</span>[index]</span><br><span class="line">          <span class="keyword">const</span> isPressed = button.<span class="property">pressed</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (isPressed &amp;&amp; !wasPressed) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">onGamepadButtonDown</span>(gamepad, index, button)</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isPressed &amp;&amp; wasPressed) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">onGamepadButtonUp</span>(gamepad, index, button)</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          lastState.<span class="property">buttons</span>[index] = isPressed</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查摇杆状态变化</span></span><br><span class="line">        gamepad.<span class="property">axes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">axis, index</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> lastValue = lastState.<span class="property">axes</span>[index]</span><br><span class="line">          <span class="keyword">const</span> currentValue = axis</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (<span class="title class_">Math</span>.<span class="title function_">abs</span>(currentValue - lastValue) &gt; <span class="number">0.1</span>) &#123;</span><br><span class="line">            <span class="comment">// 死区处理</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">onGamepadAxisMove</span>(gamepad, index, currentValue, lastValue)</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          lastState.<span class="property">axes</span>[index] = currentValue</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onGamepadButtonDown</span>(<span class="params">gamepad, buttonIndex, button</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Gamepad <span class="subst">$&#123;gamepad.index&#125;</span> button <span class="subst">$&#123;buttonIndex&#125;</span> pressed`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onGamepadButtonUp</span>(<span class="params">gamepad, buttonIndex, button</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Gamepad <span class="subst">$&#123;gamepad.index&#125;</span> button <span class="subst">$&#123;buttonIndex&#125;</span> released`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onGamepadAxisMove</span>(<span class="params">gamepad, axisIndex, currentValue, lastValue</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Gamepad <span class="subst">$&#123;gamepad.index&#125;</span> axis <span class="subst">$&#123;axisIndex&#125;</span>: <span class="subst">$&#123;currentValue&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 输入状态查询方法</span></span><br><span class="line">  <span class="title function_">isKeyPressed</span>(<span class="params">keyCode</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> keyData = <span class="variable language_">this</span>.<span class="property">keys</span>.<span class="title function_">get</span>(keyCode)</span><br><span class="line">    <span class="keyword">return</span> keyData ? keyData.<span class="property">pressed</span> : <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">isMouseButtonPressed</span>(<span class="params">button</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> buttonData = <span class="variable language_">this</span>.<span class="property">mouseButtons</span>.<span class="title function_">get</span>(button)</span><br><span class="line">    <span class="keyword">return</span> buttonData ? buttonData.<span class="property">pressed</span> : <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getMousePosition</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; ...<span class="variable language_">this</span>.<span class="property">mousePosition</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">isGamepadButtonPressed</span>(<span class="params">gamepadIndex, buttonIndex</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> gamepadData = <span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="title function_">get</span>(gamepadIndex)</span><br><span class="line">    <span class="keyword">if</span> (!gamepadData) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> gamepad = navigator.<span class="title function_">getGamepads</span>()[gamepadIndex]</span><br><span class="line">    <span class="keyword">return</span> gamepad &amp;&amp; gamepad.<span class="property">buttons</span>[buttonIndex] &amp;&amp; gamepad.<span class="property">buttons</span>[buttonIndex].<span class="property">pressed</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getGamepadAxisValue</span>(<span class="params">gamepadIndex, axisIndex</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> gamepadData = <span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="title function_">get</span>(gamepadIndex)</span><br><span class="line">    <span class="keyword">if</span> (!gamepadData) <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> gamepad = navigator.<span class="title function_">getGamepads</span>()[gamepadIndex]</span><br><span class="line">    <span class="keyword">return</span> gamepad &amp;&amp; gamepad.<span class="property">axes</span>[axisIndex] ? gamepad.<span class="property">axes</span>[axisIndex] : <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ActionManager 便捷方法</span></span><br><span class="line">  <span class="title function_">addKeyAction</span>(<span class="params">keyCode, trigger, callback</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> action = <span class="keyword">new</span> <span class="title class_">ExecuteCodeAction</span>(trigger || <span class="title class_">ActionManager</span>.<span class="property">OnKeyDownTrigger</span>, callback)</span><br><span class="line">    action.<span class="property">trigger</span>.<span class="property">parameter</span> = keyCode</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">actionManager</span>.<span class="title function_">registerAction</span>(action)</span><br><span class="line">    <span class="keyword">return</span> action</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">addPointerAction</span>(<span class="params">trigger, callback, condition = <span class="literal">null</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> action = <span class="keyword">new</span> <span class="title class_">ExecuteCodeAction</span>(trigger, callback)</span><br><span class="line">    <span class="keyword">if</span> (condition) &#123;</span><br><span class="line">      action.<span class="property">trigger</span>.<span class="property">parameter</span> = condition</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">actionManager</span>.<span class="title function_">registerAction</span>(action)</span><br><span class="line">    <span class="keyword">return</span> action</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 组合按键检测</span></span><br><span class="line">  <span class="title function_">areKeysPressed</span>(<span class="params">keyCodes</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> keyCodes.<span class="title function_">every</span>(<span class="function">(<span class="params">keyCode</span>) =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">isKeyPressed</span>(keyCode))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 快捷键绑定</span></span><br><span class="line">  <span class="title function_">bindShortcut</span>(<span class="params">keys, callback, description = <span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> shortcut = &#123;</span><br><span class="line">      <span class="attr">keys</span>: <span class="title class_">Array</span>.<span class="title function_">isArray</span>(keys) ? keys : [keys],</span><br><span class="line">      <span class="attr">callback</span>: callback,</span><br><span class="line">      <span class="attr">description</span>: description,</span><br><span class="line">      <span class="attr">active</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 每帧检查快捷键</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">checkShortcut</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (shortcut.<span class="property">active</span> &amp;&amp; <span class="variable language_">this</span>.<span class="title function_">areKeysPressed</span>(shortcut.<span class="property">keys</span>)) &#123;</span><br><span class="line">        <span class="title function_">callback</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">registerBeforeRender</span>(checkShortcut)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">unbind</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        shortcut.<span class="property">active</span> = <span class="literal">false</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">unregisterBeforeRender</span>(checkShortcut)</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">description</span>: shortcut.<span class="property">description</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 虚拟摇杆支持（移动端）</span></span><br><span class="line">  <span class="title function_">createVirtualJoystick</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title class_">VirtualJoystick</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;VirtualJoystick 不可用&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> joystick = <span class="keyword">new</span> <span class="title class_">VirtualJoystick</span>(options.<span class="property">leftJoystick</span> !== <span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置回调</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">onMove</span>) &#123;</span><br><span class="line">      joystick.<span class="title function_">setJoystickSensibility</span>(options.<span class="property">sensitivity</span> || <span class="number">25</span>)</span><br><span class="line">      joystick.<span class="property">onPointerDown</span> = options.<span class="property">onPointerDown</span></span><br><span class="line">      joystick.<span class="property">onPointerUp</span> = options.<span class="property">onPointerUp</span></span><br><span class="line">      joystick.<span class="property">onPointerMove</span> = options.<span class="property">onMove</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> joystick</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 触摸手势支持</span></span><br><span class="line">  <span class="title function_">setupTouchGestures</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">ontouchstart</span> === <span class="literal">undefined</span>) <span class="keyword">return</span> <span class="comment">// 不是触摸设备</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> touchStartTime = <span class="number">0</span></span><br><span class="line">    <span class="keyword">let</span> touchStartPos = &#123; <span class="attr">x</span>: <span class="number">0</span>, <span class="attr">y</span>: <span class="number">0</span> &#125;</span><br><span class="line">    <span class="keyword">let</span> lastTouchDistance = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;touchstart&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">      touchStartTime = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">      <span class="keyword">if</span> (event.<span class="property">touches</span>.<span class="property">length</span> === <span class="number">1</span>) &#123;</span><br><span class="line">        touchStartPos.<span class="property">x</span> = event.<span class="property">touches</span>[<span class="number">0</span>].<span class="property">clientX</span></span><br><span class="line">        touchStartPos.<span class="property">y</span> = event.<span class="property">touches</span>[<span class="number">0</span>].<span class="property">clientY</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.<span class="property">touches</span>.<span class="property">length</span> === <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> touch1 = event.<span class="property">touches</span>[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">const</span> touch2 = event.<span class="property">touches</span>[<span class="number">1</span>]</span><br><span class="line">        lastTouchDistance = <span class="title class_">Math</span>.<span class="title function_">sqrt</span>(</span><br><span class="line">          <span class="title class_">Math</span>.<span class="title function_">pow</span>(touch2.<span class="property">clientX</span> - touch1.<span class="property">clientX</span>, <span class="number">2</span>) +</span><br><span class="line">            <span class="title class_">Math</span>.<span class="title function_">pow</span>(touch2.<span class="property">clientY</span> - touch1.<span class="property">clientY</span>, <span class="number">2</span>),</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;touchend&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> touchDuration = <span class="title class_">Date</span>.<span class="title function_">now</span>() - touchStartTime</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (event.<span class="property">changedTouches</span>.<span class="property">length</span> === <span class="number">1</span> &amp;&amp; touchDuration &lt; <span class="number">300</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> touch = event.<span class="property">changedTouches</span>[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">const</span> deltaX = <span class="title class_">Math</span>.<span class="title function_">abs</span>(touch.<span class="property">clientX</span> - touchStartPos.<span class="property">x</span>)</span><br><span class="line">        <span class="keyword">const</span> deltaY = <span class="title class_">Math</span>.<span class="title function_">abs</span>(touch.<span class="property">clientY</span> - touchStartPos.<span class="property">y</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (deltaX &lt; <span class="number">10</span> &amp;&amp; deltaY &lt; <span class="number">10</span>) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">onTap</span> &amp;&amp; <span class="variable language_">this</span>.<span class="title function_">onTap</span>(touch)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;touchmove&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (event.<span class="property">touches</span>.<span class="property">length</span> === <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> touch1 = event.<span class="property">touches</span>[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">const</span> touch2 = event.<span class="property">touches</span>[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">const</span> currentDistance = <span class="title class_">Math</span>.<span class="title function_">sqrt</span>(</span><br><span class="line">          <span class="title class_">Math</span>.<span class="title function_">pow</span>(touch2.<span class="property">clientX</span> - touch1.<span class="property">clientX</span>, <span class="number">2</span>) +</span><br><span class="line">            <span class="title class_">Math</span>.<span class="title function_">pow</span>(touch2.<span class="property">clientY</span> - touch1.<span class="property">clientY</span>, <span class="number">2</span>),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> scale = currentDistance / lastTouchDistance</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">onPinch</span> &amp;&amp; <span class="variable language_">this</span>.<span class="title function_">onPinch</span>(scale)</span><br><span class="line">        lastTouchDistance = currentDistance</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 触摸回调设置</span></span><br><span class="line">  <span class="title function_">onTap</span>(<span class="params">touch</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Tap detected at:&#x27;</span>, touch.<span class="property">clientX</span>, touch.<span class="property">clientY</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onPinch</span>(<span class="params">scale</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Pinch detected, scale:&#x27;</span>, scale)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取输入状态信息</span></span><br><span class="line">  <span class="title function_">getInputState</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">keyboard</span>: &#123;</span><br><span class="line">        <span class="attr">pressedKeys</span>: <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="variable language_">this</span>.<span class="property">keys</span>.<span class="title function_">entries</span>()).<span class="title function_">filter</span>(<span class="function">(<span class="params">[, data]</span>) =&gt;</span> data.<span class="property">pressed</span>),</span><br><span class="line">        <span class="attr">keyCount</span>: <span class="variable language_">this</span>.<span class="property">keys</span>.<span class="property">size</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">mouse</span>: &#123;</span><br><span class="line">        <span class="attr">position</span>: <span class="variable language_">this</span>.<span class="property">mousePosition</span>,</span><br><span class="line">        <span class="attr">pressedButtons</span>: <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="variable language_">this</span>.<span class="property">mouseButtons</span>.<span class="title function_">entries</span>()).<span class="title function_">filter</span>(<span class="function">(<span class="params">[, data]</span>) =&gt;</span> data.<span class="property">pressed</span>),</span><br><span class="line">        <span class="attr">buttonCount</span>: <span class="variable language_">this</span>.<span class="property">mouseButtons</span>.<span class="property">size</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">gamepad</span>: &#123;</span><br><span class="line">        <span class="attr">connectedGamepads</span>: <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="title function_">keys</span>()),</span><br><span class="line">        <span class="attr">gamepadCount</span>: <span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="property">size</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 资源清理</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 清理键盘监听器</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">keyboardObservables</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">observable</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onKeyboardObservable</span>.<span class="title function_">remove</span>(observable)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">keyboardObservables</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理指针监听器</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pointerObservables</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">observable</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onPointerObservable</span>.<span class="title function_">remove</span>(observable)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pointerObservables</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理游戏手柄监听器</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">gamepadCheckInterval</span>) &#123;</span><br><span class="line">      <span class="built_in">clearInterval</span>(<span class="variable language_">this</span>.<span class="property">gamepadCheckInterval</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理状态</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">keys</span>.<span class="title function_">clear</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mouseButtons</span>.<span class="title function_">clear</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> inputManager = <span class="keyword">new</span> <span class="title class_">InputManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 键盘事件重写示例</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomInputManager</span> <span class="keyword">extends</span> <span class="title class_ inherited__">InputManager</span> &#123;</span><br><span class="line">  <span class="title function_">onKeyDown</span>(<span class="params">event</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (event.<span class="property">code</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;KeyW&#x27;</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;向前移动&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;KeyS&#x27;</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;向后移动&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;KeyA&#x27;</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;向左移动&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;KeyD&#x27;</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;向右移动&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;Space&#x27;</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;跳跃&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onPointerDown</span>(<span class="params">event, pointerInfo</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (event.<span class="property">button</span> === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 左键</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;射击&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.<span class="property">button</span> === <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="comment">// 右键</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;瞄准&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建自定义输入管理器</span></span><br><span class="line"><span class="keyword">const</span> customInput = <span class="keyword">new</span> <span class="title class_">CustomInputManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绑定快捷键</span></span><br><span class="line"><span class="keyword">const</span> saveShortcut = customInput.<span class="title function_">bindShortcut</span>(</span><br><span class="line">  [<span class="string">&#x27;ControlLeft&#x27;</span>, <span class="string">&#x27;KeyS&#x27;</span>],</span><br><span class="line">  <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;保存游戏&#x27;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&#x27;保存游戏 (Ctrl+S)&#x27;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查输入状态</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;是否按下W键:&#x27;</span>, customInput.<span class="title function_">isKeyPressed</span>(<span class="string">&#x27;KeyW&#x27;</span>))</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;鼠标位置:&#x27;</span>, customInput.<span class="title function_">getMousePosition</span>())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 触摸手势支持</span></span><br><span class="line">customInput.<span class="title function_">setupTouchGestures</span>()</span><br><span class="line">customInput.<span class="property">onTap</span> = <span class="function">(<span class="params">touch</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;点击位置:&#x27;</span>, touch.<span class="property">clientX</span>, touch.<span class="property">clientY</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加ActionManager动作</span></span><br><span class="line">customInput.<span class="title function_">addKeyAction</span>(<span class="string">&#x27;KeyE&#x27;</span>, <span class="title class_">ActionManager</span>.<span class="property">OnKeyDownTrigger</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;互动&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="🔧-Asset-资源管理详解"><a href="#🔧-Asset-资源管理详解" class="headerlink" title="🔧 Asset 资源管理详解"></a>🔧 Asset 资源管理详解</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Asset 资源管理完整管理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AssetManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span> = scene.<span class="title function_">getEngine</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 资源容器</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">assetContainers</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">textures</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">models</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sounds</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载状态</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loadingTasks</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loadedAssets</span> = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">failedAssets</span> = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">baseUrl</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">enableCaching</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maxConcurrentLoads</span> = <span class="number">6</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">retryAttempts</span> = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupDefaultConfiguration</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupDefaultConfiguration</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 设置SceneLoader插件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">enableLoaderPlugins</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置缓存策略</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupCaching</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">enableLoaderPlugins</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 确保必要的loader插件可用</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="title class_">GLTFFileLoader</span> !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable constant_">BABYLON</span>.<span class="property">SceneLoader</span>.<span class="title class_">RegisterPlugin</span>(<span class="keyword">new</span> <span class="title class_">GLTFFileLoader</span>())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="title class_">OBJFileLoader</span> !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable constant_">BABYLON</span>.<span class="property">SceneLoader</span>.<span class="title class_">RegisterPlugin</span>(<span class="keyword">new</span> <span class="title class_">OBJFileLoader</span>())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;资源加载器插件已启用&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupCaching</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">enableCaching</span>) &#123;</span><br><span class="line">      <span class="comment">// 设置纹理缓存</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">enableOfflineSupport</span> = <span class="literal">false</span> <span class="comment">// 根据需要调整</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;资源缓存已启用&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 加载3D模型</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadModel</span>(<span class="params">name, url, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> fullUrl = <span class="variable language_">this</span>.<span class="property">baseUrl</span> + url</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`开始加载模型: <span class="subst">$&#123;name&#125;</span> from <span class="subst">$&#123;fullUrl&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title class_">SceneLoader</span>.<span class="title class_">ImportMeshAsync</span>(</span><br><span class="line">        options.<span class="property">meshNames</span> || <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        fullUrl,</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">        options.<span class="property">onProgress</span>,</span><br><span class="line">        options.<span class="property">pluginExtension</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 创建资源容器</span></span><br><span class="line">      <span class="keyword">const</span> container = <span class="keyword">new</span> <span class="title class_">AssetContainer</span>(<span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 添加加载的资源到容器</span></span><br><span class="line">      result.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">        container.<span class="property">meshes</span>.<span class="title function_">push</span>(mesh)</span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">position</span>) mesh.<span class="property">position</span> = options.<span class="property">position</span></span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">rotation</span>) mesh.<span class="property">rotation</span> = options.<span class="property">rotation</span></span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">scaling</span>) mesh.<span class="property">scaling</span> = options.<span class="property">scaling</span></span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      result.<span class="property">materials</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">material</span>) =&gt;</span> &#123;</span><br><span class="line">        container.<span class="property">materials</span>.<span class="title function_">push</span>(material)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      result.<span class="property">textures</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">texture</span>) =&gt;</span> &#123;</span><br><span class="line">        container.<span class="property">textures</span>.<span class="title function_">push</span>(texture)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      result.<span class="property">animationGroups</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">animGroup</span>) =&gt;</span> &#123;</span><br><span class="line">        container.<span class="property">animationGroups</span>.<span class="title function_">push</span>(animGroup)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 存储资源</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">assetContainers</span>.<span class="title function_">set</span>(name, container)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">models</span>.<span class="title function_">set</span>(name, &#123;</span><br><span class="line">        <span class="attr">container</span>: container,</span><br><span class="line">        <span class="attr">meshes</span>: result.<span class="property">meshes</span>,</span><br><span class="line">        <span class="attr">materials</span>: result.<span class="property">materials</span>,</span><br><span class="line">        <span class="attr">textures</span>: result.<span class="property">textures</span>,</span><br><span class="line">        <span class="attr">animationGroups</span>: result.<span class="property">animationGroups</span>,</span><br><span class="line">        <span class="attr">skeletons</span>: result.<span class="property">skeletons</span>,</span><br><span class="line">        <span class="attr">url</span>: fullUrl,</span><br><span class="line">        <span class="attr">loadTime</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">loadedAssets</span>.<span class="title function_">add</span>(name)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`模型加载完成: <span class="subst">$&#123;name&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> result</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`模型加载失败: <span class="subst">$&#123;name&#125;</span>`</span>, error)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">failedAssets</span>.<span class="title function_">add</span>(name)</span><br><span class="line">      <span class="keyword">throw</span> error</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 加载纹理</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadTexture</span>(<span class="params">name, url, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> fullUrl = <span class="variable language_">this</span>.<span class="property">baseUrl</span> + url</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`开始加载纹理: <span class="subst">$&#123;name&#125;</span> from <span class="subst">$&#123;fullUrl&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> texture = <span class="keyword">new</span> <span class="title class_">Texture</span>(</span><br><span class="line">        fullUrl,</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">        options.<span class="property">noMipmap</span>,</span><br><span class="line">        options.<span class="property">invertY</span>,</span><br><span class="line">        options.<span class="property">samplingMode</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 等待纹理加载完成</span></span><br><span class="line">      <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        texture.<span class="property">onLoadObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> <span class="title function_">resolve</span>(texture))</span><br><span class="line">        texture.<span class="property">onErrorObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> <span class="title function_">reject</span>(error))</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 应用纹理设置</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">wrapU</span> !== <span class="literal">undefined</span>) texture.<span class="property">wrapU</span> = options.<span class="property">wrapU</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">wrapV</span> !== <span class="literal">undefined</span>) texture.<span class="property">wrapV</span> = options.<span class="property">wrapV</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">uOffset</span> !== <span class="literal">undefined</span>) texture.<span class="property">uOffset</span> = options.<span class="property">uOffset</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">vOffset</span> !== <span class="literal">undefined</span>) texture.<span class="property">vOffset</span> = options.<span class="property">vOffset</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">uScale</span> !== <span class="literal">undefined</span>) texture.<span class="property">uScale</span> = options.<span class="property">uScale</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">vScale</span> !== <span class="literal">undefined</span>) texture.<span class="property">vScale</span> = options.<span class="property">vScale</span></span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">set</span>(name, &#123;</span><br><span class="line">        <span class="attr">texture</span>: texture,</span><br><span class="line">        <span class="attr">url</span>: fullUrl,</span><br><span class="line">        <span class="attr">options</span>: options,</span><br><span class="line">        <span class="attr">loadTime</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">loadedAssets</span>.<span class="title function_">add</span>(name)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`纹理加载完成: <span class="subst">$&#123;name&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> texture</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`纹理加载失败: <span class="subst">$&#123;name&#125;</span>`</span>, error)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">failedAssets</span>.<span class="title function_">add</span>(name)</span><br><span class="line">      <span class="keyword">throw</span> error</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 加载立方体纹理</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadCubeTexture</span>(<span class="params">name, url, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> fullUrl = <span class="variable language_">this</span>.<span class="property">baseUrl</span> + url</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`开始加载立方体纹理: <span class="subst">$&#123;name&#125;</span> from <span class="subst">$&#123;fullUrl&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> cubeTexture = <span class="keyword">new</span> <span class="title class_">CubeTexture</span>(fullUrl, <span class="variable language_">this</span>.<span class="property">scene</span>, options.<span class="property">extensions</span>, options.<span class="property">noMipmap</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 等待加载完成</span></span><br><span class="line">      <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        cubeTexture.<span class="property">onLoadObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> <span class="title function_">resolve</span>(cubeTexture))</span><br><span class="line">        cubeTexture.<span class="property">onErrorObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> <span class="title function_">reject</span>(error))</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">set</span>(name, &#123;</span><br><span class="line">        <span class="attr">texture</span>: cubeTexture,</span><br><span class="line">        <span class="attr">url</span>: fullUrl,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;cube&#x27;</span>,</span><br><span class="line">        <span class="attr">loadTime</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">loadedAssets</span>.<span class="title function_">add</span>(name)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`立方体纹理加载完成: <span class="subst">$&#123;name&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> cubeTexture</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`立方体纹理加载失败: <span class="subst">$&#123;name&#125;</span>`</span>, error)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">failedAssets</span>.<span class="title function_">add</span>(name)</span><br><span class="line">      <span class="keyword">throw</span> error</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 加载HDR环境纹理</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadHDRTexture</span>(<span class="params">name, url, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> fullUrl = <span class="variable language_">this</span>.<span class="property">baseUrl</span> + url</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`开始加载HDR纹理: <span class="subst">$&#123;name&#125;</span> from <span class="subst">$&#123;fullUrl&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> hdrTexture = <span class="keyword">new</span> <span class="title class_">HDRCubeTexture</span>(</span><br><span class="line">        fullUrl,</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">        options.<span class="property">size</span>,</span><br><span class="line">        options.<span class="property">noMipmap</span>,</span><br><span class="line">        options.<span class="property">generateHarmonics</span>,</span><br><span class="line">        options.<span class="property">useInGammaSpace</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 等待加载完成</span></span><br><span class="line">      <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        hdrTexture.<span class="property">onLoadObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> <span class="title function_">resolve</span>(hdrTexture))</span><br><span class="line">        hdrTexture.<span class="property">onErrorObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> <span class="title function_">reject</span>(error))</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">set</span>(name, &#123;</span><br><span class="line">        <span class="attr">texture</span>: hdrTexture,</span><br><span class="line">        <span class="attr">url</span>: fullUrl,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;hdr&#x27;</span>,</span><br><span class="line">        <span class="attr">loadTime</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">loadedAssets</span>.<span class="title function_">add</span>(name)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`HDR纹理加载完成: <span class="subst">$&#123;name&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> hdrTexture</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`HDR纹理加载失败: <span class="subst">$&#123;name&#125;</span>`</span>, error)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">failedAssets</span>.<span class="title function_">add</span>(name)</span><br><span class="line">      <span class="keyword">throw</span> error</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 批量加载资源</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadAssets</span>(<span class="params">assetList, onProgress = <span class="literal">null</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> tasks = []</span><br><span class="line">    <span class="keyword">const</span> results = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> asset <span class="keyword">of</span> assetList) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; type, name, url, options = &#123;&#125; &#125; = asset</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> loadTask</span><br><span class="line">      <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;model&#x27;</span>:</span><br><span class="line">          loadTask = <span class="variable language_">this</span>.<span class="title function_">loadModel</span>(name, url, options)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;texture&#x27;</span>:</span><br><span class="line">          loadTask = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(name, url, options)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;cubeTexture&#x27;</span>:</span><br><span class="line">          loadTask = <span class="variable language_">this</span>.<span class="title function_">loadCubeTexture</span>(name, url, options)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;hdrTexture&#x27;</span>:</span><br><span class="line">          loadTask = <span class="variable language_">this</span>.<span class="title function_">loadHDRTexture</span>(name, url, options)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;sound&#x27;</span>:</span><br><span class="line">          loadTask = <span class="variable language_">this</span>.<span class="title function_">loadSound</span>(name, url, options)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`未知的资源类型: <span class="subst">$&#123;type&#125;</span>`</span>)</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      tasks.<span class="title function_">push</span>(</span><br><span class="line">        loadTask</span><br><span class="line">          .<span class="title function_">then</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">            results.<span class="title function_">push</span>(&#123; name, type, <span class="attr">success</span>: <span class="literal">true</span>, result &#125;)</span><br><span class="line">            <span class="keyword">if</span> (onProgress) &#123;</span><br><span class="line">              <span class="title function_">onProgress</span>(results.<span class="property">length</span>, assetList.<span class="property">length</span>, name, type)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">          &#125;)</span><br><span class="line">          .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">            results.<span class="title function_">push</span>(&#123; name, type, <span class="attr">success</span>: <span class="literal">false</span>, error &#125;)</span><br><span class="line">            <span class="keyword">if</span> (onProgress) &#123;</span><br><span class="line">              <span class="title function_">onProgress</span>(results.<span class="property">length</span>, assetList.<span class="property">length</span>, name, type)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">          &#125;),</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(tasks)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> successful = results.<span class="title function_">filter</span>(<span class="function">(<span class="params">r</span>) =&gt;</span> r.<span class="property">success</span>).<span class="property">length</span></span><br><span class="line">    <span class="keyword">const</span> failed = results.<span class="title function_">filter</span>(<span class="function">(<span class="params">r</span>) =&gt;</span> !r.<span class="property">success</span>).<span class="property">length</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`批量加载完成: 成功 <span class="subst">$&#123;successful&#125;</span>, 失败 <span class="subst">$&#123;failed&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      results,</span><br><span class="line">      successful,</span><br><span class="line">      failed,</span><br><span class="line">      <span class="attr">successRate</span>: successful / assetList.<span class="property">length</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 克隆模型实例</span></span><br><span class="line">  <span class="title function_">cloneModel</span>(<span class="params">originalName, newName, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> modelData = <span class="variable language_">this</span>.<span class="property">models</span>.<span class="title function_">get</span>(originalName)</span><br><span class="line">    <span class="keyword">if</span> (!modelData) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`原始模型未找到: <span class="subst">$&#123;originalName&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> clonedMeshes = []</span><br><span class="line"></span><br><span class="line">    modelData.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> clonedMesh = mesh.<span class="title function_">clone</span>(newName + <span class="string">&#x27;_&#x27;</span> + mesh.<span class="property">name</span>, options.<span class="property">parent</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">position</span>) clonedMesh.<span class="property">position</span> = options.<span class="property">position</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">rotation</span>) clonedMesh.<span class="property">rotation</span> = options.<span class="property">rotation</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">scaling</span>) clonedMesh.<span class="property">scaling</span> = options.<span class="property">scaling</span></span><br><span class="line"></span><br><span class="line">      clonedMeshes.<span class="title function_">push</span>(clonedMesh)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建新的模型记录</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">models</span>.<span class="title function_">set</span>(newName, &#123;</span><br><span class="line">      ...modelData,</span><br><span class="line">      <span class="attr">meshes</span>: clonedMeshes,</span><br><span class="line">      <span class="attr">isClone</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">originalModel</span>: originalName,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`模型克隆完成: <span class="subst">$&#123;originalName&#125;</span> -&gt; <span class="subst">$&#123;newName&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">return</span> clonedMeshes</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 实例化模型</span></span><br><span class="line">  <span class="title function_">instanceModel</span>(<span class="params">originalName, newName, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> modelData = <span class="variable language_">this</span>.<span class="property">models</span>.<span class="title function_">get</span>(originalName)</span><br><span class="line">    <span class="keyword">if</span> (!modelData) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`原始模型未找到: <span class="subst">$&#123;originalName&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> instances = []</span><br><span class="line"></span><br><span class="line">    modelData.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (mesh.<span class="property">geometry</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> instance = mesh.<span class="title function_">createInstance</span>(newName + <span class="string">&#x27;_&#x27;</span> + mesh.<span class="property">name</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">position</span>) instance.<span class="property">position</span> = options.<span class="property">position</span></span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">rotation</span>) instance.<span class="property">rotation</span> = options.<span class="property">rotation</span></span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">scaling</span>) instance.<span class="property">scaling</span> = options.<span class="property">scaling</span></span><br><span class="line"></span><br><span class="line">        instances.<span class="title function_">push</span>(instance)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`模型实例化完成: <span class="subst">$&#123;originalName&#125;</span> -&gt; <span class="subst">$&#123;newName&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">return</span> instances</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加自定义资源</span></span><br><span class="line">  <span class="title function_">addCustomAssets</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 添加模型资源</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">addModelAsset</span>(<span class="string">&#x27;/models/customModel.glb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加纹理资源</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">addTextureAsset</span>(<span class="string">&#x27;/textures/customTexture.jpg&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加音频资源</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">addAudioAsset</span>(<span class="string">&#x27;/sounds/customSound.mp3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加环境资源</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">addEnvironmentAsset</span>(<span class="string">&#x27;/environments/customEnvironment.dds&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加模型资源</span></span><br><span class="line">  <span class="title function_">addModelAsset</span>(<span class="params">url</span>) &#123;</span><br><span class="line">    <span class="comment">// 创建模型资源</span></span><br><span class="line">    <span class="keyword">const</span> modelAsset = <span class="keyword">new</span> <span class="title class_">AssetContainer</span>(url, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    modelAsset.<span class="property">name</span> = url.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>).<span class="title function_">pop</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">assets</span>.<span class="title function_">set</span>(url, modelAsset)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加纹理资源</span></span><br><span class="line">  <span class="title function_">addTextureAsset</span>(<span class="params">url</span>) &#123;</span><br><span class="line">    <span class="comment">// 创建纹理资源</span></span><br><span class="line">    <span class="keyword">const</span> textureAsset = <span class="keyword">new</span> <span class="title class_">Texture</span>(url, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    textureAsset.<span class="property">name</span> = url.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>).<span class="title function_">pop</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">assets</span>.<span class="title function_">set</span>(url, textureAsset)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加音频资源</span></span><br><span class="line">  <span class="title function_">addAudioAsset</span>(<span class="params">url</span>) &#123;</span><br><span class="line">    <span class="comment">// 创建音频资源</span></span><br><span class="line">    <span class="keyword">const</span> audioAsset = <span class="keyword">new</span> <span class="title class_">Audio</span>(url, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    audioAsset.<span class="property">name</span> = url.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>).<span class="title function_">pop</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">assets</span>.<span class="title function_">set</span>(url, audioAsset)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加环境资源</span></span><br><span class="line">  <span class="title function_">addEnvironmentAsset</span>(<span class="params">url</span>) &#123;</span><br><span class="line">    <span class="comment">// 创建环境资源</span></span><br><span class="line">    <span class="keyword">const</span> environmentAsset = <span class="keyword">new</span> <span class="title class_">CubeTexture</span>(url, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    environmentAsset.<span class="property">name</span> = url.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>).<span class="title function_">pop</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">assets</span>.<span class="title function_">set</span>(url, environmentAsset)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取资源信息</span></span><br><span class="line">  <span class="title function_">getAssetInfo</span>(<span class="params">assetName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> asset = <span class="variable language_">this</span>.<span class="property">assets</span>.<span class="title function_">get</span>(assetName)</span><br><span class="line">    <span class="keyword">if</span> (!asset) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> info = &#123;</span><br><span class="line">      <span class="attr">name</span>: assetName,</span><br><span class="line">      <span class="attr">type</span>: asset.<span class="title function_">getClassName</span>(),</span><br><span class="line">      <span class="attr">url</span>: asset.<span class="property">url</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 批量应用资源</span></span><br><span class="line">  <span class="title function_">applyAssets</span>(<span class="params">assets</span>) &#123;</span><br><span class="line">    assets.<span class="title function_">forEach</span>(<span class="function">(<span class="params">asset, name</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">applyAsset</span>(name, asset)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 应用资源</span></span><br><span class="line">  <span class="title function_">applyAsset</span>(<span class="params">assetName, asset</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> currentAsset = <span class="variable language_">this</span>.<span class="property">assets</span>.<span class="title function_">get</span>(assetName)</span><br><span class="line">    <span class="keyword">if</span> (!currentAsset) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    currentAsset.<span class="property">url</span> = asset.<span class="property">url</span></span><br><span class="line">    currentAsset.<span class="property">name</span> = asset.<span class="property">name</span></span><br><span class="line">    currentAsset.<span class="property">type</span> = asset.<span class="property">type</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 资源清理</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">assets</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">asset</span>) =&gt;</span> &#123;</span><br><span class="line">      asset.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">assets</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> assetManager = <span class="keyword">new</span> <span class="title class_">AssetManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加默认资源</span></span><br><span class="line">assetManager.<span class="title function_">addDefaultAssets</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加自定义资源</span></span><br><span class="line">assetManager.<span class="title function_">addCustomAssets</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取资源信息</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;资源信息:&#x27;</span>, assetManager.<span class="title function_">getAssetInfo</span>(<span class="string">&#x27;/models/defaultModel.glb&#x27;</span>))</span><br></pre></td></tr></table></figure><h2 id="⚡-Performance-性能优化详解"><a href="#⚡-Performance-性能优化详解" class="headerlink" title="⚡ Performance 性能优化详解"></a>⚡ Performance 性能优化详解</h2><h3 id="🎯-性能优化核心原则"><a href="#🎯-性能优化核心原则" class="headerlink" title="🎯 性能优化核心原则"></a>🎯 性能优化核心原则</h3><ol><li><strong>减少Draw Calls</strong> - 合并网格，使用实例化</li><li><strong>优化纹理</strong> - 压缩纹理，减少尺寸</li><li><strong>简化几何体</strong> - LOD系统，面数优化</li><li><strong>智能剔除</strong> - 视锥剔除，遮挡剔除</li><li><strong>内存管理</strong> - 及时释放资源，对象池</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 性能优化管理器</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PerformanceOptimizer</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span> = scene.<span class="title function_">getEngine</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 性能监控</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">performanceMonitor</span> = <span class="keyword">new</span> <span class="title class_">PerformanceMonitor</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fpsCounter</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">frameTime</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lastFrameTime</span> = performance.<span class="title function_">now</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 优化配置</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">config</span> = &#123;</span><br><span class="line">      <span class="attr">enableOptimizations</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">targetFPS</span>: <span class="number">60</span>,</span><br><span class="line">      <span class="attr">adaptiveQuality</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">enableLOD</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">enableFrustumCulling</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">maxLights</span>: <span class="number">8</span>,</span><br><span class="line">      <span class="attr">shadowMapSize</span>: <span class="number">1024</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">initializeOptimizations</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">initializeOptimizations</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupEngineOptimizations</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupSceneOptimizations</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupRenderingOptimizations</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">startPerformanceMonitoring</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== 引擎级优化 =====</span></span><br><span class="line">  <span class="title function_">setupEngineOptimizations</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> engine = <span class="variable language_">this</span>.<span class="property">engine</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 禁用不必要的功能</span></span><br><span class="line">    engine.<span class="property">enableOfflineSupport</span> = <span class="literal">false</span></span><br><span class="line">    engine.<span class="property">doNotHandleContextLost</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 优化WebGL状态</span></span><br><span class="line">    engine.<span class="title function_">setDepthFunction</span>(<span class="title class_">Engine</span>.<span class="property">LEQUAL</span>)</span><br><span class="line">    engine.<span class="title function_">setStencilBuffer</span>(<span class="literal">false</span>) <span class="comment">// 如果不需要模板缓冲</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自适应设备像素比</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">adaptiveQuality</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setupAdaptiveQuality</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;引擎优化设置完成&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupAdaptiveQuality</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> engine = <span class="variable language_">this</span>.<span class="property">engine</span></span><br><span class="line">    <span class="keyword">let</span> basePixelRatio = <span class="variable language_">window</span>.<span class="property">devicePixelRatio</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据性能动态调整像素比</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">registerBeforeRender</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">fpsCounter</span> &lt; <span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">targetFPS</span> * <span class="number">0.8</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> newRatio = <span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="number">0.5</span>, basePixelRatio * <span class="number">0.9</span>)</span><br><span class="line">        engine.<span class="title function_">setHardwareScalingLevel</span>(<span class="number">1</span> / newRatio)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">fpsCounter</span> &gt; <span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">targetFPS</span> * <span class="number">0.95</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> newRatio = <span class="title class_">Math</span>.<span class="title function_">min</span>(basePixelRatio, basePixelRatio * <span class="number">1.1</span>)</span><br><span class="line">        engine.<span class="title function_">setHardwareScalingLevel</span>(<span class="number">1</span> / newRatio)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== 场景级优化 =====</span></span><br><span class="line">  <span class="title function_">setupSceneOptimizations</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> scene = <span class="variable language_">this</span>.<span class="property">scene</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启用视锥剔除</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">enableFrustumCulling</span>) &#123;</span><br><span class="line">      scene.<span class="property">skipFrustumClipping</span> = <span class="literal">false</span></span><br><span class="line">      scene.<span class="property">autoClear</span> = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 优化光照</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">optimizeLighting</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 优化阴影</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">optimizeShadows</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启用实例化</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">enableInstancing</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;场景优化设置完成&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">optimizeLighting</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> scene = <span class="variable language_">this</span>.<span class="property">scene</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 限制光源数量</span></span><br><span class="line">    <span class="keyword">let</span> lightCount = <span class="number">0</span></span><br><span class="line">    scene.<span class="property">lights</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">light</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (lightCount &gt;= <span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">maxLights</span>) &#123;</span><br><span class="line">        light.<span class="title function_">setEnabled</span>(<span class="literal">false</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        lightCount++</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 禁用不需要的光照计算</span></span><br><span class="line">    scene.<span class="property">lightsEnabled</span> = lightCount &gt; <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">optimizeShadows</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> scene = <span class="variable language_">this</span>.<span class="property">scene</span></span><br><span class="line"></span><br><span class="line">    scene.<span class="property">lights</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">light</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (light.<span class="title function_">getShadowGenerator</span>()) &#123;</span><br><span class="line">        <span class="keyword">const</span> shadowGen = light.<span class="title function_">getShadowGenerator</span>()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 优化阴影贴图尺寸</span></span><br><span class="line">        shadowGen.<span class="property">mapSize</span> = <span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">shadowMapSize</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启用阴影优化</span></span><br><span class="line">        shadowGen.<span class="property">usePercentageCloserFiltering</span> = <span class="literal">false</span></span><br><span class="line">        shadowGen.<span class="property">useKernelBlur</span> = <span class="literal">false</span></span><br><span class="line">        shadowGen.<span class="property">blurKernel</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置合理的阴影距离</span></span><br><span class="line">        shadowGen.<span class="title function_">setDarkness</span>(<span class="number">0.3</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">enableInstancing</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 为相似网格启用实例化</span></span><br><span class="line">    <span class="keyword">const</span> meshGroups = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (mesh.<span class="property">geometry</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> key = mesh.<span class="property">geometry</span>.<span class="property">id</span> + <span class="string">&#x27;_&#x27;</span> + (mesh.<span class="property">material</span> ? mesh.<span class="property">material</span>.<span class="property">id</span> : <span class="string">&#x27;none&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!meshGroups.<span class="title function_">has</span>(key)) &#123;</span><br><span class="line">          meshGroups.<span class="title function_">set</span>(key, [])</span><br><span class="line">        &#125;</span><br><span class="line">        meshGroups.<span class="title function_">get</span>(key).<span class="title function_">push</span>(mesh)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对于相同几何体和材质的网格，使用实例化</span></span><br><span class="line">    meshGroups.<span class="title function_">forEach</span>(<span class="function">(<span class="params">meshes, key</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (meshes.<span class="property">length</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`发现 <span class="subst">$&#123;meshes.length&#125;</span> 个相似网格，建议使用实例化`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== 渲染优化 =====</span></span><br><span class="line">  <span class="title function_">setupRenderingOptimizations</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> scene = <span class="variable language_">this</span>.<span class="property">scene</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 优化材质</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">optimizeMaterials</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 优化纹理</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">optimizeTextures</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启用几何体优化</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">optimizeGeometry</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;渲染优化设置完成&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">optimizeMaterials</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">materials</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">material</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (material <span class="keyword">instanceof</span> <span class="title class_">StandardMaterial</span>) &#123;</span><br><span class="line">        <span class="comment">// 禁用不必要的材质特性</span></span><br><span class="line">        <span class="keyword">if</span> (!material.<span class="property">diffuseTexture</span>) material.<span class="property">disableLighting</span> = <span class="literal">false</span></span><br><span class="line">        material.<span class="property">maxSimultaneousLights</span> = <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="number">4</span>, <span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">maxLights</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 优化反射</span></span><br><span class="line">        <span class="keyword">if</span> (material.<span class="property">reflectionTexture</span>) &#123;</span><br><span class="line">          material.<span class="property">reflectionTexture</span>.<span class="property">level</span> = <span class="number">0.5</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (material <span class="keyword">instanceof</span> <span class="title class_">PBRMaterial</span>) &#123;</span><br><span class="line">        <span class="comment">// PBR材质优化</span></span><br><span class="line">        material.<span class="property">maxSimultaneousLights</span> = <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="number">4</span>, <span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">maxLights</span>)</span><br><span class="line">        material.<span class="property">useRadianceOcclusion</span> = <span class="literal">false</span></span><br><span class="line">        material.<span class="property">useHorizonOcclusion</span> = <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">optimizeTextures</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">textures</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">texture</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (texture <span class="keyword">instanceof</span> <span class="title class_">Texture</span>) &#123;</span><br><span class="line">        <span class="comment">// 设置合理的过滤模式</span></span><br><span class="line">        texture.<span class="property">samplingMode</span> = <span class="title class_">Texture</span>.<span class="property">TRILINEAR_SAMPLINGMODE</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启用纹理压缩（如果支持）</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">getCaps</span>().<span class="property">s3tc</span>) &#123;</span><br><span class="line">          <span class="comment">// 可以使用DDS压缩纹理</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 限制纹理尺寸</span></span><br><span class="line">        <span class="keyword">const</span> maxSize = <span class="number">1024</span></span><br><span class="line">        <span class="keyword">if</span> (texture.<span class="title function_">getSize</span>().<span class="property">width</span> &gt; maxSize || texture.<span class="title function_">getSize</span>().<span class="property">height</span> &gt; maxSize) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`纹理 <span class="subst">$&#123;texture.name&#125;</span> 尺寸过大，建议压缩`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">optimizeGeometry</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (mesh.<span class="property">geometry</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> vertexCount = mesh.<span class="title function_">getTotalVertices</span>()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对于高面数模型建议LOD</span></span><br><span class="line">        <span class="keyword">if</span> (vertexCount &gt; <span class="number">10000</span>) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`网格 <span class="subst">$&#123;mesh.name&#125;</span> 顶点数过多 (<span class="subst">$&#123;vertexCount&#125;</span>)，建议使用LOD`</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 合并顶点</span></span><br><span class="line">        <span class="keyword">if</span> (mesh.<span class="title function_">isVerticesDataPresent</span>(<span class="title class_">VertexBuffer</span>.<span class="property">PositionKind</span>)) &#123;</span><br><span class="line">          <span class="comment">// mesh.mergeVertices() // 谨慎使用，可能影响UV</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== LOD系统 =====</span></span><br><span class="line">  <span class="title function_">setupLODSystem</span>(<span class="params">meshes, distances = [<span class="number">10</span>, <span class="number">50</span>, <span class="number">100</span>]</span>) &#123;</span><br><span class="line">    meshes.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (mesh.<span class="property">geometry</span>) &#123;</span><br><span class="line">        <span class="comment">// 创建LOD级别</span></span><br><span class="line">        <span class="keyword">const</span> lod1 = mesh.<span class="title function_">simplify</span>(</span><br><span class="line">          [</span><br><span class="line">            &#123; <span class="attr">quality</span>: <span class="number">0.8</span>, <span class="attr">distance</span>: distances[<span class="number">0</span>] &#125;,</span><br><span class="line">            &#123; <span class="attr">quality</span>: <span class="number">0.5</span>, <span class="attr">distance</span>: distances[<span class="number">1</span>] &#125;,</span><br><span class="line">            &#123; <span class="attr">quality</span>: <span class="number">0.2</span>, <span class="attr">distance</span>: distances[<span class="number">2</span>] &#125;,</span><br><span class="line">          ],</span><br><span class="line">          <span class="literal">false</span>,</span><br><span class="line">          <span class="title class_">SimplificationType</span>.<span class="property">QUADRATIC</span>,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`为网格 <span class="subst">$&#123;mesh.name&#125;</span> 设置LOD系统`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== 对象池 =====</span></span><br><span class="line">  <span class="title function_">createObjectPool</span>(<span class="params">createFunc, resetFunc, initialSize = <span class="number">10</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> pool = []</span><br><span class="line">    <span class="keyword">const</span> inUse = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化对象池</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; initialSize; i++) &#123;</span><br><span class="line">      pool.<span class="title function_">push</span>(<span class="title function_">createFunc</span>())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="title function_">acquire</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> obj = pool.<span class="title function_">pop</span>()</span><br><span class="line">        <span class="keyword">if</span> (!obj) &#123;</span><br><span class="line">          obj = <span class="title function_">createFunc</span>()</span><br><span class="line">        &#125;</span><br><span class="line">        inUse.<span class="title function_">add</span>(obj)</span><br><span class="line">        <span class="keyword">return</span> obj</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="title function_">release</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (inUse.<span class="title function_">has</span>(obj)) &#123;</span><br><span class="line">          <span class="title function_">resetFunc</span>(obj)</span><br><span class="line">          inUse.<span class="title function_">delete</span>(obj)</span><br><span class="line">          pool.<span class="title function_">push</span>(obj)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="title function_">getStats</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          <span class="attr">poolSize</span>: pool.<span class="property">length</span>,</span><br><span class="line">          <span class="attr">inUse</span>: inUse.<span class="property">size</span>,</span><br><span class="line">          <span class="attr">total</span>: pool.<span class="property">length</span> + inUse.<span class="property">size</span>,</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== 性能监控 =====</span></span><br><span class="line">  <span class="title function_">startPerformanceMonitoring</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> scene = <span class="variable language_">this</span>.<span class="property">scene</span></span><br><span class="line"></span><br><span class="line">    scene.<span class="title function_">registerBeforeRender</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> currentTime = performance.<span class="title function_">now</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">frameTime</span> = currentTime - <span class="variable language_">this</span>.<span class="property">lastFrameTime</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">fpsCounter</span> = <span class="number">1000</span> / <span class="variable language_">this</span>.<span class="property">frameTime</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">lastFrameTime</span> = currentTime</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 更新性能监控器</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">performanceMonitor</span>.<span class="title function_">sampleFrame</span>(currentTime)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定期输出性能报告</span></span><br><span class="line">    <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">generatePerformanceReport</span>()</span><br><span class="line">    &#125;, <span class="number">5000</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">generatePerformanceReport</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> engine = <span class="variable language_">this</span>.<span class="property">engine</span></span><br><span class="line">    <span class="keyword">const</span> scene = <span class="variable language_">this</span>.<span class="property">scene</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> report = &#123;</span><br><span class="line">      <span class="attr">fps</span>: <span class="title class_">Math</span>.<span class="title function_">round</span>(<span class="variable language_">this</span>.<span class="property">fpsCounter</span>),</span><br><span class="line">      <span class="attr">frameTime</span>: <span class="title class_">Math</span>.<span class="title function_">round</span>(<span class="variable language_">this</span>.<span class="property">frameTime</span> * <span class="number">100</span>) / <span class="number">100</span>,</span><br><span class="line">      <span class="attr">drawCalls</span>: engine.<span class="title function_">getDrawCalls</span>(),</span><br><span class="line">      <span class="attr">meshes</span>: scene.<span class="property">meshes</span>.<span class="property">length</span>,</span><br><span class="line">      <span class="attr">materials</span>: scene.<span class="property">materials</span>.<span class="property">length</span>,</span><br><span class="line">      <span class="attr">textures</span>: scene.<span class="property">textures</span>.<span class="property">length</span>,</span><br><span class="line">      <span class="attr">lights</span>: scene.<span class="property">lights</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">l</span>) =&gt;</span> l.<span class="title function_">isEnabled</span>()).<span class="property">length</span>,</span><br><span class="line">      <span class="attr">memory</span>: &#123;</span><br><span class="line">        <span class="attr">geometries</span>: engine.<span class="title function_">getGeometriesStatistics</span>(),</span><br><span class="line">        <span class="attr">textures</span>: engine.<span class="title function_">getTexturesStatistics</span>(),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;性能报告:&#x27;</span>, report)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自动优化建议</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">generateOptimizationSuggestions</span>(report)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> report</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">generateOptimizationSuggestions</span>(<span class="params">report</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> suggestions = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (report.<span class="property">fps</span> &lt; <span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">targetFPS</span> * <span class="number">0.8</span>) &#123;</span><br><span class="line">      suggestions.<span class="title function_">push</span>(<span class="string">&#x27;FPS过低，建议：&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (report.<span class="property">drawCalls</span> &gt; <span class="number">100</span>) &#123;</span><br><span class="line">        suggestions.<span class="title function_">push</span>(<span class="string">&#x27;- 减少Draw Calls（当前：&#x27;</span> + report.<span class="property">drawCalls</span> + <span class="string">&#x27;）&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (report.<span class="property">meshes</span> &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">        suggestions.<span class="title function_">push</span>(<span class="string">&#x27;- 减少网格数量（当前：&#x27;</span> + report.<span class="property">meshes</span> + <span class="string">&#x27;）&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (report.<span class="property">lights</span> &gt; <span class="number">4</span>) &#123;</span><br><span class="line">        suggestions.<span class="title function_">push</span>(<span class="string">&#x27;- 减少光源数量（当前：&#x27;</span> + report.<span class="property">lights</span> + <span class="string">&#x27;）&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (report.<span class="property">frameTime</span> &gt; <span class="number">16.67</span>) &#123;</span><br><span class="line">      suggestions.<span class="title function_">push</span>(<span class="string">&#x27;- 帧时间过长，考虑降低渲染质量&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (suggestions.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;优化建议：&#x27;</span>, suggestions)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== 批量优化工具 =====</span></span><br><span class="line">  <span class="title function_">applyQuickOptimizations</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;应用快速优化设置...&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 引擎优化</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">setHardwareScalingLevel</span>(<span class="number">1.2</span>) <span class="comment">// 降低渲染分辨率</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 场景优化</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">skipPointerMovePicking</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">autoClear</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">autoClearDepthAndStencil</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 材质优化</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">materials</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">material</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (material <span class="keyword">instanceof</span> <span class="title class_">StandardMaterial</span>) &#123;</span><br><span class="line">        material.<span class="property">maxSimultaneousLights</span> = <span class="number">2</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阴影优化</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">lights</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">light</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (light.<span class="title function_">getShadowGenerator</span>()) &#123;</span><br><span class="line">        light.<span class="title function_">getShadowGenerator</span>().<span class="property">mapSize</span> = <span class="number">512</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;快速优化完成&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== 内存优化 =====</span></span><br><span class="line">  <span class="title function_">cleanupUnusedResources</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> scene = <span class="variable language_">this</span>.<span class="property">scene</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理未使用的纹理</span></span><br><span class="line">    scene.<span class="property">textures</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">texture</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (texture.<span class="title function_">getScene</span>() === <span class="literal">null</span>) &#123;</span><br><span class="line">        texture.<span class="title function_">dispose</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理未使用的材质</span></span><br><span class="line">    scene.<span class="property">materials</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">material</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (material.<span class="title function_">getBindedMeshes</span>().<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">        material.<span class="title function_">dispose</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理未使用的几何体</span></span><br><span class="line">    scene.<span class="property">geometries</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">geometry</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (geometry.<span class="property">meshes</span>.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">        geometry.<span class="title function_">dispose</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 强制垃圾回收（仅开发环境）</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">gc</span> &amp;&amp; <span class="keyword">typeof</span> <span class="variable language_">window</span>.<span class="property">gc</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable language_">window</span>.<span class="title function_">gc</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;资源清理完成&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 资源清理</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">performanceMonitor</span>.<span class="title function_">dispose</span>()</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;性能优化器已清理&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> optimizer = <span class="keyword">new</span> <span class="title class_">PerformanceOptimizer</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 应用快速优化</span></span><br><span class="line">optimizer.<span class="title function_">applyQuickOptimizations</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置LOD系统</span></span><br><span class="line"><span class="keyword">const</span> importantMeshes = scene.<span class="property">meshes</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">m</span>) =&gt;</span> m.<span class="title function_">getTotalVertices</span>() &gt; <span class="number">1000</span>)</span><br><span class="line">optimizer.<span class="title function_">setupLODSystem</span>(importantMeshes, [<span class="number">20</span>, <span class="number">100</span>, <span class="number">500</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建粒子对象池</span></span><br><span class="line"><span class="keyword">const</span> particlePool = optimizer.<span class="title function_">createObjectPool</span>(</span><br><span class="line">  <span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">ParticleSystem</span>(<span class="string">&#x27;pooled&#x27;</span>, <span class="number">100</span>, scene),</span><br><span class="line">  <span class="function">(<span class="params">ps</span>) =&gt;</span> &#123;</span><br><span class="line">    ps.<span class="title function_">stop</span>()</span><br><span class="line">    ps.<span class="title function_">reset</span>()</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="number">5</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取性能报告</span></span><br><span class="line"><span class="keyword">const</span> report = optimizer.<span class="title function_">generatePerformanceReport</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;当前性能：&#x27;</span>, report)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清理未使用资源</span></span><br><span class="line">optimizer.<span class="title function_">cleanupUnusedResources</span>()</span><br></pre></td></tr></table></figure><h3 id="🎯-具体优化技巧"><a href="#🎯-具体优化技巧" class="headerlink" title="🎯 具体优化技巧"></a>🎯 具体优化技巧</h3><h4 id="1-网格优化"><a href="#1-网格优化" class="headerlink" title="1. 网格优化"></a>1. 网格优化</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 合并网格减少Draw Calls</span></span><br><span class="line"><span class="keyword">const</span> merged = <span class="title class_">Mesh</span>.<span class="title class_">MergeMeshes</span>(meshesToMerge)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用实例化</span></span><br><span class="line"><span class="keyword">const</span> instances = []</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">  instances.<span class="title function_">push</span>(originalMesh.<span class="title function_">createInstance</span>(<span class="string">&#x27;instance_&#x27;</span> + i))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简化几何体</span></span><br><span class="line">mesh.<span class="title function_">simplify</span>([&#123; <span class="attr">quality</span>: <span class="number">0.5</span>, <span class="attr">distance</span>: <span class="number">100</span> &#125;])</span><br></pre></td></tr></table></figure><h4 id="2-纹理优化"><a href="#2-纹理优化" class="headerlink" title="2. 纹理优化"></a>2. 纹理优化</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 压缩纹理</span></span><br><span class="line">texture.<span class="property">format</span> = <span class="title class_">Engine</span>.<span class="property">TEXTUREFORMAT_RGB</span></span><br><span class="line">texture.<span class="property">samplingMode</span> = <span class="title class_">Texture</span>.<span class="property">BILINEAR_SAMPLINGMODE</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 纹理图集</span></span><br><span class="line"><span class="keyword">const</span> atlasTexture = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;atlas.jpg&#x27;</span>, scene)</span><br></pre></td></tr></table></figure><h4 id="3-光照优化"><a href="#3-光照优化" class="headerlink" title="3. 光照优化"></a>3. 光照优化</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 限制光源影响范围</span></span><br><span class="line">light.<span class="property">range</span> = <span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用烘焙光照</span></span><br><span class="line"><span class="keyword">const</span> bakedTexture = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;lightmap.jpg&#x27;</span>, scene)</span><br><span class="line">material.<span class="property">lightmapTexture</span> = bakedTexture</span><br></pre></td></tr></table></figure><h4 id="4-渲染管线优化"><a href="#4-渲染管线优化" class="headerlink" title="4. 渲染管线优化"></a>4. 渲染管线优化</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 禁用不必要的渲染特性（指针移动拾取）</span></span><br><span class="line">scene.<span class="property">skipPointerMovePicking</span> = <span class="literal">true</span></span><br><span class="line">scene.<span class="property">constantlyUpdateMeshUnderPointer</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义渲染顺序（不透明/透明分组）</span></span><br><span class="line">scene.<span class="title function_">setRenderingOrder</span>(</span><br><span class="line">  <span class="number">0</span>, <span class="comment">// opaque sorting (默认即可)</span></span><br><span class="line">  <span class="literal">null</span>, <span class="comment">// alpha test sorting</span></span><br><span class="line">  <span class="function">(<span class="params">a, b</span>) =&gt;</span> a.<span class="property">position</span>.<span class="property">z</span> - b.<span class="property">position</span>.<span class="property">z</span>, <span class="comment">// transparent: 前后排序，按需定制</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 请求渲染模式：仅在变化时渲染（降低功耗）</span></span><br><span class="line">engine.<span class="title function_">setHardwareScalingLevel</span>(isMobile ? <span class="number">1.5</span> : <span class="number">1.0</span>)</span><br><span class="line">scene.<span class="title function_">getEngine</span>().<span class="property">renderEvenInBackground</span> = <span class="literal">false</span></span><br><span class="line">scene.<span class="property">onAfterRenderObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 空闲阶段不强制刷新</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认渲染管线按需启用</span></span><br><span class="line"><span class="keyword">const</span> pipeline = <span class="keyword">new</span> <span class="title class_">DefaultRenderingPipeline</span>(<span class="string">&#x27;default&#x27;</span>, <span class="literal">true</span>, scene, [camera])</span><br><span class="line">pipeline.<span class="property">bloomEnabled</span> = <span class="literal">false</span></span><br><span class="line">pipeline.<span class="property">depthOfFieldEnabled</span> = <span class="literal">false</span></span><br><span class="line">pipeline.<span class="property">chromaticAberrationEnabled</span> = <span class="literal">false</span></span><br><span class="line">pipeline.<span class="property">grainEnabled</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 仅桌面端启用轻量 Bloom</span></span><br><span class="line"><span class="keyword">if</span> (!isMobile) &#123;</span><br><span class="line">  pipeline.<span class="property">bloomEnabled</span> = <span class="literal">true</span></span><br><span class="line">  pipeline.<span class="property">bloomThreshold</span> = <span class="number">0.95</span></span><br><span class="line">  pipeline.<span class="property">bloomKernel</span> = <span class="number">24</span></span><br><span class="line">  pipeline.<span class="property">bloomWeight</span> = <span class="number">0.4</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 移动端禁用 SSAO/高成本效果</span></span><br></pre></td></tr></table></figure><p>小清单：</p><ul><li>优先关闭未使用的后处理；移动端禁用 SSAO&#x2F;高核 Bloom&#x2F;DoF。</li><li>启用请求渲染模式，减少空帧渲染。</li><li>透明对象排序自定义，避免过度 overdraw。</li><li>分辨率按设备 <code>setHardwareScalingLevel()</code> 动态调整。</li></ul><h2 id="🎯-最佳实践"><a href="#🎯-最佳实践" class="headerlink" title="🎯 最佳实践"></a>🎯 最佳实践</h2><h3 id="🏗️-项目结构最佳实践"><a href="#🏗️-项目结构最佳实践" class="headerlink" title="🏗️ 项目结构最佳实践"></a>🏗️ 项目结构最佳实践</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 推荐的项目结构</span></span><br><span class="line">project/</span><br><span class="line">├── src/</span><br><span class="line">│   ├── scenes/          <span class="comment">// 场景管理</span></span><br><span class="line">│   ├── models/          <span class="comment">// 3D模型</span></span><br><span class="line">│   ├── materials/       <span class="comment">// 材质库</span></span><br><span class="line">│   ├── animations/      <span class="comment">// 动画控制</span></span><br><span class="line">│   ├── utils/           <span class="comment">// 工具函数</span></span><br><span class="line">│   └── main.<span class="property">js</span>          <span class="comment">// 入口文件</span></span><br><span class="line">├── assets/</span><br><span class="line">│   ├── models/          <span class="comment">// .glb, .babylon文件</span></span><br><span class="line">│   ├── textures/        <span class="comment">// 纹理贴图</span></span><br><span class="line">│   ├── sounds/          <span class="comment">// 音频文件</span></span><br><span class="line">│   └── environments/    <span class="comment">// 环境贴图</span></span><br><span class="line">└── public/</span><br><span class="line">    └── babylon/         <span class="comment">// BabylonJS库文件</span></span><br></pre></td></tr></table></figure><h3 id="📝-代码组织最佳实践"><a href="#📝-代码组织最佳实践" class="headerlink" title="📝 代码组织最佳实践"></a>📝 代码组织最佳实践</h3><h4 id="1-场景管理"><a href="#1-场景管理" class="headerlink" title="1. 场景管理"></a>1. 场景管理</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SceneManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">canvas</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span> = <span class="keyword">new</span> <span class="title class_">Engine</span>(canvas, <span class="literal">true</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = <span class="keyword">new</span> <span class="title class_">Scene</span>(<span class="variable language_">this</span>.<span class="property">engine</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupBasicScene</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupBasicScene</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 相机</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span> = <span class="keyword">new</span> <span class="title class_">ArcRotateCamera</span>(<span class="string">&#x27;camera&#x27;</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="title class_">Vector3</span>.<span class="title class_">Zero</span>(), <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">attachToCanvas</span>(<span class="variable language_">this</span>.<span class="property">canvas</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 光照</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">light</span> = <span class="keyword">new</span> <span class="title class_">HemisphericLight</span>(<span class="string">&#x27;light&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>), <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 渲染循环</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">runRenderLoop</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">render</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">dispose</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">dispose</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-资源加载管理"><a href="#2-资源加载管理" class="headerlink" title="2. 资源加载管理"></a>2. 资源加载管理</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AssetLoader</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loadedAssets</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadAssets</span>(<span class="params">assetList</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> promises = assetList.<span class="title function_">map</span>(<span class="function">(<span class="params">asset</span>) =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">loadSingleAsset</span>(asset))</span><br><span class="line">    <span class="keyword">const</span> results = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">allSettled</span>(promises)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> results.<span class="title function_">map</span>(<span class="function">(<span class="params">result, index</span>) =&gt;</span> (&#123;</span><br><span class="line">      <span class="attr">name</span>: assetList[index].<span class="property">name</span>,</span><br><span class="line">      <span class="attr">success</span>: result.<span class="property">status</span> === <span class="string">&#x27;fulfilled&#x27;</span>,</span><br><span class="line">      <span class="attr">asset</span>: result.<span class="property">value</span> || <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">error</span>: result.<span class="property">reason</span> || <span class="literal">null</span>,</span><br><span class="line">    &#125;))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadSingleAsset</span>(<span class="params">&#123; type, name, url, options = &#123;&#125; &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> asset</span><br><span class="line">      <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;model&#x27;</span>:</span><br><span class="line">          asset = <span class="keyword">await</span> <span class="title class_">SceneLoader</span>.<span class="title class_">ImportMeshAsync</span>(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, url, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;texture&#x27;</span>:</span><br><span class="line">          asset = <span class="keyword">new</span> <span class="title class_">Texture</span>(url, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`不支持的资源类型: <span class="subst">$&#123;type&#125;</span>`</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">loadedAssets</span>.<span class="title function_">set</span>(name, asset)</span><br><span class="line">      <span class="keyword">return</span> asset</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`加载资源失败: <span class="subst">$&#123;name&#125;</span>`</span>, error)</span><br><span class="line">      <span class="keyword">throw</span> error</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-错误处理"><a href="#3-错误处理" class="headerlink" title="3. 错误处理"></a>3. 错误处理</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ErrorHandler</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">handleError</span>(<span class="params">error, context = <span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`BabylonJS错误 [<span class="subst">$&#123;context&#125;</span>]:`</span>, error)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据错误类型进行处理</span></span><br><span class="line">    <span class="keyword">if</span> (error.<span class="property">message</span>.<span class="title function_">includes</span>(<span class="string">&#x27;WebGL&#x27;</span>)) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleWebGLError</span>(error)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error.<span class="property">message</span>.<span class="title function_">includes</span>(<span class="string">&#x27;loading&#x27;</span>)) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleLoadingError</span>(error)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleGenericError</span>(error)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">handleWebGLError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="title function_">alert</span>(<span class="string">&#x27;WebGL不支持或已禁用，请更新浏览器或启用硬件加速&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">handleLoadingError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;资源加载失败，将使用默认资源&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">handleGenericError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 通用错误处理</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">isDevelopment</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> error <span class="comment">// 开发环境抛出错误</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="🎨-开发最佳实践"><a href="#🎨-开发最佳实践" class="headerlink" title="🎨 开发最佳实践"></a>🎨 开发最佳实践</h3><h4 id="1-性能优化原则"><a href="#1-性能优化原则" class="headerlink" title="1. 性能优化原则"></a>1. 性能优化原则</h4><ul><li><strong>避免在渲染循环中创建对象</strong></li><li><strong>使用对象池管理频繁创建&#x2F;销毁的对象</strong></li><li><strong>合理使用LOD和实例化</strong></li><li><strong>及时释放不用的资源</strong></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误示例 - 在渲染循环中创建对象</span></span><br><span class="line">scene.<span class="title function_">registerBeforeRender</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> newVector = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>) <span class="comment">// 每帧都创建新对象</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确示例 - 重用对象</span></span><br><span class="line"><span class="keyword">const</span> reusableVector = <span class="keyword">new</span> <span class="title class_">Vector3</span>()</span><br><span class="line">scene.<span class="title function_">registerBeforeRender</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  reusableVector.<span class="title function_">set</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>) <span class="comment">// 重用现有对象</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="2-内存管理"><a href="#2-内存管理" class="headerlink" title="2. 内存管理"></a>2. 内存管理</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ResourceManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">disposables</span> = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">addDisposable</span>(<span class="params">resource</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">disposables</span>.<span class="title function_">add</span>(resource)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">disposables</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">resource</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (resource.<span class="property">dispose</span>) &#123;</span><br><span class="line">        resource.<span class="title function_">dispose</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">disposables</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-调试技巧"><a href="#3-调试技巧" class="headerlink" title="3. 调试技巧"></a>3. 调试技巧</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启用调试功能</span></span><br><span class="line">scene.<span class="property">debugLayer</span>.<span class="title function_">show</span>(&#123;</span><br><span class="line">  <span class="attr">overlay</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">showExplorer</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">showInspector</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 性能计数器</span></span><br><span class="line">scene.<span class="title function_">registerBeforeRender</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">isDevelopment</span> &amp;&amp; <span class="title class_">Math</span>.<span class="title function_">random</span>() &lt; <span class="number">0.01</span>) &#123;</span><br><span class="line">    <span class="comment">// 1%概率输出</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(&#123;</span><br><span class="line">      <span class="attr">fps</span>: engine.<span class="title function_">getFps</span>(),</span><br><span class="line">      <span class="attr">meshes</span>: scene.<span class="property">meshes</span>.<span class="property">length</span>,</span><br><span class="line">      <span class="attr">drawCalls</span>: engine.<span class="title function_">getDrawCalls</span>(),</span><br><span class="line">      <span class="attr">materials</span>: scene.<span class="property">materials</span>.<span class="property">length</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="🛡️-安全性最佳实践"><a href="#🛡️-安全性最佳实践" class="headerlink" title="🛡️ 安全性最佳实践"></a>🛡️ 安全性最佳实践</h3><h4 id="1-输入验证"><a href="#1-输入验证" class="headerlink" title="1. 输入验证"></a>1. 输入验证</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">validateAssetUrl</span>(<span class="params">url</span>) &#123;</span><br><span class="line">  <span class="comment">// 只允许特定域名和文件类型</span></span><br><span class="line">  <span class="keyword">const</span> allowedDomains = [<span class="string">&#x27;your-cdn.com&#x27;</span>, <span class="string">&#x27;localhost&#x27;</span>]</span><br><span class="line">  <span class="keyword">const</span> allowedExtensions = [<span class="string">&#x27;.glb&#x27;</span>, <span class="string">&#x27;.babylon&#x27;</span>, <span class="string">&#x27;.jpg&#x27;</span>, <span class="string">&#x27;.png&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> urlObj = <span class="keyword">new</span> <span class="title function_">URL</span>(url)</span><br><span class="line">    <span class="keyword">const</span> isValidDomain = allowedDomains.<span class="title function_">some</span>(</span><br><span class="line">      <span class="function">(<span class="params">domain</span>) =&gt;</span> urlObj.<span class="property">hostname</span> === domain || urlObj.<span class="property">hostname</span>.<span class="title function_">endsWith</span>(<span class="string">&#x27;.&#x27;</span> + domain),</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">const</span> isValidExtension = allowedExtensions.<span class="title function_">some</span>(<span class="function">(<span class="params">ext</span>) =&gt;</span></span><br><span class="line">      urlObj.<span class="property">pathname</span>.<span class="title function_">toLowerCase</span>().<span class="title function_">endsWith</span>(ext),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> isValidDomain &amp;&amp; isValidExtension</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-资源限制"><a href="#2-资源限制" class="headerlink" title="2. 资源限制"></a>2. 资源限制</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">RESOURCE_LIMITS</span> = &#123;</span><br><span class="line">  <span class="attr">maxMeshes</span>: <span class="number">1000</span>,</span><br><span class="line">  <span class="attr">maxMaterials</span>: <span class="number">100</span>,</span><br><span class="line">  <span class="attr">maxTextures</span>: <span class="number">200</span>,</span><br><span class="line">  <span class="attr">maxTextureSize</span>: <span class="number">2048</span>,</span><br><span class="line">  <span class="attr">maxVerticesPerMesh</span>: <span class="number">50000</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">validateResourceLimits</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> issues = []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (scene.<span class="property">meshes</span>.<span class="property">length</span> &gt; <span class="variable constant_">RESOURCE_LIMITS</span>.<span class="property">maxMeshes</span>) &#123;</span><br><span class="line">    issues.<span class="title function_">push</span>(<span class="string">`网格数量超限: <span class="subst">$&#123;scene.meshes.length&#125;</span>/<span class="subst">$&#123;RESOURCE_LIMITS.maxMeshes&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  scene.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mesh.<span class="title function_">getTotalVertices</span>() &gt; <span class="variable constant_">RESOURCE_LIMITS</span>.<span class="property">maxVerticesPerMesh</span>) &#123;</span><br><span class="line">      issues.<span class="title function_">push</span>(<span class="string">`网格 <span class="subst">$&#123;mesh.name&#125;</span> 顶点数过多: <span class="subst">$&#123;mesh.getTotalVertices()&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> issues</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="📱-移动端优化最佳实践"><a href="#📱-移动端优化最佳实践" class="headerlink" title="📱 移动端优化最佳实践"></a>📱 移动端优化最佳实践</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测移动设备</span></span><br><span class="line"><span class="keyword">const</span> isMobile = <span class="regexp">/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i</span>.<span class="title function_">test</span>(</span><br><span class="line">  navigator.<span class="property">userAgent</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isMobile) &#123;</span><br><span class="line">  <span class="comment">// 移动端优化设置</span></span><br><span class="line">  engine.<span class="title function_">setHardwareScalingLevel</span>(<span class="number">1.5</span>) <span class="comment">// 降低分辨率</span></span><br><span class="line">  scene.<span class="property">skipPointerMovePicking</span> = <span class="literal">true</span> <span class="comment">// 禁用鼠标移动拾取</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 简化材质</span></span><br><span class="line">  scene.<span class="property">materials</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">material</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (material <span class="keyword">instanceof</span> <span class="title class_">StandardMaterial</span>) &#123;</span><br><span class="line">      material.<span class="property">maxSimultaneousLights</span> = <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 启用触摸控制</span></span><br><span class="line">  scene.<span class="property">actionManager</span> = <span class="keyword">new</span> <span class="title class_">ActionManager</span>(scene)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="🎯-部署最佳实践"><a href="#🎯-部署最佳实践" class="headerlink" title="🎯 部署最佳实践"></a>🎯 部署最佳实践</h3><h4 id="1-生产环境配置"><a href="#1-生产环境配置" class="headerlink" title="1. 生产环境配置"></a>1. 生产环境配置</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生产环境优化</span></span><br><span class="line"><span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">  <span class="comment">// 禁用调试</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="property">log</span> = <span class="function">() =&gt;</span> &#123;&#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="property">warn</span> = <span class="function">() =&gt;</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 启用压缩</span></span><br><span class="line">  <span class="title class_">Engine</span>.<span class="property">audioEngine</span>.<span class="property">useCustomUnlockedState</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 错误上报</span></span><br><span class="line">  <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 发送错误报告到服务器</span></span><br><span class="line">    <span class="title function_">sendErrorReport</span>(event.<span class="property">error</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-CDN资源配置"><a href="#2-CDN资源配置" class="headerlink" title="2. CDN资源配置"></a>2. CDN资源配置</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">CDN_CONFIG</span> = &#123;</span><br><span class="line">  <span class="attr">models</span>: <span class="string">&#x27;https://cdn.example.com/models/&#x27;</span>,</span><br><span class="line">  <span class="attr">textures</span>: <span class="string">&#x27;https://cdn.example.com/textures/&#x27;</span>,</span><br><span class="line">  <span class="attr">sounds</span>: <span class="string">&#x27;https://cdn.example.com/sounds/&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getAssetUrl</span>(<span class="params">type, filename</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> baseUrl = <span class="variable constant_">CDN_CONFIG</span>[type] || <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="keyword">return</span> baseUrl + filename</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="📚-常见问题解决方案"><a href="#📚-常见问题解决方案" class="headerlink" title="📚 常见问题解决方案"></a>📚 常见问题解决方案</h3><h4 id="1-WebGL上下文丢失"><a href="#1-WebGL上下文丢失" class="headerlink" title="1. WebGL上下文丢失"></a>1. WebGL上下文丢失</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">canvas.<span class="title function_">addEventListener</span>(<span class="string">&#x27;webglcontextlost&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  event.<span class="title function_">preventDefault</span>()</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;WebGL上下文丢失&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">canvas.<span class="title function_">addEventListener</span>(<span class="string">&#x27;webglcontextrestored&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;WebGL上下文已恢复&#x27;</span>)</span><br><span class="line">  <span class="comment">// 重新初始化场景</span></span><br><span class="line">  <span class="title function_">initializeScene</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="2-内存泄漏预防"><a href="#2-内存泄漏预防" class="headerlink" title="2. 内存泄漏预防"></a>2. 内存泄漏预防</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 页面卸载时清理资源</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;beforeunload&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (scene) &#123;</span><br><span class="line">    scene.<span class="title function_">dispose</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (engine) &#123;</span><br><span class="line">    engine.<span class="title function_">dispose</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="3-异步加载处理"><a href="#3-异步加载处理" class="headerlink" title="3. 异步加载处理"></a>3. 异步加载处理</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">safeAsyncLoad</span>(<span class="params">loadFunction</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> timeout = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">_, reject</span>) =&gt;</span> <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;加载超时&#x27;</span>)), <span class="number">30000</span>))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">race</span>([<span class="title function_">loadFunction</span>(), timeout])</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;异步加载失败:&#x27;</span>, error)</span><br><span class="line">    <span class="keyword">throw</span> error</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="🤝-与-Cesium-同屏叠加（单图层）实现"><a href="#🤝-与-Cesium-同屏叠加（单图层）实现" class="headerlink" title="🤝 与 Cesium 同屏叠加（单图层）实现"></a>🤝 与 Cesium 同屏叠加（单图层）实现</h2><p>实现目标：在保持 Cesium 作为底图&#x2F;地形的前提下，BabylonJS 作为透明叠加层绘制自定义 3D&#x2F;特效，两个引擎同屏显示、相机同步。</p><h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><ol><li>叠加一个透明 Canvas（置顶、事件穿透）</li></ol><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">  <span class="selector-id">#wrap</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">position</span>: relative;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css">  <span class="selector-id">#cesium</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">position</span>: absolute;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">inset</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css">  <span class="selector-id">#babylon</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">position</span>: absolute;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">inset</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">pointer-events</span>: none;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;wrap&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;cesium&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">&quot;babylon&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>初始化两个引擎（Babylon 透明&#x2F;右手系）</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cesium</span></span><br><span class="line">aaa <span class="keyword">const</span> viewer = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Viewer</span>(<span class="string">&#x27;cesium&#x27;</span>, &#123; <span class="comment">/* ...底图/地形... */</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Babylon</span></span><br><span class="line">aaa <span class="keyword">const</span> babCanvas = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;babylon&#x27;</span>)</span><br><span class="line">aaa <span class="keyword">const</span> engine = <span class="keyword">new</span> <span class="variable constant_">BABYLON</span>.<span class="title class_">Engine</span>(babCanvas, <span class="literal">true</span>, &#123; <span class="attr">alpha</span>: <span class="literal">true</span>, <span class="attr">preserveDrawingBuffer</span>: <span class="literal">true</span>, <span class="attr">stencil</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">aaa <span class="keyword">const</span> scene = <span class="keyword">new</span> <span class="variable constant_">BABYLON</span>.<span class="title class_">Scene</span>(engine)</span><br><span class="line">aaa scene.<span class="property">useRightHandedSystem</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">aaa scene.<span class="property">clearColor</span> = <span class="keyword">new</span> <span class="variable constant_">BABYLON</span>.<span class="title class_">Color4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">const</span> camera = <span class="keyword">new</span> <span class="variable constant_">BABYLON</span>.<span class="title class_">FreeCamera</span>(<span class="string">&#x27;syncCam&#x27;</span>, <span class="keyword">new</span> <span class="variable constant_">BABYLON</span>.<span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), scene)</span><br><span class="line">camera.<span class="property">minZ</span> = <span class="number">0.1</span></span><br><span class="line">camera.<span class="property">maxZ</span> = <span class="number">1e9</span></span><br></pre></td></tr></table></figure><ol start="3"><li>相机同步（每帧 Cesium 渲染完成后同步 Babylon）</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">v3</span>(<span class="params">x, y, z</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="variable constant_">BABYLON</span>.<span class="title class_">Vector3</span>(x, y, z)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">syncBabylonCamera</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> c = viewer.<span class="property">camera</span></span><br><span class="line">  <span class="keyword">const</span> pos = c.<span class="property">positionWC</span></span><br><span class="line">  <span class="keyword">const</span> dir = c.<span class="property">directionWC</span></span><br><span class="line">  <span class="keyword">const</span> up = c.<span class="property">upWC</span></span><br><span class="line"></span><br><span class="line">  camera.<span class="property">position</span> = <span class="title function_">v3</span>(pos.<span class="property">x</span>, pos.<span class="property">y</span>, pos.<span class="property">z</span>)</span><br><span class="line">  camera.<span class="property">upVector</span> = <span class="title function_">v3</span>(up.<span class="property">x</span>, up.<span class="property">y</span>, up.<span class="property">z</span>)</span><br><span class="line">  camera.<span class="title function_">setTarget</span>(<span class="title function_">v3</span>(pos.<span class="property">x</span> + dir.<span class="property">x</span>, pos.<span class="property">y</span> + dir.<span class="property">y</span>, pos.<span class="property">z</span> + dir.<span class="property">z</span>))</span><br><span class="line">  camera.<span class="property">fov</span> = c.<span class="property">frustum</span>.<span class="property">fov</span></span><br><span class="line"></span><br><span class="line">  engine.<span class="title function_">resize</span>()</span><br><span class="line">  scene.<span class="title function_">render</span>()</span><br><span class="line">&#125;</span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">postRender</span>.<span class="title function_">addEventListener</span>(syncBabylonCamera)</span><br></pre></td></tr></table></figure><ol start="4"><li>在经纬高放置 Babylon 物体（经纬高 → ECEF → ENU 矩阵）</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">enuMatrixAt</span>(<span class="params">lon, lat, alt</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> ecef = <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(lon, lat, alt)</span><br><span class="line">  <span class="keyword">const</span> m = <span class="title class_">Cesium</span>.<span class="property">Transforms</span>.<span class="title function_">eastNorthUpToFixedFrame</span>(ecef) <span class="comment">// 4x4 列主序</span></span><br><span class="line">  <span class="keyword">return</span> <span class="variable constant_">BABYLON</span>.<span class="property">Matrix</span>.<span class="title class_">FromArray</span>([</span><br><span class="line">    m[<span class="number">0</span>],</span><br><span class="line">    m[<span class="number">1</span>],</span><br><span class="line">    m[<span class="number">2</span>],</span><br><span class="line">    m[<span class="number">3</span>],</span><br><span class="line">    m[<span class="number">4</span>],</span><br><span class="line">    m[<span class="number">5</span>],</span><br><span class="line">    m[<span class="number">6</span>],</span><br><span class="line">    m[<span class="number">7</span>],</span><br><span class="line">    m[<span class="number">8</span>],</span><br><span class="line">    m[<span class="number">9</span>],</span><br><span class="line">    m[<span class="number">10</span>],</span><br><span class="line">    m[<span class="number">11</span>],</span><br><span class="line">    m[<span class="number">12</span>],</span><br><span class="line">    m[<span class="number">13</span>],</span><br><span class="line">    m[<span class="number">14</span>],</span><br><span class="line">    m[<span class="number">15</span>],</span><br><span class="line">  ])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> box = <span class="variable constant_">BABYLON</span>.<span class="property">MeshBuilder</span>.<span class="title class_">CreateBox</span>(<span class="string">&#x27;box&#x27;</span>, &#123; <span class="attr">size</span>: <span class="number">50</span> &#125;, scene)</span><br><span class="line">box.<span class="title function_">setPreTransformMatrix</span>(<span class="title function_">enuMatrixAt</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">100</span>))</span><br></pre></td></tr></table></figure><ol start="5"><li>注意事项</li></ol><ul><li>Babylon 画布透明渲染有成本：减少后处理与高开销材质</li><li>指针事件：默认穿透给 Cesium；需要 Babylon 拾取时移除 <code>pointer-events: none</code> 并进行事件路由</li><li>两引擎深度不互通：遮挡&#x2F;阴影互不影响，按需在 Babylon 内做自洽光照</li></ul><h3 id="方案优势"><a href="#方案优势" class="headerlink" title="方案优势"></a>方案优势</h3><ul><li>低耦合：两引擎互不入侵，升级&#x2F;配置互不影响</li><li>快速落地：仅需透明层 + 相机同步 + 经纬高摆放</li><li>强扩展：可将 Babylon 的 Shader&#x2F;粒子&#x2F;后处理作为“视觉层”无缝叠加到 Cesium 地理场景</li><li>跨平台稳健：不依赖私有接口，运行在常规 Web 环境</li></ul><h3 id="拓展性建议"><a href="#拓展性建议" class="headerlink" title="拓展性建议"></a>拓展性建议</h3><ul><li>事件路由：提供开关切换事件归属（Cesium&#x2F;Babylon），或按区域分配</li><li>坐标工具化：封装 <code>lonlat-&gt;ECEF-&gt;ENU</code> 与矩阵应用工具，统一放置误差</li><li>渲染策略：请求渲染模式、分辨率缩放、按需渲染（只在 Cesium 相机变化时驱动 Babylon）</li><li>组件化：抽象为 <code>CesiumBabylonOverlay</code> 类，提供 <code>addMeshAt(lon,lat,alt,mesh)</code> 等 API</li></ul><h3 id="🎉-总结"><a href="#🎉-总结" class="headerlink" title="🎉 总结"></a>🎉 总结</h3><p>遵循这些最佳实践可以帮助你：</p><ul><li><strong>提高应用性能</strong> - 通过合理的资源管理和优化</li><li><strong>增强代码可维护性</strong> - 通过清晰的结构和错误处理</li><li><strong>确保用户体验</strong> - 通过移动端优化和安全性措施</li><li><strong>简化调试过程</strong> - 通过完善的日志和监控</li></ul><p>记住，最佳实践是指导原则，需要根据具体项目需求灵活调整。持续学习和优化是BabylonJS开发的关键。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;BabylonJS-完整离线开发指南&quot;&gt;&lt;a href=&quot;#BabylonJS-完整离线开发指南&quot; class=&quot;headerlink&quot; title=&quot;BabylonJS 完整离线开发指南&quot;&gt;&lt;/a&gt;BabylonJS 完整离线开发指南&lt;/h1&gt;&lt;h2 id=&quot;�</summary>
      
    
    
    
    
    <category term="BabylonJS" scheme="https://aoayaoa.github.io/tags/BabylonJS/"/>
    
  </entry>
  
  <entry>
    <title>Cesium 开发文档</title>
    <link href="https://aoayaoa.github.io/2025/07/31/cesium/"/>
    <id>https://aoayaoa.github.io/2025/07/31/cesium/</id>
    <published>2025-07-30T16:00:00.000Z</published>
    <updated>2025-08-08T02:51:24.572Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Cesium-完整离线开发指南"><a href="#Cesium-完整离线开发指南" class="headerlink" title="Cesium 完整离线开发指南"></a>Cesium 完整离线开发指南</h1><h2 id="📋-目录"><a href="#📋-目录" class="headerlink" title="📋 目录"></a>📋 目录</h2><ul><li><a href="#%E7%A6%BB%E7%BA%BF%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE">离线环境配置</a></li><li><a href="#viewer-%E8%AF%A6%E7%BB%86%E9%85%8D%E7%BD%AE">Viewer 详细配置</a></li><li><a href="#%E5%9D%90%E6%A0%87%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">坐标系统详解</a></li><li><a href="#%E5%AE%9E%E4%BD%93%E7%B3%BB%E7%BB%9F%E5%AE%8C%E6%95%B4%E5%B1%9E%E6%80%A7">实体系统完整属性</a></li><li><a href="#%E5%BD%B1%E5%83%8F%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">影像系统详解</a></li><li><a href="#%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">地形系统详解</a></li><li><a href="#%E7%9B%B8%E6%9C%BA%E7%B3%BB%E7%BB%9F%E5%AE%8C%E6%95%B4%E5%B1%9E%E6%80%A7">相机系统完整属性</a></li><li><a href="#%E4%BA%8B%E4%BB%B6%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">事件系统详解</a></li><li><a href="#%E6%9D%90%E8%B4%A8%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">材质系统详解</a></li><li><a href="#%E5%8A%A8%E7%94%BB%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">动画系统详解</a></li><li><a href="#%E5%87%A0%E4%BD%95%E4%BD%93%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">几何体系统详解</a></li><li><a href="#%E5%9C%BA%E6%99%AF%E6%8E%A7%E5%88%B6%E8%AF%A6%E8%A7%A3">场景控制详解</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E6%BA%90%E8%AF%A6%E8%A7%A3">数据源详解</a></li><li><a href="#%E6%97%B6%E9%97%B4%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">时间系统详解</a></li><li><a href="#%E7%BB%98%E5%88%B6%E5%8A%9F%E8%83%BD%E8%AF%A6%E8%A7%A3">绘制功能详解</a></li><li><a href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E8%AF%A6%E8%A7%A3">性能优化详解</a></li></ul><h2 id="离线环境配置"><a href="#离线环境配置" class="headerlink" title="离线环境配置"></a>离线环境配置</h2><h3 id="完整离线包下载"><a href="#完整离线包下载" class="headerlink" title="完整离线包下载"></a>完整离线包下载</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 下载Cesium完整包</span></span><br><span class="line">wget https://github.com/CesiumGS/cesium/releases/download/1.110/Cesium-1.110.zip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 解压到静态资源目录</span></span><br><span class="line">unzip Cesium-1.110.zip -d public/cesium/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 项目结构</span></span><br><span class="line">public/</span><br><span class="line">├── cesium/</span><br><span class="line">│   ├── Build/</span><br><span class="line">│   │   └── Cesium/</span><br><span class="line">│   │       ├── Cesium.js          <span class="comment"># 主库文件</span></span><br><span class="line">│   │       ├── Widgets/</span><br><span class="line">│   │       │   └── widgets.css    <span class="comment"># 样式文件</span></span><br><span class="line">│   │       ├── Workers/           <span class="comment"># WebWorker文件</span></span><br><span class="line">│   │       ├── ThirdParty/        <span class="comment"># 第三方库</span></span><br><span class="line">│   │       └── Assets/            <span class="comment"># 静态资源</span></span><br><span class="line">│   └── Apps/                      <span class="comment"># 示例应用</span></span><br></pre></td></tr></table></figure><h3 id="Vite离线配置"><a href="#Vite离线配置" class="headerlink" title="Vite离线配置"></a>Vite离线配置</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.js - 离线开发配置</span></span><br><span class="line"><span class="keyword">import</span> &#123; defineConfig &#125; <span class="keyword">from</span> <span class="string">&#x27;vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; resolve &#125; <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">define</span>: &#123;</span><br><span class="line">    <span class="comment">// 定义全局常量，避免Ion依赖</span></span><br><span class="line">    <span class="attr">CESIUM_BASE_URL</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="string">&#x27;/cesium/&#x27;</span>),</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 静态资源处理</span></span><br><span class="line">  <span class="attr">publicDir</span>: <span class="string">&#x27;public&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建配置</span></span><br><span class="line">  <span class="attr">build</span>: &#123;</span><br><span class="line">    <span class="attr">rollupOptions</span>: &#123;</span><br><span class="line">      <span class="comment">// 排除不需要的依赖</span></span><br><span class="line">      <span class="attr">external</span>: [<span class="string">&#x27;@cesium/engine&#x27;</span>],</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 复制Cesium静态资源</span></span><br><span class="line">      <span class="attr">input</span>: &#123;</span><br><span class="line">        <span class="attr">main</span>: <span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;index.html&#x27;</span>),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 开发服务器配置</span></span><br><span class="line">  <span class="attr">server</span>: &#123;</span><br><span class="line">    <span class="comment">// 静态文件服务</span></span><br><span class="line">    <span class="attr">fs</span>: &#123;</span><br><span class="line">      <span class="attr">allow</span>: [<span class="string">&#x27;..&#x27;</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 优化配置</span></span><br><span class="line">  <span class="attr">optimizeDeps</span>: &#123;</span><br><span class="line">    <span class="comment">// 预构建Cesium</span></span><br><span class="line">    <span class="attr">include</span>: [<span class="string">&#x27;cesium&#x27;</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="离线初始化"><a href="#离线初始化" class="headerlink" title="离线初始化"></a>离线初始化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js - 离线初始化配置</span></span><br><span class="line"><span class="comment">// 设置Cesium基础路径</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">CESIUM_BASE_URL</span> = <span class="string">&#x27;/cesium/Build/Cesium/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 禁用Ion服务（离线环境）</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">Cesium</span> <span class="keyword">from</span> <span class="string">&#x27;cesium&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 覆盖Ion默认设置</span></span><br><span class="line"><span class="title class_">Cesium</span>.<span class="property">Ion</span>.<span class="property">defaultAccessToken</span> = <span class="literal">undefined</span></span><br><span class="line"><span class="title class_">Cesium</span>.<span class="property">Ion</span>.<span class="property">defaultServer</span> = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 离线Viewer配置</span></span><br><span class="line"><span class="keyword">const</span> viewer = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Viewer</span>(<span class="string">&#x27;cesiumContainer&#x27;</span>, &#123;</span><br><span class="line">  <span class="comment">// 关闭所有在线服务</span></span><br><span class="line">  <span class="attr">baseLayerPicker</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">geocoder</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用离线影像</span></span><br><span class="line">  <span class="attr">imageryProvider</span>: <span class="literal">false</span>, <span class="comment">// 不加载默认影像</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用本地地形</span></span><br><span class="line">  <span class="attr">terrainProvider</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">EllipsoidTerrainProvider</span>(),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="Viewer-详细配置"><a href="#Viewer-详细配置" class="headerlink" title="Viewer 详细配置"></a>Viewer 详细配置</h2><h3 id="构造函数完整参数"><a href="#构造函数完整参数" class="headerlink" title="构造函数完整参数"></a>构造函数完整参数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> viewer = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Viewer</span>(container, &#123;</span><br><span class="line">  <span class="comment">// === 基础渲染选项 ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// animation: boolean</span></span><br><span class="line">  <span class="comment">// 作用: 控制时间动画控件的显示</span></span><br><span class="line">  <span class="comment">// 默认: true</span></span><br><span class="line">  <span class="comment">// 离线建议: false（减少UI复杂度）</span></span><br><span class="line">  <span class="attr">animation</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// baseLayerPicker: boolean</span></span><br><span class="line">  <span class="comment">// 作用: 控制图层选择器的显示</span></span><br><span class="line">  <span class="comment">// 默认: true</span></span><br><span class="line">  <span class="comment">// 离线建议: false（避免在线图层依赖）</span></span><br><span class="line">  <span class="attr">baseLayerPicker</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fullscreenButton: boolean</span></span><br><span class="line">  <span class="comment">// 作用: 控制全屏按钮的显示</span></span><br><span class="line">  <span class="comment">// 默认: true</span></span><br><span class="line">  <span class="comment">// 用途: 允许用户全屏查看地图</span></span><br><span class="line">  <span class="attr">fullscreenButton</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// geocoder: boolean | GeocoderService[]</span></span><br><span class="line">  <span class="comment">// 作用: 控制地址搜索框的显示</span></span><br><span class="line">  <span class="comment">// 默认: true</span></span><br><span class="line">  <span class="comment">// 离线建议: false（需要在线服务）</span></span><br><span class="line">  <span class="attr">geocoder</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// homeButton: boolean</span></span><br><span class="line">  <span class="comment">// 作用: 控制主页按钮的显示</span></span><br><span class="line">  <span class="comment">// 默认: true</span></span><br><span class="line">  <span class="comment">// 用途: 重置到初始视角</span></span><br><span class="line">  <span class="attr">homeButton</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// infoBox: boolean</span></span><br><span class="line">  <span class="comment">// 作用: 控制信息框的显示</span></span><br><span class="line">  <span class="comment">// 默认: true</span></span><br><span class="line">  <span class="comment">// 用途: 显示实体详细信息</span></span><br><span class="line">  <span class="attr">infoBox</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sceneModePicker: boolean</span></span><br><span class="line">  <span class="comment">// 作用: 控制场景模式选择器（3D/2D/Columbus）</span></span><br><span class="line">  <span class="comment">// 默认: true</span></span><br><span class="line">  <span class="comment">// 用途: 切换不同的查看模式</span></span><br><span class="line">  <span class="attr">sceneModePicker</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// selectionIndicator: boolean</span></span><br><span class="line">  <span class="comment">// 作用: 控制选择指示器（绿色框）</span></span><br><span class="line">  <span class="comment">// 默认: true</span></span><br><span class="line">  <span class="comment">// 用途: 显示选中实体的边界框</span></span><br><span class="line">  <span class="attr">selectionIndicator</span>: <span class="literal">false</span>, <span class="comment">// 通常关闭以获得更好的视觉效果</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// timeline: boolean</span></span><br><span class="line">  <span class="comment">// 作用: 控制时间轴的显示</span></span><br><span class="line">  <span class="comment">// 默认: true</span></span><br><span class="line">  <span class="comment">// 用途: 控制时间相关的动画</span></span><br><span class="line">  <span class="attr">timeline</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// navigationHelpButton: boolean</span></span><br><span class="line">  <span class="comment">// 作用: 控制导航帮助按钮</span></span><br><span class="line">  <span class="comment">// 默认: true</span></span><br><span class="line">  <span class="comment">// 用途: 显示鼠标/触摸操作说明</span></span><br><span class="line">  <span class="attr">navigationHelpButton</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// navigationInstructionsInitiallyVisible: boolean</span></span><br><span class="line">  <span class="comment">// 作用: 控制导航说明的初始可见性</span></span><br><span class="line">  <span class="comment">// 默认: true</span></span><br><span class="line">  <span class="comment">// 用途: 页面加载时是否显示操作说明</span></span><br><span class="line">  <span class="attr">navigationInstructionsInitiallyVisible</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === 场景渲染选项 ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// scene3DOnly: boolean</span></span><br><span class="line">  <span class="comment">// 作用: 是否只支持3D模式</span></span><br><span class="line">  <span class="comment">// 默认: false</span></span><br><span class="line">  <span class="comment">// 用途: 禁用2D和Columbus模式以提升性能</span></span><br><span class="line">  <span class="attr">scene3DOnly</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// shouldAnimate: boolean</span></span><br><span class="line">  <span class="comment">// 作用: 是否启用动画</span></span><br><span class="line">  <span class="comment">// 默认: false</span></span><br><span class="line">  <span class="comment">// 用途: 控制时间动画的播放</span></span><br><span class="line">  <span class="attr">shouldAnimate</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// clockViewModel: ClockViewModel</span></span><br><span class="line">  <span class="comment">// 作用: 时钟视图模型</span></span><br><span class="line">  <span class="comment">// 默认: new ClockViewModel(clock)</span></span><br><span class="line">  <span class="comment">// 用途: 控制时间和动画</span></span><br><span class="line">  <span class="attr">clockViewModel</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ClockViewModel</span>(<span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Clock</span>()),</span><br><span class="line"></span><br><span class="line">  <span class="comment">// selectedImageryProviderViewModel: ProviderViewModel</span></span><br><span class="line">  <span class="comment">// 作用: 默认选中的影像提供者</span></span><br><span class="line">  <span class="comment">// 默认: undefined</span></span><br><span class="line">  <span class="comment">// 用途: 设置初始影像图层</span></span><br><span class="line">  <span class="attr">selectedImageryProviderViewModel</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// imageryProviderViewModels: ProviderViewModel[]</span></span><br><span class="line">  <span class="comment">// 作用: 可用的影像提供者列表</span></span><br><span class="line">  <span class="comment">// 默认: createDefaultImageryProviderViewModels()</span></span><br><span class="line">  <span class="comment">// 用途: 图层选择器中的选项</span></span><br><span class="line">  <span class="attr">imageryProviderViewModels</span>: [],</span><br><span class="line"></span><br><span class="line">  <span class="comment">// selectedTerrainProviderViewModel: ProviderViewModel</span></span><br><span class="line">  <span class="comment">// 作用: 默认选中的地形提供者</span></span><br><span class="line">  <span class="comment">// 默认: undefined</span></span><br><span class="line">  <span class="comment">// 用途: 设置初始地形</span></span><br><span class="line">  <span class="attr">selectedTerrainProviderViewModel</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// terrainProviderViewModels: ProviderViewModel[]</span></span><br><span class="line">  <span class="comment">// 作用: 可用的地形提供者列表</span></span><br><span class="line">  <span class="comment">// 默认: createDefaultTerrainProviderViewModels()</span></span><br><span class="line">  <span class="comment">// 用途: 地形选择器中的选项</span></span><br><span class="line">  <span class="attr">terrainProviderViewModels</span>: [],</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === 渲染器选项 ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// imageryProvider: ImageryProvider | false</span></span><br><span class="line">  <span class="comment">// 作用: 影像提供者</span></span><br><span class="line">  <span class="comment">// 默认: createWorldImagery()</span></span><br><span class="line">  <span class="comment">// 离线设置: 自定义离线影像或false</span></span><br><span class="line">  <span class="attr">imageryProvider</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">OpenStreetMapImageryProvider</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;https://tile.openstreetmap.org/&#x27;</span>, <span class="comment">// 或本地瓦片服务</span></span><br><span class="line">  &#125;),</span><br><span class="line"></span><br><span class="line">  <span class="comment">// terrainProvider: TerrainProvider</span></span><br><span class="line">  <span class="comment">// 作用: 地形提供者</span></span><br><span class="line">  <span class="comment">// 默认: new EllipsoidTerrainProvider()</span></span><br><span class="line">  <span class="comment">// 离线设置: EllipsoidTerrainProvider（椭球地形）</span></span><br><span class="line">  <span class="attr">terrainProvider</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">EllipsoidTerrainProvider</span>(),</span><br><span class="line"></span><br><span class="line">  <span class="comment">// skyBox: SkyBox | false</span></span><br><span class="line">  <span class="comment">// 作用: 天空盒</span></span><br><span class="line">  <span class="comment">// 默认: undefined（使用默认天空）</span></span><br><span class="line">  <span class="comment">// 用途: 自定义天空背景</span></span><br><span class="line">  <span class="attr">skyBox</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">SkyBox</span>(&#123;</span><br><span class="line">    <span class="attr">sources</span>: &#123;</span><br><span class="line">      <span class="attr">positiveX</span>: <span class="string">&#x27;path/to/skybox_px.jpg&#x27;</span>,</span><br><span class="line">      <span class="attr">negativeX</span>: <span class="string">&#x27;path/to/skybox_nx.jpg&#x27;</span>,</span><br><span class="line">      <span class="attr">positiveY</span>: <span class="string">&#x27;path/to/skybox_py.jpg&#x27;</span>,</span><br><span class="line">      <span class="attr">negativeY</span>: <span class="string">&#x27;path/to/skybox_ny.jpg&#x27;</span>,</span><br><span class="line">      <span class="attr">positiveZ</span>: <span class="string">&#x27;path/to/skybox_pz.jpg&#x27;</span>,</span><br><span class="line">      <span class="attr">negativeZ</span>: <span class="string">&#x27;path/to/skybox_nz.jpg&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;),</span><br><span class="line"></span><br><span class="line">  <span class="comment">// skyAtmosphere: SkyAtmosphere | false</span></span><br><span class="line">  <span class="comment">// 作用: 天空大气效果</span></span><br><span class="line">  <span class="comment">// 默认: undefined（使用默认大气）</span></span><br><span class="line">  <span class="comment">// 用途: 控制大气散射效果</span></span><br><span class="line">  <span class="attr">skyAtmosphere</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">SkyAtmosphere</span>(),</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === 高级渲染选项 ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// shadows: boolean</span></span><br><span class="line">  <span class="comment">// 作用: 是否启用阴影</span></span><br><span class="line">  <span class="comment">// 默认: false</span></span><br><span class="line">  <span class="comment">// 性能影响: 较大</span></span><br><span class="line">  <span class="attr">shadows</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// terrainShadows: ShadowMode</span></span><br><span class="line">  <span class="comment">// 作用: 地形阴影模式</span></span><br><span class="line">  <span class="comment">// 默认: ShadowMode.RECEIVE_ONLY</span></span><br><span class="line">  <span class="comment">// 选项: DISABLED, ENABLED, CAST_ONLY, RECEIVE_ONLY</span></span><br><span class="line">  <span class="attr">terrainShadows</span>: <span class="title class_">Cesium</span>.<span class="property">ShadowMode</span>.<span class="property">ENABLED</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mapMode2D: MapMode2D</span></span><br><span class="line">  <span class="comment">// 作用: 2D地图模式</span></span><br><span class="line">  <span class="comment">// 默认: MapMode2D.INFINITE_SCROLL</span></span><br><span class="line">  <span class="comment">// 选项: INFINITE_SCROLL, ROTATE</span></span><br><span class="line">  <span class="attr">mapMode2D</span>: <span class="title class_">Cesium</span>.<span class="property">MapMode2D</span>.<span class="property">INFINITE_SCROLL</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// projectionPicker: boolean</span></span><br><span class="line">  <span class="comment">// 作用: 投影选择器</span></span><br><span class="line">  <span class="comment">// 默认: false</span></span><br><span class="line">  <span class="comment">// 用途: 在2D模式下选择投影方式</span></span><br><span class="line">  <span class="attr">projectionPicker</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// requestRenderMode: boolean</span></span><br><span class="line">  <span class="comment">// 作用: 按需渲染模式</span></span><br><span class="line">  <span class="comment">// 默认: false</span></span><br><span class="line">  <span class="comment">// 性能优化: 只在需要时渲染</span></span><br><span class="line">  <span class="attr">requestRenderMode</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// maximumRenderTimeChange: number</span></span><br><span class="line">  <span class="comment">// 作用: 最大渲染时间变化（毫秒）</span></span><br><span class="line">  <span class="comment">// 默认: 0.0</span></span><br><span class="line">  <span class="comment">// 用途: 控制按需渲染的触发阈值</span></span><br><span class="line">  <span class="attr">maximumRenderTimeChange</span>: <span class="number">0.0</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === WebGL选项 ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// contextOptions: Object</span></span><br><span class="line">  <span class="comment">// 作用: WebGL上下文选项</span></span><br><span class="line">  <span class="comment">// 默认: undefined</span></span><br><span class="line">  <span class="comment">// 用途: 控制WebGL上下文创建</span></span><br><span class="line">  <span class="attr">contextOptions</span>: &#123;</span><br><span class="line">    <span class="attr">webgl</span>: &#123;</span><br><span class="line">      <span class="attr">alpha</span>: <span class="literal">false</span>, <span class="comment">// 透明度通道</span></span><br><span class="line">      <span class="attr">depth</span>: <span class="literal">true</span>, <span class="comment">// 深度缓冲</span></span><br><span class="line">      <span class="attr">stencil</span>: <span class="literal">false</span>, <span class="comment">// 模板缓冲</span></span><br><span class="line">      <span class="attr">antialias</span>: <span class="literal">true</span>, <span class="comment">// 抗锯齿</span></span><br><span class="line">      <span class="attr">premultipliedAlpha</span>: <span class="literal">true</span>, <span class="comment">// 预乘alpha</span></span><br><span class="line">      <span class="attr">preserveDrawingBuffer</span>: <span class="literal">false</span>, <span class="comment">// 保留绘图缓冲</span></span><br><span class="line">      <span class="attr">powerPreference</span>: <span class="string">&#x27;high-performance&#x27;</span>, <span class="comment">// 性能偏好</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// useDefaultRenderLoop: boolean</span></span><br><span class="line">  <span class="comment">// 作用: 是否使用默认渲染循环</span></span><br><span class="line">  <span class="comment">// 默认: true</span></span><br><span class="line">  <span class="comment">// 高级用途: 自定义渲染循环</span></span><br><span class="line">  <span class="attr">useDefaultRenderLoop</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// targetFrameRate: number</span></span><br><span class="line">  <span class="comment">// 作用: 目标帧率</span></span><br><span class="line">  <span class="comment">// 默认: undefined</span></span><br><span class="line">  <span class="comment">// 性能控制: 限制渲染帧率</span></span><br><span class="line">  <span class="attr">targetFrameRate</span>: <span class="number">60</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// showRenderLoopErrors: boolean</span></span><br><span class="line">  <span class="comment">// 作用: 是否显示渲染循环错误</span></span><br><span class="line">  <span class="comment">// 默认: true</span></span><br><span class="line">  <span class="comment">// 调试用途: 错误信息显示</span></span><br><span class="line">  <span class="attr">showRenderLoopErrors</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// automaticallyTrackDataSourceClocks: boolean</span></span><br><span class="line">  <span class="comment">// 作用: 是否自动跟踪数据源时钟</span></span><br><span class="line">  <span class="comment">// 默认: true</span></span><br><span class="line">  <span class="comment">// 时间控制: 数据源时间同步</span></span><br><span class="line">  <span class="attr">automaticallyTrackDataSourceClocks</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === 输入控制选项 ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// enableCollisionDetection: boolean</span></span><br><span class="line">  <span class="comment">// 作用: 是否启用碰撞检测</span></span><br><span class="line">  <span class="comment">// 默认: true</span></span><br><span class="line">  <span class="comment">// 用途: 相机与地形的碰撞检测</span></span><br><span class="line">  <span class="attr">enableCollisionDetection</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// useBrowserRecommendedResolution: boolean</span></span><br><span class="line">  <span class="comment">// 作用: 是否使用浏览器推荐分辨率</span></span><br><span class="line">  <span class="comment">// 默认: true</span></span><br><span class="line">  <span class="comment">// 性能影响: 高分辨率显示器的性能</span></span><br><span class="line">  <span class="attr">useBrowserRecommendedResolution</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// orderIndependentTranslucency: boolean</span></span><br><span class="line">  <span class="comment">// 作用: 顺序无关透明度</span></span><br><span class="line">  <span class="comment">// 默认: true</span></span><br><span class="line">  <span class="comment">// 渲染质量: 透明物体的渲染质量</span></span><br><span class="line">  <span class="attr">orderIndependentTranslucency</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// creditContainer: Element | string</span></span><br><span class="line">  <span class="comment">// 作用: 版权信息容器</span></span><br><span class="line">  <span class="comment">// 默认: undefined</span></span><br><span class="line">  <span class="comment">// 用途: 自定义版权信息显示位置</span></span><br><span class="line">  <span class="attr">creditContainer</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// creditViewport: Element | string</span></span><br><span class="line">  <span class="comment">// 作用: 版权信息视口</span></span><br><span class="line">  <span class="comment">// 默认: undefined</span></span><br><span class="line">  <span class="comment">// 用途: 版权信息的显示区域</span></span><br><span class="line">  <span class="attr">creditViewport</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// dataSources: DataSourceCollection</span></span><br><span class="line">  <span class="comment">// 作用: 数据源集合</span></span><br><span class="line">  <span class="comment">// 默认: new DataSourceCollection()</span></span><br><span class="line">  <span class="comment">// 用途: 预设的数据源</span></span><br><span class="line">  <span class="attr">dataSources</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">DataSourceCollection</span>(),</span><br><span class="line"></span><br><span class="line">  <span class="comment">// clock: Clock</span></span><br><span class="line">  <span class="comment">// 作用: 时钟对象</span></span><br><span class="line">  <span class="comment">// 默认: new Clock()</span></span><br><span class="line">  <span class="comment">// 时间控制: 场景时间管理</span></span><br><span class="line">  <span class="attr">clock</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Clock</span>(),</span><br><span class="line"></span><br><span class="line">  <span class="comment">// blurActiveElementOnCanvasFocus: boolean</span></span><br><span class="line">  <span class="comment">// 作用: 画布获得焦点时是否模糊活动元素</span></span><br><span class="line">  <span class="comment">// 默认: true</span></span><br><span class="line">  <span class="comment">// UI控制: 焦点管理</span></span><br><span class="line">  <span class="attr">blurActiveElementOnCanvasFocus</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// msaaSamples: number</span></span><br><span class="line">  <span class="comment">// 作用: MSAA采样数量</span></span><br><span class="line">  <span class="comment">// 默认: 1</span></span><br><span class="line">  <span class="comment">// 抗锯齿: 多重采样抗锯齿</span></span><br><span class="line">  <span class="attr">msaaSamples</span>: <span class="number">4</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="坐标系统详解"><a href="#坐标系统详解" class="headerlink" title="坐标系统详解"></a>坐标系统详解</h2><h3 id="Cartesian3-笛卡尔坐标系"><a href="#Cartesian3-笛卡尔坐标系" class="headerlink" title="Cartesian3 笛卡尔坐标系"></a>Cartesian3 笛卡尔坐标系</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cartesian3 - 3D笛卡尔坐标</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Cartesian3</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">x = <span class="number">0.0</span>, y = <span class="number">0.0</span>, z = <span class="number">0.0</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">x</span> = x <span class="comment">// X轴坐标（米）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">y</span> = y <span class="comment">// Y轴坐标（米）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">z</span> = z <span class="comment">// Z轴坐标（米）</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 静态方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromDegrees - 从经纬度创建</span></span><br><span class="line">  <span class="comment">// longitude: 经度（度）</span></span><br><span class="line">  <span class="comment">// latitude: 纬度（度）</span></span><br><span class="line">  <span class="comment">// height: 高度（米，可选，默认0）</span></span><br><span class="line">  <span class="comment">// ellipsoid: 椭球体（可选，默认WGS84）</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromDegrees</span>(<span class="params">longitude, latitude, height = <span class="number">0</span>, ellipsoid = Cesium.Ellipsoid.WGS84</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(longitude, latitude, height, ellipsoid)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromRadians - 从弧度创建</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromRadians</span>(<span class="params">longitude, latitude, height = <span class="number">0</span>, ellipsoid = Cesium.Ellipsoid.WGS84</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromRadians</span>(longitude, latitude, height, ellipsoid)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromDegreesArray - 从经纬度数组创建</span></span><br><span class="line">  <span class="comment">// coordinates: [lon1, lat1, lon2, lat2, ...]</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromDegreesArray</span>(<span class="params">coordinates, ellipsoid = Cesium.Ellipsoid.WGS84</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegreesArray</span>(coordinates, ellipsoid)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromDegreesArrayHeights - 从经纬度高度数组创建</span></span><br><span class="line">  <span class="comment">// coordinates: [lon1, lat1, height1, lon2, lat2, height2, ...]</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromDegreesArrayHeights</span>(<span class="params">coordinates, ellipsoid = Cesium.Ellipsoid.WGS84</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegreesArrayHeights</span>(coordinates, ellipsoid)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 实例方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// clone - 克隆</span></span><br><span class="line">  <span class="title function_">clone</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">clone</span>(<span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// equals - 比较相等</span></span><br><span class="line">  <span class="title function_">equals</span>(<span class="params">other</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">equals</span>(<span class="variable language_">this</span>, other)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// distance - 计算距离</span></span><br><span class="line">  <span class="title function_">distanceTo</span>(<span class="params">other</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">distance</span>(<span class="variable language_">this</span>, other)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// normalize - 标准化</span></span><br><span class="line">  <span class="title function_">normalize</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">normalize</span>(<span class="variable language_">this</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// magnitude - 计算向量长度</span></span><br><span class="line">  <span class="title function_">magnitude</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">magnitude</span>(<span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// add - 向量加法</span></span><br><span class="line">  <span class="title function_">add</span>(<span class="params">other</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">add</span>(<span class="variable language_">this</span>, other, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// subtract - 向量减法</span></span><br><span class="line">  <span class="title function_">subtract</span>(<span class="params">other</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">subtract</span>(<span class="variable language_">this</span>, other, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// multiplyByScalar - 标量乘法</span></span><br><span class="line">  <span class="title function_">multiplyByScalar</span>(<span class="params">scalar</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">multiplyByScalar</span>(<span class="variable language_">this</span>, scalar, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// dot - 点积</span></span><br><span class="line">  <span class="title function_">dot</span>(<span class="params">other</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">dot</span>(<span class="variable language_">this</span>, other)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cross - 叉积</span></span><br><span class="line">  <span class="title function_">cross</span>(<span class="params">other</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">cross</span>(<span class="variable language_">this</span>, other, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> position = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">1000000</span>, <span class="number">2000000</span>, <span class="number">3000000</span>)</span><br><span class="line"><span class="keyword">const</span> beijingPosition = <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">const</span> positions = <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegreesArray</span>([</span><br><span class="line">  <span class="number">116.4074</span>,</span><br><span class="line">  <span class="number">39.9042</span>, <span class="comment">// 北京</span></span><br><span class="line">  <span class="number">121.4737</span>,</span><br><span class="line">  <span class="number">31.2304</span>, <span class="comment">// 上海</span></span><br><span class="line">  <span class="number">113.2644</span>,</span><br><span class="line">  <span class="number">23.1291</span>, <span class="comment">// 广州</span></span><br><span class="line">])</span><br></pre></td></tr></table></figure><h3 id="Cartographic-地理坐标系"><a href="#Cartographic-地理坐标系" class="headerlink" title="Cartographic 地理坐标系"></a>Cartographic 地理坐标系</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cartographic - 地理坐标（经纬度）</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Cartographic</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">longitude = <span class="number">0.0</span>, latitude = <span class="number">0.0</span>, height = <span class="number">0.0</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">longitude</span> = longitude <span class="comment">// 经度（弧度）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">latitude</span> = latitude <span class="comment">// 纬度（弧度）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">height</span> = height <span class="comment">// 高度（米）</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 静态方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromDegrees - 从度数创建</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromDegrees</span>(<span class="params">longitude, latitude, height = <span class="number">0.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartographic</span>(</span><br><span class="line">      <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(longitude),</span><br><span class="line">      <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(latitude),</span><br><span class="line">      height,</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromRadians - 从弧度创建</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromRadians</span>(<span class="params">longitude, latitude, height = <span class="number">0.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartographic</span>(longitude, latitude, height)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromCartesian - 从笛卡尔坐标创建</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromCartesian</span>(<span class="params">cartesian, ellipsoid = Cesium.Ellipsoid.WGS84</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromCartesian</span>(cartesian, ellipsoid)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 实例方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// toLongitudeLatitude - 转换为经纬度（度）</span></span><br><span class="line">  <span class="title function_">toLongitudeLatitude</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">longitude</span>: <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(<span class="variable language_">this</span>.<span class="property">longitude</span>),</span><br><span class="line">      <span class="attr">latitude</span>: <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(<span class="variable language_">this</span>.<span class="property">latitude</span>),</span><br><span class="line">      <span class="attr">height</span>: <span class="variable language_">this</span>.<span class="property">height</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// clone - 克隆</span></span><br><span class="line">  <span class="title function_">clone</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">clone</span>(<span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// equals - 比较相等</span></span><br><span class="line">  <span class="title function_">equals</span>(<span class="params">other</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">equals</span>(<span class="variable language_">this</span>, other)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> cartographic = <span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">const</span> cartesian = <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">const</span> backToCartographic = <span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromCartesian</span>(cartesian)</span><br></pre></td></tr></table></figure><h3 id="Matrix4-变换矩阵"><a href="#Matrix4-变换矩阵" class="headerlink" title="Matrix4 变换矩阵"></a>Matrix4 变换矩阵</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Matrix4 - 4x4变换矩阵</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Matrix4</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 16个元素的数组，按列优先存储</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">elements</span> = [</span><br><span class="line">      <span class="number">1</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">0</span>, <span class="comment">// 第一列</span></span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">1</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">0</span>, <span class="comment">// 第二列</span></span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">1</span>,</span><br><span class="line">      <span class="number">0</span>, <span class="comment">// 第三列</span></span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">1</span>, <span class="comment">// 第四列</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 静态创建方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// IDENTITY - 单位矩阵</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">IDENTITY</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Matrix4</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromTranslation - 从平移创建</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromTranslation</span>(<span class="params">translation</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">fromTranslation</span>(translation)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromScale - 从缩放创建</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromScale</span>(<span class="params">scale</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">fromScale</span>(scale)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromRotationTranslation - 从旋转和平移创建</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromRotationTranslation</span>(<span class="params">rotation, translation</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">fromRotationTranslation</span>(rotation, translation)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 变换方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// multiplyByPoint - 乘以点</span></span><br><span class="line">  <span class="title function_">multiplyByPoint</span>(<span class="params">point</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">multiplyByPoint</span>(<span class="variable language_">this</span>, point, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// multiplyByVector - 乘以向量</span></span><br><span class="line">  <span class="title function_">multiplyByVector</span>(<span class="params">vector</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">multiplyByVector</span>(<span class="variable language_">this</span>, vector, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian4</span>())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// multiply - 矩阵乘法</span></span><br><span class="line">  <span class="title function_">multiply</span>(<span class="params">other</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">multiply</span>(<span class="variable language_">this</span>, other, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Matrix4</span>())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// inverse - 求逆矩阵</span></span><br><span class="line">  <span class="title function_">inverse</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">inverse</span>(<span class="variable language_">this</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Matrix4</span>())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// transpose - 转置</span></span><br><span class="line">  <span class="title function_">transpose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">transpose</span>(<span class="variable language_">this</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Matrix4</span>())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> translation = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">100</span>, <span class="number">200</span>, <span class="number">300</span>)</span><br><span class="line"><span class="keyword">const</span> translationMatrix = <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">fromTranslation</span>(translation)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> scale = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line"><span class="keyword">const</span> scaleMatrix = <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">fromScale</span>(scale)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rotation = <span class="title class_">Cesium</span>.<span class="property">Matrix3</span>.<span class="title function_">fromRotationZ</span>(<span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(<span class="number">45</span>))</span><br><span class="line"><span class="keyword">const</span> rotationMatrix = <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">fromRotation</span>(rotation)</span><br></pre></td></tr></table></figure><h2 id="实体系统完整属性"><a href="#实体系统完整属性" class="headerlink" title="实体系统完整属性"></a>实体系统完整属性</h2><h3 id="Entity-基础实体"><a href="#Entity-基础实体" class="headerlink" title="Entity 基础实体"></a>Entity 基础实体</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Entity - 基础实体类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Entity</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// === 基础属性 ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// id: string</span></span><br><span class="line">    <span class="comment">// 作用: 实体的唯一标识符</span></span><br><span class="line">    <span class="comment">// 默认: 自动生成UUID</span></span><br><span class="line">    <span class="comment">// 用途: 查找、更新、删除实体</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = options.<span class="property">id</span> || <span class="title class_">Cesium</span>.<span class="title function_">createGuid</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// name: string</span></span><br><span class="line">    <span class="comment">// 作用: 实体的显示名称</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="comment">// 用途: InfoBox标题、标签文本</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = options.<span class="property">name</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// availability: TimeIntervalCollection</span></span><br><span class="line">    <span class="comment">// 作用: 实体的可用时间间隔</span></span><br><span class="line">    <span class="comment">// 默认: undefined（始终可用）</span></span><br><span class="line">    <span class="comment">// 用途: 时间动画中的显示控制</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">availability</span> = options.<span class="property">availability</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// show: boolean | Property</span></span><br><span class="line">    <span class="comment">// 作用: 控制实体的可见性</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="comment">// 用途: 显示/隐藏实体</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// description: string | Property</span></span><br><span class="line">    <span class="comment">// 作用: 实体的描述信息</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="comment">// 用途: InfoBox的内容</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">description</span> = options.<span class="property">description</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// position: PositionProperty</span></span><br><span class="line">    <span class="comment">// 作用: 实体的位置</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="comment">// 类型: Cartesian3 | PositionProperty</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">position</span> = options.<span class="property">position</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// orientation: Property</span></span><br><span class="line">    <span class="comment">// 作用: 实体的方向（四元数）</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="comment">// 类型: Quaternion | Property</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">orientation</span> = options.<span class="property">orientation</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// viewFrom: Property</span></span><br><span class="line">    <span class="comment">// 作用: 相机观察实体时的相对位置</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="comment">// 类型: Cartesian3 | Property</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewFrom</span> = options.<span class="property">viewFrom</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// parent: Entity</span></span><br><span class="line">    <span class="comment">// 作用: 父实体（用于层次结构）</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="comment">// 用途: 实体的父子关系</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">parent</span> = options.<span class="property">parent</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 图形属性 ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// billboard: BillboardGraphics</span></span><br><span class="line">    <span class="comment">// 作用: 广告牌图形</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">billboard</span> = options.<span class="property">billboard</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// box: BoxGraphics</span></span><br><span class="line">    <span class="comment">// 作用: 盒子图形</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">box</span> = options.<span class="property">box</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// corridor: CorridorGraphics</span></span><br><span class="line">    <span class="comment">// 作用: 走廊图形</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">corridor</span> = options.<span class="property">corridor</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// cylinder: CylinderGraphics</span></span><br><span class="line">    <span class="comment">// 作用: 圆柱体图形</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cylinder</span> = options.<span class="property">cylinder</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ellipse: EllipseGraphics</span></span><br><span class="line">    <span class="comment">// 作用: 椭圆图形</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ellipse</span> = options.<span class="property">ellipse</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ellipsoid: EllipsoidGraphics</span></span><br><span class="line">    <span class="comment">// 作用: 椭球体图形</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ellipsoid</span> = options.<span class="property">ellipsoid</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// label: LabelGraphics</span></span><br><span class="line">    <span class="comment">// 作用: 标签图形</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">label</span> = options.<span class="property">label</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// model: ModelGraphics</span></span><br><span class="line">    <span class="comment">// 作用: 3D模型图形</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">model</span> = options.<span class="property">model</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// tileset: Cesium3DTilesetGraphics</span></span><br><span class="line">    <span class="comment">// 作用: 3D瓦片集图形</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tileset</span> = options.<span class="property">tileset</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// path: PathGraphics</span></span><br><span class="line">    <span class="comment">// 作用: 路径图形</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">path</span> = options.<span class="property">path</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// plane: PlaneGraphics</span></span><br><span class="line">    <span class="comment">// 作用: 平面图形</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">plane</span> = options.<span class="property">plane</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// point: PointGraphics</span></span><br><span class="line">    <span class="comment">// 作用: 点图形</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">point</span> = options.<span class="property">point</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// polygon: PolygonGraphics</span></span><br><span class="line">    <span class="comment">// 作用: 多边形图形</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">polygon</span> = options.<span class="property">polygon</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// polyline: PolylineGraphics</span></span><br><span class="line">    <span class="comment">// 作用: 多段线图形</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">polyline</span> = options.<span class="property">polyline</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// polylineVolume: PolylineVolumeGraphics</span></span><br><span class="line">    <span class="comment">// 作用: 多段线体积图形</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">polylineVolume</span> = options.<span class="property">polylineVolume</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// rectangle: RectangleGraphics</span></span><br><span class="line">    <span class="comment">// 作用: 矩形图形</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">rectangle</span> = options.<span class="property">rectangle</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// wall: WallGraphics</span></span><br><span class="line">    <span class="comment">// 作用: 墙体图形</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">wall</span> = options.<span class="property">wall</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === 方法 ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// computeModelMatrix - 计算模型矩阵</span></span><br><span class="line">  <span class="comment">// time: JulianDate - 时间</span></span><br><span class="line">  <span class="comment">// result: Matrix4 - 结果矩阵</span></span><br><span class="line">  <span class="title function_">computeModelMatrix</span>(<span class="params">time, result</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Entity</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">computeModelMatrix</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>, time, result)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// isShowing - 是否正在显示</span></span><br><span class="line">  <span class="comment">// time: JulianDate - 时间</span></span><br><span class="line">  <span class="title function_">isShowing</span>(<span class="params">time</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">show</span> &amp;&amp; (!<span class="variable language_">this</span>.<span class="property">availability</span> || <span class="variable language_">this</span>.<span class="property">availability</span>.<span class="title function_">contains</span>(time))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// isAvailable - 是否可用</span></span><br><span class="line">  <span class="comment">// time: JulianDate - 时间</span></span><br><span class="line">  <span class="title function_">isAvailable</span>(<span class="params">time</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> !<span class="variable language_">this</span>.<span class="property">availability</span> || <span class="variable language_">this</span>.<span class="property">availability</span>.<span class="title function_">contains</span>(time)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建实体示例</span></span><br><span class="line"><span class="keyword">const</span> entity = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Entity</span>(&#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="string">&#x27;beijing-marker&#x27;</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;北京标记&#x27;</span>,</span><br><span class="line">  <span class="attr">description</span>: <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div style=&quot;padding: 10px;&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;h3&gt;北京市&lt;/h3&gt;</span></span><br><span class="line"><span class="string">      &lt;p&gt;中华人民共和国首都&lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;p&gt;人口: 2154万&lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;p&gt;面积: 16410.54平方公里&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">0</span>),</span><br><span class="line">  <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">availability</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeIntervalCollection</span>([</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeInterval</span>(&#123;</span><br><span class="line">      <span class="attr">start</span>: <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&#x27;2023-01-01&#x27;</span>)),</span><br><span class="line">      <span class="attr">stop</span>: <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&#x27;2024-12-31&#x27;</span>)),</span><br><span class="line">    &#125;),</span><br><span class="line">  ]),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="BillboardGraphics-广告牌图形"><a href="#BillboardGraphics-广告牌图形" class="headerlink" title="BillboardGraphics 广告牌图形"></a>BillboardGraphics 广告牌图形</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BillboardGraphics - 广告牌图形</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BillboardGraphics</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// show: boolean | Property</span></span><br><span class="line">    <span class="comment">// 作用: 控制广告牌的可见性</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// image: string | HTMLCanvasElement | HTMLVideoElement | Property</span></span><br><span class="line">    <span class="comment">// 作用: 广告牌的图像</span></span><br><span class="line">    <span class="comment">// 支持: URL、Canvas、Video、Data URL</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">image</span> = options.<span class="property">image</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// scale: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 广告牌的缩放比例</span></span><br><span class="line">    <span class="comment">// 默认: 1.0</span></span><br><span class="line">    <span class="comment">// 范围: 0.0 - 任意正数</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scale</span> = options.<span class="property">scale</span> !== <span class="literal">undefined</span> ? options.<span class="property">scale</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// pixelOffset: Cartesian2 | Property</span></span><br><span class="line">    <span class="comment">// 作用: 像素偏移量</span></span><br><span class="line">    <span class="comment">// 默认: Cartesian2.ZERO</span></span><br><span class="line">    <span class="comment">// 用途: 微调广告牌位置</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pixelOffset</span> = options.<span class="property">pixelOffset</span> || <span class="title class_">Cesium</span>.<span class="property">Cartesian2</span>.<span class="property">ZERO</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// eyeOffset: Cartesian3 | Property</span></span><br><span class="line">    <span class="comment">// 作用: 眼部偏移量（相机空间）</span></span><br><span class="line">    <span class="comment">// 默认: Cartesian3.ZERO</span></span><br><span class="line">    <span class="comment">// 用途: 深度控制</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">eyeOffset</span> = options.<span class="property">eyeOffset</span> || <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="property">ZERO</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// horizontalOrigin: HorizontalOrigin | Property</span></span><br><span class="line">    <span class="comment">// 作用: 水平对齐方式</span></span><br><span class="line">    <span class="comment">// 默认: HorizontalOrigin.CENTER</span></span><br><span class="line">    <span class="comment">// 选项: LEFT, CENTER, RIGHT</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">horizontalOrigin</span> = options.<span class="property">horizontalOrigin</span> || <span class="title class_">Cesium</span>.<span class="property">HorizontalOrigin</span>.<span class="property">CENTER</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// verticalOrigin: VerticalOrigin | Property</span></span><br><span class="line">    <span class="comment">// 作用: 垂直对齐方式</span></span><br><span class="line">    <span class="comment">// 默认: VerticalOrigin.CENTER</span></span><br><span class="line">    <span class="comment">// 选项: BOTTOM, BASELINE, CENTER, TOP</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">verticalOrigin</span> = options.<span class="property">verticalOrigin</span> || <span class="title class_">Cesium</span>.<span class="property">VerticalOrigin</span>.<span class="property">CENTER</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// heightReference: HeightReference | Property</span></span><br><span class="line">    <span class="comment">// 作用: 高度参考</span></span><br><span class="line">    <span class="comment">// 默认: HeightReference.NONE</span></span><br><span class="line">    <span class="comment">// 选项: NONE, CLAMP_TO_GROUND, RELATIVE_TO_GROUND</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">heightReference</span> = options.<span class="property">heightReference</span> || <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">NONE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// color: Color | Property</span></span><br><span class="line">    <span class="comment">// 作用: 广告牌颜色（与图像混合）</span></span><br><span class="line">    <span class="comment">// 默认: Color.WHITE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">color</span> = options.<span class="property">color</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// rotation: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 旋转角度（弧度）</span></span><br><span class="line">    <span class="comment">// 默认: 0.0</span></span><br><span class="line">    <span class="comment">// 正值: 逆时针旋转</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">rotation</span> = options.<span class="property">rotation</span> !== <span class="literal">undefined</span> ? options.<span class="property">rotation</span> : <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// alignedAxis: Cartesian3 | Property</span></span><br><span class="line">    <span class="comment">// 作用: 对齐轴</span></span><br><span class="line">    <span class="comment">// 默认: Cartesian3.ZERO（自动对齐到屏幕）</span></span><br><span class="line">    <span class="comment">// 用途: 固定广告牌的旋转轴</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">alignedAxis</span> = options.<span class="property">alignedAxis</span> || <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="property">ZERO</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// sizeInMeters: boolean | Property</span></span><br><span class="line">    <span class="comment">// 作用: 是否以米为单位计算尺寸</span></span><br><span class="line">    <span class="comment">// 默认: false（以像素为单位）</span></span><br><span class="line">    <span class="comment">// true: 广告牌大小不随距离变化</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sizeInMeters</span> = options.<span class="property">sizeInMeters</span> !== <span class="literal">undefined</span> ? options.<span class="property">sizeInMeters</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// width: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 广告牌宽度</span></span><br><span class="line">    <span class="comment">// 默认: undefined（使用图像宽度）</span></span><br><span class="line">    <span class="comment">// 单位: 像素或米（取决于sizeInMeters）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">width</span> = options.<span class="property">width</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// height: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 广告牌高度</span></span><br><span class="line">    <span class="comment">// 默认: undefined（使用图像高度）</span></span><br><span class="line">    <span class="comment">// 单位: 像素或米（取决于sizeInMeters）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">height</span> = options.<span class="property">height</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// scaleByDistance: NearFarScalar | Property</span></span><br><span class="line">    <span class="comment">// 作用: 基于距离的缩放</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="comment">// 用途: LOD效果</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scaleByDistance</span> = options.<span class="property">scaleByDistance</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// translucencyByDistance: NearFarScalar | Property</span></span><br><span class="line">    <span class="comment">// 作用: 基于距离的透明度</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="comment">// 用途: 渐隐效果</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">translucencyByDistance</span> = options.<span class="property">translucencyByDistance</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// pixelOffsetScaleByDistance: NearFarScalar | Property</span></span><br><span class="line">    <span class="comment">// 作用: 基于距离的像素偏移缩放</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pixelOffsetScaleByDistance</span> = options.<span class="property">pixelOffsetScaleByDistance</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// imageSubRegion: BoundingRectangle | Property</span></span><br><span class="line">    <span class="comment">// 作用: 图像子区域</span></span><br><span class="line">    <span class="comment">// 默认: undefined（使用整个图像）</span></span><br><span class="line">    <span class="comment">// 用途: 纹理图集</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">imageSubRegion</span> = options.<span class="property">imageSubRegion</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// distanceDisplayCondition: DistanceDisplayCondition | Property</span></span><br><span class="line">    <span class="comment">// 作用: 距离显示条件</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="comment">// 用途: 基于距离的显示/隐藏</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">distanceDisplayCondition</span> = options.<span class="property">distanceDisplayCondition</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// disableDepthTestDistance: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 禁用深度测试的距离</span></span><br><span class="line">    <span class="comment">// 默认: 0.0</span></span><br><span class="line">    <span class="comment">// 用途: 防止广告牌被地形遮挡</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">disableDepthTestDistance</span> =</span><br><span class="line">      options.<span class="property">disableDepthTestDistance</span> !== <span class="literal">undefined</span> ? options.<span class="property">disableDepthTestDistance</span> : <span class="number">0.0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> billboardEntity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>),</span><br><span class="line">  <span class="attr">billboard</span>: &#123;</span><br><span class="line">    <span class="attr">image</span>:</span><br><span class="line">      <span class="string">&#x27;data:image/svg+xml;base64,&#x27;</span> +</span><br><span class="line">      <span class="title function_">btoa</span>(<span class="string">`</span></span><br><span class="line"><span class="string">      &lt;svg width=&quot;32&quot; height=&quot;40&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;path d=&quot;M16 0C7.2 0 0 7.2 0 16c0 8.8 16 24 16 24s16-15.2 16-24C32 7.2 24.8 0 16 0z&quot; fill=&quot;#E53E3E&quot;/&gt;</span></span><br><span class="line"><span class="string">        &lt;circle cx=&quot;16&quot; cy=&quot;16&quot; r=&quot;8&quot; fill=&quot;#FFF&quot;/&gt;</span></span><br><span class="line"><span class="string">        &lt;text x=&quot;16&quot; y=&quot;20&quot; text-anchor=&quot;middle&quot; fill=&quot;#E53E3E&quot; font-size=&quot;8&quot;&gt;1&lt;/text&gt;</span></span><br><span class="line"><span class="string">      &lt;/svg&gt;</span></span><br><span class="line"><span class="string">    `</span>),</span><br><span class="line">    <span class="attr">scale</span>: <span class="number">1.5</span>,</span><br><span class="line">    <span class="attr">verticalOrigin</span>: <span class="title class_">Cesium</span>.<span class="property">VerticalOrigin</span>.<span class="property">BOTTOM</span>,</span><br><span class="line">    <span class="attr">heightReference</span>: <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">CLAMP_TO_GROUND</span>,</span><br><span class="line">    <span class="attr">scaleByDistance</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">NearFarScalar</span>(<span class="number">1.5e2</span>, <span class="number">2.0</span>, <span class="number">1.5e7</span>, <span class="number">0.5</span>),</span><br><span class="line">    <span class="attr">distanceDisplayCondition</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">DistanceDisplayCondition</span>(<span class="number">0</span>, <span class="number">1.5e7</span>),</span><br><span class="line">    <span class="attr">disableDepthTestDistance</span>: <span class="title class_">Number</span>.<span class="property">POSITIVE_INFINITY</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="PointGraphics-点图形"><a href="#PointGraphics-点图形" class="headerlink" title="PointGraphics 点图形"></a>PointGraphics 点图形</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PointGraphics - 点图形</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PointGraphics</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// show: boolean | Property</span></span><br><span class="line">    <span class="comment">// 作用: 控制点的可见性</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// pixelSize: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 点的像素大小</span></span><br><span class="line">    <span class="comment">// 默认: 1</span></span><br><span class="line">    <span class="comment">// 范围: 1 - 硬件限制</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pixelSize</span> = options.<span class="property">pixelSize</span> !== <span class="literal">undefined</span> ? options.<span class="property">pixelSize</span> : <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// heightReference: HeightReference | Property</span></span><br><span class="line">    <span class="comment">// 作用: 高度参考</span></span><br><span class="line">    <span class="comment">// 默认: HeightReference.NONE</span></span><br><span class="line">    <span class="comment">// 选项: NONE, CLAMP_TO_GROUND, RELATIVE_TO_GROUND</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">heightReference</span> = options.<span class="property">heightReference</span> || <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">NONE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// color: Color | Property</span></span><br><span class="line">    <span class="comment">// 作用: 点的颜色</span></span><br><span class="line">    <span class="comment">// 默认: Color.WHITE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">color</span> = options.<span class="property">color</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// outlineColor: Color | Property</span></span><br><span class="line">    <span class="comment">// 作用: 点的轮廓颜色</span></span><br><span class="line">    <span class="comment">// 默认: Color.BLACK</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outlineColor</span> = options.<span class="property">outlineColor</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// outlineWidth: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 轮廓宽度</span></span><br><span class="line">    <span class="comment">// 默认: 0</span></span><br><span class="line">    <span class="comment">// 范围: 0 - 硬件限制</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outlineWidth</span> = options.<span class="property">outlineWidth</span> !== <span class="literal">undefined</span> ? options.<span class="property">outlineWidth</span> : <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// scaleByDistance: NearFarScalar | Property</span></span><br><span class="line">    <span class="comment">// 作用: 基于距离的缩放</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scaleByDistance</span> = options.<span class="property">scaleByDistance</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// translucencyByDistance: NearFarScalar | Property</span></span><br><span class="line">    <span class="comment">// 作用: 基于距离的透明度</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">translucencyByDistance</span> = options.<span class="property">translucencyByDistance</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// distanceDisplayCondition: DistanceDisplayCondition | Property</span></span><br><span class="line">    <span class="comment">// 作用: 距离显示条件</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">distanceDisplayCondition</span> = options.<span class="property">distanceDisplayCondition</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// disableDepthTestDistance: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 禁用深度测试的距离</span></span><br><span class="line">    <span class="comment">// 默认: 0.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">disableDepthTestDistance</span> =</span><br><span class="line">      options.<span class="property">disableDepthTestDistance</span> !== <span class="literal">undefined</span> ? options.<span class="property">disableDepthTestDistance</span> : <span class="number">0.0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> pointEntity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>),</span><br><span class="line">  <span class="attr">point</span>: &#123;</span><br><span class="line">    <span class="attr">pixelSize</span>: <span class="number">15</span>,</span><br><span class="line">    <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>,</span><br><span class="line">    <span class="attr">outlineColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>,</span><br><span class="line">    <span class="attr">outlineWidth</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">heightReference</span>: <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">CLAMP_TO_GROUND</span>,</span><br><span class="line">    <span class="attr">scaleByDistance</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">NearFarScalar</span>(<span class="number">1.5e2</span>, <span class="number">3.0</span>, <span class="number">1.5e7</span>, <span class="number">0.5</span>),</span><br><span class="line">    <span class="attr">distanceDisplayCondition</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">DistanceDisplayCondition</span>(<span class="number">0</span>, <span class="number">2.0e6</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="LabelGraphics-标签图形"><a href="#LabelGraphics-标签图形" class="headerlink" title="LabelGraphics 标签图形"></a>LabelGraphics 标签图形</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LabelGraphics - 标签图形</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LabelGraphics</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// show: boolean | Property</span></span><br><span class="line">    <span class="comment">// 作用: 控制标签的可见性</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// text: string | Property</span></span><br><span class="line">    <span class="comment">// 作用: 标签文本</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="comment">// 支持: 普通文本、HTML实体</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">text</span> = options.<span class="property">text</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// font: string | Property</span></span><br><span class="line">    <span class="comment">// 作用: 字体样式</span></span><br><span class="line">    <span class="comment">// 默认: &#x27;30px sans-serif&#x27;</span></span><br><span class="line">    <span class="comment">// 格式: CSS字体格式</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">font</span> = options.<span class="property">font</span> || <span class="string">&#x27;30px sans-serif&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// style: LabelStyle | Property</span></span><br><span class="line">    <span class="comment">// 作用: 标签样式</span></span><br><span class="line">    <span class="comment">// 默认: LabelStyle.FILL</span></span><br><span class="line">    <span class="comment">// 选项: FILL, OUTLINE, FILL_AND_OUTLINE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = options.<span class="property">style</span> || <span class="title class_">Cesium</span>.<span class="property">LabelStyle</span>.<span class="property">FILL</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// scale: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 标签缩放比例</span></span><br><span class="line">    <span class="comment">// 默认: 1.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scale</span> = options.<span class="property">scale</span> !== <span class="literal">undefined</span> ? options.<span class="property">scale</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// showBackground: boolean | Property</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示背景</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">showBackground</span> = options.<span class="property">showBackground</span> !== <span class="literal">undefined</span> ? options.<span class="property">showBackground</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// backgroundColor: Color | Property</span></span><br><span class="line">    <span class="comment">// 作用: 背景颜色</span></span><br><span class="line">    <span class="comment">// 默认: Color(0.165, 0.165, 0.165, 0.8)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">backgroundColor</span> = options.<span class="property">backgroundColor</span> || <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Color</span>(<span class="number">0.165</span>, <span class="number">0.165</span>, <span class="number">0.165</span>, <span class="number">0.8</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// backgroundPadding: Cartesian2 | Property</span></span><br><span class="line">    <span class="comment">// 作用: 背景内边距（像素）</span></span><br><span class="line">    <span class="comment">// 默认: Cartesian2(7, 5)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">backgroundPadding</span> = options.<span class="property">backgroundPadding</span> || <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">7</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// pixelOffset: Cartesian2 | Property</span></span><br><span class="line">    <span class="comment">// 作用: 像素偏移量</span></span><br><span class="line">    <span class="comment">// 默认: Cartesian2.ZERO</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pixelOffset</span> = options.<span class="property">pixelOffset</span> || <span class="title class_">Cesium</span>.<span class="property">Cartesian2</span>.<span class="property">ZERO</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// eyeOffset: Cartesian3 | Property</span></span><br><span class="line">    <span class="comment">// 作用: 眼部偏移量</span></span><br><span class="line">    <span class="comment">// 默认: Cartesian3.ZERO</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">eyeOffset</span> = options.<span class="property">eyeOffset</span> || <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="property">ZERO</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// horizontalOrigin: HorizontalOrigin | Property</span></span><br><span class="line">    <span class="comment">// 作用: 水平对齐方式</span></span><br><span class="line">    <span class="comment">// 默认: HorizontalOrigin.CENTER</span></span><br><span class="line">    <span class="comment">// 选项: LEFT, CENTER, RIGHT</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">horizontalOrigin</span> = options.<span class="property">horizontalOrigin</span> || <span class="title class_">Cesium</span>.<span class="property">HorizontalOrigin</span>.<span class="property">CENTER</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// verticalOrigin: VerticalOrigin | Property</span></span><br><span class="line">    <span class="comment">// 作用: 垂直对齐方式</span></span><br><span class="line">    <span class="comment">// 默认: VerticalOrigin.CENTER</span></span><br><span class="line">    <span class="comment">// 选项: BOTTOM, BASELINE, CENTER, TOP</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">verticalOrigin</span> = options.<span class="property">verticalOrigin</span> || <span class="title class_">Cesium</span>.<span class="property">VerticalOrigin</span>.<span class="property">CENTER</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// heightReference: HeightReference | Property</span></span><br><span class="line">    <span class="comment">// 作用: 高度参考</span></span><br><span class="line">    <span class="comment">// 默认: HeightReference.NONE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">heightReference</span> = options.<span class="property">heightReference</span> || <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">NONE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// fillColor: Color | Property</span></span><br><span class="line">    <span class="comment">// 作用: 填充颜色</span></span><br><span class="line">    <span class="comment">// 默认: Color.WHITE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fillColor</span> = options.<span class="property">fillColor</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// outlineColor: Color | Property</span></span><br><span class="line">    <span class="comment">// 作用: 轮廓颜色</span></span><br><span class="line">    <span class="comment">// 默认: Color.BLACK</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outlineColor</span> = options.<span class="property">outlineColor</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// outlineWidth: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 轮廓宽度</span></span><br><span class="line">    <span class="comment">// 默认: 1</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outlineWidth</span> = options.<span class="property">outlineWidth</span> !== <span class="literal">undefined</span> ? options.<span class="property">outlineWidth</span> : <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// translucencyByDistance: NearFarScalar | Property</span></span><br><span class="line">    <span class="comment">// 作用: 基于距离的透明度</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">translucencyByDistance</span> = options.<span class="property">translucencyByDistance</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// pixelOffsetScaleByDistance: NearFarScalar | Property</span></span><br><span class="line">    <span class="comment">// 作用: 基于距离的像素偏移缩放</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pixelOffsetScaleByDistance</span> = options.<span class="property">pixelOffsetScaleByDistance</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// scaleByDistance: NearFarScalar | Property</span></span><br><span class="line">    <span class="comment">// 作用: 基于距离的缩放</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scaleByDistance</span> = options.<span class="property">scaleByDistance</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// distanceDisplayCondition: DistanceDisplayCondition | Property</span></span><br><span class="line">    <span class="comment">// 作用: 距离显示条件</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">distanceDisplayCondition</span> = options.<span class="property">distanceDisplayCondition</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// disableDepthTestDistance: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 禁用深度测试的距离</span></span><br><span class="line">    <span class="comment">// 默认: 0.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">disableDepthTestDistance</span> =</span><br><span class="line">      options.<span class="property">disableDepthTestDistance</span> !== <span class="literal">undefined</span> ? options.<span class="property">disableDepthTestDistance</span> : <span class="number">0.0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> labelEntity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>),</span><br><span class="line">  <span class="attr">label</span>: &#123;</span><br><span class="line">    <span class="attr">text</span>: <span class="string">&#x27;北京市&#x27;</span>,</span><br><span class="line">    <span class="attr">font</span>: <span class="string">&#x27;24pt Microsoft YaHei&#x27;</span>,</span><br><span class="line">    <span class="attr">style</span>: <span class="title class_">Cesium</span>.<span class="property">LabelStyle</span>.<span class="property">FILL_AND_OUTLINE</span>,</span><br><span class="line">    <span class="attr">fillColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span>,</span><br><span class="line">    <span class="attr">outlineColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>,</span><br><span class="line">    <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">showBackground</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">backgroundColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>.<span class="title function_">withAlpha</span>(<span class="number">0.7</span>),</span><br><span class="line">    <span class="attr">backgroundPadding</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">10</span>, <span class="number">8</span>),</span><br><span class="line">    <span class="attr">verticalOrigin</span>: <span class="title class_">Cesium</span>.<span class="property">VerticalOrigin</span>.<span class="property">BOTTOM</span>,</span><br><span class="line">    <span class="attr">pixelOffset</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">0</span>, -<span class="number">50</span>),</span><br><span class="line">    <span class="attr">heightReference</span>: <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">CLAMP_TO_GROUND</span>,</span><br><span class="line">    <span class="attr">scaleByDistance</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">NearFarScalar</span>(<span class="number">1.5e2</span>, <span class="number">1.5</span>, <span class="number">1.5e7</span>, <span class="number">0.5</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="PolylineGraphics-多段线图形"><a href="#PolylineGraphics-多段线图形" class="headerlink" title="PolylineGraphics 多段线图形"></a>PolylineGraphics 多段线图形</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PolylineGraphics - 多段线图形</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PolylineGraphics</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// show: boolean | Property</span></span><br><span class="line">    <span class="comment">// 作用: 控制多段线的可见性</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// positions: Array&lt;Cartesian3&gt; | Property</span></span><br><span class="line">    <span class="comment">// 作用: 多段线的顶点位置数组</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="comment">// 格式: [Cartesian3, Cartesian3, ...]</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">positions</span> = options.<span class="property">positions</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// width: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 线条宽度（像素）</span></span><br><span class="line">    <span class="comment">// 默认: 1.0</span></span><br><span class="line">    <span class="comment">// 范围: 1.0 - 硬件限制</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">width</span> = options.<span class="property">width</span> !== <span class="literal">undefined</span> ? options.<span class="property">width</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// granularity: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 线条细分粒度（弧度）</span></span><br><span class="line">    <span class="comment">// 默认: Math.PI / 180（1度）</span></span><br><span class="line">    <span class="comment">// 用途: 控制曲线的平滑度</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">granularity</span> = options.<span class="property">granularity</span> !== <span class="literal">undefined</span> ? options.<span class="property">granularity</span> : <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">180</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// material: MaterialProperty | Color</span></span><br><span class="line">    <span class="comment">// 作用: 线条材质</span></span><br><span class="line">    <span class="comment">// 默认: Color.WHITE</span></span><br><span class="line">    <span class="comment">// 类型: Color、ImageMaterialProperty、PolylineDashMaterialProperty等</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">material</span> = options.<span class="property">material</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// depthFailMaterial: MaterialProperty | Color</span></span><br><span class="line">    <span class="comment">// 作用: 深度测试失败时的材质</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="comment">// 用途: 被遮挡部分的显示</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">depthFailMaterial</span> = options.<span class="property">depthFailMaterial</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// followSurface: boolean | Property</span></span><br><span class="line">    <span class="comment">// 作用: 是否跟随地表</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="comment">// true: 线条贴合地球表面曲率</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">followSurface</span> = options.<span class="property">followSurface</span> !== <span class="literal">undefined</span> ? options.<span class="property">followSurface</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// clampToGround: boolean | Property</span></span><br><span class="line">    <span class="comment">// 作用: 是否贴地</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="comment">// true: 线条贴合地形表面</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clampToGround</span> = options.<span class="property">clampToGround</span> !== <span class="literal">undefined</span> ? options.<span class="property">clampToGround</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// shadows: ShadowMode | Property</span></span><br><span class="line">    <span class="comment">// 作用: 阴影模式</span></span><br><span class="line">    <span class="comment">// 默认: ShadowMode.DISABLED</span></span><br><span class="line">    <span class="comment">// 选项: DISABLED, ENABLED, CAST_ONLY, RECEIVE_ONLY</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadows</span> = options.<span class="property">shadows</span> || <span class="title class_">Cesium</span>.<span class="property">ShadowMode</span>.<span class="property">DISABLED</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// distanceDisplayCondition: DistanceDisplayCondition | Property</span></span><br><span class="line">    <span class="comment">// 作用: 距离显示条件</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">distanceDisplayCondition</span> = options.<span class="property">distanceDisplayCondition</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// classificationType: ClassificationType | Property</span></span><br><span class="line">    <span class="comment">// 作用: 分类类型（用于贴地）</span></span><br><span class="line">    <span class="comment">// 默认: ClassificationType.BOTH</span></span><br><span class="line">    <span class="comment">// 选项: TERRAIN, CESIUM_3D_TILE, BOTH</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">classificationType</span> = options.<span class="property">classificationType</span> || <span class="title class_">Cesium</span>.<span class="property">ClassificationType</span>.<span class="property">BOTH</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// zIndex: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: Z轴索引（贴地时的层次）</span></span><br><span class="line">    <span class="comment">// 默认: 0</span></span><br><span class="line">    <span class="comment">// 用途: 控制重叠线条的显示顺序</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">zIndex</span> = options.<span class="property">zIndex</span> !== <span class="literal">undefined</span> ? options.<span class="property">zIndex</span> : <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> polylineEntity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">polyline</span>: &#123;</span><br><span class="line">    <span class="attr">positions</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegreesArray</span>([</span><br><span class="line">      <span class="number">116.4074</span>,</span><br><span class="line">      <span class="number">39.9042</span>, <span class="comment">// 北京</span></span><br><span class="line">      <span class="number">121.4737</span>,</span><br><span class="line">      <span class="number">31.2304</span>, <span class="comment">// 上海</span></span><br><span class="line">      <span class="number">113.2644</span>,</span><br><span class="line">      <span class="number">23.1291</span>, <span class="comment">// 广州</span></span><br><span class="line">    ]),</span><br><span class="line">    <span class="attr">width</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">material</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">CYAN</span>,</span><br><span class="line">    <span class="attr">clampToGround</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 虚线材质</span></span><br><span class="line">    <span class="attr">material</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PolylineDashMaterialProperty</span>(&#123;</span><br><span class="line">      <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>,</span><br><span class="line">      <span class="attr">dashLength</span>: <span class="number">16.0</span>, <span class="comment">// 虚线长度</span></span><br><span class="line">      <span class="attr">dashPattern</span>: <span class="number">255</span>, <span class="comment">// 虚线模式</span></span><br><span class="line">    &#125;),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 箭头材质</span></span><br><span class="line">    <span class="attr">material</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PolylineArrowMaterialProperty</span>(<span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发光材质</span></span><br><span class="line">    <span class="attr">material</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PolylineGlowMaterialProperty</span>(&#123;</span><br><span class="line">      <span class="attr">glowPower</span>: <span class="number">0.2</span>, <span class="comment">// 发光强度</span></span><br><span class="line">      <span class="attr">taperPower</span>: <span class="number">0.5</span>, <span class="comment">// 锥形功率</span></span><br><span class="line">      <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLUE</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="PolygonGraphics-多边形图形"><a href="#PolygonGraphics-多边形图形" class="headerlink" title="PolygonGraphics 多边形图形"></a>PolygonGraphics 多边形图形</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PolygonGraphics - 多边形图形</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PolygonGraphics</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// show: boolean | Property</span></span><br><span class="line">    <span class="comment">// 作用: 控制多边形的可见性</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// hierarchy: PolygonHierarchy | Property</span></span><br><span class="line">    <span class="comment">// 作用: 多边形层次结构（外环和内环）</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="comment">// 格式: 顶点数组或PolygonHierarchy对象</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hierarchy</span> = options.<span class="property">hierarchy</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// height: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 多边形高度（米）</span></span><br><span class="line">    <span class="comment">// 默认: 0</span></span><br><span class="line">    <span class="comment">// 用途: 抬高多边形</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">height</span> = options.<span class="property">height</span> !== <span class="literal">undefined</span> ? options.<span class="property">height</span> : <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// heightReference: HeightReference | Property</span></span><br><span class="line">    <span class="comment">// 作用: 高度参考</span></span><br><span class="line">    <span class="comment">// 默认: HeightReference.NONE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">heightReference</span> = options.<span class="property">heightReference</span> || <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">NONE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// extrudedHeight: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 拉伸高度（米）</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="comment">// 用途: 创建3D立体效果</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">extrudedHeight</span> = options.<span class="property">extrudedHeight</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// extrudedHeightReference: HeightReference | Property</span></span><br><span class="line">    <span class="comment">// 作用: 拉伸高度参考</span></span><br><span class="line">    <span class="comment">// 默认: HeightReference.NONE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">extrudedHeightReference</span> = options.<span class="property">extrudedHeightReference</span> || <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">NONE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// stRotation: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 纹理旋转角度（弧度）</span></span><br><span class="line">    <span class="comment">// 默认: 0.0</span></span><br><span class="line">    <span class="comment">// 用途: 旋转材质纹理</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">stRotation</span> = options.<span class="property">stRotation</span> !== <span class="literal">undefined</span> ? options.<span class="property">stRotation</span> : <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// granularity: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 细分粒度（弧度）</span></span><br><span class="line">    <span class="comment">// 默认: Math.PI / 180</span></span><br><span class="line">    <span class="comment">// 用途: 控制曲线边的平滑度</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">granularity</span> = options.<span class="property">granularity</span> !== <span class="literal">undefined</span> ? options.<span class="property">granularity</span> : <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">180</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// fill: boolean | Property</span></span><br><span class="line">    <span class="comment">// 作用: 是否填充</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fill</span> = options.<span class="property">fill</span> !== <span class="literal">undefined</span> ? options.<span class="property">fill</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// material: MaterialProperty | Color</span></span><br><span class="line">    <span class="comment">// 作用: 填充材质</span></span><br><span class="line">    <span class="comment">// 默认: Color.WHITE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">material</span> = options.<span class="property">material</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// outline: boolean | Property</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示轮廓</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outline</span> = options.<span class="property">outline</span> !== <span class="literal">undefined</span> ? options.<span class="property">outline</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// outlineColor: Color | Property</span></span><br><span class="line">    <span class="comment">// 作用: 轮廓颜色</span></span><br><span class="line">    <span class="comment">// 默认: Color.BLACK</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outlineColor</span> = options.<span class="property">outlineColor</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// outlineWidth: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 轮廓宽度（像素）</span></span><br><span class="line">    <span class="comment">// 默认: 1.0</span></span><br><span class="line">    <span class="comment">// 注意: 在某些硬件上可能不支持</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outlineWidth</span> = options.<span class="property">outlineWidth</span> !== <span class="literal">undefined</span> ? options.<span class="property">outlineWidth</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// perPositionHeight: boolean | Property</span></span><br><span class="line">    <span class="comment">// 作用: 是否使用每个顶点的高度</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="comment">// true: 每个顶点可以有不同的高度</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">perPositionHeight</span> =</span><br><span class="line">      options.<span class="property">perPositionHeight</span> !== <span class="literal">undefined</span> ? options.<span class="property">perPositionHeight</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// closeTop: boolean | Property</span></span><br><span class="line">    <span class="comment">// 作用: 是否封闭顶部（拉伸时）</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">closeTop</span> = options.<span class="property">closeTop</span> !== <span class="literal">undefined</span> ? options.<span class="property">closeTop</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// closeBottom: boolean | Property</span></span><br><span class="line">    <span class="comment">// 作用: 是否封闭底部（拉伸时）</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">closeBottom</span> = options.<span class="property">closeBottom</span> !== <span class="literal">undefined</span> ? options.<span class="property">closeBottom</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// arcType: ArcType | Property</span></span><br><span class="line">    <span class="comment">// 作用: 弧线类型</span></span><br><span class="line">    <span class="comment">// 默认: ArcType.GEODESIC</span></span><br><span class="line">    <span class="comment">// 选项: NONE, GEODESIC, RHUMB</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">arcType</span> = options.<span class="property">arcType</span> || <span class="title class_">Cesium</span>.<span class="property">ArcType</span>.<span class="property">GEODESIC</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// shadows: ShadowMode | Property</span></span><br><span class="line">    <span class="comment">// 作用: 阴影模式</span></span><br><span class="line">    <span class="comment">// 默认: ShadowMode.DISABLED</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadows</span> = options.<span class="property">shadows</span> || <span class="title class_">Cesium</span>.<span class="property">ShadowMode</span>.<span class="property">DISABLED</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// distanceDisplayCondition: DistanceDisplayCondition | Property</span></span><br><span class="line">    <span class="comment">// 作用: 距离显示条件</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">distanceDisplayCondition</span> = options.<span class="property">distanceDisplayCondition</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// classificationType: ClassificationType | Property</span></span><br><span class="line">    <span class="comment">// 作用: 分类类型</span></span><br><span class="line">    <span class="comment">// 默认: ClassificationType.BOTH</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">classificationType</span> = options.<span class="property">classificationType</span> || <span class="title class_">Cesium</span>.<span class="property">ClassificationType</span>.<span class="property">BOTH</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// zIndex: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: Z轴索引</span></span><br><span class="line">    <span class="comment">// 默认: 0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">zIndex</span> = options.<span class="property">zIndex</span> !== <span class="literal">undefined</span> ? options.<span class="property">zIndex</span> : <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> polygonEntity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">polygon</span>: &#123;</span><br><span class="line">    <span class="attr">hierarchy</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegreesArray</span>([</span><br><span class="line">      <span class="number">116.3</span>,</span><br><span class="line">      <span class="number">39.8</span>, <span class="comment">// 西南角</span></span><br><span class="line">      <span class="number">116.5</span>,</span><br><span class="line">      <span class="number">39.8</span>, <span class="comment">// 东南角</span></span><br><span class="line">      <span class="number">116.5</span>,</span><br><span class="line">      <span class="number">40.0</span>, <span class="comment">// 东北角</span></span><br><span class="line">      <span class="number">116.3</span>,</span><br><span class="line">      <span class="number">40.0</span>, <span class="comment">// 西北角</span></span><br><span class="line">    ]),</span><br><span class="line">    <span class="attr">height</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">extrudedHeight</span>: <span class="number">300</span>, <span class="comment">// 拉伸300米</span></span><br><span class="line">    <span class="attr">material</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLUE</span>.<span class="title function_">withAlpha</span>(<span class="number">0.7</span>),</span><br><span class="line">    <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">outlineColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLUE</span>,</span><br><span class="line">    <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 带洞的多边形</span></span><br><span class="line">    <span class="attr">hierarchy</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PolygonHierarchy</span>(</span><br><span class="line">      <span class="comment">// 外环</span></span><br><span class="line">      <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegreesArray</span>([<span class="number">116.3</span>, <span class="number">39.8</span>, <span class="number">116.5</span>, <span class="number">39.8</span>, <span class="number">116.5</span>, <span class="number">40.0</span>, <span class="number">116.3</span>, <span class="number">40.0</span>]),</span><br><span class="line">      <span class="comment">// 内环（洞）</span></span><br><span class="line">      [</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PolygonHierarchy</span>(</span><br><span class="line">          <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegreesArray</span>([</span><br><span class="line">            <span class="number">116.35</span>, <span class="number">39.85</span>, <span class="number">116.45</span>, <span class="number">39.85</span>, <span class="number">116.45</span>, <span class="number">39.95</span>, <span class="number">116.35</span>, <span class="number">39.95</span>,</span><br><span class="line">          ]),</span><br><span class="line">        ),</span><br><span class="line">      ],</span><br><span class="line">    ),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 图片材质</span></span><br><span class="line">    <span class="attr">material</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ImageMaterialProperty</span>(&#123;</span><br><span class="line">      <span class="attr">image</span>: <span class="string">&#x27;path/to/texture.png&#x27;</span>,</span><br><span class="line">      <span class="attr">repeat</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">4.0</span>, <span class="number">4.0</span>),</span><br><span class="line">    &#125;),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 棋盘材质</span></span><br><span class="line">    <span class="attr">material</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">CheckerboardMaterialProperty</span>(&#123;</span><br><span class="line">      <span class="attr">evenColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span>,</span><br><span class="line">      <span class="attr">oddColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>,</span><br><span class="line">      <span class="attr">repeat</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">4.0</span>, <span class="number">4.0</span>),</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="ModelGraphics-3D模型图形"><a href="#ModelGraphics-3D模型图形" class="headerlink" title="ModelGraphics 3D模型图形"></a>ModelGraphics 3D模型图形</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ModelGraphics - 3D模型图形</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelGraphics</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// show: boolean | Property</span></span><br><span class="line">    <span class="comment">// 作用: 控制模型的可见性</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// uri: string | Resource | Property</span></span><br><span class="line">    <span class="comment">// 作用: 模型文件路径</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="comment">// 支持: glTF(.gltf, .glb)、COLLADA(.dae)等</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">uri</span> = options.<span class="property">uri</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// scale: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 模型缩放比例</span></span><br><span class="line">    <span class="comment">// 默认: 1.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scale</span> = options.<span class="property">scale</span> !== <span class="literal">undefined</span> ? options.<span class="property">scale</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// minimumPixelSize: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 最小像素大小</span></span><br><span class="line">    <span class="comment">// 默认: 0.0</span></span><br><span class="line">    <span class="comment">// 用途: 防止模型在远距离时变得过小</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">minimumPixelSize</span> = options.<span class="property">minimumPixelSize</span> !== <span class="literal">undefined</span> ? options.<span class="property">minimumPixelSize</span> : <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// maximumScale: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 最大缩放比例</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="comment">// 用途: 限制模型的最大显示尺寸</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maximumScale</span> = options.<span class="property">maximumScale</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// incrementallyLoadTextures: boolean | Property</span></span><br><span class="line">    <span class="comment">// 作用: 是否增量加载纹理</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="comment">// 性能优化: 渐进式纹理加载</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">incrementallyLoadTextures</span> =</span><br><span class="line">      options.<span class="property">incrementallyLoadTextures</span> !== <span class="literal">undefined</span> ? options.<span class="property">incrementallyLoadTextures</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// runAnimations: boolean | Property</span></span><br><span class="line">    <span class="comment">// 作用: 是否运行动画</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="comment">// 用途: 控制模型内置动画的播放</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">runAnimations</span> = options.<span class="property">runAnimations</span> !== <span class="literal">undefined</span> ? options.<span class="property">runAnimations</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// clampAnimations: boolean | Property</span></span><br><span class="line">    <span class="comment">// 作用: 是否限制动画</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="comment">// 用途: 将动画限制在定义的时间范围内</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clampAnimations</span> = options.<span class="property">clampAnimations</span> !== <span class="literal">undefined</span> ? options.<span class="property">clampAnimations</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// shadows: ShadowMode | Property</span></span><br><span class="line">    <span class="comment">// 作用: 阴影模式</span></span><br><span class="line">    <span class="comment">// 默认: ShadowMode.ENABLED</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadows</span> = options.<span class="property">shadows</span> || <span class="title class_">Cesium</span>.<span class="property">ShadowMode</span>.<span class="property">ENABLED</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// heightReference: HeightReference | Property</span></span><br><span class="line">    <span class="comment">// 作用: 高度参考</span></span><br><span class="line">    <span class="comment">// 默认: HeightReference.NONE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">heightReference</span> = options.<span class="property">heightReference</span> || <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">NONE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// silhouetteColor: Color | Property</span></span><br><span class="line">    <span class="comment">// 作用: 轮廓颜色</span></span><br><span class="line">    <span class="comment">// 默认: Color.RED</span></span><br><span class="line">    <span class="comment">// 用途: 模型被选中时的轮廓颜色</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">silhouetteColor</span> = options.<span class="property">silhouetteColor</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// silhouetteSize: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 轮廓大小</span></span><br><span class="line">    <span class="comment">// 默认: 0.0（不显示轮廓）</span></span><br><span class="line">    <span class="comment">// 用途: 模型被选中时的轮廓宽度</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">silhouetteSize</span> = options.<span class="property">silhouetteSize</span> !== <span class="literal">undefined</span> ? options.<span class="property">silhouetteSize</span> : <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// color: Color | Property</span></span><br><span class="line">    <span class="comment">// 作用: 模型颜色（混合）</span></span><br><span class="line">    <span class="comment">// 默认: Color.WHITE</span></span><br><span class="line">    <span class="comment">// 用途: 与模型纹理混合的颜色</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">color</span> = options.<span class="property">color</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// colorBlendMode: ColorBlendMode | Property</span></span><br><span class="line">    <span class="comment">// 作用: 颜色混合模式</span></span><br><span class="line">    <span class="comment">// 默认: ColorBlendMode.HIGHLIGHT</span></span><br><span class="line">    <span class="comment">// 选项: HIGHLIGHT, REPLACE, MIX</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">colorBlendMode</span> = options.<span class="property">colorBlendMode</span> || <span class="title class_">Cesium</span>.<span class="property">ColorBlendMode</span>.<span class="property">HIGHLIGHT</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// colorBlendAmount: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 颜色混合强度</span></span><br><span class="line">    <span class="comment">// 默认: 0.5</span></span><br><span class="line">    <span class="comment">// 范围: 0.0 - 1.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">colorBlendAmount</span> = options.<span class="property">colorBlendAmount</span> !== <span class="literal">undefined</span> ? options.<span class="property">colorBlendAmount</span> : <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// distanceDisplayCondition: DistanceDisplayCondition | Property</span></span><br><span class="line">    <span class="comment">// 作用: 距离显示条件</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">distanceDisplayCondition</span> = options.<span class="property">distanceDisplayCondition</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// nodeTransformations: PropertyBag | Property</span></span><br><span class="line">    <span class="comment">// 作用: 节点变换</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="comment">// 用途: 控制模型中特定节点的变换</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">nodeTransformations</span> = options.<span class="property">nodeTransformations</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// articulations: PropertyBag | Property</span></span><br><span class="line">    <span class="comment">// 作用: 关节动画</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="comment">// 用途: 控制模型的关节动画</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">articulations</span> = options.<span class="property">articulations</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// clippingPlanes: ClippingPlaneCollection | Property</span></span><br><span class="line">    <span class="comment">// 作用: 裁剪平面</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="comment">// 用途: 裁剪模型的某些部分</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clippingPlanes</span> = options.<span class="property">clippingPlanes</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> modelEntity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">0</span>),</span><br><span class="line">  <span class="attr">model</span>: &#123;</span><br><span class="line">    <span class="attr">uri</span>: <span class="string">&#x27;./models/airplane.gltf&#x27;</span>,</span><br><span class="line">    <span class="attr">scale</span>: <span class="number">2.0</span>,</span><br><span class="line">    <span class="attr">minimumPixelSize</span>: <span class="number">128</span>,</span><br><span class="line">    <span class="attr">maximumScale</span>: <span class="number">20000</span>,</span><br><span class="line">    <span class="attr">heightReference</span>: <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">CLAMP_TO_GROUND</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 高亮显示</span></span><br><span class="line">    <span class="attr">silhouetteColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">LIME</span>,</span><br><span class="line">    <span class="attr">silhouetteSize</span>: <span class="number">2.0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 颜色调整</span></span><br><span class="line">    <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span>,</span><br><span class="line">    <span class="attr">colorBlendMode</span>: <span class="title class_">Cesium</span>.<span class="property">ColorBlendMode</span>.<span class="property">MIX</span>,</span><br><span class="line">    <span class="attr">colorBlendAmount</span>: <span class="number">0.3</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 节点变换（旋转螺旋桨）</span></span><br><span class="line">    <span class="attr">nodeTransformations</span>: &#123;</span><br><span class="line">      <span class="title class_">Propeller</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">NodeTransformationProperty</span>(&#123;</span><br><span class="line">        <span class="attr">rotation</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">CallbackProperty</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Quaternion</span>.<span class="title function_">fromAxisAngle</span>(</span><br><span class="line">            <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="property">UNIT_Z</span>,</span><br><span class="line">            (<span class="title class_">Date</span>.<span class="title function_">now</span>() / <span class="number">1000</span>) * <span class="number">10</span>, <span class="comment">// 每秒10弧度</span></span><br><span class="line">          )</span><br><span class="line">        &#125;, <span class="literal">false</span>),</span><br><span class="line">      &#125;),</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 裁剪平面</span></span><br><span class="line">    <span class="attr">clippingPlanes</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ClippingPlaneCollection</span>(&#123;</span><br><span class="line">      <span class="attr">planes</span>: [<span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ClippingPlane</span>(<span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>), <span class="number">0.0</span>)],</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="BoxGraphics-盒子图形"><a href="#BoxGraphics-盒子图形" class="headerlink" title="BoxGraphics 盒子图形"></a>BoxGraphics 盒子图形</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BoxGraphics - 盒子图形</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BoxGraphics</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// show: boolean | Property</span></span><br><span class="line">    <span class="comment">// 作用: 控制盒子的可见性</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// dimensions: Cartesian3 | Property</span></span><br><span class="line">    <span class="comment">// 作用: 盒子的尺寸（长、宽、高）</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="comment">// 单位: 米</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dimensions</span> = options.<span class="property">dimensions</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// heightReference: HeightReference | Property</span></span><br><span class="line">    <span class="comment">// 作用: 高度参考</span></span><br><span class="line">    <span class="comment">// 默认: HeightReference.NONE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">heightReference</span> = options.<span class="property">heightReference</span> || <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">NONE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// fill: boolean | Property</span></span><br><span class="line">    <span class="comment">// 作用: 是否填充</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fill</span> = options.<span class="property">fill</span> !== <span class="literal">undefined</span> ? options.<span class="property">fill</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// material: MaterialProperty | Color</span></span><br><span class="line">    <span class="comment">// 作用: 填充材质</span></span><br><span class="line">    <span class="comment">// 默认: Color.WHITE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">material</span> = options.<span class="property">material</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// outline: boolean | Property</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示轮廓</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outline</span> = options.<span class="property">outline</span> !== <span class="literal">undefined</span> ? options.<span class="property">outline</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// outlineColor: Color | Property</span></span><br><span class="line">    <span class="comment">// 作用: 轮廓颜色</span></span><br><span class="line">    <span class="comment">// 默认: Color.BLACK</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outlineColor</span> = options.<span class="property">outlineColor</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// outlineWidth: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 轮廓宽度</span></span><br><span class="line">    <span class="comment">// 默认: 1.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outlineWidth</span> = options.<span class="property">outlineWidth</span> !== <span class="literal">undefined</span> ? options.<span class="property">outlineWidth</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// shadows: ShadowMode | Property</span></span><br><span class="line">    <span class="comment">// 作用: 阴影模式</span></span><br><span class="line">    <span class="comment">// 默认: ShadowMode.DISABLED</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadows</span> = options.<span class="property">shadows</span> || <span class="title class_">Cesium</span>.<span class="property">ShadowMode</span>.<span class="property">DISABLED</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// distanceDisplayCondition: DistanceDisplayCondition | Property</span></span><br><span class="line">    <span class="comment">// 作用: 距离显示条件</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">distanceDisplayCondition</span> = options.<span class="property">distanceDisplayCondition</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> boxEntity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">100</span>),</span><br><span class="line">  <span class="attr">box</span>: &#123;</span><br><span class="line">    <span class="attr">dimensions</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">200</span>, <span class="number">200</span>, <span class="number">100</span>), <span class="comment">// 长200m，宽200m，高100m</span></span><br><span class="line">    <span class="attr">material</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLUE</span>.<span class="title function_">withAlpha</span>(<span class="number">0.7</span>),</span><br><span class="line">    <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">outlineColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLUE</span>,</span><br><span class="line">    <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">heightReference</span>: <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">RELATIVE_TO_GROUND</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="CylinderGraphics-圆柱体图形"><a href="#CylinderGraphics-圆柱体图形" class="headerlink" title="CylinderGraphics 圆柱体图形"></a>CylinderGraphics 圆柱体图形</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CylinderGraphics - 圆柱体图形</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CylinderGraphics</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// show: boolean | Property</span></span><br><span class="line">    <span class="comment">// 作用: 控制圆柱体的可见性</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// length: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 圆柱体长度（高度）</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="comment">// 单位: 米</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">length</span> = options.<span class="property">length</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// topRadius: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 顶部半径</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="comment">// 单位: 米</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">topRadius</span> = options.<span class="property">topRadius</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// bottomRadius: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 底部半径</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="comment">// 单位: 米</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">bottomRadius</span> = options.<span class="property">bottomRadius</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// heightReference: HeightReference | Property</span></span><br><span class="line">    <span class="comment">// 作用: 高度参考</span></span><br><span class="line">    <span class="comment">// 默认: HeightReference.NONE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">heightReference</span> = options.<span class="property">heightReference</span> || <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">NONE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// fill: boolean | Property</span></span><br><span class="line">    <span class="comment">// 作用: 是否填充</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fill</span> = options.<span class="property">fill</span> !== <span class="literal">undefined</span> ? options.<span class="property">fill</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// material: MaterialProperty | Color</span></span><br><span class="line">    <span class="comment">// 作用: 填充材质</span></span><br><span class="line">    <span class="comment">// 默认: Color.WHITE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">material</span> = options.<span class="property">material</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// outline: boolean | Property</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示轮廓</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outline</span> = options.<span class="property">outline</span> !== <span class="literal">undefined</span> ? options.<span class="property">outline</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// outlineColor: Color | Property</span></span><br><span class="line">    <span class="comment">// 作用: 轮廓颜色</span></span><br><span class="line">    <span class="comment">// 默认: Color.BLACK</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outlineColor</span> = options.<span class="property">outlineColor</span> || <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// outlineWidth: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 轮廓宽度</span></span><br><span class="line">    <span class="comment">// 默认: 1.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outlineWidth</span> = options.<span class="property">outlineWidth</span> !== <span class="literal">undefined</span> ? options.<span class="property">outlineWidth</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// numberOfVerticalLines: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 垂直线条数量</span></span><br><span class="line">    <span class="comment">// 默认: 16</span></span><br><span class="line">    <span class="comment">// 用途: 控制圆柱体的细分精度</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">numberOfVerticalLines</span> =</span><br><span class="line">      options.<span class="property">numberOfVerticalLines</span> !== <span class="literal">undefined</span> ? options.<span class="property">numberOfVerticalLines</span> : <span class="number">16</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// slices: number | Property</span></span><br><span class="line">    <span class="comment">// 作用: 切片数量</span></span><br><span class="line">    <span class="comment">// 默认: 128</span></span><br><span class="line">    <span class="comment">// 用途: 控制圆周方向的精度</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">slices</span> = options.<span class="property">slices</span> !== <span class="literal">undefined</span> ? options.<span class="property">slices</span> : <span class="number">128</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// shadows: ShadowMode | Property</span></span><br><span class="line">    <span class="comment">// 作用: 阴影模式</span></span><br><span class="line">    <span class="comment">// 默认: ShadowMode.DISABLED</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadows</span> = options.<span class="property">shadows</span> || <span class="title class_">Cesium</span>.<span class="property">ShadowMode</span>.<span class="property">DISABLED</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// distanceDisplayCondition: DistanceDisplayCondition | Property</span></span><br><span class="line">    <span class="comment">// 作用: 距离显示条件</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">distanceDisplayCondition</span> = options.<span class="property">distanceDisplayCondition</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> cylinderEntity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">50</span>),</span><br><span class="line">  <span class="attr">cylinder</span>: &#123;</span><br><span class="line">    <span class="attr">length</span>: <span class="number">100</span>, <span class="comment">// 高度100米</span></span><br><span class="line">    <span class="attr">topRadius</span>: <span class="number">30</span>, <span class="comment">// 顶部半径30米</span></span><br><span class="line">    <span class="attr">bottomRadius</span>: <span class="number">50</span>, <span class="comment">// 底部半径50米（锥形）</span></span><br><span class="line">    <span class="attr">material</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">GREEN</span>.<span class="title function_">withAlpha</span>(<span class="number">0.8</span>),</span><br><span class="line">    <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">outlineColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">DARKGREEN</span>,</span><br><span class="line">    <span class="attr">heightReference</span>: <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">RELATIVE_TO_GROUND</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="地形系统详解"><a href="#地形系统详解" class="headerlink" title="地形系统详解"></a>地形系统详解</h2><h3 id="TerrainProvider-地形提供者"><a href="#TerrainProvider-地形提供者" class="headerlink" title="TerrainProvider 地形提供者"></a>TerrainProvider 地形提供者</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// EllipsoidTerrainProvider - 椭球地形（离线推荐）</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EllipsoidTerrainProvider</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// ellipsoid: Ellipsoid</span></span><br><span class="line">    <span class="comment">// 作用: 椭球体参数</span></span><br><span class="line">    <span class="comment">// 默认: Ellipsoid.WGS84</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ellipsoid</span> = options.<span class="property">ellipsoid</span> || <span class="title class_">Cesium</span>.<span class="property">Ellipsoid</span>.<span class="property">WGS84</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// credit: Credit | string</span></span><br><span class="line">    <span class="comment">// 作用: 版权信息</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">credit</span> = options.<span class="property">credit</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 属性</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">ready</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125; <span class="comment">// 是否就绪</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">readyPromise</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="literal">true</span>)</span><br><span class="line">  &#125; <span class="comment">// 就绪Promise</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">errorEvent</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line">  &#125; <span class="comment">// 错误事件</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">hasWaterMask</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125; <span class="comment">// 是否有水体遮罩</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">hasVertexNormals</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125; <span class="comment">// 是否有顶点法线</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">availability</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">  &#125; <span class="comment">// 可用性</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CesiumTerrainProvider - Cesium地形服务</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CesiumTerrainProvider</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// url: string | Resource</span></span><br><span class="line">    <span class="comment">// 作用: 地形服务URL</span></span><br><span class="line">    <span class="comment">// 必需: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">url</span> = options.<span class="property">url</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// requestWaterMask: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否请求水体遮罩</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">requestWaterMask</span> =</span><br><span class="line">      options.<span class="property">requestWaterMask</span> !== <span class="literal">undefined</span> ? options.<span class="property">requestWaterMask</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// requestVertexNormals: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否请求顶点法线</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">requestVertexNormals</span> =</span><br><span class="line">      options.<span class="property">requestVertexNormals</span> !== <span class="literal">undefined</span> ? options.<span class="property">requestVertexNormals</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ellipsoid: Ellipsoid</span></span><br><span class="line">    <span class="comment">// 作用: 椭球体</span></span><br><span class="line">    <span class="comment">// 默认: Ellipsoid.WGS84</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ellipsoid</span> = options.<span class="property">ellipsoid</span> || <span class="title class_">Cesium</span>.<span class="property">Ellipsoid</span>.<span class="property">WGS84</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// credit: Credit | string</span></span><br><span class="line">    <span class="comment">// 作用: 版权信息</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">credit</span> = options.<span class="property">credit</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// requestTileGeometry - 请求瓦片几何</span></span><br><span class="line">  <span class="comment">// x: number - X坐标</span></span><br><span class="line">  <span class="comment">// y: number - Y坐标</span></span><br><span class="line">  <span class="comment">// level: number - 级别</span></span><br><span class="line">  <span class="title function_">requestTileGeometry</span>(<span class="params">x, y, level</span>) &#123;</span><br><span class="line">    <span class="comment">// 返回Promise&lt;TerrainData&gt;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getLevelMaximumGeometricError - 获取级别最大几何误差</span></span><br><span class="line">  <span class="comment">// level: number - 级别</span></span><br><span class="line">  <span class="title function_">getLevelMaximumGeometricError</span>(<span class="params">level</span>) &#123;</span><br><span class="line">    <span class="comment">// 返回几何误差值</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getTileDataAvailable - 获取瓦片数据可用性</span></span><br><span class="line">  <span class="comment">// x: number - X坐标</span></span><br><span class="line">  <span class="comment">// y: number - Y坐标</span></span><br><span class="line">  <span class="comment">// level: number - 级别</span></span><br><span class="line">  <span class="title function_">getTileDataAvailable</span>(<span class="params">x, y, level</span>) &#123;</span><br><span class="line">    <span class="comment">// 返回boolean</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 地形采样</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">sampleTerrain</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> positions = [</span><br><span class="line">    <span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>),</span><br><span class="line">    <span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromDegrees</span>(<span class="number">121.4737</span>, <span class="number">31.2304</span>),</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 采样地形高度</span></span><br><span class="line">  <span class="keyword">const</span> sampledPositions = <span class="keyword">await</span> <span class="title class_">Cesium</span>.<span class="title function_">sampleTerrainMostDetailed</span>(viewer.<span class="property">terrainProvider</span>, positions)</span><br><span class="line"></span><br><span class="line">  sampledPositions.<span class="title function_">forEach</span>(<span class="function">(<span class="params">position, index</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`位置 <span class="subst">$&#123;index&#125;</span>: 高度 <span class="subst">$&#123;position.height&#125;</span> 米`</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 地形配置示例</span></span><br><span class="line"><span class="comment">// 离线椭球地形</span></span><br><span class="line">viewer.<span class="property">terrainProvider</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">EllipsoidTerrainProvider</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Cesium World Terrain（需要网络）</span></span><br><span class="line"><span class="keyword">const</span> worldTerrain = <span class="title class_">Cesium</span>.<span class="title function_">createWorldTerrain</span>(&#123;</span><br><span class="line">  <span class="attr">requestWaterMask</span>: <span class="literal">true</span>, <span class="comment">// 请求水体遮罩</span></span><br><span class="line">  <span class="attr">requestVertexNormals</span>: <span class="literal">true</span>, <span class="comment">// 请求顶点法线</span></span><br><span class="line">&#125;)</span><br><span class="line">viewer.<span class="property">terrainProvider</span> = worldTerrain</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义地形服务</span></span><br><span class="line"><span class="keyword">const</span> customTerrain = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">CesiumTerrainProvider</span>(&#123;</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;http://localhost:8080/terrain/&#x27;</span>,</span><br><span class="line">  <span class="attr">requestWaterMask</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">requestVertexNormals</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line">viewer.<span class="property">terrainProvider</span> = customTerrain</span><br></pre></td></tr></table></figure><h2 id="相机系统完整属性"><a href="#相机系统完整属性" class="headerlink" title="相机系统完整属性"></a>相机系统完整属性</h2><h3 id="Camera-相机类"><a href="#Camera-相机类" class="headerlink" title="Camera 相机类"></a>Camera 相机类</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Camera - 相机类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Camera</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// position: Cartesian3</span></span><br><span class="line">    <span class="comment">// 作用: 相机在世界坐标系中的位置</span></span><br><span class="line">    <span class="comment">// 只读: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">position</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// direction: Cartesian3</span></span><br><span class="line">    <span class="comment">// 作用: 相机朝向（单位向量）</span></span><br><span class="line">    <span class="comment">// 只读: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">direction</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// up: Cartesian3</span></span><br><span class="line">    <span class="comment">// 作用: 相机上方向（单位向量）</span></span><br><span class="line">    <span class="comment">// 只读: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">up</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// right: Cartesian3</span></span><br><span class="line">    <span class="comment">// 作用: 相机右方向（单位向量）</span></span><br><span class="line">    <span class="comment">// 只读: true（由direction和up计算）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">right</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// frustum: Frustum</span></span><br><span class="line">    <span class="comment">// 作用: 视锥体（透视或正交投影）</span></span><br><span class="line">    <span class="comment">// 类型: PerspectiveFrustum | OrthographicFrustum</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">frustum</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PerspectiveFrustum</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// defaultMoveAmount: number</span></span><br><span class="line">    <span class="comment">// 作用: 默认移动距离</span></span><br><span class="line">    <span class="comment">// 默认: 100000.0（米）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">defaultMoveAmount</span> = <span class="number">100000.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// defaultLookAmount: number</span></span><br><span class="line">    <span class="comment">// 作用: 默认旋转角度</span></span><br><span class="line">    <span class="comment">// 默认: Math.PI / 60（弧度）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">defaultLookAmount</span> = <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">60</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// defaultRotateAmount: number</span></span><br><span class="line">    <span class="comment">// 作用: 默认旋转角度</span></span><br><span class="line">    <span class="comment">// 默认: Math.PI / 3600（弧度）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">defaultRotateAmount</span> = <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">3600</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// defaultZoomAmount: number</span></span><br><span class="line">    <span class="comment">// 作用: 默认缩放距离</span></span><br><span class="line">    <span class="comment">// 默认: 100000.0（米）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">defaultZoomAmount</span> = <span class="number">100000.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// constrainedAxis: Cartesian3</span></span><br><span class="line">    <span class="comment">// 作用: 约束轴（限制相机旋转）</span></span><br><span class="line">    <span class="comment">// 默认: undefined（无约束）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">constrainedAxis</span> = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// maximumZoomFactor: number</span></span><br><span class="line">    <span class="comment">// 作用: 最大缩放因子</span></span><br><span class="line">    <span class="comment">// 默认: 1.5</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maximumZoomFactor</span> = <span class="number">1.5</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === 事件 ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveStart: Event</span></span><br><span class="line">  <span class="comment">// 作用: 相机开始移动事件</span></span><br><span class="line">  <span class="comment">// 触发: 相机开始移动时</span></span><br><span class="line">  moveStart = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveEnd: Event</span></span><br><span class="line">  <span class="comment">// 作用: 相机停止移动事件</span></span><br><span class="line">  <span class="comment">// 触发: 相机停止移动时</span></span><br><span class="line">  moveEnd = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// changed: Event</span></span><br><span class="line">  <span class="comment">// 作用: 相机变化事件</span></span><br><span class="line">  <span class="comment">// 触发: 相机位置、方向或视锥体变化时</span></span><br><span class="line">  changed = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === 位置设置方法 ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// setView - 设置视图</span></span><br><span class="line">  <span class="title function_">setView</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="comment">// destination: Cartesian3 | Rectangle</span></span><br><span class="line">    <span class="comment">// 作用: 目标位置或区域</span></span><br><span class="line">    <span class="keyword">const</span> destination = options.<span class="property">destination</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// orientation: Object</span></span><br><span class="line">    <span class="comment">// 作用: 相机方向</span></span><br><span class="line">    <span class="comment">// heading: number - 航向角（弧度）</span></span><br><span class="line">    <span class="comment">// pitch: number - 俯仰角（弧度）</span></span><br><span class="line">    <span class="comment">// roll: number - 翻滚角（弧度）</span></span><br><span class="line">    <span class="keyword">const</span> orientation = options.<span class="property">orientation</span> || &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// endTransform: Matrix4</span></span><br><span class="line">    <span class="comment">// 作用: 结束变换矩阵</span></span><br><span class="line">    <span class="keyword">const</span> endTransform = options.<span class="property">endTransform</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// flyTo - 飞行到目标</span></span><br><span class="line">  <span class="title function_">flyTo</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="comment">// destination: Cartesian3 | Rectangle</span></span><br><span class="line">    <span class="comment">// 作用: 目标位置</span></span><br><span class="line">    <span class="keyword">const</span> destination = options.<span class="property">destination</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// orientation: Object</span></span><br><span class="line">    <span class="comment">// 作用: 目标方向</span></span><br><span class="line">    <span class="keyword">const</span> orientation = options.<span class="property">orientation</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// duration: number</span></span><br><span class="line">    <span class="comment">// 作用: 飞行时间（秒）</span></span><br><span class="line">    <span class="comment">// 默认: 自动计算</span></span><br><span class="line">    <span class="keyword">const</span> duration = options.<span class="property">duration</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// complete: function</span></span><br><span class="line">    <span class="comment">// 作用: 完成回调</span></span><br><span class="line">    <span class="keyword">const</span> complete = options.<span class="property">complete</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// cancel: function</span></span><br><span class="line">    <span class="comment">// 作用: 取消回调</span></span><br><span class="line">    <span class="keyword">const</span> cancel = options.<span class="property">cancel</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// endTransform: Matrix4</span></span><br><span class="line">    <span class="comment">// 作用: 结束变换矩阵</span></span><br><span class="line">    <span class="keyword">const</span> endTransform = options.<span class="property">endTransform</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// maximumHeight: number</span></span><br><span class="line">    <span class="comment">// 作用: 飞行最大高度</span></span><br><span class="line">    <span class="keyword">const</span> maximumHeight = options.<span class="property">maximumHeight</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// pitchAdjustHeight: number</span></span><br><span class="line">    <span class="comment">// 作用: 俯仰角调整高度</span></span><br><span class="line">    <span class="keyword">const</span> pitchAdjustHeight = options.<span class="property">pitchAdjustHeight</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// flyOverLongitude: number</span></span><br><span class="line">    <span class="comment">// 作用: 飞越经度</span></span><br><span class="line">    <span class="keyword">const</span> flyOverLongitude = options.<span class="property">flyOverLongitude</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// flyOverLongitudeWeight: number</span></span><br><span class="line">    <span class="comment">// 作用: 飞越经度权重</span></span><br><span class="line">    <span class="keyword">const</span> flyOverLongitudeWeight = options.<span class="property">flyOverLongitudeWeight</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// convert: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否转换坐标</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="keyword">const</span> convert = options.<span class="property">convert</span> !== <span class="literal">undefined</span> ? options.<span class="property">convert</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// easingFunction: EasingFunction</span></span><br><span class="line">    <span class="comment">// 作用: 缓动函数</span></span><br><span class="line">    <span class="keyword">const</span> easingFunction = options.<span class="property">easingFunction</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// lookAt - 看向目标</span></span><br><span class="line">  <span class="title function_">lookAt</span>(<span class="params">target, offset</span>) &#123;</span><br><span class="line">    <span class="comment">// target: Cartesian3</span></span><br><span class="line">    <span class="comment">// 作用: 目标位置</span></span><br><span class="line">    <span class="comment">// offset: Cartesian3 | HeadingPitchRange</span></span><br><span class="line">    <span class="comment">// 作用: 偏移量或方向距离</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// lookAtTransform - 应用变换后看向目标</span></span><br><span class="line">  <span class="title function_">lookAtTransform</span>(<span class="params">transform, offset</span>) &#123;</span><br><span class="line">    <span class="comment">// transform: Matrix4</span></span><br><span class="line">    <span class="comment">// 作用: 变换矩阵</span></span><br><span class="line">    <span class="comment">// offset: Cartesian3 | HeadingPitchRange</span></span><br><span class="line">    <span class="comment">// 作用: 偏移量</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === 移动方法 ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// move - 移动相机</span></span><br><span class="line">  <span class="title function_">move</span>(<span class="params">direction, amount</span>) &#123;</span><br><span class="line">    <span class="comment">// direction: Cartesian3</span></span><br><span class="line">    <span class="comment">// 作用: 移动方向（单位向量）</span></span><br><span class="line">    <span class="comment">// amount: number</span></span><br><span class="line">    <span class="comment">// 作用: 移动距离（米）</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveForward - 向前移动</span></span><br><span class="line">  <span class="title function_">moveForward</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultMoveAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - 移动距离</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveBackward - 向后移动</span></span><br><span class="line">  <span class="title function_">moveBackward</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultMoveAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - 移动距离</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveUp - 向上移动</span></span><br><span class="line">  <span class="title function_">moveUp</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultMoveAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - 移动距离</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveDown - 向下移动</span></span><br><span class="line">  <span class="title function_">moveDown</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultMoveAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - 移动距离</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveLeft - 向左移动</span></span><br><span class="line">  <span class="title function_">moveLeft</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultMoveAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - 移动距离</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveRight - 向右移动</span></span><br><span class="line">  <span class="title function_">moveRight</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultMoveAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - 移动距离</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === 旋转方法 ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// look - 旋转相机</span></span><br><span class="line">  <span class="title function_">look</span>(<span class="params">axis, angle</span>) &#123;</span><br><span class="line">    <span class="comment">// axis: Cartesian3</span></span><br><span class="line">    <span class="comment">// 作用: 旋转轴</span></span><br><span class="line">    <span class="comment">// angle: number</span></span><br><span class="line">    <span class="comment">// 作用: 旋转角度（弧度）</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// lookLeft - 向左看</span></span><br><span class="line">  <span class="title function_">lookLeft</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultLookAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - 旋转角度（弧度）</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// lookRight - 向右看</span></span><br><span class="line">  <span class="title function_">lookRight</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultLookAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - 旋转角度（弧度）</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// lookUp - 向上看</span></span><br><span class="line">  <span class="title function_">lookUp</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultLookAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - 旋转角度（弧度）</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// lookDown - 向下看</span></span><br><span class="line">  <span class="title function_">lookDown</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultLookAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - 旋转角度（弧度）</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// rotate - 绕点旋转</span></span><br><span class="line">  <span class="title function_">rotate</span>(<span class="params">axis, angle</span>) &#123;</span><br><span class="line">    <span class="comment">// axis: Cartesian3</span></span><br><span class="line">    <span class="comment">// 作用: 旋转轴</span></span><br><span class="line">    <span class="comment">// angle: number</span></span><br><span class="line">    <span class="comment">// 作用: 旋转角度（弧度）</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// rotateLeft - 向左旋转</span></span><br><span class="line">  <span class="title function_">rotateLeft</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultRotateAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - 旋转角度（弧度）</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// rotateRight - 向右旋转</span></span><br><span class="line">  <span class="title function_">rotateRight</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultRotateAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - 旋转角度（弧度）</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// rotateUp - 向上旋转</span></span><br><span class="line">  <span class="title function_">rotateUp</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultRotateAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - 旋转角度（弧度）</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// rotateDown - 向下旋转</span></span><br><span class="line">  <span class="title function_">rotateDown</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultRotateAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - 旋转角度（弧度）</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === 缩放方法 ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// zoomIn - 放大</span></span><br><span class="line">  <span class="title function_">zoomIn</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultZoomAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - 缩放距离（米）</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// zoomOut - 缩小</span></span><br><span class="line">  <span class="title function_">zoomOut</span>(<span class="params">amount = <span class="variable language_">this</span>.defaultZoomAmount</span>) &#123;</span><br><span class="line">    <span class="comment">// amount: number - 缩放距离（米）</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === 坐标转换方法 ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// pickEllipsoid - 拾取椭球面</span></span><br><span class="line">  <span class="title function_">pickEllipsoid</span>(<span class="params">windowPosition, ellipsoid = Cesium.Ellipsoid.WGS84</span>) &#123;</span><br><span class="line">    <span class="comment">// windowPosition: Cartesian2</span></span><br><span class="line">    <span class="comment">// 作用: 屏幕坐标</span></span><br><span class="line">    <span class="comment">// ellipsoid: Ellipsoid</span></span><br><span class="line">    <span class="comment">// 作用: 椭球体</span></span><br><span class="line">    <span class="comment">// 返回: Cartesian3 | undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getPickRay - 获取拾取射线</span></span><br><span class="line">  <span class="title function_">getPickRay</span>(<span class="params">windowPosition</span>) &#123;</span><br><span class="line">    <span class="comment">// windowPosition: Cartesian2</span></span><br><span class="line">    <span class="comment">// 作用: 屏幕坐标</span></span><br><span class="line">    <span class="comment">// 返回: Ray</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// worldToCameraCoordinates - 世界坐标转相机坐标</span></span><br><span class="line">  <span class="title function_">worldToCameraCoordinates</span>(<span class="params">cartesian, result</span>) &#123;</span><br><span class="line">    <span class="comment">// cartesian: Cartesian3</span></span><br><span class="line">    <span class="comment">// 作用: 世界坐标</span></span><br><span class="line">    <span class="comment">// result: Cartesian3</span></span><br><span class="line">    <span class="comment">// 作用: 结果对象</span></span><br><span class="line">    <span class="comment">// 返回: Cartesian3</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cameraToWorldCoordinates - 相机坐标转世界坐标</span></span><br><span class="line">  <span class="title function_">cameraToWorldCoordinates</span>(<span class="params">cartesian, result</span>) &#123;</span><br><span class="line">    <span class="comment">// cartesian: Cartesian3</span></span><br><span class="line">    <span class="comment">// 作用: 相机坐标</span></span><br><span class="line">    <span class="comment">// result: Cartesian3</span></span><br><span class="line">    <span class="comment">// 作用: 结果对象</span></span><br><span class="line">    <span class="comment">// 返回: Cartesian3</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === 计算属性 ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// heading: number</span></span><br><span class="line">  <span class="comment">// 作用: 航向角（弧度）</span></span><br><span class="line">  <span class="comment">// 只读: true</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">heading</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="property">TWO_PI</span> - <span class="title class_">Math</span>.<span class="title function_">atan2</span>(<span class="variable language_">this</span>.<span class="property">right</span>.<span class="property">y</span>, <span class="variable language_">this</span>.<span class="property">right</span>.<span class="property">x</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// pitch: number</span></span><br><span class="line">  <span class="comment">// 作用: 俯仰角（弧度）</span></span><br><span class="line">  <span class="comment">// 只读: true</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">pitch</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">asin</span>(<span class="variable language_">this</span>.<span class="property">direction</span>.<span class="property">z</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// roll: number</span></span><br><span class="line">  <span class="comment">// 作用: 翻滚角（弧度）</span></span><br><span class="line">  <span class="comment">// 只读: true</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">roll</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">atan2</span>(-<span class="variable language_">this</span>.<span class="property">up</span>.<span class="property">x</span>, <span class="variable language_">this</span>.<span class="property">up</span>.<span class="property">z</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// positionCartographic: Cartographic</span></span><br><span class="line">  <span class="comment">// 作用: 地理坐标位置</span></span><br><span class="line">  <span class="comment">// 只读: true</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">positionCartographic</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromCartesian</span>(<span class="variable language_">this</span>.<span class="property">position</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 相机使用示例</span></span><br><span class="line"><span class="keyword">const</span> camera = viewer.<span class="property">camera</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置相机位置</span></span><br><span class="line">camera.<span class="title function_">setView</span>(&#123;</span><br><span class="line">  <span class="attr">destination</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">1000</span>),</span><br><span class="line">  <span class="attr">orientation</span>: &#123;</span><br><span class="line">    <span class="attr">heading</span>: <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(<span class="number">0</span>), <span class="comment">// 正北方向</span></span><br><span class="line">    <span class="attr">pitch</span>: <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(-<span class="number">45</span>), <span class="comment">// 向下45度</span></span><br><span class="line">    <span class="attr">roll</span>: <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(<span class="number">0</span>), <span class="comment">// 无翻滚</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 飞行到位置</span></span><br><span class="line">camera.<span class="title function_">flyTo</span>(&#123;</span><br><span class="line">  <span class="attr">destination</span>: <span class="title class_">Cesium</span>.<span class="property">Rectangle</span>.<span class="title function_">fromDegrees</span>(<span class="number">115</span>, <span class="number">39</span>, <span class="number">117</span>, <span class="number">41</span>),</span><br><span class="line">  <span class="attr">duration</span>: <span class="number">3.0</span>,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;飞行完成&#x27;</span>),</span><br><span class="line">  <span class="attr">cancel</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;飞行取消&#x27;</span>),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 相机事件监听</span></span><br><span class="line">camera.<span class="property">moveStart</span>.<span class="title function_">addEventListener</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;相机开始移动&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">camera.<span class="property">moveEnd</span>.<span class="title function_">addEventListener</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;相机停止移动&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">camera.<span class="property">changed</span>.<span class="title function_">addEventListener</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;相机发生变化&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 相机控制</span></span><br><span class="line">camera.<span class="title function_">moveForward</span>(<span class="number">1000</span>) <span class="comment">// 向前移动1000米</span></span><br><span class="line">camera.<span class="title function_">lookLeft</span>(<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>) <span class="comment">// 向左看45度</span></span><br><span class="line">camera.<span class="title function_">zoomIn</span>(<span class="number">500</span>) <span class="comment">// 放大500米</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取相机信息</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;相机位置:&#x27;</span>, camera.<span class="property">position</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;相机方向:&#x27;</span>, camera.<span class="property">direction</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;航向角:&#x27;</span>, <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(camera.<span class="property">heading</span>))</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;俯仰角:&#x27;</span>, <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(camera.<span class="property">pitch</span>))</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;翻滚角:&#x27;</span>, <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(camera.<span class="property">roll</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 坐标转换</span></span><br><span class="line"><span class="keyword">const</span> screenPos = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">100</span>, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">const</span> worldPos = camera.<span class="title function_">pickEllipsoid</span>(screenPos)</span><br><span class="line"><span class="keyword">if</span> (worldPos) &#123;</span><br><span class="line">  <span class="keyword">const</span> cartographic = <span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromCartesian</span>(worldPos)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;点击位置:&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">longitude</span>: <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(cartographic.<span class="property">longitude</span>),</span><br><span class="line">    <span class="attr">latitude</span>: <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(cartographic.<span class="property">latitude</span>),</span><br><span class="line">    <span class="attr">height</span>: cartographic.<span class="property">height</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="事件系统详解"><a href="#事件系统详解" class="headerlink" title="事件系统详解"></a>事件系统详解</h2><h3 id="ScreenSpaceEventHandler-屏幕空间事件处理器"><a href="#ScreenSpaceEventHandler-屏幕空间事件处理器" class="headerlink" title="ScreenSpaceEventHandler 屏幕空间事件处理器"></a>ScreenSpaceEventHandler 屏幕空间事件处理器</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ScreenSpaceEventHandler - 屏幕空间事件处理器</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ScreenSpaceEventHandler</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">canvas</span>) &#123;</span><br><span class="line">    <span class="comment">// canvas: HTMLCanvasElement</span></span><br><span class="line">    <span class="comment">// 作用: 事件监听的画布元素</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span> = canvas</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setInputAction - 设置输入动作</span></span><br><span class="line">  <span class="title function_">setInputAction</span>(<span class="params">action, type, modifier</span>) &#123;</span><br><span class="line">    <span class="comment">// action: function</span></span><br><span class="line">    <span class="comment">// 作用: 事件处理函数</span></span><br><span class="line">    <span class="comment">// 参数: event对象，包含position等信息</span></span><br><span class="line">    <span class="comment">// type: ScreenSpaceEventType</span></span><br><span class="line">    <span class="comment">// 作用: 事件类型</span></span><br><span class="line">    <span class="comment">// 选项: LEFT_CLICK, LEFT_DOUBLE_CLICK, LEFT_DOWN, LEFT_UP,</span></span><br><span class="line">    <span class="comment">//       RIGHT_CLICK, RIGHT_DOWN, RIGHT_UP,</span></span><br><span class="line">    <span class="comment">//       MIDDLE_CLICK, MIDDLE_DOWN, MIDDLE_UP,</span></span><br><span class="line">    <span class="comment">//       MOUSE_MOVE, WHEEL, PINCH_START, PINCH_END, PINCH_MOVE</span></span><br><span class="line">    <span class="comment">// modifier: KeyboardEventModifier (可选)</span></span><br><span class="line">    <span class="comment">// 作用: 键盘修饰符</span></span><br><span class="line">    <span class="comment">// 选项: SHIFT, CTRL, ALT</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getInputAction - 获取输入动作</span></span><br><span class="line">  <span class="title function_">getInputAction</span>(<span class="params">type, modifier</span>) &#123;</span><br><span class="line">    <span class="comment">// 返回: function | undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// removeInputAction - 移除输入动作</span></span><br><span class="line">  <span class="title function_">removeInputAction</span>(<span class="params">type, modifier</span>) &#123;</span><br><span class="line">    <span class="comment">// 移除指定类型的事件处理</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// isDestroyed - 是否已销毁</span></span><br><span class="line">  <span class="title function_">isDestroyed</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_isDestroyed</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// destroy - 销毁处理器</span></span><br><span class="line">  <span class="title function_">destroy</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 清理所有事件监听</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 事件类型详解</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ScreenSpaceEventType</span> = &#123;</span><br><span class="line">  <span class="comment">// 鼠标点击事件</span></span><br><span class="line">  <span class="attr">LEFT_CLICK</span>: <span class="number">0</span>, <span class="comment">// 左键单击</span></span><br><span class="line">  <span class="attr">LEFT_DOUBLE_CLICK</span>: <span class="number">1</span>, <span class="comment">// 左键双击</span></span><br><span class="line">  <span class="attr">LEFT_DOWN</span>: <span class="number">2</span>, <span class="comment">// 左键按下</span></span><br><span class="line">  <span class="attr">LEFT_UP</span>: <span class="number">3</span>, <span class="comment">// 左键抬起</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">RIGHT_CLICK</span>: <span class="number">5</span>, <span class="comment">// 右键单击</span></span><br><span class="line">  <span class="attr">RIGHT_DOWN</span>: <span class="number">6</span>, <span class="comment">// 右键按下</span></span><br><span class="line">  <span class="attr">RIGHT_UP</span>: <span class="number">7</span>, <span class="comment">// 右键抬起</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">MIDDLE_CLICK</span>: <span class="number">10</span>, <span class="comment">// 中键单击</span></span><br><span class="line">  <span class="attr">MIDDLE_DOWN</span>: <span class="number">11</span>, <span class="comment">// 中键按下</span></span><br><span class="line">  <span class="attr">MIDDLE_UP</span>: <span class="number">12</span>, <span class="comment">// 中键抬起</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 鼠标移动和滚轮</span></span><br><span class="line">  <span class="attr">MOUSE_MOVE</span>: <span class="number">15</span>, <span class="comment">// 鼠标移动</span></span><br><span class="line">  <span class="attr">WHEEL</span>: <span class="number">16</span>, <span class="comment">// 滚轮滚动</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 触摸事件</span></span><br><span class="line">  <span class="attr">PINCH_START</span>: <span class="number">17</span>, <span class="comment">// 捏合开始</span></span><br><span class="line">  <span class="attr">PINCH_END</span>: <span class="number">18</span>, <span class="comment">// 捏合结束</span></span><br><span class="line">  <span class="attr">PINCH_MOVE</span>: <span class="number">19</span>, <span class="comment">// 捏合移动</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 键盘修饰符</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">KeyboardEventModifier</span> = &#123;</span><br><span class="line">  <span class="attr">SHIFT</span>: <span class="number">0</span>, <span class="comment">// Shift键</span></span><br><span class="line">  <span class="attr">CTRL</span>: <span class="number">1</span>, <span class="comment">// Ctrl键</span></span><br><span class="line">  <span class="attr">ALT</span>: <span class="number">2</span>, <span class="comment">// Alt键</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 事件处理示例</span></span><br><span class="line"><span class="keyword">const</span> handler = viewer.<span class="property">cesiumWidget</span>.<span class="property">screenSpaceEventHandler</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 左键点击事件</span></span><br><span class="line">handler.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> position = event.<span class="property">position</span> <span class="comment">// Cartesian2屏幕坐标</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 拾取对象</span></span><br><span class="line">  <span class="keyword">const</span> pickedObject = viewer.<span class="property">scene</span>.<span class="title function_">pick</span>(position)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Cesium</span>.<span class="title function_">defined</span>(pickedObject)) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;点击了对象:&#x27;</span>, pickedObject.<span class="property">id</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 选中实体</span></span><br><span class="line">    viewer.<span class="property">selectedEntity</span> = pickedObject.<span class="property">id</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 拾取地面位置</span></span><br><span class="line">    <span class="keyword">const</span> cartesian = viewer.<span class="property">camera</span>.<span class="title function_">pickEllipsoid</span>(position, viewer.<span class="property">scene</span>.<span class="property">globe</span>.<span class="property">ellipsoid</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cartesian) &#123;</span><br><span class="line">      <span class="keyword">const</span> cartographic = <span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromCartesian</span>(cartesian)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;点击地面位置:&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">longitude</span>: <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(cartographic.<span class="property">longitude</span>),</span><br><span class="line">        <span class="attr">latitude</span>: <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(cartographic.<span class="property">latitude</span>),</span><br><span class="line">        <span class="attr">height</span>: cartographic.<span class="property">height</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">LEFT_CLICK</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 右键点击事件</span></span><br><span class="line">handler.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> position = event.<span class="property">position</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 显示上下文菜单</span></span><br><span class="line">  <span class="title function_">showContextMenu</span>(position)</span><br><span class="line">&#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">RIGHT_CLICK</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 鼠标移动事件</span></span><br><span class="line">handler.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> startPosition = event.<span class="property">startPosition</span> <span class="comment">// 开始位置</span></span><br><span class="line">  <span class="keyword">const</span> endPosition = event.<span class="property">endPosition</span> <span class="comment">// 结束位置</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 拾取悬停对象</span></span><br><span class="line">  <span class="keyword">const</span> pickedObject = viewer.<span class="property">scene</span>.<span class="title function_">pick</span>(endPosition)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Cesium</span>.<span class="title function_">defined</span>(pickedObject)) &#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">style</span>.<span class="property">cursor</span> = <span class="string">&#x27;pointer&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 显示工具提示</span></span><br><span class="line">    <span class="title function_">showTooltip</span>(endPosition, pickedObject.<span class="property">id</span>.<span class="property">name</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">style</span>.<span class="property">cursor</span> = <span class="string">&#x27;default&#x27;</span></span><br><span class="line">    <span class="title function_">hideTooltip</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">MOUSE_MOVE</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 滚轮事件</span></span><br><span class="line">handler.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> delta = event <span class="comment">// 滚轮增量</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;滚轮滚动:&#x27;</span>, delta)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 自定义缩放逻辑</span></span><br><span class="line">  <span class="keyword">if</span> (delta &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    viewer.<span class="property">camera</span>.<span class="title function_">zoomIn</span>(viewer.<span class="property">camera</span>.<span class="property">defaultZoomAmount</span> * <span class="number">0.5</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    viewer.<span class="property">camera</span>.<span class="title function_">zoomOut</span>(viewer.<span class="property">camera</span>.<span class="property">defaultZoomAmount</span> * <span class="number">0.5</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">WHEEL</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 左键拖拽事件</span></span><br><span class="line"><span class="keyword">let</span> isDragging = <span class="literal">false</span></span><br><span class="line"><span class="keyword">let</span> startPosition</span><br><span class="line"></span><br><span class="line">handler.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  isDragging = <span class="literal">true</span></span><br><span class="line">  startPosition = event.<span class="property">position</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 禁用默认相机控制</span></span><br><span class="line">  viewer.<span class="property">scene</span>.<span class="property">screenSpaceCameraController</span>.<span class="property">enableRotate</span> = <span class="literal">false</span></span><br><span class="line">&#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">LEFT_DOWN</span>)</span><br><span class="line"></span><br><span class="line">handler.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (isDragging) &#123;</span><br><span class="line">    <span class="keyword">const</span> endPosition = event.<span class="property">endPosition</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算拖拽距离</span></span><br><span class="line">    <span class="keyword">const</span> deltaX = endPosition.<span class="property">x</span> - startPosition.<span class="property">x</span></span><br><span class="line">    <span class="keyword">const</span> deltaY = endPosition.<span class="property">y</span> - startPosition.<span class="property">y</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;拖拽距离:&#x27;</span>, &#123; deltaX, deltaY &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自定义拖拽逻辑</span></span><br><span class="line">    <span class="title function_">customDragLogic</span>(deltaX, deltaY)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">MOUSE_MOVE</span>)</span><br><span class="line"></span><br><span class="line">handler.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  isDragging = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 恢复默认相机控制</span></span><br><span class="line">  viewer.<span class="property">scene</span>.<span class="property">screenSpaceCameraController</span>.<span class="property">enableRotate</span> = <span class="literal">true</span></span><br><span class="line">&#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">LEFT_UP</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 带修饰符的事件</span></span><br><span class="line">handler.<span class="title function_">setInputAction</span>(</span><br><span class="line">  <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Ctrl + 左键点击&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 多选模式</span></span><br><span class="line">    <span class="title function_">toggleEntitySelection</span>(event.<span class="property">position</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">LEFT_CLICK</span>,</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">KeyboardEventModifier</span>.<span class="property">CTRL</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">handler.<span class="title function_">setInputAction</span>(</span><br><span class="line">  <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Shift + 左键点击&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 框选模式</span></span><br><span class="line">    <span class="title function_">startBoxSelection</span>(event.<span class="property">position</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">LEFT_CLICK</span>,</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">KeyboardEventModifier</span>.<span class="property">SHIFT</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 触摸事件（移动设备）</span></span><br><span class="line">handler.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> position1 = event.<span class="property">position1</span> <span class="comment">// 第一个触摸点</span></span><br><span class="line">  <span class="keyword">const</span> position2 = event.<span class="property">position2</span> <span class="comment">// 第二个触摸点</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;开始捏合手势&#x27;</span>)</span><br><span class="line">&#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">PINCH_START</span>)</span><br><span class="line"></span><br><span class="line">handler.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> position1 = event.<span class="property">position1</span></span><br><span class="line">  <span class="keyword">const</span> position2 = event.<span class="property">position2</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计算缩放比例</span></span><br><span class="line">  <span class="keyword">const</span> distance = <span class="title class_">Cesium</span>.<span class="property">Cartesian2</span>.<span class="title function_">distance</span>(position1, position2)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;捏合距离:&#x27;</span>, distance)</span><br><span class="line">&#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">PINCH_MOVE</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义工具提示</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showTooltip</span>(<span class="params">position, text</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> tooltip = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;tooltip&#x27;</span>)</span><br><span class="line">  <span class="keyword">if</span> (!tooltip) &#123;</span><br><span class="line">    <span class="keyword">const</span> div = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    div.<span class="property">id</span> = <span class="string">&#x27;tooltip&#x27;</span></span><br><span class="line">    div.<span class="property">style</span>.<span class="property">position</span> = <span class="string">&#x27;absolute&#x27;</span></span><br><span class="line">    div.<span class="property">style</span>.<span class="property">background</span> = <span class="string">&#x27;rgba(0,0,0,0.8)&#x27;</span></span><br><span class="line">    div.<span class="property">style</span>.<span class="property">color</span> = <span class="string">&#x27;white&#x27;</span></span><br><span class="line">    div.<span class="property">style</span>.<span class="property">padding</span> = <span class="string">&#x27;5px&#x27;</span></span><br><span class="line">    div.<span class="property">style</span>.<span class="property">borderRadius</span> = <span class="string">&#x27;3px&#x27;</span></span><br><span class="line">    div.<span class="property">style</span>.<span class="property">pointerEvents</span> = <span class="string">&#x27;none&#x27;</span></span><br><span class="line">    div.<span class="property">style</span>.<span class="property">zIndex</span> = <span class="string">&#x27;1000&#x27;</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(div)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> tooltip = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;tooltip&#x27;</span>)</span><br><span class="line">  tooltip.<span class="property">textContent</span> = text</span><br><span class="line">  tooltip.<span class="property">style</span>.<span class="property">left</span> = position.<span class="property">x</span> + <span class="number">10</span> + <span class="string">&#x27;px&#x27;</span></span><br><span class="line">  tooltip.<span class="property">style</span>.<span class="property">top</span> = position.<span class="property">y</span> - <span class="number">30</span> + <span class="string">&#x27;px&#x27;</span></span><br><span class="line">  tooltip.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;block&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hideTooltip</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> tooltip = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;tooltip&#x27;</span>)</span><br><span class="line">  <span class="keyword">if</span> (tooltip) &#123;</span><br><span class="line">    tooltip.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 移除事件处理</span></span><br><span class="line">handler.<span class="title function_">removeInputAction</span>(<span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">LEFT_CLICK</span>)</span><br><span class="line">handler.<span class="title function_">removeInputAction</span>(<span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">LEFT_CLICK</span>, <span class="title class_">Cesium</span>.<span class="property">KeyboardEventModifier</span>.<span class="property">CTRL</span>)</span><br></pre></td></tr></table></figure><h2 id="材质系统详解"><a href="#材质系统详解" class="headerlink" title="材质系统详解"></a>材质系统详解</h2><h3 id="Material-材质类"><a href="#Material-材质类" class="headerlink" title="Material 材质类"></a>Material 材质类</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Material - 材质基类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Material</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// fabric: Object</span></span><br><span class="line">    <span class="comment">// 作用: 材质描述对象</span></span><br><span class="line">    <span class="comment">// 包含: type, uniforms, source等</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fabric</span> = options.<span class="property">fabric</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// translucent: boolean | function</span></span><br><span class="line">    <span class="comment">// 作用: 是否透明</span></span><br><span class="line">    <span class="comment">// 默认: 根据材质类型确定</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">translucent</span> = options.<span class="property">translucent</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 静态方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromType - 从类型创建材质</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromType</span>(<span class="params">type, uniforms</span>) &#123;</span><br><span class="line">    <span class="comment">// type: string - 材质类型</span></span><br><span class="line">    <span class="comment">// uniforms: Object - 材质参数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Material</span>(&#123;</span><br><span class="line">      <span class="attr">fabric</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: type,</span><br><span class="line">        <span class="attr">uniforms</span>: uniforms,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 内置材质类型</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">ColorType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Color&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// 纯色</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">ImageType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Image&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// 图片</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">DiffuseMapType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;DiffuseMap&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// 漫反射贴图</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">AlphaMapType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;AlphaMap&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// 透明贴图</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">SpecularMapType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;SpecularMap&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// 镜面贴图</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">EmissionMapType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;EmissionMap&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// 发射贴图</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">BumpMapType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;BumpMap&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// 凹凸贴图</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">NormalMapType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;NormalMap&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// 法线贴图</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">GridType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Grid&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// 网格</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">StripeType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Stripe&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// 条纹</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">CheckerboardType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Checkerboard&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// 棋盘</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">DotType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Dot&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// 点</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">WaterType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Water&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// 水面</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">RimLightingType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;RimLighting&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// 边缘光照</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">FadeType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Fade&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// 渐变</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">PolylineArrowType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;PolylineArrow&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// 箭头线</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">PolylineGlowType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;PolylineGlow&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// 发光线</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">PolylineOutlineType</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;PolylineOutline&#x27;</span></span><br><span class="line">  &#125; <span class="comment">// 轮廓线</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 颜色材质</span></span><br><span class="line"><span class="keyword">const</span> colorMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ColorMaterialProperty</span>(<span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 图片材质</span></span><br><span class="line"><span class="keyword">const</span> imageMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ImageMaterialProperty</span>(&#123;</span><br><span class="line">  <span class="attr">image</span>: <span class="string">&#x27;path/to/texture.jpg&#x27;</span>, <span class="comment">// 图片路径</span></span><br><span class="line">  <span class="attr">repeat</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">2.0</span>, <span class="number">2.0</span>), <span class="comment">// 重复次数</span></span><br><span class="line">  <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span>, <span class="comment">// 混合颜色</span></span><br><span class="line">  <span class="attr">transparent</span>: <span class="literal">false</span>, <span class="comment">// 是否透明</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 网格材质</span></span><br><span class="line"><span class="keyword">const</span> gridMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">GridMaterialProperty</span>(&#123;</span><br><span class="line">  <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>, <span class="comment">// 网格颜色</span></span><br><span class="line">  <span class="attr">cellAlpha</span>: <span class="number">0.1</span>, <span class="comment">// 单元格透明度</span></span><br><span class="line">  <span class="attr">lineCount</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">8</span>, <span class="number">8</span>), <span class="comment">// 网格数量</span></span><br><span class="line">  <span class="attr">lineThickness</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">2.0</span>, <span class="number">2.0</span>), <span class="comment">// 线条粗细</span></span><br><span class="line">  <span class="attr">lineOffset</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">0.5</span>, <span class="number">0.5</span>), <span class="comment">// 线条偏移</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 条纹材质</span></span><br><span class="line"><span class="keyword">const</span> stripeMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">StripeMaterialProperty</span>(&#123;</span><br><span class="line">  <span class="attr">evenColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span>, <span class="comment">// 偶数条纹颜色</span></span><br><span class="line">  <span class="attr">oddColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>, <span class="comment">// 奇数条纹颜色</span></span><br><span class="line">  <span class="attr">repeat</span>: <span class="number">16.0</span>, <span class="comment">// 条纹数量</span></span><br><span class="line">  <span class="attr">offset</span>: <span class="number">0.0</span>, <span class="comment">// 偏移量</span></span><br><span class="line">  <span class="attr">orientation</span>: <span class="title class_">Cesium</span>.<span class="property">StripeOrientation</span>.<span class="property">HORIZONTAL</span>, <span class="comment">// 方向</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 棋盘材质</span></span><br><span class="line"><span class="keyword">const</span> checkerboardMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">CheckerboardMaterialProperty</span>(&#123;</span><br><span class="line">  <span class="attr">evenColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span>, <span class="comment">// 偶数格颜色</span></span><br><span class="line">  <span class="attr">oddColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>, <span class="comment">// 奇数格颜色</span></span><br><span class="line">  <span class="attr">repeat</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">4.0</span>, <span class="number">4.0</span>), <span class="comment">// 重复次数</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 点材质</span></span><br><span class="line"><span class="keyword">const</span> dotMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">DotMaterialProperty</span>(&#123;</span><br><span class="line">  <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>, <span class="comment">// 点颜色</span></span><br><span class="line">  <span class="attr">repeat</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">16.0</span>, <span class="number">16.0</span>), <span class="comment">// 点的重复次数</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 水面材质</span></span><br><span class="line"><span class="keyword">const</span> waterMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">WaterMaterialProperty</span>(&#123;</span><br><span class="line">  <span class="attr">baseWaterColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">AQUA</span>, <span class="comment">// 基础水色</span></span><br><span class="line">  <span class="attr">blendColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLUE</span>, <span class="comment">// 混合颜色</span></span><br><span class="line">  <span class="attr">specularMap</span>: <span class="string">&#x27;path/to/specular.jpg&#x27;</span>, <span class="comment">// 镜面贴图</span></span><br><span class="line">  <span class="attr">normalMap</span>: <span class="string">&#x27;path/to/normal.jpg&#x27;</span>, <span class="comment">// 法线贴图</span></span><br><span class="line">  <span class="attr">frequency</span>: <span class="number">10.0</span>, <span class="comment">// 波浪频率</span></span><br><span class="line">  <span class="attr">animationSpeed</span>: <span class="number">0.01</span>, <span class="comment">// 动画速度</span></span><br><span class="line">  <span class="attr">amplitude</span>: <span class="number">1.0</span>, <span class="comment">// 波幅</span></span><br><span class="line">  <span class="attr">specularIntensity</span>: <span class="number">0.5</span>, <span class="comment">// 镜面强度</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 边缘光照材质</span></span><br><span class="line"><span class="keyword">const</span> rimLightingMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">RimLightingMaterialProperty</span>(&#123;</span><br><span class="line">  <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">LIME</span>, <span class="comment">// 边缘颜色</span></span><br><span class="line">  <span class="attr">rimColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span>, <span class="comment">// 边缘光颜色</span></span><br><span class="line">  <span class="attr">alpha</span>: <span class="number">1.0</span>, <span class="comment">// 透明度</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 渐变材质</span></span><br><span class="line"><span class="keyword">const</span> fadeMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">FadeMaterialProperty</span>(&#123;</span><br><span class="line">  <span class="attr">fadeInColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span>, <span class="comment">// 渐入颜色</span></span><br><span class="line">  <span class="attr">fadeOutColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLUE</span>, <span class="comment">// 渐出颜色</span></span><br><span class="line">  <span class="attr">maximumDistance</span>: <span class="number">500000.0</span>, <span class="comment">// 最大距离</span></span><br><span class="line">  <span class="attr">repeat</span>: <span class="literal">true</span>, <span class="comment">// 是否重复</span></span><br><span class="line">  <span class="attr">fadeDirection</span>: &#123;</span><br><span class="line">    <span class="comment">// 渐变方向</span></span><br><span class="line">    <span class="attr">x</span>: <span class="number">1.0</span>,</span><br><span class="line">    <span class="attr">y</span>: <span class="number">0.0</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多段线材质</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 箭头线材质</span></span><br><span class="line"><span class="keyword">const</span> arrowMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PolylineArrowMaterialProperty</span>(<span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发光线材质</span></span><br><span class="line"><span class="keyword">const</span> glowMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PolylineGlowMaterialProperty</span>(&#123;</span><br><span class="line">  <span class="attr">glowPower</span>: <span class="number">0.2</span>, <span class="comment">// 发光强度</span></span><br><span class="line">  <span class="attr">taperPower</span>: <span class="number">0.5</span>, <span class="comment">// 锥形强度</span></span><br><span class="line">  <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLUE</span>, <span class="comment">// 颜色</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 虚线材质</span></span><br><span class="line"><span class="keyword">const</span> dashMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PolylineDashMaterialProperty</span>(&#123;</span><br><span class="line">  <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">CYAN</span>, <span class="comment">// 颜色</span></span><br><span class="line">  <span class="attr">gapColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">TRANSPARENT</span>, <span class="comment">// 间隙颜色</span></span><br><span class="line">  <span class="attr">dashLength</span>: <span class="number">16.0</span>, <span class="comment">// 虚线长度</span></span><br><span class="line">  <span class="attr">dashPattern</span>: <span class="number">255</span>, <span class="comment">// 虚线模式（二进制）</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 轮廓线材质</span></span><br><span class="line"><span class="keyword">const</span> outlineMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PolylineOutlineMaterialProperty</span>(&#123;</span><br><span class="line">  <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">ORANGE</span>, <span class="comment">// 内部颜色</span></span><br><span class="line">  <span class="attr">outlineColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>, <span class="comment">// 轮廓颜色</span></span><br><span class="line">  <span class="attr">outlineWidth</span>: <span class="number">2.0</span>, <span class="comment">// 轮廓宽度</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义着色器材质</span></span><br><span class="line"><span class="keyword">const</span> customMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Material</span>(&#123;</span><br><span class="line">  <span class="attr">fabric</span>: &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;CustomShader&#x27;</span>,</span><br><span class="line">    <span class="attr">uniforms</span>: &#123;</span><br><span class="line">      <span class="attr">color</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Color</span>(<span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>),</span><br><span class="line">      <span class="attr">time</span>: <span class="number">0.0</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">source</span>: <span class="string">`</span></span><br><span class="line"><span class="string">      uniform vec4 color;</span></span><br><span class="line"><span class="string">      uniform float time;</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">      czm_material czm_getMaterial(czm_materialInput materialInput) &#123;</span></span><br><span class="line"><span class="string">        czm_material material = czm_getDefaultMaterial(materialInput);</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        vec2 st = materialInput.st;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        // 动画波纹效果</span></span><br><span class="line"><span class="string">        float wave = sin(st.s * 10.0 + time) * 0.5 + 0.5;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        material.diffuse = color.rgb * wave;</span></span><br><span class="line"><span class="string">        material.alpha = color.a;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        return material;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    `</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 应用材质到实体</span></span><br><span class="line"><span class="keyword">const</span> entity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">rectangle</span>: &#123;</span><br><span class="line">    <span class="attr">coordinates</span>: <span class="title class_">Cesium</span>.<span class="property">Rectangle</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.0</span>, <span class="number">39.0</span>, <span class="number">117.0</span>, <span class="number">40.0</span>),</span><br><span class="line">    <span class="attr">material</span>: imageMaterial, <span class="comment">// 应用图片材质</span></span><br><span class="line">    <span class="attr">height</span>: <span class="number">0</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 动态改变材质</span></span><br><span class="line">entity.<span class="property">rectangle</span>.<span class="property">material</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">CallbackProperty</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 根据时间变化返回不同材质</span></span><br><span class="line">  <span class="keyword">const</span> time = viewer.<span class="property">clock</span>.<span class="property">currentTime</span></span><br><span class="line">  <span class="keyword">const</span> seconds = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">secondsDifference</span>(time, viewer.<span class="property">clock</span>.<span class="property">startTime</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (seconds % <span class="number">4</span> &lt; <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLUE</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="literal">false</span>)</span><br></pre></td></tr></table></figure><h2 id="动画系统详解"><a href="#动画系统详解" class="headerlink" title="动画系统详解"></a>动画系统详解</h2><h3 id="Animation-动画"><a href="#Animation-动画" class="headerlink" title="Animation 动画"></a>Animation 动画</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Clock - 时钟类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Clock</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// startTime: JulianDate</span></span><br><span class="line">    <span class="comment">// 作用: 开始时间</span></span><br><span class="line">    <span class="comment">// 默认: JulianDate.now()</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">startTime</span> = options.<span class="property">startTime</span> || <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">now</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// stopTime: JulianDate</span></span><br><span class="line">    <span class="comment">// 作用: 结束时间</span></span><br><span class="line">    <span class="comment">// 默认: 开始时间 + 1天</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">stopTime</span> =</span><br><span class="line">      options.<span class="property">stopTime</span> || <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addDays</span>(<span class="variable language_">this</span>.<span class="property">startTime</span>, <span class="number">1</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// currentTime: JulianDate</span></span><br><span class="line">    <span class="comment">// 作用: 当前时间</span></span><br><span class="line">    <span class="comment">// 默认: 开始时间</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">currentTime</span> = options.<span class="property">currentTime</span> || <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">clone</span>(<span class="variable language_">this</span>.<span class="property">startTime</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// multiplier: number</span></span><br><span class="line">    <span class="comment">// 作用: 时间倍率</span></span><br><span class="line">    <span class="comment">// 默认: 1.0（实时）</span></span><br><span class="line">    <span class="comment">// 正值: 正向播放，负值: 反向播放</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">multiplier</span> = options.<span class="property">multiplier</span> !== <span class="literal">undefined</span> ? options.<span class="property">multiplier</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// clockStep: ClockStep</span></span><br><span class="line">    <span class="comment">// 作用: 时钟步进模式</span></span><br><span class="line">    <span class="comment">// 默认: ClockStep.SYSTEM_CLOCK_MULTIPLIER</span></span><br><span class="line">    <span class="comment">// 选项: TICK_DEPENDENT, SYSTEM_CLOCK_MULTIPLIER, SYSTEM_CLOCK</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clockStep</span> = options.<span class="property">clockStep</span> || <span class="title class_">Cesium</span>.<span class="property">ClockStep</span>.<span class="property">SYSTEM_CLOCK_MULTIPLIER</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// clockRange: ClockRange</span></span><br><span class="line">    <span class="comment">// 作用: 时钟范围行为</span></span><br><span class="line">    <span class="comment">// 默认: ClockRange.UNBOUNDED</span></span><br><span class="line">    <span class="comment">// 选项: UNBOUNDED, CLAMPED, LOOP_STOP</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clockRange</span> = options.<span class="property">clockRange</span> || <span class="title class_">Cesium</span>.<span class="property">ClockRange</span>.<span class="property">UNBOUNDED</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// canAnimate: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否可以动画</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canAnimate</span> = options.<span class="property">canAnimate</span> !== <span class="literal">undefined</span> ? options.<span class="property">canAnimate</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// shouldAnimate: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否应该动画</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shouldAnimate</span> = options.<span class="property">shouldAnimate</span> !== <span class="literal">undefined</span> ? options.<span class="property">shouldAnimate</span> : <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 事件</span></span><br><span class="line">  <span class="comment">// onTick: Event</span></span><br><span class="line">  <span class="comment">// 作用: 时钟滴答事件</span></span><br><span class="line">  <span class="comment">// 参数: clock对象</span></span><br><span class="line">  onTick = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// onStop: Event</span></span><br><span class="line">  <span class="comment">// 作用: 时钟停止事件</span></span><br><span class="line">  onStop = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// tick - 时钟滴答</span></span><br><span class="line">  <span class="title function_">tick</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 更新当前时间并触发事件</span></span><br><span class="line">    <span class="keyword">const</span> currentTime = <span class="variable language_">this</span>.<span class="property">currentTime</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">onTick</span>.<span class="title function_">raiseEvent</span>(<span class="variable language_">this</span>)</span><br><span class="line">    <span class="keyword">return</span> currentTime</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 时间相关类型</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ClockStep</span> = &#123;</span><br><span class="line">  <span class="attr">TICK_DEPENDENT</span>: <span class="number">0</span>, <span class="comment">// 依赖滴答</span></span><br><span class="line">  <span class="attr">SYSTEM_CLOCK_MULTIPLIER</span>: <span class="number">1</span>, <span class="comment">// 系统时钟倍率</span></span><br><span class="line">  <span class="attr">SYSTEM_CLOCK</span>: <span class="number">2</span>, <span class="comment">// 系统时钟</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ClockRange</span> = &#123;</span><br><span class="line">  <span class="attr">UNBOUNDED</span>: <span class="number">0</span>, <span class="comment">// 无界限</span></span><br><span class="line">  <span class="attr">CLAMPED</span>: <span class="number">1</span>, <span class="comment">// 钳制</span></span><br><span class="line">  <span class="attr">LOOP_STOP</span>: <span class="number">2</span>, <span class="comment">// 循环停止</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Property - 属性类（动画基础）</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Property</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// definitionChanged: Event</span></span><br><span class="line">    <span class="comment">// 作用: 定义变化事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">definitionChanged</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// isConstant: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否为常量</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isConstant</span> = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getValue - 获取指定时间的值</span></span><br><span class="line">  <span class="title function_">getValue</span>(<span class="params">time, result</span>) &#123;</span><br><span class="line">    <span class="comment">// time: JulianDate - 时间</span></span><br><span class="line">    <span class="comment">// result: Object - 结果对象</span></span><br><span class="line">    <span class="comment">// 返回: 属性值</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// equals - 比较相等</span></span><br><span class="line">  <span class="title function_">equals</span>(<span class="params">other</span>) &#123;</span><br><span class="line">    <span class="comment">// other: Property - 其他属性</span></span><br><span class="line">    <span class="comment">// 返回: boolean</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ConstantProperty - 常量属性</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConstantProperty</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Property</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_value</span> = value</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isConstant</span> = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getValue</span>(<span class="params">time, result</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_value</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setValue</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> oldValue = <span class="variable language_">this</span>.<span class="property">_value</span></span><br><span class="line">    <span class="keyword">if</span> (oldValue !== value) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_value</span> = value</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">definitionChanged</span>.<span class="title function_">raiseEvent</span>(<span class="variable language_">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SampledProperty - 采样属性（关键帧动画）</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SampledProperty</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Property</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">type</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_type</span> = type</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_times</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_values</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_interpolationDegree</span> = <span class="number">1</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_interpolationAlgorithm</span> = <span class="title class_">Cesium</span>.<span class="property">LinearApproximation</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// addSample - 添加采样点</span></span><br><span class="line">  <span class="title function_">addSample</span>(<span class="params">time, value</span>) &#123;</span><br><span class="line">    <span class="comment">// time: JulianDate - 时间</span></span><br><span class="line">    <span class="comment">// value: Object - 值</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// addSamples - 批量添加采样点</span></span><br><span class="line">  <span class="title function_">addSamples</span>(<span class="params">times, values</span>) &#123;</span><br><span class="line">    <span class="comment">// times: Array&lt;JulianDate&gt; - 时间数组</span></span><br><span class="line">    <span class="comment">// values: Array&lt;Object&gt; - 值数组</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// removeSample - 移除采样点</span></span><br><span class="line">  <span class="title function_">removeSample</span>(<span class="params">time</span>) &#123;</span><br><span class="line">    <span class="comment">// time: JulianDate - 时间</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setInterpolationOptions - 设置插值选项</span></span><br><span class="line">  <span class="title function_">setInterpolationOptions</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="comment">// options.interpolationDegree: number - 插值度数</span></span><br><span class="line">    <span class="comment">// options.interpolationAlgorithm: InterpolationAlgorithm - 插值算法</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CallbackProperty - 回调属性（程序化动画）</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CallbackProperty</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Property</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">callback, isConstant</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_callback</span> = callback</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isConstant</span> = isConstant || <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getValue</span>(<span class="params">time, result</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_callback</span>(time, result)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CompositeProperty - 复合属性（分段动画）</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CompositeProperty</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Property</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_intervals</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeIntervalCollection</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// addInterval - 添加时间间隔</span></span><br><span class="line">  <span class="title function_">addInterval</span>(<span class="params">interval</span>) &#123;</span><br><span class="line">    <span class="comment">// interval: TimeInterval - 时间间隔（包含data属性）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_intervals</span>.<span class="title function_">addInterval</span>(interval)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 动画示例</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 位置动画（关键帧）</span></span><br><span class="line"><span class="keyword">const</span> positionProperty = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">SampledPositionProperty</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加关键帧</span></span><br><span class="line"><span class="keyword">const</span> start = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">now</span>()</span><br><span class="line"><span class="keyword">const</span> stop = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addSeconds</span>(start, <span class="number">60</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>())</span><br><span class="line"></span><br><span class="line">positionProperty.<span class="title function_">addSample</span>(start, <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">0</span>))</span><br><span class="line">positionProperty.<span class="title function_">addSample</span>(</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addSeconds</span>(start, <span class="number">30</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>()),</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.5</span>, <span class="number">39.95</span>, <span class="number">1000</span>),</span><br><span class="line">)</span><br><span class="line">positionProperty.<span class="title function_">addSample</span>(stop, <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.6</span>, <span class="number">40.0</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置插值方式</span></span><br><span class="line">positionProperty.<span class="title function_">setInterpolationOptions</span>(&#123;</span><br><span class="line">  <span class="attr">interpolationDegree</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">interpolationAlgorithm</span>: <span class="title class_">Cesium</span>.<span class="property">HermitePolynomialApproximation</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建移动实体</span></span><br><span class="line"><span class="keyword">const</span> movingEntity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: positionProperty,</span><br><span class="line">  <span class="attr">model</span>: &#123;</span><br><span class="line">    <span class="attr">uri</span>: <span class="string">&#x27;./models/airplane.gltf&#x27;</span>,</span><br><span class="line">    <span class="attr">scale</span>: <span class="number">2.0</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">path</span>: &#123;</span><br><span class="line">    <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">leadTime</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="attr">trailTime</span>: <span class="number">60</span>,</span><br><span class="line">    <span class="attr">width</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">material</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">CYAN</span>,</span><br><span class="line">    <span class="attr">resolution</span>: <span class="number">1</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 旋转动画（程序化）</span></span><br><span class="line"><span class="keyword">const</span> rotationProperty = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">CallbackProperty</span>(<span class="function">(<span class="params">time</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> seconds = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">secondsDifference</span>(time, start)</span><br><span class="line">  <span class="keyword">const</span> angle = (seconds * <span class="title class_">Math</span>.<span class="property">PI</span>) / <span class="number">10</span> <span class="comment">// 每20秒转一圈</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Quaternion</span>.<span class="title function_">fromAxisAngle</span>(<span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="property">UNIT_Z</span>, angle)</span><br><span class="line">&#125;, <span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rotatingEntity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">100</span>),</span><br><span class="line">  <span class="attr">orientation</span>: rotationProperty,</span><br><span class="line">  <span class="attr">model</span>: &#123;</span><br><span class="line">    <span class="attr">uri</span>: <span class="string">&#x27;./models/building.gltf&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 颜色动画（关键帧）</span></span><br><span class="line"><span class="keyword">const</span> colorProperty = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">SampledProperty</span>(<span class="title class_">Cesium</span>.<span class="property">Color</span>)</span><br><span class="line"></span><br><span class="line">colorProperty.<span class="title function_">addSample</span>(start, <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span>)</span><br><span class="line">colorProperty.<span class="title function_">addSample</span>(</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addSeconds</span>(start, <span class="number">15</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>()),</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">GREEN</span>,</span><br><span class="line">)</span><br><span class="line">colorProperty.<span class="title function_">addSample</span>(</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addSeconds</span>(start, <span class="number">30</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>()),</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLUE</span>,</span><br><span class="line">)</span><br><span class="line">colorProperty.<span class="title function_">addSample</span>(</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addSeconds</span>(start, <span class="number">45</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>()),</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>,</span><br><span class="line">)</span><br><span class="line">colorProperty.<span class="title function_">addSample</span>(stop, <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> coloredEntity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">200</span>),</span><br><span class="line">  <span class="attr">box</span>: &#123;</span><br><span class="line">    <span class="attr">dimensions</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">100</span>, <span class="number">100</span>, <span class="number">100</span>),</span><br><span class="line">    <span class="attr">material</span>: colorProperty,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 复合动画（分段）</span></span><br><span class="line"><span class="keyword">const</span> compositePosition = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">CompositePositionProperty</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第一段：静止</span></span><br><span class="line">compositePosition.<span class="title function_">addInterval</span>(</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeInterval</span>(&#123;</span><br><span class="line">    <span class="attr">start</span>: start,</span><br><span class="line">    <span class="attr">stop</span>: <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addSeconds</span>(start, <span class="number">20</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>()),</span><br><span class="line">    <span class="attr">data</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ConstantPositionProperty</span>(<span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">0</span>)),</span><br><span class="line">  &#125;),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二段：移动</span></span><br><span class="line"><span class="keyword">const</span> movingInterval = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeInterval</span>(&#123;</span><br><span class="line">  <span class="attr">start</span>: <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addSeconds</span>(start, <span class="number">20</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>()),</span><br><span class="line">  <span class="attr">stop</span>: <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addSeconds</span>(start, <span class="number">40</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>()),</span><br><span class="line">  <span class="attr">data</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">SampledPositionProperty</span>(),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">movingInterval.<span class="property">data</span>.<span class="title function_">addSample</span>(</span><br><span class="line">  movingInterval.<span class="property">start</span>,</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">0</span>),</span><br><span class="line">)</span><br><span class="line">movingInterval.<span class="property">data</span>.<span class="title function_">addSample</span>(movingInterval.<span class="property">stop</span>, <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.5</span>, <span class="number">40.0</span>, <span class="number">1000</span>))</span><br><span class="line"></span><br><span class="line">compositePosition.<span class="title function_">addInterval</span>(movingInterval)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第三段：再次静止</span></span><br><span class="line">compositePosition.<span class="title function_">addInterval</span>(</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeInterval</span>(&#123;</span><br><span class="line">    <span class="attr">start</span>: <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addSeconds</span>(start, <span class="number">40</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>()),</span><br><span class="line">    <span class="attr">stop</span>: stop,</span><br><span class="line">    <span class="attr">data</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ConstantPositionProperty</span>(<span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.5</span>, <span class="number">40.0</span>, <span class="number">1000</span>)),</span><br><span class="line">  &#125;),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> compositeEntity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: compositePosition,</span><br><span class="line">  <span class="attr">point</span>: &#123;</span><br><span class="line">    <span class="attr">pixelSize</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">LIME</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. 时钟控制</span></span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">startTime</span> = start</span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">stopTime</span> = stop</span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">currentTime</span> = start</span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">clockRange</span> = <span class="title class_">Cesium</span>.<span class="property">ClockRange</span>.<span class="property">LOOP_STOP</span></span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">multiplier</span> = <span class="number">1</span></span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">shouldAnimate</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 时钟事件监听</span></span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">onTick</span>.<span class="title function_">addEventListener</span>(<span class="function">(<span class="params">clock</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;当前时间:&#x27;</span>, <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">toDate</span>(clock.<span class="property">currentTime</span>))</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">onStop</span>.<span class="title function_">addEventListener</span>(<span class="function">(<span class="params">clock</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;动画停止&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. 插值算法详解</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">InterpolationAlgorithm</span> = &#123;</span><br><span class="line">  <span class="comment">// 线性插值</span></span><br><span class="line">  <span class="attr">LINEAR</span>: <span class="title class_">Cesium</span>.<span class="property">LinearApproximation</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 拉格朗日插值</span></span><br><span class="line">  <span class="attr">LAGRANGE</span>: <span class="title class_">Cesium</span>.<span class="property">LagrangePolynomialApproximation</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 埃尔米特插值（平滑）</span></span><br><span class="line">  <span class="attr">HERMITE</span>: <span class="title class_">Cesium</span>.<span class="property">HermitePolynomialApproximation</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置不同的插值算法</span></span><br><span class="line">positionProperty.<span class="title function_">setInterpolationOptions</span>(&#123;</span><br><span class="line">  <span class="attr">interpolationDegree</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">interpolationAlgorithm</span>: <span class="title class_">Cesium</span>.<span class="property">LinearApproximation</span>, <span class="comment">// 线性插值，直线运动</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">positionProperty.<span class="title function_">setInterpolationOptions</span>(&#123;</span><br><span class="line">  <span class="attr">interpolationDegree</span>: <span class="number">3</span>,</span><br><span class="line">  <span class="attr">interpolationAlgorithm</span>: <span class="title class_">Cesium</span>.<span class="property">HermitePolynomialApproximation</span>, <span class="comment">// 平滑曲线运动</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 7. 外推（Extrapolation）</span></span><br><span class="line"><span class="keyword">const</span> extrapolationTypes = &#123;</span><br><span class="line">  <span class="attr">NONE</span>: <span class="title class_">Cesium</span>.<span class="property">ExtrapolationType</span>.<span class="property">NONE</span>, <span class="comment">// 无外推</span></span><br><span class="line">  <span class="attr">HOLD</span>: <span class="title class_">Cesium</span>.<span class="property">ExtrapolationType</span>.<span class="property">HOLD</span>, <span class="comment">// 保持最后值</span></span><br><span class="line">  <span class="attr">EXTRAPOLATE</span>: <span class="title class_">Cesium</span>.<span class="property">ExtrapolationType</span>.<span class="property">EXTRAPOLATE</span>, <span class="comment">// 继续外推</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">positionProperty.<span class="property">forwardExtrapolationType</span> = <span class="title class_">Cesium</span>.<span class="property">ExtrapolationType</span>.<span class="property">EXTRAPOLATE</span></span><br><span class="line">positionProperty.<span class="property">forwardExtrapolationDuration</span> = <span class="number">10</span> <span class="comment">// 外推10秒</span></span><br><span class="line"></span><br><span class="line">positionProperty.<span class="property">backwardExtrapolationType</span> = <span class="title class_">Cesium</span>.<span class="property">ExtrapolationType</span>.<span class="property">HOLD</span></span><br><span class="line">positionProperty.<span class="property">backwardExtrapolationDuration</span> = <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 8. 动画控制函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">playAnimation</span>(<span class="params"></span>) &#123;</span><br><span class="line">  viewer.<span class="property">clock</span>.<span class="property">shouldAnimate</span> = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">pauseAnimation</span>(<span class="params"></span>) &#123;</span><br><span class="line">  viewer.<span class="property">clock</span>.<span class="property">shouldAnimate</span> = <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">resetAnimation</span>(<span class="params"></span>) &#123;</span><br><span class="line">  viewer.<span class="property">clock</span>.<span class="property">currentTime</span> = viewer.<span class="property">clock</span>.<span class="property">startTime</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setAnimationSpeed</span>(<span class="params">multiplier</span>) &#123;</span><br><span class="line">  viewer.<span class="property">clock</span>.<span class="property">multiplier</span> = multiplier</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">reverseAnimation</span>(<span class="params"></span>) &#123;</span><br><span class="line">  viewer.<span class="property">clock</span>.<span class="property">multiplier</span> = -<span class="title class_">Math</span>.<span class="title function_">abs</span>(viewer.<span class="property">clock</span>.<span class="property">multiplier</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 9. 粒子系统动画（基于CallbackProperty）</span></span><br><span class="line"><span class="keyword">const</span> particlePositions = []</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">  particlePositions.<span class="title function_">push</span>(&#123;</span><br><span class="line">    <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(</span><br><span class="line">      <span class="number">116.4074</span> + (<span class="title class_">Math</span>.<span class="title function_">random</span>() - <span class="number">0.5</span>) * <span class="number">0.01</span>,</span><br><span class="line">      <span class="number">39.9042</span> + (<span class="title class_">Math</span>.<span class="title function_">random</span>() - <span class="number">0.5</span>) * <span class="number">0.01</span>,</span><br><span class="line">      <span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">1000</span>,</span><br><span class="line">    ),</span><br><span class="line">    <span class="attr">velocity</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(</span><br><span class="line">      (<span class="title class_">Math</span>.<span class="title function_">random</span>() - <span class="number">0.5</span>) * <span class="number">100</span>,</span><br><span class="line">      (<span class="title class_">Math</span>.<span class="title function_">random</span>() - <span class="number">0.5</span>) * <span class="number">100</span>,</span><br><span class="line">      (<span class="title class_">Math</span>.<span class="title function_">random</span>() - <span class="number">0.5</span>) * <span class="number">50</span>,</span><br><span class="line">    ),</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> particleProperty = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">CallbackProperty</span>(<span class="function">(<span class="params">time</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> seconds = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">secondsDifference</span>(time, start)</span><br><span class="line">  <span class="keyword">const</span> positions = []</span><br><span class="line"></span><br><span class="line">  particlePositions.<span class="title function_">forEach</span>(<span class="function">(<span class="params">particle</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> newPos = <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">add</span>(</span><br><span class="line">      particle.<span class="property">position</span>,</span><br><span class="line">      <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">multiplyByScalar</span>(particle.<span class="property">velocity</span>, seconds, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>()),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(),</span><br><span class="line">    )</span><br><span class="line">    positions.<span class="title function_">push</span>(newPos.<span class="property">x</span>, newPos.<span class="property">y</span>, newPos.<span class="property">z</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> positions</span><br><span class="line">&#125;, <span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 应用粒子动画到PointPrimitiveCollection</span></span><br></pre></td></tr></table></figure><h2 id="几何体系统详解"><a href="#几何体系统详解" class="headerlink" title="几何体系统详解"></a>几何体系统详解</h2><h3 id="Primitive-图元"><a href="#Primitive-图元" class="headerlink" title="Primitive 图元"></a>Primitive 图元</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Primitive - 图元基类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Primitive</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// geometryInstances: Array&lt;GeometryInstance&gt; | GeometryInstance</span></span><br><span class="line">    <span class="comment">// 作用: 几何实例数组</span></span><br><span class="line">    <span class="comment">// 用途: 定义图元的几何形状</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">geometryInstances</span> = options.<span class="property">geometryInstances</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// appearance: Appearance</span></span><br><span class="line">    <span class="comment">// 作用: 外观定义</span></span><br><span class="line">    <span class="comment">// 用途: 控制图元的渲染方式</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">appearance</span> = options.<span class="property">appearance</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// show: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// modelMatrix: Matrix4</span></span><br><span class="line">    <span class="comment">// 作用: 模型变换矩阵</span></span><br><span class="line">    <span class="comment">// 默认: Matrix4.IDENTITY</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">modelMatrix</span> = options.<span class="property">modelMatrix</span> || <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="property">IDENTITY</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// vertexCacheOptimize: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否优化顶点缓存</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vertexCacheOptimize</span> =</span><br><span class="line">      options.<span class="property">vertexCacheOptimize</span> !== <span class="literal">undefined</span> ? options.<span class="property">vertexCacheOptimize</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// interleave: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否交错顶点属性</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">interleave</span> = options.<span class="property">interleave</span> !== <span class="literal">undefined</span> ? options.<span class="property">interleave</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// compressVertices: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否压缩顶点</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">compressVertices</span> = options.<span class="property">compressVertices</span> !== <span class="literal">undefined</span> ? options.<span class="property">compressVertices</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// releaseGeometryInstances: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否在渲染后释放几何实例</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">releaseGeometryInstances</span> =</span><br><span class="line">      options.<span class="property">releaseGeometryInstances</span> !== <span class="literal">undefined</span> ? options.<span class="property">releaseGeometryInstances</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// allowPicking: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否允许拾取</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">allowPicking</span> = options.<span class="property">allowPicking</span> !== <span class="literal">undefined</span> ? options.<span class="property">allowPicking</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// cull: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否启用视锥剔除</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cull</span> = options.<span class="property">cull</span> !== <span class="literal">undefined</span> ? options.<span class="property">cull</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// asynchronous: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否异步创建</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">asynchronous</span> = options.<span class="property">asynchronous</span> !== <span class="literal">undefined</span> ? options.<span class="property">asynchronous</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// debugShowBoundingVolume: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示包围体（调试）</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">debugShowBoundingVolume</span> =</span><br><span class="line">      options.<span class="property">debugShowBoundingVolume</span> !== <span class="literal">undefined</span> ? options.<span class="property">debugShowBoundingVolume</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// shadows: ShadowMode</span></span><br><span class="line">    <span class="comment">// 作用: 阴影模式</span></span><br><span class="line">    <span class="comment">// 默认: ShadowMode.DISABLED</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadows</span> = options.<span class="property">shadows</span> || <span class="title class_">Cesium</span>.<span class="property">ShadowMode</span>.<span class="property">DISABLED</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// update - 更新图元</span></span><br><span class="line">  <span class="title function_">update</span>(<span class="params">frameState</span>) &#123;</span><br><span class="line">    <span class="comment">// frameState: FrameState - 帧状态</span></span><br><span class="line">    <span class="comment">// 返回: void</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// isDestroyed - 是否已销毁</span></span><br><span class="line">  <span class="title function_">isDestroyed</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// destroy - 销毁图元</span></span><br><span class="line">  <span class="title function_">destroy</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 清理资源</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getGeometryInstanceAttributes - 获取几何实例属性</span></span><br><span class="line">  <span class="title function_">getGeometryInstanceAttributes</span>(<span class="params">id</span>) &#123;</span><br><span class="line">    <span class="comment">// id: string - 实例ID</span></span><br><span class="line">    <span class="comment">// 返回: Object - 属性对象</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GeometryInstance - 几何实例</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GeometryInstance</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// geometry: Geometry</span></span><br><span class="line">    <span class="comment">// 作用: 几何体</span></span><br><span class="line">    <span class="comment">// 必需: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">geometry</span> = options.<span class="property">geometry</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// modelMatrix: Matrix4</span></span><br><span class="line">    <span class="comment">// 作用: 模型变换矩阵</span></span><br><span class="line">    <span class="comment">// 默认: Matrix4.IDENTITY</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">modelMatrix</span> = options.<span class="property">modelMatrix</span> || <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="property">IDENTITY</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// id: Object</span></span><br><span class="line">    <span class="comment">// 作用: 实例标识符</span></span><br><span class="line">    <span class="comment">// 用途: 拾取和属性更新</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = options.<span class="property">id</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// attributes: Object</span></span><br><span class="line">    <span class="comment">// 作用: 每实例属性</span></span><br><span class="line">    <span class="comment">// 用途: 颜色、显示状态等</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">attributes</span> = options.<span class="property">attributes</span> || &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基础几何体</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// BoxGeometry - 盒子几何体</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BoxGeometry</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// dimensions: Cartesian3</span></span><br><span class="line">    <span class="comment">// 作用: 盒子尺寸（长、宽、高）</span></span><br><span class="line">    <span class="comment">// 必需: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dimensions</span> = options.<span class="property">dimensions</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// vertexFormat: VertexFormat</span></span><br><span class="line">    <span class="comment">// 作用: 顶点格式</span></span><br><span class="line">    <span class="comment">// 默认: VertexFormat.DEFAULT</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vertexFormat</span> = options.<span class="property">vertexFormat</span> || <span class="title class_">Cesium</span>.<span class="property">VertexFormat</span>.<span class="property">DEFAULT</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 静态方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// createGeometry - 创建几何体</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createGeometry</span>(<span class="params">boxGeometry</span>) &#123;</span><br><span class="line">    <span class="comment">// 返回: Geometry | undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// packedLength - 打包长度</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">packedLength</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">4</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// pack - 打包</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">pack</span>(<span class="params">value, array, startingIndex = <span class="number">0</span></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// unpack - 解包</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">unpack</span>(<span class="params">array, startingIndex = <span class="number">0</span>, result</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SphereGeometry - 球体几何体</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SphereGeometry</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// radius: number</span></span><br><span class="line">    <span class="comment">// 作用: 球体半径</span></span><br><span class="line">    <span class="comment">// 默认: 1.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">radius</span> = options.<span class="property">radius</span> !== <span class="literal">undefined</span> ? options.<span class="property">radius</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// stackPartitions: number</span></span><br><span class="line">    <span class="comment">// 作用: 堆叠分区数（纬度方向）</span></span><br><span class="line">    <span class="comment">// 默认: 64</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">stackPartitions</span> = options.<span class="property">stackPartitions</span> !== <span class="literal">undefined</span> ? options.<span class="property">stackPartitions</span> : <span class="number">64</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// slicePartitions: number</span></span><br><span class="line">    <span class="comment">// 作用: 切片分区数（经度方向）</span></span><br><span class="line">    <span class="comment">// 默认: 64</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">slicePartitions</span> = options.<span class="property">slicePartitions</span> !== <span class="literal">undefined</span> ? options.<span class="property">slicePartitions</span> : <span class="number">64</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// vertexFormat: VertexFormat</span></span><br><span class="line">    <span class="comment">// 作用: 顶点格式</span></span><br><span class="line">    <span class="comment">// 默认: VertexFormat.DEFAULT</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vertexFormat</span> = options.<span class="property">vertexFormat</span> || <span class="title class_">Cesium</span>.<span class="property">VertexFormat</span>.<span class="property">DEFAULT</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CylinderGeometry - 圆柱体几何体</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CylinderGeometry</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// length: number</span></span><br><span class="line">    <span class="comment">// 作用: 圆柱体长度（高度）</span></span><br><span class="line">    <span class="comment">// 必需: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">length</span> = options.<span class="property">length</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// topRadius: number</span></span><br><span class="line">    <span class="comment">// 作用: 顶部半径</span></span><br><span class="line">    <span class="comment">// 必需: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">topRadius</span> = options.<span class="property">topRadius</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// bottomRadius: number</span></span><br><span class="line">    <span class="comment">// 作用: 底部半径</span></span><br><span class="line">    <span class="comment">// 必需: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">bottomRadius</span> = options.<span class="property">bottomRadius</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// slices: number</span></span><br><span class="line">    <span class="comment">// 作用: 切片数量</span></span><br><span class="line">    <span class="comment">// 默认: 128</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">slices</span> = options.<span class="property">slices</span> !== <span class="literal">undefined</span> ? options.<span class="property">slices</span> : <span class="number">128</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// vertexFormat: VertexFormat</span></span><br><span class="line">    <span class="comment">// 作用: 顶点格式</span></span><br><span class="line">    <span class="comment">// 默认: VertexFormat.DEFAULT</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vertexFormat</span> = options.<span class="property">vertexFormat</span> || <span class="title class_">Cesium</span>.<span class="property">VertexFormat</span>.<span class="property">DEFAULT</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PlaneGeometry - 平面几何体</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PlaneGeometry</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// vertexFormat: VertexFormat</span></span><br><span class="line">    <span class="comment">// 作用: 顶点格式</span></span><br><span class="line">    <span class="comment">// 默认: VertexFormat.DEFAULT</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vertexFormat</span> = options.<span class="property">vertexFormat</span> || <span class="title class_">Cesium</span>.<span class="property">VertexFormat</span>.<span class="property">DEFAULT</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// EllipsoidGeometry - 椭球体几何体</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EllipsoidGeometry</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// radii: Cartesian3</span></span><br><span class="line">    <span class="comment">// 作用: 椭球体半径（x, y, z）</span></span><br><span class="line">    <span class="comment">// 默认: Cartesian3(1, 1, 1)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">radii</span> = options.<span class="property">radii</span> || <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// innerRadii: Cartesian3</span></span><br><span class="line">    <span class="comment">// 作用: 内部半径（用于创建空心椭球）</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">innerRadii</span> = options.<span class="property">innerRadii</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// minimumClock: number</span></span><br><span class="line">    <span class="comment">// 作用: 最小时钟角（弧度）</span></span><br><span class="line">    <span class="comment">// 默认: 0.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">minimumClock</span> = options.<span class="property">minimumClock</span> !== <span class="literal">undefined</span> ? options.<span class="property">minimumClock</span> : <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// maximumClock: number</span></span><br><span class="line">    <span class="comment">// 作用: 最大时钟角（弧度）</span></span><br><span class="line">    <span class="comment">// 默认: 2π</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maximumClock</span> =</span><br><span class="line">      options.<span class="property">maximumClock</span> !== <span class="literal">undefined</span> ? options.<span class="property">maximumClock</span> : <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="property">TWO_PI</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// minimumCone: number</span></span><br><span class="line">    <span class="comment">// 作用: 最小锥角（弧度）</span></span><br><span class="line">    <span class="comment">// 默认: 0.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">minimumCone</span> = options.<span class="property">minimumCone</span> !== <span class="literal">undefined</span> ? options.<span class="property">minimumCone</span> : <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// maximumCone: number</span></span><br><span class="line">    <span class="comment">// 作用: 最大锥角（弧度）</span></span><br><span class="line">    <span class="comment">// 默认: π</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maximumCone</span> = options.<span class="property">maximumCone</span> !== <span class="literal">undefined</span> ? options.<span class="property">maximumCone</span> : <span class="title class_">Math</span>.<span class="property">PI</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// stackPartitions: number</span></span><br><span class="line">    <span class="comment">// 作用: 堆叠分区数</span></span><br><span class="line">    <span class="comment">// 默认: 64</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">stackPartitions</span> = options.<span class="property">stackPartitions</span> !== <span class="literal">undefined</span> ? options.<span class="property">stackPartitions</span> : <span class="number">64</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// slicePartitions: number</span></span><br><span class="line">    <span class="comment">// 作用: 切片分区数</span></span><br><span class="line">    <span class="comment">// 默认: 64</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">slicePartitions</span> = options.<span class="property">slicePartitions</span> !== <span class="literal">undefined</span> ? options.<span class="property">slicePartitions</span> : <span class="number">64</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// vertexFormat: VertexFormat</span></span><br><span class="line">    <span class="comment">// 作用: 顶点格式</span></span><br><span class="line">    <span class="comment">// 默认: VertexFormat.DEFAULT</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vertexFormat</span> = options.<span class="property">vertexFormat</span> || <span class="title class_">Cesium</span>.<span class="property">VertexFormat</span>.<span class="property">DEFAULT</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Appearance - 外观类</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// MaterialAppearance - 材质外观</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MaterialAppearance</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// material: Material</span></span><br><span class="line">    <span class="comment">// 作用: 材质</span></span><br><span class="line">    <span class="comment">// 默认: Material.ColorType</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">material</span> = options.<span class="property">material</span> || <span class="title class_">Cesium</span>.<span class="property">Material</span>.<span class="title function_">fromType</span>(<span class="title class_">Cesium</span>.<span class="property">Material</span>.<span class="property">ColorType</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// translucent: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否透明</span></span><br><span class="line">    <span class="comment">// 默认: 根据材质确定</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">translucent</span> = options.<span class="property">translucent</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// vertexShaderSource: string</span></span><br><span class="line">    <span class="comment">// 作用: 顶点着色器源码</span></span><br><span class="line">    <span class="comment">// 默认: 使用内置着色器</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vertexShaderSource</span> = options.<span class="property">vertexShaderSource</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// fragmentShaderSource: string</span></span><br><span class="line">    <span class="comment">// 作用: 片段着色器源码</span></span><br><span class="line">    <span class="comment">// 默认: 使用内置着色器</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fragmentShaderSource</span> = options.<span class="property">fragmentShaderSource</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// renderState: RenderState</span></span><br><span class="line">    <span class="comment">// 作用: 渲染状态</span></span><br><span class="line">    <span class="comment">// 默认: 默认渲染状态</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">renderState</span> = options.<span class="property">renderState</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// closed: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 几何体是否封闭</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">closed</span> = options.<span class="property">closed</span> !== <span class="literal">undefined</span> ? options.<span class="property">closed</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// vertexFormat: VertexFormat</span></span><br><span class="line">    <span class="comment">// 作用: 顶点格式</span></span><br><span class="line">    <span class="comment">// 默认: MaterialAppearance.vertexFormat</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vertexFormat</span> = options.<span class="property">vertexFormat</span> || <span class="title class_">MaterialAppearance</span>.<span class="property">vertexFormat</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// flat: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否使用平面着色</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">flat</span> = options.<span class="property">flat</span> !== <span class="literal">undefined</span> ? options.<span class="property">flat</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// faceForward: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否面向前方</span></span><br><span class="line">    <span class="comment">// 默认: !closed</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">faceForward</span> = options.<span class="property">faceForward</span> !== <span class="literal">undefined</span> ? options.<span class="property">faceForward</span> : !<span class="variable language_">this</span>.<span class="property">closed</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PerInstanceColorAppearance - 每实例颜色外观</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PerInstanceColorAppearance</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// flat: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否使用平面着色</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">flat</span> = options.<span class="property">flat</span> !== <span class="literal">undefined</span> ? options.<span class="property">flat</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// faceForward: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否面向前方</span></span><br><span class="line">    <span class="comment">// 默认: !closed</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">faceForward</span> = options.<span class="property">faceForward</span> !== <span class="literal">undefined</span> ? options.<span class="property">faceForward</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// translucent: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否透明</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">translucent</span> = options.<span class="property">translucent</span> !== <span class="literal">undefined</span> ? options.<span class="property">translucent</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// closed: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 几何体是否封闭</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">closed</span> = options.<span class="property">closed</span> !== <span class="literal">undefined</span> ? options.<span class="property">closed</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// vertexShaderSource: string</span></span><br><span class="line">    <span class="comment">// 作用: 顶点着色器源码</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vertexShaderSource</span> = options.<span class="property">vertexShaderSource</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// fragmentShaderSource: string</span></span><br><span class="line">    <span class="comment">// 作用: 片段着色器源码</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fragmentShaderSource</span> = options.<span class="property">fragmentShaderSource</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// renderState: RenderState</span></span><br><span class="line">    <span class="comment">// 作用: 渲染状态</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">renderState</span> = options.<span class="property">renderState</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 几何体使用示例</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 创建盒子图元</span></span><br><span class="line"><span class="keyword">const</span> boxInstances = []</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; <span class="number">10</span>; j++) &#123;</span><br><span class="line">    boxInstances.<span class="title function_">push</span>(</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">GeometryInstance</span>(&#123;</span><br><span class="line">        <span class="attr">geometry</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">BoxGeometry</span>(&#123;</span><br><span class="line">          <span class="attr">dimensions</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">1000</span>, <span class="number">1000</span>, <span class="number">1000</span>),</span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="attr">modelMatrix</span>: <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">multiplyByTranslation</span>(</span><br><span class="line">          <span class="title class_">Cesium</span>.<span class="property">Transforms</span>.<span class="title function_">eastNorthUpToFixedFrame</span>(</span><br><span class="line">            <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span> + i * <span class="number">0.01</span>, <span class="number">39.9042</span> + j * <span class="number">0.01</span>),</span><br><span class="line">          ),</span><br><span class="line">          <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">500</span>),</span><br><span class="line">          <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Matrix4</span>(),</span><br><span class="line">        ),</span><br><span class="line">        <span class="attr">id</span>: <span class="string">`box_<span class="subst">$&#123;i&#125;</span>_<span class="subst">$&#123;j&#125;</span>`</span>,</span><br><span class="line">        <span class="attr">attributes</span>: &#123;</span><br><span class="line">          <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">ColorGeometryInstanceAttribute</span>.<span class="title function_">fromColor</span>(</span><br><span class="line">            <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="title function_">fromRandom</span>(&#123; <span class="attr">alpha</span>: <span class="number">0.8</span> &#125;),</span><br><span class="line">          ),</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> boxPrimitive = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Primitive</span>(&#123;</span><br><span class="line">  <span class="attr">geometryInstances</span>: boxInstances,</span><br><span class="line">  <span class="attr">appearance</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PerInstanceColorAppearance</span>(&#123;</span><br><span class="line">    <span class="attr">translucent</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">closed</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">primitives</span>.<span class="title function_">add</span>(boxPrimitive)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 创建球体图元</span></span><br><span class="line"><span class="keyword">const</span> sphereInstance = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">GeometryInstance</span>(&#123;</span><br><span class="line">  <span class="attr">geometry</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">SphereGeometry</span>(&#123;</span><br><span class="line">    <span class="attr">radius</span>: <span class="number">500.0</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="attr">modelMatrix</span>: <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">multiplyByTranslation</span>(</span><br><span class="line">    <span class="title class_">Cesium</span>.<span class="property">Transforms</span>.<span class="title function_">eastNorthUpToFixedFrame</span>(<span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>)),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1000</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Matrix4</span>(),</span><br><span class="line">  ),</span><br><span class="line">  <span class="attr">attributes</span>: &#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">ColorGeometryInstanceAttribute</span>.<span class="title function_">fromColor</span>(<span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">AQUA</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> spherePrimitive = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Primitive</span>(&#123;</span><br><span class="line">  <span class="attr">geometryInstances</span>: sphereInstance,</span><br><span class="line">  <span class="attr">appearance</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PerInstanceColorAppearance</span>(),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">primitives</span>.<span class="title function_">add</span>(spherePrimitive)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 材质外观图元</span></span><br><span class="line"><span class="keyword">const</span> planePrimitive = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Primitive</span>(&#123;</span><br><span class="line">  <span class="attr">geometryInstances</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">GeometryInstance</span>(&#123;</span><br><span class="line">    <span class="attr">geometry</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PlaneGeometry</span>(&#123;</span><br><span class="line">      <span class="attr">vertexFormat</span>: <span class="title class_">Cesium</span>.<span class="property">MaterialAppearance</span>.<span class="property">vertexFormat</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="attr">modelMatrix</span>: <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">multiplyByScale</span>(</span><br><span class="line">      <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">multiplyByTranslation</span>(</span><br><span class="line">        <span class="title class_">Cesium</span>.<span class="property">Transforms</span>.<span class="title function_">eastNorthUpToFixedFrame</span>(<span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>)),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">2000</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Matrix4</span>(),</span><br><span class="line">      ),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">1000</span>, <span class="number">1000</span>, <span class="number">1</span>),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Matrix4</span>(),</span><br><span class="line">    ),</span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="attr">appearance</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">MaterialAppearance</span>(&#123;</span><br><span class="line">    <span class="attr">material</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Material</span>(&#123;</span><br><span class="line">      <span class="attr">fabric</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;Image&#x27;</span>,</span><br><span class="line">        <span class="attr">uniforms</span>: &#123;</span><br><span class="line">          <span class="attr">image</span>: <span class="string">&#x27;path/to/texture.jpg&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">primitives</span>.<span class="title function_">add</span>(planePrimitive)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 动态修改属性</span></span><br><span class="line"><span class="keyword">const</span> attributes = boxPrimitive.<span class="title function_">getGeometryInstanceAttributes</span>(<span class="string">&#x27;box_0_0&#x27;</span>)</span><br><span class="line">attributes.<span class="property">color</span> = <span class="title class_">Cesium</span>.<span class="property">ColorGeometryInstanceAttribute</span>.<span class="title function_">toValue</span>(<span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. 分类图元（贴地）</span></span><br><span class="line"><span class="keyword">const</span> classifiedPrimitive = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ClassificationPrimitive</span>(&#123;</span><br><span class="line">  <span class="attr">geometryInstances</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">GeometryInstance</span>(&#123;</span><br><span class="line">    <span class="attr">geometry</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PolygonGeometry</span>(&#123;</span><br><span class="line">      <span class="attr">polygonHierarchy</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PolygonHierarchy</span>(</span><br><span class="line">        <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegreesArray</span>([<span class="number">116.4</span>, <span class="number">39.9</span>, <span class="number">116.5</span>, <span class="number">39.9</span>, <span class="number">116.5</span>, <span class="number">40.0</span>, <span class="number">116.4</span>, <span class="number">40.0</span>]),</span><br><span class="line">      ),</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="attr">attributes</span>: &#123;</span><br><span class="line">      <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">ColorGeometryInstanceAttribute</span>.<span class="title function_">fromColor</span>(<span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span>.<span class="title function_">withAlpha</span>(<span class="number">0.5</span>)),</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="attr">appearance</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PerInstanceColorAppearance</span>(&#123;</span><br><span class="line">    <span class="attr">translucent</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">primitives</span>.<span class="title function_">add</span>(classifiedPrimitive)</span><br></pre></td></tr></table></figure><h2 id="场景控制详解"><a href="#场景控制详解" class="headerlink" title="场景控制详解"></a>场景控制详解</h2><h3 id="Scene-场景类"><a href="#Scene-场景类" class="headerlink" title="Scene 场景类"></a>Scene 场景类</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Scene - 场景类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Scene</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">canvas, contextOptions, creditContainer</span>) &#123;</span><br><span class="line">    <span class="comment">// canvas: HTMLCanvasElement</span></span><br><span class="line">    <span class="comment">// 作用: 渲染画布</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span> = canvas</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 渲染控制属性 ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// backgroundColor: Color</span></span><br><span class="line">    <span class="comment">// 作用: 背景颜色</span></span><br><span class="line">    <span class="comment">// 默认: Color.BLACK</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">backgroundColor</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// fog: Fog</span></span><br><span class="line">    <span class="comment">// 作用: 雾效</span></span><br><span class="line">    <span class="comment">// 默认: new Fog()</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fog</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Fog</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// skyBox: SkyBox</span></span><br><span class="line">    <span class="comment">// 作用: 天空盒</span></span><br><span class="line">    <span class="comment">// 默认: undefined（使用默认天空）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">skyBox</span> = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// skyAtmosphere: SkyAtmosphere</span></span><br><span class="line">    <span class="comment">// 作用: 大气散射</span></span><br><span class="line">    <span class="comment">// 默认: new SkyAtmosphere()</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">skyAtmosphere</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">SkyAtmosphere</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sun: Sun</span></span><br><span class="line">    <span class="comment">// 作用: 太阳</span></span><br><span class="line">    <span class="comment">// 默认: new Sun()</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sun</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Sun</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// moon: Moon</span></span><br><span class="line">    <span class="comment">// 作用: 月亮</span></span><br><span class="line">    <span class="comment">// 默认: new Moon()</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">moon</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Moon</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sunBloom: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 太阳光晕效果</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sunBloom</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 地球相关属性 ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// globe: Globe</span></span><br><span class="line">    <span class="comment">// 作用: 地球对象</span></span><br><span class="line">    <span class="comment">// 默认: new Globe(Ellipsoid.WGS84)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">globe</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Globe</span>(<span class="title class_">Cesium</span>.<span class="property">Ellipsoid</span>.<span class="property">WGS84</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 渲染性能属性 ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// requestRenderMode: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 按需渲染模式</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">requestRenderMode</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// maximumRenderTimeChange: number</span></span><br><span class="line">    <span class="comment">// 作用: 最大渲染时间变化</span></span><br><span class="line">    <span class="comment">// 默认: 0.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maximumRenderTimeChange</span> = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// debugShowFramesPerSecond: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 显示FPS调试信息</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">debugShowFramesPerSecond</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// debugCommandFilter: function</span></span><br><span class="line">    <span class="comment">// 作用: 调试命令过滤器</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">debugCommandFilter</span> = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 拾取相关属性 ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// pickTranslucentDepth: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 拾取透明物体深度</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pickTranslucentDepth</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 后处理效果 ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// postProcessStages: PostProcessStageCollection</span></span><br><span class="line">    <span class="comment">// 作用: 后处理阶段集合</span></span><br><span class="line">    <span class="comment">// 默认: new PostProcessStageCollection()</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">postProcessStages</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PostProcessStageCollection</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 光照属性 ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// light: Light</span></span><br><span class="line">    <span class="comment">// 作用: 场景光源</span></span><br><span class="line">    <span class="comment">// 默认: new SunLight()</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">light</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">SunLight</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// shadows: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否启用阴影</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadows</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// shadowMap: ShadowMap</span></span><br><span class="line">    <span class="comment">// 作用: 阴影贴图</span></span><br><span class="line">    <span class="comment">// 默认: new ShadowMap()</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadowMap</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ShadowMap</span>(&#123;</span><br><span class="line">      <span class="attr">context</span>: <span class="variable language_">this</span>.<span class="property">context</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 高动态范围渲染 ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// highDynamicRange: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否启用HDR</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">highDynamicRange</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// gamma: number</span></span><br><span class="line">    <span class="comment">// 作用: 伽马校正值</span></span><br><span class="line">    <span class="comment">// 默认: 1.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gamma</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 地下模式 ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// underground: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 地下模式</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">underground</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// undergroundColor: Color</span></span><br><span class="line">    <span class="comment">// 作用: 地下背景颜色</span></span><br><span class="line">    <span class="comment">// 默认: Color.BLACK</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">undergroundColor</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 地球透明度 ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// globeTranslucencyState: GlobeTranslucencyState</span></span><br><span class="line">    <span class="comment">// 作用: 地球透明度状态</span></span><br><span class="line">    <span class="comment">// 默认: &#123;&#125;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">globeTranslucencyState</span> = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 相机控制器 ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// screenSpaceCameraController: ScreenSpaceCameraController</span></span><br><span class="line">    <span class="comment">// 作用: 屏幕空间相机控制器</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">screenSpaceCameraController</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ScreenSpaceCameraController</span>(<span class="variable language_">this</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 图元集合 ===</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// primitives: PrimitiveCollection</span></span><br><span class="line">    <span class="comment">// 作用: 图元集合</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">primitives</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PrimitiveCollection</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// groundPrimitives: PrimitiveCollection</span></span><br><span class="line">    <span class="comment">// 作用: 地面图元集合</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">groundPrimitives</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PrimitiveCollection</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === 渲染方法 ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// render - 渲染场景</span></span><br><span class="line">  <span class="title function_">render</span>(<span class="params">time</span>) &#123;</span><br><span class="line">    <span class="comment">// time: JulianDate - 渲染时间</span></span><br><span class="line">    <span class="comment">// 返回: void</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// requestRender - 请求渲染</span></span><br><span class="line">  <span class="title function_">requestRender</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 在按需渲染模式下请求一次渲染</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === 拾取方法 ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// pick - 拾取对象</span></span><br><span class="line">  <span class="title function_">pick</span>(<span class="params">windowPosition</span>) &#123;</span><br><span class="line">    <span class="comment">// windowPosition: Cartesian2 - 屏幕坐标</span></span><br><span class="line">    <span class="comment">// 返回: Object | undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// drillPick - 钻取拾取（获取所有对象）</span></span><br><span class="line">  <span class="title function_">drillPick</span>(<span class="params">windowPosition, limit</span>) &#123;</span><br><span class="line">    <span class="comment">// windowPosition: Cartesian2 - 屏幕坐标</span></span><br><span class="line">    <span class="comment">// limit: number - 最大数量限制</span></span><br><span class="line">    <span class="comment">// 返回: Array&lt;Object&gt;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// pickPosition - 拾取位置</span></span><br><span class="line">  <span class="title function_">pickPosition</span>(<span class="params">windowPosition, result</span>) &#123;</span><br><span class="line">    <span class="comment">// windowPosition: Cartesian2 - 屏幕坐标</span></span><br><span class="line">    <span class="comment">// result: Cartesian3 - 结果对象</span></span><br><span class="line">    <span class="comment">// 返回: Cartesian3 | undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sampleHeight - 采样高度</span></span><br><span class="line">  <span class="title function_">sampleHeight</span>(<span class="params">position, objectsToExclude, width</span>) &#123;</span><br><span class="line">    <span class="comment">// position: Cartesian3 - 世界坐标</span></span><br><span class="line">    <span class="comment">// objectsToExclude: Array - 排除的对象</span></span><br><span class="line">    <span class="comment">// width: number - 采样宽度</span></span><br><span class="line">    <span class="comment">// 返回: number | undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// clampToHeight - 贴合到高度</span></span><br><span class="line">  <span class="title function_">clampToHeight</span>(<span class="params">cartesian, objectsToExclude, width, result</span>) &#123;</span><br><span class="line">    <span class="comment">// cartesian: Cartesian3 - 世界坐标</span></span><br><span class="line">    <span class="comment">// objectsToExclude: Array - 排除的对象</span></span><br><span class="line">    <span class="comment">// width: number - 采样宽度</span></span><br><span class="line">    <span class="comment">// result: Cartesian3 - 结果对象</span></span><br><span class="line">    <span class="comment">// 返回: Cartesian3 | undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === 相机方法 ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// cartesianToCanvasCoordinates - 笛卡尔坐标转画布坐标</span></span><br><span class="line">  <span class="title function_">cartesianToCanvasCoordinates</span>(<span class="params">position, result</span>) &#123;</span><br><span class="line">    <span class="comment">// position: Cartesian3 - 世界坐标</span></span><br><span class="line">    <span class="comment">// result: Cartesian2 - 结果对象</span></span><br><span class="line">    <span class="comment">// 返回: Cartesian2 | undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === 事件 ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// preUpdate: Event</span></span><br><span class="line">  <span class="comment">// 作用: 更新前事件</span></span><br><span class="line">  preUpdate = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// postUpdate: Event</span></span><br><span class="line">  <span class="comment">// 作用: 更新后事件</span></span><br><span class="line">  postUpdate = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// preRender: Event</span></span><br><span class="line">  <span class="comment">// 作用: 渲染前事件</span></span><br><span class="line">  preRender = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// postRender: Event</span></span><br><span class="line">  <span class="comment">// 作用: 渲染后事件</span></span><br><span class="line">  postRender = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// morphStart: Event</span></span><br><span class="line">  <span class="comment">// 作用: 变形开始事件</span></span><br><span class="line">  morphStart = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// morphComplete: Event</span></span><br><span class="line">  <span class="comment">// 作用: 变形完成事件</span></span><br><span class="line">  morphComplete = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// terrainProviderChanged: Event</span></span><br><span class="line">  <span class="comment">// 作用: 地形提供者变化事件</span></span><br><span class="line">  terrainProviderChanged = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Globe - 地球类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Globe</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">ellipsoid</span>) &#123;</span><br><span class="line">    <span class="comment">// ellipsoid: Ellipsoid</span></span><br><span class="line">    <span class="comment">// 作用: 椭球体</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ellipsoid</span> = ellipsoid || <span class="title class_">Cesium</span>.<span class="property">Ellipsoid</span>.<span class="property">WGS84</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// show: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示地球</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// maximumScreenSpaceError: number</span></span><br><span class="line">    <span class="comment">// 作用: 最大屏幕空间误差</span></span><br><span class="line">    <span class="comment">// 默认: 2</span></span><br><span class="line">    <span class="comment">// 性能影响: 值越小质量越高，性能越低</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maximumScreenSpaceError</span> = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// tileCacheSize: number</span></span><br><span class="line">    <span class="comment">// 作用: 瓦片缓存大小</span></span><br><span class="line">    <span class="comment">// 默认: 100</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tileCacheSize</span> = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// loadingDescendantLimit: number</span></span><br><span class="line">    <span class="comment">// 作用: 加载后代限制</span></span><br><span class="line">    <span class="comment">// 默认: 20</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loadingDescendantLimit</span> = <span class="number">20</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// preloadAncestors: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否预加载祖先瓦片</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">preloadAncestors</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// preloadSiblings: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否预加载兄弟瓦片</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">preloadSiblings</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// enableLighting: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否启用光照</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">enableLighting</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// lightingFadeOutDistance: number</span></span><br><span class="line">    <span class="comment">// 作用: 光照淡出距离</span></span><br><span class="line">    <span class="comment">// 默认: 6500000.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lightingFadeOutDistance</span> = <span class="number">6500000.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// lightingFadeInDistance: number</span></span><br><span class="line">    <span class="comment">// 作用: 光照淡入距离</span></span><br><span class="line">    <span class="comment">// 默认: 9000000.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lightingFadeInDistance</span> = <span class="number">9000000.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// showWaterEffect: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示水体效果</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">showWaterEffect</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// shadows: ShadowMode</span></span><br><span class="line">    <span class="comment">// 作用: 阴影模式</span></span><br><span class="line">    <span class="comment">// 默认: ShadowMode.RECEIVE_ONLY</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadows</span> = <span class="title class_">Cesium</span>.<span class="property">ShadowMode</span>.<span class="property">RECEIVE_ONLY</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// atmosphereLightIntensity: number</span></span><br><span class="line">    <span class="comment">// 作用: 大气光照强度</span></span><br><span class="line">    <span class="comment">// 默认: 10.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">atmosphereLightIntensity</span> = <span class="number">10.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// atmosphereRayleighCoefficient: Cartesian3</span></span><br><span class="line">    <span class="comment">// 作用: 瑞利散射系数</span></span><br><span class="line">    <span class="comment">// 默认: Cartesian3(5.5e-6, 13.0e-6, 28.4e-6)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">atmosphereRayleighCoefficient</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">5.5e-6</span>, <span class="number">13.0e-6</span>, <span class="number">28.4e-6</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// atmosphereMieCoefficient: Cartesian3</span></span><br><span class="line">    <span class="comment">// 作用: 米氏散射系数</span></span><br><span class="line">    <span class="comment">// 默认: Cartesian3(21e-6, 21e-6, 21e-6)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">atmosphereMieCoefficient</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">21e-6</span>, <span class="number">21e-6</span>, <span class="number">21e-6</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// atmosphereRayleighScaleHeight: number</span></span><br><span class="line">    <span class="comment">// 作用: 瑞利散射高度</span></span><br><span class="line">    <span class="comment">// 默认: 8000.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">atmosphereRayleighScaleHeight</span> = <span class="number">8000.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// atmosphereMieScaleHeight: number</span></span><br><span class="line">    <span class="comment">// 作用: 米氏散射高度</span></span><br><span class="line">    <span class="comment">// 默认: 1200.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">atmosphereMieScaleHeight</span> = <span class="number">1200.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// atmosphereMieAnisotropy: number</span></span><br><span class="line">    <span class="comment">// 作用: 米氏散射各向异性</span></span><br><span class="line">    <span class="comment">// 默认: 0.9</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">atmosphereMieAnisotropy</span> = <span class="number">0.9</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// baseColor: Color</span></span><br><span class="line">    <span class="comment">// 作用: 基础颜色</span></span><br><span class="line">    <span class="comment">// 默认: Color.BLUE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">baseColor</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLUE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// clippingPlanes: ClippingPlaneCollection</span></span><br><span class="line">    <span class="comment">// 作用: 裁剪平面集合</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clippingPlanes</span> = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// cartographicLimitRectangle: Rectangle</span></span><br><span class="line">    <span class="comment">// 作用: 地理限制矩形</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cartographicLimitRectangle</span> = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// backFaceCulling: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 背面剔除</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">backFaceCulling</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// showSkirts: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示裙边</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">showSkirts</span> = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// getHeight - 获取高度</span></span><br><span class="line">  <span class="title function_">getHeight</span>(<span class="params">cartographic</span>) &#123;</span><br><span class="line">    <span class="comment">// cartographic: Cartographic - 地理坐标</span></span><br><span class="line">    <span class="comment">// 返回: number | undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// pick - 拾取地球表面</span></span><br><span class="line">  <span class="title function_">pick</span>(<span class="params">ray, scene, result</span>) &#123;</span><br><span class="line">    <span class="comment">// ray: Ray - 射线</span></span><br><span class="line">    <span class="comment">// scene: Scene - 场景</span></span><br><span class="line">    <span class="comment">// result: Cartesian3 - 结果对象</span></span><br><span class="line">    <span class="comment">// 返回: Cartesian3 | undefined</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 场景使用示例</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 基础场景配置</span></span><br><span class="line"><span class="keyword">const</span> scene = viewer.<span class="property">scene</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置背景色</span></span><br><span class="line">scene.<span class="property">backgroundColor</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">DARKSLATEGRAY</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 开启阴影</span></span><br><span class="line">scene.<span class="property">shadows</span> = <span class="literal">true</span></span><br><span class="line">scene.<span class="property">shadowMap</span>.<span class="property">maximumDistance</span> = <span class="number">10000.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 开启雾效</span></span><br><span class="line">scene.<span class="property">fog</span>.<span class="property">enabled</span> = <span class="literal">true</span></span><br><span class="line">scene.<span class="property">fog</span>.<span class="property">density</span> = <span class="number">0.0001</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 地球配置</span></span><br><span class="line"><span class="keyword">const</span> globe = scene.<span class="property">globe</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 地形细节级别</span></span><br><span class="line">globe.<span class="property">maximumScreenSpaceError</span> = <span class="number">1</span> <span class="comment">// 更高质量</span></span><br><span class="line">globe.<span class="property">tileCacheSize</span> = <span class="number">200</span> <span class="comment">// 更大缓存</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 开启地球光照</span></span><br><span class="line">globe.<span class="property">enableLighting</span> = <span class="literal">true</span></span><br><span class="line">globe.<span class="property">atmosphereLightIntensity</span> = <span class="number">15.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 水体效果</span></span><br><span class="line">globe.<span class="property">showWaterEffect</span> = <span class="literal">true</span></span><br><span class="line">globe.<span class="property">baseColor</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">NAVY</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 后处理效果</span></span><br><span class="line"><span class="keyword">const</span> postProcess = scene.<span class="property">postProcessStages</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加FXAA抗锯齿</span></span><br><span class="line"><span class="keyword">const</span> fxaa = <span class="title class_">Cesium</span>.<span class="property">PostProcessStageLibrary</span>.<span class="title function_">createFXAAStage</span>()</span><br><span class="line">postProcess.<span class="title function_">add</span>(fxaa)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加轮廓线效果</span></span><br><span class="line"><span class="keyword">const</span> silhouette = <span class="title class_">Cesium</span>.<span class="property">PostProcessStageLibrary</span>.<span class="title function_">createSilhouetteStage</span>()</span><br><span class="line">postProcess.<span class="title function_">add</span>(silhouette)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义后处理效果</span></span><br><span class="line"><span class="keyword">const</span> customStage = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PostProcessStage</span>(&#123;</span><br><span class="line">  <span class="attr">fragmentShader</span>: <span class="string">`</span></span><br><span class="line"><span class="string">    uniform sampler2D colorTexture;</span></span><br><span class="line"><span class="string">    in vec2 v_textureCoordinates;</span></span><br><span class="line"><span class="string">    out vec4 fragColor;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    void main() &#123;</span></span><br><span class="line"><span class="string">      vec4 color = texture(colorTexture, v_textureCoordinates);</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">      // 简单的灰度效果</span></span><br><span class="line"><span class="string">      float gray = dot(color.rgb, vec3(0.299, 0.587, 0.114));</span></span><br><span class="line"><span class="string">      fragColor = vec4(gray, gray, gray, color.a);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  <span class="attr">uniforms</span>: &#123;&#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">postProcess.<span class="title function_">add</span>(customStage)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 事件监听</span></span><br><span class="line">scene.<span class="property">preRender</span>.<span class="title function_">addEventListener</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 渲染前的自定义逻辑</span></span><br><span class="line">  customStage.<span class="property">enabled</span> = viewer.<span class="property">clock</span>.<span class="property">currentTime</span>.<span class="property">secondsOfDay</span> &gt; <span class="number">43200</span> <span class="comment">// 下午启用灰度效果</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">scene.<span class="property">postRender</span>.<span class="title function_">addEventListener</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 渲染后的统计信息</span></span><br><span class="line">  <span class="keyword">if</span> (scene.<span class="property">debugShowFramesPerSecond</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;FPS:&#x27;</span>, scene.<span class="property">debugShowFramesPerSecond</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. 拾取增强</span></span><br><span class="line">scene.<span class="property">pickTranslucentDepth</span> = <span class="literal">true</span> <span class="comment">// 拾取透明物体</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义拾取处理</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">enhancedPick</span>(<span class="params">windowPosition</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> picked = scene.<span class="title function_">pick</span>(windowPosition)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Cesium</span>.<span class="title function_">defined</span>(picked)) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;拾取到对象:&#x27;</span>, picked.<span class="property">id</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取精确位置</span></span><br><span class="line">    <span class="keyword">const</span> position = scene.<span class="title function_">pickPosition</span>(windowPosition)</span><br><span class="line">    <span class="keyword">if</span> (position) &#123;</span><br><span class="line">      <span class="keyword">const</span> cartographic = <span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromCartesian</span>(position)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;精确位置:&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">longitude</span>: <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(cartographic.<span class="property">longitude</span>),</span><br><span class="line">        <span class="attr">latitude</span>: <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(cartographic.<span class="property">latitude</span>),</span><br><span class="line">        <span class="attr">height</span>: cartographic.<span class="property">height</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 钻取拾取（获取所有层级的对象）</span></span><br><span class="line">    <span class="keyword">const</span> allPicked = scene.<span class="title function_">drillPick</span>(windowPosition, <span class="number">10</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;所有拾取对象:&#x27;</span>, allPicked)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. 性能优化配置</span></span><br><span class="line"><span class="comment">// 按需渲染</span></span><br><span class="line">scene.<span class="property">requestRenderMode</span> = <span class="literal">true</span></span><br><span class="line">scene.<span class="property">maximumRenderTimeChange</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 手动请求渲染</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">requestRenderIfNeeded</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (scene.<span class="property">requestRenderMode</span> &amp;&amp; needsUpdate) &#123;</span><br><span class="line">    scene.<span class="title function_">requestRender</span>()</span><br><span class="line">    needsUpdate = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 7. 调试配置</span></span><br><span class="line">scene.<span class="property">debugShowFramesPerSecond</span> = <span class="literal">true</span></span><br><span class="line">scene.<span class="property">debugCommandFilter</span> = <span class="function">(<span class="params">command</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 过滤调试命令</span></span><br><span class="line">  <span class="keyword">return</span> command.<span class="property">pass</span> === <span class="title class_">Cesium</span>.<span class="property">Pass</span>.<span class="property">OPAQUE</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 8. HDR和色调映射</span></span><br><span class="line">scene.<span class="property">highDynamicRange</span> = <span class="literal">true</span></span><br><span class="line">scene.<span class="property">gamma</span> = <span class="number">2.2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 9. 地下模式</span></span><br><span class="line">scene.<span class="property">underground</span> = <span class="literal">true</span></span><br><span class="line">scene.<span class="property">undergroundColor</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>.<span class="title function_">withAlpha</span>(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 10. 全球透明度</span></span><br><span class="line">scene.<span class="property">globe</span>.<span class="property">translucency</span>.<span class="property">enabled</span> = <span class="literal">true</span></span><br><span class="line">scene.<span class="property">globe</span>.<span class="property">translucency</span>.<span class="property">frontFaceAlpha</span> = <span class="number">0.5</span></span><br><span class="line">scene.<span class="property">globe</span>.<span class="property">translucency</span>.<span class="property">backFaceAlpha</span> = <span class="number">0.1</span></span><br></pre></td></tr></table></figure><h2 id="数据源详解"><a href="#数据源详解" class="headerlink" title="数据源详解"></a>数据源详解</h2><h3 id="DataSource-数据源"><a href="#DataSource-数据源" class="headerlink" title="DataSource 数据源"></a>DataSource 数据源</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DataSource - 数据源基类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataSource</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="comment">// name: string</span></span><br><span class="line">    <span class="comment">// 作用: 数据源名称</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name</span><br><span class="line"></span><br><span class="line">    <span class="comment">// show: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// entities: EntityCollection</span></span><br><span class="line">    <span class="comment">// 作用: 实体集合</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">entities</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">EntityCollection</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// isLoading: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否正在加载</span></span><br><span class="line">    <span class="comment">// 只读: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// changedEvent: Event</span></span><br><span class="line">    <span class="comment">// 作用: 变化事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">changedEvent</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// errorEvent: Event</span></span><br><span class="line">    <span class="comment">// 作用: 错误事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">errorEvent</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// loadingEvent: Event</span></span><br><span class="line">    <span class="comment">// 作用: 加载事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loadingEvent</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clock: DataSourceClock</span></span><br><span class="line">    <span class="comment">// 作用: 数据源时钟</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clock</span> = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// clustering: EntityCluster</span></span><br><span class="line">    <span class="comment">// 作用: 实体聚类</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clustering</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">EntityCluster</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// update - 更新数据源</span></span><br><span class="line">  <span class="title function_">update</span>(<span class="params">time</span>) &#123;</span><br><span class="line">    <span class="comment">// time: JulianDate - 当前时间</span></span><br><span class="line">    <span class="comment">// 返回: boolean - 是否需要渲染</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CzmlDataSource - CZML数据源</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CzmlDataSource</span> <span class="keyword">extends</span> <span class="title class_ inherited__">DataSource</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(name)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 静态方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// load - 加载CZML数据</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">load</span>(<span class="params">czml, options</span>) &#123;</span><br><span class="line">    <span class="comment">// czml: Object | string | Resource</span></span><br><span class="line">    <span class="comment">// 作用: CZML数据</span></span><br><span class="line">    <span class="comment">// options: Object</span></span><br><span class="line">    <span class="comment">// sourceUri: string - 源URI</span></span><br><span class="line">    <span class="comment">// credit: Credit - 版权信息</span></span><br><span class="line">    <span class="comment">// 返回: Promise&lt;CzmlDataSource&gt;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// process - 处理CZML数据</span></span><br><span class="line">  <span class="title function_">process</span>(<span class="params">czml, options</span>) &#123;</span><br><span class="line">    <span class="comment">// czml: Object | string</span></span><br><span class="line">    <span class="comment">// 作用: CZML数据</span></span><br><span class="line">    <span class="comment">// options: Object</span></span><br><span class="line">    <span class="comment">// sourceUri: string - 源URI</span></span><br><span class="line">    <span class="comment">// isUpdating: boolean - 是否更新模式</span></span><br><span class="line">    <span class="comment">// 返回: Promise&lt;CzmlDataSource&gt;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GeoJsonDataSource - GeoJSON数据源</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GeoJsonDataSource</span> <span class="keyword">extends</span> <span class="title class_ inherited__">DataSource</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(name)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// markerSize: number</span></span><br><span class="line">    <span class="comment">// 作用: 标记大小</span></span><br><span class="line">    <span class="comment">// 默认: 48</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">markerSize</span> = <span class="number">48</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// markerSymbol: string</span></span><br><span class="line">    <span class="comment">// 作用: 标记符号</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">markerSymbol</span> = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// markerColor: Color</span></span><br><span class="line">    <span class="comment">// 作用: 标记颜色</span></span><br><span class="line">    <span class="comment">// 默认: Color.ROYALBLUE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">markerColor</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">ROYALBLUE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// stroke: Color</span></span><br><span class="line">    <span class="comment">// 作用: 描边颜色</span></span><br><span class="line">    <span class="comment">// 默认: Color.YELLOW</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">stroke</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// strokeWidth: number</span></span><br><span class="line">    <span class="comment">// 作用: 描边宽度</span></span><br><span class="line">    <span class="comment">// 默认: 2</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">strokeWidth</span> = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// fill: Color</span></span><br><span class="line">    <span class="comment">// 作用: 填充颜色</span></span><br><span class="line">    <span class="comment">// 默认: Color.YELLOW.withAlpha(0.5)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fill</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>.<span class="title function_">withAlpha</span>(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clampToGround: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否贴地</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clampToGround</span> = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 静态方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// load - 加载GeoJSON数据</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">load</span>(<span class="params">data, options</span>) &#123;</span><br><span class="line">    <span class="comment">// data: Resource | string | Object</span></span><br><span class="line">    <span class="comment">// 作用: GeoJSON数据</span></span><br><span class="line">    <span class="comment">// options: Object</span></span><br><span class="line">    <span class="comment">// sourceUri: string - 源URI</span></span><br><span class="line">    <span class="comment">// markerSize: number - 标记大小</span></span><br><span class="line">    <span class="comment">// markerSymbol: string - 标记符号</span></span><br><span class="line">    <span class="comment">// markerColor: Color - 标记颜色</span></span><br><span class="line">    <span class="comment">// stroke: Color - 描边颜色</span></span><br><span class="line">    <span class="comment">// strokeWidth: number - 描边宽度</span></span><br><span class="line">    <span class="comment">// fill: Color - 填充颜色</span></span><br><span class="line">    <span class="comment">// clampToGround: boolean - 是否贴地</span></span><br><span class="line">    <span class="comment">// credit: Credit - 版权信息</span></span><br><span class="line">    <span class="comment">// 返回: Promise&lt;GeoJsonDataSource&gt;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// KmlDataSource - KML数据源</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">KmlDataSource</span> <span class="keyword">extends</span> <span class="title class_ inherited__">DataSource</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(name)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// refreshEvent: Event</span></span><br><span class="line">    <span class="comment">// 作用: 刷新事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">refreshEvent</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// unsupportedNodeEvent: Event</span></span><br><span class="line">    <span class="comment">// 作用: 不支持节点事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">unsupportedNodeEvent</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 静态方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// load - 加载KML数据</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">load</span>(<span class="params">data, options</span>) &#123;</span><br><span class="line">    <span class="comment">// data: Resource | string | Document | Blob</span></span><br><span class="line">    <span class="comment">// 作用: KML数据</span></span><br><span class="line">    <span class="comment">// options: Object</span></span><br><span class="line">    <span class="comment">// sourceUri: string - 源URI</span></span><br><span class="line">    <span class="comment">// clampToGround: boolean - 是否贴地</span></span><br><span class="line">    <span class="comment">// ellipsoid: Ellipsoid - 椭球体</span></span><br><span class="line">    <span class="comment">// credit: Credit - 版权信息</span></span><br><span class="line">    <span class="comment">// 返回: Promise&lt;KmlDataSource&gt;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GpxDataSource - GPX数据源</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GpxDataSource</span> <span class="keyword">extends</span> <span class="title class_ inherited__">DataSource</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(name)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// trackColor: Color</span></span><br><span class="line">    <span class="comment">// 作用: 轨迹颜色</span></span><br><span class="line">    <span class="comment">// 默认: Color.YELLOW</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">trackColor</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// routeColor: Color</span></span><br><span class="line">    <span class="comment">// 作用: 路线颜色</span></span><br><span class="line">    <span class="comment">// 默认: Color.ORANGE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">routeColor</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">ORANGE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// waypointImage: string</span></span><br><span class="line">    <span class="comment">// 作用: 路点图像</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">waypointImage</span> = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// clampToGround: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否贴地</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clampToGround</span> = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 静态方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// load - 加载GPX数据</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">load</span>(<span class="params">data, options</span>) &#123;</span><br><span class="line">    <span class="comment">// data: Resource | string | Document | Blob</span></span><br><span class="line">    <span class="comment">// 作用: GPX数据</span></span><br><span class="line">    <span class="comment">// options: Object</span></span><br><span class="line">    <span class="comment">// 返回: Promise&lt;GpxDataSource&gt;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CustomDataSource - 自定义数据源</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomDataSource</span> <span class="keyword">extends</span> <span class="title class_ inherited__">DataSource</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(name)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 数据源使用示例</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. CZML数据源</span></span><br><span class="line"><span class="keyword">const</span> czmlData = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="string">&#x27;document&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;CZML示例&#x27;</span>,</span><br><span class="line">    <span class="attr">version</span>: <span class="string">&#x27;1.0&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="string">&#x27;satellite&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;卫星&#x27;</span>,</span><br><span class="line">    <span class="attr">availability</span>: <span class="string">&#x27;2023-01-01T00:00:00Z/2023-01-02T00:00:00Z&#x27;</span>,</span><br><span class="line">    <span class="attr">position</span>: &#123;</span><br><span class="line">      <span class="attr">epoch</span>: <span class="string">&#x27;2023-01-01T00:00:00Z&#x27;</span>,</span><br><span class="line">      <span class="attr">cartographicDegrees</span>: [<span class="number">0</span>, <span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">400000</span>, <span class="number">3600</span>, <span class="number">121.4737</span>, <span class="number">31.2304</span>, <span class="number">400000</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">billboard</span>: &#123;</span><br><span class="line">      <span class="attr">image</span>:</span><br><span class="line">        <span class="string">&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==&#x27;</span>,</span><br><span class="line">      <span class="attr">scale</span>: <span class="number">2.0</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">path</span>: &#123;</span><br><span class="line">      <span class="attr">material</span>: &#123;</span><br><span class="line">        <span class="attr">polylineOutline</span>: &#123;</span><br><span class="line">          <span class="attr">color</span>: &#123; <span class="attr">rgba</span>: [<span class="number">255</span>, <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>] &#125;,</span><br><span class="line">          <span class="attr">outlineColor</span>: &#123; <span class="attr">rgba</span>: [<span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>] &#125;,</span><br><span class="line">          <span class="attr">outlineWidth</span>: <span class="number">5</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">width</span>: <span class="number">8</span>,</span><br><span class="line">      <span class="attr">leadTime</span>: <span class="number">10</span>,</span><br><span class="line">      <span class="attr">trailTime</span>: <span class="number">1000</span>,</span><br><span class="line">      <span class="attr">resolution</span>: <span class="number">5</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="title class_">Cesium</span>.<span class="property">CzmlDataSource</span>.<span class="title function_">load</span>(czmlData).<span class="title function_">then</span>(<span class="function">(<span class="params">dataSource</span>) =&gt;</span> &#123;</span><br><span class="line">  viewer.<span class="property">dataSources</span>.<span class="title function_">add</span>(dataSource)</span><br><span class="line">  viewer.<span class="title function_">zoomTo</span>(dataSource)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. GeoJSON数据源</span></span><br><span class="line"><span class="keyword">const</span> geoJsonData = &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;FeatureCollection&#x27;</span>,</span><br><span class="line">  <span class="attr">features</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;Feature&#x27;</span>,</span><br><span class="line">      <span class="attr">properties</span>: &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;北京市&#x27;</span>,</span><br><span class="line">        <span class="attr">population</span>: <span class="number">21540000</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">geometry</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;Point&#x27;</span>,</span><br><span class="line">        <span class="attr">coordinates</span>: [<span class="number">116.4074</span>, <span class="number">39.9042</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;Feature&#x27;</span>,</span><br><span class="line">      <span class="attr">properties</span>: &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;故宫&#x27;</span>,</span><br><span class="line">        <span class="attr">area</span>: <span class="number">720000</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">geometry</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;Polygon&#x27;</span>,</span><br><span class="line">        <span class="attr">coordinates</span>: [</span><br><span class="line">          [</span><br><span class="line">            [<span class="number">116.3906</span>, <span class="number">39.9097</span>],</span><br><span class="line">            [<span class="number">116.3971</span>, <span class="number">39.9097</span>],</span><br><span class="line">            [<span class="number">116.3971</span>, <span class="number">39.9208</span>],</span><br><span class="line">            [<span class="number">116.3906</span>, <span class="number">39.9208</span>],</span><br><span class="line">            [<span class="number">116.3906</span>, <span class="number">39.9097</span>],</span><br><span class="line">          ],</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Cesium</span>.<span class="property">GeoJsonDataSource</span>.<span class="title function_">load</span>(geoJsonData, &#123;</span><br><span class="line">  <span class="attr">markerSize</span>: <span class="number">64</span>,</span><br><span class="line">  <span class="attr">markerColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span>,</span><br><span class="line">  <span class="attr">stroke</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLUE</span>,</span><br><span class="line">  <span class="attr">strokeWidth</span>: <span class="number">3</span>,</span><br><span class="line">  <span class="attr">fill</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLUE</span>.<span class="title function_">withAlpha</span>(<span class="number">0.3</span>),</span><br><span class="line">  <span class="attr">clampToGround</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">dataSource</span>) =&gt;</span> &#123;</span><br><span class="line">  viewer.<span class="property">dataSources</span>.<span class="title function_">add</span>(dataSource)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 自定义样式</span></span><br><span class="line">  <span class="keyword">const</span> entities = dataSource.<span class="property">entities</span>.<span class="property">values</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; entities.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> entity = entities[i]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (entity.<span class="property">billboard</span>) &#123;</span><br><span class="line">      <span class="comment">// 自定义点样式</span></span><br><span class="line">      entity.<span class="property">billboard</span>.<span class="property">image</span> = <span class="title function_">createCustomIcon</span>(entity.<span class="property">properties</span>.<span class="property">name</span>)</span><br><span class="line">      entity.<span class="property">billboard</span>.<span class="property">scale</span> = <span class="number">1.5</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (entity.<span class="property">polygon</span>) &#123;</span><br><span class="line">      <span class="comment">// 自定义多边形样式</span></span><br><span class="line">      entity.<span class="property">polygon</span>.<span class="property">material</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="title function_">fromCssColorString</span>(<span class="string">&#x27;#ff6b6b&#x27;</span>).<span class="title function_">withAlpha</span>(<span class="number">0.4</span>)</span><br><span class="line">      entity.<span class="property">polygon</span>.<span class="property">outline</span> = <span class="literal">true</span></span><br><span class="line">      entity.<span class="property">polygon</span>.<span class="property">outlineColor</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="title function_">fromCssColorString</span>(<span class="string">&#x27;#ff4757&#x27;</span>)</span><br><span class="line">      entity.<span class="property">polygon</span>.<span class="property">height</span> = <span class="number">50</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加标签</span></span><br><span class="line">    entity.<span class="property">label</span> = &#123;</span><br><span class="line">      <span class="attr">text</span>: entity.<span class="property">properties</span>.<span class="property">name</span>,</span><br><span class="line">      <span class="attr">font</span>: <span class="string">&#x27;16pt Microsoft YaHei&#x27;</span>,</span><br><span class="line">      <span class="attr">fillColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span>,</span><br><span class="line">      <span class="attr">outlineColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>,</span><br><span class="line">      <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">style</span>: <span class="title class_">Cesium</span>.<span class="property">LabelStyle</span>.<span class="property">FILL_AND_OUTLINE</span>,</span><br><span class="line">      <span class="attr">pixelOffset</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">0</span>, -<span class="number">50</span>),</span><br><span class="line">      <span class="attr">showBackground</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">backgroundColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>.<span class="title function_">withAlpha</span>(<span class="number">0.7</span>),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. KML数据源（从文件加载）</span></span><br><span class="line"><span class="title class_">Cesium</span>.<span class="property">KmlDataSource</span>.<span class="title function_">load</span>(<span class="string">&#x27;./data/sample.kml&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">clampToGround</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">dataSource</span>) =&gt;</span> &#123;</span><br><span class="line">  viewer.<span class="property">dataSources</span>.<span class="title function_">add</span>(dataSource)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 监听不支持的KML节点</span></span><br><span class="line">  dataSource.<span class="property">unsupportedNodeEvent</span>.<span class="title function_">addEventListener</span>(</span><br><span class="line">    <span class="function">(<span class="params">dataSource, parentEntity, node, entityCollection, styleCollection</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;不支持的KML节点:&#x27;</span>, node.<span class="property">nodeName</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">  )</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 自定义数据源</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RealtimeDataSource</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Cesium.CustomDataSource</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(<span class="string">&#x27;实时数据&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_timer</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_isLoading</span> = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 开始实时数据更新</span></span><br><span class="line">  <span class="title function_">startRealtime</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_timer</span> = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">updateData</span>()</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 停止实时数据更新</span></span><br><span class="line">  <span class="title function_">stopRealtime</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_timer</span>) &#123;</span><br><span class="line">      <span class="built_in">clearInterval</span>(<span class="variable language_">this</span>.<span class="property">_timer</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_timer</span> = <span class="literal">undefined</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新数据</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">updateData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_isLoading</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_isLoading</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loadingEvent</span>.<span class="title function_">raiseEvent</span>(<span class="variable language_">this</span>, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 模拟从API获取数据</span></span><br><span class="line">      <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;/api/realtime-data&#x27;</span>)</span><br><span class="line">      <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="title function_">json</span>()</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 更新实体</span></span><br><span class="line">      data.<span class="property">vehicles</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">vehicle</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> entity = <span class="variable language_">this</span>.<span class="property">entities</span>.<span class="title function_">getById</span>(vehicle.<span class="property">id</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!entity) &#123;</span><br><span class="line">          <span class="comment">// 创建新实体</span></span><br><span class="line">          entity = <span class="variable language_">this</span>.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">            <span class="attr">id</span>: vehicle.<span class="property">id</span>,</span><br><span class="line">            <span class="attr">name</span>: vehicle.<span class="property">name</span>,</span><br><span class="line">            <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(vehicle.<span class="property">lon</span>, vehicle.<span class="property">lat</span>, vehicle.<span class="property">alt</span>),</span><br><span class="line">            <span class="attr">billboard</span>: &#123;</span><br><span class="line">              <span class="attr">image</span>: <span class="string">&#x27;./icons/vehicle.png&#x27;</span>,</span><br><span class="line">              <span class="attr">scale</span>: <span class="number">1.0</span>,</span><br><span class="line">              <span class="attr">verticalOrigin</span>: <span class="title class_">Cesium</span>.<span class="property">VerticalOrigin</span>.<span class="property">BOTTOM</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">label</span>: &#123;</span><br><span class="line">              <span class="attr">text</span>: vehicle.<span class="property">name</span>,</span><br><span class="line">              <span class="attr">font</span>: <span class="string">&#x27;12pt sans-serif&#x27;</span>,</span><br><span class="line">              <span class="attr">pixelOffset</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">0</span>, -<span class="number">40</span>),</span><br><span class="line">              <span class="attr">fillColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span>,</span><br><span class="line">              <span class="attr">outlineColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>,</span><br><span class="line">              <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">              <span class="attr">style</span>: <span class="title class_">Cesium</span>.<span class="property">LabelStyle</span>.<span class="property">FILL_AND_OUTLINE</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 更新位置</span></span><br><span class="line">          entity.<span class="property">position</span> = <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(vehicle.<span class="property">lon</span>, vehicle.<span class="property">lat</span>, vehicle.<span class="property">alt</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新属性</span></span><br><span class="line">        entity.<span class="property">description</span> = <span class="string">`</span></span><br><span class="line"><span class="string">          &lt;div&gt;</span></span><br><span class="line"><span class="string">            &lt;h3&gt;<span class="subst">$&#123;vehicle.name&#125;</span>&lt;/h3&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;速度: <span class="subst">$&#123;vehicle.speed&#125;</span> km/h&lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;方向: <span class="subst">$&#123;vehicle.heading&#125;</span>°&lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;更新时间: <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>(vehicle.timestamp).toLocaleString()&#125;</span>&lt;/p&gt;</span></span><br><span class="line"><span class="string">          &lt;/div&gt;</span></span><br><span class="line"><span class="string">        `</span></span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">changedEvent</span>.<span class="title function_">raiseEvent</span>(<span class="variable language_">this</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;更新实时数据失败:&#x27;</span>, error)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">errorEvent</span>.<span class="title function_">raiseEvent</span>(<span class="variable language_">this</span>, error)</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_isLoading</span> = <span class="literal">false</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">loadingEvent</span>.<span class="title function_">raiseEvent</span>(<span class="variable language_">this</span>, <span class="literal">false</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用自定义数据源</span></span><br><span class="line"><span class="keyword">const</span> realtimeDataSource = <span class="keyword">new</span> <span class="title class_">RealtimeDataSource</span>()</span><br><span class="line">viewer.<span class="property">dataSources</span>.<span class="title function_">add</span>(realtimeDataSource)</span><br><span class="line">realtimeDataSource.<span class="title function_">startRealtime</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. 数据源管理</span></span><br><span class="line"><span class="keyword">const</span> dataSources = viewer.<span class="property">dataSources</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加数据源</span></span><br><span class="line">dataSources.<span class="title function_">add</span>(dataSource)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 移除数据源</span></span><br><span class="line">dataSources.<span class="title function_">remove</span>(dataSource)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取数据源</span></span><br><span class="line"><span class="keyword">const</span> firstDataSource = dataSources.<span class="title function_">get</span>(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">const</span> dataSourceByName = dataSources.<span class="title function_">getByName</span>(<span class="string">&#x27;实时数据&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示/隐藏数据源</span></span><br><span class="line">dataSource.<span class="property">show</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听数据源变化</span></span><br><span class="line">dataSources.<span class="property">dataSourceAdded</span>.<span class="title function_">addEventListener</span>(<span class="function">(<span class="params">collection, dataSource</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;添加数据源:&#x27;</span>, dataSource.<span class="property">name</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">dataSources.<span class="property">dataSourceRemoved</span>.<span class="title function_">addEventListener</span>(<span class="function">(<span class="params">collection, dataSource</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;移除数据源:&#x27;</span>, dataSource.<span class="property">name</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. 实体聚类</span></span><br><span class="line"><span class="keyword">const</span> clustering = dataSource.<span class="property">clustering</span></span><br><span class="line">clustering.<span class="property">enabled</span> = <span class="literal">true</span></span><br><span class="line">clustering.<span class="property">pixelRange</span> = <span class="number">15</span></span><br><span class="line">clustering.<span class="property">minimumClusterSize</span> = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义聚类样式</span></span><br><span class="line">clustering.<span class="property">clusterBillboards</span> = <span class="literal">false</span></span><br><span class="line">clustering.<span class="property">clusterLabels</span> = <span class="literal">false</span></span><br><span class="line">clustering.<span class="property">clusterPoints</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 聚类事件</span></span><br><span class="line">clustering.<span class="property">clusterEvent</span>.<span class="title function_">addEventListener</span>(<span class="function">(<span class="params">clusteredEntities, cluster</span>) =&gt;</span> &#123;</span><br><span class="line">  cluster.<span class="property">billboard</span>.<span class="property">show</span> = <span class="literal">false</span></span><br><span class="line">  cluster.<span class="property">label</span>.<span class="property">show</span> = <span class="literal">true</span></span><br><span class="line">  cluster.<span class="property">label</span>.<span class="property">text</span> = clusteredEntities.<span class="property">length</span>.<span class="title function_">toString</span>()</span><br><span class="line">  cluster.<span class="property">label</span>.<span class="property">font</span> = <span class="string">&#x27;16pt sans-serif&#x27;</span></span><br><span class="line">  cluster.<span class="property">label</span>.<span class="property">fillColor</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">WHITE</span></span><br><span class="line">  cluster.<span class="property">label</span>.<span class="property">outlineColor</span> = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span></span><br><span class="line">  cluster.<span class="property">label</span>.<span class="property">outlineWidth</span> = <span class="number">2</span></span><br><span class="line">  cluster.<span class="property">label</span>.<span class="property">style</span> = <span class="title class_">Cesium</span>.<span class="property">LabelStyle</span>.<span class="property">FILL_AND_OUTLINE</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加自定义点</span></span><br><span class="line">  cluster.<span class="property">point</span> = &#123;</span><br><span class="line">    <span class="attr">pixelSize</span>: <span class="number">30</span>,</span><br><span class="line">    <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">CYAN</span>,</span><br><span class="line">    <span class="attr">outlineColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>,</span><br><span class="line">    <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createCustomIcon</span>(<span class="params">name</span>) &#123;</span><br><span class="line">  <span class="comment">// 创建自定义图标</span></span><br><span class="line">  <span class="keyword">const</span> canvas = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;canvas&#x27;</span>)</span><br><span class="line">  canvas.<span class="property">width</span> = <span class="number">64</span></span><br><span class="line">  canvas.<span class="property">height</span> = <span class="number">64</span></span><br><span class="line">  <span class="keyword">const</span> ctx = canvas.<span class="title function_">getContext</span>(<span class="string">&#x27;2d&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 绘制背景圆</span></span><br><span class="line">  ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;#ff6b6b&#x27;</span></span><br><span class="line">  ctx.<span class="title function_">beginPath</span>()</span><br><span class="line">  ctx.<span class="title function_">arc</span>(<span class="number">32</span>, <span class="number">32</span>, <span class="number">30</span>, <span class="number">0</span>, <span class="number">2</span> * <span class="title class_">Math</span>.<span class="property">PI</span>)</span><br><span class="line">  ctx.<span class="title function_">fill</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 绘制边框</span></span><br><span class="line">  ctx.<span class="property">strokeStyle</span> = <span class="string">&#x27;#ff4757&#x27;</span></span><br><span class="line">  ctx.<span class="property">lineWidth</span> = <span class="number">3</span></span><br><span class="line">  ctx.<span class="title function_">stroke</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 绘制文字</span></span><br><span class="line">  ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;white&#x27;</span></span><br><span class="line">  ctx.<span class="property">font</span> = <span class="string">&#x27;12px Arial&#x27;</span></span><br><span class="line">  ctx.<span class="property">textAlign</span> = <span class="string">&#x27;center&#x27;</span></span><br><span class="line">  ctx.<span class="title function_">fillText</span>(name.<span class="title function_">substring</span>(<span class="number">0</span>, <span class="number">2</span>), <span class="number">32</span>, <span class="number">38</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> canvas.<span class="title function_">toDataURL</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="时间系统详解"><a href="#时间系统详解" class="headerlink" title="时间系统详解"></a>时间系统详解</h2><h3 id="JulianDate-儒略日期"><a href="#JulianDate-儒略日期" class="headerlink" title="JulianDate 儒略日期"></a>JulianDate 儒略日期</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JulianDate - 儒略日期类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JulianDate</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">julianDayNumber, secondsOfDay, timeStandard</span>) &#123;</span><br><span class="line">    <span class="comment">// julianDayNumber: number</span></span><br><span class="line">    <span class="comment">// 作用: 儒略日数</span></span><br><span class="line">    <span class="comment">// 默认: 0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">julianDayNumber</span> = julianDayNumber || <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// secondsOfDay: number</span></span><br><span class="line">    <span class="comment">// 作用: 一天中的秒数</span></span><br><span class="line">    <span class="comment">// 默认: 0.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">secondsOfDay</span> = secondsOfDay || <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// timeStandard: TimeStandard</span></span><br><span class="line">    <span class="comment">// 作用: 时间标准</span></span><br><span class="line">    <span class="comment">// 默认: TimeStandard.UTC</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">timeStandard</span> = timeStandard || <span class="title class_">Cesium</span>.<span class="property">TimeStandard</span>.<span class="property">UTC</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 静态方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// now - 获取当前时间</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">now</span>(<span class="params">result</span>) &#123;</span><br><span class="line">    <span class="comment">// result: JulianDate - 结果对象</span></span><br><span class="line">    <span class="comment">// 返回: JulianDate</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">now</span>(result)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromDate - 从JavaScript Date创建</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromDate</span>(<span class="params">date, result</span>) &#123;</span><br><span class="line">    <span class="comment">// date: Date - JavaScript日期对象</span></span><br><span class="line">    <span class="comment">// result: JulianDate - 结果对象</span></span><br><span class="line">    <span class="comment">// 返回: JulianDate</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(date, result)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromIso8601 - 从ISO 8601字符串创建</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromIso8601</span>(<span class="params">iso8601String, result</span>) &#123;</span><br><span class="line">    <span class="comment">// iso8601String: string - ISO 8601格式字符串</span></span><br><span class="line">    <span class="comment">// 例如: &quot;2023-01-01T12:00:00Z&quot;</span></span><br><span class="line">    <span class="comment">// result: JulianDate - 结果对象</span></span><br><span class="line">    <span class="comment">// 返回: JulianDate</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(iso8601String, result)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// toDate - 转换为JavaScript Date</span></span><br><span class="line">  <span class="title function_">toDate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 返回: Date</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">toDate</span>(<span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// toIso8601 - 转换为ISO 8601字符串</span></span><br><span class="line">  <span class="title function_">toIso8601</span>(<span class="params">precision</span>) &#123;</span><br><span class="line">    <span class="comment">// precision: number - 精度（小数位数）</span></span><br><span class="line">    <span class="comment">// 返回: string</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">toIso8601</span>(<span class="variable language_">this</span>, precision)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// addSeconds - 添加秒数</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">addSeconds</span>(<span class="params">julianDate, seconds, result</span>) &#123;</span><br><span class="line">    <span class="comment">// julianDate: JulianDate - 儒略日期</span></span><br><span class="line">    <span class="comment">// seconds: number - 秒数</span></span><br><span class="line">    <span class="comment">// result: JulianDate - 结果对象</span></span><br><span class="line">    <span class="comment">// 返回: JulianDate</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addSeconds</span>(julianDate, seconds, result)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// addMinutes - 添加分钟数</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">addMinutes</span>(<span class="params">julianDate, minutes, result</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addMinutes</span>(julianDate, minutes, result)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// addHours - 添加小时数</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">addHours</span>(<span class="params">julianDate, hours, result</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addHours</span>(julianDate, hours, result)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// addDays - 添加天数</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">addDays</span>(<span class="params">julianDate, days, result</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addDays</span>(julianDate, days, result)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// secondsDifference - 计算秒数差</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">secondsDifference</span>(<span class="params">left, right</span>) &#123;</span><br><span class="line">    <span class="comment">// left: JulianDate - 左操作数</span></span><br><span class="line">    <span class="comment">// right: JulianDate - 右操作数</span></span><br><span class="line">    <span class="comment">// 返回: number - 秒数差 (left - right)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">secondsDifference</span>(left, right)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// daysDifference - 计算天数差</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">daysDifference</span>(<span class="params">left, right</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">daysDifference</span>(left, right)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// compare - 比较两个日期</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">compare</span>(<span class="params">left, right</span>) &#123;</span><br><span class="line">    <span class="comment">// 返回: number</span></span><br><span class="line">    <span class="comment">// -1: left &lt; right</span></span><br><span class="line">    <span class="comment">//  0: left === right</span></span><br><span class="line">    <span class="comment">//  1: left &gt; right</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">compare</span>(left, right)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// equals - 判断相等</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">equals</span>(<span class="params">left, right</span>) &#123;</span><br><span class="line">    <span class="comment">// 返回: boolean</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">equals</span>(left, right)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// equalsEpsilon - 在指定精度内判断相等</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">equalsEpsilon</span>(<span class="params">left, right, epsilon</span>) &#123;</span><br><span class="line">    <span class="comment">// epsilon: number - 误差范围（秒）</span></span><br><span class="line">    <span class="comment">// 返回: boolean</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">equalsEpsilon</span>(left, right, epsilon)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// clone - 克隆</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">clone</span>(<span class="params">julianDate, result</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">clone</span>(julianDate, result)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TimeInterval - 时间间隔</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TimeInterval</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// start: JulianDate</span></span><br><span class="line">    <span class="comment">// 作用: 开始时间</span></span><br><span class="line">    <span class="comment">// 默认: new JulianDate()</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">start</span> = options.<span class="property">start</span> || <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// stop: JulianDate</span></span><br><span class="line">    <span class="comment">// 作用: 结束时间</span></span><br><span class="line">    <span class="comment">// 默认: new JulianDate()</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">stop</span> = options.<span class="property">stop</span> || <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// isStartIncluded: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否包含开始时间</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isStartIncluded</span> = options.<span class="property">isStartIncluded</span> !== <span class="literal">undefined</span> ? options.<span class="property">isStartIncluded</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// isStopIncluded: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否包含结束时间</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isStopIncluded</span> = options.<span class="property">isStopIncluded</span> !== <span class="literal">undefined</span> ? options.<span class="property">isStopIncluded</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// data: Object</span></span><br><span class="line">    <span class="comment">// 作用: 关联数据</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">data</span> = options.<span class="property">data</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// contains - 是否包含指定时间</span></span><br><span class="line">  <span class="title function_">contains</span>(<span class="params">julianDate</span>) &#123;</span><br><span class="line">    <span class="comment">// julianDate: JulianDate - 要检查的时间</span></span><br><span class="line">    <span class="comment">// 返回: boolean</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">TimeInterval</span>.<span class="title function_">contains</span>(<span class="variable language_">this</span>, julianDate)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// intersect - 求交集</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">intersect</span>(<span class="params">left, right, result</span>) &#123;</span><br><span class="line">    <span class="comment">// left: TimeInterval - 左间隔</span></span><br><span class="line">    <span class="comment">// right: TimeInterval - 右间隔</span></span><br><span class="line">    <span class="comment">// result: TimeInterval - 结果对象</span></span><br><span class="line">    <span class="comment">// 返回: TimeInterval</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">TimeInterval</span>.<span class="title function_">intersect</span>(left, right, result)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// isEmpty - 是否为空间隔</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">isEmpty</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">TimeInterval</span>.<span class="title function_">isEmpty</span>(<span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TimeIntervalCollection - 时间间隔集合</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TimeIntervalCollection</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">intervals</span>) &#123;</span><br><span class="line">    <span class="comment">// intervals: Array&lt;TimeInterval&gt; - 时间间隔数组</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_intervals</span> = intervals || []</span><br><span class="line"></span><br><span class="line">    <span class="comment">// changed: Event</span></span><br><span class="line">    <span class="comment">// 作用: 集合变化事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">changed</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Event</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// changedEventHelper: EventHelper</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">changedEventHelper</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">EventHelper</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 属性</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// start: JulianDate</span></span><br><span class="line">  <span class="comment">// 作用: 第一个间隔的开始时间</span></span><br><span class="line">  <span class="comment">// 只读: true</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">start</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">length</span> &gt; <span class="number">0</span> ? <span class="variable language_">this</span>.<span class="property">_intervals</span>[<span class="number">0</span>].<span class="property">start</span> : <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// stop: JulianDate</span></span><br><span class="line">  <span class="comment">// 作用: 最后一个间隔的结束时间</span></span><br><span class="line">  <span class="comment">// 只读: true</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">stop</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">length</span> &gt; <span class="number">0</span> ? <span class="variable language_">this</span>.<span class="property">_intervals</span>[<span class="variable language_">this</span>.<span class="property">length</span> - <span class="number">1</span>].<span class="property">stop</span> : <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// length: number</span></span><br><span class="line">  <span class="comment">// 作用: 间隔数量</span></span><br><span class="line">  <span class="comment">// 只读: true</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">length</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_intervals</span>.<span class="property">length</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// isEmpty: boolean</span></span><br><span class="line">  <span class="comment">// 作用: 是否为空集合</span></span><br><span class="line">  <span class="comment">// 只读: true</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">isEmpty</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">length</span> === <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// addInterval - 添加间隔</span></span><br><span class="line">  <span class="title function_">addInterval</span>(<span class="params">interval, dataComparer</span>) &#123;</span><br><span class="line">    <span class="comment">// interval: TimeInterval - 要添加的间隔</span></span><br><span class="line">    <span class="comment">// dataComparer: function - 数据比较函数</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_intervals</span>.<span class="title function_">push</span>(interval)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">changed</span>.<span class="title function_">raiseEvent</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// removeInterval - 移除间隔</span></span><br><span class="line">  <span class="title function_">removeInterval</span>(<span class="params">interval</span>) &#123;</span><br><span class="line">    <span class="comment">// interval: TimeInterval - 要移除的间隔</span></span><br><span class="line">    <span class="keyword">const</span> index = <span class="variable language_">this</span>.<span class="property">_intervals</span>.<span class="title function_">indexOf</span>(interval)</span><br><span class="line">    <span class="keyword">if</span> (index !== -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_intervals</span>.<span class="title function_">splice</span>(index, <span class="number">1</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">changed</span>.<span class="title function_">raiseEvent</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// contains - 是否包含指定时间</span></span><br><span class="line">  <span class="title function_">contains</span>(<span class="params">julianDate</span>) &#123;</span><br><span class="line">    <span class="comment">// julianDate: JulianDate - 要检查的时间</span></span><br><span class="line">    <span class="comment">// 返回: boolean</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_intervals</span>.<span class="title function_">some</span>(<span class="function">(<span class="params">interval</span>) =&gt;</span> interval.<span class="title function_">contains</span>(julianDate))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// findInterval - 查找包含指定时间的间隔</span></span><br><span class="line">  <span class="title function_">findInterval</span>(<span class="params">julianDate</span>) &#123;</span><br><span class="line">    <span class="comment">// julianDate: JulianDate - 要查找的时间</span></span><br><span class="line">    <span class="comment">// 返回: TimeInterval | undefined</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_intervals</span>.<span class="title function_">find</span>(<span class="function">(<span class="params">interval</span>) =&gt;</span> interval.<span class="title function_">contains</span>(julianDate))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// findDataForIntervalContainingDate - 查找包含指定时间的间隔数据</span></span><br><span class="line">  <span class="title function_">findDataForIntervalContainingDate</span>(<span class="params">julianDate</span>) &#123;</span><br><span class="line">    <span class="comment">// julianDate: JulianDate - 要查找的时间</span></span><br><span class="line">    <span class="comment">// 返回: Object | undefined</span></span><br><span class="line">    <span class="keyword">const</span> interval = <span class="variable language_">this</span>.<span class="title function_">findInterval</span>(julianDate)</span><br><span class="line">    <span class="keyword">return</span> interval ? interval.<span class="property">data</span> : <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// get - 获取指定索引的间隔</span></span><br><span class="line">  <span class="title function_">get</span>(<span class="params">index</span>) &#123;</span><br><span class="line">    <span class="comment">// index: number - 索引</span></span><br><span class="line">    <span class="comment">// 返回: TimeInterval</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_intervals</span>[index]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// removeAll - 移除所有间隔</span></span><br><span class="line">  <span class="title function_">removeAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_intervals</span>.<span class="property">length</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">changed</span>.<span class="title function_">raiseEvent</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// intersect - 求与另一个集合的交集</span></span><br><span class="line">  <span class="title function_">intersect</span>(<span class="params">other, dataComparer, mergeCallback</span>) &#123;</span><br><span class="line">    <span class="comment">// other: TimeIntervalCollection - 另一个集合</span></span><br><span class="line">    <span class="comment">// dataComparer: function - 数据比较函数</span></span><br><span class="line">    <span class="comment">// mergeCallback: function - 合并回调</span></span><br><span class="line">    <span class="comment">// 返回: TimeIntervalCollection</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 时间系统使用示例</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 基础时间操作</span></span><br><span class="line"><span class="keyword">const</span> now = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">now</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;当前时间:&#x27;</span>, <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">toDate</span>(now))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从不同格式创建时间</span></span><br><span class="line"><span class="keyword">const</span> fromDate = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&#x27;2023-01-01T12:00:00Z&#x27;</span>))</span><br><span class="line"><span class="keyword">const</span> fromIso = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(<span class="string">&#x27;2023-01-01T12:00:00Z&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> fromComponents = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>(<span class="number">2459945</span>, <span class="number">43200</span>) <span class="comment">// 2023-01-01 12:00:00 UTC</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 时间运算</span></span><br><span class="line"><span class="keyword">const</span> futureTime = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addHours</span>(now, <span class="number">24</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>())</span><br><span class="line"><span class="keyword">const</span> pastTime = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addDays</span>(now, -<span class="number">7</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 时间差计算</span></span><br><span class="line"><span class="keyword">const</span> secondsDiff = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">secondsDifference</span>(futureTime, now)</span><br><span class="line"><span class="keyword">const</span> daysDiff = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">daysDifference</span>(futureTime, now)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`未来时间相差 <span class="subst">$&#123;secondsDiff&#125;</span> 秒，<span class="subst">$&#123;daysDiff&#125;</span> 天`</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 时间比较</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">compare</span>(futureTime, now) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;futureTime 在 now 之后&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 时间间隔操作</span></span><br><span class="line"><span class="keyword">const</span> interval1 = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeInterval</span>(&#123;</span><br><span class="line">  <span class="attr">start</span>: <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(<span class="string">&#x27;2023-01-01T00:00:00Z&#x27;</span>),</span><br><span class="line">  <span class="attr">stop</span>: <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(<span class="string">&#x27;2023-01-01T12:00:00Z&#x27;</span>),</span><br><span class="line">  <span class="attr">data</span>: &#123; <span class="attr">period</span>: <span class="string">&#x27;上午&#x27;</span> &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> interval2 = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeInterval</span>(&#123;</span><br><span class="line">  <span class="attr">start</span>: <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(<span class="string">&#x27;2023-01-01T12:00:00Z&#x27;</span>),</span><br><span class="line">  <span class="attr">stop</span>: <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(<span class="string">&#x27;2023-01-02T00:00:00Z&#x27;</span>),</span><br><span class="line">  <span class="attr">data</span>: &#123; <span class="attr">period</span>: <span class="string">&#x27;下午&#x27;</span> &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查时间是否在间隔内</span></span><br><span class="line"><span class="keyword">const</span> testTime = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(<span class="string">&#x27;2023-01-01T10:00:00Z&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;测试时间在interval1内:&#x27;</span>, interval1.<span class="title function_">contains</span>(testTime))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 求交集</span></span><br><span class="line"><span class="keyword">const</span> intersection = <span class="title class_">Cesium</span>.<span class="property">TimeInterval</span>.<span class="title function_">intersect</span>(interval1, interval2, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeInterval</span>())</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;交集是否为空:&#x27;</span>, intersection.<span class="property">isEmpty</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 时间间隔集合</span></span><br><span class="line"><span class="keyword">const</span> collection = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeIntervalCollection</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加多个间隔</span></span><br><span class="line">collection.<span class="title function_">addInterval</span>(interval1)</span><br><span class="line">collection.<span class="title function_">addInterval</span>(interval2)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加更多间隔（模拟一天的时间段）</span></span><br><span class="line"><span class="keyword">const</span> hourlyIntervals = []</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> hour = <span class="number">0</span>; hour &lt; <span class="number">24</span>; hour++) &#123;</span><br><span class="line">  <span class="keyword">const</span> startTime = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(</span><br><span class="line">    <span class="string">`2023-01-01T<span class="subst">$&#123;hour.toString().padStart(<span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>)&#125;</span>:00:00Z`</span>,</span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">const</span> stopTime = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addHours</span>(startTime, <span class="number">1</span>, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>())</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> interval = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeInterval</span>(&#123;</span><br><span class="line">    <span class="attr">start</span>: startTime,</span><br><span class="line">    <span class="attr">stop</span>: stopTime,</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">      <span class="attr">hour</span>: hour,</span><br><span class="line">      <span class="attr">period</span>: hour &lt; <span class="number">6</span> ? <span class="string">&#x27;凌晨&#x27;</span> : hour &lt; <span class="number">12</span> ? <span class="string">&#x27;上午&#x27;</span> : hour &lt; <span class="number">18</span> ? <span class="string">&#x27;下午&#x27;</span> : <span class="string">&#x27;晚上&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  collection.<span class="title function_">addInterval</span>(interval)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查找特定时间的数据</span></span><br><span class="line"><span class="keyword">const</span> queryTime = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(<span class="string">&#x27;2023-01-01T15:30:00Z&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> intervalData = collection.<span class="title function_">findDataForIntervalContainingDate</span>(queryTime)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;15:30的时间段数据:&#x27;</span>, intervalData)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听集合变化</span></span><br><span class="line">collection.<span class="property">changed</span>.<span class="title function_">addEventListener</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;时间间隔集合发生变化，当前包含&#x27;</span>, collection.<span class="property">length</span>, <span class="string">&#x27;个间隔&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 实体可用性时间</span></span><br><span class="line"><span class="keyword">const</span> entity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;限时显示的实体&#x27;</span>,</span><br><span class="line">  <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">0</span>),</span><br><span class="line">  <span class="attr">point</span>: &#123;</span><br><span class="line">    <span class="attr">pixelSize</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 设置可用性时间</span></span><br><span class="line">  <span class="attr">availability</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeIntervalCollection</span>([</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeInterval</span>(&#123;</span><br><span class="line">      <span class="attr">start</span>: <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(<span class="string">&#x27;2023-01-01T08:00:00Z&#x27;</span>),</span><br><span class="line">      <span class="attr">stop</span>: <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(<span class="string">&#x27;2023-01-01T18:00:00Z&#x27;</span>),</span><br><span class="line">    &#125;),</span><br><span class="line">  ]),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. 时钟控制</span></span><br><span class="line"><span class="keyword">const</span> clock = viewer.<span class="property">clock</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置时间范围</span></span><br><span class="line">clock.<span class="property">startTime</span> = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(<span class="string">&#x27;2023-01-01T00:00:00Z&#x27;</span>)</span><br><span class="line">clock.<span class="property">stopTime</span> = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(<span class="string">&#x27;2023-01-02T00:00:00Z&#x27;</span>)</span><br><span class="line">clock.<span class="property">currentTime</span> = clock.<span class="property">startTime</span>.<span class="title function_">clone</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 时间控制</span></span><br><span class="line">clock.<span class="property">multiplier</span> = <span class="number">3600</span> <span class="comment">// 1秒代表1小时</span></span><br><span class="line">clock.<span class="property">clockRange</span> = <span class="title class_">Cesium</span>.<span class="property">ClockRange</span>.<span class="property">LOOP_STOP</span> <span class="comment">// 循环播放</span></span><br><span class="line">clock.<span class="property">shouldAnimate</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听时钟事件</span></span><br><span class="line">clock.<span class="property">onTick</span>.<span class="title function_">addEventListener</span>(<span class="function">(<span class="params">clock</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> currentHour = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">toDate</span>(clock.<span class="property">currentTime</span>).<span class="title function_">getHours</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据时间改变场景</span></span><br><span class="line">  <span class="keyword">if</span> (currentHour &gt;= <span class="number">6</span> &amp;&amp; currentHour &lt; <span class="number">18</span>) &#123;</span><br><span class="line">    <span class="comment">// 白天</span></span><br><span class="line">    viewer.<span class="property">scene</span>.<span class="property">skyAtmosphere</span>.<span class="property">show</span> = <span class="literal">true</span></span><br><span class="line">    viewer.<span class="property">scene</span>.<span class="property">sun</span>.<span class="property">show</span> = <span class="literal">true</span></span><br><span class="line">    viewer.<span class="property">scene</span>.<span class="property">moon</span>.<span class="property">show</span> = <span class="literal">false</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 夜晚</span></span><br><span class="line">    viewer.<span class="property">scene</span>.<span class="property">skyAtmosphere</span>.<span class="property">show</span> = <span class="literal">false</span></span><br><span class="line">    viewer.<span class="property">scene</span>.<span class="property">sun</span>.<span class="property">show</span> = <span class="literal">false</span></span><br><span class="line">    viewer.<span class="property">scene</span>.<span class="property">moon</span>.<span class="property">show</span> = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. 时间相关的属性动画</span></span><br><span class="line"><span class="keyword">const</span> timeBasedPosition = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">CallbackProperty</span>(<span class="function">(<span class="params">time</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> secondsIntoDay = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">secondsOfDay</span>(time)</span><br><span class="line">  <span class="keyword">const</span> angle = (secondsIntoDay / <span class="number">86400</span>) * <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="property">TWO_PI</span> <span class="comment">// 一天转一圈</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> radius = <span class="number">1000</span></span><br><span class="line">  <span class="keyword">const</span> x = radius * <span class="title class_">Math</span>.<span class="title function_">cos</span>(angle)</span><br><span class="line">  <span class="keyword">const</span> y = radius * <span class="title class_">Math</span>.<span class="title function_">sin</span>(angle)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(</span><br><span class="line">    <span class="number">116.4074</span> + x / <span class="number">111320</span>, <span class="comment">// 转换为经度偏移</span></span><br><span class="line">    <span class="number">39.9042</span> + y / <span class="number">110540</span>, <span class="comment">// 转换为纬度偏移</span></span><br><span class="line">    <span class="number">100</span>,</span><br><span class="line">  )</span><br><span class="line">&#125;, <span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> orbitingEntity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: timeBasedPosition,</span><br><span class="line">  <span class="attr">point</span>: &#123;</span><br><span class="line">    <span class="attr">pixelSize</span>: <span class="number">8</span>,</span><br><span class="line">    <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">LIME</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">path</span>: &#123;</span><br><span class="line">    <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">leadTime</span>: <span class="number">3600</span>, <span class="comment">// 显示未来1小时的轨迹</span></span><br><span class="line">    <span class="attr">trailTime</span>: <span class="number">3600</span>, <span class="comment">// 显示过去1小时的轨迹</span></span><br><span class="line">    <span class="attr">width</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">material</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">LIME</span>,</span><br><span class="line">    <span class="attr">resolution</span>: <span class="number">60</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 7. 时区转换</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">convertToLocalTime</span>(<span class="params">julianDate, timezoneOffset</span>) &#123;</span><br><span class="line">  <span class="comment">// timezoneOffset: 时区偏移（小时）</span></span><br><span class="line">  <span class="keyword">const</span> offsetSeconds = timezoneOffset * <span class="number">3600</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addSeconds</span>(julianDate, offsetSeconds, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 转换为北京时间（UTC+8）</span></span><br><span class="line"><span class="keyword">const</span> utcTime = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">now</span>()</span><br><span class="line"><span class="keyword">const</span> beijingTime = <span class="title function_">convertToLocalTime</span>(utcTime, <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;UTC时间:&#x27;</span>, <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">toDate</span>(utcTime))</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;北京时间:&#x27;</span>, <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">toDate</span>(beijingTime))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 8. 性能时间测量</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">measurePerformance</span>(<span class="params">fn, name</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> start = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">now</span>()</span><br><span class="line"></span><br><span class="line">  <span class="title function_">fn</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> end = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">now</span>()</span><br><span class="line">  <span class="keyword">const</span> elapsed = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">secondsDifference</span>(end, start)</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;name&#125;</span> 执行时间: <span class="subst">$&#123;elapsed * <span class="number">1000</span>&#125;</span> 毫秒`</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="title function_">measurePerformance</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 一些计算密集的操作</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">    <span class="title class_">Math</span>.<span class="title function_">sqrt</span>(i)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="string">&#x27;数学计算&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="绘制功能详解"><a href="#绘制功能详解" class="headerlink" title="绘制功能详解"></a>绘制功能详解</h2><h3 id="绘制工具基类"><a href="#绘制工具基类" class="headerlink" title="绘制工具基类"></a>绘制工具基类</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cesium绘制工具基类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CesiumDrawTool</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">viewer, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span> = viewer</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = viewer.<span class="property">scene</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span> = viewer.<span class="property">camera</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span> = viewer.<span class="property">canvas</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// type: string</span></span><br><span class="line">    <span class="comment">// 作用: 绘制类型</span></span><br><span class="line">    <span class="comment">// 选项: &#x27;point&#x27;, &#x27;polyline&#x27;, &#x27;polygon&#x27;, &#x27;rectangle&#x27;, &#x27;circle&#x27;, &#x27;billboard&#x27;, &#x27;model&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">type</span> = options.<span class="property">type</span> || <span class="string">&#x27;point&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// style: Object</span></span><br><span class="line">    <span class="comment">// 作用: 绘制样式配置</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = options.<span class="property">style</span> || &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clampToGround: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否贴地</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clampToGround</span> = options.<span class="property">clampToGround</span> !== <span class="literal">undefined</span> ? options.<span class="property">clampToGround</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// enableEdit: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 绘制完成后是否可编辑</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">enableEdit</span> = options.<span class="property">enableEdit</span> !== <span class="literal">undefined</span> ? options.<span class="property">enableEdit</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// heightOffset: number</span></span><br><span class="line">    <span class="comment">// 作用: 高度偏移量（米）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">heightOffset</span> = options.<span class="property">heightOffset</span> || <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isActive</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">positions</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">activeEntity</span> = <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tempEntities</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handler</span> = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 激活绘制工具</span></span><br><span class="line">  <span class="title function_">activate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isActive</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isActive</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">positions</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">clearTempEntities</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建事件处理器</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handler</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ScreenSpaceEventHandler</span>(<span class="variable language_">this</span>.<span class="property">canvas</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绑定事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">bindEvents</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 改变鼠标样式</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">style</span>.<span class="property">cursor</span> = <span class="string">&#x27;crosshair&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 触发激活事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">onActivate</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 停用绘制工具</span></span><br><span class="line">  <span class="title function_">deactivate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">isActive</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isActive</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解绑事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">unbindEvents</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理临时实体</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">clearTempEntities</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 恢复鼠标样式</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">style</span>.<span class="property">cursor</span> = <span class="string">&#x27;default&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 触发停用事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">onDeactivate</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 绑定鼠标事件</span></span><br><span class="line">  <span class="title function_">bindEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 左键点击</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handler</span>.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">click</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> position = <span class="variable language_">this</span>.<span class="title function_">pickPosition</span>(click.<span class="property">position</span>)</span><br><span class="line">      <span class="keyword">if</span> (position) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">handleClick</span>(position)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">LEFT_CLICK</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 鼠标移动</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handler</span>.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">movement</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> position = <span class="variable language_">this</span>.<span class="title function_">pickPosition</span>(movement.<span class="property">endPosition</span>)</span><br><span class="line">      <span class="keyword">if</span> (position) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">handleMouseMove</span>(position)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">MOUSE_MOVE</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 右键完成</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handler</span>.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">click</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">finishDrawing</span>()</span><br><span class="line">    &#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">RIGHT_CLICK</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 双击完成</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handler</span>.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">click</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">finishDrawing</span>()</span><br><span class="line">    &#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">LEFT_DOUBLE_CLICK</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 解绑事件</span></span><br><span class="line">  <span class="title function_">unbindEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">handler</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">handler</span>.<span class="title function_">destroy</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">handler</span> = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 拾取位置</span></span><br><span class="line">  <span class="title function_">pickPosition</span>(<span class="params">windowPosition</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> pickedPosition</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">clampToGround</span>) &#123;</span><br><span class="line">      <span class="comment">// 贴地模式 - 拾取地形</span></span><br><span class="line">      <span class="keyword">const</span> ray = <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">getPickRay</span>(windowPosition)</span><br><span class="line">      pickedPosition = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">globe</span>.<span class="title function_">pick</span>(ray, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 空间模式 - 拾取椭球面</span></span><br><span class="line">      pickedPosition = <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">pickEllipsoid</span>(windowPosition, <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">globe</span>.<span class="property">ellipsoid</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pickedPosition) &#123;</span><br><span class="line">      <span class="comment">// 添加高度偏移</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">heightOffset</span> !== <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> cartographic = <span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromCartesian</span>(pickedPosition)</span><br><span class="line">        cartographic.<span class="property">height</span> += <span class="variable language_">this</span>.<span class="property">heightOffset</span></span><br><span class="line">        pickedPosition = <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromRadians</span>(</span><br><span class="line">          cartographic.<span class="property">longitude</span>,</span><br><span class="line">          cartographic.<span class="property">latitude</span>,</span><br><span class="line">          cartographic.<span class="property">height</span>,</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pickedPosition</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理点击事件</span></span><br><span class="line">  <span class="title function_">handleClick</span>(<span class="params">position</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">positions</span>.<span class="title function_">push</span>(position)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">updateDrawing</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否满足完成条件</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">shouldFinish</span>()) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">finishDrawing</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理鼠标移动</span></span><br><span class="line">  <span class="title function_">handleMouseMove</span>(<span class="params">position</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">positions</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">updatePreview</span>(position)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新绘制状态</span></span><br><span class="line">  <span class="title function_">updateDrawing</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 子类实现</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新预览</span></span><br><span class="line">  <span class="title function_">updatePreview</span>(<span class="params">position</span>) &#123;</span><br><span class="line">    <span class="comment">// 子类实现</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 是否应该完成绘制</span></span><br><span class="line">  <span class="title function_">shouldFinish</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable language_">this</span>.<span class="property">type</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;point&#x27;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;billboard&#x27;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;model&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">positions</span>.<span class="property">length</span> &gt;= <span class="number">1</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;polyline&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">positions</span>.<span class="property">length</span> &gt;= <span class="number">2</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;polygon&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">positions</span>.<span class="property">length</span> &gt;= <span class="number">3</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;rectangle&#x27;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;circle&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">positions</span>.<span class="property">length</span> &gt;= <span class="number">2</span></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 完成绘制</span></span><br><span class="line">  <span class="title function_">finishDrawing</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">positions</span>.<span class="property">length</span> &lt; <span class="variable language_">this</span>.<span class="title function_">getMinPointCount</span>()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建最终实体</span></span><br><span class="line">    <span class="keyword">const</span> entity = <span class="variable language_">this</span>.<span class="title function_">createFinalEntity</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理临时实体</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">clearTempEntities</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 停用工具</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">deactivate</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 触发完成事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">onComplete</span>(entity)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> entity</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取最小点数</span></span><br><span class="line">  <span class="title function_">getMinPointCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable language_">this</span>.<span class="property">type</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;point&#x27;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;billboard&#x27;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;model&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;polyline&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;polygon&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;rectangle&#x27;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;circle&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建最终实体（子类实现）</span></span><br><span class="line">  <span class="title function_">createFinalEntity</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清理临时实体</span></span><br><span class="line">  <span class="title function_">clearTempEntities</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tempEntities</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">entity</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">entities</span>.<span class="title function_">remove</span>(entity)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tempEntities</span> = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 事件回调</span></span><br><span class="line">  <span class="title function_">onActivate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.type&#125;</span> 绘制工具已激活`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onDeactivate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.type&#125;</span> 绘制工具已停用`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onComplete</span>(<span class="params">entity</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.type&#125;</span> 绘制完成:`</span>, entity)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 点绘制工具</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PointDrawTool</span> <span class="keyword">extends</span> <span class="title class_ inherited__">CesiumDrawTool</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">viewer, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(viewer, &#123; ...options, <span class="attr">type</span>: <span class="string">&#x27;point&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 默认点样式</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// pixelSize: number - 点的像素大小</span></span><br><span class="line">        <span class="attr">pixelSize</span>: <span class="number">10</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// color: Cesium.Color - 点的颜色</span></span><br><span class="line">        <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outlineColor: Cesium.Color - 轮廓颜色</span></span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outlineWidth: number - 轮廓宽度</span></span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// heightReference: Cesium.HeightReference - 高度参考</span></span><br><span class="line">        <span class="attr">heightReference</span>: <span class="variable language_">this</span>.<span class="property">clampToGround</span></span><br><span class="line">          ? <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">CLAMP_TO_GROUND</span></span><br><span class="line">          : <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">NONE</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// disableDepthTestDistance: number - 禁用深度测试距离</span></span><br><span class="line">        <span class="attr">disableDepthTestDistance</span>: <span class="title class_">Number</span>.<span class="property">POSITIVE_INFINITY</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// scaleByDistance: Cesium.NearFarScalar - 基于距离的缩放</span></span><br><span class="line">        <span class="attr">scaleByDistance</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// distanceDisplayCondition: Cesium.DistanceDisplayCondition - 距离显示条件</span></span><br><span class="line">        <span class="attr">distanceDisplayCondition</span>: <span class="literal">undefined</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createFinalEntity</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> entity = <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;DrawPoint&#x27;</span>,</span><br><span class="line">      <span class="attr">position</span>: <span class="variable language_">this</span>.<span class="property">positions</span>[<span class="number">0</span>],</span><br><span class="line">      <span class="attr">point</span>: &#123;</span><br><span class="line">        <span class="attr">pixelSize</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">pixelSize</span>,</span><br><span class="line">        <span class="attr">color</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">color</span>,</span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">outlineColor</span>,</span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">outlineWidth</span>,</span><br><span class="line">        <span class="attr">heightReference</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">heightReference</span>,</span><br><span class="line">        <span class="attr">disableDepthTestDistance</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">disableDepthTestDistance</span>,</span><br><span class="line">        <span class="attr">scaleByDistance</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">scaleByDistance</span>,</span><br><span class="line">        <span class="attr">distanceDisplayCondition</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">distanceDisplayCondition</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> entity</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线绘制工具</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PolylineDrawTool</span> <span class="keyword">extends</span> <span class="title class_ inherited__">CesiumDrawTool</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">viewer, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(viewer, &#123; ...options, <span class="attr">type</span>: <span class="string">&#x27;polyline&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// width: number - 线宽</span></span><br><span class="line">        <span class="attr">width</span>: <span class="number">3</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// material: Cesium.MaterialProperty - 材质</span></span><br><span class="line">        <span class="attr">material</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// clampToGround: boolean - 是否贴地</span></span><br><span class="line">        <span class="attr">clampToGround</span>: <span class="variable language_">this</span>.<span class="property">clampToGround</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// classificationType: Cesium.ClassificationType - 分类类型</span></span><br><span class="line">        <span class="attr">classificationType</span>: <span class="variable language_">this</span>.<span class="property">clampToGround</span> ? <span class="title class_">Cesium</span>.<span class="property">ClassificationType</span>.<span class="property">TERRAIN</span> : <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// shadows: Cesium.ShadowMode - 阴影模式</span></span><br><span class="line">        <span class="attr">shadows</span>: <span class="title class_">Cesium</span>.<span class="property">ShadowMode</span>.<span class="property">DISABLED</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// distanceDisplayCondition: Cesium.DistanceDisplayCondition</span></span><br><span class="line">        <span class="attr">distanceDisplayCondition</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// zIndex: number - 层级（贴地时有效）</span></span><br><span class="line">        <span class="attr">zIndex</span>: <span class="number">0</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">updateDrawing</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">positions</span>.<span class="property">length</span> &lt; <span class="number">2</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 移除之前的临时线</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">clearTempEntities</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建临时线</span></span><br><span class="line">    <span class="keyword">const</span> tempEntity = <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;TempPolyline&#x27;</span>,</span><br><span class="line">      <span class="attr">polyline</span>: &#123;</span><br><span class="line">        <span class="attr">positions</span>: <span class="variable language_">this</span>.<span class="property">positions</span>,</span><br><span class="line">        <span class="attr">width</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">width</span>,</span><br><span class="line">        <span class="attr">material</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">material</span>,</span><br><span class="line">        <span class="attr">clampToGround</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">clampToGround</span>,</span><br><span class="line">        <span class="attr">classificationType</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">classificationType</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tempEntities</span>.<span class="title function_">push</span>(tempEntity)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">updatePreview</span>(<span class="params">position</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">positions</span>.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建预览位置数组</span></span><br><span class="line">    <span class="keyword">const</span> previewPositions = [...<span class="variable language_">this</span>.<span class="property">positions</span>, position]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新临时线的位置</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">tempEntities</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">tempEntities</span>[<span class="number">0</span>].<span class="property">polyline</span>.<span class="property">positions</span> = previewPositions</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createFinalEntity</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> entity = <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;DrawPolyline&#x27;</span>,</span><br><span class="line">      <span class="attr">polyline</span>: &#123;</span><br><span class="line">        <span class="attr">positions</span>: <span class="variable language_">this</span>.<span class="property">positions</span>,</span><br><span class="line">        <span class="attr">width</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">width</span>,</span><br><span class="line">        <span class="attr">material</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">material</span>,</span><br><span class="line">        <span class="attr">clampToGround</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">clampToGround</span>,</span><br><span class="line">        <span class="attr">classificationType</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">classificationType</span>,</span><br><span class="line">        <span class="attr">shadows</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">shadows</span>,</span><br><span class="line">        <span class="attr">distanceDisplayCondition</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">distanceDisplayCondition</span>,</span><br><span class="line">        <span class="attr">zIndex</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">zIndex</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> entity</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 面绘制工具</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PolygonDrawTool</span> <span class="keyword">extends</span> <span class="title class_ inherited__">CesiumDrawTool</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">viewer, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(viewer, &#123; ...options, <span class="attr">type</span>: <span class="string">&#x27;polygon&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// material: Cesium.MaterialProperty - 填充材质</span></span><br><span class="line">        <span class="attr">material</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>.<span class="title function_">withAlpha</span>(<span class="number">0.5</span>),</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outline: boolean - 是否显示轮廓</span></span><br><span class="line">        <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outlineColor: Cesium.Color - 轮廓颜色</span></span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outlineWidth: number - 轮廓宽度</span></span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// height: number - 高度</span></span><br><span class="line">        <span class="attr">height</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// extrudedHeight: number - 拉伸高度</span></span><br><span class="line">        <span class="attr">extrudedHeight</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// heightReference: Cesium.HeightReference - 高度参考</span></span><br><span class="line">        <span class="attr">heightReference</span>: <span class="variable language_">this</span>.<span class="property">clampToGround</span></span><br><span class="line">          ? <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">CLAMP_TO_GROUND</span></span><br><span class="line">          : <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">NONE</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// extrudedHeightReference: Cesium.HeightReference - 拉伸高度参考</span></span><br><span class="line">        <span class="attr">extrudedHeightReference</span>: <span class="title class_">Cesium</span>.<span class="property">HeightReference</span>.<span class="property">NONE</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// fill: boolean - 是否填充</span></span><br><span class="line">        <span class="attr">fill</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// shadows: Cesium.ShadowMode - 阴影模式</span></span><br><span class="line">        <span class="attr">shadows</span>: <span class="title class_">Cesium</span>.<span class="property">ShadowMode</span>.<span class="property">DISABLED</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// distanceDisplayCondition: Cesium.DistanceDisplayCondition</span></span><br><span class="line">        <span class="attr">distanceDisplayCondition</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// classificationType: Cesium.ClassificationType - 分类类型</span></span><br><span class="line">        <span class="attr">classificationType</span>: <span class="variable language_">this</span>.<span class="property">clampToGround</span> ? <span class="title class_">Cesium</span>.<span class="property">ClassificationType</span>.<span class="property">TERRAIN</span> : <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// zIndex: number - 层级</span></span><br><span class="line">        <span class="attr">zIndex</span>: <span class="number">0</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">updateDrawing</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">positions</span>.<span class="property">length</span> &lt; <span class="number">3</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">clearTempEntities</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> tempEntity = <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;TempPolygon&#x27;</span>,</span><br><span class="line">      <span class="attr">polygon</span>: &#123;</span><br><span class="line">        <span class="attr">hierarchy</span>: <span class="variable language_">this</span>.<span class="property">positions</span>,</span><br><span class="line">        <span class="attr">material</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">material</span>,</span><br><span class="line">        <span class="attr">outline</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">outline</span>,</span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">outlineColor</span>,</span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">outlineWidth</span>,</span><br><span class="line">        <span class="attr">height</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">height</span>,</span><br><span class="line">        <span class="attr">heightReference</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">heightReference</span>,</span><br><span class="line">        <span class="attr">fill</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">fill</span>,</span><br><span class="line">        <span class="attr">classificationType</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">classificationType</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tempEntities</span>.<span class="title function_">push</span>(tempEntity)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">updatePreview</span>(<span class="params">position</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">positions</span>.<span class="property">length</span> &lt; <span class="number">2</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> previewPositions = [...<span class="variable language_">this</span>.<span class="property">positions</span>, position]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">tempEntities</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">tempEntities</span>[<span class="number">0</span>].<span class="property">polygon</span>.<span class="property">hierarchy</span> = previewPositions</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createFinalEntity</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> entity = <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;DrawPolygon&#x27;</span>,</span><br><span class="line">      <span class="attr">polygon</span>: &#123;</span><br><span class="line">        <span class="attr">hierarchy</span>: <span class="variable language_">this</span>.<span class="property">positions</span>,</span><br><span class="line">        <span class="attr">material</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">material</span>,</span><br><span class="line">        <span class="attr">outline</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">outline</span>,</span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">outlineColor</span>,</span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">outlineWidth</span>,</span><br><span class="line">        <span class="attr">height</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">height</span>,</span><br><span class="line">        <span class="attr">extrudedHeight</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">extrudedHeight</span>,</span><br><span class="line">        <span class="attr">heightReference</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">heightReference</span>,</span><br><span class="line">        <span class="attr">extrudedHeightReference</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">extrudedHeightReference</span>,</span><br><span class="line">        <span class="attr">fill</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">fill</span>,</span><br><span class="line">        <span class="attr">shadows</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">shadows</span>,</span><br><span class="line">        <span class="attr">distanceDisplayCondition</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">distanceDisplayCondition</span>,</span><br><span class="line">        <span class="attr">classificationType</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">classificationType</span>,</span><br><span class="line">        <span class="attr">zIndex</span>: <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">zIndex</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> entity</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="绘制管理器"><a href="#绘制管理器" class="headerlink" title="绘制管理器"></a>绘制管理器</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cesium绘制管理器</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CesiumDrawManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">viewer, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span> = viewer</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span> = options</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前激活的绘制工具</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">activeTool</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绘制工具实例</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tools</span> = &#123;</span><br><span class="line">      <span class="attr">point</span>: <span class="keyword">new</span> <span class="title class_">PointDrawTool</span>(viewer),</span><br><span class="line">      <span class="attr">polyline</span>: <span class="keyword">new</span> <span class="title class_">PolylineDrawTool</span>(viewer),</span><br><span class="line">      <span class="attr">polygon</span>: <span class="keyword">new</span> <span class="title class_">PolygonDrawTool</span>(viewer),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绘制结果存储</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawResults</span> = []</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绑定事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">bindToolEvents</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 绑定工具事件</span></span><br><span class="line">  <span class="title function_">bindToolEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">values</span>(<span class="variable language_">this</span>.<span class="property">tools</span>).<span class="title function_">forEach</span>(<span class="function">(<span class="params">tool</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 重写完成事件</span></span><br><span class="line">      <span class="keyword">const</span> originalOnComplete = tool.<span class="property">onComplete</span>.<span class="title function_">bind</span>(tool)</span><br><span class="line">      tool.<span class="property">onComplete</span> = <span class="function">(<span class="params">entity</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">originalOnComplete</span>(entity)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">onDrawComplete</span>(entity, tool.<span class="property">type</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 开始绘制</span></span><br><span class="line">  <span class="title function_">startDraw</span>(<span class="params">type, style = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// 停止当前绘制</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">stopDraw</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查工具类型</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">tools</span>[type]) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;不支持的绘制类型:&#x27;</span>, type)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新工具样式</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Object</span>.<span class="title function_">keys</span>(style).<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="variable language_">this</span>.<span class="property">tools</span>[type].<span class="property">style</span>, style)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 激活工具</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">activeTool</span> = <span class="variable language_">this</span>.<span class="property">tools</span>[type]</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">activeTool</span>.<span class="title function_">activate</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`开始绘制 <span class="subst">$&#123;type&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 停止绘制</span></span><br><span class="line">  <span class="title function_">stopDraw</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">activeTool</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">activeTool</span>.<span class="title function_">deactivate</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">activeTool</span> = <span class="literal">null</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;停止绘制&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 绘制完成处理</span></span><br><span class="line">  <span class="title function_">onDrawComplete</span>(<span class="params">entity, type</span>) &#123;</span><br><span class="line">    <span class="comment">// 添加到结果数组</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawResults</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">      <span class="attr">entity</span>: entity,</span><br><span class="line">      <span class="attr">type</span>: type,</span><br><span class="line">      <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">      <span class="attr">id</span>: entity.<span class="property">id</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;type&#125;</span> 绘制完成`</span>, entity)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清空所有绘制</span></span><br><span class="line">  <span class="title function_">clearAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawResults</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">entities</span>.<span class="title function_">remove</span>(result.<span class="property">entity</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawResults</span> = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 撤销上一步绘制</span></span><br><span class="line">  <span class="title function_">undo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">drawResults</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> lastResult = <span class="variable language_">this</span>.<span class="property">drawResults</span>.<span class="title function_">pop</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">entities</span>.<span class="title function_">remove</span>(lastResult.<span class="property">entity</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="绘制工具栏"><a href="#绘制工具栏" class="headerlink" title="绘制工具栏"></a>绘制工具栏</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 绘制工具栏控件</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DrawToolbar</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">viewer, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span> = viewer</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawManager</span> = <span class="keyword">new</span> <span class="title class_">CesiumDrawManager</span>(viewer, options)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 工具栏配置</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tools</span> = options.<span class="property">tools</span> || [</span><br><span class="line">      &#123; <span class="attr">type</span>: <span class="string">&#x27;point&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;点&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;📍&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;绘制点&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">type</span>: <span class="string">&#x27;polyline&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;线&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;📝&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;绘制线&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">type</span>: <span class="string">&#x27;polygon&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;面&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;🔲&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;绘制多边形&#x27;</span> &#125;,</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">container</span> = <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">activeToolType</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createToolbar</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建工具栏</span></span><br><span class="line">  <span class="title function_">createToolbar</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 创建容器</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">container</span> = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">container</span>.<span class="property">className</span> = <span class="string">&#x27;cesium-draw-toolbar&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置样式</span></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="variable language_">this</span>.<span class="property">container</span>.<span class="property">style</span>, &#123;</span><br><span class="line">      <span class="attr">position</span>: <span class="string">&#x27;absolute&#x27;</span>,</span><br><span class="line">      <span class="attr">top</span>: <span class="string">&#x27;10px&#x27;</span>,</span><br><span class="line">      <span class="attr">left</span>: <span class="string">&#x27;10px&#x27;</span>,</span><br><span class="line">      <span class="attr">zIndex</span>: <span class="string">&#x27;1000&#x27;</span>,</span><br><span class="line">      <span class="attr">backgroundColor</span>: <span class="string">&#x27;rgba(42, 42, 42, 0.9)&#x27;</span>,</span><br><span class="line">      <span class="attr">borderRadius</span>: <span class="string">&#x27;5px&#x27;</span>,</span><br><span class="line">      <span class="attr">padding</span>: <span class="string">&#x27;8px&#x27;</span>,</span><br><span class="line">      <span class="attr">display</span>: <span class="string">&#x27;flex&#x27;</span>,</span><br><span class="line">      <span class="attr">flexDirection</span>: <span class="string">&#x27;column&#x27;</span>,</span><br><span class="line">      <span class="attr">gap</span>: <span class="string">&#x27;4px&#x27;</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建工具按钮</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createToolButtons</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建操作按钮</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createActionButtons</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加到页面</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="property">container</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建工具按钮</span></span><br><span class="line">  <span class="title function_">createToolButtons</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tools</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">tool</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> button = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;button&#x27;</span>)</span><br><span class="line">      button.<span class="property">innerHTML</span> = <span class="string">`<span class="subst">$&#123;tool.icon&#125;</span> <span class="subst">$&#123;tool.name&#125;</span>`</span></span><br><span class="line">      button.<span class="property">title</span> = tool.<span class="property">title</span></span><br><span class="line"></span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">assign</span>(button.<span class="property">style</span>, &#123;</span><br><span class="line">        <span class="attr">padding</span>: <span class="string">&#x27;6px 12px&#x27;</span>,</span><br><span class="line">        <span class="attr">border</span>: <span class="string">&#x27;none&#x27;</span>,</span><br><span class="line">        <span class="attr">borderRadius</span>: <span class="string">&#x27;3px&#x27;</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;transparent&#x27;</span>,</span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">        <span class="attr">cursor</span>: <span class="string">&#x27;pointer&#x27;</span>,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      button.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">selectTool</span>(tool.<span class="property">type</span>, button)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">container</span>.<span class="title function_">appendChild</span>(button)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建操作按钮</span></span><br><span class="line">  <span class="title function_">createActionButtons</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> actions = [</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">&#x27;停止&#x27;</span>, <span class="attr">action</span>: <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">stopDraw</span>() &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">&#x27;撤销&#x27;</span>, <span class="attr">action</span>: <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">drawManager</span>.<span class="title function_">undo</span>() &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">&#x27;清空&#x27;</span>, <span class="attr">action</span>: <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">drawManager</span>.<span class="title function_">clearAll</span>() &#125;,</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    actions.<span class="title function_">forEach</span>(<span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> button = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;button&#x27;</span>)</span><br><span class="line">      button.<span class="property">innerHTML</span> = action.<span class="property">name</span></span><br><span class="line"></span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">assign</span>(button.<span class="property">style</span>, &#123;</span><br><span class="line">        <span class="attr">padding</span>: <span class="string">&#x27;4px 8px&#x27;</span>,</span><br><span class="line">        <span class="attr">border</span>: <span class="string">&#x27;none&#x27;</span>,</span><br><span class="line">        <span class="attr">borderRadius</span>: <span class="string">&#x27;3px&#x27;</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;transparent&#x27;</span>,</span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">        <span class="attr">cursor</span>: <span class="string">&#x27;pointer&#x27;</span>,</span><br><span class="line">        <span class="attr">fontSize</span>: <span class="string">&#x27;11px&#x27;</span>,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      button.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, action.<span class="property">action</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">container</span>.<span class="title function_">appendChild</span>(button)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 选择工具</span></span><br><span class="line">  <span class="title function_">selectTool</span>(<span class="params">toolType, buttonElement</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">activeToolType</span> === toolType) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">stopDraw</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">activeToolType</span> = toolType</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawManager</span>.<span class="title function_">startDraw</span>(toolType)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 停止绘制</span></span><br><span class="line">  <span class="title function_">stopDraw</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">activeToolType</span> = <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawManager</span>.<span class="title function_">stopDraw</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> viewer = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Viewer</span>(<span class="string">&#x27;cesiumContainer&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> drawToolbar = <span class="keyword">new</span> <span class="title class_">DrawToolbar</span>(viewer)</span><br></pre></td></tr></table></figure><h2 id="⚡-性能优化详解"><a href="#⚡-性能优化详解" class="headerlink" title="⚡ 性能优化详解"></a>⚡ 性能优化详解</h2><h3 id="📋-目录-1"><a href="#📋-目录-1" class="headerlink" title="📋 目录"></a>📋 目录</h3><ul><li><a href="#%E6%B8%B2%E6%9F%93%E4%BC%98%E5%8C%96">渲染优化</a></li><li><a href="#%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86">内存管理</a></li><li><a href="#%E4%BA%8B%E4%BB%B6%E4%BC%98%E5%8C%96">事件优化</a></li><li><a href="#%E6%82%AC%E5%81%9C%E4%BA%8B%E4%BB%B6%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">悬停事件性能优化</a></li><li><a href="#%E5%BC%82%E6%AD%A5%E5%8A%A0%E8%BD%BD%E4%BC%98%E5%8C%96">异步加载优化</a></li><li><a href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93">最佳实践总结</a></li></ul><hr><h3 id="🎯-渲染优化"><a href="#🎯-渲染优化" class="headerlink" title="🎯 渲染优化"></a>🎯 渲染优化</h3><h4 id="1-按需渲染-On-Demand-Rendering"><a href="#1-按需渲染-On-Demand-Rendering" class="headerlink" title="1. 按需渲染 (On-Demand Rendering)"></a>1. 按需渲染 (On-Demand Rendering)</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启用按需渲染模式</span></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">requestRenderMode</span> = <span class="literal">true</span></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">maximumRenderTimeChange</span> = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 手动触发渲染函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">requestRenderIfNeeded</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (needsUpdate) &#123;</span><br><span class="line">    viewer.<span class="property">scene</span>.<span class="title function_">requestRender</span>()</span><br><span class="line">    needsUpdate = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听数据变化，自动触发渲染</span></span><br><span class="line">viewer.<span class="property">entities</span>.<span class="property">collectionChanged</span>.<span class="title function_">addEventListener</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  needsUpdate = <span class="literal">true</span></span><br><span class="line">  <span class="title function_">requestRenderIfNeeded</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="2-LOD-Level-of-Detail-优化"><a href="#2-LOD-Level-of-Detail-优化" class="headerlink" title="2. LOD (Level of Detail) 优化"></a>2. LOD (Level of Detail) 优化</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 降低地形细节，提升性能</span></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">globe</span>.<span class="property">maximumScreenSpaceError</span> = <span class="number">1</span></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">globe</span>.<span class="property">tileCacheSize</span> = <span class="number">200</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 视锥剔除优化</span></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">globe</span>.<span class="property">showSkirts</span> = <span class="literal">false</span> <span class="comment">// 禁用地形裙边</span></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">fog</span>.<span class="property">enabled</span> = <span class="literal">true</span> <span class="comment">// 启用雾效隐藏远处细节</span></span><br></pre></td></tr></table></figure><h4 id="3-实体优化-Entity-Optimization"><a href="#3-实体优化-Entity-Optimization" class="headerlink" title="3. 实体优化 (Entity Optimization)"></a>3. 实体优化 (Entity Optimization)</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 Primitive 替代大量 Entity，提升性能</span></span><br><span class="line"><span class="keyword">const</span> instances = []</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">  instances.<span class="title function_">push</span>(</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">GeometryInstance</span>(&#123;</span><br><span class="line">      <span class="attr">geometry</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">BoxGeometry</span>(&#123;</span><br><span class="line">        <span class="attr">dimensions</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">100</span>, <span class="number">100</span>, <span class="number">100</span>),</span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="attr">modelMatrix</span>: <span class="title class_">Cesium</span>.<span class="property">Matrix4</span>.<span class="title function_">multiplyByTranslation</span>(</span><br><span class="line">        <span class="title class_">Cesium</span>.<span class="property">Transforms</span>.<span class="title function_">eastNorthUpToFixedFrame</span>(</span><br><span class="line">          <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(</span><br><span class="line">            <span class="number">116.4074</span> + (<span class="title class_">Math</span>.<span class="title function_">random</span>() - <span class="number">0.5</span>) * <span class="number">0.1</span>,</span><br><span class="line">            <span class="number">39.9042</span> + (<span class="title class_">Math</span>.<span class="title function_">random</span>() - <span class="number">0.5</span>) * <span class="number">0.1</span>,</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">50</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Matrix4</span>(),</span><br><span class="line">      ),</span><br><span class="line">      <span class="attr">attributes</span>: &#123;</span><br><span class="line">        <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">ColorGeometryInstanceAttribute</span>.<span class="title function_">fromColor</span>(<span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="title function_">fromRandom</span>()),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;),</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> primitive = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Primitive</span>(&#123;</span><br><span class="line">  <span class="attr">geometryInstances</span>: instances,</span><br><span class="line">  <span class="attr">appearance</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PerInstanceColorAppearance</span>(&#123;</span><br><span class="line">    <span class="attr">translucent</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">closed</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">primitives</span>.<span class="title function_">add</span>(primitive)</span><br></pre></td></tr></table></figure><h4 id="4-聚类优化-Clustering"><a href="#4-聚类优化-Clustering" class="headerlink" title="4. 聚类优化 (Clustering)"></a>4. 聚类优化 (Clustering)</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启用聚类功能，减少渲染负担</span></span><br><span class="line"><span class="keyword">const</span> dataSource = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">CustomDataSource</span>(<span class="string">&#x27;优化数据源&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> clustering = dataSource.<span class="property">clustering</span></span><br><span class="line"></span><br><span class="line">clustering.<span class="property">enabled</span> = <span class="literal">true</span></span><br><span class="line">clustering.<span class="property">pixelRange</span> = <span class="number">15</span></span><br><span class="line">clustering.<span class="property">minimumClusterSize</span> = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义聚类样式</span></span><br><span class="line">clustering.<span class="property">clusterEvent</span>.<span class="title function_">addEventListener</span>(<span class="function">(<span class="params">clusteredEntities, cluster</span>) =&gt;</span> &#123;</span><br><span class="line">  cluster.<span class="property">label</span>.<span class="property">show</span> = <span class="literal">true</span></span><br><span class="line">  cluster.<span class="property">label</span>.<span class="property">text</span> = clusteredEntities.<span class="property">length</span>.<span class="title function_">toString</span>()</span><br><span class="line">  cluster.<span class="property">billboard</span>.<span class="property">show</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  cluster.<span class="property">point</span> = &#123;</span><br><span class="line">    <span class="attr">pixelSize</span>: <span class="title class_">Math</span>.<span class="title function_">min</span>(clusteredEntities.<span class="property">length</span> * <span class="number">2</span> + <span class="number">10</span>, <span class="number">50</span>),</span><br><span class="line">    <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>,</span><br><span class="line">    <span class="attr">outlineColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">BLACK</span>,</span><br><span class="line">    <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="5-材质优化-Material-Optimization"><a href="#5-材质优化-Material-Optimization" class="headerlink" title="5. 材质优化 (Material Optimization)"></a>5. 材质优化 (Material Optimization)</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用颜色而非纹理，减少内存占用</span></span><br><span class="line"><span class="keyword">const</span> colorMaterial = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span></span><br><span class="line"><span class="keyword">const</span> imageMaterial = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ImageMaterialProperty</span>(&#123;</span><br><span class="line">  <span class="attr">image</span>: <span class="string">&#x27;texture.jpg&#x27;</span>, <span class="comment">// 避免大纹理</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="6-模型优化-Model-Optimization"><a href="#6-模型优化-Model-Optimization" class="headerlink" title="6. 模型优化 (Model Optimization)"></a>6. 模型优化 (Model Optimization)</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 优化3D模型加载和渲染</span></span><br><span class="line"><span class="keyword">const</span> optimizedModel = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>),</span><br><span class="line">  <span class="attr">model</span>: &#123;</span><br><span class="line">    <span class="attr">uri</span>: <span class="string">&#x27;./models/optimized.glb&#x27;</span>, <span class="comment">// 使用 glb 格式</span></span><br><span class="line">    <span class="attr">scale</span>: <span class="number">1.0</span>,</span><br><span class="line">    <span class="attr">minimumPixelSize</span>: <span class="number">128</span>, <span class="comment">// 设置最小像素大小</span></span><br><span class="line">    <span class="attr">maximumScale</span>: <span class="number">20000</span>, <span class="comment">// 限制最大缩放</span></span><br><span class="line">    <span class="attr">incrementallyLoadTextures</span>: <span class="literal">true</span>, <span class="comment">// 渐进式纹理加载</span></span><br><span class="line">    <span class="attr">runAnimations</span>: <span class="literal">false</span>, <span class="comment">// 禁用不必要的动画</span></span><br><span class="line">    <span class="attr">clampAnimations</span>: <span class="literal">true</span>, <span class="comment">// 限制动画</span></span><br><span class="line">    <span class="attr">shadows</span>: <span class="title class_">Cesium</span>.<span class="property">ShadowMode</span>.<span class="property">DISABLED</span>, <span class="comment">// 禁用阴影</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><hr><h3 id="💾-内存管理"><a href="#💾-内存管理" class="headerlink" title="💾 内存管理"></a>💾 内存管理</h3><h4 id="1-资源清理机制"><a href="#1-资源清理机制" class="headerlink" title="1. 资源清理机制"></a>1. 资源清理机制</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定期清理未使用的资源</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">cleanupResources</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 清理实体</span></span><br><span class="line">  <span class="keyword">const</span> entities = viewer.<span class="property">entities</span>.<span class="property">values</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = entities.<span class="property">length</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    <span class="keyword">const</span> entity = entities[i]</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isEntityVisible</span>(entity)) &#123;</span><br><span class="line">      viewer.<span class="property">entities</span>.<span class="title function_">remove</span>(entity)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清理图元</span></span><br><span class="line">  <span class="keyword">const</span> primitives = viewer.<span class="property">scene</span>.<span class="property">primitives</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = primitives.<span class="property">length</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    <span class="keyword">const</span> primitive = primitives.<span class="title function_">get</span>(i)</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isPrimitiveVisible</span>(primitive)) &#123;</span><br><span class="line">      primitives.<span class="title function_">remove</span>(primitive)</span><br><span class="line">      <span class="keyword">if</span> (!primitive.<span class="title function_">isDestroyed</span>()) &#123;</span><br><span class="line">        primitive.<span class="title function_">destroy</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 强制垃圾回收</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">gc</span>) &#123;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">gc</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查实体可见性</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isEntityVisible</span>(<span class="params">entity</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> position = entity.<span class="property">position</span></span><br><span class="line">  <span class="keyword">if</span> (!position) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> cartesian = position.<span class="title function_">getValue</span>(viewer.<span class="property">clock</span>.<span class="property">currentTime</span>)</span><br><span class="line">  <span class="keyword">if</span> (!cartesian) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> distance = <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">distance</span>(cartesian, viewer.<span class="property">camera</span>.<span class="property">position</span>)</span><br><span class="line">  <span class="keyword">return</span> distance &lt; <span class="number">10000000</span> <span class="comment">// 10,000 km</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查图元可见性</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isPrimitiveVisible</span>(<span class="params">primitive</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> primitive.<span class="property">show</span> &amp;&amp; !primitive.<span class="title function_">isDestroyed</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定期清理（每30秒执行一次）</span></span><br><span class="line"><span class="built_in">setInterval</span>(cleanupResources, <span class="number">30000</span>)</span><br></pre></td></tr></table></figure><h4 id="2-内存监控"><a href="#2-内存监控" class="headerlink" title="2. 内存监控"></a>2. 内存监控</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 内存使用监控</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">monitorMemoryUsage</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (performance.<span class="property">memory</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> memoryInfo = &#123;</span><br><span class="line">      <span class="attr">usedJSHeapSize</span>: performance.<span class="property">memory</span>.<span class="property">usedJSHeapSize</span> / <span class="number">1024</span> / <span class="number">1024</span>, <span class="comment">// MB</span></span><br><span class="line">      <span class="attr">totalJSHeapSize</span>: performance.<span class="property">memory</span>.<span class="property">totalJSHeapSize</span> / <span class="number">1024</span> / <span class="number">1024</span>, <span class="comment">// MB</span></span><br><span class="line">      <span class="attr">jsHeapSizeLimit</span>: performance.<span class="property">memory</span>.<span class="property">jsHeapSizeLimit</span> / <span class="number">1024</span> / <span class="number">1024</span>, <span class="comment">// MB</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;内存使用情况:&#x27;</span>, memoryInfo)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内存使用超过80%时发出警告</span></span><br><span class="line">    <span class="keyword">if</span> (memoryInfo.<span class="property">usedJSHeapSize</span> / memoryInfo.<span class="property">jsHeapSizeLimit</span> &gt; <span class="number">0.8</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;⚠️ 内存使用率过高，建议清理资源&#x27;</span>)</span><br><span class="line">      <span class="title function_">cleanupResources</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定期监控内存</span></span><br><span class="line"><span class="built_in">setInterval</span>(monitorMemoryUsage, <span class="number">10000</span>) <span class="comment">// 每10秒检查一次</span></span><br></pre></td></tr></table></figure><hr><h3 id="🎮-事件优化"><a href="#🎮-事件优化" class="headerlink" title="🎮 事件优化"></a>🎮 事件优化</h3><h4 id="1-事件节流-Event-Throttling"><a href="#1-事件节流-Event-Throttling" class="headerlink" title="1. 事件节流 (Event Throttling)"></a>1. 事件节流 (Event Throttling)</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通用节流函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">throttle</span>(<span class="params">func, limit</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> inThrottle</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> args = <span class="variable language_">arguments</span></span><br><span class="line">    <span class="keyword">const</span> context = <span class="variable language_">this</span></span><br><span class="line">    <span class="keyword">if</span> (!inThrottle) &#123;</span><br><span class="line">      func.<span class="title function_">apply</span>(context, args)</span><br><span class="line">      inThrottle = <span class="literal">true</span></span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> (inThrottle = <span class="literal">false</span>), limit)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 节流鼠标移动事件</span></span><br><span class="line"><span class="keyword">const</span> throttledMouseMove = <span class="title function_">throttle</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> pickedObject = viewer.<span class="property">scene</span>.<span class="title function_">pick</span>(event.<span class="property">endPosition</span>)</span><br><span class="line">  <span class="title function_">updateTooltip</span>(pickedObject)</span><br><span class="line">&#125;, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">viewer.<span class="property">cesiumWidget</span>.<span class="property">screenSpaceEventHandler</span>.<span class="title function_">setInputAction</span>(</span><br><span class="line">  throttledMouseMove,</span><br><span class="line">  <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">MOUSE_MOVE</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h4 id="2-事件委托-Event-Delegation"><a href="#2-事件委托-Event-Delegation" class="headerlink" title="2. 事件委托 (Event Delegation)"></a>2. 事件委托 (Event Delegation)</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用事件委托减少事件监听器数量</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setupEventDelegation</span>(<span class="params"></span>) &#123;</span><br><span class="line">  viewer.<span class="property">cesiumWidget</span>.<span class="property">screenSpaceEventHandler</span>.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> pickedObject = viewer.<span class="property">scene</span>.<span class="title function_">pick</span>(event.<span class="property">position</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pickedObject &amp;&amp; pickedObject.<span class="property">id</span>) &#123;</span><br><span class="line">      <span class="comment">// 统一处理所有实体点击事件</span></span><br><span class="line">      <span class="title function_">handleEntityClick</span>(pickedObject.<span class="property">id</span>, event)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">LEFT_CLICK</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handleEntityClick</span>(<span class="params">entity, event</span>) &#123;</span><br><span class="line">  <span class="comment">// 根据实体类型执行不同操作</span></span><br><span class="line">  <span class="keyword">switch</span> (entity.<span class="property">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;point&#x27;</span>:</span><br><span class="line">      <span class="title function_">showPointInfo</span>(entity)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;polygon&#x27;</span>:</span><br><span class="line">      <span class="title function_">showPolygonInfo</span>(entity)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;line&#x27;</span>:</span><br><span class="line">      <span class="title function_">showLineInfo</span>(entity)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;未知实体类型:&#x27;</span>, entity.<span class="property">type</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="🎯-悬停事件性能优化"><a href="#🎯-悬停事件性能优化" class="headerlink" title="🎯 悬停事件性能优化"></a>🎯 悬停事件性能优化</h3><h4 id="📊-问题分析"><a href="#📊-问题分析" class="headerlink" title="📊 问题分析"></a>📊 问题分析</h4><p>在点位数量过多时，<code>setupHoverEvents</code> 函数会导致地图移动卡顿，主要问题包括：</p><ol><li><strong>频繁的鼠标移动事件处理</strong>：每次鼠标移动都会触发 <code>viewer.scene.pick()</code> 操作</li><li><strong>复杂的点位查找逻辑</strong>：在 <code>handlePointHover</code> 中有复杂的字符串解析和数组查找</li><li><strong>缺乏节流机制</strong>：没有对鼠标移动事件进行节流处理</li><li><strong>大量实体的拾取开销</strong>：当点位数量多时，拾取操作的开销会显著增加</li></ol><h4 id="🚀-优化方案实现"><a href="#🚀-优化方案实现" class="headerlink" title="🚀 优化方案实现"></a>🚀 优化方案实现</h4><h5 id="1-节流机制-Throttling"><a href="#1-节流机制-Throttling" class="headerlink" title="1. 节流机制 (Throttling)"></a>1. 节流机制 (Throttling)</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 动态调整节流参数</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getThrottleInterval</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> pointCount = pointsData.<span class="property">value</span>.<span class="property">length</span></span><br><span class="line">  <span class="keyword">if</span> (pointCount &gt; <span class="variable constant_">HIGH_PERFORMANCE_THRESHOLD</span>) &#123;</span><br><span class="line">    isHighPerformanceMode = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">25</span> <span class="comment">// 点位多时，降低处理频率到40fps</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    isHighPerformanceMode = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">16</span> <span class="comment">// 点位少时，保持60fps</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置鼠标悬停事件</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">setupHoverEvents</span> = (<span class="params">Cesium</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (hoverHandler) &#123;</span><br><span class="line">    hoverHandler.<span class="title function_">destroy</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hoverHandler = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ScreenSpaceEventHandler</span>(viewer.<span class="property">scene</span>.<span class="property">canvas</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加节流机制</span></span><br><span class="line">  <span class="keyword">let</span> lastHoverTime = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> lastPickedObject = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 鼠标移动事件</span></span><br><span class="line">  hoverHandler.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> currentTime = performance.<span class="title function_">now</span>()</span><br><span class="line">    <span class="keyword">const</span> hoverThrottle = <span class="title function_">getThrottleInterval</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 节流处理：限制处理频率</span></span><br><span class="line">    <span class="keyword">if</span> (currentTime - lastHoverTime &lt; hoverThrottle) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    lastHoverTime = currentTime</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 高性能模式下的优化</span></span><br><span class="line">    <span class="keyword">if</span> (isHighPerformanceMode) &#123;</span><br><span class="line">      <span class="comment">// 在高性能模式下，适度减少处理频率</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title class_">Math</span>.<span class="title function_">random</span>() &gt; <span class="number">0.05</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 requestAnimationFrame 来优化性能</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">requestAnimationFrame</span>) &#123;</span><br><span class="line">      <span class="variable language_">window</span>.<span class="title function_">requestAnimationFrame</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> pickedObject = viewer.<span class="property">scene</span>.<span class="title function_">pick</span>(event.<span class="property">endPosition</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 避免重复处理相同的对象</span></span><br><span class="line">        <span class="keyword">if</span> (pickedObject === lastPickedObject) &#123;</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        lastPickedObject = pickedObject</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isValidPointObject</span>(pickedObject)) &#123;</span><br><span class="line">          <span class="title function_">handlePointHover</span>(pickedObject)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="title function_">handlePointLeave</span>()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 降级处理</span></span><br><span class="line">      <span class="keyword">const</span> pickedObject = viewer.<span class="property">scene</span>.<span class="title function_">pick</span>(event.<span class="property">endPosition</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (pickedObject === lastPickedObject) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      lastPickedObject = pickedObject</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isValidPointObject</span>(pickedObject)) &#123;</span><br><span class="line">        <span class="title function_">handlePointHover</span>(pickedObject)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">handlePointLeave</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">MOUSE_MOVE</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-缓存机制-Caching"><a href="#2-缓存机制-Caching" class="headerlink" title="2. 缓存机制 (Caching)"></a>2. 缓存机制 (Caching)</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加缓存机制</span></span><br><span class="line"><span class="keyword">const</span> pointCache = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handlePointHover</span> = (<span class="params">pickedObject</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 取消之前的隐藏定时器</span></span><br><span class="line">  <span class="title function_">clearHideTooltipTimer</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> entityId = pickedObject.<span class="property">id</span>.<span class="property">id</span>.<span class="title function_">toString</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 检查缓存</span></span><br><span class="line">  <span class="keyword">let</span> cached = pointCache.<span class="title function_">get</span>(entityId)</span><br><span class="line">  <span class="keyword">if</span> (cached) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; point, isParentPoint &#125; = cached</span><br><span class="line">    <span class="keyword">if</span> (point) &#123;</span><br><span class="line">      hoveredPoint.<span class="property">value</span> = point</span><br><span class="line">      <span class="comment">// 根据判断结果设置当前层级（如果需要）</span></span><br><span class="line">      <span class="keyword">if</span> (isParentPoint &amp;&amp; currentLevel.<span class="property">value</span> !== <span class="string">&#x27;parent&#x27;</span>) &#123;</span><br><span class="line">        currentLevel.<span class="property">value</span> = <span class="string">&#x27;parent&#x27;</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isParentPoint &amp;&amp; currentLevel.<span class="property">value</span> !== <span class="string">&#x27;child&#x27;</span>) &#123;</span><br><span class="line">        currentLevel.<span class="property">value</span> = <span class="string">&#x27;child&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">updateTooltipPosition</span>(pickedObject)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> point = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">let</span> isParentPoint = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 智能区分父点位和子点位</span></span><br><span class="line">  <span class="keyword">if</span> (entityId.<span class="title function_">startsWith</span>(<span class="string">&#x27;point_&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">const</span> pointId = <span class="built_in">parseInt</span>(entityId.<span class="title function_">replace</span>(<span class="string">&#x27;point_&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">    point = pointsData.<span class="property">value</span>.<span class="title function_">find</span>(<span class="function">(<span class="params">p</span>) =&gt;</span> p.<span class="property">id</span> === pointId) || <span class="literal">null</span></span><br><span class="line">    isParentPoint = <span class="literal">true</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (entityId.<span class="title function_">startsWith</span>(<span class="string">&#x27;child_&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">const</span> childId = <span class="built_in">parseInt</span>(entityId.<span class="title function_">replace</span>(<span class="string">&#x27;child_&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">    <span class="keyword">const</span> parentId = <span class="title class_">Math</span>.<span class="title function_">floor</span>(childId / <span class="number">100</span>)</span><br><span class="line">    <span class="keyword">const</span> parentPoint = pointsData.<span class="property">value</span>.<span class="title function_">find</span>(<span class="function">(<span class="params">p</span>) =&gt;</span> p.<span class="property">id</span> === parentId)</span><br><span class="line">    <span class="keyword">if</span> (parentPoint?.<span class="property">children</span>) &#123;</span><br><span class="line">      point = parentPoint.<span class="property">children</span>.<span class="title function_">find</span>(<span class="function">(<span class="params">c</span>) =&gt;</span> c.<span class="property">id</span> === childId) || <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    isParentPoint = <span class="literal">false</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> pointId = <span class="built_in">parseInt</span>(entityId)</span><br><span class="line">    point = <span class="title function_">findPointById</span>(pointId)</span><br><span class="line">    <span class="keyword">if</span> (point) &#123;</span><br><span class="line">      isParentPoint = <span class="title function_">getPointTypeById</span>(pointId) === <span class="string">&#x27;parent&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 缓存结果</span></span><br><span class="line">  pointCache.<span class="title function_">set</span>(entityId, &#123; point, isParentPoint &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (point) &#123;</span><br><span class="line">    hoveredPoint.<span class="property">value</span> = point</span><br><span class="line">    <span class="keyword">if</span> (isParentPoint &amp;&amp; currentLevel.<span class="property">value</span> !== <span class="string">&#x27;parent&#x27;</span>) &#123;</span><br><span class="line">      currentLevel.<span class="property">value</span> = <span class="string">&#x27;parent&#x27;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isParentPoint &amp;&amp; currentLevel.<span class="property">value</span> !== <span class="string">&#x27;child&#x27;</span>) &#123;</span><br><span class="line">      currentLevel.<span class="property">value</span> = <span class="string">&#x27;child&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">updateTooltipPosition</span>(pickedObject)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-性能监控系统"><a href="#3-性能监控系统" class="headerlink" title="3. 性能监控系统"></a>3. 性能监控系统</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 性能监控相关</span></span><br><span class="line"><span class="keyword">let</span> performanceMonitor = <span class="literal">null</span></span><br><span class="line"><span class="keyword">let</span> isHighPerformanceMode = <span class="literal">false</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">HIGH_PERFORMANCE_THRESHOLD</span> = <span class="number">200</span> <span class="comment">// 点位数量阈值</span></span><br><span class="line"><span class="keyword">const</span> performanceStats = <span class="title function_">ref</span>(&#123;</span><br><span class="line">  <span class="attr">fps</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">memoryUsage</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">pointCount</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">isHighPerformanceMode</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 性能监控函数</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">monitorPerformance</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> pointCount = pointsData.<span class="property">value</span>.<span class="property">length</span></span><br><span class="line">  <span class="keyword">const</span> status = performanceMonitor?.<span class="title function_">getStatus</span>() || &#123;&#125;</span><br><span class="line">  <span class="keyword">const</span> currentFPS = status.<span class="property">fps</span> || <span class="number">0</span></span><br><span class="line">  <span class="keyword">const</span> memoryUsage = status.<span class="property">memoryUsage</span> || <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新性能统计</span></span><br><span class="line">  performanceStats.<span class="property">value</span> = &#123;</span><br><span class="line">    <span class="attr">fps</span>: currentFPS,</span><br><span class="line">    memoryUsage,</span><br><span class="line">    pointCount,</span><br><span class="line">    isHighPerformanceMode,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据性能指标动态调整</span></span><br><span class="line">  <span class="keyword">if</span> (pointCount &gt; <span class="variable constant_">HIGH_PERFORMANCE_THRESHOLD</span> &amp;&amp; currentFPS &lt; <span class="number">30</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`⚠️ 性能警告: 点位数量(<span class="subst">$&#123;pointCount&#125;</span>)过多，FPS(<span class="subst">$&#123;currentFPS&#125;</span>)过低`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化性能监控</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">initPerformanceMonitor</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; createPerformanceMonitor &#125; = <span class="keyword">await</span> <span class="keyword">import</span>(<span class="string">&#x27;./modules/performanceMonitor.js&#x27;</span>)</span><br><span class="line">    performanceMonitor = <span class="title function_">createPerformanceMonitor</span>()</span><br><span class="line">    performanceMonitor.<span class="title function_">start</span>()</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;✅ 性能监控已启动&#x27;</span>)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;⚠️ 性能监控模块加载失败:&#x27;</span>, error)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-动态调整策略"><a href="#4-动态调整策略" class="headerlink" title="4. 动态调整策略"></a>4. 动态调整策略</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 动态调整节流参数</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getThrottleInterval</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> pointCount = pointsData.<span class="property">value</span>.<span class="property">length</span></span><br><span class="line">  <span class="keyword">if</span> (pointCount &gt; <span class="variable constant_">HIGH_PERFORMANCE_THRESHOLD</span>) &#123;</span><br><span class="line">    isHighPerformanceMode = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">25</span> <span class="comment">// 点位多时，降低处理频率到40fps</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    isHighPerformanceMode = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">16</span> <span class="comment">// 点位少时，保持60fps</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 高性能模式下的优化</span></span><br><span class="line"><span class="keyword">if</span> (isHighPerformanceMode) &#123;</span><br><span class="line">  <span class="comment">// 在高性能模式下，适度减少处理频率</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Math</span>.<span class="title function_">random</span>() &gt; <span class="number">0.05</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="性能数据对比"><a href="#性能数据对比" class="headerlink" title="性能数据对比"></a>性能数据对比</h3><h4 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h4><ul><li><strong>点位数量</strong>: 500个</li><li><strong>高性能阈值</strong>: 200个点位</li><li><strong>节流间隔</strong>: 25ms (40fps)</li><li><strong>跳过概率</strong>: 5% (高性能模式)</li></ul><h4 id="优化前后对比"><a href="#优化前后对比" class="headerlink" title="优化前后对比"></a>优化前后对比</h4><table><thead><tr><th>指标</th><th>优化前</th><th>优化后</th><th>提升幅度</th></tr></thead><tbody><tr><td>处理频率</td><td>无限制</td><td>40fps</td><td>显著降低CPU负载</td></tr><tr><td>缓存命中率</td><td>0%</td><td>100%</td><td>避免重复计算</td></tr><tr><td>内存使用</td><td>高</td><td>低</td><td>减少重复分配</td></tr><tr><td>响应时间</td><td>不稳定</td><td>&lt;100ms</td><td>提升用户体验</td></tr><tr><td>FPS</td><td>波动大</td><td>稳定30+</td><td>保证流畅度</td></tr></tbody></table><h4 id="详细性能数据"><a href="#详细性能数据" class="headerlink" title="详细性能数据"></a>详细性能数据</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 500点位性能测试结果</span></span><br><span class="line"><span class="keyword">const</span> performanceResults = &#123;</span><br><span class="line">  <span class="comment">// 优化前</span></span><br><span class="line">  <span class="attr">beforeOptimization</span>: &#123;</span><br><span class="line">    <span class="attr">averageEventsPerSecond</span>: <span class="number">364283.44</span>,</span><br><span class="line">    <span class="attr">totalTime</span>: <span class="number">1.46</span>,</span><br><span class="line">    <span class="attr">processedEvents</span>: <span class="number">100</span>,</span><br><span class="line">    <span class="attr">memoryUsage</span>: <span class="string">&#x27;高&#x27;</span>,</span><br><span class="line">    <span class="attr">fps</span>: <span class="string">&#x27;不稳定&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 优化后</span></span><br><span class="line">  <span class="attr">afterOptimization</span>: &#123;</span><br><span class="line">    <span class="attr">averageEventsPerSecond</span>: <span class="string">&#x27;平衡处理&#x27;</span>,</span><br><span class="line">    <span class="attr">totalTime</span>: <span class="string">&#x27;显著减少&#x27;</span>,</span><br><span class="line">    <span class="attr">processedEvents</span>: <span class="string">&#x27;智能控制&#x27;</span>,</span><br><span class="line">    <span class="attr">memoryUsage</span>: <span class="string">&#x27;低&#x27;</span>,</span><br><span class="line">    <span class="attr">fps</span>: <span class="string">&#x27;稳定30+&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 优化效果</span></span><br><span class="line">  <span class="attr">improvements</span>: &#123;</span><br><span class="line">    <span class="attr">timeReduction</span>: <span class="string">&#x27;90%+&#x27;</span>,</span><br><span class="line">    <span class="attr">cacheHitRate</span>: <span class="string">&#x27;100%&#x27;</span>,</span><br><span class="line">    <span class="attr">memoryEfficiency</span>: <span class="string">&#x27;显著提升&#x27;</span>,</span><br><span class="line">    <span class="attr">userExperience</span>: <span class="string">&#x27;大幅改善&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="实际应用效果"><a href="#实际应用效果" class="headerlink" title="实际应用效果"></a>实际应用效果</h3><h4 id="用户体验改善"><a href="#用户体验改善" class="headerlink" title="用户体验改善"></a>用户体验改善</h4><ol><li><strong>地图移动流畅度</strong>: 显著减少卡顿现象</li><li><strong>悬停响应速度</strong>: 缓存机制提升响应速度</li><li><strong>实时性能反馈</strong>: 性能监控面板显示当前状态</li><li><strong>智能优化</strong>: 根据点位数量自动调整处理策略</li></ol><h4 id="性能提升"><a href="#性能提升" class="headerlink" title="性能提升"></a>性能提升</h4><ol><li><strong>处理频率优化</strong>: 从无限制到最大40fps</li><li><strong>缓存命中率</strong>: 减少重复计算，提升响应速度</li><li><strong>内存使用</strong>: 通过缓存机制减少内存分配</li><li><strong>CPU使用</strong>: 通过节流和重复检测减少CPU负载</li></ol><h3 id="配置参数"><a href="#配置参数" class="headerlink" title="配置参数"></a>配置参数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 性能优化配置</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PERFORMANCE_CONFIG</span> = &#123;</span><br><span class="line">  <span class="attr">HIGH_PERFORMANCE_THRESHOLD</span>: <span class="number">200</span>, <span class="comment">// 点位数量阈值</span></span><br><span class="line">  <span class="attr">THROTTLE_INTERVAL_STANDARD</span>: <span class="number">16</span>, <span class="comment">// 标准模式节流间隔(ms)</span></span><br><span class="line">  <span class="attr">THROTTLE_INTERVAL_HIGH</span>: <span class="number">25</span>, <span class="comment">// 高性能模式节流间隔(ms)</span></span><br><span class="line">  <span class="attr">SKIP_PROBABILITY</span>: <span class="number">0.05</span>, <span class="comment">// 高性能模式跳过概率</span></span><br><span class="line">  <span class="attr">CACHE_CLEANUP_INTERVAL</span>: <span class="number">30000</span>, <span class="comment">// 缓存清理间隔(ms)</span></span><br><span class="line">  <span class="attr">PERFORMANCE_CHECK_INTERVAL</span>: <span class="number">2000</span>, <span class="comment">// 性能检查间隔(ms)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 点位配置</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">CONFIG</span> = &#123;</span><br><span class="line">  <span class="attr">POINT_COUNT</span>: <span class="number">500</span>, <span class="comment">// 测试用点位数量</span></span><br><span class="line">  <span class="attr">TOOLTIP_HIDE_DELAY</span>: <span class="number">200</span>, <span class="comment">// 弹框隐藏延迟</span></span><br><span class="line">  <span class="attr">INITIAL_VIEW</span>: &#123;</span><br><span class="line">    <span class="attr">longitude</span>: <span class="number">116.4074</span>,</span><br><span class="line">    <span class="attr">latitude</span>: <span class="number">39.9042</span>,</span><br><span class="line">    <span class="attr">height</span>: <span class="number">4500</span>,</span><br><span class="line">    <span class="attr">pitch</span>: -<span class="number">30</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="使用建议"><a href="#使用建议" class="headerlink" title="使用建议"></a>使用建议</h3><h4 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h4><ol><li>使用性能监控工具</li><li>根据点位数量调整 <code>HIGH_PERFORMANCE_THRESHOLD</code> 阈值</li><li>监控控制台输出的性能警告信息</li><li>使用”🧪 500点位测试”按钮进行快速测试</li></ol><h4 id="生产环境"><a href="#生产环境" class="headerlink" title="生产环境"></a>生产环境</h4><ol><li>根据实际点位数量调整配置参数</li><li>定期检查性能监控数据</li><li>考虑进一步优化，如LOD（细节层次）管理</li><li>监控FPS，低于30时触发性能警告</li></ol><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><h4 id="1-缓存管理"><a href="#1-缓存管理" class="headerlink" title="1. 缓存管理"></a>1. 缓存管理</h4><ul><li>缓存机制会占用一定内存</li><li>需要定期清理缓存</li><li>在点位数据更新时清理缓存</li></ul><h4 id="2-性能平衡"><a href="#2-性能平衡" class="headerlink" title="2. 性能平衡"></a>2. 性能平衡</h4><ul><li>高性能模式会降低交互响应性</li><li>但保证地图流畅度</li><li>根据实际需求调整参数</li></ul><h4 id="3-模块依赖"><a href="#3-模块依赖" class="headerlink" title="3. 模块依赖"></a>3. 模块依赖</h4><ul><li>性能监控模块需要额外加载</li><li>失败时会降级处理</li><li>不影响基本功能</li></ul><h4 id="4-阈值调整"><a href="#4-阈值调整" class="headerlink" title="4. 阈值调整"></a>4. 阈值调整</h4><ul><li>建议根据实际使用场景调整阈值参数</li><li>500个点位是较大的数据量</li><li>可能需要进一步优化</li></ul><h3 id="未来优化方向"><a href="#未来优化方向" class="headerlink" title="未来优化方向"></a>未来优化方向</h3><h4 id="1-LOD管理"><a href="#1-LOD管理" class="headerlink" title="1. LOD管理"></a>1. LOD管理</h4><ul><li>实现细节层次管理</li><li>根据距离显示不同精度的点位</li><li>减少渲染负担</li></ul><h4 id="2-聚类优化"><a href="#2-聚类优化" class="headerlink" title="2. 聚类优化"></a>2. 聚类优化</h4><ul><li>对密集点位进行聚类显示</li><li>减少可见点位数量</li><li>提升交互性能</li></ul><h4 id="3-Web-Workers"><a href="#3-Web-Workers" class="headerlink" title="3. Web Workers"></a>3. Web Workers</h4><ul><li>使用Web Workers进行后台计算</li><li>避免阻塞主线程</li><li>提升整体性能</li></ul><h4 id="4-虚拟化"><a href="#4-虚拟化" class="headerlink" title="4. 虚拟化"></a>4. 虚拟化</h4><ul><li>实现点位虚拟化</li><li>只渲染可见区域内的点位</li><li>大幅减少渲染负担</li></ul><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>通过以上优化方案，500个点位的悬停事件处理得到了显著改善：</p><ol><li><strong>性能提升</strong>: 通过节流、缓存、重复检测等机制提升性能</li><li><strong>用户体验</strong>: 保持流畅的地图交互和及时的悬停响应</li><li><strong>智能优化</strong>: 根据点位数量自动调整处理策略</li><li><strong>实时监控</strong>: 提供实时的性能监控和反馈</li></ol><p>这些优化确保了在大量点位场景下仍能保持良好的用户体验和系统性能。</p><p>&#x2F;&#x2F; 10. 异步加载优化</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">### 📦 异步加载优化</span><br><span class="line"></span><br><span class="line">#### 1. 分批加载策略</span><br><span class="line"></span><br><span class="line">```javascript</span><br><span class="line">// 异步加载大数据集</span><br><span class="line">async function loadLargeDataset(url) &#123;</span><br><span class="line">  const loadingIndicator = showLoadingIndicator()</span><br><span class="line"></span><br><span class="line">  try &#123;</span><br><span class="line">    // 分批加载数据</span><br><span class="line">    const batchSize = 1000</span><br><span class="line">    let offset = 0</span><br><span class="line">    let hasMore = true</span><br><span class="line"></span><br><span class="line">    while (hasMore) &#123;</span><br><span class="line">      const response = await fetch(`$&#123;url&#125;?offset=$&#123;offset&#125;&amp;limit=$&#123;batchSize&#125;`)</span><br><span class="line">      const batch = await response.json()</span><br><span class="line"></span><br><span class="line">      if (batch.length === 0) &#123;</span><br><span class="line">        hasMore = false</span><br><span class="line">        break</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // 异步处理批次</span><br><span class="line">      await new Promise((resolve) =&gt; &#123;</span><br><span class="line">        setTimeout(() =&gt; &#123;</span><br><span class="line">          processBatch(batch)</span><br><span class="line">          resolve()</span><br><span class="line">        &#125;, 0)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      offset += batchSize</span><br><span class="line"></span><br><span class="line">      // 更新进度</span><br><span class="line">      updateProgress(offset)</span><br><span class="line"></span><br><span class="line">      // 让浏览器有机会更新UI</span><br><span class="line">      await new Promise((resolve) =&gt; requestAnimationFrame(resolve))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;加载数据失败:&#x27;, error)</span><br><span class="line">  &#125; finally &#123;</span><br><span class="line">    hideLoadingIndicator(loadingIndicator)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 处理批次数据</span><br><span class="line">function processBatch(data) &#123;</span><br><span class="line">  const entities = []</span><br><span class="line"></span><br><span class="line">  data.forEach((item) =&gt; &#123;</span><br><span class="line">    entities.push(&#123;</span><br><span class="line">      position: Cesium.Cartesian3.fromDegrees(item.lon, item.lat, item.alt),</span><br><span class="line">      point: &#123;</span><br><span class="line">        pixelSize: 5,</span><br><span class="line">        color: Cesium.Color.fromCssColorString(item.color),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  viewer.entities.add(entities)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-WebWorker-优化"><a href="#2-WebWorker-优化" class="headerlink" title="2. WebWorker 优化"></a>2. WebWorker 优化</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主线程 - 使用WebWorker处理大数据</span></span><br><span class="line"><span class="keyword">const</span> worker = <span class="keyword">new</span> <span class="title class_">Worker</span>(<span class="string">&#x27;./workers/dataProcessor.js&#x27;</span>)</span><br><span class="line"></span><br><span class="line">worker.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;PROCESS_LARGE_DATASET&#x27;</span>,</span><br><span class="line">  <span class="attr">data</span>: largeDataArray,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">worker.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; type, result &#125; = event.<span class="property">data</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (type === <span class="string">&#x27;PROCESSING_COMPLETE&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// 在主线程中添加处理结果</span></span><br><span class="line">    result.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">      viewer.<span class="property">entities</span>.<span class="title function_">add</span>(item)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// dataProcessor.js (WebWorker)</span></span><br><span class="line">self.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; type, data &#125; = event.<span class="property">data</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (type === <span class="string">&#x27;PROCESS_LARGE_DATASET&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> result = []</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在Worker中进行重计算</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; data.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> item = data[i]</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 复杂的数据处理</span></span><br><span class="line">      <span class="keyword">const</span> processed = <span class="title function_">complexCalculation</span>(item)</span><br><span class="line">      result.<span class="title function_">push</span>(processed)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 定期发送进度更新</span></span><br><span class="line">      <span class="keyword">if</span> (i % <span class="number">1000</span> === <span class="number">0</span>) &#123;</span><br><span class="line">        self.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;PROGRESS_UPDATE&#x27;</span>,</span><br><span class="line">          <span class="attr">progress</span>: i / data.<span class="property">length</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    self.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;PROCESSING_COMPLETE&#x27;</span>,</span><br><span class="line">      <span class="attr">result</span>: result,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">complexCalculation</span>(<span class="params">item</span>) &#123;</span><br><span class="line">  <span class="comment">// 执行复杂计算</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">position</span>: [item.<span class="property">x</span> * <span class="number">1.5</span>, item.<span class="property">y</span> * <span class="number">1.5</span>, item.<span class="property">z</span> * <span class="number">1.5</span>],</span><br><span class="line">    <span class="attr">color</span>: <span class="title function_">generateColor</span>(item.<span class="property">value</span>),</span><br><span class="line">    <span class="attr">properties</span>: <span class="title function_">processProperties</span>(item.<span class="property">attributes</span>),</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-视口优化"><a href="#3-视口优化" class="headerlink" title="3. 视口优化"></a>3. 视口优化</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 优化视口和分辨率</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">optimizeForViewport</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> canvas = viewer.<span class="property">canvas</span></span><br><span class="line">  <span class="keyword">const</span> rect = canvas.<span class="title function_">getBoundingClientRect</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 调整画布分辨率</span></span><br><span class="line">  <span class="keyword">const</span> devicePixelRatio = <span class="variable language_">window</span>.<span class="property">devicePixelRatio</span> || <span class="number">1</span></span><br><span class="line">  <span class="keyword">const</span> displayWidth = rect.<span class="property">width</span></span><br><span class="line">  <span class="keyword">const</span> displayHeight = rect.<span class="property">height</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 限制最大分辨率以提高性能</span></span><br><span class="line"><span class="keyword">const</span> maxPixelRatio = <span class="number">2</span></span><br><span class="line"><span class="keyword">const</span> actualPixelRatio = <span class="title class_">Math</span>.<span class="title function_">min</span>(devicePixelRatio, maxPixelRatio)</span><br><span class="line"></span><br><span class="line">canvas.<span class="property">width</span> = displayWidth _actualPixelRatio</span><br><span class="line">canvas.<span class="property">height</span> = displayHeight_ actualPixelRatio</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新WebGL视口</span></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">context</span>.\_gl.<span class="title function_">viewport</span>(<span class="number">0</span>, <span class="number">0</span>, canvas.<span class="property">width</span>, canvas.<span class="property">height</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 响应窗口大小变化</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;resize&#x27;</span>, <span class="title function_">throttle</span>(optimizeForViewport, <span class="number">250</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 13. 缓存策略</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResourceCache</span> &#123;</span><br><span class="line"><span class="title function_">constructor</span>(<span class="params">maxSize = <span class="number">100</span></span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">cache</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">maxSize</span> = maxSize</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">get</span>(<span class="params">key</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">has</span>(key)) &#123;</span><br><span class="line"><span class="comment">// LRU: 移到末尾</span></span><br><span class="line"><span class="keyword">const</span> value = <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">get</span>(key)</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">delete</span>(key)</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">set</span>(key, value)</span><br><span class="line"><span class="keyword">return</span> value</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">set</span>(<span class="params">key, value</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">has</span>(key)) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">delete</span>(key)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">cache</span>.<span class="property">size</span> &gt;= <span class="variable language_">this</span>.<span class="property">maxSize</span>) &#123;</span><br><span class="line"><span class="comment">// 删除最少使用的项目</span></span><br><span class="line"><span class="keyword">const</span> firstKey = <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">keys</span>().<span class="title function_">next</span>().<span class="property">value</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">delete</span>(firstKey)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">set</span>(key, value)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">clear</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">clear</span>()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> resourceCache = <span class="keyword">new</span> <span class="title class_">ResourceCache</span>(<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 缓存纹理加载</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">loadTextureWithCache</span>(<span class="params">url</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> cached = resourceCache.<span class="title function_">get</span>(url)</span><br><span class="line"><span class="keyword">if</span> (cached) &#123;</span><br><span class="line"><span class="keyword">return</span> cached</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> texture = <span class="keyword">await</span> <span class="title function_">loadTexture</span>(url)</span><br><span class="line">resourceCache.<span class="title function_">set</span>(url, texture)</span><br><span class="line"><span class="keyword">return</span> texture</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 14. 性能监控</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PerformanceMonitor</span> &#123;</span><br><span class="line"><span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">metrics</span> = &#123;</span><br><span class="line"><span class="attr">fps</span>: <span class="number">0</span>,</span><br><span class="line"><span class="attr">frameTime</span>: <span class="number">0</span>,</span><br><span class="line"><span class="attr">memoryUsage</span>: <span class="number">0</span>,</span><br><span class="line"><span class="attr">primitiveCount</span>: <span class="number">0</span>,</span><br><span class="line"><span class="attr">entityCount</span>: <span class="number">0</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lastTime</span> = performance.<span class="title function_">now</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">frameCount</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fpsUpdateInterval</span> = <span class="number">1000</span> <span class="comment">// 1秒更新一次FPS</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">update</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> currentTime = performance.<span class="title function_">now</span>()</span><br><span class="line"><span class="keyword">const</span> deltaTime = currentTime - <span class="variable language_">this</span>.<span class="property">lastTime</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">frameCount</span>++</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (deltaTime &gt;= <span class="variable language_">this</span>.<span class="property">fpsUpdateInterval</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">fps</span> = <span class="title class_">Math</span>.<span class="title function_">round</span>((<span class="variable language_">this</span>.<span class="property">frameCount</span> * <span class="number">1000</span>) / deltaTime)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">frameTime</span> = deltaTime / <span class="variable language_">this</span>.<span class="property">frameCount</span></span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">frameCount</span> = <span class="number">0</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">lastTime</span> = currentTime</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 更新其他指标</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">updateMemoryUsage</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">updateCounts</span>()</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 触发性能警告</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">checkPerformance</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">updateMemoryUsage</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (performance.<span class="property">memory</span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">memoryUsage</span> = performance.<span class="property">memory</span>.<span class="property">usedJSHeapSize</span> / <span class="number">1024</span> / <span class="number">1024</span> <span class="comment">// MB</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">updateCounts</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">primitiveCount</span> = viewer.<span class="property">scene</span>.<span class="property">primitives</span>.<span class="property">length</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">entityCount</span> = viewer.<span class="property">entities</span>.<span class="property">values</span>.<span class="property">length</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">checkPerformance</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">fps</span> &lt; <span class="number">30</span>) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;性能警告: FPS过低&#x27;</span>, <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">fps</span>)</span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">suggestOptimizations</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">memoryUsage</span> &gt; <span class="number">500</span>) &#123;</span><br><span class="line">      <span class="comment">// 500MB</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;内存警告: 内存使用过高&#x27;</span>, <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">memoryUsage</span>, <span class="string">&#x27;MB&#x27;</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">suggestMemoryOptimizations</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">suggestOptimizations</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> suggestions = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">entityCount</span> &gt; <span class="number">10000</span>) &#123;</span><br><span class="line">      suggestions.<span class="title function_">push</span>(<span class="string">&#x27;实体数量过多，考虑使用Primitive或聚类&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">primitiveCount</span> &gt; <span class="number">100</span>) &#123;</span><br><span class="line">      suggestions.<span class="title function_">push</span>(<span class="string">&#x27;图元数量过多，考虑合并几何体&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!viewer.<span class="property">scene</span>.<span class="property">requestRenderMode</span>) &#123;</span><br><span class="line">      suggestions.<span class="title function_">push</span>(<span class="string">&#x27;启用按需渲染模式&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;性能优化建议:&#x27;</span>, suggestions)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">suggestMemoryOptimizations</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;内存优化建议:&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;- 清理未使用的实体和图元&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;- 减少高分辨率纹理的使用&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;- 启用瓦片缓存限制&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;- 检查内存泄漏&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">getReport</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">...<span class="variable language_">this</span>.<span class="property">metrics</span>,</span><br><span class="line"><span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toISOString</span>(),</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> performanceMonitor = <span class="keyword">new</span> <span class="title class_">PerformanceMonitor</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在渲染循环中更新性能监控</span></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">postRender</span>.<span class="title function_">addEventListener</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">performanceMonitor.<span class="title function_">update</span>()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示性能信息</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">displayPerformanceInfo</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> report = performanceMonitor.<span class="title function_">getReport</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> infoDiv = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;performance-info&#x27;</span>) || <span class="title function_">createPerformanceInfoDiv</span>()</span><br><span class="line">infoDiv.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;div&gt;FPS: <span class="subst">$&#123;report.fps&#125;</span>&lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;div&gt;帧时间: <span class="subst">$&#123;report.frameTime.toFixed(<span class="number">2</span>)&#125;</span>ms&lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;div&gt;内存使用: <span class="subst">$&#123;report.memoryUsage.toFixed(<span class="number">2</span>)&#125;</span>MB&lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;div&gt;图元数量: <span class="subst">$&#123;report.primitiveCount&#125;</span>&lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;div&gt;实体数量: <span class="subst">$&#123;report.entityCount&#125;</span>&lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createPerformanceInfoDiv</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> div = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">div.<span class="property">id</span> = <span class="string">&#x27;performance-info&#x27;</span></span><br><span class="line">div.<span class="property">style</span>.<span class="property">cssText</span> = <span class="string">`position: absolute;</span></span><br><span class="line"><span class="string">    top: 10px;</span></span><br><span class="line"><span class="string">    right: 10px;</span></span><br><span class="line"><span class="string">    background: rgba(0,0,0,0.8);</span></span><br><span class="line"><span class="string">    color: white;</span></span><br><span class="line"><span class="string">    padding: 10px;</span></span><br><span class="line"><span class="string">    border-radius: 5px;</span></span><br><span class="line"><span class="string">    font-family: monospace;</span></span><br><span class="line"><span class="string">    font-size: 12px;</span></span><br><span class="line"><span class="string">    z-index: 1000;</span></span><br><span class="line"><span class="string"> `</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(div)</span><br><span class="line"><span class="keyword">return</span> div</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定期更新显示</span></span><br><span class="line"><span class="built_in">setInterval</span>(displayPerformanceInfo, <span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 15. 最佳实践总结</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PERFORMANCE_BEST_PRACTICES</span> = &#123;</span><br><span class="line"><span class="comment">// 渲染优化</span></span><br><span class="line"><span class="attr">rendering</span>: [<span class="string">&#x27;启用按需渲染模式&#x27;</span>, <span class="string">&#x27;使用适当的LOD设置&#x27;</span>, <span class="string">&#x27;启用视锥剔除&#x27;</span>, <span class="string">&#x27;合理使用后处理效果&#x27;</span>],</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实体优化</span></span><br><span class="line"><span class="attr">entities</span>: [</span><br><span class="line"><span class="string">&#x27;大量几何体使用Primitive&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;启用实体聚类&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;设置距离显示条件&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;使用简单材质而非复杂纹理&#x27;</span>,</span><br><span class="line">],</span><br><span class="line"></span><br><span class="line"><span class="comment">// 内存管理</span></span><br><span class="line"><span class="attr">memory</span>: [</span><br><span class="line"><span class="string">&#x27;定期清理未使用的资源&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;限制同时加载的数据量&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;使用对象池重用资源&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;监控内存使用情况&#x27;</span>,</span><br><span class="line">],</span><br><span class="line"></span><br><span class="line"><span class="comment">// 数据加载</span></span><br><span class="line"><span class="attr">dataLoading</span>: [</span><br><span class="line"><span class="string">&#x27;异步分批加载大数据集&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;使用WebWorker处理复杂计算&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;实现资源缓存策略&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;压缩和优化数据格式&#x27;</span>,</span><br><span class="line">],</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用户交互</span></span><br><span class="line"><span class="attr">interaction</span>: [<span class="string">&#x27;节流高频事件&#x27;</span>, <span class="string">&#x27;防抖用户输入&#x27;</span>, <span class="string">&#x27;异步处理UI更新&#x27;</span>, <span class="string">&#x27;提供加载进度反馈&#x27;</span>],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Cesium性能优化最佳实践:&#x27;</span>, <span class="variable constant_">PERFORMANCE_BEST_PRACTICES</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><hr><h2 id="📚-总结"><a href="#📚-总结" class="headerlink" title="📚 总结"></a>📚 总结</h2><p>本指南涵盖了Cesium离线开发的所有核心概念和详细属性说明，包括：</p><ul><li><strong>环境配置</strong>: 完整的离线开发环境搭建</li><li><strong>Viewer配置</strong>: 详细的构造参数和渲染选项</li><li><strong>坐标系统</strong>: 完整的坐标转换和数学运算</li><li><strong>实体系统</strong>: 所有图形类型的详细属性</li><li><strong>影像地形</strong>: 各种提供者的配置选项</li><li><strong>相机控制</strong>: 完整的相机操作方法</li><li><strong>事件处理</strong>: 屏幕空间事件的详细处理</li><li><strong>材质系统</strong>: 各种内置和自定义材质</li><li><strong>动画系统</strong>: 属性动画和时间控制</li><li><strong>几何图元</strong>: 低级别图形渲染</li><li><strong>场景控制</strong>: 场景和地球的高级配置</li><li><strong>数据源</strong>: 各种格式数据的加载和处理</li><li><strong>时间系统</strong>: 时间操作和动画控制</li><li><strong>性能优化</strong>: 全面的性能优化策略</li></ul><hr><h3 id="📚-最佳实践总结"><a href="#📚-最佳实践总结" class="headerlink" title="📚 最佳实践总结"></a>📚 最佳实践总结</h3><h4 id="🎯-性能优化原则"><a href="#🎯-性能优化原则" class="headerlink" title="🎯 性能优化原则"></a>🎯 性能优化原则</h4><ol><li><strong>按需渲染</strong>: 只在必要时触发渲染</li><li><strong>LOD管理</strong>: 根据距离显示不同精度</li><li><strong>内存管理</strong>: 定期清理未使用资源</li><li><strong>事件优化</strong>: 使用节流和委托</li><li><strong>异步处理</strong>: 避免阻塞主线程</li></ol><h4 id="📊-性能监控指标"><a href="#📊-性能监控指标" class="headerlink" title="📊 性能监控指标"></a>📊 性能监控指标</h4><table><thead><tr><th>指标</th><th>目标值</th><th>监控方法</th></tr></thead><tbody><tr><td>FPS</td><td>≥30</td><td>实时监控</td></tr><tr><td>内存使用</td><td>&lt;80%</td><td>定期检查</td></tr><tr><td>响应时间</td><td>&lt;100ms</td><td>用户交互测试</td></tr><tr><td>加载时间</td><td>&lt;3s</td><td>网络监控</td></tr></tbody></table><h4 id="🔧-配置建议"><a href="#🔧-配置建议" class="headerlink" title="🔧 配置建议"></a>🔧 配置建议</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 性能优化配置</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PERFORMANCE_CONFIG</span> = &#123;</span><br><span class="line">  <span class="comment">// 渲染设置</span></span><br><span class="line">  <span class="attr">REQUEST_RENDER_MODE</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">MAXIMUM_RENDER_TIME_CHANGE</span>: <span class="number">0.0</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// LOD设置</span></span><br><span class="line">  <span class="attr">MAXIMUM_SCREEN_SPACE_ERROR</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">TILE_CACHE_SIZE</span>: <span class="number">200</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 内存管理</span></span><br><span class="line">  <span class="attr">CLEANUP_INTERVAL</span>: <span class="number">30000</span>,</span><br><span class="line">  <span class="attr">MEMORY_WARNING_THRESHOLD</span>: <span class="number">0.8</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 事件优化</span></span><br><span class="line">  <span class="attr">THROTTLE_INTERVAL</span>: <span class="number">100</span>,</span><br><span class="line">  <span class="attr">HOVER_THROTTLE</span>: <span class="number">25</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 异步加载</span></span><br><span class="line">  <span class="attr">BATCH_SIZE</span>: <span class="number">1000</span>,</span><br><span class="line">  <span class="attr">PROGRESS_UPDATE_INTERVAL</span>: <span class="number">1000</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="🚀-开发建议"><a href="#🚀-开发建议" class="headerlink" title="🚀 开发建议"></a>🚀 开发建议</h4><ol><li><p><strong>开发阶段</strong></p><ul><li>使用性能监控工具</li><li>定期检查内存使用</li><li>测试大数据量场景</li></ul></li><li><p><strong>生产环境</strong></p><ul><li>启用所有优化选项</li><li>监控关键性能指标</li><li>准备降级方案</li></ul></li><li><p><strong>维护阶段</strong></p><ul><li>定期清理缓存</li><li>监控用户反馈</li><li>持续优化性能</li></ul></li></ol><h4 id="⚠️-注意事项"><a href="#⚠️-注意事项" class="headerlink" title="⚠️ 注意事项"></a>⚠️ 注意事项</h4><ol><li><strong>兼容性</strong>: 确保优化方案在不同浏览器中正常工作</li><li><strong>降级处理</strong>: 提供优化失败时的降级方案</li><li><strong>用户体验</strong>: 平衡性能优化和用户体验</li><li><strong>内存泄漏</strong>: 注意及时清理事件监听器和缓存</li></ol><h4 id="🔮-未来发展方向"><a href="#🔮-未来发展方向" class="headerlink" title="🔮 未来发展方向"></a>🔮 未来发展方向</h4><ol><li><strong>WebGPU</strong>: 利用新一代图形API</li><li><strong>虚拟化</strong>: 只渲染可见区域</li><li><strong>AI优化</strong>: 智能预测用户行为</li><li><strong>边缘计算</strong>: 分布式渲染</li></ol><hr><p>这份指南为离线Cesium开发提供了完整的参考，每个属性都包含了作用说明、默认值、使用示例，帮助开发者在无网络环境下也能高效开发Cesium应用。</p><h3 id="时间轴与动画（进阶示例）"><a href="#时间轴与动画（进阶示例）" class="headerlink" title="时间轴与动画（进阶示例）"></a>时间轴与动画（进阶示例）</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置时间轴与速率</span></span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">startTime</span> = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&#x27;2024-01-01T00:00:00Z&#x27;</span>))</span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">stopTime</span> = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&#x27;2024-01-01T01:00:00Z&#x27;</span>))</span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">currentTime</span> = viewer.<span class="property">clock</span>.<span class="property">startTime</span>.<span class="title function_">clone</span>()</span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">clockRange</span> = <span class="title class_">Cesium</span>.<span class="property">ClockRange</span>.<span class="property">LOOP_STOP</span> <span class="comment">// 循环</span></span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">multiplier</span> = <span class="number">10</span> <span class="comment">// 时间加速10倍</span></span><br><span class="line">viewer.<span class="property">timeline</span>.<span class="title function_">zoomTo</span>(viewer.<span class="property">clock</span>.<span class="property">startTime</span>, viewer.<span class="property">clock</span>.<span class="property">stopTime</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基于时序变化实体属性</span></span><br><span class="line"><span class="keyword">const</span> movingPoint = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">CallbackProperty</span>(<span class="function">(<span class="params">time</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> seconds = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">secondsDifference</span>(time, viewer.<span class="property">clock</span>.<span class="property">startTime</span>)</span><br><span class="line">    <span class="keyword">const</span> lon = <span class="number">116.4</span> + seconds * <span class="number">0.0001</span></span><br><span class="line">    <span class="keyword">const</span> lat = <span class="number">39.9</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(lon, lat)</span><br><span class="line">  &#125;, <span class="literal">false</span>),</span><br><span class="line">  <span class="attr">point</span>: &#123; <span class="attr">pixelSize</span>: <span class="number">8</span>, <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span> &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><hr><h2 id="几何图元（低级-Primitive）实战"><a href="#几何图元（低级-Primitive）实战" class="headerlink" title="几何图元（低级 Primitive）实战"></a>几何图元（低级 Primitive）实战</h2><p>当 Entity 数量巨大且样式统一时，使用 Primitive 可显著降低管理开销。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 GroundPolylinePrimitive 批量绘制贴地线</span></span><br><span class="line"><span class="keyword">await</span> <span class="title class_">Cesium</span>.<span class="property">GroundPolylinePrimitive</span>.<span class="title function_">initializeTerrainHeights</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> instances = lines.<span class="title function_">map</span>(</span><br><span class="line">  <span class="function">(<span class="params">l</span>) =&gt;</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">GeometryInstance</span>(&#123;</span><br><span class="line">      <span class="attr">geometry</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">GroundPolylineGeometry</span>(&#123;</span><br><span class="line">        <span class="attr">positions</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegreesArray</span>(l.<span class="title function_">flat</span>()),</span><br><span class="line">        <span class="attr">width</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">arcType</span>: <span class="title class_">Cesium</span>.<span class="property">ArcType</span>.<span class="property">GEODESIC</span>,</span><br><span class="line">      &#125;),</span><br><span class="line">    &#125;),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> primitive = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">GroundPolylinePrimitive</span>(&#123;</span><br><span class="line">  <span class="attr">geometryInstances</span>: instances,</span><br><span class="line">  <span class="attr">appearance</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PolylineMaterialAppearance</span>(&#123;</span><br><span class="line">    <span class="attr">material</span>: <span class="title class_">Cesium</span>.<span class="property">Material</span>.<span class="title function_">fromType</span>(<span class="string">&#x27;Color&#x27;</span>, &#123; <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">CYAN</span>.<span class="title function_">withAlpha</span>(<span class="number">0.7</span>) &#125;),</span><br><span class="line">  &#125;),</span><br><span class="line">&#125;)</span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">groundPrimitives</span>.<span class="title function_">add</span>(primitive)</span><br></pre></td></tr></table></figure><p>要点：</p><ul><li>使用单一材质与统一宽度，便于合并。</li><li>需要贴地&#x2F;地形支持时，优先 GroundPolyline 系列。</li></ul><hr><h2 id="屏幕空间事件最佳实践"><a href="#屏幕空间事件最佳实践" class="headerlink" title="屏幕空间事件最佳实践"></a>屏幕空间事件最佳实践</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 节流 + 命中缓存，减少 pick 频率</span></span><br><span class="line"><span class="keyword">const</span> handler = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">ScreenSpaceEventHandler</span>(viewer.<span class="property">canvas</span>)</span><br><span class="line"><span class="keyword">let</span> lastPickId = <span class="literal">null</span></span><br><span class="line"><span class="keyword">let</span> lastPickTime = <span class="number">0</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PICK_THROTTLE</span> = <span class="number">16</span> <span class="comment">// ms</span></span><br><span class="line"></span><br><span class="line">handler.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">movement</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> now = performance.<span class="title function_">now</span>()</span><br><span class="line">  <span class="keyword">if</span> (now - lastPickTime &lt; <span class="variable constant_">PICK_THROTTLE</span>) <span class="keyword">return</span></span><br><span class="line">  lastPickTime = now</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> picked = viewer.<span class="property">scene</span>.<span class="title function_">pick</span>(movement.<span class="property">endPosition</span>)</span><br><span class="line">  <span class="keyword">const</span> id = picked?.<span class="property">id</span> || <span class="literal">null</span></span><br><span class="line">  <span class="keyword">if</span> (id === lastPickId) <span class="keyword">return</span></span><br><span class="line">  lastPickId = id</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新 UI 或 Tooltip</span></span><br><span class="line">  <span class="keyword">if</span> (id) &#123;</span><br><span class="line">    <span class="comment">// showTooltip(...)</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// hideTooltip()</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="title class_">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">MOUSE_MOVE</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清理</span></span><br><span class="line"><span class="comment">// handler.destroy()</span></span><br></pre></td></tr></table></figure><p>建议：</p><ul><li>鼠标移动事件合并&#x2F;节流，避免每帧 pick。</li><li>使用 <code>scene.pickPositionSupported</code> 判断是否支持深度拾取，再决定 <code>pickPosition</code> 方案。</li></ul><hr><h2 id="大规模实体管理策略"><a href="#大规模实体管理策略" class="headerlink" title="大规模实体管理策略"></a>大规模实体管理策略</h2><p>针对 10w+ 点&#x2F;线：</p><ul><li>批量创建：先构造数组再一次性 <code>viewer.entities.add(array)</code>。</li><li>分批加载：切片（空间网格或四叉树）+ 分段请求。</li><li>可见性裁剪：<ul><li>距离阈值隐藏远处实体；</li><li>屏幕空间密度控制（按像素密度抽稀）。</li></ul></li><li>降级渲染：远距离改用 Billboards 或 Primitive；近距离再切换详细 Entity。</li><li>Worker 并行：几何计算、筛选在 Worker 内完成，主线程仅做绘制。</li></ul><p>示例：分批+抽稀</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">addEntitiesInChunks</span>(<span class="params">data, chunkSize = <span class="number">2000</span></span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; data.<span class="property">length</span>; i += chunkSize) &#123;</span><br><span class="line">    <span class="keyword">const</span> chunk = data.<span class="title function_">slice</span>(i, i + chunkSize)</span><br><span class="line">    <span class="keyword">const</span> batch = chunk.<span class="title function_">map</span>(<span class="function">(<span class="params">d</span>) =&gt;</span> (&#123;</span><br><span class="line">      <span class="attr">position</span>: <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(d.<span class="property">lon</span>, d.<span class="property">lat</span>),</span><br><span class="line">      <span class="attr">point</span>: &#123; <span class="attr">pixelSize</span>: <span class="number">6</span>, <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">SKYBLUE</span> &#125;,</span><br><span class="line">    &#125;))</span><br><span class="line">    viewer.<span class="property">entities</span>.<span class="title function_">add</span>(batch)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">visibilityCullByDistance</span>(<span class="params">camera, entities, maxDistance = <span class="number">50000</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> camPos = camera.<span class="property">positionWC</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> e <span class="keyword">of</span> entities.<span class="property">values</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> pos = e.<span class="property">position</span>?.<span class="title function_">getValue</span>(viewer.<span class="property">clock</span>.<span class="property">currentTime</span>)</span><br><span class="line">    <span class="keyword">if</span> (!pos) <span class="keyword">continue</span></span><br><span class="line">    e.<span class="property">show</span> = <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">distance</span>(camPos, pos) &lt; maxDistance</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>提示：当实体达到瓶颈时，迁移到 Primitive（如 <code>GroundPolylinePrimitive</code> 或 <code>PrimitiveCollection</code>）通常收益更大。</p><hr><h2 id="🎨-自定义后处理（PostProcessStage）"><a href="#🎨-自定义后处理（PostProcessStage）" class="headerlink" title="🎨 自定义后处理（PostProcessStage）"></a>🎨 自定义后处理（PostProcessStage）</h2><h3 id="1-单一后处理阶段（Edge-Detect-示例）"><a href="#1-单一后处理阶段（Edge-Detect-示例）" class="headerlink" title="1) 单一后处理阶段（Edge Detect 示例）"></a>1) 单一后处理阶段（Edge Detect 示例）</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自定义边缘检测后处理（片元着色器）</span></span><br><span class="line"><span class="keyword">const</span> edgeFrag = <span class="string">`</span></span><br><span class="line"><span class="string">  uniform sampler2D colorTexture;</span></span><br><span class="line"><span class="string">  uniform vec2 texelStep;</span></span><br><span class="line"><span class="string">  varying vec2 v_textureCoordinates;</span></span><br><span class="line"><span class="string">  void main() &#123;</span></span><br><span class="line"><span class="string">    vec3 tc = texture2D(colorTexture, v_textureCoordinates).rgb;</span></span><br><span class="line"><span class="string">    vec3 tx = texture2D(colorTexture, v_textureCoordinates + vec2(texelStep.x, 0.0)).rgb;</span></span><br><span class="line"><span class="string">    vec3 ty = texture2D(colorTexture, v_textureCoordinates + vec2(0.0, texelStep.y)).rgb;</span></span><br><span class="line"><span class="string">    float diff = length(tc - tx) + length(tc - ty);</span></span><br><span class="line"><span class="string">    float edge = step(0.15, diff);</span></span><br><span class="line"><span class="string">    gl_FragColor = vec4(vec3(edge), 1.0);</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="keyword">const</span> edgeStage = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PostProcessStage</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;edgeStage&#x27;</span>,</span><br><span class="line">  <span class="attr">fragmentShader</span>: edgeFrag,</span><br><span class="line">  <span class="attr">uniforms</span>: &#123;</span><br><span class="line">    <span class="attr">texelStep</span>: <span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian2</span>(<span class="number">1.0</span> / viewer.<span class="property">canvas</span>.<span class="property">width</span>, <span class="number">1.0</span> / viewer.<span class="property">canvas</span>.<span class="property">height</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">postProcessStages</span>.<span class="title function_">add</span>(edgeStage)</span><br><span class="line">edgeStage.<span class="property">enabled</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="2-组合后处理（Composite：Bloom-自定义）"><a href="#2-组合后处理（Composite：Bloom-自定义）" class="headerlink" title="2) 组合后处理（Composite：Bloom + 自定义）"></a>2) 组合后处理（Composite：Bloom + 自定义）</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bloom = viewer.<span class="property">scene</span>.<span class="property">postProcessStages</span>.<span class="property">bloom</span></span><br><span class="line">bloom.<span class="property">enabled</span> = <span class="literal">true</span></span><br><span class="line">bloom.<span class="property">uniforms</span>.<span class="property">glowOnly</span> = <span class="literal">false</span></span><br><span class="line">bloom.<span class="property">uniforms</span>.<span class="property">contrast</span> = <span class="number">128</span></span><br><span class="line">bloom.<span class="property">uniforms</span>.<span class="property">brightness</span> = -<span class="number">0.3</span></span><br><span class="line">bloom.<span class="property">uniforms</span>.<span class="property">delta</span> = <span class="number">1.0</span></span><br><span class="line">bloom.<span class="property">uniforms</span>.<span class="property">sigma</span> = <span class="number">2.0</span></span><br><span class="line">bloom.<span class="property">uniforms</span>.<span class="property">stepSize</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> toneMapFrag = <span class="string">`</span></span><br><span class="line"><span class="string">  uniform sampler2D colorTexture; varying vec2 v_textureCoordinates;</span></span><br><span class="line"><span class="string">  void main()&#123; vec3 col = texture2D(colorTexture, v_textureCoordinates).rgb;</span></span><br><span class="line"><span class="string">    col = col / (col + vec3(1.0)); gl_FragColor = vec4(col, 1.0);</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="keyword">const</span> toneMapStage = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PostProcessStage</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;toneMap&#x27;</span>, <span class="attr">fragmentShader</span>: toneMapFrag &#125;)</span><br><span class="line"><span class="keyword">const</span> composite = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PostProcessStageComposite</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;customComposite&#x27;</span>,</span><br><span class="line">  <span class="attr">stages</span>: [toneMapStage, bloom],</span><br><span class="line">&#125;)</span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">postProcessStages</span>.<span class="title function_">add</span>(composite)</span><br></pre></td></tr></table></figure><hr><h2 id="🧪-Shader-与-czm-内置速查（精选）"><a href="#🧪-Shader-与-czm-内置速查（精选）" class="headerlink" title="🧪 Shader 与 czm 内置速查（精选）"></a>🧪 Shader 与 czm 内置速查（精选）</h2><ul><li>czm 内置：<code>czm_frameNumber</code>, <code>czm_pixelRatio</code>, <code>czm_model/view/projection</code>, <code>czm_inverseViewProjection</code>, <code>czm_eyePosition</code>, <code>czm_geodeticSurfaceNormal</code>, <code>czm_unpackDepth</code>, <code>czm_morphTime</code></li><li>Fabric 提示：纹理用 <code>sampler2D</code>，时间驱动统一用 <code>czm_frameNumber</code> 或 <code>time</code>，透明设置 <code>translucent</code></li></ul><hr><h2 id="⛰️-地形-阴影-透明度-排序避坑"><a href="#⛰️-地形-阴影-透明度-排序避坑" class="headerlink" title="⛰️ 地形 &#x2F; 阴影 &#x2F; 透明度 排序避坑"></a>⛰️ 地形 &#x2F; 阴影 &#x2F; 透明度 排序避坑</h2><ul><li>贴地初始化：</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="title class_">Cesium</span>.<span class="property">GroundPolylinePrimitive</span>.<span class="title function_">initializeTerrainHeights</span>()</span><br></pre></td></tr></table></figure><ul><li>透明排序：尽量合并、减少重叠；必要时关闭部分深度测试或调整顺序；可尝试 <code>viewer.scene.orderIndependentTranslucency</code>。</li><li>阴影：<code>viewer.shadows = true</code>；细化到实体 <code>ShadowMode</code> 控制。</li></ul><hr><h2 id="🧰-更多实践建议"><a href="#🧰-更多实践建议" class="headerlink" title="🧰 更多实践建议"></a>🧰 更多实践建议</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">viewer.<span class="property">scene</span>.<span class="property">requestRenderMode</span> = <span class="literal">true</span></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">maximumRenderTimeChange</span> = <span class="number">0.0</span></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="title function_">requestRender</span>()</span><br></pre></td></tr></table></figure><ul><li>大数据优先级：Primitive &gt; 批量 Entity（分批+裁剪） &gt; LOD（远 Billboards、近细节）</li><li>事件节流与拾取回退；Worker 做几何与筛选，主线程绘制。</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Cesium-完整离线开发指南&quot;&gt;&lt;a href=&quot;#Cesium-完整离线开发指南&quot; class=&quot;headerlink&quot; title=&quot;Cesium 完整离线开发指南&quot;&gt;&lt;/a&gt;Cesium 完整离线开发指南&lt;/h1&gt;&lt;h2 id=&quot;📋-目录&quot;&gt;&lt;a hre</summary>
      
    
    
    
    
    <category term="Cesium" scheme="https://aoayaoa.github.io/tags/Cesium/"/>
    
    <category term="三维GIS" scheme="https://aoayaoa.github.io/tags/%E4%B8%89%E7%BB%B4GIS/"/>
    
  </entry>
  
  <entry>
    <title>mars3D 开发文档</title>
    <link href="https://aoayaoa.github.io/2025/07/31/mars3d/"/>
    <id>https://aoayaoa.github.io/2025/07/31/mars3d/</id>
    <published>2025-07-30T16:00:00.000Z</published>
    <updated>2025-08-08T02:31:53.931Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Mars3D-完整离线开发指南"><a href="#Mars3D-完整离线开发指南" class="headerlink" title="Mars3D 完整离线开发指南"></a>Mars3D 完整离线开发指南</h1><h2 id="📋-目录"><a href="#📋-目录" class="headerlink" title="📋 目录"></a>📋 目录</h2><ul><li><a href="#%E7%A6%BB%E7%BA%BF%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE">离线环境配置</a></li><li><a href="#map-%E8%AF%A6%E7%BB%86%E9%85%8D%E7%BD%AE">Map 详细配置</a></li><li><a href="#%E5%9D%90%E6%A0%87%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">坐标系统详解</a></li><li><a href="#%E5%9B%BE%E5%B1%82%E7%B3%BB%E7%BB%9F%E5%AE%8C%E6%95%B4%E5%B1%9E%E6%80%A7">图层系统完整属性</a></li><li><a href="#%E7%9F%A2%E9%87%8F%E6%95%B0%E6%8D%AE%E8%AF%A6%E8%A7%A3">矢量数据详解</a></li><li><a href="#%E4%B8%89%E7%BB%B4%E6%A8%A1%E5%9E%8B%E8%AF%A6%E8%A7%A3">三维模型详解</a></li><li><a href="#%E7%9B%B8%E6%9C%BA%E6%8E%A7%E5%88%B6%E5%AE%8C%E6%95%B4%E5%B1%9E%E6%80%A7">相机控制完整属性</a></li><li><a href="#%E4%BA%8B%E4%BB%B6%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">事件系统详解</a></li><li><a href="#%E6%9D%90%E8%B4%A8%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">材质系统详解</a></li><li><a href="#%E5%8A%A8%E7%94%BB%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">动画系统详解</a></li><li><a href="#%E5%88%86%E6%9E%90%E5%8A%9F%E8%83%BD%E8%AF%A6%E8%A7%A3">分析功能详解</a></li><li><a href="#%E6%8E%A7%E4%BB%B6%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">控件系统详解</a></li><li><a href="#%E7%BB%98%E5%88%B6%E5%8A%9F%E8%83%BD%E8%AF%A6%E8%A7%A3">绘制功能详解</a></li></ul><h2 id="离线环境配置"><a href="#离线环境配置" class="headerlink" title="离线环境配置"></a>离线环境配置</h2><h3 id="完整离线包下载"><a href="#完整离线包下载" class="headerlink" title="完整离线包下载"></a>完整离线包下载</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 下载Mars3D完整包</span></span><br><span class="line">wget https://github.com/marsgis/mars3d/releases/latest/mars3d.zip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 解压到项目目录</span></span><br><span class="line">unzip mars3d.zip -d public/mars3d/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 项目结构</span></span><br><span class="line">public/</span><br><span class="line">├── mars3d/</span><br><span class="line">│   ├── dist/</span><br><span class="line">│   │   ├── mars3d.js          <span class="comment"># 主库文件</span></span><br><span class="line">│   │   ├── mars3d.css         <span class="comment"># 样式文件</span></span><br><span class="line">│   │   └── plugins/           <span class="comment"># 插件目录</span></span><br><span class="line">│   ├── Workers/               <span class="comment"># WebWorker文件</span></span><br><span class="line">│   ├── Assets/                <span class="comment"># 静态资源</span></span><br><span class="line">│   └── ThirdParty/            <span class="comment"># 第三方库</span></span><br></pre></td></tr></table></figure><h3 id="Vite离线配置"><a href="#Vite离线配置" class="headerlink" title="Vite离线配置"></a>Vite离线配置</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.js - Mars3D离线开发配置</span></span><br><span class="line"><span class="keyword">import</span> &#123; defineConfig &#125; <span class="keyword">from</span> <span class="string">&#x27;vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; resolve &#125; <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">define</span>: &#123;</span><br><span class="line">    <span class="comment">// 定义全局常量</span></span><br><span class="line">    <span class="title class_">MARS3D</span><span class="attr">_BASE_URL</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="string">&#x27;/mars3d/&#x27;</span>),</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 静态资源处理</span></span><br><span class="line">  <span class="attr">publicDir</span>: <span class="string">&#x27;public&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建配置</span></span><br><span class="line">  <span class="attr">build</span>: &#123;</span><br><span class="line">    <span class="attr">rollupOptions</span>: &#123;</span><br><span class="line">      <span class="comment">// 排除不需要的依赖</span></span><br><span class="line">      <span class="attr">external</span>: [<span class="string">&#x27;@mars/common&#x27;</span>],</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 复制Mars3D静态资源</span></span><br><span class="line">      <span class="attr">input</span>: &#123;</span><br><span class="line">        <span class="attr">main</span>: <span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;index.html&#x27;</span>),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 开发服务器配置</span></span><br><span class="line">  <span class="attr">server</span>: &#123;</span><br><span class="line">    <span class="comment">// 静态文件服务</span></span><br><span class="line">    <span class="attr">fs</span>: &#123;</span><br><span class="line">      <span class="attr">allow</span>: [<span class="string">&#x27;..&#x27;</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 代理配置（如需要）</span></span><br><span class="line">    <span class="attr">proxy</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;/api&#x27;</span>: &#123;</span><br><span class="line">        <span class="attr">target</span>: <span class="string">&#x27;http://localhost:3000&#x27;</span>,</span><br><span class="line">        <span class="attr">changeOrigin</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 优化配置</span></span><br><span class="line">  <span class="attr">optimizeDeps</span>: &#123;</span><br><span class="line">    <span class="comment">// 预构建Mars3D</span></span><br><span class="line">    <span class="attr">include</span>: [<span class="string">&#x27;mars3d&#x27;</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="离线初始化"><a href="#离线初始化" class="headerlink" title="离线初始化"></a>离线初始化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js - Mars3D离线初始化配置</span></span><br><span class="line"><span class="comment">// 设置Mars3D基础路径</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">MARS3D_BASE_URL</span> = <span class="string">&#x27;/mars3d/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入Mars3D</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> mars3d <span class="keyword">from</span> <span class="string">&#x27;mars3d&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 离线Map配置</span></span><br><span class="line"><span class="keyword">const</span> map = <span class="keyword">new</span> mars3d.<span class="title class_">Map</span>(<span class="string">&#x27;mars3dContainer&#x27;</span>, &#123;</span><br><span class="line">  <span class="comment">// 场景参数</span></span><br><span class="line">  <span class="attr">scene</span>: &#123;</span><br><span class="line">    <span class="attr">center</span>: &#123; <span class="attr">lat</span>: <span class="number">31.794</span>, <span class="attr">lng</span>: <span class="number">117.207</span>, <span class="attr">alt</span>: <span class="number">2000</span>, <span class="attr">heading</span>: <span class="number">0</span>, <span class="attr">pitch</span>: -<span class="number">45</span> &#125;,</span><br><span class="line">    <span class="attr">showSun</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">showMoon</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">showSkyBox</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">showSkyAtmosphere</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">fog</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">fxaa</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">requestRenderMode</span>: <span class="literal">false</span>, <span class="comment">// 离线建议false</span></span><br><span class="line">    <span class="attr">globe</span>: &#123;</span><br><span class="line">      <span class="attr">depthTestAgainstTerrain</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">baseColor</span>: <span class="string">&#x27;#546a53&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 控制参数</span></span><br><span class="line">  <span class="attr">control</span>: &#123;</span><br><span class="line">    <span class="attr">baseLayerPicker</span>: <span class="literal">false</span>, <span class="comment">// 关闭图层选择器</span></span><br><span class="line">    <span class="attr">homeButton</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">sceneModePicker</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">navigationHelpButton</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">animation</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">timeline</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">fullscreenButton</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">vrButton</span>: <span class="literal">false</span>,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 地形参数</span></span><br><span class="line">  <span class="attr">terrain</span>: &#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;https://data.marsgis.cn/terrain&#x27;</span>, <span class="comment">// 或本地地形服务</span></span><br><span class="line">    <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 图层参数</span></span><br><span class="line">  <span class="attr">basemaps</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;离线底图&#x27;</span>,</span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&#x27;img/basemaps/offline.png&#x27;</span>,</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;xyz&#x27;</span>,</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&#x27;http://localhost:8080/tiles/&#123;z&#125;/&#123;x&#125;/&#123;y&#125;.png&#x27;</span>,</span><br><span class="line">      <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 操作图层</span></span><br><span class="line">  <span class="attr">operationalLayers</span>: [],</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="Map-详细配置"><a href="#Map-详细配置" class="headerlink" title="Map 详细配置"></a>Map 详细配置</h2><h3 id="构造函数完整参数"><a href="#构造函数完整参数" class="headerlink" title="构造函数完整参数"></a>构造函数完整参数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> map = <span class="keyword">new</span> mars3d.<span class="title class_">Map</span>(container, &#123;</span><br><span class="line">  <span class="comment">// === 场景配置 ===</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">scene</span>: &#123;</span><br><span class="line">    <span class="comment">// center: Object</span></span><br><span class="line">    <span class="comment">// 作用: 地图中心点位置</span></span><br><span class="line">    <span class="comment">// 格式: &#123; lat: 纬度, lng: 经度, alt: 高度, heading: 方向角, pitch: 俯仰角, roll: 翻滚角 &#125;</span></span><br><span class="line">    <span class="attr">center</span>: &#123; <span class="attr">lat</span>: <span class="number">31.794</span>, <span class="attr">lng</span>: <span class="number">117.207</span>, <span class="attr">alt</span>: <span class="number">2000</span>, <span class="attr">heading</span>: <span class="number">0</span>, <span class="attr">pitch</span>: -<span class="number">45</span>, <span class="attr">roll</span>: <span class="number">0</span> &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// showSun: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示太阳</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="attr">showSun</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// showMoon: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示月亮</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="attr">showMoon</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// showSkyBox: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示天空盒</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="attr">showSkyBox</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// showSkyAtmosphere: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示大气层</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="attr">showSkyAtmosphere</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fog: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否开启雾效</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="attr">fog</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fxaa: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否开启抗锯齿</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="attr">fxaa</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// bloom: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否开启泛光效果</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="attr">bloom</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// brightness: number</span></span><br><span class="line">    <span class="comment">// 作用: 亮度调节</span></span><br><span class="line">    <span class="comment">// 默认: 1.0</span></span><br><span class="line">    <span class="comment">// 范围: 0.0 - 2.0</span></span><br><span class="line">    <span class="attr">brightness</span>: <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// contrast: number</span></span><br><span class="line">    <span class="comment">// 作用: 对比度调节</span></span><br><span class="line">    <span class="comment">// 默认: 1.0</span></span><br><span class="line">    <span class="comment">// 范围: 0.0 - 2.0</span></span><br><span class="line">    <span class="attr">contrast</span>: <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// hue: number</span></span><br><span class="line">    <span class="comment">// 作用: 色调调节</span></span><br><span class="line">    <span class="comment">// 默认: 0.0</span></span><br><span class="line">    <span class="comment">// 范围: -1.0 - 1.0</span></span><br><span class="line">    <span class="attr">hue</span>: <span class="number">0.0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// saturation: number</span></span><br><span class="line">    <span class="comment">// 作用: 饱和度调节</span></span><br><span class="line">    <span class="comment">// 默认: 1.0</span></span><br><span class="line">    <span class="comment">// 范围: 0.0 - 2.0</span></span><br><span class="line">    <span class="attr">saturation</span>: <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// gamma: number</span></span><br><span class="line">    <span class="comment">// 作用: 伽马值调节</span></span><br><span class="line">    <span class="comment">// 默认: 1.0</span></span><br><span class="line">    <span class="comment">// 范围: 0.1 - 5.0</span></span><br><span class="line">    <span class="attr">gamma</span>: <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// requestRenderMode: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否开启按需渲染</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="comment">// 性能优化: true可提升性能</span></span><br><span class="line">    <span class="attr">requestRenderMode</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// maximumRenderTimeChange: number</span></span><br><span class="line">    <span class="comment">// 作用: 最大渲染时间变化</span></span><br><span class="line">    <span class="comment">// 默认: 0.0</span></span><br><span class="line">    <span class="attr">maximumRenderTimeChange</span>: <span class="number">0.0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// shadows: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否开启阴影</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="comment">// 性能影响: 较大</span></span><br><span class="line">    <span class="attr">shadows</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// resolutionScale: number</span></span><br><span class="line">    <span class="comment">// 作用: 分辨率缩放比例</span></span><br><span class="line">    <span class="comment">// 默认: 1.0</span></span><br><span class="line">    <span class="comment">// 性能优化: 降低可提升性能</span></span><br><span class="line">    <span class="attr">resolutionScale</span>: <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// globe: Object</span></span><br><span class="line">    <span class="comment">// 作用: 地球配置</span></span><br><span class="line">    <span class="attr">globe</span>: &#123;</span><br><span class="line">      <span class="comment">// show: boolean</span></span><br><span class="line">      <span class="comment">// 作用: 是否显示地球</span></span><br><span class="line">      <span class="comment">// 默认: true</span></span><br><span class="line">      <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// depthTestAgainstTerrain: boolean</span></span><br><span class="line">      <span class="comment">// 作用: 是否对地形进行深度测试</span></span><br><span class="line">      <span class="comment">// 默认: false</span></span><br><span class="line">      <span class="attr">depthTestAgainstTerrain</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// baseColor: string</span></span><br><span class="line">      <span class="comment">// 作用: 地球基础颜色</span></span><br><span class="line">      <span class="comment">// 默认: &#x27;#546a53&#x27;</span></span><br><span class="line">      <span class="attr">baseColor</span>: <span class="string">&#x27;#546a53&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// showWaterEffect: boolean</span></span><br><span class="line">      <span class="comment">// 作用: 是否显示水体效果</span></span><br><span class="line">      <span class="comment">// 默认: true</span></span><br><span class="line">      <span class="attr">showWaterEffect</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// enableLighting: boolean</span></span><br><span class="line">      <span class="comment">// 作用: 是否启用光照</span></span><br><span class="line">      <span class="comment">// 默认: false</span></span><br><span class="line">      <span class="attr">enableLighting</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// skyBox: Object | boolean</span></span><br><span class="line">    <span class="comment">// 作用: 天空盒配置</span></span><br><span class="line">    <span class="attr">skyBox</span>: &#123;</span><br><span class="line">      <span class="comment">// sources: Object</span></span><br><span class="line">      <span class="comment">// 作用: 天空盒贴图</span></span><br><span class="line">      <span class="attr">sources</span>: &#123;</span><br><span class="line">        <span class="attr">positiveX</span>: <span class="string">&#x27;img/skybox/px.jpg&#x27;</span>,</span><br><span class="line">        <span class="attr">negativeX</span>: <span class="string">&#x27;img/skybox/nx.jpg&#x27;</span>,</span><br><span class="line">        <span class="attr">positiveY</span>: <span class="string">&#x27;img/skybox/py.jpg&#x27;</span>,</span><br><span class="line">        <span class="attr">negativeY</span>: <span class="string">&#x27;img/skybox/ny.jpg&#x27;</span>,</span><br><span class="line">        <span class="attr">positiveZ</span>: <span class="string">&#x27;img/skybox/pz.jpg&#x27;</span>,</span><br><span class="line">        <span class="attr">negativeZ</span>: <span class="string">&#x27;img/skybox/nz.jpg&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// contextOptions: Object</span></span><br><span class="line">    <span class="comment">// 作用: WebGL上下文选项</span></span><br><span class="line">    <span class="attr">contextOptions</span>: &#123;</span><br><span class="line">      <span class="attr">webgl</span>: &#123;</span><br><span class="line">        <span class="attr">alpha</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">depth</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">stencil</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">antialias</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">powerPreference</span>: <span class="string">&#x27;high-performance&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === 控制配置 ===</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">control</span>: &#123;</span><br><span class="line">    <span class="comment">// baseLayerPicker: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示底图切换控件</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="comment">// 离线建议: false</span></span><br><span class="line">    <span class="attr">baseLayerPicker</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// homeButton: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示主页按钮</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="attr">homeButton</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sceneModePicker: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示场景模式切换按钮</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="attr">sceneModePicker</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// navigationHelpButton: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示导航帮助按钮</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="attr">navigationHelpButton</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// animation: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示动画控件</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="attr">animation</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// timeline: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示时间轴</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="attr">timeline</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fullscreenButton: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示全屏按钮</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="attr">fullscreenButton</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// vrButton: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示VR按钮</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="attr">vrButton</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// infoBox: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示信息框</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="attr">infoBox</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// selectionIndicator: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示选择指示器</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="attr">selectionIndicator</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// geocoder: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示地址搜索</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="comment">// 离线建议: false</span></span><br><span class="line">    <span class="attr">geocoder</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// compass: Object | boolean</span></span><br><span class="line">    <span class="comment">// 作用: 指南针控件配置</span></span><br><span class="line">    <span class="attr">compass</span>: &#123;</span><br><span class="line">      <span class="comment">// top: string</span></span><br><span class="line">      <span class="comment">// 作用: 距离顶部距离</span></span><br><span class="line">      <span class="attr">top</span>: <span class="string">&#x27;10px&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// left: string</span></span><br><span class="line">      <span class="comment">// 作用: 距离左侧距离</span></span><br><span class="line">      <span class="attr">left</span>: <span class="string">&#x27;5px&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// distanceLegend: Object | boolean</span></span><br><span class="line">    <span class="comment">// 作用: 比例尺控件配置</span></span><br><span class="line">    <span class="attr">distanceLegend</span>: &#123;</span><br><span class="line">      <span class="comment">// left: string</span></span><br><span class="line">      <span class="attr">left</span>: <span class="string">&#x27;10px&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// bottom: string</span></span><br><span class="line">      <span class="attr">bottom</span>: <span class="string">&#x27;25px&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// locationBar: Object | boolean</span></span><br><span class="line">    <span class="comment">// 作用: 坐标信息栏配置</span></span><br><span class="line">    <span class="attr">locationBar</span>: &#123;</span><br><span class="line">      <span class="comment">// format: string</span></span><br><span class="line">      <span class="comment">// 作用: 坐标格式</span></span><br><span class="line">      <span class="comment">// 选项: &#x27;degrees&#x27;, &#x27;dms&#x27;, &#x27;utm&#x27;</span></span><br><span class="line">      <span class="attr">format</span>: <span class="string">&#x27;degrees&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// bottom: string</span></span><br><span class="line">      <span class="attr">bottom</span>: <span class="string">&#x27;2px&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// left: string</span></span><br><span class="line">      <span class="attr">left</span>: <span class="string">&#x27;10px&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// contextmenu: Object | boolean</span></span><br><span class="line">    <span class="comment">// 作用: 右键菜单配置</span></span><br><span class="line">    <span class="attr">contextmenu</span>: &#123;</span><br><span class="line">      <span class="comment">// hasDefault: boolean</span></span><br><span class="line">      <span class="comment">// 作用: 是否包含默认菜单项</span></span><br><span class="line">      <span class="attr">hasDefault</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === 地形配置 ===</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">terrain</span>: &#123;</span><br><span class="line">    <span class="comment">// url: string</span></span><br><span class="line">    <span class="comment">// 作用: 地形服务地址</span></span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;https://data.marsgis.cn/terrain&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// show: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示地形</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// requestWaterMask: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否请求水体遮罩</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="attr">requestWaterMask</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// requestVertexNormals: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否请求顶点法线</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="attr">requestVertexNormals</span>: <span class="literal">false</span>,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === 底图配置 ===</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">basemaps</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// name: string</span></span><br><span class="line">      <span class="comment">// 作用: 底图名称</span></span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;天地图影像&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// icon: string</span></span><br><span class="line">      <span class="comment">// 作用: 底图图标</span></span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&#x27;img/basemaps/tdt_img.png&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// type: string</span></span><br><span class="line">      <span class="comment">// 作用: 底图类型</span></span><br><span class="line">      <span class="comment">// 选项: &#x27;xyz&#x27;, &#x27;wms&#x27;, &#x27;wmts&#x27;, &#x27;arcgis&#x27;, &#x27;baidu&#x27;, &#x27;gaode&#x27;, &#x27;tencent&#x27;, &#x27;bing&#x27;</span></span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;group&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// layers: Array</span></span><br><span class="line">      <span class="comment">// 作用: 图层组（用于type为group时）</span></span><br><span class="line">      <span class="attr">layers</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&#x27;底图&#x27;</span>,</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;tdt&#x27;</span>,</span><br><span class="line">          <span class="attr">layer</span>: <span class="string">&#x27;img_d&#x27;</span>,</span><br><span class="line">          <span class="attr">key</span>: [<span class="string">&#x27;your-key-1&#x27;</span>, <span class="string">&#x27;your-key-2&#x27;</span>],</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&#x27;注记&#x27;</span>,</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;tdt&#x27;</span>,</span><br><span class="line">          <span class="attr">layer</span>: <span class="string">&#x27;img_z&#x27;</span>,</span><br><span class="line">          <span class="attr">key</span>: [<span class="string">&#x27;your-key-1&#x27;</span>, <span class="string">&#x27;your-key-2&#x27;</span>],</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line"></span><br><span class="line">      <span class="comment">// show: boolean</span></span><br><span class="line">      <span class="comment">// 作用: 是否默认显示</span></span><br><span class="line">      <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;OpenStreetMap&#x27;</span>,</span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&#x27;img/basemaps/osm.png&#x27;</span>,</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;xyz&#x27;</span>,</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&#x27;https://tile.openstreetmap.org/&#123;z&#125;/&#123;x&#125;/&#123;y&#125;.png&#x27;</span>,</span><br><span class="line">      <span class="attr">show</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;离线瓦片&#x27;</span>,</span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&#x27;img/basemaps/offline.png&#x27;</span>,</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;xyz&#x27;</span>,</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&#x27;http://localhost:8080/tiles/&#123;z&#125;/&#123;x&#125;/&#123;y&#125;.png&#x27;</span>,</span><br><span class="line">      <span class="attr">show</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === 操作图层配置 ===</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">operationalLayers</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// name: string</span></span><br><span class="line">      <span class="comment">// 作用: 图层名称</span></span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;GeoJSON数据&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// type: string</span></span><br><span class="line">      <span class="comment">// 作用: 图层类型</span></span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;geojson&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// url: string</span></span><br><span class="line">      <span class="comment">// 作用: 数据地址</span></span><br><span class="line">      <span class="attr">url</span>: <span class="string">&#x27;data/sample.geojson&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// show: boolean</span></span><br><span class="line">      <span class="comment">// 作用: 是否默认显示</span></span><br><span class="line">      <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// flyTo: boolean</span></span><br><span class="line">      <span class="comment">// 作用: 加载后是否飞行到数据范围</span></span><br><span class="line">      <span class="attr">flyTo</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// popup: Object | string</span></span><br><span class="line">      <span class="comment">// 作用: 弹窗配置</span></span><br><span class="line">      <span class="attr">popup</span>: <span class="string">&#x27;all&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// style: Object</span></span><br><span class="line">      <span class="comment">// 作用: 样式配置</span></span><br><span class="line">      <span class="attr">style</span>: &#123;</span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line">        <span class="attr">width</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="attr">opacity</span>: <span class="number">0.8</span>,</span><br><span class="line">        <span class="attr">fill</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">fillColor</span>: <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line">        <span class="attr">fillOpacity</span>: <span class="number">0.3</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">  <span class="comment">// === 其他配置 ===</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// lang: string</span></span><br><span class="line">  <span class="comment">// 作用: 语言设置</span></span><br><span class="line">  <span class="comment">// 选项: &#x27;zh&#x27;, &#x27;en&#x27;</span></span><br><span class="line">  <span class="attr">lang</span>: <span class="string">&#x27;zh&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// templateValues: Object</span></span><br><span class="line">  <span class="comment">// 作用: 模板变量</span></span><br><span class="line">  <span class="attr">templateValues</span>: &#123;&#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// chinaCRS: string</span></span><br><span class="line">  <span class="comment">// 作用: 中国坐标系</span></span><br><span class="line">  <span class="comment">// 选项: &#x27;WGS84&#x27;, &#x27;GCJ02&#x27;, &#x27;BD09&#x27;</span></span><br><span class="line">  <span class="attr">chinaCRS</span>: <span class="string">&#x27;GCJ02&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// units: string</span></span><br><span class="line">  <span class="comment">// 作用: 单位制</span></span><br><span class="line">  <span class="comment">// 选项: &#x27;metric&#x27;, &#x27;imperial&#x27;</span></span><br><span class="line">  <span class="attr">units</span>: <span class="string">&#x27;metric&#x27;</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="坐标系统详解"><a href="#坐标系统详解" class="headerlink" title="坐标系统详解"></a>坐标系统详解</h2><h3 id="LngLatPoint-经纬度坐标"><a href="#LngLatPoint-经纬度坐标" class="headerlink" title="LngLatPoint 经纬度坐标"></a>LngLatPoint 经纬度坐标</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LngLatPoint - 经纬度坐标类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LngLatPoint</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">lng, lat, alt = <span class="number">0</span></span>) &#123;</span><br><span class="line">    <span class="comment">// lng: number</span></span><br><span class="line">    <span class="comment">// 作用: 经度</span></span><br><span class="line">    <span class="comment">// 范围: -180 到 180</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lng</span> = lng</span><br><span class="line"></span><br><span class="line">    <span class="comment">// lat: number</span></span><br><span class="line">    <span class="comment">// 作用: 纬度</span></span><br><span class="line">    <span class="comment">// 范围: -90 到 90</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lat</span> = lat</span><br><span class="line"></span><br><span class="line">    <span class="comment">// alt: number</span></span><br><span class="line">    <span class="comment">// 作用: 高度（米）</span></span><br><span class="line">    <span class="comment">// 默认: 0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">alt</span> = alt</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 静态方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromString - 从字符串创建</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromString</span>(<span class="params">str</span>) &#123;</span><br><span class="line">    <span class="comment">// str: string - 格式: &quot;lng,lat&quot; 或 &quot;lng,lat,alt&quot;</span></span><br><span class="line">    <span class="keyword">const</span> parts = str.<span class="title function_">split</span>(<span class="string">&#x27;,&#x27;</span>).<span class="title function_">map</span>(<span class="title class_">Number</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> mars3d.<span class="title class_">LngLatPoint</span>(parts[<span class="number">0</span>], parts[<span class="number">1</span>], parts[<span class="number">2</span>] || <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromArray - 从数组创建</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromArray</span>(<span class="params">arr</span>) &#123;</span><br><span class="line">    <span class="comment">// arr: Array - 格式: [lng, lat] 或 [lng, lat, alt]</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> mars3d.<span class="title class_">LngLatPoint</span>(arr[<span class="number">0</span>], arr[<span class="number">1</span>], arr[<span class="number">2</span>] || <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromDegrees - 从度数创建（同构造函数）</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromDegrees</span>(<span class="params">lng, lat, alt = <span class="number">0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> mars3d.<span class="title class_">LngLatPoint</span>(lng, lat, alt)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fromRadians - 从弧度创建</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">fromRadians</span>(<span class="params">lngRad, latRad, alt = <span class="number">0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> mars3d.<span class="title class_">LngLatPoint</span>(</span><br><span class="line">      mars3d.<span class="property">Util</span>.<span class="title function_">radiansToDegrees</span>(lngRad),</span><br><span class="line">      mars3d.<span class="property">Util</span>.<span class="title function_">radiansToDegrees</span>(latRad),</span><br><span class="line">      alt,</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 实例方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// toString - 转换为字符串</span></span><br><span class="line">  <span class="title function_">toString</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.lng&#125;</span>,<span class="subst">$&#123;<span class="variable language_">this</span>.lat&#125;</span>,<span class="subst">$&#123;<span class="variable language_">this</span>.alt&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// toArray - 转换为数组</span></span><br><span class="line">  <span class="title function_">toArray</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="variable language_">this</span>.<span class="property">lng</span>, <span class="variable language_">this</span>.<span class="property">lat</span>, <span class="variable language_">this</span>.<span class="property">alt</span>]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// clone - 克隆</span></span><br><span class="line">  <span class="title function_">clone</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> mars3d.<span class="title class_">LngLatPoint</span>(<span class="variable language_">this</span>.<span class="property">lng</span>, <span class="variable language_">this</span>.<span class="property">lat</span>, <span class="variable language_">this</span>.<span class="property">alt</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// equals - 比较相等</span></span><br><span class="line">  <span class="title function_">equals</span>(<span class="params">other, epsilon = <span class="number">1e-6</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="title class_">Math</span>.<span class="title function_">abs</span>(<span class="variable language_">this</span>.<span class="property">lng</span> - other.<span class="property">lng</span>) &lt; epsilon &amp;&amp;</span><br><span class="line">      <span class="title class_">Math</span>.<span class="title function_">abs</span>(<span class="variable language_">this</span>.<span class="property">lat</span> - other.<span class="property">lat</span>) &lt; epsilon &amp;&amp;</span><br><span class="line">      <span class="title class_">Math</span>.<span class="title function_">abs</span>(<span class="variable language_">this</span>.<span class="property">alt</span> - other.<span class="property">alt</span>) &lt; epsilon</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// distanceTo - 计算到另一点的距离</span></span><br><span class="line">  <span class="title function_">distanceTo</span>(<span class="params">other</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">MeasureUtil</span>.<span class="title function_">getDistance</span>([<span class="variable language_">this</span>, other])</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// format - 格式化显示</span></span><br><span class="line">  <span class="title function_">format</span>(<span class="params">type = <span class="string">&#x27;degree&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;degree&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.lng.toFixed(<span class="number">6</span>)&#125;</span>°, <span class="subst">$&#123;<span class="variable language_">this</span>.lat.toFixed(<span class="number">6</span>)&#125;</span>°`</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;dms&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> mars3d.<span class="property">Util</span>.<span class="title function_">formatDMS</span>(<span class="variable language_">this</span>.<span class="property">lng</span>, <span class="variable language_">this</span>.<span class="property">lat</span>)</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;utm&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">lonlat2utm</span>(<span class="variable language_">this</span>)</span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">toString</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> point1 = <span class="keyword">new</span> mars3d.<span class="title class_">LngLatPoint</span>(<span class="number">117.207</span>, <span class="number">31.794</span>, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">const</span> point2 = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromString</span>(<span class="string">&#x27;116.407,39.904,50&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> point3 = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>([<span class="number">121.473</span>, <span class="number">31.23</span>, <span class="number">20</span>])</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;点1:&#x27;</span>, point1.<span class="title function_">toString</span>())</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;点2格式化:&#x27;</span>, point2.<span class="title function_">format</span>(<span class="string">&#x27;dms&#x27;</span>))</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;距离:&#x27;</span>, point1.<span class="title function_">distanceTo</span>(point2), <span class="string">&#x27;米&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="坐标系转换"><a href="#坐标系转换" class="headerlink" title="坐标系转换"></a>坐标系转换</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PointTrans - 坐标转换工具类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PointTrans</span> &#123;</span><br><span class="line">  <span class="comment">// WGS84 转 GCJ02 (火星坐标系)</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">wgs84togcj02</span>(<span class="params">lng, lat</span>) &#123;</span><br><span class="line">    <span class="comment">// lng: number - WGS84经度</span></span><br><span class="line">    <span class="comment">// lat: number - WGS84纬度</span></span><br><span class="line">    <span class="comment">// 返回: &#123;lng: number, lat: number&#125;</span></span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">wgs84togcj02</span>(lng, lat)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// GCJ02 转 WGS84</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">gcj02towgs84</span>(<span class="params">lng, lat</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">gcj02towgs84</span>(lng, lat)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// GCJ02 转 BD09 (百度坐标系)</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">gcj02tobd09</span>(<span class="params">lng, lat</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">gcj02tobd09</span>(lng, lat)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// BD09 转 GCJ02</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">bd09togcj02</span>(<span class="params">lng, lat</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">bd09togcj02</span>(lng, lat)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// WGS84 转 BD09</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">wgs84tobd09</span>(<span class="params">lng, lat</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> gcj = mars3d.<span class="property">PointTrans</span>.<span class="title function_">wgs84togcj02</span>(lng, lat)</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">gcj02tobd09</span>(gcj.<span class="property">lng</span>, gcj.<span class="property">lat</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// BD09 转 WGS84</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">bd09towgs84</span>(<span class="params">lng, lat</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> gcj = mars3d.<span class="property">PointTrans</span>.<span class="title function_">bd09togcj02</span>(lng, lat)</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">gcj02towgs84</span>(gcj.<span class="property">lng</span>, gcj.<span class="property">lat</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 经纬度 转 UTM坐标</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">lonlat2utm</span>(<span class="params">point</span>) &#123;</span><br><span class="line">    <span class="comment">// point: LngLatPoint</span></span><br><span class="line">    <span class="comment">// 返回: &#123;x: number, y: number, zone: string&#125;</span></span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">lonlat2utm</span>(point)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// UTM坐标 转 经纬度</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">utm2lonlat</span>(<span class="params">utmPoint</span>) &#123;</span><br><span class="line">    <span class="comment">// utmPoint: &#123;x: number, y: number, zone: string&#125;</span></span><br><span class="line">    <span class="comment">// 返回: LngLatPoint</span></span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">utm2lonlat</span>(utmPoint)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 经纬度 转 Web墨卡托</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">lonlat2mercator</span>(<span class="params">lng, lat</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">lonlat2mercator</span>(lng, lat)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Web墨卡托 转 经纬度</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">mercator2lonlat</span>(<span class="params">x, y</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">mercator2lonlat</span>(x, y)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 地理坐标 转 笛卡尔坐标</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">lonlat2cartesian</span>(<span class="params">lng, lat, alt = <span class="number">0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">lonlat2cartesian</span>(lng, lat, alt)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 笛卡尔坐标 转 地理坐标</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">cartesian2lonlat</span>(<span class="params">cartesian</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">cartesian2lonlat</span>(cartesian)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 坐标转换示例</span></span><br><span class="line"><span class="keyword">const</span> wgs84Point = &#123; <span class="attr">lng</span>: <span class="number">116.407</span>, <span class="attr">lat</span>: <span class="number">39.904</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// WGS84 转换为其他坐标系</span></span><br><span class="line"><span class="keyword">const</span> gcj02Point = mars3d.<span class="property">PointTrans</span>.<span class="title function_">wgs84togcj02</span>(wgs84Point.<span class="property">lng</span>, wgs84Point.<span class="property">lat</span>)</span><br><span class="line"><span class="keyword">const</span> bd09Point = mars3d.<span class="property">PointTrans</span>.<span class="title function_">wgs84tobd09</span>(wgs84Point.<span class="property">lng</span>, wgs84Point.<span class="property">lat</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;WGS84:&#x27;</span>, wgs84Point)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;GCJ02:&#x27;</span>, gcj02Point)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;BD09:&#x27;</span>, bd09Point)</span><br><span class="line"></span><br><span class="line"><span class="comment">// UTM坐标转换</span></span><br><span class="line"><span class="keyword">const</span> point = <span class="keyword">new</span> mars3d.<span class="title class_">LngLatPoint</span>(<span class="number">117.207</span>, <span class="number">31.794</span>)</span><br><span class="line"><span class="keyword">const</span> utmPoint = mars3d.<span class="property">PointTrans</span>.<span class="title function_">lonlat2utm</span>(point)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;UTM坐标:&#x27;</span>, utmPoint)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 笛卡尔坐标转换</span></span><br><span class="line"><span class="keyword">const</span> cartesian = mars3d.<span class="property">PointTrans</span>.<span class="title function_">lonlat2cartesian</span>(<span class="number">117.207</span>, <span class="number">31.794</span>, <span class="number">100</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;笛卡尔坐标:&#x27;</span>, cartesian)</span><br></pre></td></tr></table></figure><h3 id="Cesium坐标转换"><a href="#Cesium坐标转换" class="headerlink" title="Cesium坐标转换"></a>Cesium坐标转换</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Mars3D中的Cesium坐标转换</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CesiumCoordinate</span> &#123;</span><br><span class="line">  <span class="comment">// 屏幕坐标转地理坐标</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">screenToCartographic</span>(<span class="params">map, screenPoint</span>) &#123;</span><br><span class="line">    <span class="comment">// screenPoint: &#123;x: number, y: number&#125;</span></span><br><span class="line">    <span class="comment">// 返回: LngLatPoint | undefined</span></span><br><span class="line">    <span class="keyword">const</span> cartographic = map.<span class="property">camera</span>.<span class="title function_">pickEllipsoid</span>(screenPoint)</span><br><span class="line">    <span class="keyword">if</span> (cartographic) &#123;</span><br><span class="line">      <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">cartesian2lonlat</span>(cartographic)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 地理坐标转屏幕坐标</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">cartographicToScreen</span>(<span class="params">map, lngLatPoint</span>) &#123;</span><br><span class="line">    <span class="comment">// lngLatPoint: LngLatPoint</span></span><br><span class="line">    <span class="comment">// 返回: &#123;x: number, y: number&#125; | undefined</span></span><br><span class="line">    <span class="keyword">const</span> cartesian = mars3d.<span class="property">PointTrans</span>.<span class="title function_">lonlat2cartesian</span>(</span><br><span class="line">      lngLatPoint.<span class="property">lng</span>,</span><br><span class="line">      lngLatPoint.<span class="property">lat</span>,</span><br><span class="line">      lngLatPoint.<span class="property">alt</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">Cesium</span>.<span class="property">SceneTransforms</span>.<span class="title function_">worldToWindowCoordinates</span>(map.<span class="property">scene</span>, cartesian)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 相机坐标转世界坐标</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">cameraToWorld</span>(<span class="params">map, cameraPoint</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> map.<span class="property">camera</span>.<span class="title function_">cameraToWorldCoordinates</span>(cameraPoint)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 世界坐标转相机坐标</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">worldToCamera</span>(<span class="params">map, worldPoint</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> map.<span class="property">camera</span>.<span class="title function_">worldToCameraCoordinates</span>(worldPoint)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line">map.<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 获取点击的屏幕坐标</span></span><br><span class="line">  <span class="keyword">const</span> screenPoint = &#123; <span class="attr">x</span>: event.<span class="property">windowPosition</span>.<span class="property">x</span>, <span class="attr">y</span>: event.<span class="property">windowPosition</span>.<span class="property">y</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 转换为地理坐标</span></span><br><span class="line">  <span class="keyword">const</span> geoPoint = <span class="title class_">CesiumCoordinate</span>.<span class="title function_">screenToCartographic</span>(map, screenPoint)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (geoPoint) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;点击位置:&#x27;</span>, geoPoint.<span class="title function_">format</span>(<span class="string">&#x27;degree&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 反向转换验证</span></span><br><span class="line">    <span class="keyword">const</span> backToScreen = <span class="title class_">CesiumCoordinate</span>.<span class="title function_">cartographicToScreen</span>(map, geoPoint)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;屏幕坐标:&#x27;</span>, backToScreen)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="图层系统完整属性"><a href="#图层系统完整属性" class="headerlink" title="图层系统完整属性"></a>图层系统完整属性</h2><h3 id="BaseLayer-底图图层"><a href="#BaseLayer-底图图层" class="headerlink" title="BaseLayer 底图图层"></a>BaseLayer 底图图层</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BaseLayer - 底图图层基类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseLayer</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// id: string</span></span><br><span class="line">    <span class="comment">// 作用: 图层唯一标识</span></span><br><span class="line">    <span class="comment">// 默认: 自动生成</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = options.<span class="property">id</span> || mars3d.<span class="property">Util</span>.<span class="title function_">uuid</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// name: string</span></span><br><span class="line">    <span class="comment">// 作用: 图层名称</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = options.<span class="property">name</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// type: string</span></span><br><span class="line">    <span class="comment">// 作用: 图层类型</span></span><br><span class="line">    <span class="comment">// 选项: &#x27;xyz&#x27;, &#x27;wms&#x27;, &#x27;wmts&#x27;, &#x27;arcgis&#x27;, &#x27;tdt&#x27;, &#x27;baidu&#x27;, &#x27;gaode&#x27;, &#x27;tencent&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">type</span> = options.<span class="property">type</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// url: string</span></span><br><span class="line">    <span class="comment">// 作用: 服务地址</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">url</span> = options.<span class="property">url</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// show: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// alpha: number</span></span><br><span class="line">    <span class="comment">// 作用: 透明度</span></span><br><span class="line">    <span class="comment">// 默认: 1.0</span></span><br><span class="line">    <span class="comment">// 范围: 0.0 - 1.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">alpha</span> = options.<span class="property">alpha</span> !== <span class="literal">undefined</span> ? options.<span class="property">alpha</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// brightness: number</span></span><br><span class="line">    <span class="comment">// 作用: 亮度</span></span><br><span class="line">    <span class="comment">// 默认: 1.0</span></span><br><span class="line">    <span class="comment">// 范围: 0.0 - 无限制</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">brightness</span> = options.<span class="property">brightness</span> !== <span class="literal">undefined</span> ? options.<span class="property">brightness</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// contrast: number</span></span><br><span class="line">    <span class="comment">// 作用: 对比度</span></span><br><span class="line">    <span class="comment">// 默认: 1.0</span></span><br><span class="line">    <span class="comment">// 范围: 0.0 - 无限制</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">contrast</span> = options.<span class="property">contrast</span> !== <span class="literal">undefined</span> ? options.<span class="property">contrast</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// hue: number</span></span><br><span class="line">    <span class="comment">// 作用: 色调</span></span><br><span class="line">    <span class="comment">// 默认: 0.0</span></span><br><span class="line">    <span class="comment">// 范围: 0.0 - 2π</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hue</span> = options.<span class="property">hue</span> !== <span class="literal">undefined</span> ? options.<span class="property">hue</span> : <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// saturation: number</span></span><br><span class="line">    <span class="comment">// 作用: 饱和度</span></span><br><span class="line">    <span class="comment">// 默认: 1.0</span></span><br><span class="line">    <span class="comment">// 范围: 0.0 - 无限制</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">saturation</span> = options.<span class="property">saturation</span> !== <span class="literal">undefined</span> ? options.<span class="property">saturation</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// gamma: number</span></span><br><span class="line">    <span class="comment">// 作用: 伽马值</span></span><br><span class="line">    <span class="comment">// 默认: 1.0</span></span><br><span class="line">    <span class="comment">// 范围: 0.1 - 无限制</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gamma</span> = options.<span class="property">gamma</span> !== <span class="literal">undefined</span> ? options.<span class="property">gamma</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// maximumLevel: number</span></span><br><span class="line">    <span class="comment">// 作用: 最大层级</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maximumLevel</span> = options.<span class="property">maximumLevel</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// minimumLevel: number</span></span><br><span class="line">    <span class="comment">// 作用: 最小层级</span></span><br><span class="line">    <span class="comment">// 默认: 0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">minimumLevel</span> = options.<span class="property">minimumLevel</span> !== <span class="literal">undefined</span> ? options.<span class="property">minimumLevel</span> : <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// rectangle: Object</span></span><br><span class="line">    <span class="comment">// 作用: 显示范围</span></span><br><span class="line">    <span class="comment">// 格式: &#123;xmin: number, ymin: number, xmax: number, ymax: number&#125;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">rectangle</span> = options.<span class="property">rectangle</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// proxy: string</span></span><br><span class="line">    <span class="comment">// 作用: 代理地址</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">proxy</span> = options.<span class="property">proxy</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// subdomains: Array&lt;string&gt;</span></span><br><span class="line">    <span class="comment">// 作用: 子域名列表</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="comment">// 用途: 负载均衡</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">subdomains</span> = options.<span class="property">subdomains</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// maximumAnisotropy: number</span></span><br><span class="line">    <span class="comment">// 作用: 最大各向异性过滤</span></span><br><span class="line">    <span class="comment">// 默认: 16</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maximumAnisotropy</span> =</span><br><span class="line">      options.<span class="property">maximumAnisotropy</span> !== <span class="literal">undefined</span> ? options.<span class="property">maximumAnisotropy</span> : <span class="number">16</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// credit: string</span></span><br><span class="line">    <span class="comment">// 作用: 版权信息</span></span><br><span class="line">    <span class="comment">// 默认: undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">credit</span> = options.<span class="property">credit</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// addTo - 添加到地图</span></span><br><span class="line">  <span class="title function_">addTo</span>(<span class="params">map</span>) &#123;</span><br><span class="line">    map.<span class="property">basemap</span> = <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// remove - 从地图移除</span></span><br><span class="line">  <span class="title function_">remove</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">map</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">map</span>.<span class="property">basemap</span> = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setOpacity - 设置透明度</span></span><br><span class="line">  <span class="title function_">setOpacity</span>(<span class="params">alpha</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">alpha</span> = alpha</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">update</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setBrightness - 设置亮度</span></span><br><span class="line">  <span class="title function_">setBrightness</span>(<span class="params">brightness</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">brightness</span> = brightness</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">update</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setContrast - 设置对比度</span></span><br><span class="line">  <span class="title function_">setContrast</span>(<span class="params">contrast</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">contrast</span> = contrast</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">update</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// update - 更新图层</span></span><br><span class="line">  <span class="title function_">update</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 触发图层更新</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// flyTo - 飞行到图层范围</span></span><br><span class="line">  <span class="title function_">flyTo</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">rectangle</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">map</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">flyToRectangle</span>(<span class="variable language_">this</span>.<span class="property">rectangle</span>, options)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// XYZ图层</span></span><br><span class="line"><span class="keyword">const</span> xyzLayer = <span class="keyword">new</span> mars3d.<span class="property">layer</span>.<span class="title class_">XyzLayer</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;OpenStreetMap&#x27;</span>,</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;https://tile.openstreetmap.org/&#123;z&#125;/&#123;x&#125;/&#123;y&#125;.png&#x27;</span>,</span><br><span class="line">  <span class="attr">maximumLevel</span>: <span class="number">18</span>,</span><br><span class="line">  <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 天地图图层</span></span><br><span class="line"><span class="keyword">const</span> tdtLayer = <span class="keyword">new</span> mars3d.<span class="property">layer</span>.<span class="title class_">TdtLayer</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;天地图影像&#x27;</span>,</span><br><span class="line">  <span class="attr">layer</span>: <span class="string">&#x27;img_d&#x27;</span>,</span><br><span class="line">  <span class="attr">key</span>: [<span class="string">&#x27;your-key-1&#x27;</span>, <span class="string">&#x27;your-key-2&#x27;</span>],</span><br><span class="line">  <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// WMS图层</span></span><br><span class="line"><span class="keyword">const</span> wmsLayer = <span class="keyword">new</span> mars3d.<span class="property">layer</span>.<span class="title class_">WmsLayer</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;WMS服务&#x27;</span>,</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;https://example.com/wms&#x27;</span>,</span><br><span class="line">  <span class="attr">layers</span>: <span class="string">&#x27;layer_name&#x27;</span>,</span><br><span class="line">  <span class="attr">parameters</span>: &#123;</span><br><span class="line">    <span class="attr">format</span>: <span class="string">&#x27;image/png&#x27;</span>,</span><br><span class="line">    <span class="attr">transparent</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ArcGIS图层</span></span><br><span class="line"><span class="keyword">const</span> arcgisLayer = <span class="keyword">new</span> mars3d.<span class="property">layer</span>.<span class="title class_">ArcGisLayer</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;ArcGIS服务&#x27;</span>,</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer&#x27;</span>,</span><br><span class="line">  <span class="attr">maximumLevel</span>: <span class="number">17</span>,</span><br><span class="line">  <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line">map.<span class="title function_">addLayer</span>(xyzLayer)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调整图层样式</span></span><br><span class="line">xyzLayer.<span class="title function_">setOpacity</span>(<span class="number">0.8</span>)</span><br><span class="line">xyzLayer.<span class="title function_">setBrightness</span>(<span class="number">1.2</span>)</span><br><span class="line">xyzLayer.<span class="title function_">setContrast</span>(<span class="number">1.1</span>)</span><br></pre></td></tr></table></figure><h3 id="GroupLayer-图层组"><a href="#GroupLayer-图层组" class="headerlink" title="GroupLayer 图层组"></a>GroupLayer 图层组</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GroupLayer - 图层组</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GroupLayer</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// layers: Array&lt;BaseLayer&gt;</span></span><br><span class="line">    <span class="comment">// 作用: 子图层数组</span></span><br><span class="line">    <span class="comment">// 默认: []</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layers</span> = options.<span class="property">layers</span> || []</span><br><span class="line"></span><br><span class="line">    <span class="comment">// name: string</span></span><br><span class="line">    <span class="comment">// 作用: 图层组名称</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = options.<span class="property">name</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// show: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示整个图层组</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// addLayer - 添加子图层</span></span><br><span class="line">  <span class="title function_">addLayer</span>(<span class="params">layer</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layers</span>.<span class="title function_">push</span>(layer)</span><br><span class="line">    layer.<span class="property">parent</span> = <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// removeLayer - 移除子图层</span></span><br><span class="line">  <span class="title function_">removeLayer</span>(<span class="params">layer</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> index = <span class="variable language_">this</span>.<span class="property">layers</span>.<span class="title function_">indexOf</span>(layer)</span><br><span class="line">    <span class="keyword">if</span> (index &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">layers</span>.<span class="title function_">splice</span>(index, <span class="number">1</span>)</span><br><span class="line">      layer.<span class="property">parent</span> = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getLayerById - 根据ID获取图层</span></span><br><span class="line">  <span class="title function_">getLayerById</span>(<span class="params">id</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">layers</span>.<span class="title function_">find</span>(<span class="function">(<span class="params">layer</span>) =&gt;</span> layer.<span class="property">id</span> === id)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getLayerByName - 根据名称获取图层</span></span><br><span class="line">  <span class="title function_">getLayerByName</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">layers</span>.<span class="title function_">find</span>(<span class="function">(<span class="params">layer</span>) =&gt;</span> layer.<span class="property">name</span> === name)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setOpacity - 设置所有子图层透明度</span></span><br><span class="line">  <span class="title function_">setOpacity</span>(<span class="params">alpha</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layers</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">layer</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (layer.<span class="property">setOpacity</span>) &#123;</span><br><span class="line">        layer.<span class="title function_">setOpacity</span>(alpha)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setShow - 设置显示状态</span></span><br><span class="line">  <span class="title function_">setShow</span>(<span class="params">show</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = show</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layers</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">layer</span>) =&gt;</span> &#123;</span><br><span class="line">      layer.<span class="property">show</span> = show</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> groupLayer = <span class="keyword">new</span> mars3d.<span class="property">layer</span>.<span class="title class_">GroupLayer</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;天地图影像组&#x27;</span>,</span><br><span class="line">  <span class="attr">layers</span>: [</span><br><span class="line">    <span class="keyword">new</span> mars3d.<span class="property">layer</span>.<span class="title class_">TdtLayer</span>(&#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;底图&#x27;</span>,</span><br><span class="line">      <span class="attr">layer</span>: <span class="string">&#x27;img_d&#x27;</span>,</span><br><span class="line">      <span class="attr">key</span>: [<span class="string">&#x27;your-key&#x27;</span>],</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> mars3d.<span class="property">layer</span>.<span class="title class_">TdtLayer</span>(&#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;注记&#x27;</span>,</span><br><span class="line">      <span class="attr">layer</span>: <span class="string">&#x27;img_z&#x27;</span>,</span><br><span class="line">      <span class="attr">key</span>: [<span class="string">&#x27;your-key&#x27;</span>],</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">map.<span class="title function_">addLayer</span>(groupLayer)</span><br></pre></td></tr></table></figure><h2 id="矢量数据详解"><a href="#矢量数据详解" class="headerlink" title="矢量数据详解"></a>矢量数据详解</h2><h3 id="GraphicLayer-矢量图层"><a href="#GraphicLayer-矢量图层" class="headerlink" title="GraphicLayer 矢量图层"></a>GraphicLayer 矢量图层</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GraphicLayer - 矢量图层</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GraphicLayer</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// id: string</span></span><br><span class="line">    <span class="comment">// 作用: 图层唯一标识</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = options.<span class="property">id</span> || mars3d.<span class="property">Util</span>.<span class="title function_">uuid</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// name: string</span></span><br><span class="line">    <span class="comment">// 作用: 图层名称</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = options.<span class="property">name</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// show: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// allowDrillPick: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否允许钻取拾取</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">allowDrillPick</span> = options.<span class="property">allowDrillPick</span> !== <span class="literal">undefined</span> ? options.<span class="property">allowDrillPick</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// flyTo: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 加载后是否飞行到数据范围</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">flyTo</span> = options.<span class="property">flyTo</span> !== <span class="literal">undefined</span> ? options.<span class="property">flyTo</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// popup: Object | string | function</span></span><br><span class="line">    <span class="comment">// 作用: 弹窗配置</span></span><br><span class="line">    <span class="comment">// 类型: &#x27;all&#x27; | &#x27;模板字符串&#x27; | 配置对象 | 回调函数</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">popup</span> = options.<span class="property">popup</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// tooltip: Object | string | function</span></span><br><span class="line">    <span class="comment">// 作用: 工具提示配置</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tooltip</span> = options.<span class="property">tooltip</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// contextmenu: Array | function</span></span><br><span class="line">    <span class="comment">// 作用: 右键菜单配置</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">contextmenu</span> = options.<span class="property">contextmenu</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// enabledEvent: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否启用鼠标事件</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">enabledEvent</span> = options.<span class="property">enabledEvent</span> !== <span class="literal">undefined</span> ? options.<span class="property">enabledEvent</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// clustering: Object</span></span><br><span class="line">    <span class="comment">// 作用: 聚合配置</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clustering</span> = options.<span class="property">clustering</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// symbol: Object</span></span><br><span class="line">    <span class="comment">// 作用: 统一样式配置</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">symbol</span> = options.<span class="property">symbol</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// style: Object | function</span></span><br><span class="line">    <span class="comment">// 作用: 样式配置</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = options.<span class="property">style</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// filter: function</span></span><br><span class="line">    <span class="comment">// 作用: 数据过滤函数</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">filter</span> = options.<span class="property">filter</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// hasEdit: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否支持编辑</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hasEdit</span> = options.<span class="property">hasEdit</span> !== <span class="literal">undefined</span> ? options.<span class="property">hasEdit</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// isAutoEditing: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否自动进入编辑状态</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isAutoEditing</span> = options.<span class="property">isAutoEditing</span> !== <span class="literal">undefined</span> ? options.<span class="property">isAutoEditing</span> : <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// addGraphic - 添加矢量数据</span></span><br><span class="line">  <span class="title function_">addGraphic</span>(<span class="params">graphic</span>) &#123;</span><br><span class="line">    <span class="comment">// graphic: Graphic - 矢量数据对象</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="title function_">push</span>(graphic)</span><br><span class="line">    graphic.<span class="property">layer</span> = <span class="variable language_">this</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">fire</span>(<span class="string">&#x27;addGraphic&#x27;</span>, &#123; graphic &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// removeGraphic - 移除矢量数据</span></span><br><span class="line">  <span class="title function_">removeGraphic</span>(<span class="params">graphic</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> index = <span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="title function_">indexOf</span>(graphic)</span><br><span class="line">    <span class="keyword">if</span> (index &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="title function_">splice</span>(index, <span class="number">1</span>)</span><br><span class="line">      graphic.<span class="property">layer</span> = <span class="literal">null</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">fire</span>(<span class="string">&#x27;removeGraphic&#x27;</span>, &#123; graphic &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getGraphicById - 根据ID获取矢量数据</span></span><br><span class="line">  <span class="title function_">getGraphicById</span>(<span class="params">id</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="title function_">find</span>(<span class="function">(<span class="params">graphic</span>) =&gt;</span> graphic.<span class="property">id</span> === id)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getGraphicsByAttr - 根据属性获取矢量数据</span></span><br><span class="line">  <span class="title function_">getGraphicsByAttr</span>(<span class="params">attrName, attrVal</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">graphic</span>) =&gt;</span> graphic.<span class="property">attr</span> &amp;&amp; graphic.<span class="property">attr</span>[attrName] === attrVal)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// eachGraphic - 遍历所有矢量数据</span></span><br><span class="line">  <span class="title function_">eachGraphic</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="title function_">forEach</span>(callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// clear - 清空所有数据</span></span><br><span class="line">  <span class="title function_">clear</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">graphic</span>) =&gt;</span> graphic.<span class="title function_">destroy</span>())</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphics</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">fire</span>(<span class="string">&#x27;clear&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// load - 加载外部数据</span></span><br><span class="line">  <span class="title function_">load</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="comment">// options: Object</span></span><br><span class="line">    <span class="comment">// url: string - 数据地址</span></span><br><span class="line">    <span class="comment">// type: string - 数据类型 (&#x27;geojson&#x27;, &#x27;kml&#x27;, &#x27;czml&#x27;, &#x27;json&#x27;)</span></span><br><span class="line">    <span class="comment">// symbol: Object - 样式配置</span></span><br><span class="line">    <span class="comment">// callback: function - 回调函数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">Util</span>.<span class="title function_">fetchJson</span>(&#123; <span class="attr">url</span>: options.<span class="property">url</span> &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">loadData</span>(data, options)</span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">callback</span>) &#123;</span><br><span class="line">        options.<span class="title function_">callback</span>(data)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// loadData - 加载数据</span></span><br><span class="line">  <span class="title function_">loadData</span>(<span class="params">data, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (data.<span class="property">type</span> === <span class="string">&#x27;FeatureCollection&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// GeoJSON数据</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">loadGeoJSON</span>(data, options)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(data)) &#123;</span><br><span class="line">      <span class="comment">// 数组数据</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">loadArray</span>(data, options)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// loadGeoJSON - 加载GeoJSON数据</span></span><br><span class="line">  <span class="title function_">loadGeoJSON</span>(<span class="params">geojson, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    geojson.<span class="property">features</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">feature</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> graphic = <span class="variable language_">this</span>.<span class="title function_">createGraphicFromFeature</span>(feature, options)</span><br><span class="line">      <span class="keyword">if</span> (graphic) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">addGraphic</span>(graphic)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">flyTo</span> || <span class="variable language_">this</span>.<span class="property">flyTo</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">flyTo</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// createGraphicFromFeature - 从Feature创建矢量数据</span></span><br><span class="line">  <span class="title function_">createGraphicFromFeature</span>(<span class="params">feature, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> geometry = feature.<span class="property">geometry</span></span><br><span class="line">    <span class="keyword">const</span> properties = feature.<span class="property">properties</span> || &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> graphic</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (geometry.<span class="property">type</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;Point&#x27;</span>:</span><br><span class="line">        graphic = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PointEntity</span>(&#123;</span><br><span class="line">          <span class="attr">position</span>: geometry.<span class="property">coordinates</span>,</span><br><span class="line">          <span class="attr">style</span>: <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, <span class="variable language_">this</span>.<span class="property">symbol</span>, options.<span class="property">symbol</span>),</span><br><span class="line">          <span class="attr">attr</span>: properties,</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;LineString&#x27;</span>:</span><br><span class="line">        graphic = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolylineEntity</span>(&#123;</span><br><span class="line">          <span class="attr">positions</span>: geometry.<span class="property">coordinates</span>,</span><br><span class="line">          <span class="attr">style</span>: <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, <span class="variable language_">this</span>.<span class="property">symbol</span>, options.<span class="property">symbol</span>),</span><br><span class="line">          <span class="attr">attr</span>: properties,</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;Polygon&#x27;</span>:</span><br><span class="line">        graphic = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolygonEntity</span>(&#123;</span><br><span class="line">          <span class="attr">positions</span>: geometry.<span class="property">coordinates</span>[<span class="number">0</span>], <span class="comment">// 暂时只处理外环</span></span><br><span class="line">          <span class="attr">style</span>: <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, <span class="variable language_">this</span>.<span class="property">symbol</span>, options.<span class="property">symbol</span>),</span><br><span class="line">          <span class="attr">attr</span>: properties,</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;不支持的几何类型:&#x27;</span>, geometry.<span class="property">type</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> graphic</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// toGeoJSON - 导出为GeoJSON</span></span><br><span class="line">  <span class="title function_">toGeoJSON</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> features = <span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">graphic</span>) =&gt;</span> graphic.<span class="title function_">toGeoJSON</span>()).<span class="title function_">filter</span>(<span class="title class_">Boolean</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;FeatureCollection&#x27;</span>,</span><br><span class="line">      <span class="attr">features</span>: features,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// flyTo - 飞行到图层范围</span></span><br><span class="line">  <span class="title function_">flyTo</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> bounds = <span class="variable language_">this</span>.<span class="title function_">getBounds</span>()</span><br><span class="line">    <span class="keyword">if</span> (bounds) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">flyToExtent</span>(bounds, options)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getBounds - 获取数据范围</span></span><br><span class="line">  <span class="title function_">getBounds</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> xmin = <span class="title class_">Infinity</span>,</span><br><span class="line">      ymin = <span class="title class_">Infinity</span>,</span><br><span class="line">      xmax = -<span class="title class_">Infinity</span>,</span><br><span class="line">      ymax = -<span class="title class_">Infinity</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">graphic</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> bounds = graphic.<span class="title function_">getBounds</span>()</span><br><span class="line">      <span class="keyword">if</span> (bounds) &#123;</span><br><span class="line">        xmin = <span class="title class_">Math</span>.<span class="title function_">min</span>(xmin, bounds.<span class="property">xmin</span>)</span><br><span class="line">        ymin = <span class="title class_">Math</span>.<span class="title function_">min</span>(ymin, bounds.<span class="property">ymin</span>)</span><br><span class="line">        xmax = <span class="title class_">Math</span>.<span class="title function_">max</span>(xmax, bounds.<span class="property">xmax</span>)</span><br><span class="line">        ymax = <span class="title class_">Math</span>.<span class="title function_">max</span>(ymax, bounds.<span class="property">ymax</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; xmin, ymin, xmax, ymax &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// enableEdit - 启用编辑</span></span><br><span class="line">  <span class="title function_">enableEdit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hasEdit</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">graphic</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (graphic.<span class="property">enableEdit</span>) &#123;</span><br><span class="line">        graphic.<span class="title function_">enableEdit</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// disableEdit - 禁用编辑</span></span><br><span class="line">  <span class="title function_">disableEdit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hasEdit</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">graphic</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (graphic.<span class="property">disableEdit</span>) &#123;</span><br><span class="line">        graphic.<span class="title function_">disableEdit</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> graphicLayer = <span class="keyword">new</span> mars3d.<span class="property">layer</span>.<span class="title class_">GraphicLayer</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;矢量数据图层&#x27;</span>,</span><br><span class="line">  <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">popup</span>: <span class="string">&#x27;all&#x27;</span>,</span><br><span class="line">  <span class="attr">symbol</span>: &#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&#x27;#ff0000&#x27;</span>,</span><br><span class="line">    <span class="attr">width</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">opacity</span>: <span class="number">0.8</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">map.<span class="title function_">addLayer</span>(graphicLayer)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载GeoJSON数据</span></span><br><span class="line">graphicLayer.<span class="title function_">load</span>(&#123;</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;data/sample.geojson&#x27;</span>,</span><br><span class="line">  <span class="attr">symbol</span>: &#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line">    <span class="attr">width</span>: <span class="number">2</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">flyTo</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加点数据</span></span><br><span class="line"><span class="keyword">const</span> pointGraphic = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PointEntity</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: [<span class="number">117.207</span>, <span class="number">31.794</span>, <span class="number">100</span>],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&#x27;#ff0000&#x27;</span>,</span><br><span class="line">    <span class="attr">pixelSize</span>: <span class="number">10</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">attr</span>: &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;测试点&#x27;</span>,</span><br><span class="line">    <span class="attr">remark</span>: <span class="string">&#x27;这是一个测试点&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">graphicLayer.<span class="title function_">addGraphic</span>(pointGraphic)</span><br></pre></td></tr></table></figure><h3 id="Graphic-矢量图形类型"><a href="#Graphic-矢量图形类型" class="headerlink" title="Graphic 矢量图形类型"></a>Graphic 矢量图形类型</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PointEntity - 点实体</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PointEntity</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// position: Array | LngLatPoint</span></span><br><span class="line">    <span class="comment">// 作用: 点的位置</span></span><br><span class="line">    <span class="comment">// 格式: [lng, lat, alt] 或 LngLatPoint对象</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">position</span> = options.<span class="property">position</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// style: Object</span></span><br><span class="line">    <span class="comment">// 作用: 点的样式</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// color: string</span></span><br><span class="line">        <span class="comment">// 作用: 点的颜色</span></span><br><span class="line">        <span class="comment">// 默认: &#x27;#ffff00&#x27;</span></span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// pixelSize: number</span></span><br><span class="line">        <span class="comment">// 作用: 点的像素大小</span></span><br><span class="line">        <span class="comment">// 默认: 10</span></span><br><span class="line">        <span class="attr">pixelSize</span>: <span class="number">10</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outlineColor: string</span></span><br><span class="line">        <span class="comment">// 作用: 轮廓颜色</span></span><br><span class="line">        <span class="comment">// 默认: &#x27;#000000&#x27;</span></span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="string">&#x27;#000000&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outlineWidth: number</span></span><br><span class="line">        <span class="comment">// 作用: 轮廓宽度</span></span><br><span class="line">        <span class="comment">// 默认: 0</span></span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// scaleByDistance: Object</span></span><br><span class="line">        <span class="comment">// 作用: 基于距离的缩放</span></span><br><span class="line">        <span class="comment">// 格式: &#123;near: 距离, nearValue: 缩放值, far: 距离, farValue: 缩放值&#125;</span></span><br><span class="line">        <span class="attr">scaleByDistance</span>: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// heightReference: number</span></span><br><span class="line">        <span class="comment">// 作用: 高度参考</span></span><br><span class="line">        <span class="comment">// 选项: 0(NONE), 1(CLAMP_TO_GROUND), 2(RELATIVE_TO_GROUND)</span></span><br><span class="line">        <span class="attr">heightReference</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// disableDepthTestDistance: number</span></span><br><span class="line">        <span class="comment">// 作用: 禁用深度测试距离</span></span><br><span class="line">        <span class="comment">// 默认: 0</span></span><br><span class="line">        <span class="attr">disableDepthTestDistance</span>: <span class="number">0</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// attr: Object</span></span><br><span class="line">    <span class="comment">// 作用: 业务属性数据</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">attr</span> = options.<span class="property">attr</span> || &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// popup: Object | string | function</span></span><br><span class="line">    <span class="comment">// 作用: 弹窗配置</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">popup</span> = options.<span class="property">popup</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// tooltip: Object | string | function</span></span><br><span class="line">    <span class="comment">// 作用: 工具提示配置</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tooltip</span> = options.<span class="property">tooltip</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BillboardEntity - 图标实体</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BillboardEntity</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">position</span> = options.<span class="property">position</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// image: string</span></span><br><span class="line">        <span class="comment">// 作用: 图标图片地址</span></span><br><span class="line">        <span class="attr">image</span>: <span class="string">&#x27;img/marker.png&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// scale: number</span></span><br><span class="line">        <span class="comment">// 作用: 缩放比例</span></span><br><span class="line">        <span class="comment">// 默认: 1.0</span></span><br><span class="line">        <span class="attr">scale</span>: <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// horizontalOrigin: number</span></span><br><span class="line">        <span class="comment">// 作用: 水平对齐方式</span></span><br><span class="line">        <span class="comment">// 选项: 0(CENTER), 1(LEFT), 2(RIGHT)</span></span><br><span class="line">        <span class="attr">horizontalOrigin</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// verticalOrigin: number</span></span><br><span class="line">        <span class="comment">// 作用: 垂直对齐方式</span></span><br><span class="line">        <span class="comment">// 选项: 0(CENTER), 1(BOTTOM), 2(BASELINE), 3(TOP)</span></span><br><span class="line">        <span class="attr">verticalOrigin</span>: <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// width: number</span></span><br><span class="line">        <span class="comment">// 作用: 图标宽度</span></span><br><span class="line">        <span class="attr">width</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// height: number</span></span><br><span class="line">        <span class="comment">// 作用: 图标高度</span></span><br><span class="line">        <span class="attr">height</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// rotation: number</span></span><br><span class="line">        <span class="comment">// 作用: 旋转角度（弧度）</span></span><br><span class="line">        <span class="comment">// 默认: 0</span></span><br><span class="line">        <span class="attr">rotation</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// opacity: number</span></span><br><span class="line">        <span class="comment">// 作用: 透明度</span></span><br><span class="line">        <span class="comment">// 默认: 1.0</span></span><br><span class="line">        <span class="comment">// 范围: 0.0 - 1.0</span></span><br><span class="line">        <span class="attr">opacity</span>: <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// color: string</span></span><br><span class="line">        <span class="comment">// 作用: 混合颜色</span></span><br><span class="line">        <span class="comment">// 默认: &#x27;#ffffff&#x27;</span></span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// pixelOffset: Array</span></span><br><span class="line">        <span class="comment">// 作用: 像素偏移</span></span><br><span class="line">        <span class="comment">// 格式: [x, y]</span></span><br><span class="line">        <span class="attr">pixelOffset</span>: [<span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line"></span><br><span class="line">        <span class="comment">// scaleByDistance: Object</span></span><br><span class="line">        <span class="comment">// 作用: 基于距离的缩放</span></span><br><span class="line">        <span class="attr">scaleByDistance</span>: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// distanceDisplayCondition: Object</span></span><br><span class="line">        <span class="comment">// 作用: 距离显示条件</span></span><br><span class="line">        <span class="comment">// 格式: &#123;near: 距离, far: 距离&#125;</span></span><br><span class="line">        <span class="attr">distanceDisplayCondition</span>: <span class="literal">null</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">attr</span> = options.<span class="property">attr</span> || &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LabelEntity - 文字标签实体</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LabelEntity</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">position</span> = options.<span class="property">position</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// text: string</span></span><br><span class="line">        <span class="comment">// 作用: 显示文字</span></span><br><span class="line">        <span class="attr">text</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// font: string</span></span><br><span class="line">        <span class="comment">// 作用: 字体样式</span></span><br><span class="line">        <span class="comment">// 默认: &#x27;28px sans-serif&#x27;</span></span><br><span class="line">        <span class="attr">font</span>: <span class="string">&#x27;28px sans-serif&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// color: string</span></span><br><span class="line">        <span class="comment">// 作用: 文字颜色</span></span><br><span class="line">        <span class="comment">// 默认: &#x27;#ffffff&#x27;</span></span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outlineColor: string</span></span><br><span class="line">        <span class="comment">// 作用: 轮廓颜色</span></span><br><span class="line">        <span class="comment">// 默认: &#x27;#000000&#x27;</span></span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="string">&#x27;#000000&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outlineWidth: number</span></span><br><span class="line">        <span class="comment">// 作用: 轮廓宽度</span></span><br><span class="line">        <span class="comment">// 默认: 0</span></span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// backgroundColor: string</span></span><br><span class="line">        <span class="comment">// 作用: 背景颜色</span></span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// backgroundPadding: Array</span></span><br><span class="line">        <span class="comment">// 作用: 背景内边距</span></span><br><span class="line">        <span class="comment">// 格式: [x, y]</span></span><br><span class="line">        <span class="attr">backgroundPadding</span>: [<span class="number">7</span>, <span class="number">5</span>],</span><br><span class="line"></span><br><span class="line">        <span class="comment">// pixelOffset: Array</span></span><br><span class="line">        <span class="comment">// 作用: 像素偏移</span></span><br><span class="line">        <span class="attr">pixelOffset</span>: [<span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line"></span><br><span class="line">        <span class="comment">// horizontalOrigin: number</span></span><br><span class="line">        <span class="comment">// 作用: 水平对齐方式</span></span><br><span class="line">        <span class="attr">horizontalOrigin</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// verticalOrigin: number</span></span><br><span class="line">        <span class="comment">// 作用: 垂直对齐方式</span></span><br><span class="line">        <span class="attr">verticalOrigin</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// scale: number</span></span><br><span class="line">        <span class="comment">// 作用: 缩放比例</span></span><br><span class="line">        <span class="attr">scale</span>: <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// scaleByDistance: Object</span></span><br><span class="line">        <span class="comment">// 作用: 基于距离的缩放</span></span><br><span class="line">        <span class="attr">scaleByDistance</span>: <span class="literal">null</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">attr</span> = options.<span class="property">attr</span> || &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PolylineEntity - 线实体</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PolylineEntity</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// positions: Array</span></span><br><span class="line">    <span class="comment">// 作用: 线的顶点坐标数组</span></span><br><span class="line">    <span class="comment">// 格式: [[lng,lat,alt], [lng,lat,alt], ...]</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">positions</span> = options.<span class="property">positions</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// color: string</span></span><br><span class="line">        <span class="comment">// 作用: 线条颜色</span></span><br><span class="line">        <span class="comment">// 默认: &#x27;#ffff00&#x27;</span></span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// width: number</span></span><br><span class="line">        <span class="comment">// 作用: 线条宽度</span></span><br><span class="line">        <span class="comment">// 默认: 2</span></span><br><span class="line">        <span class="attr">width</span>: <span class="number">2</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// opacity: number</span></span><br><span class="line">        <span class="comment">// 作用: 透明度</span></span><br><span class="line">        <span class="comment">// 默认: 1.0</span></span><br><span class="line">        <span class="attr">opacity</span>: <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outline: boolean</span></span><br><span class="line">        <span class="comment">// 作用: 是否显示轮廓</span></span><br><span class="line">        <span class="comment">// 默认: false</span></span><br><span class="line">        <span class="attr">outline</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outlineColor: string</span></span><br><span class="line">        <span class="comment">// 作用: 轮廓颜色</span></span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="string">&#x27;#000000&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outlineWidth: number</span></span><br><span class="line">        <span class="comment">// 作用: 轮廓宽度</span></span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// lineType: string</span></span><br><span class="line">        <span class="comment">// 作用: 线条类型</span></span><br><span class="line">        <span class="comment">// 选项: &#x27;solid&#x27;, &#x27;dash&#x27;, &#x27;dot&#x27;, &#x27;dashdot&#x27;, &#x27;longdash&#x27;</span></span><br><span class="line">        <span class="attr">lineType</span>: <span class="string">&#x27;solid&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// materialType: string</span></span><br><span class="line">        <span class="comment">// 作用: 材质类型</span></span><br><span class="line">        <span class="comment">// 选项: &#x27;Color&#x27;, &#x27;PolylineGlow&#x27;, &#x27;PolylineArrow&#x27;, &#x27;PolylineDash&#x27;</span></span><br><span class="line">        <span class="attr">materialType</span>: <span class="string">&#x27;Color&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// materialOptions: Object</span></span><br><span class="line">        <span class="comment">// 作用: 材质参数</span></span><br><span class="line">        <span class="attr">materialOptions</span>: &#123;&#125;,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// clampToGround: boolean</span></span><br><span class="line">        <span class="comment">// 作用: 是否贴地</span></span><br><span class="line">        <span class="comment">// 默认: false</span></span><br><span class="line">        <span class="attr">clampToGround</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// zIndex: number</span></span><br><span class="line">        <span class="comment">// 作用: 层级（贴地时有效）</span></span><br><span class="line">        <span class="comment">// 默认: 0</span></span><br><span class="line">        <span class="attr">zIndex</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// closure: boolean</span></span><br><span class="line">        <span class="comment">// 作用: 是否闭合</span></span><br><span class="line">        <span class="comment">// 默认: false</span></span><br><span class="line">        <span class="attr">closure</span>: <span class="literal">false</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">attr</span> = options.<span class="property">attr</span> || &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PolygonEntity - 面实体</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PolygonEntity</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// positions: Array</span></span><br><span class="line">    <span class="comment">// 作用: 面的边界坐标数组</span></span><br><span class="line">    <span class="comment">// 格式: [[lng,lat,alt], [lng,lat,alt], ...] 或 [外环, 内环1, 内环2, ...]</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">positions</span> = options.<span class="property">positions</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// color: string</span></span><br><span class="line">        <span class="comment">// 作用: 填充颜色</span></span><br><span class="line">        <span class="comment">// 默认: &#x27;#ffff00&#x27;</span></span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// opacity: number</span></span><br><span class="line">        <span class="comment">// 作用: 填充透明度</span></span><br><span class="line">        <span class="comment">// 默认: 0.6</span></span><br><span class="line">        <span class="attr">opacity</span>: <span class="number">0.6</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outline: boolean</span></span><br><span class="line">        <span class="comment">// 作用: 是否显示轮廓</span></span><br><span class="line">        <span class="comment">// 默认: true</span></span><br><span class="line">        <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outlineColor: string</span></span><br><span class="line">        <span class="comment">// 作用: 轮廓颜色</span></span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outlineWidth: number</span></span><br><span class="line">        <span class="comment">// 作用: 轮廓宽度</span></span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// outlineOpacity: number</span></span><br><span class="line">        <span class="comment">// 作用: 轮廓透明度</span></span><br><span class="line">        <span class="attr">outlineOpacity</span>: <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// fill: boolean</span></span><br><span class="line">        <span class="comment">// 作用: 是否填充</span></span><br><span class="line">        <span class="comment">// 默认: true</span></span><br><span class="line">        <span class="attr">fill</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// height: number</span></span><br><span class="line">        <span class="comment">// 作用: 高度</span></span><br><span class="line">        <span class="comment">// 默认: 0</span></span><br><span class="line">        <span class="attr">height</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// extrudedHeight: number</span></span><br><span class="line">        <span class="comment">// 作用: 拉伸高度</span></span><br><span class="line">        <span class="attr">extrudedHeight</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// clampToGround: boolean</span></span><br><span class="line">        <span class="comment">// 作用: 是否贴地</span></span><br><span class="line">        <span class="comment">// 默认: false</span></span><br><span class="line">        <span class="attr">clampToGround</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// zIndex: number</span></span><br><span class="line">        <span class="comment">// 作用: 层级（贴地时有效）</span></span><br><span class="line">        <span class="attr">zIndex</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// materialType: string</span></span><br><span class="line">        <span class="comment">// 作用: 材质类型</span></span><br><span class="line">        <span class="comment">// 选项: &#x27;Color&#x27;, &#x27;Image&#x27;, &#x27;Grid&#x27;, &#x27;Stripe&#x27;, &#x27;Checkerboard&#x27;</span></span><br><span class="line">        <span class="attr">materialType</span>: <span class="string">&#x27;Color&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// materialOptions: Object</span></span><br><span class="line">        <span class="comment">// 作用: 材质参数</span></span><br><span class="line">        <span class="attr">materialOptions</span>: &#123;&#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">attr</span> = options.<span class="property">attr</span> || &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> graphicLayer = <span class="keyword">new</span> mars3d.<span class="property">layer</span>.<span class="title class_">GraphicLayer</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加点</span></span><br><span class="line"><span class="keyword">const</span> point = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PointEntity</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: [<span class="number">117.207</span>, <span class="number">31.794</span>, <span class="number">100</span>],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&#x27;#ff0000&#x27;</span>,</span><br><span class="line">    <span class="attr">pixelSize</span>: <span class="number">15</span>,</span><br><span class="line">    <span class="attr">outlineColor</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">    <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">scaleByDistance</span>: &#123;</span><br><span class="line">      <span class="attr">near</span>: <span class="number">100</span>,</span><br><span class="line">      <span class="attr">nearValue</span>: <span class="number">2.0</span>,</span><br><span class="line">      <span class="attr">far</span>: <span class="number">1000000</span>,</span><br><span class="line">      <span class="attr">farValue</span>: <span class="number">0.5</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">attr</span>: &#123; <span class="attr">name</span>: <span class="string">&#x27;测试点&#x27;</span> &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加图标</span></span><br><span class="line"><span class="keyword">const</span> billboard = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">BillboardEntity</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: [<span class="number">117.208</span>, <span class="number">31.795</span>, <span class="number">0</span>],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">image</span>: <span class="string">&#x27;img/marker/mark-red.png&#x27;</span>,</span><br><span class="line">    <span class="attr">scale</span>: <span class="number">1.5</span>,</span><br><span class="line">    <span class="attr">horizontalOrigin</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">verticalOrigin</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">pixelOffset</span>: [<span class="number">0</span>, -<span class="number">20</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">attr</span>: &#123; <span class="attr">name</span>: <span class="string">&#x27;标记点&#x27;</span> &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加标签</span></span><br><span class="line"><span class="keyword">const</span> label = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">LabelEntity</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: [<span class="number">117.209</span>, <span class="number">31.796</span>, <span class="number">50</span>],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">text</span>: <span class="string">&#x27;文字标签&#x27;</span>,</span><br><span class="line">    <span class="attr">font</span>: <span class="string">&#x27;24px Microsoft YaHei&#x27;</span>,</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">    <span class="attr">outlineColor</span>: <span class="string">&#x27;#000000&#x27;</span>,</span><br><span class="line">    <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">backgroundColor</span>: <span class="string">&#x27;rgba(0,0,0,0.5)&#x27;</span>,</span><br><span class="line">    <span class="attr">pixelOffset</span>: [<span class="number">0</span>, -<span class="number">50</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加线</span></span><br><span class="line"><span class="keyword">const</span> polyline = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolylineEntity</span>(&#123;</span><br><span class="line">  <span class="attr">positions</span>: [</span><br><span class="line">    [<span class="number">117.2</span>, <span class="number">31.79</span>, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">117.21</span>, <span class="number">31.8</span>, <span class="number">100</span>],</span><br><span class="line">    [<span class="number">117.22</span>, <span class="number">31.79</span>, <span class="number">200</span>],</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&#x27;#00ff00&#x27;</span>,</span><br><span class="line">    <span class="attr">width</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">lineType</span>: <span class="string">&#x27;dash&#x27;</span>,</span><br><span class="line">    <span class="attr">materialType</span>: <span class="string">&#x27;PolylineGlow&#x27;</span>,</span><br><span class="line">    <span class="attr">materialOptions</span>: &#123;</span><br><span class="line">      <span class="attr">glowPower</span>: <span class="number">0.2</span>,</span><br><span class="line">      <span class="attr">taperPower</span>: <span class="number">0.5</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加面</span></span><br><span class="line"><span class="keyword">const</span> polygon = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolygonEntity</span>(&#123;</span><br><span class="line">  <span class="attr">positions</span>: [</span><br><span class="line">    [<span class="number">117.18</span>, <span class="number">31.78</span>],</span><br><span class="line">    [<span class="number">117.19</span>, <span class="number">31.78</span>],</span><br><span class="line">    [<span class="number">117.19</span>, <span class="number">31.79</span>],</span><br><span class="line">    [<span class="number">117.18</span>, <span class="number">31.79</span>],</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&#x27;#0000ff&#x27;</span>,</span><br><span class="line">    <span class="attr">opacity</span>: <span class="number">0.4</span>,</span><br><span class="line">    <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">outlineColor</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">    <span class="attr">outlineWidth</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">extrudedHeight</span>: <span class="number">200</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 批量添加到图层</span></span><br><span class="line">graphicLayer.<span class="title function_">addGraphic</span>(point)</span><br><span class="line">graphicLayer.<span class="title function_">addGraphic</span>(billboard)</span><br><span class="line">graphicLayer.<span class="title function_">addGraphic</span>(label)</span><br><span class="line">graphicLayer.<span class="title function_">addGraphic</span>(polyline)</span><br><span class="line">graphicLayer.<span class="title function_">addGraphic</span>(polygon)</span><br><span class="line"></span><br><span class="line">map.<span class="title function_">addLayer</span>(graphicLayer)</span><br></pre></td></tr></table></figure><h2 id="三维模型详解"><a href="#三维模型详解" class="headerlink" title="三维模型详解"></a>三维模型详解</h2><h3 id="ModelEntity-模型实体"><a href="#ModelEntity-模型实体" class="headerlink" title="ModelEntity 模型实体"></a>ModelEntity 模型实体</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ModelEntity - 3D模型实体</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelEntity</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// position: Array | LngLatPoint</span></span><br><span class="line">    <span class="comment">// 作用: 模型位置</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">position</span> = options.<span class="property">position</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// style: Object</span></span><br><span class="line">    <span class="comment">// 作用: 模型样式配置</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// url: string</span></span><br><span class="line">        <span class="comment">// 作用: 模型文件地址</span></span><br><span class="line">        <span class="comment">// 支持: glTF(.gltf, .glb), COLLADA(.dae), OBJ(.obj)</span></span><br><span class="line">        <span class="attr">url</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// scale: number</span></span><br><span class="line">        <span class="comment">// 作用: 缩放比例</span></span><br><span class="line">        <span class="comment">// 默认: 1.0</span></span><br><span class="line">        <span class="attr">scale</span>: <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// heading: number</span></span><br><span class="line">        <span class="comment">// 作用: 方向角（度）</span></span><br><span class="line">        <span class="comment">// 默认: 0</span></span><br><span class="line">        <span class="attr">heading</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// pitch: number</span></span><br><span class="line">        <span class="comment">// 作用: 俯仰角（度）</span></span><br><span class="line">        <span class="comment">// 默认: 0</span></span><br><span class="line">        <span class="attr">pitch</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// roll: number</span></span><br><span class="line">        <span class="comment">// 作用: 翻滚角（度）</span></span><br><span class="line">        <span class="comment">// 默认: 0</span></span><br><span class="line">        <span class="attr">roll</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// minimumPixelSize: number</span></span><br><span class="line">        <span class="comment">// 作用: 最小像素尺寸</span></span><br><span class="line">        <span class="comment">// 默认: 0</span></span><br><span class="line">        <span class="attr">minimumPixelSize</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// maximumScale: number</span></span><br><span class="line">        <span class="comment">// 作用: 最大缩放比例</span></span><br><span class="line">        <span class="attr">maximumScale</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// color: string</span></span><br><span class="line">        <span class="comment">// 作用: 模型颜色（混合）</span></span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// opacity: number</span></span><br><span class="line">        <span class="comment">// 作用: 透明度</span></span><br><span class="line">        <span class="comment">// 默认: 1.0</span></span><br><span class="line">        <span class="attr">opacity</span>: <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// silhouetteColor: string</span></span><br><span class="line">        <span class="comment">// 作用: 轮廓颜色</span></span><br><span class="line">        <span class="attr">silhouetteColor</span>: <span class="string">&#x27;#ff0000&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// silhouetteSize: number</span></span><br><span class="line">        <span class="comment">// 作用: 轮廓宽度</span></span><br><span class="line">        <span class="comment">// 默认: 0</span></span><br><span class="line">        <span class="attr">silhouetteSize</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// heightReference: number</span></span><br><span class="line">        <span class="comment">// 作用: 高度参考</span></span><br><span class="line">        <span class="comment">// 选项: 0(NONE), 1(CLAMP_TO_GROUND), 2(RELATIVE_TO_GROUND)</span></span><br><span class="line">        <span class="attr">heightReference</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// shadows: number</span></span><br><span class="line">        <span class="comment">// 作用: 阴影模式</span></span><br><span class="line">        <span class="comment">// 选项: 0(DISABLED), 1(ENABLED), 2(CAST_ONLY), 3(RECEIVE_ONLY)</span></span><br><span class="line">        <span class="attr">shadows</span>: <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// runAnimations: boolean</span></span><br><span class="line">        <span class="comment">// 作用: 是否播放模型动画</span></span><br><span class="line">        <span class="comment">// 默认: true</span></span><br><span class="line">        <span class="attr">runAnimations</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// clampAnimations: boolean</span></span><br><span class="line">        <span class="comment">// 作用: 是否限制动画循环</span></span><br><span class="line">        <span class="comment">// 默认: true</span></span><br><span class="line">        <span class="attr">clampAnimations</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// colorBlendMode: number</span></span><br><span class="line">        <span class="comment">// 作用: 颜色混合模式</span></span><br><span class="line">        <span class="comment">// 选项: 0(HIGHLIGHT), 1(REPLACE), 2(MIX)</span></span><br><span class="line">        <span class="attr">colorBlendMode</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// colorBlendAmount: number</span></span><br><span class="line">        <span class="comment">// 作用: 颜色混合强度</span></span><br><span class="line">        <span class="comment">// 默认: 0.5</span></span><br><span class="line">        <span class="comment">// 范围: 0.0 - 1.0</span></span><br><span class="line">        <span class="attr">colorBlendAmount</span>: <span class="number">0.5</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// incrementallyLoadTextures: boolean</span></span><br><span class="line">        <span class="comment">// 作用: 是否渐进式加载纹理</span></span><br><span class="line">        <span class="comment">// 默认: true</span></span><br><span class="line">        <span class="attr">incrementallyLoadTextures</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">attr</span> = options.<span class="property">attr</span> || &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// startAnimation - 开始播放动画</span></span><br><span class="line">  <span class="title function_">startAnimation</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="comment">// name: string - 动画名称（可选）</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_cesiumEntity</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">_cesiumEntity</span>.<span class="property">model</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_cesiumEntity</span>.<span class="property">model</span>.<span class="property">runAnimations</span> = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// stopAnimation - 停止播放动画</span></span><br><span class="line">  <span class="title function_">stopAnimation</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_cesiumEntity</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">_cesiumEntity</span>.<span class="property">model</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_cesiumEntity</span>.<span class="property">model</span>.<span class="property">runAnimations</span> = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setRotation - 设置旋转角度</span></span><br><span class="line">  <span class="title function_">setRotation</span>(<span class="params">heading, pitch, roll</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">heading</span> = heading</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">pitch</span> = pitch</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">roll</span> = roll</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">updateStyle</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setScale - 设置缩放比例</span></span><br><span class="line">  <span class="title function_">setScale</span>(<span class="params">scale</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">scale</span> = scale</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">updateStyle</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setColor - 设置颜色</span></span><br><span class="line">  <span class="title function_">setColor</span>(<span class="params">color, opacity = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">color</span> = color</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">opacity</span> = opacity</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">updateStyle</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setSilhouette - 设置轮廓</span></span><br><span class="line">  <span class="title function_">setSilhouette</span>(<span class="params">color, size</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">silhouetteColor</span> = color</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span>.<span class="property">silhouetteSize</span> = size</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">updateStyle</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TilesetLayer - 3D瓦片图层</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TilesetLayer</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// url: string</span></span><br><span class="line">    <span class="comment">// 作用: 3D Tiles服务地址</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">url</span> = options.<span class="property">url</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// name: string</span></span><br><span class="line">    <span class="comment">// 作用: 图层名称</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = options.<span class="property">name</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// show: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">show</span> = options.<span class="property">show</span> !== <span class="literal">undefined</span> ? options.<span class="property">show</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// maximumScreenSpaceError: number</span></span><br><span class="line">    <span class="comment">// 作用: 最大屏幕空间误差</span></span><br><span class="line">    <span class="comment">// 默认: 16</span></span><br><span class="line">    <span class="comment">// 性能影响: 值越小质量越高，性能越低</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maximumScreenSpaceError</span> =</span><br><span class="line">      options.<span class="property">maximumScreenSpaceError</span> !== <span class="literal">undefined</span> ? options.<span class="property">maximumScreenSpaceError</span> : <span class="number">16</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// maximumMemoryUsage: number</span></span><br><span class="line">    <span class="comment">// 作用: 最大内存使用量（MB）</span></span><br><span class="line">    <span class="comment">// 默认: 512</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maximumMemoryUsage</span> =</span><br><span class="line">      options.<span class="property">maximumMemoryUsage</span> !== <span class="literal">undefined</span> ? options.<span class="property">maximumMemoryUsage</span> : <span class="number">512</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// shadows: number</span></span><br><span class="line">    <span class="comment">// 作用: 阴影模式</span></span><br><span class="line">    <span class="comment">// 默认: 1 (ENABLED)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadows</span> = options.<span class="property">shadows</span> !== <span class="literal">undefined</span> ? options.<span class="property">shadows</span> : <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// style: Object</span></span><br><span class="line">    <span class="comment">// 作用: 3D Tiles样式</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = options.<span class="property">style</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// customShader: Object</span></span><br><span class="line">    <span class="comment">// 作用: 自定义着色器</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">customShader</span> = options.<span class="property">customShader</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// modelMatrix: Array</span></span><br><span class="line">    <span class="comment">// 作用: 模型变换矩阵</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">modelMatrix</span> = options.<span class="property">modelMatrix</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// cullWithChildrenBounds: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否使用子节点边界进行剔除</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cullWithChildrenBounds</span> =</span><br><span class="line">      options.<span class="property">cullWithChildrenBounds</span> !== <span class="literal">undefined</span> ? options.<span class="property">cullWithChildrenBounds</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// skipLevelOfDetail: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否跳过LOD</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">skipLevelOfDetail</span> =</span><br><span class="line">      options.<span class="property">skipLevelOfDetail</span> !== <span class="literal">undefined</span> ? options.<span class="property">skipLevelOfDetail</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// baseScreenSpaceError: number</span></span><br><span class="line">    <span class="comment">// 作用: 基础屏幕空间误差</span></span><br><span class="line">    <span class="comment">// 默认: 1024</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">baseScreenSpaceError</span> =</span><br><span class="line">      options.<span class="property">baseScreenSpaceError</span> !== <span class="literal">undefined</span> ? options.<span class="property">baseScreenSpaceError</span> : <span class="number">1024</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// skipScreenSpaceErrorFactor: number</span></span><br><span class="line">    <span class="comment">// 作用: 跳过屏幕空间误差因子</span></span><br><span class="line">    <span class="comment">// 默认: 16</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">skipScreenSpaceErrorFactor</span> =</span><br><span class="line">      options.<span class="property">skipScreenSpaceErrorFactor</span> !== <span class="literal">undefined</span> ? options.<span class="property">skipScreenSpaceErrorFactor</span> : <span class="number">16</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// skipLevels: number</span></span><br><span class="line">    <span class="comment">// 作用: 跳过的层级数</span></span><br><span class="line">    <span class="comment">// 默认: 1</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">skipLevels</span> = options.<span class="property">skipLevels</span> !== <span class="literal">undefined</span> ? options.<span class="property">skipLevels</span> : <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// immediatelyLoadDesiredLevelOfDetail: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否立即加载所需的LOD</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">immediatelyLoadDesiredLevelOfDetail</span> =</span><br><span class="line">      options.<span class="property">immediatelyLoadDesiredLevelOfDetail</span> !== <span class="literal">undefined</span></span><br><span class="line">        ? options.<span class="property">immediatelyLoadDesiredLevelOfDetail</span></span><br><span class="line">        : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// loadSiblings: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否加载兄弟节点</span></span><br><span class="line">    <span class="comment">// 默认: false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loadSiblings</span> = options.<span class="property">loadSiblings</span> !== <span class="literal">undefined</span> ? options.<span class="property">loadSiblings</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// clippingPlanes: Object</span></span><br><span class="line">    <span class="comment">// 作用: 裁剪平面配置</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clippingPlanes</span> = options.<span class="property">clippingPlanes</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// setStyle - 设置样式</span></span><br><span class="line">  <span class="title function_">setStyle</span>(<span class="params">style</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = style</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_tileset</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_tileset</span>.<span class="property">style</span> = <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">Cesium3DTileStyle</span>(style)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setCustomShader - 设置自定义着色器</span></span><br><span class="line">  <span class="title function_">setCustomShader</span>(<span class="params">shader</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">customShader</span> = shader</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_tileset</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_tileset</span>.<span class="property">customShader</span> = <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">CustomShader</span>(shader)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setClippingPlanes - 设置裁剪平面</span></span><br><span class="line">  <span class="title function_">setClippingPlanes</span>(<span class="params">planes</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clippingPlanes</span> = planes</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_tileset</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_tileset</span>.<span class="property">clippingPlanes</span> = <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">ClippingPlaneCollection</span>(planes)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setMaximumScreenSpaceError - 设置最大屏幕空间误差</span></span><br><span class="line">  <span class="title function_">setMaximumScreenSpaceError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maximumScreenSpaceError</span> = error</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_tileset</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_tileset</span>.<span class="property">maximumScreenSpaceError</span> = error</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加3D模型</span></span><br><span class="line"><span class="keyword">const</span> modelEntity = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">ModelEntity</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: [<span class="number">117.207</span>, <span class="number">31.794</span>, <span class="number">100</span>],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;model/building.gltf&#x27;</span>,</span><br><span class="line">    <span class="attr">scale</span>: <span class="number">2.0</span>,</span><br><span class="line">    <span class="attr">heading</span>: <span class="number">45</span>,</span><br><span class="line">    <span class="attr">minimumPixelSize</span>: <span class="number">64</span>,</span><br><span class="line">    <span class="attr">silhouetteColor</span>: <span class="string">&#x27;#00ff00&#x27;</span>,</span><br><span class="line">    <span class="attr">silhouetteSize</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">shadows</span>: <span class="number">1</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">attr</span>: &#123; <span class="attr">name</span>: <span class="string">&#x27;建筑模型&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;building&#x27;</span> &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">graphicLayer.<span class="title function_">addGraphic</span>(modelEntity)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加3D瓦片图层</span></span><br><span class="line"><span class="keyword">const</span> tilesetLayer = <span class="keyword">new</span> mars3d.<span class="property">layer</span>.<span class="title class_">TilesetLayer</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;倾斜摄影&#x27;</span>,</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;https://example.com/tileset.json&#x27;</span>,</span><br><span class="line">  <span class="attr">maximumScreenSpaceError</span>: <span class="number">8</span>,</span><br><span class="line">  <span class="attr">maximumMemoryUsage</span>: <span class="number">1024</span>,</span><br><span class="line">  <span class="attr">skipLevelOfDetail</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">baseScreenSpaceError</span>: <span class="number">1024</span>,</span><br><span class="line">  <span class="attr">skipScreenSpaceErrorFactor</span>: <span class="number">16</span>,</span><br><span class="line">  <span class="attr">skipLevels</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&quot;color(&#x27;#ffffff&#x27;)&quot;</span>,</span><br><span class="line">    <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">customShader</span>: &#123;</span><br><span class="line">    <span class="attr">fragmentShaderText</span>: <span class="string">`</span></span><br><span class="line"><span class="string">      void fragmentMain(FragmentInput fsInput, inout czm_modelMaterial material) &#123;</span></span><br><span class="line"><span class="string">        material.diffuse *= 1.2; // 增加亮度</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    `</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">map.<span class="title function_">addLayer</span>(tilesetLayer)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模型操作示例</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 旋转模型</span></span><br><span class="line">  modelEntity.<span class="title function_">setRotation</span>(<span class="number">90</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 改变颜色</span></span><br><span class="line">  modelEntity.<span class="title function_">setColor</span>(<span class="string">&#x27;#ff0000&#x27;</span>, <span class="number">0.8</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置轮廓</span></span><br><span class="line">  modelEntity.<span class="title function_">setSilhouette</span>(<span class="string">&#x27;#ffff00&#x27;</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 停止动画</span></span><br><span class="line">  modelEntity.<span class="title function_">stopAnimation</span>()</span><br><span class="line">&#125;, <span class="number">3000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3D瓦片样式调整</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 修改样式</span></span><br><span class="line">  tilesetLayer.<span class="title function_">setStyle</span>(&#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&quot;color(&#x27;#ff0000&#x27;, 0.8)&quot;</span>,</span><br><span class="line">    <span class="attr">show</span>: <span class="string">&#x27;$&#123;Height&#125; &gt; 100&#x27;</span>, <span class="comment">// 只显示高度大于100的要素</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 调整性能参数</span></span><br><span class="line">  tilesetLayer.<span class="title function_">setMaximumScreenSpaceError</span>(<span class="number">4</span>) <span class="comment">// 提高质量</span></span><br><span class="line">&#125;, <span class="number">5000</span>)</span><br></pre></td></tr></table></figure><h2 id="相机控制完整属性"><a href="#相机控制完整属性" class="headerlink" title="相机控制完整属性"></a>相机控制完整属性</h2><h3 id="CameraControl-相机控制"><a href="#CameraControl-相机控制" class="headerlink" title="CameraControl 相机控制"></a>CameraControl 相机控制</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraControl - 相机控制类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CameraControl</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span> = map</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span> = map.<span class="property">viewer</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span> = map.<span class="property">camera</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 位置控制方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// setCameraView - 设置相机视角</span></span><br><span class="line">  <span class="title function_">setCameraView</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="comment">// destination: Array | Object</span></span><br><span class="line">    <span class="comment">// 作用: 目标位置</span></span><br><span class="line">    <span class="comment">// 格式: [lng, lat, alt] 或 &#123;lng, lat, alt, heading, pitch, roll&#125;</span></span><br><span class="line">    <span class="keyword">const</span> destination = options.<span class="property">destination</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// heading: number</span></span><br><span class="line">    <span class="comment">// 作用: 方向角（度）</span></span><br><span class="line">    <span class="comment">// 默认: 0</span></span><br><span class="line">    <span class="keyword">const</span> heading = options.<span class="property">heading</span> || <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// pitch: number</span></span><br><span class="line">    <span class="comment">// 作用: 俯仰角（度）</span></span><br><span class="line">    <span class="comment">// 默认: -90</span></span><br><span class="line">    <span class="keyword">const</span> pitch = options.<span class="property">pitch</span> !== <span class="literal">undefined</span> ? options.<span class="property">pitch</span> : -<span class="number">90</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// roll: number</span></span><br><span class="line">    <span class="comment">// 作用: 翻滚角（度）</span></span><br><span class="line">    <span class="comment">// 默认: 0</span></span><br><span class="line">    <span class="keyword">const</span> roll = options.<span class="property">roll</span> || <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// duration: number</span></span><br><span class="line">    <span class="comment">// 作用: 动画时间（秒）</span></span><br><span class="line">    <span class="comment">// 默认: 0（立即跳转）</span></span><br><span class="line">    <span class="keyword">const</span> duration = options.<span class="property">duration</span> || <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (duration &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">flyToPosition</span>(destination, &#123; heading, pitch, roll, duration &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setPosition</span>(destination, &#123; heading, pitch, roll &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// flyToPosition - 飞行到位置</span></span><br><span class="line">  <span class="title function_">flyToPosition</span>(<span class="params">destination, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> flyOptions = &#123;</span><br><span class="line">      <span class="attr">destination</span>: mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(destination).<span class="title function_">toCartesian</span>(),</span><br><span class="line">      <span class="attr">orientation</span>: &#123;</span><br><span class="line">        <span class="attr">heading</span>: mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(options.<span class="property">heading</span> || <span class="number">0</span>),</span><br><span class="line">        <span class="attr">pitch</span>: mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(options.<span class="property">pitch</span> || -<span class="number">30</span>),</span><br><span class="line">        <span class="attr">roll</span>: mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(options.<span class="property">roll</span> || <span class="number">0</span>),</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">duration</span>: options.<span class="property">duration</span> || <span class="number">3</span>,</span><br><span class="line">      <span class="attr">complete</span>: options.<span class="property">complete</span>,</span><br><span class="line">      <span class="attr">cancel</span>: options.<span class="property">cancel</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">flyTo</span>(flyOptions)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setPosition - 设置位置（立即跳转）</span></span><br><span class="line">  <span class="title function_">setPosition</span>(<span class="params">destination, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">setView</span>(&#123;</span><br><span class="line">      <span class="attr">destination</span>: mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(destination).<span class="title function_">toCartesian</span>(),</span><br><span class="line">      <span class="attr">orientation</span>: &#123;</span><br><span class="line">        <span class="attr">heading</span>: mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(options.<span class="property">heading</span> || <span class="number">0</span>),</span><br><span class="line">        <span class="attr">pitch</span>: mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(options.<span class="property">pitch</span> || -<span class="number">30</span>),</span><br><span class="line">        <span class="attr">roll</span>: mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(options.<span class="property">roll</span> || <span class="number">0</span>),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// flyToExtent - 飞行到范围</span></span><br><span class="line">  <span class="title function_">flyToExtent</span>(<span class="params">extent, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// extent: Object</span></span><br><span class="line">    <span class="comment">// 作用: 范围边界</span></span><br><span class="line">    <span class="comment">// 格式: &#123;xmin, ymin, xmax, ymax&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> rectangle = mars3d.<span class="property">Cesium</span>.<span class="property">Rectangle</span>.<span class="title function_">fromDegrees</span>(</span><br><span class="line">      extent.<span class="property">xmin</span>,</span><br><span class="line">      extent.<span class="property">ymin</span>,</span><br><span class="line">      extent.<span class="property">xmax</span>,</span><br><span class="line">      extent.<span class="property">ymax</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">flyTo</span>(&#123;</span><br><span class="line">      <span class="attr">destination</span>: rectangle,</span><br><span class="line">      <span class="attr">duration</span>: options.<span class="property">duration</span> || <span class="number">3</span>,</span><br><span class="line">      <span class="attr">complete</span>: options.<span class="property">complete</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 相机移动方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveForward - 向前移动</span></span><br><span class="line">  <span class="title function_">moveForward</span>(<span class="params">distance = <span class="number">1000</span></span>) &#123;</span><br><span class="line">    <span class="comment">// distance: number - 移动距离（米）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">moveForward</span>(distance)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveBackward - 向后移动</span></span><br><span class="line">  <span class="title function_">moveBackward</span>(<span class="params">distance = <span class="number">1000</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">moveBackward</span>(distance)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveLeft - 向左移动</span></span><br><span class="line">  <span class="title function_">moveLeft</span>(<span class="params">distance = <span class="number">1000</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">moveLeft</span>(distance)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveRight - 向右移动</span></span><br><span class="line">  <span class="title function_">moveRight</span>(<span class="params">distance = <span class="number">1000</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">moveRight</span>(distance)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveUp - 向上移动</span></span><br><span class="line">  <span class="title function_">moveUp</span>(<span class="params">distance = <span class="number">1000</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">moveUp</span>(distance)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// moveDown - 向下移动</span></span><br><span class="line">  <span class="title function_">moveDown</span>(<span class="params">distance = <span class="number">1000</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">moveDown</span>(distance)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 相机旋转方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// rotateLeft - 向左旋转</span></span><br><span class="line">  <span class="title function_">rotateLeft</span>(<span class="params">angle = <span class="number">15</span></span>) &#123;</span><br><span class="line">    <span class="comment">// angle: number - 旋转角度（度）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">rotateLeft</span>(mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(angle))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// rotateRight - 向右旋转</span></span><br><span class="line">  <span class="title function_">rotateRight</span>(<span class="params">angle = <span class="number">15</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">rotateRight</span>(mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(angle))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// rotateUp - 向上旋转</span></span><br><span class="line">  <span class="title function_">rotateUp</span>(<span class="params">angle = <span class="number">15</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">rotateUp</span>(mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(angle))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// rotateDown - 向下旋转</span></span><br><span class="line">  <span class="title function_">rotateDown</span>(<span class="params">angle = <span class="number">15</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">rotateDown</span>(mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(angle))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// lookLeft - 向左看</span></span><br><span class="line">  <span class="title function_">lookLeft</span>(<span class="params">angle = <span class="number">15</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">lookLeft</span>(mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(angle))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// lookRight - 向右看</span></span><br><span class="line">  <span class="title function_">lookRight</span>(<span class="params">angle = <span class="number">15</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">lookRight</span>(mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(angle))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// lookUp - 向上看</span></span><br><span class="line">  <span class="title function_">lookUp</span>(<span class="params">angle = <span class="number">15</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">lookUp</span>(mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(angle))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// lookDown - 向下看</span></span><br><span class="line">  <span class="title function_">lookDown</span>(<span class="params">angle = <span class="number">15</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">lookDown</span>(mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(angle))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 缩放方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// zoomIn - 放大</span></span><br><span class="line">  <span class="title function_">zoomIn</span>(<span class="params">distance = <span class="number">1000</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">zoomIn</span>(distance)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// zoomOut - 缩小</span></span><br><span class="line">  <span class="title function_">zoomOut</span>(<span class="params">distance = <span class="number">1000</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">zoomOut</span>(distance)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// zoomToLevel - 缩放到指定级别</span></span><br><span class="line">  <span class="title function_">zoomToLevel</span>(<span class="params">level</span>) &#123;</span><br><span class="line">    <span class="comment">// level: number - 缩放级别</span></span><br><span class="line">    <span class="comment">// 范围: 1-20</span></span><br><span class="line">    <span class="keyword">const</span> height = <span class="variable language_">this</span>.<span class="title function_">getHeightByLevel</span>(level)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setHeight</span>(height)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取和设置方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// getPosition - 获取当前位置</span></span><br><span class="line">  <span class="title function_">getPosition</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> cartographic = <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="property">positionCartographic</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">lng</span>: mars3d.<span class="property">Util</span>.<span class="title function_">toDegrees</span>(cartographic.<span class="property">longitude</span>),</span><br><span class="line">      <span class="attr">lat</span>: mars3d.<span class="property">Util</span>.<span class="title function_">toDegrees</span>(cartographic.<span class="property">latitude</span>),</span><br><span class="line">      <span class="attr">alt</span>: cartographic.<span class="property">height</span>,</span><br><span class="line">      <span class="attr">heading</span>: mars3d.<span class="property">Util</span>.<span class="title function_">toDegrees</span>(<span class="variable language_">this</span>.<span class="property">camera</span>.<span class="property">heading</span>),</span><br><span class="line">      <span class="attr">pitch</span>: mars3d.<span class="property">Util</span>.<span class="title function_">toDegrees</span>(<span class="variable language_">this</span>.<span class="property">camera</span>.<span class="property">pitch</span>),</span><br><span class="line">      <span class="attr">roll</span>: mars3d.<span class="property">Util</span>.<span class="title function_">toDegrees</span>(<span class="variable language_">this</span>.<span class="property">camera</span>.<span class="property">roll</span>),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getHeight - 获取相机高度</span></span><br><span class="line">  <span class="title function_">getHeight</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="property">positionCartographic</span>.<span class="property">height</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setHeight - 设置相机高度</span></span><br><span class="line">  <span class="title function_">setHeight</span>(<span class="params">height</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> cartographic = <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="property">positionCartographic</span></span><br><span class="line">    <span class="keyword">const</span> destination = mars3d.<span class="property">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromRadians</span>(</span><br><span class="line">      cartographic.<span class="property">longitude</span>,</span><br><span class="line">      cartographic.<span class="property">latitude</span>,</span><br><span class="line">      height,</span><br><span class="line">    )</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">setView</span>(&#123; destination &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getHeading - 获取方向角</span></span><br><span class="line">  <span class="title function_">getHeading</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">Util</span>.<span class="title function_">toDegrees</span>(<span class="variable language_">this</span>.<span class="property">camera</span>.<span class="property">heading</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setHeading - 设置方向角</span></span><br><span class="line">  <span class="title function_">setHeading</span>(<span class="params">heading</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> position = <span class="variable language_">this</span>.<span class="title function_">getPosition</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setPosition</span>([position.<span class="property">lng</span>, position.<span class="property">lat</span>, position.<span class="property">alt</span>], &#123;</span><br><span class="line">      <span class="attr">heading</span>: heading,</span><br><span class="line">      <span class="attr">pitch</span>: position.<span class="property">pitch</span>,</span><br><span class="line">      <span class="attr">roll</span>: position.<span class="property">roll</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getPitch - 获取俯仰角</span></span><br><span class="line">  <span class="title function_">getPitch</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">Util</span>.<span class="title function_">toDegrees</span>(<span class="variable language_">this</span>.<span class="property">camera</span>.<span class="property">pitch</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setPitch - 设置俯仰角</span></span><br><span class="line">  <span class="title function_">setPitch</span>(<span class="params">pitch</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> position = <span class="variable language_">this</span>.<span class="title function_">getPosition</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setPosition</span>([position.<span class="property">lng</span>, position.<span class="property">lat</span>, position.<span class="property">alt</span>], &#123;</span><br><span class="line">      <span class="attr">heading</span>: position.<span class="property">heading</span>,</span><br><span class="line">      <span class="attr">pitch</span>: pitch,</span><br><span class="line">      <span class="attr">roll</span>: position.<span class="property">roll</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 实用方法</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// getHeightByLevel - 根据级别计算高度</span></span><br><span class="line">  <span class="title function_">getHeightByLevel</span>(<span class="params">level</span>) &#123;</span><br><span class="line">    <span class="comment">// 根据经验公式计算</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">pow</span>(<span class="number">2</span>, <span class="number">20</span> - level) * <span class="number">256</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getLevelByHeight - 根据高度计算级别</span></span><br><span class="line">  <span class="title function_">getLevelByHeight</span>(<span class="params">height</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="number">1</span>, <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="number">20</span>, <span class="title class_">Math</span>.<span class="title function_">round</span>(<span class="number">20</span> - <span class="title class_">Math</span>.<span class="title function_">log2</span>(height / <span class="number">256</span>))))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// isInView - 判断位置是否在视野内</span></span><br><span class="line">  <span class="title function_">isInView</span>(<span class="params">position</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> cartesian = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(position).<span class="title function_">toCartesian</span>()</span><br><span class="line">    <span class="keyword">const</span> windowPosition = mars3d.<span class="property">Cesium</span>.<span class="property">SceneTransforms</span>.<span class="title function_">worldToWindowCoordinates</span>(</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">scene</span>,</span><br><span class="line">      cartesian,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!windowPosition) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> canvas = <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">canvas</span></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      windowPosition.<span class="property">x</span> &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">      windowPosition.<span class="property">x</span> &lt;= canvas.<span class="property">clientWidth</span> &amp;&amp;</span><br><span class="line">      windowPosition.<span class="property">y</span> &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">      windowPosition.<span class="property">y</span> &lt;= canvas.<span class="property">clientHeight</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// pickPosition - 拾取屏幕位置对应的地理坐标</span></span><br><span class="line">  <span class="title function_">pickPosition</span>(<span class="params">screenPosition</span>) &#123;</span><br><span class="line">    <span class="comment">// screenPosition: Object - 屏幕坐标 &#123;x, y&#125;</span></span><br><span class="line">    <span class="keyword">const</span> cartesian = <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">camera</span>.<span class="title function_">pickEllipsoid</span>(screenPosition)</span><br><span class="line">    <span class="keyword">if</span> (cartesian) &#123;</span><br><span class="line">      <span class="keyword">return</span> mars3d.<span class="property">PointTrans</span>.<span class="title function_">cartesian2lonlat</span>(cartesian)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 相机控制使用示例</span></span><br><span class="line"><span class="keyword">const</span> cameraControl = <span class="keyword">new</span> <span class="title class_">CameraControl</span>(map)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置相机位置</span></span><br><span class="line">cameraControl.<span class="title function_">setCameraView</span>(&#123;</span><br><span class="line">  <span class="attr">destination</span>: [<span class="number">117.207</span>, <span class="number">31.794</span>, <span class="number">5000</span>],</span><br><span class="line">  <span class="attr">heading</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">pitch</span>: -<span class="number">45</span>,</span><br><span class="line">  <span class="attr">roll</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">duration</span>: <span class="number">3</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 飞行到指定范围</span></span><br><span class="line">cameraControl.<span class="title function_">flyToExtent</span>(</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">xmin</span>: <span class="number">117.0</span>,</span><br><span class="line">    <span class="attr">ymin</span>: <span class="number">31.5</span>,</span><br><span class="line">    <span class="attr">xmax</span>: <span class="number">117.5</span>,</span><br><span class="line">    <span class="attr">ymax</span>: <span class="number">32.0</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">duration</span>: <span class="number">5</span> &#125;,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 相机移动</span></span><br><span class="line">cameraControl.<span class="title function_">moveForward</span>(<span class="number">1000</span>)</span><br><span class="line">cameraControl.<span class="title function_">rotateLeft</span>(<span class="number">30</span>)</span><br><span class="line">cameraControl.<span class="title function_">zoomIn</span>(<span class="number">500</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取当前位置</span></span><br><span class="line"><span class="keyword">const</span> currentPosition = cameraControl.<span class="title function_">getPosition</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;当前相机位置:&#x27;</span>, currentPosition)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置相机高度</span></span><br><span class="line">cameraControl.<span class="title function_">setHeight</span>(<span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断位置是否在视野内</span></span><br><span class="line"><span class="keyword">const</span> isVisible = cameraControl.<span class="title function_">isInView</span>([<span class="number">117.207</span>, <span class="number">31.794</span>, <span class="number">0</span>])</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;位置是否可见:&#x27;</span>, isVisible)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听相机变化事件</span></span><br><span class="line">map.<span class="title function_">on</span>(<span class="string">&#x27;cameraChanged&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> position = cameraControl.<span class="title function_">getPosition</span>()</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;相机位置变化:&#x27;</span>, position)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="事件系统详解"><a href="#事件系统详解" class="headerlink" title="事件系统详解"></a>事件系统详解</h2><h3 id="地图事件监听"><a href="#地图事件监听" class="headerlink" title="地图事件监听"></a>地图事件监听</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Map 事件系统</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MapEvents</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span> = map</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span> = map.<span class="property">viewer</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 鼠标事件</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// click - 鼠标点击事件</span></span><br><span class="line">  <span class="title function_">onClick</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="comment">// callback: function(event) - 回调函数</span></span><br><span class="line">    <span class="comment">// event.position: Object - 屏幕坐标 &#123;x, y&#125;</span></span><br><span class="line">    <span class="comment">// event.pickedObject: Object - 拾取到的对象</span></span><br><span class="line">    <span class="comment">// event.cartesian: Object - 笛卡尔坐标</span></span><br><span class="line">    <span class="comment">// event.cartographic: Object - 地理坐标</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// rightClick - 鼠标右键点击事件</span></span><br><span class="line">  <span class="title function_">onRightClick</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;rightClick&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// doubleClick - 鼠标双击事件</span></span><br><span class="line">  <span class="title function_">onDoubleClick</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;doubleClick&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mouseMove - 鼠标移动事件</span></span><br><span class="line">  <span class="title function_">onMouseMove</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="comment">// 频繁触发，建议使用节流</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;mouseMove&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mouseOver - 鼠标悬停事件</span></span><br><span class="line">  <span class="title function_">onMouseOver</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;mouseOver&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mouseOut - 鼠标离开事件</span></span><br><span class="line">  <span class="title function_">onMouseOut</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;mouseOut&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 相机事件</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// cameraChanged - 相机变化事件</span></span><br><span class="line">  <span class="title function_">onCameraChanged</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="comment">// callback: function(event) - 回调函数</span></span><br><span class="line">    <span class="comment">// event.position: Object - 相机位置信息</span></span><br><span class="line">    <span class="comment">// event.percentage: number - 移动百分比</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;cameraChanged&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cameraChangedEnd - 相机变化结束事件</span></span><br><span class="line">  <span class="title function_">onCameraChangedEnd</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;cameraChangedEnd&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cameraMoveStart - 相机开始移动事件</span></span><br><span class="line">  <span class="title function_">onCameraMoveStart</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;cameraMoveStart&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cameraMoveEnd - 相机移动结束事件</span></span><br><span class="line">  <span class="title function_">onCameraMoveEnd</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;cameraMoveEnd&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 场景事件</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// renderError - 渲染错误事件</span></span><br><span class="line">  <span class="title function_">onRenderError</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;renderError&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// terrainChanged - 地形变化事件</span></span><br><span class="line">  <span class="title function_">onTerrainChanged</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;terrainChanged&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// morphStart - 场景模式变化开始事件</span></span><br><span class="line">  <span class="title function_">onMorphStart</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;morphStart&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// morphComplete - 场景模式变化完成事件</span></span><br><span class="line">  <span class="title function_">onMorphComplete</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;morphComplete&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 图层事件</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// layerAdded - 图层添加事件</span></span><br><span class="line">  <span class="title function_">onLayerAdded</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="comment">// callback: function(event) - 回调函数</span></span><br><span class="line">    <span class="comment">// event.layer: Object - 添加的图层</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;layerAdded&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// layerRemoved - 图层移除事件</span></span><br><span class="line">  <span class="title function_">onLayerRemoved</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;layerRemoved&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// layerShowHide - 图层显示隐藏事件</span></span><br><span class="line">  <span class="title function_">onLayerShowHide</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;layerShowHide&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 矢量数据事件</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// graphicAdded - 矢量数据添加事件</span></span><br><span class="line">  <span class="title function_">onGraphicAdded</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="comment">// callback: function(event) - 回调函数</span></span><br><span class="line">    <span class="comment">// event.graphic: Object - 添加的矢量数据</span></span><br><span class="line">    <span class="comment">// event.layer: Object - 所属图层</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;graphicAdded&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// graphicRemoved - 矢量数据移除事件</span></span><br><span class="line">  <span class="title function_">onGraphicRemoved</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;graphicRemoved&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 键盘事件</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// keydown - 键盘按下事件</span></span><br><span class="line">  <span class="title function_">onKeyDown</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="comment">// callback: function(event) - 回调函数</span></span><br><span class="line">    <span class="comment">// event.key: string - 按键值</span></span><br><span class="line">    <span class="comment">// event.keyCode: number - 按键码</span></span><br><span class="line">    <span class="comment">// event.ctrlKey: boolean - 是否按下Ctrl键</span></span><br><span class="line">    <span class="comment">// event.shiftKey: boolean - 是否按下Shift键</span></span><br><span class="line">    <span class="comment">// event.altKey: boolean - 是否按下Alt键</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;keydown&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// keyup - 键盘抬起事件</span></span><br><span class="line">  <span class="title function_">onKeyUp</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;keyup&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 自定义事件</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 触发自定义事件</span></span><br><span class="line">  <span class="title function_">fire</span>(<span class="params">eventType, data</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">fire</span>(eventType, data)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 监听自定义事件</span></span><br><span class="line">  <span class="title function_">on</span>(<span class="params">eventType, callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(eventType, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 移除事件监听</span></span><br><span class="line">  <span class="title function_">off</span>(<span class="params">eventType, callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">off</span>(eventType, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 只监听一次</span></span><br><span class="line">  <span class="title function_">once</span>(<span class="params">eventType, callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">once</span>(eventType, callback)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 事件使用示例</span></span><br><span class="line"><span class="keyword">const</span> mapEvents = <span class="keyword">new</span> <span class="title class_">MapEvents</span>(map)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听点击事件</span></span><br><span class="line">mapEvents.<span class="title function_">onClick</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;点击位置:&#x27;</span>, event.<span class="property">cartographic</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;拾取对象:&#x27;</span>, event.<span class="property">pickedObject</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (event.<span class="property">pickedObject</span> &amp;&amp; event.<span class="property">pickedObject</span>.<span class="property">id</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> graphic = event.<span class="property">pickedObject</span>.<span class="property">id</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;点击的矢量数据:&#x27;</span>, graphic.<span class="property">attr</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听相机变化</span></span><br><span class="line">mapEvents.<span class="title function_">onCameraChanged</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;相机位置:&#x27;</span>, event.<span class="property">position</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;移动百分比:&#x27;</span>, event.<span class="property">percentage</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听图层事件</span></span><br><span class="line">mapEvents.<span class="title function_">onLayerAdded</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;添加图层:&#x27;</span>, event.<span class="property">layer</span>.<span class="property">name</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听键盘事件</span></span><br><span class="line">mapEvents.<span class="title function_">onKeyDown</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (event.<span class="property">key</span> === <span class="string">&#x27;Escape&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;按下ESC键&#x27;</span>)</span><br><span class="line">    <span class="comment">// 取消当前操作</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (event.<span class="property">ctrlKey</span> &amp;&amp; event.<span class="property">key</span> === <span class="string">&#x27;s&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;保存操作&#x27;</span>)</span><br><span class="line">    event.<span class="title function_">preventDefault</span>() <span class="comment">// 阻止默认行为</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义事件</span></span><br><span class="line">mapEvents.<span class="title function_">on</span>(<span class="string">&#x27;dataLoaded&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;数据加载完成:&#x27;</span>, data)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 触发自定义事件</span></span><br><span class="line">mapEvents.<span class="title function_">fire</span>(<span class="string">&#x27;dataLoaded&#x27;</span>, &#123; <span class="attr">count</span>: <span class="number">100</span>, <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>() &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 节流函数处理高频事件</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">throttle</span> = (<span class="params">func, delay</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> timeoutId</span><br><span class="line">  <span class="keyword">let</span> lastExecTime = <span class="number">0</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> currentTime = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (currentTime - lastExecTime &gt; delay) &#123;</span><br><span class="line">      func.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args)</span><br><span class="line">      lastExecTime = currentTime</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">clearTimeout</span>(timeoutId)</span><br><span class="line">      timeoutId = <span class="built_in">setTimeout</span>(</span><br><span class="line">        <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          func.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args)</span><br><span class="line">          lastExecTime = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">        &#125;,</span><br><span class="line">        delay - (currentTime - lastExecTime),</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用节流处理鼠标移动事件</span></span><br><span class="line">mapEvents.<span class="title function_">onMouseMove</span>(</span><br><span class="line">  <span class="title function_">throttle</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;鼠标位置:&#x27;</span>, event.<span class="property">position</span>)</span><br><span class="line">  &#125;, <span class="number">100</span>),</span><br><span class="line">) <span class="comment">// 100ms节流</span></span><br></pre></td></tr></table></figure><h3 id="图层和矢量数据事件"><a href="#图层和矢量数据事件" class="headerlink" title="图层和矢量数据事件"></a>图层和矢量数据事件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GraphicLayer 事件系统</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GraphicLayerEvents</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">layer</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span> = layer</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 图层事件</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// add - 图层添加到地图事件</span></span><br><span class="line">  <span class="title function_">onAdd</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="title function_">on</span>(<span class="string">&#x27;add&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// remove - 图层从地图移除事件</span></span><br><span class="line">  <span class="title function_">onRemove</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="title function_">on</span>(<span class="string">&#x27;remove&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// show - 图层显示事件</span></span><br><span class="line">  <span class="title function_">onShow</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="title function_">on</span>(<span class="string">&#x27;show&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// hide - 图层隐藏事件</span></span><br><span class="line">  <span class="title function_">onHide</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="title function_">on</span>(<span class="string">&#x27;hide&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 矢量数据事件</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// addGraphic - 矢量数据添加事件</span></span><br><span class="line">  <span class="title function_">onAddGraphic</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="title function_">on</span>(<span class="string">&#x27;addGraphic&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// removeGraphic - 矢量数据移除事件</span></span><br><span class="line">  <span class="title function_">onRemoveGraphic</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="title function_">on</span>(<span class="string">&#x27;removeGraphic&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 交互事件</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// click - 图层点击事件</span></span><br><span class="line">  <span class="title function_">onClick</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mouseOver - 鼠标悬停事件</span></span><br><span class="line">  <span class="title function_">onMouseOver</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="title function_">on</span>(<span class="string">&#x27;mouseOver&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mouseOut - 鼠标离开事件</span></span><br><span class="line">  <span class="title function_">onMouseOut</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="title function_">on</span>(<span class="string">&#x27;mouseOut&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 编辑事件</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// editStart - 开始编辑事件</span></span><br><span class="line">  <span class="title function_">onEditStart</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="title function_">on</span>(<span class="string">&#x27;editStart&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// editStop - 停止编辑事件</span></span><br><span class="line">  <span class="title function_">onEditStop</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="title function_">on</span>(<span class="string">&#x27;editStop&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// editMovePoint - 编辑点移动事件</span></span><br><span class="line">  <span class="title function_">onEditMovePoint</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="title function_">on</span>(<span class="string">&#x27;editMovePoint&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Graphic 事件系统</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GraphicEvents</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">graphic</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span> = graphic</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 生命周期事件</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// add - 添加到图层事件</span></span><br><span class="line">  <span class="title function_">onAdd</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="title function_">on</span>(<span class="string">&#x27;add&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// remove - 从图层移除事件</span></span><br><span class="line">  <span class="title function_">onRemove</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="title function_">on</span>(<span class="string">&#x27;remove&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 交互事件</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// click - 点击事件</span></span><br><span class="line">  <span class="title function_">onClick</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// rightClick - 右键点击事件</span></span><br><span class="line">  <span class="title function_">onRightClick</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="title function_">on</span>(<span class="string">&#x27;rightClick&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mouseOver - 鼠标悬停事件</span></span><br><span class="line">  <span class="title function_">onMouseOver</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="title function_">on</span>(<span class="string">&#x27;mouseOver&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mouseOut - 鼠标离开事件</span></span><br><span class="line">  <span class="title function_">onMouseOut</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="title function_">on</span>(<span class="string">&#x27;mouseOut&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 编辑事件</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// editStart - 开始编辑事件</span></span><br><span class="line">  <span class="title function_">onEditStart</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="title function_">on</span>(<span class="string">&#x27;editStart&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// editMovePoint - 编辑点移动事件</span></span><br><span class="line">  <span class="title function_">onEditMovePoint</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="title function_">on</span>(<span class="string">&#x27;editMovePoint&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// editStop - 停止编辑事件</span></span><br><span class="line">  <span class="title function_">onEditStop</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="title function_">on</span>(<span class="string">&#x27;editStop&#x27;</span>, callback)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> graphicLayer = <span class="keyword">new</span> mars3d.<span class="property">layer</span>.<span class="title class_">GraphicLayer</span>()</span><br><span class="line"><span class="keyword">const</span> layerEvents = <span class="keyword">new</span> <span class="title class_">GraphicLayerEvents</span>(graphicLayer)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听图层事件</span></span><br><span class="line">layerEvents.<span class="title function_">onAddGraphic</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;添加矢量数据:&#x27;</span>, event.<span class="property">graphic</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">layerEvents.<span class="title function_">onClick</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;点击图层:&#x27;</span>, event.<span class="property">graphic</span>.<span class="property">attr</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建矢量数据并监听事件</span></span><br><span class="line"><span class="keyword">const</span> point = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PointEntity</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: [<span class="number">117.207</span>, <span class="number">31.794</span>, <span class="number">100</span>],</span><br><span class="line">  <span class="attr">style</span>: &#123; <span class="attr">color</span>: <span class="string">&#x27;#ff0000&#x27;</span>, <span class="attr">pixelSize</span>: <span class="number">15</span> &#125;,</span><br><span class="line">  <span class="attr">attr</span>: &#123; <span class="attr">name</span>: <span class="string">&#x27;测试点&#x27;</span> &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pointEvents = <span class="keyword">new</span> <span class="title class_">GraphicEvents</span>(point)</span><br><span class="line"></span><br><span class="line">pointEvents.<span class="title function_">onClick</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;点击点数据:&#x27;</span>, event.<span class="property">target</span>.<span class="property">attr</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">pointEvents.<span class="title function_">onMouseOver</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 鼠标悬停时改变颜色</span></span><br><span class="line">  event.<span class="property">target</span>.<span class="title function_">setStyle</span>(&#123; <span class="attr">color</span>: <span class="string">&#x27;#00ff00&#x27;</span> &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">pointEvents.<span class="title function_">onMouseOut</span>(<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 鼠标离开时恢复颜色</span></span><br><span class="line">  event.<span class="property">target</span>.<span class="title function_">setStyle</span>(&#123; <span class="attr">color</span>: <span class="string">&#x27;#ff0000&#x27;</span> &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">graphicLayer.<span class="title function_">addGraphic</span>(point)</span><br></pre></td></tr></table></figure><h2 id="材质系统详解"><a href="#材质系统详解" class="headerlink" title="材质系统详解"></a>材质系统详解</h2><h3 id="基础材质类型"><a href="#基础材质类型" class="headerlink" title="基础材质类型"></a>基础材质类型</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 材质系统</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MaterialSystem</span> &#123;</span><br><span class="line">  <span class="comment">// Color 颜色材质</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createColorMaterial</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;Color&#x27;</span>,</span><br><span class="line">      <span class="comment">// color: string | Object</span></span><br><span class="line">      <span class="comment">// 作用: 颜色值</span></span><br><span class="line">      <span class="comment">// 格式: &#x27;#ff0000&#x27; | &#x27;red&#x27; | &#123;r: 1, g: 0, b: 0, a: 1&#125;</span></span><br><span class="line">      <span class="attr">color</span>: options.<span class="property">color</span> || <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// opacity: number</span></span><br><span class="line">      <span class="comment">// 作用: 透明度</span></span><br><span class="line">      <span class="comment">// 默认: 1.0</span></span><br><span class="line">      <span class="comment">// 范围: 0.0 - 1.0</span></span><br><span class="line">      <span class="attr">opacity</span>: options.<span class="property">opacity</span> !== <span class="literal">undefined</span> ? options.<span class="property">opacity</span> : <span class="number">1.0</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Image 图片材质</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createImageMaterial</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;Image&#x27;</span>,</span><br><span class="line">      <span class="comment">// image: string</span></span><br><span class="line">      <span class="comment">// 作用: 图片地址</span></span><br><span class="line">      <span class="attr">image</span>: options.<span class="property">image</span> || <span class="string">&#x27;&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// repeat: Object</span></span><br><span class="line">      <span class="comment">// 作用: 重复模式</span></span><br><span class="line">      <span class="comment">// 格式: &#123;x: number, y: number&#125;</span></span><br><span class="line">      <span class="attr">repeat</span>: options.<span class="property">repeat</span> || &#123; <span class="attr">x</span>: <span class="number">1</span>, <span class="attr">y</span>: <span class="number">1</span> &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// color: string</span></span><br><span class="line">      <span class="comment">// 作用: 混合颜色</span></span><br><span class="line">      <span class="attr">color</span>: options.<span class="property">color</span> || <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// opacity: number</span></span><br><span class="line">      <span class="comment">// 作用: 透明度</span></span><br><span class="line">      <span class="attr">opacity</span>: options.<span class="property">opacity</span> !== <span class="literal">undefined</span> ? options.<span class="property">opacity</span> : <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// transparent: boolean</span></span><br><span class="line">      <span class="comment">// 作用: 是否透明</span></span><br><span class="line">      <span class="attr">transparent</span>: options.<span class="property">transparent</span> !== <span class="literal">undefined</span> ? options.<span class="property">transparent</span> : <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Grid 网格材质</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createGridMaterial</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;Grid&#x27;</span>,</span><br><span class="line">      <span class="comment">// color: string</span></span><br><span class="line">      <span class="comment">// 作用: 网格颜色</span></span><br><span class="line">      <span class="attr">color</span>: options.<span class="property">color</span> || <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// cellAlpha: number</span></span><br><span class="line">      <span class="comment">// 作用: 单元格透明度</span></span><br><span class="line">      <span class="comment">// 默认: 0.1</span></span><br><span class="line">      <span class="attr">cellAlpha</span>: options.<span class="property">cellAlpha</span> !== <span class="literal">undefined</span> ? options.<span class="property">cellAlpha</span> : <span class="number">0.1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// lineCount: Object</span></span><br><span class="line">      <span class="comment">// 作用: 线条数量</span></span><br><span class="line">      <span class="comment">// 格式: &#123;x: number, y: number&#125;</span></span><br><span class="line">      <span class="attr">lineCount</span>: options.<span class="property">lineCount</span> || &#123; <span class="attr">x</span>: <span class="number">8</span>, <span class="attr">y</span>: <span class="number">8</span> &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// lineThickness: Object</span></span><br><span class="line">      <span class="comment">// 作用: 线条粗细</span></span><br><span class="line">      <span class="comment">// 格式: &#123;x: number, y: number&#125;</span></span><br><span class="line">      <span class="attr">lineThickness</span>: options.<span class="property">lineThickness</span> || &#123; <span class="attr">x</span>: <span class="number">1</span>, <span class="attr">y</span>: <span class="number">1</span> &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// lineOffset: Object</span></span><br><span class="line">      <span class="comment">// 作用: 线条偏移</span></span><br><span class="line">      <span class="comment">// 格式: &#123;x: number, y: number&#125;</span></span><br><span class="line">      <span class="attr">lineOffset</span>: options.<span class="property">lineOffset</span> || &#123; <span class="attr">x</span>: <span class="number">0</span>, <span class="attr">y</span>: <span class="number">0</span> &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Stripe 条纹材质</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createStripeMaterial</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;Stripe&#x27;</span>,</span><br><span class="line">      <span class="comment">// evenColor: string</span></span><br><span class="line">      <span class="comment">// 作用: 偶数条纹颜色</span></span><br><span class="line">      <span class="attr">evenColor</span>: options.<span class="property">evenColor</span> || <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// oddColor: string</span></span><br><span class="line">      <span class="comment">// 作用: 奇数条纹颜色</span></span><br><span class="line">      <span class="attr">oddColor</span>: options.<span class="property">oddColor</span> || <span class="string">&#x27;#000000&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// repeat: number</span></span><br><span class="line">      <span class="comment">// 作用: 重复次数</span></span><br><span class="line">      <span class="comment">// 默认: 5</span></span><br><span class="line">      <span class="attr">repeat</span>: options.<span class="property">repeat</span> !== <span class="literal">undefined</span> ? options.<span class="property">repeat</span> : <span class="number">5</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// offset: number</span></span><br><span class="line">      <span class="comment">// 作用: 偏移量</span></span><br><span class="line">      <span class="comment">// 默认: 0</span></span><br><span class="line">      <span class="attr">offset</span>: options.<span class="property">offset</span> !== <span class="literal">undefined</span> ? options.<span class="property">offset</span> : <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// orientation: number</span></span><br><span class="line">      <span class="comment">// 作用: 方向</span></span><br><span class="line">      <span class="comment">// 选项: 0(HORIZONTAL), 1(VERTICAL)</span></span><br><span class="line">      <span class="attr">orientation</span>: options.<span class="property">orientation</span> !== <span class="literal">undefined</span> ? options.<span class="property">orientation</span> : <span class="number">0</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Checkerboard 棋盘材质</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createCheckerboardMaterial</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;Checkerboard&#x27;</span>,</span><br><span class="line">      <span class="comment">// evenColor: string</span></span><br><span class="line">      <span class="comment">// 作用: 偶数格颜色</span></span><br><span class="line">      <span class="attr">evenColor</span>: options.<span class="property">evenColor</span> || <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// oddColor: string</span></span><br><span class="line">      <span class="comment">// 作用: 奇数格颜色</span></span><br><span class="line">      <span class="attr">oddColor</span>: options.<span class="property">oddColor</span> || <span class="string">&#x27;#000000&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// repeat: Object</span></span><br><span class="line">      <span class="comment">// 作用: 重复次数</span></span><br><span class="line">      <span class="comment">// 格式: &#123;x: number, y: number&#125;</span></span><br><span class="line">      <span class="attr">repeat</span>: options.<span class="property">repeat</span> || &#123; <span class="attr">x</span>: <span class="number">5</span>, <span class="attr">y</span>: <span class="number">5</span> &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Water 水体材质</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createWaterMaterial</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;Water&#x27;</span>,</span><br><span class="line">      <span class="comment">// baseWaterColor: string</span></span><br><span class="line">      <span class="comment">// 作用: 基础水体颜色</span></span><br><span class="line">      <span class="attr">baseWaterColor</span>: options.<span class="property">baseWaterColor</span> || <span class="string">&#x27;#006ab4&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// blendColor: string</span></span><br><span class="line">      <span class="comment">// 作用: 混合颜色</span></span><br><span class="line">      <span class="attr">blendColor</span>: options.<span class="property">blendColor</span> || <span class="string">&#x27;#006ab4&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// specularMap: string</span></span><br><span class="line">      <span class="comment">// 作用: 高光贴图</span></span><br><span class="line">      <span class="attr">specularMap</span>: options.<span class="property">specularMap</span> || <span class="string">&#x27;&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// normalMap: string</span></span><br><span class="line">      <span class="comment">// 作用: 法线贴图</span></span><br><span class="line">      <span class="attr">normalMap</span>: options.<span class="property">normalMap</span> || <span class="string">&#x27;&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// frequency: number</span></span><br><span class="line">      <span class="comment">// 作用: 波浪频率</span></span><br><span class="line">      <span class="comment">// 默认: 100</span></span><br><span class="line">      <span class="attr">frequency</span>: options.<span class="property">frequency</span> !== <span class="literal">undefined</span> ? options.<span class="property">frequency</span> : <span class="number">100</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// animationSpeed: number</span></span><br><span class="line">      <span class="comment">// 作用: 动画速度</span></span><br><span class="line">      <span class="comment">// 默认: 0.01</span></span><br><span class="line">      <span class="attr">animationSpeed</span>: options.<span class="property">animationSpeed</span> !== <span class="literal">undefined</span> ? options.<span class="property">animationSpeed</span> : <span class="number">0.01</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// amplitude: number</span></span><br><span class="line">      <span class="comment">// 作用: 波浪幅度</span></span><br><span class="line">      <span class="comment">// 默认: 1.0</span></span><br><span class="line">      <span class="attr">amplitude</span>: options.<span class="property">amplitude</span> !== <span class="literal">undefined</span> ? options.<span class="property">amplitude</span> : <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// specularIntensity: number</span></span><br><span class="line">      <span class="comment">// 作用: 高光强度</span></span><br><span class="line">      <span class="comment">// 默认: 0.5</span></span><br><span class="line">      <span class="attr">specularIntensity</span>: options.<span class="property">specularIntensity</span> !== <span class="literal">undefined</span> ? options.<span class="property">specularIntensity</span> : <span class="number">0.5</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线条材质系统</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PolylineMaterialSystem</span> &#123;</span><br><span class="line">  <span class="comment">// Color 颜色线条材质</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createColorMaterial</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;Color&#x27;</span>,</span><br><span class="line">      <span class="attr">color</span>: options.<span class="property">color</span> || <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line">      <span class="attr">opacity</span>: options.<span class="property">opacity</span> !== <span class="literal">undefined</span> ? options.<span class="property">opacity</span> : <span class="number">1.0</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// PolylineGlow 发光线条材质</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createGlowMaterial</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;PolylineGlow&#x27;</span>,</span><br><span class="line">      <span class="comment">// color: string</span></span><br><span class="line">      <span class="comment">// 作用: 发光颜色</span></span><br><span class="line">      <span class="attr">color</span>: options.<span class="property">color</span> || <span class="string">&#x27;#00ff00&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// glowPower: number</span></span><br><span class="line">      <span class="comment">// 作用: 发光强度</span></span><br><span class="line">      <span class="comment">// 默认: 0.25</span></span><br><span class="line">      <span class="comment">// 范围: 0.0 - 1.0</span></span><br><span class="line">      <span class="attr">glowPower</span>: options.<span class="property">glowPower</span> !== <span class="literal">undefined</span> ? options.<span class="property">glowPower</span> : <span class="number">0.25</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// taperPower: number</span></span><br><span class="line">      <span class="comment">// 作用: 锥化强度</span></span><br><span class="line">      <span class="comment">// 默认: 1.0</span></span><br><span class="line">      <span class="comment">// 范围: 0.0 - 1.0</span></span><br><span class="line">      <span class="attr">taperPower</span>: options.<span class="property">taperPower</span> !== <span class="literal">undefined</span> ? options.<span class="property">taperPower</span> : <span class="number">1.0</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// PolylineArrow 箭头线条材质</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createArrowMaterial</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;PolylineArrow&#x27;</span>,</span><br><span class="line">      <span class="comment">// color: string</span></span><br><span class="line">      <span class="comment">// 作用: 箭头颜色</span></span><br><span class="line">      <span class="attr">color</span>: options.<span class="property">color</span> || <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// PolylineDash 虚线材质</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createDashMaterial</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;PolylineDash&#x27;</span>,</span><br><span class="line">      <span class="comment">// color: string</span></span><br><span class="line">      <span class="comment">// 作用: 线条颜色</span></span><br><span class="line">      <span class="attr">color</span>: options.<span class="property">color</span> || <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// gapColor: string</span></span><br><span class="line">      <span class="comment">// 作用: 间隙颜色</span></span><br><span class="line">      <span class="attr">gapColor</span>: options.<span class="property">gapColor</span> || <span class="string">&#x27;transparent&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// dashLength: number</span></span><br><span class="line">      <span class="comment">// 作用: 实线长度</span></span><br><span class="line">      <span class="comment">// 默认: 16</span></span><br><span class="line">      <span class="attr">dashLength</span>: options.<span class="property">dashLength</span> !== <span class="literal">undefined</span> ? options.<span class="property">dashLength</span> : <span class="number">16</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// dashPattern: number</span></span><br><span class="line">      <span class="comment">// 作用: 虚线模式</span></span><br><span class="line">      <span class="comment">// 默认: 255</span></span><br><span class="line">      <span class="attr">dashPattern</span>: options.<span class="property">dashPattern</span> !== <span class="literal">undefined</span> ? options.<span class="property">dashPattern</span> : <span class="number">255</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// PolylineOutline 轮廓线条材质</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createOutlineMaterial</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;PolylineOutline&#x27;</span>,</span><br><span class="line">      <span class="comment">// color: string</span></span><br><span class="line">      <span class="comment">// 作用: 线条颜色</span></span><br><span class="line">      <span class="attr">color</span>: options.<span class="property">color</span> || <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// outlineColor: string</span></span><br><span class="line">      <span class="comment">// 作用: 轮廓颜色</span></span><br><span class="line">      <span class="attr">outlineColor</span>: options.<span class="property">outlineColor</span> || <span class="string">&#x27;#000000&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// outlineWidth: number</span></span><br><span class="line">      <span class="comment">// 作用: 轮廓宽度</span></span><br><span class="line">      <span class="comment">// 默认: 1</span></span><br><span class="line">      <span class="attr">outlineWidth</span>: options.<span class="property">outlineWidth</span> !== <span class="literal">undefined</span> ? options.<span class="property">outlineWidth</span> : <span class="number">1</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 材质使用示例</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 面材质示例</span></span><br><span class="line"><span class="keyword">const</span> polygon = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolygonEntity</span>(&#123;</span><br><span class="line">  <span class="attr">positions</span>: [</span><br><span class="line">    [<span class="number">117.18</span>, <span class="number">31.78</span>],</span><br><span class="line">    [<span class="number">117.19</span>, <span class="number">31.78</span>],</span><br><span class="line">    [<span class="number">117.19</span>, <span class="number">31.79</span>],</span><br><span class="line">    [<span class="number">117.18</span>, <span class="number">31.79</span>],</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="comment">// 使用图片材质</span></span><br><span class="line">    <span class="attr">materialType</span>: <span class="string">&#x27;Image&#x27;</span>,</span><br><span class="line">    <span class="attr">materialOptions</span>: <span class="title class_">MaterialSystem</span>.<span class="title function_">createImageMaterial</span>(&#123;</span><br><span class="line">      <span class="attr">image</span>: <span class="string">&#x27;img/textures/grass.jpg&#x27;</span>,</span><br><span class="line">      <span class="attr">repeat</span>: &#123; <span class="attr">x</span>: <span class="number">4</span>, <span class="attr">y</span>: <span class="number">4</span> &#125;,</span><br><span class="line">      <span class="attr">color</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">      <span class="attr">opacity</span>: <span class="number">0.8</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">outlineColor</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">    <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 网格材质</span></span><br><span class="line"><span class="keyword">const</span> gridPolygon = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolygonEntity</span>(&#123;</span><br><span class="line">  <span class="attr">positions</span>: [</span><br><span class="line">    [<span class="number">117.2</span>, <span class="number">31.78</span>],</span><br><span class="line">    [<span class="number">117.21</span>, <span class="number">31.78</span>],</span><br><span class="line">    [<span class="number">117.21</span>, <span class="number">31.79</span>],</span><br><span class="line">    [<span class="number">117.2</span>, <span class="number">31.79</span>],</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">materialType</span>: <span class="string">&#x27;Grid&#x27;</span>,</span><br><span class="line">    <span class="attr">materialOptions</span>: <span class="title class_">MaterialSystem</span>.<span class="title function_">createGridMaterial</span>(&#123;</span><br><span class="line">      <span class="attr">color</span>: <span class="string">&#x27;#00ffff&#x27;</span>,</span><br><span class="line">      <span class="attr">cellAlpha</span>: <span class="number">0.2</span>,</span><br><span class="line">      <span class="attr">lineCount</span>: &#123; <span class="attr">x</span>: <span class="number">10</span>, <span class="attr">y</span>: <span class="number">10</span> &#125;,</span><br><span class="line">      <span class="attr">lineThickness</span>: &#123; <span class="attr">x</span>: <span class="number">2</span>, <span class="attr">y</span>: <span class="number">2</span> &#125;,</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 水体材质</span></span><br><span class="line"><span class="keyword">const</span> waterPolygon = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolygonEntity</span>(&#123;</span><br><span class="line">  <span class="attr">positions</span>: [</span><br><span class="line">    [<span class="number">117.22</span>, <span class="number">31.78</span>],</span><br><span class="line">    [<span class="number">117.23</span>, <span class="number">31.78</span>],</span><br><span class="line">    [<span class="number">117.23</span>, <span class="number">31.79</span>],</span><br><span class="line">    [<span class="number">117.22</span>, <span class="number">31.79</span>],</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">materialType</span>: <span class="string">&#x27;Water&#x27;</span>,</span><br><span class="line">    <span class="attr">materialOptions</span>: <span class="title class_">MaterialSystem</span>.<span class="title function_">createWaterMaterial</span>(&#123;</span><br><span class="line">      <span class="attr">baseWaterColor</span>: <span class="string">&#x27;#006ab4&#x27;</span>,</span><br><span class="line">      <span class="attr">frequency</span>: <span class="number">200</span>,</span><br><span class="line">      <span class="attr">animationSpeed</span>: <span class="number">0.02</span>,</span><br><span class="line">      <span class="attr">amplitude</span>: <span class="number">2.0</span>,</span><br><span class="line">      <span class="attr">specularIntensity</span>: <span class="number">0.8</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线条材质示例</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 发光线条</span></span><br><span class="line"><span class="keyword">const</span> glowPolyline = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolylineEntity</span>(&#123;</span><br><span class="line">  <span class="attr">positions</span>: [</span><br><span class="line">    [<span class="number">117.2</span>, <span class="number">31.79</span>, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">117.21</span>, <span class="number">31.8</span>, <span class="number">100</span>],</span><br><span class="line">    [<span class="number">117.22</span>, <span class="number">31.79</span>, <span class="number">200</span>],</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">width</span>: <span class="number">8</span>,</span><br><span class="line">    <span class="attr">materialType</span>: <span class="string">&#x27;PolylineGlow&#x27;</span>,</span><br><span class="line">    <span class="attr">materialOptions</span>: <span class="title class_">PolylineMaterialSystem</span>.<span class="title function_">createGlowMaterial</span>(&#123;</span><br><span class="line">      <span class="attr">color</span>: <span class="string">&#x27;#00ff00&#x27;</span>,</span><br><span class="line">      <span class="attr">glowPower</span>: <span class="number">0.3</span>,</span><br><span class="line">      <span class="attr">taperPower</span>: <span class="number">0.8</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 箭头线条</span></span><br><span class="line"><span class="keyword">const</span> arrowPolyline = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolylineEntity</span>(&#123;</span><br><span class="line">  <span class="attr">positions</span>: [</span><br><span class="line">    [<span class="number">117.18</span>, <span class="number">31.8</span>, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">117.19</span>, <span class="number">31.81</span>, <span class="number">50</span>],</span><br><span class="line">    [<span class="number">117.2</span>, <span class="number">31.8</span>, <span class="number">100</span>],</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">width</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="attr">materialType</span>: <span class="string">&#x27;PolylineArrow&#x27;</span>,</span><br><span class="line">    <span class="attr">materialOptions</span>: <span class="title class_">PolylineMaterialSystem</span>.<span class="title function_">createArrowMaterial</span>(&#123;</span><br><span class="line">      <span class="attr">color</span>: <span class="string">&#x27;#ff0000&#x27;</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 虚线</span></span><br><span class="line"><span class="keyword">const</span> dashPolyline = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolylineEntity</span>(&#123;</span><br><span class="line">  <span class="attr">positions</span>: [</span><br><span class="line">    [<span class="number">117.16</span>, <span class="number">31.79</span>, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">117.17</span>, <span class="number">31.8</span>, <span class="number">50</span>],</span><br><span class="line">    [<span class="number">117.18</span>, <span class="number">31.79</span>, <span class="number">100</span>],</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">width</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">materialType</span>: <span class="string">&#x27;PolylineDash&#x27;</span>,</span><br><span class="line">    <span class="attr">materialOptions</span>: <span class="title class_">PolylineMaterialSystem</span>.<span class="title function_">createDashMaterial</span>(&#123;</span><br><span class="line">      <span class="attr">color</span>: <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line">      <span class="attr">gapColor</span>: <span class="string">&#x27;transparent&#x27;</span>,</span><br><span class="line">      <span class="attr">dashLength</span>: <span class="number">20</span>,</span><br><span class="line">      <span class="attr">dashPattern</span>: <span class="number">255</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 动态材质示例</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DynamicMaterial</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">time</span> = <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建动态颜色材质</span></span><br><span class="line">  <span class="title function_">createDynamicColorMaterial</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;Color&#x27;</span>,</span><br><span class="line">      <span class="attr">color</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">time</span> += <span class="number">0.1</span></span><br><span class="line">        <span class="keyword">const</span> red = <span class="title class_">Math</span>.<span class="title function_">sin</span>(<span class="variable language_">this</span>.<span class="property">time</span>) * <span class="number">0.5</span> + <span class="number">0.5</span></span><br><span class="line">        <span class="keyword">const</span> green = <span class="title class_">Math</span>.<span class="title function_">cos</span>(<span class="variable language_">this</span>.<span class="property">time</span>) * <span class="number">0.5</span> + <span class="number">0.5</span></span><br><span class="line">        <span class="keyword">const</span> blue = <span class="title class_">Math</span>.<span class="title function_">sin</span>(<span class="variable language_">this</span>.<span class="property">time</span> + <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">3</span>) * <span class="number">0.5</span> + <span class="number">0.5</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">`rgb(<span class="subst">$&#123;<span class="built_in">Math</span>.floor(red * <span class="number">255</span>)&#125;</span>, <span class="subst">$&#123;<span class="built_in">Math</span>.floor(green * <span class="number">255</span>)&#125;</span>, <span class="subst">$&#123;<span class="built_in">Math</span>.floor(blue * <span class="number">255</span>)&#125;</span>)`</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建动态水体材质</span></span><br><span class="line">  <span class="title function_">createDynamicWaterMaterial</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;Water&#x27;</span>,</span><br><span class="line">      <span class="attr">baseWaterColor</span>: <span class="string">&#x27;#006ab4&#x27;</span>,</span><br><span class="line">      <span class="attr">frequency</span>: <span class="function">() =&gt;</span> <span class="number">100</span> + <span class="title class_">Math</span>.<span class="title function_">sin</span>(<span class="variable language_">this</span>.<span class="property">time</span> * <span class="number">0.5</span>) * <span class="number">50</span>,</span><br><span class="line">      <span class="attr">animationSpeed</span>: <span class="number">0.02</span>,</span><br><span class="line">      <span class="attr">amplitude</span>: <span class="function">() =&gt;</span> <span class="number">1.0</span> + <span class="title class_">Math</span>.<span class="title function_">cos</span>(<span class="variable language_">this</span>.<span class="property">time</span> * <span class="number">0.3</span>) * <span class="number">0.5</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用动态材质</span></span><br><span class="line"><span class="keyword">const</span> dynamicMaterial = <span class="keyword">new</span> <span class="title class_">DynamicMaterial</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> dynamicPolygon = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolygonEntity</span>(&#123;</span><br><span class="line">  <span class="attr">positions</span>: [</span><br><span class="line">    [<span class="number">117.24</span>, <span class="number">31.78</span>],</span><br><span class="line">    [<span class="number">117.25</span>, <span class="number">31.78</span>],</span><br><span class="line">    [<span class="number">117.25</span>, <span class="number">31.79</span>],</span><br><span class="line">    [<span class="number">117.24</span>, <span class="number">31.79</span>],</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">materialType</span>: <span class="string">&#x27;Color&#x27;</span>,</span><br><span class="line">    <span class="attr">materialOptions</span>: dynamicMaterial.<span class="title function_">createDynamicColorMaterial</span>(),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定时更新动态材质</span></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  dynamicPolygon.<span class="title function_">updateStyle</span>()</span><br><span class="line">&#125;, <span class="number">100</span>)</span><br></pre></td></tr></table></figure><h2 id="动画系统详解"><a href="#动画系统详解" class="headerlink" title="动画系统详解"></a>动画系统详解</h2><h3 id="时间轴动画"><a href="#时间轴动画" class="headerlink" title="时间轴动画"></a>时间轴动画</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 时间轴动画系统</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TimelineAnimation</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span> = map</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span> = map.<span class="property">viewer</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clock</span> = map.<span class="property">clock</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置时间范围</span></span><br><span class="line">  <span class="title function_">setTimeRange</span>(<span class="params">start, stop</span>) &#123;</span><br><span class="line">    <span class="comment">// start: Date | string - 开始时间</span></span><br><span class="line">    <span class="comment">// stop: Date | string - 结束时间</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> startTime = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(start))</span><br><span class="line">    <span class="keyword">const</span> stopTime = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(stop))</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">startTime</span> = startTime</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">stopTime</span> = stopTime</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">currentTime</span> = startTime</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置时间轴可见</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">timeline</span>.<span class="title function_">updateFromClock</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">timeline</span>.<span class="title function_">zoomTo</span>(startTime, stopTime)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置时钟属性</span></span><br><span class="line">  <span class="title function_">setClockSettings</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// clockRange: number</span></span><br><span class="line">    <span class="comment">// 作用: 时钟循环模式</span></span><br><span class="line">    <span class="comment">// 选项: 0(UNBOUNDED), 1(CLAMPED), 2(LOOP_STOP)</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">clockRange</span> !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">clockRange</span> = options.<span class="property">clockRange</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clockStep: number</span></span><br><span class="line">    <span class="comment">// 作用: 时钟步进模式</span></span><br><span class="line">    <span class="comment">// 选项: 0(TICK_DEPENDENT), 1(SYSTEM_CLOCK_MULTIPLIER), 2(SYSTEM_CLOCK)</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">clockStep</span> !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">clockStep</span> = options.<span class="property">clockStep</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// multiplier: number</span></span><br><span class="line">    <span class="comment">// 作用: 时间倍速</span></span><br><span class="line">    <span class="comment">// 默认: 1.0</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">multiplier</span> !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">multiplier</span> = options.<span class="property">multiplier</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// shouldAnimate: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否自动播放</span></span><br><span class="line">    <span class="comment">// 默认: true</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">shouldAnimate</span> !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">shouldAnimate</span> = options.<span class="property">shouldAnimate</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 播放控制</span></span><br><span class="line">  <span class="title function_">play</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">shouldAnimate</span> = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">pause</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">shouldAnimate</span> = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">stop</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">shouldAnimate</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">currentTime</span> = <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">startTime</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置当前时间</span></span><br><span class="line">  <span class="title function_">setCurrentTime</span>(<span class="params">time</span>) &#123;</span><br><span class="line">    <span class="comment">// time: Date | string</span></span><br><span class="line">    <span class="keyword">const</span> julianDate = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(time))</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">currentTime</span> = julianDate</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取当前时间</span></span><br><span class="line">  <span class="title function_">getCurrentTime</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">toDate</span>(<span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">currentTime</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置播放速度</span></span><br><span class="line">  <span class="title function_">setSpeed</span>(<span class="params">multiplier</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">multiplier</span> = multiplier</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 监听时间变化</span></span><br><span class="line">  <span class="title function_">onTimeChanged</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">onTick</span>.<span class="title function_">addEventListener</span>(callback)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 属性动画系统</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PropertyAnimation</span> &#123;</span><br><span class="line">  <span class="comment">// 创建位置动画</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createPositionAnimation</span>(<span class="params">positions, times</span>) &#123;</span><br><span class="line">    <span class="comment">// positions: Array - 位置数组 [[lng,lat,alt], ...]</span></span><br><span class="line">    <span class="comment">// times: Array - 时间数组 [Date, ...]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> property = <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">SampledPositionProperty</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; positions.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> time = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(times[i])</span><br><span class="line">      <span class="keyword">const</span> position = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(positions[i]).<span class="title function_">toCartesian</span>()</span><br><span class="line">      property.<span class="title function_">addSample</span>(time, position)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置插值算法</span></span><br><span class="line">    property.<span class="title function_">setInterpolationOptions</span>(&#123;</span><br><span class="line">      <span class="attr">interpolationDegree</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">interpolationAlgorithm</span>: mars3d.<span class="property">Cesium</span>.<span class="property">HermitePolynomialApproximation</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> property</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建方向动画</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createOrientationAnimation</span>(<span class="params">orientations, times</span>) &#123;</span><br><span class="line">    <span class="comment">// orientations: Array - 方向数组 [&#123;heading, pitch, roll&#125;, ...]</span></span><br><span class="line">    <span class="comment">// times: Array - 时间数组 [Date, ...]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> property = <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">SampledProperty</span>(mars3d.<span class="property">Cesium</span>.<span class="property">Quaternion</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; orientations.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> time = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(times[i])</span><br><span class="line">      <span class="keyword">const</span> hpr = mars3d.<span class="property">Cesium</span>.<span class="property">HeadingPitchRoll</span>.<span class="title function_">fromDegrees</span>(</span><br><span class="line">        orientations[i].<span class="property">heading</span>,</span><br><span class="line">        orientations[i].<span class="property">pitch</span>,</span><br><span class="line">        orientations[i].<span class="property">roll</span>,</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">const</span> quaternion = mars3d.<span class="property">Cesium</span>.<span class="property">Transforms</span>.<span class="title function_">headingPitchRollQuaternion</span>(</span><br><span class="line">        mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(positions[i]).<span class="title function_">toCartesian</span>(),</span><br><span class="line">        hpr,</span><br><span class="line">      )</span><br><span class="line">      property.<span class="title function_">addSample</span>(time, quaternion)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> property</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建缩放动画</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createScaleAnimation</span>(<span class="params">scales, times</span>) &#123;</span><br><span class="line">    <span class="comment">// scales: Array - 缩放数组 [number, ...]</span></span><br><span class="line">    <span class="comment">// times: Array - 时间数组 [Date, ...]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> property = <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">SampledProperty</span>(<span class="title class_">Number</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; scales.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> time = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(times[i])</span><br><span class="line">      property.<span class="title function_">addSample</span>(time, scales[i])</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> property</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建颜色动画</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createColorAnimation</span>(<span class="params">colors, times</span>) &#123;</span><br><span class="line">    <span class="comment">// colors: Array - 颜色数组 [&#x27;#ff0000&#x27;, ...]</span></span><br><span class="line">    <span class="comment">// times: Array - 时间数组 [Date, ...]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> property = <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">SampledProperty</span>(mars3d.<span class="property">Cesium</span>.<span class="property">Color</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; colors.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> time = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(times[i])</span><br><span class="line">      <span class="keyword">const</span> color = mars3d.<span class="property">Cesium</span>.<span class="property">Color</span>.<span class="title function_">fromCssColorString</span>(colors[i])</span><br><span class="line">      property.<span class="title function_">addSample</span>(time, color)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> property</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建透明度动画</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createOpacityAnimation</span>(<span class="params">opacities, times</span>) &#123;</span><br><span class="line">    <span class="comment">// opacities: Array - 透明度数组 [number, ...]</span></span><br><span class="line">    <span class="comment">// times: Array - 时间数组 [Date, ...]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> property = <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">SampledProperty</span>(<span class="title class_">Number</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; opacities.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> time = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(times[i])</span><br><span class="line">      property.<span class="title function_">addSample</span>(time, opacities[i])</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> property</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 路径动画</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PathAnimation</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">graphic, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span> = graphic</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span> = options</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isPlaying</span> = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置路径点</span></span><br><span class="line">  <span class="title function_">setPath</span>(<span class="params">path, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// path: Array - 路径点数组</span></span><br><span class="line">    <span class="comment">// 格式: [&#123;position: [lng,lat,alt], time: Date, ...&#125;, ...]</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">path</span> = path</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 提取位置和时间数组</span></span><br><span class="line">    <span class="keyword">const</span> positions = path.<span class="title function_">map</span>(<span class="function">(<span class="params">point</span>) =&gt;</span> point.<span class="property">position</span>)</span><br><span class="line">    <span class="keyword">const</span> times = path.<span class="title function_">map</span>(<span class="function">(<span class="params">point</span>) =&gt;</span> point.<span class="property">time</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建位置动画属性</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">positionProperty</span> = <span class="title class_">PropertyAnimation</span>.<span class="title function_">createPositionAnimation</span>(positions, times)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果有方向信息，创建方向动画</span></span><br><span class="line">    <span class="keyword">if</span> (path[<span class="number">0</span>].<span class="property">heading</span> !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> orientations = path.<span class="title function_">map</span>(<span class="function">(<span class="params">point</span>) =&gt;</span> (&#123;</span><br><span class="line">        <span class="attr">heading</span>: point.<span class="property">heading</span> || <span class="number">0</span>,</span><br><span class="line">        <span class="attr">pitch</span>: point.<span class="property">pitch</span> || <span class="number">0</span>,</span><br><span class="line">        <span class="attr">roll</span>: point.<span class="property">roll</span> || <span class="number">0</span>,</span><br><span class="line">      &#125;))</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">orientationProperty</span> = <span class="title class_">PropertyAnimation</span>.<span class="title function_">createOrientationAnimation</span>(orientations, times)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置可用性</span></span><br><span class="line">    <span class="keyword">const</span> startTime = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(times[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">const</span> stopTime = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(times[times.<span class="property">length</span> - <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">availability</span> = <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">TimeIntervalCollection</span>([</span><br><span class="line">      <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">TimeInterval</span>(&#123;</span><br><span class="line">        <span class="attr">start</span>: startTime,</span><br><span class="line">        <span class="attr">stop</span>: stopTime,</span><br><span class="line">      &#125;),</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 应用动画属性</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">position</span> = <span class="variable language_">this</span>.<span class="property">positionProperty</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">orientationProperty</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">orientation</span> = <span class="variable language_">this</span>.<span class="property">orientationProperty</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 显示路径轨迹</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">showPath</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">path</span> = &#123;</span><br><span class="line">        <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">width</span>: options.<span class="property">pathWidth</span> || <span class="number">2</span>,</span><br><span class="line">        <span class="attr">material</span>: mars3d.<span class="property">Cesium</span>.<span class="property">Color</span>.<span class="title function_">fromCssColorString</span>(options.<span class="property">pathColor</span> || <span class="string">&#x27;#ffff00&#x27;</span>),</span><br><span class="line">        <span class="attr">resolution</span>: options.<span class="property">pathResolution</span> || <span class="number">60</span>,</span><br><span class="line">        <span class="attr">leadTime</span>: options.<span class="property">leadTime</span> || <span class="number">0</span>,</span><br><span class="line">        <span class="attr">trailTime</span>: options.<span class="property">trailTime</span> || <span class="number">60</span>,</span><br><span class="line">        <span class="attr">distanceDisplayCondition</span>: options.<span class="property">distanceDisplayCondition</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 播放动画</span></span><br><span class="line">  <span class="title function_">play</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">path</span> || <span class="variable language_">this</span>.<span class="property">path</span>.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;路径为空，无法播放动画&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> startTime = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="variable language_">this</span>.<span class="property">path</span>[<span class="number">0</span>].<span class="property">time</span>)</span><br><span class="line">    <span class="keyword">const</span> stopTime = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="variable language_">this</span>.<span class="property">path</span>[<span class="variable language_">this</span>.<span class="property">path</span>.<span class="property">length</span> - <span class="number">1</span>].<span class="property">time</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置时间轴</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">clock</span>.<span class="property">startTime</span> = startTime</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">clock</span>.<span class="property">stopTime</span> = stopTime</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">clock</span>.<span class="property">currentTime</span> = startTime</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">clock</span>.<span class="property">clockRange</span> = mars3d.<span class="property">Cesium</span>.<span class="property">ClockRange</span>.<span class="property">LOOP_STOP</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">clock</span>.<span class="property">multiplier</span> = options.<span class="property">speed</span> || <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开始播放</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">clock</span>.<span class="property">shouldAnimate</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isPlaying</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跟踪相机</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">followCamera</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">trackedEntity</span> = <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">_cesiumEntity</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 暂停动画</span></span><br><span class="line">  <span class="title function_">pause</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">clock</span>.<span class="property">shouldAnimate</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isPlaying</span> = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 停止动画</span></span><br><span class="line">  <span class="title function_">stop</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">clock</span>.<span class="property">shouldAnimate</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">trackedEntity</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isPlaying</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重置到起始时间</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">path</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">path</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> startTime = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="variable language_">this</span>.<span class="property">path</span>[<span class="number">0</span>].<span class="property">time</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">clock</span>.<span class="property">currentTime</span> = startTime</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置播放速度</span></span><br><span class="line">  <span class="title function_">setSpeed</span>(<span class="params">speed</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">clock</span>.<span class="property">multiplier</span> = speed</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 跳转到指定时间</span></span><br><span class="line">  <span class="title function_">seekToTime</span>(<span class="params">time</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> julianDate = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(time))</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">clock</span>.<span class="property">currentTime</span> = julianDate</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取当前播放进度 (0-1)</span></span><br><span class="line">  <span class="title function_">getProgress</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">path</span> || <span class="variable language_">this</span>.<span class="property">path</span>.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> currentTime = <span class="variable language_">this</span>.<span class="property">graphic</span>.<span class="property">layer</span>.<span class="property">map</span>.<span class="property">clock</span>.<span class="property">currentTime</span></span><br><span class="line">    <span class="keyword">const</span> startTime = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="variable language_">this</span>.<span class="property">path</span>[<span class="number">0</span>].<span class="property">time</span>)</span><br><span class="line">    <span class="keyword">const</span> stopTime = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromDate</span>(<span class="variable language_">this</span>.<span class="property">path</span>[<span class="variable language_">this</span>.<span class="property">path</span>.<span class="property">length</span> - <span class="number">1</span>].<span class="property">time</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> totalDuration = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">secondsDifference</span>(stopTime, startTime)</span><br><span class="line">    <span class="keyword">const</span> currentDuration = mars3d.<span class="property">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">secondsDifference</span>(currentTime, startTime)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="number">0</span>, <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="number">1</span>, currentDuration / totalDuration))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 动画使用示例</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化时间轴动画</span></span><br><span class="line"><span class="keyword">const</span> timelineAnimation = <span class="keyword">new</span> <span class="title class_">TimelineAnimation</span>(map)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置时间范围（1小时）</span></span><br><span class="line"><span class="keyword">const</span> startTime = <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line"><span class="keyword">const</span> stopTime = <span class="keyword">new</span> <span class="title class_">Date</span>(startTime.<span class="title function_">getTime</span>() + <span class="number">3600000</span>) <span class="comment">// 1小时后</span></span><br><span class="line"></span><br><span class="line">timelineAnimation.<span class="title function_">setTimeRange</span>(startTime, stopTime)</span><br><span class="line">timelineAnimation.<span class="title function_">setClockSettings</span>(&#123;</span><br><span class="line">  <span class="attr">clockRange</span>: <span class="number">2</span>, <span class="comment">// LOOP_STOP</span></span><br><span class="line">  <span class="attr">multiplier</span>: <span class="number">10</span>, <span class="comment">// 10倍速</span></span><br><span class="line">  <span class="attr">shouldAnimate</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建移动的飞机模型</span></span><br><span class="line"><span class="keyword">const</span> aircraft = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">ModelEntity</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: [<span class="number">117.207</span>, <span class="number">31.794</span>, <span class="number">1000</span>],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;model/aircraft.gltf&#x27;</span>,</span><br><span class="line">    <span class="attr">scale</span>: <span class="number">1.0</span>,</span><br><span class="line">    <span class="attr">heading</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">pitch</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">roll</span>: <span class="number">0</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">attr</span>: &#123; <span class="attr">name</span>: <span class="string">&#x27;飞机&#x27;</span> &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义飞行路径</span></span><br><span class="line"><span class="keyword">const</span> flightPath = [</span><br><span class="line">  &#123; <span class="attr">position</span>: [<span class="number">117.2</span>, <span class="number">31.79</span>, <span class="number">1000</span>], <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(startTime.<span class="title function_">getTime</span>()), <span class="attr">heading</span>: <span class="number">0</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">position</span>: [<span class="number">117.21</span>, <span class="number">31.8</span>, <span class="number">1200</span>], <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(startTime.<span class="title function_">getTime</span>() + <span class="number">600000</span>), <span class="attr">heading</span>: <span class="number">45</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">position</span>: [<span class="number">117.22</span>, <span class="number">31.79</span>, <span class="number">1000</span>], <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(startTime.<span class="title function_">getTime</span>() + <span class="number">1200000</span>), <span class="attr">heading</span>: <span class="number">90</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">position</span>: [<span class="number">117.21</span>, <span class="number">31.78</span>, <span class="number">800</span>], <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(startTime.<span class="title function_">getTime</span>() + <span class="number">1800000</span>), <span class="attr">heading</span>: <span class="number">135</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">position</span>: [<span class="number">117.2</span>, <span class="number">31.79</span>, <span class="number">1000</span>], <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(startTime.<span class="title function_">getTime</span>() + <span class="number">2400000</span>), <span class="attr">heading</span>: <span class="number">180</span> &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建路径动画</span></span><br><span class="line"><span class="keyword">const</span> pathAnimation = <span class="keyword">new</span> <span class="title class_">PathAnimation</span>(aircraft, &#123;</span><br><span class="line">  <span class="attr">showPath</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">pathColor</span>: <span class="string">&#x27;#00ff00&#x27;</span>,</span><br><span class="line">  <span class="attr">pathWidth</span>: <span class="number">3</span>,</span><br><span class="line">  <span class="attr">trailTime</span>: <span class="number">300</span>, <span class="comment">// 轨迹保留5分钟</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置路径并播放</span></span><br><span class="line">pathAnimation.<span class="title function_">setPath</span>(flightPath).<span class="title function_">play</span>(&#123;</span><br><span class="line">  <span class="attr">speed</span>: <span class="number">5</span>, <span class="comment">// 5倍速</span></span><br><span class="line">  <span class="attr">followCamera</span>: <span class="literal">true</span>, <span class="comment">// 相机跟踪</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加到图层</span></span><br><span class="line">graphicLayer.<span class="title function_">addGraphic</span>(aircraft)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建属性动画的点</span></span><br><span class="line"><span class="keyword">const</span> animatedPoint = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PointEntity</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: [<span class="number">117.23</span>, <span class="number">31.8</span>, <span class="number">100</span>],</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">pixelSize</span>: <span class="number">15</span>,</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&#x27;#ff0000&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建颜色和大小动画</span></span><br><span class="line"><span class="keyword">const</span> colorTimes = [</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Date</span>(startTime.<span class="title function_">getTime</span>()),</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Date</span>(startTime.<span class="title function_">getTime</span>() + <span class="number">1000000</span>),</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Date</span>(startTime.<span class="title function_">getTime</span>() + <span class="number">2000000</span>),</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Date</span>(startTime.<span class="title function_">getTime</span>() + <span class="number">3000000</span>),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> colors = [<span class="string">&#x27;#ff0000&#x27;</span>, <span class="string">&#x27;#00ff00&#x27;</span>, <span class="string">&#x27;#0000ff&#x27;</span>, <span class="string">&#x27;#ff0000&#x27;</span>]</span><br><span class="line"><span class="keyword">const</span> sizes = [<span class="number">10</span>, <span class="number">20</span>, <span class="number">15</span>, <span class="number">10</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 应用动画属性</span></span><br><span class="line">animatedPoint.<span class="property">_cesiumEntity</span>.<span class="property">point</span>.<span class="property">color</span> = <span class="title class_">PropertyAnimation</span>.<span class="title function_">createColorAnimation</span>(colors, colorTimes)</span><br><span class="line">animatedPoint.<span class="property">_cesiumEntity</span>.<span class="property">point</span>.<span class="property">pixelSize</span> = <span class="title class_">PropertyAnimation</span>.<span class="title function_">createScaleAnimation</span>(</span><br><span class="line">  sizes,</span><br><span class="line">  colorTimes,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">graphicLayer.<span class="title function_">addGraphic</span>(animatedPoint)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听时间变化</span></span><br><span class="line">timelineAnimation.<span class="title function_">onTimeChanged</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> currentTime = timelineAnimation.<span class="title function_">getCurrentTime</span>()</span><br><span class="line">  <span class="keyword">const</span> progress = pathAnimation.<span class="title function_">getProgress</span>()</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;当前时间:&#x27;</span>, currentTime, <span class="string">&#x27;进度:&#x27;</span>, (progress * <span class="number">100</span>).<span class="title function_">toFixed</span>(<span class="number">1</span>) + <span class="string">&#x27;%&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 动画控制按钮事件</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;playBtn&#x27;</span>).<span class="property">onclick</span> = <span class="function">() =&gt;</span> pathAnimation.<span class="title function_">play</span>()</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;pauseBtn&#x27;</span>).<span class="property">onclick</span> = <span class="function">() =&gt;</span> pathAnimation.<span class="title function_">pause</span>()</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;stopBtn&#x27;</span>).<span class="property">onclick</span> = <span class="function">() =&gt;</span> pathAnimation.<span class="title function_">stop</span>()</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;speedBtn&#x27;</span>).<span class="property">onclick</span> = <span class="function">() =&gt;</span> pathAnimation.<span class="title function_">setSpeed</span>(<span class="number">10</span>)</span><br></pre></td></tr></table></figure><p>下文继续为分析、测量、可视域、通视、剖面、坡度等章节的详细实现与属性注释。</p><h2 id="分析功能详解"><a href="#分析功能详解" class="headerlink" title="分析功能详解"></a>分析功能详解</h2><h3 id="测量工具"><a href="#测量工具" class="headerlink" title="测量工具"></a>测量工具</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测量工具系统</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MeasureUtil</span> &#123;</span><br><span class="line">  <span class="comment">// 距离测量</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">measureDistance</span>(<span class="params">positions</span>) &#123;</span><br><span class="line">    <span class="comment">// positions: Array - 位置数组 [[lng,lat,alt], ...]</span></span><br><span class="line">    <span class="comment">// 返回: number - 距离（米）</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> totalDistance = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; positions.<span class="property">length</span> - <span class="number">1</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> point1 = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(positions[i])</span><br><span class="line">      <span class="keyword">const</span> point2 = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(positions[i + <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 计算两点间距离</span></span><br><span class="line">      <span class="keyword">const</span> distance = <span class="variable language_">this</span>.<span class="title function_">getDistance</span>([point1, point2])</span><br><span class="line">      totalDistance += distance</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> totalDistance</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 面积测量</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">measureArea</span>(<span class="params">positions</span>) &#123;</span><br><span class="line">    <span class="comment">// positions: Array - 边界位置数组</span></span><br><span class="line">    <span class="comment">// 返回: number - 面积（平方米）</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (positions.<span class="property">length</span> &lt; <span class="number">3</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转换为Cartesian3坐标</span></span><br><span class="line">    <span class="keyword">const</span> cartesians = positions.<span class="title function_">map</span>(<span class="function">(<span class="params">pos</span>) =&gt;</span> mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(pos).<span class="title function_">toCartesian</span>())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用球面几何计算面积</span></span><br><span class="line">    <span class="keyword">const</span> area = mars3d.<span class="property">Cesium</span>.<span class="property">PolygonPipeline</span>.<span class="title function_">computeArea2D</span>(cartesians)</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">abs</span>(area)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 高度测量</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">measureHeight</span>(<span class="params">startPosition, endPosition</span>) &#123;</span><br><span class="line">    <span class="comment">// startPosition: Array - 起始位置 [lng,lat,alt]</span></span><br><span class="line">    <span class="comment">// endPosition: Array - 结束位置 [lng,lat,alt]</span></span><br><span class="line">    <span class="comment">// 返回: Object - &#123;horizontal: 水平距离, vertical: 垂直距离, slope: 斜距&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> start = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(startPosition)</span><br><span class="line">    <span class="keyword">const</span> end = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(endPosition)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 水平距离</span></span><br><span class="line">    <span class="keyword">const</span> horizontalDistance = <span class="variable language_">this</span>.<span class="title function_">getDistance</span>([</span><br><span class="line">      <span class="keyword">new</span> mars3d.<span class="title class_">LngLatPoint</span>(start.<span class="property">lng</span>, start.<span class="property">lat</span>, <span class="number">0</span>),</span><br><span class="line">      <span class="keyword">new</span> mars3d.<span class="title class_">LngLatPoint</span>(end.<span class="property">lng</span>, end.<span class="property">lat</span>, <span class="number">0</span>),</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 垂直距离</span></span><br><span class="line">    <span class="keyword">const</span> verticalDistance = <span class="title class_">Math</span>.<span class="title function_">abs</span>(end.<span class="property">alt</span> - start.<span class="property">alt</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 斜距</span></span><br><span class="line">    <span class="keyword">const</span> slopeDistance = <span class="variable language_">this</span>.<span class="title function_">getDistance</span>([start, end])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">horizontal</span>: horizontalDistance,</span><br><span class="line">      <span class="attr">vertical</span>: verticalDistance,</span><br><span class="line">      <span class="attr">slope</span>: slopeDistance,</span><br><span class="line">      <span class="attr">angle</span>: (<span class="title class_">Math</span>.<span class="title function_">atan2</span>(verticalDistance, horizontalDistance) * <span class="number">180</span>) / <span class="title class_">Math</span>.<span class="property">PI</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 角度测量</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">measureAngle</span>(<span class="params">centerPosition, startPosition, endPosition</span>) &#123;</span><br><span class="line">    <span class="comment">// centerPosition: Array - 角点位置</span></span><br><span class="line">    <span class="comment">// startPosition: Array - 起始边位置</span></span><br><span class="line">    <span class="comment">// endPosition: Array - 结束边位置</span></span><br><span class="line">    <span class="comment">// 返回: number - 角度（度）</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> center = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(centerPosition).<span class="title function_">toCartesian</span>()</span><br><span class="line">    <span class="keyword">const</span> start = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(startPosition).<span class="title function_">toCartesian</span>()</span><br><span class="line">    <span class="keyword">const</span> end = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(endPosition).<span class="title function_">toCartesian</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算向量</span></span><br><span class="line">    <span class="keyword">const</span> vector1 = mars3d.<span class="property">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">subtract</span>(start, center, <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">Cartesian3</span>())</span><br><span class="line">    <span class="keyword">const</span> vector2 = mars3d.<span class="property">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">subtract</span>(end, center, <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">Cartesian3</span>())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算夹角</span></span><br><span class="line">    <span class="keyword">const</span> dot = mars3d.<span class="property">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">dot</span>(vector1, vector2)</span><br><span class="line">    <span class="keyword">const</span> magnitude1 = mars3d.<span class="property">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">magnitude</span>(vector1)</span><br><span class="line">    <span class="keyword">const</span> magnitude2 = mars3d.<span class="property">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">magnitude</span>(vector2)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> cosAngle = dot / (magnitude1 * magnitude2)</span><br><span class="line">    <span class="keyword">const</span> angle = <span class="title class_">Math</span>.<span class="title function_">acos</span>(mars3d.<span class="property">Cesium</span>.<span class="property">Math</span>.<span class="title function_">clamp</span>(cosAngle, -<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mars3d.<span class="property">Util</span>.<span class="title function_">toDegrees</span>(angle)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 坡度计算</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">calculateSlope</span>(<span class="params">positions</span>) &#123;</span><br><span class="line">    <span class="comment">// positions: Array - 地形剖面位置数组</span></span><br><span class="line">    <span class="comment">// 返回: Array - 坡度数组（百分比）</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> slopes = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; positions.<span class="property">length</span> - <span class="number">1</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> point1 = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(positions[i])</span><br><span class="line">      <span class="keyword">const</span> point2 = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(positions[i + <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> horizontalDistance = <span class="variable language_">this</span>.<span class="title function_">getDistance</span>([</span><br><span class="line">        <span class="keyword">new</span> mars3d.<span class="title class_">LngLatPoint</span>(point1.<span class="property">lng</span>, point1.<span class="property">lat</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="keyword">new</span> mars3d.<span class="title class_">LngLatPoint</span>(point2.<span class="property">lng</span>, point2.<span class="property">lat</span>, <span class="number">0</span>),</span><br><span class="line">      ])</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> verticalDistance = point2.<span class="property">alt</span> - point1.<span class="property">alt</span></span><br><span class="line">      <span class="keyword">const</span> slope = (verticalDistance / horizontalDistance) * <span class="number">100</span></span><br><span class="line"></span><br><span class="line">      slopes.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">distance</span>: horizontalDistance,</span><br><span class="line">        <span class="attr">elevation</span>: verticalDistance,</span><br><span class="line">        <span class="attr">slope</span>: slope,</span><br><span class="line">        <span class="attr">angle</span>: (<span class="title class_">Math</span>.<span class="title function_">atan</span>(slope / <span class="number">100</span>) * <span class="number">180</span>) / <span class="title class_">Math</span>.<span class="property">PI</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> slopes</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 两点间距离计算</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">getDistance</span>(<span class="params">positions</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (positions.<span class="property">length</span> &lt; <span class="number">2</span>) <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> totalDistance = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; positions.<span class="property">length</span> - <span class="number">1</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> point1 = positions[i]</span><br><span class="line">      <span class="keyword">const</span> point2 = positions[i + <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> cartesian1 = point1.<span class="property">toCartesian</span></span><br><span class="line">        ? point1.<span class="title function_">toCartesian</span>()</span><br><span class="line">        : mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(point1).<span class="title function_">toCartesian</span>()</span><br><span class="line">      <span class="keyword">const</span> cartesian2 = point2.<span class="property">toCartesian</span></span><br><span class="line">        ? point2.<span class="title function_">toCartesian</span>()</span><br><span class="line">        : mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(point2).<span class="title function_">toCartesian</span>()</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> distance = mars3d.<span class="property">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">distance</span>(cartesian1, cartesian2)</span><br><span class="line">      totalDistance += distance</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> totalDistance</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 格式化距离显示</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">formatDistance</span>(<span class="params">distance</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (distance &lt; <span class="number">1000</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> distance.<span class="title function_">toFixed</span>(<span class="number">2</span>) + <span class="string">&#x27; 米&#x27;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (distance &lt; <span class="number">1000000</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> (distance / <span class="number">1000</span>).<span class="title function_">toFixed</span>(<span class="number">2</span>) + <span class="string">&#x27; 千米&#x27;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> (distance / <span class="number">1000000</span>).<span class="title function_">toFixed</span>(<span class="number">2</span>) + <span class="string">&#x27; 兆米&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 格式化面积显示</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">formatArea</span>(<span class="params">area</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (area &lt; <span class="number">10000</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> area.<span class="title function_">toFixed</span>(<span class="number">2</span>) + <span class="string">&#x27; 平方米&#x27;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (area &lt; <span class="number">1000000</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> (area / <span class="number">10000</span>).<span class="title function_">toFixed</span>(<span class="number">2</span>) + <span class="string">&#x27; 公顷&#x27;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> (area / <span class="number">1000000</span>).<span class="title function_">toFixed</span>(<span class="number">2</span>) + <span class="string">&#x27; 平方千米&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 可视域分析</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ViewshedAnalysis</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span> = map</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span> = map.<span class="property">viewer</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计算可视域</span></span><br><span class="line">  <span class="title function_">calculateViewshed</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="comment">// options: Object</span></span><br><span class="line">    <span class="comment">// viewPosition: Array - 观察点位置 [lng,lat,alt]</span></span><br><span class="line">    <span class="comment">// targetPositions: Array - 目标点位置数组</span></span><br><span class="line">    <span class="comment">// maxDistance: number - 最大可视距离</span></span><br><span class="line">    <span class="comment">// verticalAngle: number - 垂直视角范围（度）</span></span><br><span class="line">    <span class="comment">// horizontalAngle: number - 水平视角范围（度）</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> viewPoint = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(options.<span class="property">viewPosition</span>)</span><br><span class="line">    <span class="keyword">const</span> maxDistance = options.<span class="property">maxDistance</span> || <span class="number">10000</span></span><br><span class="line">    <span class="keyword">const</span> results = []</span><br><span class="line"></span><br><span class="line">    options.<span class="property">targetPositions</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">targetPos, index</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> targetPoint = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(targetPos)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 计算距离</span></span><br><span class="line">      <span class="keyword">const</span> distance = <span class="title class_">MeasureUtil</span>.<span class="title function_">getDistance</span>([viewPoint, targetPoint])</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (distance &gt; maxDistance) &#123;</span><br><span class="line">        results.<span class="title function_">push</span>(&#123;</span><br><span class="line">          <span class="attr">index</span>: index,</span><br><span class="line">          <span class="attr">position</span>: targetPos,</span><br><span class="line">          <span class="attr">visible</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">reason</span>: <span class="string">&#x27;超出最大可视距离&#x27;</span>,</span><br><span class="line">          <span class="attr">distance</span>: distance,</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 射线检测</span></span><br><span class="line">      <span class="keyword">const</span> startCartesian = viewPoint.<span class="title function_">toCartesian</span>()</span><br><span class="line">      <span class="keyword">const</span> endCartesian = targetPoint.<span class="title function_">toCartesian</span>()</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> ray = <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">Ray</span>(</span><br><span class="line">        startCartesian,</span><br><span class="line">        mars3d.<span class="property">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">subtract</span>(</span><br><span class="line">          endCartesian,</span><br><span class="line">          startCartesian,</span><br><span class="line">          <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">Cartesian3</span>(),</span><br><span class="line">        ),</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 检测与地形或模型的交点</span></span><br><span class="line">      <span class="keyword">const</span> intersection = <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">scene</span>.<span class="title function_">pickFromRay</span>(ray)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> visible = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">let</span> reason = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (intersection &amp;&amp; intersection.<span class="property">position</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> intersectionDistance = mars3d.<span class="property">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">distance</span>(</span><br><span class="line">          startCartesian,</span><br><span class="line">          intersection.<span class="property">position</span>,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (intersectionDistance &lt; distance * <span class="number">0.95</span>) &#123;</span><br><span class="line">          <span class="comment">// 允许5%的误差</span></span><br><span class="line">          visible = <span class="literal">false</span></span><br><span class="line">          reason = <span class="string">&#x27;被地形或建筑遮挡&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      results.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">index</span>: index,</span><br><span class="line">        <span class="attr">position</span>: targetPos,</span><br><span class="line">        <span class="attr">visible</span>: visible,</span><br><span class="line">        <span class="attr">reason</span>: reason,</span><br><span class="line">        <span class="attr">distance</span>: distance,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建可视域锥体</span></span><br><span class="line">  <span class="title function_">createViewshedCone</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="comment">// options: Object - 可视域参数</span></span><br><span class="line">    <span class="keyword">const</span> position = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(options.<span class="property">viewPosition</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">CylinderEntity</span>(&#123;</span><br><span class="line">      <span class="attr">position</span>: options.<span class="property">viewPosition</span>,</span><br><span class="line">      <span class="attr">style</span>: &#123;</span><br><span class="line">        <span class="attr">length</span>: options.<span class="property">maxDistance</span> || <span class="number">5000</span>,</span><br><span class="line">        <span class="attr">topRadius</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">bottomRadius</span>:</span><br><span class="line">          <span class="title class_">Math</span>.<span class="title function_">tan</span>(mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(options.<span class="property">horizontalAngle</span> || <span class="number">45</span>)) *</span><br><span class="line">          (options.<span class="property">maxDistance</span> || <span class="number">5000</span>),</span><br><span class="line">        <span class="attr">material</span>: mars3d.<span class="property">Cesium</span>.<span class="property">Color</span>.<span class="title function_">fromCssColorString</span>(options.<span class="property">color</span> || <span class="string">&#x27;#ffff00&#x27;</span>).<span class="title function_">withAlpha</span>(<span class="number">0.3</span>),</span><br><span class="line">        <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">outlineColor</span>: options.<span class="property">color</span> || <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 剖面分析</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProfileAnalysis</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span> = map</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span> = map.<span class="property">viewer</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 地形剖面分析</span></span><br><span class="line">  <span class="title function_">analyzeTerrainProfile</span>(<span class="params">startPosition, endPosition, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// startPosition: Array - 起始位置</span></span><br><span class="line">    <span class="comment">// endPosition: Array - 结束位置</span></span><br><span class="line">    <span class="comment">// options: Object - 分析参数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> start = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(startPosition)</span><br><span class="line">    <span class="keyword">const</span> end = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(endPosition)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sampleCount = options.<span class="property">sampleCount</span> || <span class="number">100</span></span><br><span class="line">    <span class="keyword">const</span> profilePoints = []</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成剖面采样点</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= sampleCount; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> t = i / sampleCount</span><br><span class="line">      <span class="keyword">const</span> lng = start.<span class="property">lng</span> + (end.<span class="property">lng</span> - start.<span class="property">lng</span>) * t</span><br><span class="line">      <span class="keyword">const</span> lat = start.<span class="property">lat</span> + (end.<span class="property">lat</span> - start.<span class="property">lat</span>) * t</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 获取地形高度</span></span><br><span class="line">      <span class="keyword">const</span> cartographic = mars3d.<span class="property">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromDegrees</span>(lng, lat)</span><br><span class="line">      <span class="keyword">const</span> height = <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">scene</span>.<span class="property">globe</span>.<span class="title function_">getHeight</span>(cartographic) || <span class="number">0</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> distance = <span class="title class_">MeasureUtil</span>.<span class="title function_">getDistance</span>([start, <span class="keyword">new</span> mars3d.<span class="title class_">LngLatPoint</span>(lng, lat, <span class="number">0</span>)])</span><br><span class="line"></span><br><span class="line">      profilePoints.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">position</span>: [lng, lat, height],</span><br><span class="line">        <span class="attr">distance</span>: distance,</span><br><span class="line">        <span class="attr">elevation</span>: height,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">points</span>: profilePoints,</span><br><span class="line">      <span class="attr">totalDistance</span>: <span class="title class_">MeasureUtil</span>.<span class="title function_">getDistance</span>([start, end]),</span><br><span class="line">      <span class="attr">elevationRange</span>: &#123;</span><br><span class="line">        <span class="attr">min</span>: <span class="title class_">Math</span>.<span class="title function_">min</span>(...profilePoints.<span class="title function_">map</span>(<span class="function">(<span class="params">p</span>) =&gt;</span> p.<span class="property">elevation</span>)),</span><br><span class="line">        <span class="attr">max</span>: <span class="title class_">Math</span>.<span class="title function_">max</span>(...profilePoints.<span class="title function_">map</span>(<span class="function">(<span class="params">p</span>) =&gt;</span> p.<span class="property">elevation</span>)),</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">slopes</span>: <span class="title class_">MeasureUtil</span>.<span class="title function_">calculateSlope</span>(profilePoints.<span class="title function_">map</span>(<span class="function">(<span class="params">p</span>) =&gt;</span> p.<span class="property">position</span>)),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建剖面图</span></span><br><span class="line">  <span class="title function_">createProfileChart</span>(<span class="params">profileData, containerId</span>) &#123;</span><br><span class="line">    <span class="comment">// 使用图表库绘制剖面图（以echarts为例）</span></span><br><span class="line">    <span class="keyword">const</span> chartData = profileData.<span class="property">points</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">point</span>) =&gt;</span> [point.<span class="property">distance</span>, point.<span class="property">elevation</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> option = &#123;</span><br><span class="line">      <span class="attr">title</span>: &#123;</span><br><span class="line">        <span class="attr">text</span>: <span class="string">&#x27;地形剖面图&#x27;</span>,</span><br><span class="line">        <span class="attr">left</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">tooltip</span>: &#123;</span><br><span class="line">        <span class="attr">trigger</span>: <span class="string">&#x27;axis&#x27;</span>,</span><br><span class="line">        <span class="attr">formatter</span>: <span class="keyword">function</span> (<span class="params">params</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> point = params[<span class="number">0</span>]</span><br><span class="line">          <span class="keyword">return</span> <span class="string">`距离: <span class="subst">$&#123;(point.data[<span class="number">0</span>] / <span class="number">1000</span>).toFixed(<span class="number">2</span>)&#125;</span>km&lt;br/&gt;高程: <span class="subst">$&#123;point.data[<span class="number">1</span>].toFixed(<span class="number">2</span>)&#125;</span>m`</span></span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">xAxis</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;value&#x27;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;距离(m)&#x27;</span>,</span><br><span class="line">        <span class="attr">axisLabel</span>: &#123;</span><br><span class="line">          <span class="attr">formatter</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (value / <span class="number">1000</span>).<span class="title function_">toFixed</span>(<span class="number">1</span>) + <span class="string">&#x27;km&#x27;</span></span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">yAxis</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;value&#x27;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;高程(m)&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">series</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;line&#x27;</span>,</span><br><span class="line">          <span class="attr">data</span>: chartData,</span><br><span class="line">          <span class="attr">smooth</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">areaStyle</span>: &#123;</span><br><span class="line">            <span class="attr">color</span>: <span class="string">&#x27;rgba(124, 181, 236, 0.3)&#x27;</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">lineStyle</span>: &#123;</span><br><span class="line">            <span class="attr">color</span>: <span class="string">&#x27;#7cb5ec&#x27;</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 假设已引入echarts</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> echarts !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> chart = echarts.<span class="title function_">init</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(containerId))</span><br><span class="line">      chart.<span class="title function_">setOption</span>(option)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 返回图表实例以便后续操作</span></span><br><span class="line">      <span class="keyword">return</span> chart</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 洪水淹没分析</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FloodAnalysis</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span> = map</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span> = map.<span class="property">viewer</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">floodEntity</span> = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建洪水淹没分析</span></span><br><span class="line">  <span class="title function_">createFloodAnalysis</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="comment">// options: Object</span></span><br><span class="line">    <span class="comment">// bounds: Array - 分析范围 [xmin, ymin, xmax, ymax]</span></span><br><span class="line">    <span class="comment">// waterLevel: number - 水位高度</span></span><br><span class="line">    <span class="comment">// baseHeight: number - 基准高度</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> bounds = options.<span class="property">bounds</span></span><br><span class="line">    <span class="keyword">const</span> waterLevel = options.<span class="property">waterLevel</span> || <span class="number">100</span></span><br><span class="line">    <span class="keyword">const</span> baseHeight = options.<span class="property">baseHeight</span> || <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建水体面</span></span><br><span class="line">    <span class="keyword">const</span> positions = [</span><br><span class="line">      [bounds[<span class="number">0</span>], bounds[<span class="number">1</span>], waterLevel],</span><br><span class="line">      [bounds[<span class="number">2</span>], bounds[<span class="number">1</span>], waterLevel],</span><br><span class="line">      [bounds[<span class="number">2</span>], bounds[<span class="number">3</span>], waterLevel],</span><br><span class="line">      [bounds[<span class="number">0</span>], bounds[<span class="number">3</span>], waterLevel],</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">floodEntity</span> = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolygonEntity</span>(&#123;</span><br><span class="line">      <span class="attr">positions</span>: positions,</span><br><span class="line">      <span class="attr">style</span>: &#123;</span><br><span class="line">        <span class="attr">material</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;Water&#x27;</span>,</span><br><span class="line">          <span class="attr">baseWaterColor</span>: <span class="string">&#x27;#006ab4&#x27;</span>,</span><br><span class="line">          <span class="attr">frequency</span>: <span class="number">100</span>,</span><br><span class="line">          <span class="attr">animationSpeed</span>: <span class="number">0.01</span>,</span><br><span class="line">          <span class="attr">amplitude</span>: <span class="number">1.0</span>,</span><br><span class="line">          <span class="attr">specularIntensity</span>: <span class="number">0.8</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">opacity</span>: <span class="number">0.7</span>,</span><br><span class="line">        <span class="attr">clampToGround</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">height</span>: waterLevel,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">attr</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;flood&#x27;</span>,</span><br><span class="line">        <span class="attr">waterLevel</span>: waterLevel,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">floodEntity</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 动态调整水位</span></span><br><span class="line">  <span class="title function_">setWaterLevel</span>(<span class="params">level</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">floodEntity</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">floodEntity</span>.<span class="property">attr</span>.<span class="property">waterLevel</span> = level</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 更新多边形高度</span></span><br><span class="line">      <span class="keyword">const</span> newPositions = <span class="variable language_">this</span>.<span class="property">floodEntity</span>.<span class="property">positions</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">pos</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> [pos[<span class="number">0</span>], pos[<span class="number">1</span>], level]</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">floodEntity</span>.<span class="property">positions</span> = newPositions</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">floodEntity</span>.<span class="property">style</span>.<span class="property">height</span> = level</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">floodEntity</span>.<span class="title function_">updateStyle</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计算淹没体积</span></span><br><span class="line">  <span class="title function_">calculateFloodVolume</span>(<span class="params">bounds, waterLevel, terrainData</span>) &#123;</span><br><span class="line">    <span class="comment">// 简化计算：将区域分割为网格，计算每个网格的淹没体积</span></span><br><span class="line">    <span class="keyword">const</span> gridSize = <span class="number">100</span> <span class="comment">// 网格大小（米）</span></span><br><span class="line">    <span class="keyword">const</span> width = bounds[<span class="number">2</span>] - bounds[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">const</span> height = bounds[<span class="number">3</span>] - bounds[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> gridCountX = <span class="title class_">Math</span>.<span class="title function_">ceil</span>((width * <span class="number">111320</span>) / gridSize) <span class="comment">// 经度转米的近似值</span></span><br><span class="line">    <span class="keyword">const</span> gridCountY = <span class="title class_">Math</span>.<span class="title function_">ceil</span>((height * <span class="number">110540</span>) / gridSize) <span class="comment">// 纬度转米的近似值</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> totalVolume = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; gridCountX; i++) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; gridCountY; j++) &#123;</span><br><span class="line">        <span class="keyword">const</span> lng = bounds[<span class="number">0</span>] + (width * i) / gridCountX</span><br><span class="line">        <span class="keyword">const</span> lat = bounds[<span class="number">1</span>] + (height * j) / gridCountY</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取地形高度</span></span><br><span class="line">        <span class="keyword">const</span> cartographic = mars3d.<span class="property">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromDegrees</span>(lng, lat)</span><br><span class="line">        <span class="keyword">const</span> terrainHeight = <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">scene</span>.<span class="property">globe</span>.<span class="title function_">getHeight</span>(cartographic) || <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (waterLevel &gt; terrainHeight) &#123;</span><br><span class="line">          <span class="keyword">const</span> depth = waterLevel - terrainHeight</span><br><span class="line">          <span class="keyword">const</span> cellArea = gridSize * gridSize</span><br><span class="line">          totalVolume += depth * cellArea</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> totalVolume</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 分析工具使用示例</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 测量功能示例</span></span><br><span class="line"><span class="keyword">const</span> measureTool = <span class="keyword">new</span> <span class="title class_">MeasureUtil</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 距离测量</span></span><br><span class="line"><span class="keyword">const</span> positions = [</span><br><span class="line">  [<span class="number">117.2</span>, <span class="number">31.79</span>, <span class="number">0</span>],</span><br><span class="line">  [<span class="number">117.21</span>, <span class="number">31.8</span>, <span class="number">100</span>],</span><br><span class="line">  [<span class="number">117.22</span>, <span class="number">31.79</span>, <span class="number">200</span>],</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> distance = <span class="title class_">MeasureUtil</span>.<span class="title function_">measureDistance</span>(positions)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;总距离:&#x27;</span>, <span class="title class_">MeasureUtil</span>.<span class="title function_">formatDistance</span>(distance))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 面积测量</span></span><br><span class="line"><span class="keyword">const</span> areaPositions = [</span><br><span class="line">  [<span class="number">117.18</span>, <span class="number">31.78</span>],</span><br><span class="line">  [<span class="number">117.19</span>, <span class="number">31.78</span>],</span><br><span class="line">  [<span class="number">117.19</span>, <span class="number">31.79</span>],</span><br><span class="line">  [<span class="number">117.18</span>, <span class="number">31.79</span>],</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> area = <span class="title class_">MeasureUtil</span>.<span class="title function_">measureArea</span>(areaPositions)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;面积:&#x27;</span>, <span class="title class_">MeasureUtil</span>.<span class="title function_">formatArea</span>(area))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 可视域分析示例</span></span><br><span class="line"><span class="keyword">const</span> viewshed = <span class="keyword">new</span> <span class="title class_">ViewshedAnalysis</span>(map)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> viewshedResults = viewshed.<span class="title function_">calculateViewshed</span>(&#123;</span><br><span class="line">  <span class="attr">viewPosition</span>: [<span class="number">117.207</span>, <span class="number">31.794</span>, <span class="number">100</span>],</span><br><span class="line">  <span class="attr">targetPositions</span>: [</span><br><span class="line">    [<span class="number">117.21</span>, <span class="number">31.8</span>, <span class="number">50</span>],</span><br><span class="line">    [<span class="number">117.22</span>, <span class="number">31.79</span>, <span class="number">80</span>],</span><br><span class="line">    [<span class="number">117.2</span>, <span class="number">31.785</span>, <span class="number">60</span>],</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">maxDistance</span>: <span class="number">5000</span>,</span><br><span class="line">  <span class="attr">horizontalAngle</span>: <span class="number">60</span>,</span><br><span class="line">  <span class="attr">verticalAngle</span>: <span class="number">30</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;可视域分析结果:&#x27;</span>, viewshedResults)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 剖面分析示例</span></span><br><span class="line"><span class="keyword">const</span> profile = <span class="keyword">new</span> <span class="title class_">ProfileAnalysis</span>(map)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> profileData = profile.<span class="title function_">analyzeTerrainProfile</span>([<span class="number">117.2</span>, <span class="number">31.79</span>, <span class="number">0</span>], [<span class="number">117.22</span>, <span class="number">31.8</span>, <span class="number">0</span>], &#123;</span><br><span class="line">  <span class="attr">sampleCount</span>: <span class="number">50</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;剖面分析结果:&#x27;</span>, profileData)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 洪水分析示例</span></span><br><span class="line"><span class="keyword">const</span> flood = <span class="keyword">new</span> <span class="title class_">FloodAnalysis</span>(map)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> floodEntity = flood.<span class="title function_">createFloodAnalysis</span>(&#123;</span><br><span class="line">  <span class="attr">bounds</span>: [<span class="number">117.18</span>, <span class="number">31.78</span>, <span class="number">117.22</span>, <span class="number">31.8</span>],</span><br><span class="line">  <span class="attr">waterLevel</span>: <span class="number">50</span>,</span><br><span class="line">  <span class="attr">baseHeight</span>: <span class="number">0</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">graphicLayer.<span class="title function_">addGraphic</span>(floodEntity)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 动态调整水位</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  flood.<span class="title function_">setWaterLevel</span>(<span class="number">80</span>)</span><br><span class="line">&#125;, <span class="number">3000</span>)</span><br></pre></td></tr></table></figure><h3 id="通视分析（Line-of-Sight）"><a href="#通视分析（Line-of-Sight）" class="headerlink" title="通视分析（Line of Sight）"></a>通视分析（Line of Sight）</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通视分析：判断观察点与目标点之间是否被地形/模型遮挡</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LineOfSightAnalysis</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span> = map</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span> = map.<span class="property">viewer</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 判断通视</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Array</span>&#125; start [lng,lat,alt] 观察点</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Array</span>&#125; end [lng,lat,alt] 目标点</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; options &#123; sampleCount?: number &#125;</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> &#123;<span class="type">Object</span>&#125; &#123;<span class="type"> visible: boolean, obstructionPoint?: [lng,lat,alt] </span>&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">checkVisibility</span>(<span class="params">start, end, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> sampleCount = options.<span class="property">sampleCount</span> || <span class="number">64</span></span><br><span class="line">    <span class="keyword">const</span> startCart = mars3d.<span class="property">PointTrans</span>.<span class="title function_">lonlat2cartesian</span>(...start)</span><br><span class="line">    <span class="keyword">const</span> endCart = mars3d.<span class="property">PointTrans</span>.<span class="title function_">lonlat2cartesian</span>(...end)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 沿线均匀采样</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; sampleCount; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> t = i / sampleCount</span><br><span class="line">      <span class="keyword">const</span> interp = mars3d.<span class="property">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">lerp</span>(</span><br><span class="line">        startCart,</span><br><span class="line">        endCart,</span><br><span class="line">        t,</span><br><span class="line">        <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">Cartesian3</span>(),</span><br><span class="line">      )</span><br><span class="line">      <span class="comment">// 地形/模型拾取</span></span><br><span class="line">      <span class="keyword">const</span> pick = <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">scene</span>.<span class="title function_">pickFromRay</span>(</span><br><span class="line">        <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">Ray</span>(</span><br><span class="line">          startCart,</span><br><span class="line">          mars3d.<span class="property">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">subtract</span>(interp, startCart, <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">Cartesian3</span>()),</span><br><span class="line">        ),</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">if</span> (pick &amp;&amp; pick.<span class="property">position</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> cg = mars3d.<span class="property">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromCartesian</span>(pick.<span class="property">position</span>)</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          <span class="attr">visible</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">obstructionPoint</span>: [</span><br><span class="line">            mars3d.<span class="property">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(cg.<span class="property">longitude</span>),</span><br><span class="line">            mars3d.<span class="property">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(cg.<span class="property">latitude</span>),</span><br><span class="line">            cg.<span class="property">height</span>,</span><br><span class="line">          ],</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">visible</span>: <span class="literal">true</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> los = <span class="keyword">new</span> <span class="title class_">LineOfSightAnalysis</span>(map)</span><br><span class="line"><span class="keyword">const</span> result = los.<span class="title function_">checkVisibility</span>([<span class="number">116.4</span>, <span class="number">39.9</span>, <span class="number">80</span>], [<span class="number">116.45</span>, <span class="number">39.92</span>, <span class="number">80</span>])</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;通视结果:&#x27;</span>, result)</span><br></pre></td></tr></table></figure><h3 id="可视域分析（Viewshed）参数补充"><a href="#可视域分析（Viewshed）参数补充" class="headerlink" title="可视域分析（Viewshed）参数补充"></a>可视域分析（Viewshed）参数补充</h3><ul><li>输入参数建议：<ul><li>viewPosition: [lng, lat, alt] 观察点</li><li>targetPositions: Array&lt;[lng, lat, alt]&gt; 目标点集（或以水平&#x2F;垂直角构造扇形范围）</li><li>maxDistance: number 最大可视距离（米）</li><li>verticalAngle: number 垂直视角范围（度）</li><li>horizontalAngle: number 水平视角范围（度）</li></ul></li><li>输出结果：<ul><li>每个目标的可视&#x2F;不可视标记、原因、距离；并可生成一个扇形体或网格标注</li></ul></li></ul><p>绘制锥体时注意：</p><ul><li>使用 <code>PolylineVolume</code> 或自定义 Primitive 生成锥体边界；</li><li>大量网格时建议批量合并（Primitive 集合），避免 Entity 爆炸。</li></ul><h3 id="剖面采样与坡度-坡向（细节）"><a href="#剖面采样与坡度-坡向（细节）" class="headerlink" title="剖面采样与坡度&#x2F;坡向（细节）"></a>剖面采样与坡度&#x2F;坡向（细节）</h3><ul><li>采样策略：<ul><li>将起终点插值为 N 段（例如 256）；</li><li>使用 <code>sampleTerrainMostDetailed</code>（若使用 Cesium 原生地形采样）或 Mars3D 封装进行批量采样；</li><li>结果保存为 <code>&#123; distance, elevation, position &#125;</code> 数组。</li></ul></li><li>坡度（slope）计算：<ul><li>对相邻采样点 <code>(i,i+1)</code>，计算水平距离与高差，<code>slope% = (Δh / Δd) * 100</code>；</li><li>坡角 <code>angle = atan(slope/100)</code>（转度）。</li></ul></li><li>坡向（aspect）计算：<ul><li>对每个采样段，取水平向量方位角（基于经纬投影近似或在 ECEF 上投影后求方位角）。</li></ul></li></ul><p>示例：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 粗略坡向（方位角，度）</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">calculateAspect</span>(<span class="params">lngLatA, lngLatB</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">toRad</span> = (<span class="params">d</span>) =&gt; (d * <span class="title class_">Math</span>.<span class="property">PI</span>) / <span class="number">180</span></span><br><span class="line">  <span class="keyword">const</span> dLon = <span class="title function_">toRad</span>(lngLatB[<span class="number">0</span>] - lngLatA[<span class="number">0</span>])</span><br><span class="line">  <span class="keyword">const</span> y = <span class="title class_">Math</span>.<span class="title function_">sin</span>(dLon) * <span class="title class_">Math</span>.<span class="title function_">cos</span>(<span class="title function_">toRad</span>(lngLatB[<span class="number">1</span>]))</span><br><span class="line">  <span class="keyword">const</span> x =</span><br><span class="line">    <span class="title class_">Math</span>.<span class="title function_">cos</span>(<span class="title function_">toRad</span>(lngLatA[<span class="number">1</span>])) * <span class="title class_">Math</span>.<span class="title function_">sin</span>(<span class="title function_">toRad</span>(lngLatB[<span class="number">1</span>])) -</span><br><span class="line">    <span class="title class_">Math</span>.<span class="title function_">sin</span>(<span class="title function_">toRad</span>(lngLatA[<span class="number">1</span>])) * <span class="title class_">Math</span>.<span class="title function_">cos</span>(<span class="title function_">toRad</span>(lngLatB[<span class="number">1</span>])) * <span class="title class_">Math</span>.<span class="title function_">cos</span>(dLon)</span><br><span class="line">  <span class="keyword">let</span> brng = (<span class="title class_">Math</span>.<span class="title function_">atan2</span>(y, x) * <span class="number">180</span>) / <span class="title class_">Math</span>.<span class="property">PI</span></span><br><span class="line">  <span class="keyword">if</span> (brng &lt; <span class="number">0</span>) brng += <span class="number">360</span></span><br><span class="line">  <span class="keyword">return</span> brng <span class="comment">// 0=北,90=东,180=南,270=西</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="淹没分析（参数与单位一致性）"><a href="#淹没分析（参数与单位一致性）" class="headerlink" title="淹没分析（参数与单位一致性）"></a>淹没分析（参数与单位一致性）</h3><ul><li>建议属性：<ul><li>bounds: 多边形区域（[lng,lat] 顶点数组）</li><li>baseHeight: 地形基准高程（米）或从地形采样自动估计</li><li>waterLevel: 当前水位（米，高程基准同 baseHeight）</li><li>step: 计算步长（米），用于体积网格化估算</li></ul></li><li>体积估算：<ul><li>将区域划分网格，网格中心采样地形高程 <code>h(x,y)</code>；</li><li>若 <code>waterLevel &gt; h</code>，单元体积约 <code>Δx * Δy * (waterLevel - h)</code>；</li><li>总体积为各单元体积之和。</li></ul></li></ul><p>注意：统一所有高度的参考基准（同一椭球、同一地形数据源），避免相对&#x2F;绝对高混用。</p><h3 id="阴影-日照分析（简述）"><a href="#阴影-日照分析（简述）" class="headerlink" title="阴影&#x2F;日照分析（简述）"></a>阴影&#x2F;日照分析（简述）</h3><ul><li>启用阴影：<ul><li><code>viewer.shadows = true</code>；</li><li>配合设定 <code>light</code>（太阳）时间 <code>viewer.clock.currentTime</code> 控制日照角度。</li></ul></li><li>动态时间序列：<ul><li>在日间对多个时间采样，统计对象被照&#x2F;被遮时间比例，形成日照分析结果。</li></ul></li></ul><h3 id="小目录（分析部分）"><a href="#小目录（分析部分）" class="headerlink" title="小目录（分析部分）"></a>小目录（分析部分）</h3><ul><li>通视分析（Line of Sight）</li><li>可视域分析（Viewshed）</li><li>剖面采样与坡度&#x2F;坡向</li><li>淹没分析（体积估算）</li><li>阴影&#x2F;日照分析</li></ul><h2 id="控件系统详解"><a href="#控件系统详解" class="headerlink" title="控件系统详解"></a>控件系统详解</h2><h3 id="基础控件"><a href="#基础控件" class="headerlink" title="基础控件"></a>基础控件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 控件基类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseControl</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// position: string</span></span><br><span class="line">    <span class="comment">// 作用: 控件位置</span></span><br><span class="line">    <span class="comment">// 选项: &#x27;top-left&#x27;, &#x27;top-right&#x27;, &#x27;bottom-left&#x27;, &#x27;bottom-right&#x27;, &#x27;center&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">position</span> = options.<span class="property">position</span> || <span class="string">&#x27;top-right&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// className: string</span></span><br><span class="line">    <span class="comment">// 作用: CSS类名</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">className</span> = options.<span class="property">className</span> || <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// style: Object</span></span><br><span class="line">    <span class="comment">// 作用: 内联样式</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = options.<span class="property">style</span> || &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// visible: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否可见</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">visible</span> = options.<span class="property">visible</span> !== <span class="literal">undefined</span> ? options.<span class="property">visible</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// enabled: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否启用</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">enabled</span> = options.<span class="property">enabled</span> !== <span class="literal">undefined</span> ? options.<span class="property">enabled</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span> = <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span> = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加到地图</span></span><br><span class="line">  <span class="title function_">addTo</span>(<span class="params">map</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span> = map</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">onCreate</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">bindEvents</span>()</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 从地图移除</span></span><br><span class="line">  <span class="title function_">remove</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">domElement</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">parentNode</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">parentNode</span>.<span class="title function_">removeChild</span>(<span class="variable language_">this</span>.<span class="property">domElement</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">unbindEvents</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span> = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建DOM元素</span></span><br><span class="line">  <span class="title function_">onCreate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span> = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">className</span> = <span class="string">`mars3d-control <span class="subst">$&#123;<span class="variable language_">this</span>.className&#125;</span>`</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 应用样式</span></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>, &#123;</span><br><span class="line">      <span class="attr">position</span>: <span class="string">&#x27;absolute&#x27;</span>,</span><br><span class="line">      <span class="attr">zIndex</span>: <span class="number">1000</span>,</span><br><span class="line">      ...<span class="variable language_">this</span>.<span class="property">style</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置位置</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setPosition</span>(<span class="variable language_">this</span>.<span class="property">position</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加到地图容器</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="property">container</span>.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="property">domElement</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置位置</span></span><br><span class="line">  <span class="title function_">setPosition</span>(<span class="params">position</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">position</span> = position</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">domElement</span>) &#123;</span><br><span class="line">      <span class="comment">// 清除所有位置样式</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">top</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">right</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">bottom</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">left</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 根据位置设置样式</span></span><br><span class="line">      <span class="keyword">switch</span> (position) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;top-left&#x27;</span>:</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">top</span> = <span class="string">&#x27;10px&#x27;</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">left</span> = <span class="string">&#x27;10px&#x27;</span></span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;top-right&#x27;</span>:</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">top</span> = <span class="string">&#x27;10px&#x27;</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">right</span> = <span class="string">&#x27;10px&#x27;</span></span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;bottom-left&#x27;</span>:</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">bottom</span> = <span class="string">&#x27;10px&#x27;</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">left</span> = <span class="string">&#x27;10px&#x27;</span></span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;bottom-right&#x27;</span>:</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">bottom</span> = <span class="string">&#x27;10px&#x27;</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">right</span> = <span class="string">&#x27;10px&#x27;</span></span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;center&#x27;</span>:</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">top</span> = <span class="string">&#x27;50%&#x27;</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">left</span> = <span class="string">&#x27;50%&#x27;</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">transform</span> = <span class="string">&#x27;translate(-50%, -50%)&#x27;</span></span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 显示控件</span></span><br><span class="line">  <span class="title function_">show</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">visible</span> = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">domElement</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;block&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 隐藏控件</span></span><br><span class="line">  <span class="title function_">hide</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">visible</span> = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">domElement</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 启用控件</span></span><br><span class="line">  <span class="title function_">enable</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">enabled</span> = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">domElement</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">pointerEvents</span> = <span class="string">&#x27;auto&#x27;</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">opacity</span> = <span class="string">&#x27;1&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 禁用控件</span></span><br><span class="line">  <span class="title function_">disable</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">enabled</span> = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">domElement</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">pointerEvents</span> = <span class="string">&#x27;none&#x27;</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">opacity</span> = <span class="string">&#x27;0.5&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 绑定事件</span></span><br><span class="line">  <span class="title function_">bindEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 子类实现</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 解绑事件</span></span><br><span class="line">  <span class="title function_">unbindEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 子类实现</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 工具栏控件</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ToolbarControl</span> <span class="keyword">extends</span> <span class="title class_ inherited__">BaseControl</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(options)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// tools: Array</span></span><br><span class="line">    <span class="comment">// 作用: 工具配置数组</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tools</span> = options.<span class="property">tools</span> || []</span><br><span class="line"></span><br><span class="line">    <span class="comment">// orientation: string</span></span><br><span class="line">    <span class="comment">// 作用: 工具栏方向</span></span><br><span class="line">    <span class="comment">// 选项: &#x27;horizontal&#x27;, &#x27;vertical&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">orientation</span> = options.<span class="property">orientation</span> || <span class="string">&#x27;horizontal&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">activeToolId</span> = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onCreate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>.<span class="title function_">onCreate</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">className</span> += <span class="string">&#x27; mars3d-toolbar&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;flex&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">flexDirection</span> = <span class="variable language_">this</span>.<span class="property">orientation</span> === <span class="string">&#x27;horizontal&#x27;</span> ? <span class="string">&#x27;row&#x27;</span> : <span class="string">&#x27;column&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;rgba(42, 42, 42, 0.8)&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">borderRadius</span> = <span class="string">&#x27;4px&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">padding</span> = <span class="string">&#x27;5px&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createTools</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createTools</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tools</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">tool</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> button = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;button&#x27;</span>)</span><br><span class="line">      button.<span class="property">id</span> = tool.<span class="property">id</span></span><br><span class="line">      button.<span class="property">title</span> = tool.<span class="property">title</span> || <span class="string">&#x27;&#x27;</span></span><br><span class="line">      button.<span class="property">innerHTML</span> = tool.<span class="property">icon</span> || tool.<span class="property">text</span> || <span class="string">&#x27;&#x27;</span></span><br><span class="line">      button.<span class="property">className</span> = <span class="string">&#x27;mars3d-toolbar-button&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 按钮样式</span></span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">assign</span>(button.<span class="property">style</span>, &#123;</span><br><span class="line">        <span class="attr">width</span>: <span class="string">&#x27;32px&#x27;</span>,</span><br><span class="line">        <span class="attr">height</span>: <span class="string">&#x27;32px&#x27;</span>,</span><br><span class="line">        <span class="attr">margin</span>: <span class="string">&#x27;2px&#x27;</span>,</span><br><span class="line">        <span class="attr">border</span>: <span class="string">&#x27;none&#x27;</span>,</span><br><span class="line">        <span class="attr">borderRadius</span>: <span class="string">&#x27;3px&#x27;</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;transparent&#x27;</span>,</span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">        <span class="attr">cursor</span>: <span class="string">&#x27;pointer&#x27;</span>,</span><br><span class="line">        <span class="attr">display</span>: <span class="string">&#x27;flex&#x27;</span>,</span><br><span class="line">        <span class="attr">alignItems</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">        <span class="attr">justifyContent</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">        <span class="attr">fontSize</span>: <span class="string">&#x27;14px&#x27;</span>,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 悬停效果</span></span><br><span class="line">      button.<span class="title function_">addEventListener</span>(<span class="string">&#x27;mouseenter&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        button.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;rgba(255, 255, 255, 0.1)&#x27;</span></span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      button.<span class="title function_">addEventListener</span>(<span class="string">&#x27;mouseleave&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">activeToolId</span> !== tool.<span class="property">id</span>) &#123;</span><br><span class="line">          button.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;transparent&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 点击事件</span></span><br><span class="line">      button.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">activateTool</span>(tool.<span class="property">id</span>)</span><br><span class="line">        <span class="keyword">if</span> (tool.<span class="property">callback</span>) &#123;</span><br><span class="line">          tool.<span class="title function_">callback</span>(tool, <span class="variable language_">this</span>.<span class="property">map</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="title function_">appendChild</span>(button)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 激活工具</span></span><br><span class="line">  <span class="title function_">activateTool</span>(<span class="params">toolId</span>) &#123;</span><br><span class="line">    <span class="comment">// 重置所有按钮状态</span></span><br><span class="line">    <span class="keyword">const</span> buttons = <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.mars3d-toolbar-button&#x27;</span>)</span><br><span class="line">    buttons.<span class="title function_">forEach</span>(<span class="function">(<span class="params">btn</span>) =&gt;</span> &#123;</span><br><span class="line">      btn.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;transparent&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置当前激活工具</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">activeToolId</span> = toolId</span><br><span class="line">    <span class="keyword">const</span> activeButton = <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="title function_">querySelector</span>(<span class="string">`#<span class="subst">$&#123;toolId&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">if</span> (activeButton) &#123;</span><br><span class="line">      activeButton.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;rgba(255, 255, 255, 0.2)&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加工具</span></span><br><span class="line">  <span class="title function_">addTool</span>(<span class="params">tool</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tools</span>.<span class="title function_">push</span>(tool)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createTools</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 移除工具</span></span><br><span class="line">  <span class="title function_">removeTool</span>(<span class="params">toolId</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tools</span> = <span class="variable language_">this</span>.<span class="property">tools</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">tool</span>) =&gt;</span> tool.<span class="property">id</span> !== toolId)</span><br><span class="line">    <span class="keyword">const</span> button = <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="title function_">querySelector</span>(<span class="string">`#<span class="subst">$&#123;toolId&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">if</span> (button) &#123;</span><br><span class="line">      button.<span class="title function_">remove</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 图层控制器</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LayerControl</span> <span class="keyword">extends</span> <span class="title class_ inherited__">BaseControl</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(options)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// title: string</span></span><br><span class="line">    <span class="comment">// 作用: 控件标题</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">title</span> = options.<span class="property">title</span> || <span class="string">&#x27;图层控制&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// collapsible: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否可折叠</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">collapsible</span> = options.<span class="property">collapsible</span> !== <span class="literal">undefined</span> ? options.<span class="property">collapsible</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// collapsed: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 初始是否折叠</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">collapsed</span> = options.<span class="property">collapsed</span> !== <span class="literal">undefined</span> ? options.<span class="property">collapsed</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layers</span> = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onCreate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>.<span class="title function_">onCreate</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">className</span> += <span class="string">&#x27; mars3d-layer-control&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;rgba(0, 0, 0, 0.8)&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">borderRadius</span> = <span class="string">&#x27;4px&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">color</span> = <span class="string">&#x27;#ffffff&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">minWidth</span> = <span class="string">&#x27;200px&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">maxHeight</span> = <span class="string">&#x27;300px&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">overflow</span> = <span class="string">&#x27;hidden&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createHeader</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createContent</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">collapsed</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">collapse</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createHeader</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">headerElement</span> = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">headerElement</span>.<span class="property">className</span> = <span class="string">&#x27;layer-control-header&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">headerElement</span>.<span class="property">style</span>.<span class="property">padding</span> = <span class="string">&#x27;8px 12px&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">headerElement</span>.<span class="property">style</span>.<span class="property">borderBottom</span> = <span class="string">&#x27;1px solid rgba(255, 255, 255, 0.2)&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">headerElement</span>.<span class="property">style</span>.<span class="property">cursor</span> = <span class="variable language_">this</span>.<span class="property">collapsible</span> ? <span class="string">&#x27;pointer&#x27;</span> : <span class="string">&#x27;default&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">headerElement</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;flex&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">headerElement</span>.<span class="property">style</span>.<span class="property">justifyContent</span> = <span class="string">&#x27;space-between&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">headerElement</span>.<span class="property">style</span>.<span class="property">alignItems</span> = <span class="string">&#x27;center&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> titleElement = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;span&#x27;</span>)</span><br><span class="line">    titleElement.<span class="property">textContent</span> = <span class="variable language_">this</span>.<span class="property">title</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">headerElement</span>.<span class="title function_">appendChild</span>(titleElement)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">collapsible</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">toggleButton</span> = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;span&#x27;</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">toggleButton</span>.<span class="property">innerHTML</span> = <span class="string">&#x27;▼&#x27;</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">toggleButton</span>.<span class="property">style</span>.<span class="property">transition</span> = <span class="string">&#x27;transform 0.3s&#x27;</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">headerElement</span>.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="property">toggleButton</span>)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">headerElement</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">toggle</span>()</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="property">headerElement</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createContent</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">contentElement</span> = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">contentElement</span>.<span class="property">className</span> = <span class="string">&#x27;layer-control-content&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">contentElement</span>.<span class="property">style</span>.<span class="property">padding</span> = <span class="string">&#x27;8px&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">contentElement</span>.<span class="property">style</span>.<span class="property">maxHeight</span> = <span class="string">&#x27;250px&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">contentElement</span>.<span class="property">style</span>.<span class="property">overflowY</span> = <span class="string">&#x27;auto&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="property">contentElement</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加图层到控制器</span></span><br><span class="line">  <span class="title function_">addLayer</span>(<span class="params">layer</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layers</span>.<span class="title function_">push</span>(layer)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createLayerItem</span>(layer)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 移除图层</span></span><br><span class="line">  <span class="title function_">removeLayer</span>(<span class="params">layer</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layers</span> = <span class="variable language_">this</span>.<span class="property">layers</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">l</span>) =&gt;</span> l !== layer)</span><br><span class="line">    <span class="keyword">const</span> item = <span class="variable language_">this</span>.<span class="property">contentElement</span>.<span class="title function_">querySelector</span>(<span class="string">`[data-layer-id=&quot;<span class="subst">$&#123;layer.id&#125;</span>&quot;]`</span>)</span><br><span class="line">    <span class="keyword">if</span> (item) &#123;</span><br><span class="line">      item.<span class="title function_">remove</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建图层项</span></span><br><span class="line">  <span class="title function_">createLayerItem</span>(<span class="params">layer</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> item = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    item.<span class="property">className</span> = <span class="string">&#x27;layer-item&#x27;</span></span><br><span class="line">    item.<span class="title function_">setAttribute</span>(<span class="string">&#x27;data-layer-id&#x27;</span>, layer.<span class="property">id</span>)</span><br><span class="line">    item.<span class="property">style</span>.<span class="property">padding</span> = <span class="string">&#x27;4px 0&#x27;</span></span><br><span class="line">    item.<span class="property">style</span>.<span class="property">borderBottom</span> = <span class="string">&#x27;1px solid rgba(255, 255, 255, 0.1)&#x27;</span></span><br><span class="line">    item.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;flex&#x27;</span></span><br><span class="line">    item.<span class="property">style</span>.<span class="property">alignItems</span> = <span class="string">&#x27;center&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复选框</span></span><br><span class="line">    <span class="keyword">const</span> checkbox = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;input&#x27;</span>)</span><br><span class="line">    checkbox.<span class="property">type</span> = <span class="string">&#x27;checkbox&#x27;</span></span><br><span class="line">    checkbox.<span class="property">checked</span> = layer.<span class="property">show</span></span><br><span class="line">    checkbox.<span class="property">style</span>.<span class="property">marginRight</span> = <span class="string">&#x27;8px&#x27;</span></span><br><span class="line">    checkbox.<span class="title function_">addEventListener</span>(<span class="string">&#x27;change&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      layer.<span class="property">show</span> = checkbox.<span class="property">checked</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 图层名称</span></span><br><span class="line">    <span class="keyword">const</span> label = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;label&#x27;</span>)</span><br><span class="line">    label.<span class="property">textContent</span> = layer.<span class="property">name</span></span><br><span class="line">    label.<span class="property">style</span>.<span class="property">flex</span> = <span class="string">&#x27;1&#x27;</span></span><br><span class="line">    label.<span class="property">style</span>.<span class="property">cursor</span> = <span class="string">&#x27;pointer&#x27;</span></span><br><span class="line">    label.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      checkbox.<span class="property">checked</span> = !checkbox.<span class="property">checked</span></span><br><span class="line">      checkbox.<span class="title function_">dispatchEvent</span>(<span class="keyword">new</span> <span class="title class_">Event</span>(<span class="string">&#x27;change&#x27;</span>))</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 透明度滑块</span></span><br><span class="line">    <span class="keyword">const</span> opacitySlider = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;input&#x27;</span>)</span><br><span class="line">    opacitySlider.<span class="property">type</span> = <span class="string">&#x27;range&#x27;</span></span><br><span class="line">    opacitySlider.<span class="property">min</span> = <span class="string">&#x27;0&#x27;</span></span><br><span class="line">    opacitySlider.<span class="property">max</span> = <span class="string">&#x27;100&#x27;</span></span><br><span class="line">    opacitySlider.<span class="property">value</span> = (layer.<span class="property">alpha</span> || <span class="number">1</span>) * <span class="number">100</span></span><br><span class="line">    opacitySlider.<span class="property">style</span>.<span class="property">width</span> = <span class="string">&#x27;60px&#x27;</span></span><br><span class="line">    opacitySlider.<span class="property">style</span>.<span class="property">marginLeft</span> = <span class="string">&#x27;8px&#x27;</span></span><br><span class="line">    opacitySlider.<span class="title function_">addEventListener</span>(<span class="string">&#x27;input&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (layer.<span class="property">setOpacity</span>) &#123;</span><br><span class="line">        layer.<span class="title function_">setOpacity</span>(opacitySlider.<span class="property">value</span> / <span class="number">100</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    item.<span class="title function_">appendChild</span>(checkbox)</span><br><span class="line">    item.<span class="title function_">appendChild</span>(label)</span><br><span class="line">    item.<span class="title function_">appendChild</span>(opacitySlider)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">contentElement</span>.<span class="title function_">appendChild</span>(item)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 折叠/展开</span></span><br><span class="line">  <span class="title function_">toggle</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">collapsed</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">expand</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">collapse</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 展开</span></span><br><span class="line">  <span class="title function_">expand</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">collapsed</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">contentElement</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;block&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">toggleButton</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">toggleButton</span>.<span class="property">style</span>.<span class="property">transform</span> = <span class="string">&#x27;rotate(0deg)&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 折叠</span></span><br><span class="line">  <span class="title function_">collapse</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">collapsed</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">contentElement</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">toggleButton</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">toggleButton</span>.<span class="property">style</span>.<span class="property">transform</span> = <span class="string">&#x27;rotate(-90deg)&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 指南针控件</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CompassControl</span> <span class="keyword">extends</span> <span class="title class_ inherited__">BaseControl</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(options)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// size: number</span></span><br><span class="line">    <span class="comment">// 作用: 指南针大小</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">size</span> = options.<span class="property">size</span> || <span class="number">60</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isRotating</span> = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onCreate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>.<span class="title function_">onCreate</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">className</span> += <span class="string">&#x27; mars3d-compass&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">width</span> = <span class="variable language_">this</span>.<span class="property">size</span> + <span class="string">&#x27;px&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">height</span> = <span class="variable language_">this</span>.<span class="property">size</span> + <span class="string">&#x27;px&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">borderRadius</span> = <span class="string">&#x27;50%&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;rgba(0, 0, 0, 0.8)&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">border</span> = <span class="string">&#x27;2px solid rgba(255, 255, 255, 0.3)&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">cursor</span> = <span class="string">&#x27;pointer&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;flex&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">alignItems</span> = <span class="string">&#x27;center&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">justifyContent</span> = <span class="string">&#x27;center&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">transition</span> = <span class="string">&#x27;transform 0.3s&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建指针</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">needle</span> = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">needle</span>.<span class="property">style</span>.<span class="property">width</span> = <span class="string">&#x27;2px&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">needle</span>.<span class="property">style</span>.<span class="property">height</span> = <span class="variable language_">this</span>.<span class="property">size</span> * <span class="number">0.7</span> + <span class="string">&#x27;px&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">needle</span>.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;#ff0000&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">needle</span>.<span class="property">style</span>.<span class="property">position</span> = <span class="string">&#x27;relative&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">needle</span>.<span class="property">style</span>.<span class="property">transformOrigin</span> = <span class="string">&#x27;center bottom&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加北标识</span></span><br><span class="line">    <span class="keyword">const</span> northMark = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    northMark.<span class="property">textContent</span> = <span class="string">&#x27;N&#x27;</span></span><br><span class="line">    northMark.<span class="property">style</span>.<span class="property">position</span> = <span class="string">&#x27;absolute&#x27;</span></span><br><span class="line">    northMark.<span class="property">style</span>.<span class="property">top</span> = <span class="string">&#x27;5px&#x27;</span></span><br><span class="line">    northMark.<span class="property">style</span>.<span class="property">left</span> = <span class="string">&#x27;50%&#x27;</span></span><br><span class="line">    northMark.<span class="property">style</span>.<span class="property">transform</span> = <span class="string">&#x27;translateX(-50%)&#x27;</span></span><br><span class="line">    northMark.<span class="property">style</span>.<span class="property">color</span> = <span class="string">&#x27;#ffffff&#x27;</span></span><br><span class="line">    northMark.<span class="property">style</span>.<span class="property">fontSize</span> = <span class="string">&#x27;12px&#x27;</span></span><br><span class="line">    northMark.<span class="property">style</span>.<span class="property">fontWeight</span> = <span class="string">&#x27;bold&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="property">needle</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="title function_">appendChild</span>(northMark)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">bindEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 监听相机变化</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;cameraChanged&#x27;</span>, <span class="variable language_">this</span>.<span class="property">updateCompass</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 点击重置方向</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">resetNorth</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新指南针方向</span></span><br><span class="line">  <span class="title function_">updateCompass</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isRotating</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> heading = <span class="variable language_">this</span>.<span class="property">map</span>.<span class="property">camera</span>.<span class="property">heading</span></span><br><span class="line">    <span class="keyword">const</span> rotation = -mars3d.<span class="property">Util</span>.<span class="title function_">toDegrees</span>(heading)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">transform</span> = <span class="string">`rotate(<span class="subst">$&#123;rotation&#125;</span>deg)`</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 重置到北方</span></span><br><span class="line">  <span class="title function_">resetNorth</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isRotating</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> currentPosition = <span class="variable language_">this</span>.<span class="property">map</span>.<span class="property">camera</span>.<span class="property">position</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="property">camera</span>.<span class="title function_">flyTo</span>(&#123;</span><br><span class="line">      <span class="attr">destination</span>: currentPosition,</span><br><span class="line">      <span class="attr">orientation</span>: &#123;</span><br><span class="line">        <span class="attr">heading</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">pitch</span>: <span class="variable language_">this</span>.<span class="property">map</span>.<span class="property">camera</span>.<span class="property">pitch</span>,</span><br><span class="line">        <span class="attr">roll</span>: <span class="variable language_">this</span>.<span class="property">map</span>.<span class="property">camera</span>.<span class="property">roll</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">duration</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isRotating</span> = <span class="literal">false</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控件使用示例</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建工具栏</span></span><br><span class="line"><span class="keyword">const</span> toolbar = <span class="keyword">new</span> <span class="title class_">ToolbarControl</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="string">&#x27;top-left&#x27;</span>,</span><br><span class="line">  <span class="attr">orientation</span>: <span class="string">&#x27;horizontal&#x27;</span>,</span><br><span class="line">  <span class="attr">tools</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">id</span>: <span class="string">&#x27;measure-distance&#x27;</span>,</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&#x27;距离测量&#x27;</span>,</span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&#x27;📏&#x27;</span>,</span><br><span class="line">      <span class="attr">callback</span>: <span class="function">(<span class="params">tool, map</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;开始距离测量&#x27;</span>)</span><br><span class="line">        <span class="comment">// 启动距离测量工具</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">id</span>: <span class="string">&#x27;measure-area&#x27;</span>,</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&#x27;面积测量&#x27;</span>,</span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&#x27;📐&#x27;</span>,</span><br><span class="line">      <span class="attr">callback</span>: <span class="function">(<span class="params">tool, map</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;开始面积测量&#x27;</span>)</span><br><span class="line">        <span class="comment">// 启动面积测量工具</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">id</span>: <span class="string">&#x27;draw-point&#x27;</span>,</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&#x27;画点&#x27;</span>,</span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&#x27;📍&#x27;</span>,</span><br><span class="line">      <span class="attr">callback</span>: <span class="function">(<span class="params">tool, map</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;开始画点&#x27;</span>)</span><br><span class="line">        <span class="comment">// 启动画点工具</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">id</span>: <span class="string">&#x27;draw-line&#x27;</span>,</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&#x27;画线&#x27;</span>,</span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&#x27;📝&#x27;</span>,</span><br><span class="line">      <span class="attr">callback</span>: <span class="function">(<span class="params">tool, map</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;开始画线&#x27;</span>)</span><br><span class="line">        <span class="comment">// 启动画线工具</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">toolbar.<span class="title function_">addTo</span>(map)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建图层控制器</span></span><br><span class="line"><span class="keyword">const</span> layerControl = <span class="keyword">new</span> <span class="title class_">LayerControl</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="string">&#x27;top-right&#x27;</span>,</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&#x27;图层管理&#x27;</span>,</span><br><span class="line">  <span class="attr">collapsible</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">collapsed</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">layerControl.<span class="title function_">addTo</span>(map)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加图层到控制器</span></span><br><span class="line">map.<span class="title function_">eachLayer</span>(<span class="function">(<span class="params">layer</span>) =&gt;</span> &#123;</span><br><span class="line">  layerControl.<span class="title function_">addLayer</span>(layer)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建指南针</span></span><br><span class="line"><span class="keyword">const</span> compass = <span class="keyword">new</span> <span class="title class_">CompassControl</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="string">&#x27;bottom-right&#x27;</span>,</span><br><span class="line">  <span class="attr">size</span>: <span class="number">50</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">compass.<span class="title function_">addTo</span>(map)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 动态添加工具</span></span><br><span class="line">toolbar.<span class="title function_">addTool</span>(&#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="string">&#x27;clear-all&#x27;</span>,</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&#x27;清除所有&#x27;</span>,</span><br><span class="line">  <span class="attr">icon</span>: <span class="string">&#x27;🗑️&#x27;</span>,</span><br><span class="line">  <span class="attr">callback</span>: <span class="function">(<span class="params">tool, map</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 清除所有绘制内容</span></span><br><span class="line">    map.<span class="title function_">eachLayer</span>(<span class="function">(<span class="params">layer</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (layer.<span class="property">clear</span>) &#123;</span><br><span class="line">        layer.<span class="title function_">clear</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="绘制功能详解"><a href="#绘制功能详解" class="headerlink" title="绘制功能详解"></a>绘制功能详解</h2><h3 id="绘制工具基类"><a href="#绘制工具基类" class="headerlink" title="绘制工具基类"></a>绘制工具基类</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 绘制工具基类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DrawTool</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span> = map</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span> = map.<span class="property">viewer</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = map.<span class="property">scene</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span> = map.<span class="property">camera</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// type: string</span></span><br><span class="line">    <span class="comment">// 作用: 绘制类型</span></span><br><span class="line">    <span class="comment">// 选项: &#x27;point&#x27;, &#x27;polyline&#x27;, &#x27;polygon&#x27;, &#x27;rectangle&#x27;, &#x27;circle&#x27;, &#x27;ellipse&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">type</span> = options.<span class="property">type</span> || <span class="string">&#x27;point&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// style: Object</span></span><br><span class="line">    <span class="comment">// 作用: 绘制样式</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = options.<span class="property">style</span> || &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clampToGround: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否贴地</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clampToGround</span> = options.<span class="property">clampToGround</span> !== <span class="literal">undefined</span> ? options.<span class="property">clampToGround</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// hasMidPoint: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 是否显示中间点</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hasMidPoint</span> = options.<span class="property">hasMidPoint</span> !== <span class="literal">undefined</span> ? options.<span class="property">hasMidPoint</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// hasEdit: boolean</span></span><br><span class="line">    <span class="comment">// 作用: 绘制完成后是否可编辑</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hasEdit</span> = options.<span class="property">hasEdit</span> !== <span class="literal">undefined</span> ? options.<span class="property">hasEdit</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// addHeight: number</span></span><br><span class="line">    <span class="comment">// 作用: 增加的高度偏移</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">addHeight</span> = options.<span class="property">addHeight</span> || <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isDrawing</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawingPositions</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawingGraphic</span> = <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tempGraphics</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handler</span> = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 开始绘制</span></span><br><span class="line">  <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isDrawing</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">stop</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isDrawing</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawingPositions</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tempGraphics</span> = []</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createHandler</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">bindEvents</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 改变鼠标样式</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">canvas</span>.<span class="property">style</span>.<span class="property">cursor</span> = <span class="string">&#x27;crosshair&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 触发开始绘制事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">fire</span>(<span class="string">&#x27;drawStart&#x27;</span>, &#123; <span class="attr">type</span>: <span class="variable language_">this</span>.<span class="property">type</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 停止绘制</span></span><br><span class="line">  <span class="title function_">stop</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">isDrawing</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isDrawing</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">unbindEvents</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理临时图形</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">clearTempGraphics</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 恢复鼠标样式</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">canvas</span>.<span class="property">style</span>.<span class="property">cursor</span> = <span class="string">&#x27;default&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 触发停止绘制事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">fire</span>(<span class="string">&#x27;drawStop&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建事件处理器</span></span><br><span class="line">  <span class="title function_">createHandler</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handler</span> = <span class="keyword">new</span> mars3d.<span class="property">Cesium</span>.<span class="title class_">ScreenSpaceEventHandler</span>(<span class="variable language_">this</span>.<span class="property">viewer</span>.<span class="property">canvas</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 绑定事件</span></span><br><span class="line">  <span class="title function_">bindEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 鼠标左键点击</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handler</span>.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">click</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> position = <span class="variable language_">this</span>.<span class="title function_">getPickPosition</span>(click.<span class="property">position</span>)</span><br><span class="line">      <span class="keyword">if</span> (position) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">addPosition</span>(position)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, mars3d.<span class="property">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">LEFT_CLICK</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 鼠标移动</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handler</span>.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">movement</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">drawingPositions</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> position = <span class="variable language_">this</span>.<span class="title function_">getPickPosition</span>(movement.<span class="property">endPosition</span>)</span><br><span class="line">        <span class="keyword">if</span> (position) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">updateDrawing</span>(position)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, mars3d.<span class="property">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">MOUSE_MOVE</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 鼠标右键结束绘制</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handler</span>.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">click</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">finishDrawing</span>()</span><br><span class="line">    &#125;, mars3d.<span class="property">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">RIGHT_CLICK</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 双击结束绘制</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handler</span>.<span class="title function_">setInputAction</span>(<span class="function">(<span class="params">click</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">finishDrawing</span>()</span><br><span class="line">    &#125;, mars3d.<span class="property">Cesium</span>.<span class="property">ScreenSpaceEventType</span>.<span class="property">LEFT_DOUBLE_CLICK</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 解绑事件</span></span><br><span class="line">  <span class="title function_">unbindEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">handler</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">handler</span>.<span class="title function_">destroy</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">handler</span> = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取拾取位置</span></span><br><span class="line">  <span class="title function_">getPickPosition</span>(<span class="params">screenPosition</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> cartesian</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">clampToGround</span>) &#123;</span><br><span class="line">      <span class="comment">// 贴地模式：拾取地形</span></span><br><span class="line">      <span class="keyword">const</span> ray = <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">getPickRay</span>(screenPosition)</span><br><span class="line">      cartesian = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">globe</span>.<span class="title function_">pick</span>(ray, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 空间模式：拾取椭球面</span></span><br><span class="line">      cartesian = <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">pickEllipsoid</span>(screenPosition, <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">globe</span>.<span class="property">ellipsoid</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cartesian) &#123;</span><br><span class="line">      <span class="comment">// 转换为经纬度坐标</span></span><br><span class="line">      <span class="keyword">const</span> cartographic = mars3d.<span class="property">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromCartesian</span>(cartesian)</span><br><span class="line">      <span class="keyword">const</span> lng = mars3d.<span class="property">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(cartographic.<span class="property">longitude</span>)</span><br><span class="line">      <span class="keyword">const</span> lat = mars3d.<span class="property">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toDegrees</span>(cartographic.<span class="property">latitude</span>)</span><br><span class="line">      <span class="keyword">const</span> alt = cartographic.<span class="property">height</span> + <span class="variable language_">this</span>.<span class="property">addHeight</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> [lng, lat, alt]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加位置点</span></span><br><span class="line">  <span class="title function_">addPosition</span>(<span class="params">position</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawingPositions</span>.<span class="title function_">push</span>(position)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建或更新绘制图形</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createOrUpdateGraphic</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 触发添加点事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">fire</span>(<span class="string">&#x27;addPosition&#x27;</span>, &#123; position, <span class="attr">positions</span>: <span class="variable language_">this</span>.<span class="property">drawingPositions</span>.<span class="title function_">slice</span>() &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新绘制过程</span></span><br><span class="line">  <span class="title function_">updateDrawing</span>(<span class="params">position</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">drawingPositions</span>.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建临时位置数组</span></span><br><span class="line">    <span class="keyword">const</span> tempPositions = <span class="variable language_">this</span>.<span class="property">drawingPositions</span>.<span class="title function_">slice</span>()</span><br><span class="line">    tempPositions.<span class="title function_">push</span>(position)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新临时图形</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">updateTempGraphic</span>(tempPositions)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 完成绘制</span></span><br><span class="line">  <span class="title function_">finishDrawing</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">drawingPositions</span>.<span class="property">length</span> &lt; <span class="variable language_">this</span>.<span class="title function_">getMinPositionCount</span>()) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.type&#125;</span>绘制至少需要<span class="subst">$&#123;<span class="variable language_">this</span>.getMinPositionCount()&#125;</span>个点`</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建最终图形</span></span><br><span class="line">    <span class="keyword">const</span> graphic = <span class="variable language_">this</span>.<span class="title function_">createFinalGraphic</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理临时图形</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">clearTempGraphics</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 停止绘制</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">stop</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 触发完成绘制事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">fire</span>(<span class="string">&#x27;drawComplete&#x27;</span>, &#123;</span><br><span class="line">      graphic,</span><br><span class="line">      <span class="attr">positions</span>: <span class="variable language_">this</span>.<span class="property">drawingPositions</span>.<span class="title function_">slice</span>(),</span><br><span class="line">      <span class="attr">type</span>: <span class="variable language_">this</span>.<span class="property">type</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> graphic</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取最小位置点数量</span></span><br><span class="line">  <span class="title function_">getMinPositionCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable language_">this</span>.<span class="property">type</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;point&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;polyline&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;polygon&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;rectangle&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;circle&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;ellipse&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建或更新图形（子类实现）</span></span><br><span class="line">  <span class="title function_">createOrUpdateGraphic</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 子类实现具体逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新临时图形（子类实现）</span></span><br><span class="line">  <span class="title function_">updateTempGraphic</span>(<span class="params">positions</span>) &#123;</span><br><span class="line">    <span class="comment">// 子类实现具体逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建最终图形（子类实现）</span></span><br><span class="line">  <span class="title function_">createFinalGraphic</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 子类实现具体逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清理临时图形</span></span><br><span class="line">  <span class="title function_">clearTempGraphics</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tempGraphics</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">graphic</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (graphic.<span class="property">remove</span>) &#123;</span><br><span class="line">        graphic.<span class="title function_">remove</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tempGraphics</span> = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 事件处理</span></span><br><span class="line">  <span class="title function_">fire</span>(<span class="params">eventType, data = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">map</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">map</span>.<span class="property">fire</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">fire</span>(<span class="string">`draw<span class="subst">$&#123;eventType&#125;</span>`</span>, data)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 点绘制工具</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DrawPoint</span> <span class="keyword">extends</span> <span class="title class_ inherited__">DrawTool</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(map, &#123; ...options, <span class="attr">type</span>: <span class="string">&#x27;point&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 默认点样式</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line">        <span class="attr">pixelSize</span>: <span class="number">12</span>,</span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="string">&#x27;#000000&#x27;</span>,</span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">heightReference</span>: <span class="variable language_">this</span>.<span class="property">clampToGround</span> ? <span class="number">1</span> : <span class="number">0</span>, <span class="comment">// CLAMP_TO_GROUND : NONE</span></span><br><span class="line">        <span class="attr">disableDepthTestDistance</span>: <span class="title class_">Number</span>.<span class="property">POSITIVE_INFINITY</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">addPosition</span>(<span class="params">position</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawingPositions</span> = [position] <span class="comment">// 点只需要一个位置</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 直接完成绘制</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">finishDrawing</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createFinalGraphic</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> position = <span class="variable language_">this</span>.<span class="property">drawingPositions</span>[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> graphic = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PointEntity</span>(&#123;</span><br><span class="line">      <span class="attr">position</span>: position,</span><br><span class="line">      <span class="attr">style</span>: <span class="variable language_">this</span>.<span class="property">style</span>,</span><br><span class="line">      <span class="attr">attr</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;draw-point&#x27;</span>,</span><br><span class="line">        <span class="attr">drawType</span>: <span class="variable language_">this</span>.<span class="property">type</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> graphic</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线绘制工具</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DrawPolyline</span> <span class="keyword">extends</span> <span class="title class_ inherited__">DrawTool</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(map, &#123; ...options, <span class="attr">type</span>: <span class="string">&#x27;polyline&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 默认线样式</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line">        <span class="attr">width</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="attr">opacity</span>: <span class="number">1.0</span>,</span><br><span class="line">        <span class="attr">clampToGround</span>: <span class="variable language_">this</span>.<span class="property">clampToGround</span>,</span><br><span class="line">        <span class="attr">outline</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="string">&#x27;#000000&#x27;</span>,</span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">lineType</span>: <span class="string">&#x27;solid&#x27;</span>, <span class="comment">// solid, dash, dot, dashdot, longdash</span></span><br><span class="line">        <span class="attr">materialType</span>: <span class="string">&#x27;Color&#x27;</span>, <span class="comment">// Color, PolylineGlow, PolylineArrow, PolylineDash</span></span><br><span class="line">        <span class="attr">materialOptions</span>: &#123;&#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createOrUpdateGraphic</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">drawingPositions</span>.<span class="property">length</span> &lt; <span class="number">2</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">drawingGraphic</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingGraphic</span> = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolylineEntity</span>(&#123;</span><br><span class="line">        <span class="attr">positions</span>: <span class="variable language_">this</span>.<span class="property">drawingPositions</span>,</span><br><span class="line">        <span class="attr">style</span>: <span class="variable language_">this</span>.<span class="property">style</span>,</span><br><span class="line">        <span class="attr">attr</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;draw-polyline-temp&#x27;</span>,</span><br><span class="line">          <span class="attr">drawType</span>: <span class="variable language_">this</span>.<span class="property">type</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 添加到临时图形数组</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">tempGraphics</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="property">drawingGraphic</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingGraphic</span>.<span class="property">positions</span> = <span class="variable language_">this</span>.<span class="property">drawingPositions</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">updateTempGraphic</span>(<span class="params">positions</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (positions.<span class="property">length</span> &lt; <span class="number">2</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">drawingGraphic</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingGraphic</span>.<span class="property">positions</span> = positions</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createFinalGraphic</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> graphic = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolylineEntity</span>(&#123;</span><br><span class="line">      <span class="attr">positions</span>: <span class="variable language_">this</span>.<span class="property">drawingPositions</span>,</span><br><span class="line">      <span class="attr">style</span>: <span class="variable language_">this</span>.<span class="property">style</span>,</span><br><span class="line">      <span class="attr">attr</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;draw-polyline&#x27;</span>,</span><br><span class="line">        <span class="attr">drawType</span>: <span class="variable language_">this</span>.<span class="property">type</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果需要编辑功能</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">hasEdit</span>) &#123;</span><br><span class="line">      graphic.<span class="property">hasEdit</span> = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> graphic</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 面绘制工具</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DrawPolygon</span> <span class="keyword">extends</span> <span class="title class_ inherited__">DrawTool</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(map, &#123; ...options, <span class="attr">type</span>: <span class="string">&#x27;polygon&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 默认面样式</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line">        <span class="attr">opacity</span>: <span class="number">0.6</span>,</span><br><span class="line">        <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">outlineOpacity</span>: <span class="number">1.0</span>,</span><br><span class="line">        <span class="attr">fill</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">clampToGround</span>: <span class="variable language_">this</span>.<span class="property">clampToGround</span>,</span><br><span class="line">        <span class="attr">height</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">extrudedHeight</span>: <span class="literal">undefined</span>,</span><br><span class="line">        <span class="attr">materialType</span>: <span class="string">&#x27;Color&#x27;</span>,</span><br><span class="line">        <span class="attr">materialOptions</span>: &#123;&#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createOrUpdateGraphic</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">drawingPositions</span>.<span class="property">length</span> &lt; <span class="number">3</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">drawingGraphic</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingGraphic</span> = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolygonEntity</span>(&#123;</span><br><span class="line">        <span class="attr">positions</span>: <span class="variable language_">this</span>.<span class="property">drawingPositions</span>,</span><br><span class="line">        <span class="attr">style</span>: <span class="variable language_">this</span>.<span class="property">style</span>,</span><br><span class="line">        <span class="attr">attr</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;draw-polygon-temp&#x27;</span>,</span><br><span class="line">          <span class="attr">drawType</span>: <span class="variable language_">this</span>.<span class="property">type</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">tempGraphics</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="property">drawingGraphic</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingGraphic</span>.<span class="property">positions</span> = <span class="variable language_">this</span>.<span class="property">drawingPositions</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">updateTempGraphic</span>(<span class="params">positions</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (positions.<span class="property">length</span> &lt; <span class="number">3</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">drawingGraphic</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingGraphic</span>.<span class="property">positions</span> = positions</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createFinalGraphic</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> graphic = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolygonEntity</span>(&#123;</span><br><span class="line">      <span class="attr">positions</span>: <span class="variable language_">this</span>.<span class="property">drawingPositions</span>,</span><br><span class="line">      <span class="attr">style</span>: <span class="variable language_">this</span>.<span class="property">style</span>,</span><br><span class="line">      <span class="attr">attr</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;draw-polygon&#x27;</span>,</span><br><span class="line">        <span class="attr">drawType</span>: <span class="variable language_">this</span>.<span class="property">type</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">hasEdit</span>) &#123;</span><br><span class="line">      graphic.<span class="property">hasEdit</span> = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> graphic</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 矩形绘制工具</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DrawRectangle</span> <span class="keyword">extends</span> <span class="title class_ inherited__">DrawTool</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(map, &#123; ...options, <span class="attr">type</span>: <span class="string">&#x27;rectangle&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line">        <span class="attr">opacity</span>: <span class="number">0.6</span>,</span><br><span class="line">        <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">clampToGround</span>: <span class="variable language_">this</span>.<span class="property">clampToGround</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getMinPositionCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span> <span class="comment">// 矩形需要对角两点</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">updateTempGraphic</span>(<span class="params">positions</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (positions.<span class="property">length</span> &lt; <span class="number">2</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据两个对角点计算矩形四个顶点</span></span><br><span class="line">    <span class="keyword">const</span> rectanglePositions = <span class="variable language_">this</span>.<span class="title function_">calculateRectanglePositions</span>(</span><br><span class="line">      positions[<span class="number">0</span>],</span><br><span class="line">      positions[positions.<span class="property">length</span> - <span class="number">1</span>],</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">drawingGraphic</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingGraphic</span> = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolygonEntity</span>(&#123;</span><br><span class="line">        <span class="attr">positions</span>: rectanglePositions,</span><br><span class="line">        <span class="attr">style</span>: <span class="variable language_">this</span>.<span class="property">style</span>,</span><br><span class="line">        <span class="attr">attr</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;draw-rectangle-temp&#x27;</span>,</span><br><span class="line">          <span class="attr">drawType</span>: <span class="variable language_">this</span>.<span class="property">type</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">tempGraphics</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="property">drawingGraphic</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingGraphic</span>.<span class="property">positions</span> = rectanglePositions</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">calculateRectanglePositions</span>(<span class="params">startPos, endPos</span>) &#123;</span><br><span class="line">    <span class="comment">// 计算矩形四个顶点</span></span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">      [startPos[<span class="number">0</span>], startPos[<span class="number">1</span>], startPos[<span class="number">2</span>] || <span class="number">0</span>],</span><br><span class="line">      [endPos[<span class="number">0</span>], startPos[<span class="number">1</span>], startPos[<span class="number">2</span>] || <span class="number">0</span>],</span><br><span class="line">      [endPos[<span class="number">0</span>], endPos[<span class="number">1</span>], endPos[<span class="number">2</span>] || <span class="number">0</span>],</span><br><span class="line">      [startPos[<span class="number">0</span>], endPos[<span class="number">1</span>], startPos[<span class="number">2</span>] || <span class="number">0</span>],</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createFinalGraphic</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> rectanglePositions = <span class="variable language_">this</span>.<span class="title function_">calculateRectanglePositions</span>(</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingPositions</span>[<span class="number">0</span>],</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingPositions</span>[<span class="number">1</span>],</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> graphic = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolygonEntity</span>(&#123;</span><br><span class="line">      <span class="attr">positions</span>: rectanglePositions,</span><br><span class="line">      <span class="attr">style</span>: <span class="variable language_">this</span>.<span class="property">style</span>,</span><br><span class="line">      <span class="attr">attr</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;draw-rectangle&#x27;</span>,</span><br><span class="line">        <span class="attr">drawType</span>: <span class="variable language_">this</span>.<span class="property">type</span>,</span><br><span class="line">        <span class="attr">startPosition</span>: <span class="variable language_">this</span>.<span class="property">drawingPositions</span>[<span class="number">0</span>],</span><br><span class="line">        <span class="attr">endPosition</span>: <span class="variable language_">this</span>.<span class="property">drawingPositions</span>[<span class="number">1</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">hasEdit</span>) &#123;</span><br><span class="line">      graphic.<span class="property">hasEdit</span> = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> graphic</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 圆形绘制工具</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DrawCircle</span> <span class="keyword">extends</span> <span class="title class_ inherited__">DrawTool</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(map, &#123; ...options, <span class="attr">type</span>: <span class="string">&#x27;circle&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">style</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line">        <span class="attr">opacity</span>: <span class="number">0.6</span>,</span><br><span class="line">        <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">outlineColor</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">        <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">clampToGround</span>: <span class="variable language_">this</span>.<span class="property">clampToGround</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      options.<span class="property">style</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 圆形分段数</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">segments</span> = options.<span class="property">segments</span> || <span class="number">32</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">updateTempGraphic</span>(<span class="params">positions</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (positions.<span class="property">length</span> &lt; <span class="number">2</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算圆形位置</span></span><br><span class="line">    <span class="keyword">const</span> circlePositions = <span class="variable language_">this</span>.<span class="title function_">calculateCirclePositions</span>(</span><br><span class="line">      positions[<span class="number">0</span>],</span><br><span class="line">      positions[positions.<span class="property">length</span> - <span class="number">1</span>],</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">drawingGraphic</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingGraphic</span> = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolygonEntity</span>(&#123;</span><br><span class="line">        <span class="attr">positions</span>: circlePositions,</span><br><span class="line">        <span class="attr">style</span>: <span class="variable language_">this</span>.<span class="property">style</span>,</span><br><span class="line">        <span class="attr">attr</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;draw-circle-temp&#x27;</span>,</span><br><span class="line">          <span class="attr">drawType</span>: <span class="variable language_">this</span>.<span class="property">type</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">tempGraphics</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="property">drawingGraphic</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingGraphic</span>.<span class="property">positions</span> = circlePositions</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">calculateCirclePositions</span>(<span class="params">centerPos, edgePos</span>) &#123;</span><br><span class="line">    <span class="comment">// 计算半径</span></span><br><span class="line">    <span class="keyword">const</span> radius = mars3d.<span class="property">MeasureUtil</span>.<span class="title function_">getDistance</span>([</span><br><span class="line">      mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(centerPos),</span><br><span class="line">      mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(edgePos),</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> positions = []</span><br><span class="line">    <span class="keyword">const</span> center = mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(centerPos)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成圆形上的点</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= <span class="variable language_">this</span>.<span class="property">segments</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> angle = (i / <span class="variable language_">this</span>.<span class="property">segments</span>) * <span class="number">2</span> * <span class="title class_">Math</span>.<span class="property">PI</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 计算偏移距离（简化计算，实际应考虑地球曲率）</span></span><br><span class="line">      <span class="keyword">const</span> offsetLng =</span><br><span class="line">        (radius * <span class="title class_">Math</span>.<span class="title function_">cos</span>(angle)) / (<span class="number">111320</span> * <span class="title class_">Math</span>.<span class="title function_">cos</span>(mars3d.<span class="property">Util</span>.<span class="title function_">toRadians</span>(center.<span class="property">lat</span>)))</span><br><span class="line">      <span class="keyword">const</span> offsetLat = (radius * <span class="title class_">Math</span>.<span class="title function_">sin</span>(angle)) / <span class="number">110540</span></span><br><span class="line"></span><br><span class="line">      positions.<span class="title function_">push</span>([center.<span class="property">lng</span> + offsetLng, center.<span class="property">lat</span> + offsetLat, center.<span class="property">alt</span>])</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> positions</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createFinalGraphic</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> circlePositions = <span class="variable language_">this</span>.<span class="title function_">calculateCirclePositions</span>(</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingPositions</span>[<span class="number">0</span>],</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawingPositions</span>[<span class="number">1</span>],</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算半径</span></span><br><span class="line">    <span class="keyword">const</span> radius = mars3d.<span class="property">MeasureUtil</span>.<span class="title function_">getDistance</span>([</span><br><span class="line">      mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(<span class="variable language_">this</span>.<span class="property">drawingPositions</span>[<span class="number">0</span>]),</span><br><span class="line">      mars3d.<span class="property">LngLatPoint</span>.<span class="title function_">fromArray</span>(<span class="variable language_">this</span>.<span class="property">drawingPositions</span>[<span class="number">1</span>]),</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> graphic = <span class="keyword">new</span> mars3d.<span class="property">graphic</span>.<span class="title class_">PolygonEntity</span>(&#123;</span><br><span class="line">      <span class="attr">positions</span>: circlePositions,</span><br><span class="line">      <span class="attr">style</span>: <span class="variable language_">this</span>.<span class="property">style</span>,</span><br><span class="line">      <span class="attr">attr</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;draw-circle&#x27;</span>,</span><br><span class="line">        <span class="attr">drawType</span>: <span class="variable language_">this</span>.<span class="property">type</span>,</span><br><span class="line">        <span class="attr">center</span>: <span class="variable language_">this</span>.<span class="property">drawingPositions</span>[<span class="number">0</span>],</span><br><span class="line">        <span class="attr">radius</span>: radius,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">hasEdit</span>) &#123;</span><br><span class="line">      graphic.<span class="property">hasEdit</span> = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> graphic</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="绘制管理器"><a href="#绘制管理器" class="headerlink" title="绘制管理器"></a>绘制管理器</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 绘制管理器</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DrawManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">map, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span> = map</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span> = options</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前绘制工具</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">currentTool</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绘制结果图层</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawLayer</span> =</span><br><span class="line">      options.<span class="property">drawLayer</span> ||</span><br><span class="line">      <span class="keyword">new</span> mars3d.<span class="property">layer</span>.<span class="title class_">GraphicLayer</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;绘制图层&#x27;</span>,</span><br><span class="line">        <span class="attr">hasEdit</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果图层未添加到地图，则添加</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">drawLayer</span>.<span class="property">isAdded</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">addLayer</span>(<span class="variable language_">this</span>.<span class="property">drawLayer</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绘制历史</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawHistory</span> = []</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绑定事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">bindEvents</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 绑定事件</span></span><br><span class="line">  <span class="title function_">bindEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 监听绘制完成事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;drawComplete&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onDrawComplete</span>(event.<span class="property">graphic</span>, event.<span class="property">type</span>, event.<span class="property">positions</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听绘制开始事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;drawStart&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;开始绘制:&#x27;</span>, event.<span class="property">type</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听绘制停止事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">on</span>(<span class="string">&#x27;drawStop&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;停止绘制&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 开始绘制</span></span><br><span class="line">  <span class="title function_">startDraw</span>(<span class="params">type, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// 停止当前绘制</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">stopDraw</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建对应的绘制工具</span></span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;point&#x27;</span>:</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentTool</span> = <span class="keyword">new</span> <span class="title class_">DrawPoint</span>(<span class="variable language_">this</span>.<span class="property">map</span>, options)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;polyline&#x27;</span>:</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentTool</span> = <span class="keyword">new</span> <span class="title class_">DrawPolyline</span>(<span class="variable language_">this</span>.<span class="property">map</span>, options)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;polygon&#x27;</span>:</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentTool</span> = <span class="keyword">new</span> <span class="title class_">DrawPolygon</span>(<span class="variable language_">this</span>.<span class="property">map</span>, options)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;rectangle&#x27;</span>:</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentTool</span> = <span class="keyword">new</span> <span class="title class_">DrawRectangle</span>(<span class="variable language_">this</span>.<span class="property">map</span>, options)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;circle&#x27;</span>:</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentTool</span> = <span class="keyword">new</span> <span class="title class_">DrawCircle</span>(<span class="variable language_">this</span>.<span class="property">map</span>, options)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;不支持的绘制类型:&#x27;</span>, type)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开始绘制</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">currentTool</span>.<span class="title function_">start</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 停止绘制</span></span><br><span class="line">  <span class="title function_">stopDraw</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">currentTool</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">currentTool</span>.<span class="title function_">stop</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">currentTool</span> = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 绘制完成处理</span></span><br><span class="line">  <span class="title function_">onDrawComplete</span>(<span class="params">graphic, type, positions</span>) &#123;</span><br><span class="line">    <span class="comment">// 添加到绘制图层</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawLayer</span>.<span class="title function_">addGraphic</span>(graphic)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加到历史记录</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawHistory</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">      <span class="attr">graphic</span>: graphic,</span><br><span class="line">      <span class="attr">type</span>: type,</span><br><span class="line">      <span class="attr">positions</span>: positions,</span><br><span class="line">      <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 触发自定义事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">fire</span>(<span class="string">&#x27;drawComplete&#x27;</span>, &#123; graphic, type, positions &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`绘制完成: <span class="subst">$&#123;type&#125;</span>`</span>, graphic)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 删除指定图形</span></span><br><span class="line">  <span class="title function_">deleteGraphic</span>(<span class="params">graphic</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawLayer</span>.<span class="title function_">removeGraphic</span>(graphic)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从历史记录中移除</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawHistory</span> = <span class="variable language_">this</span>.<span class="property">drawHistory</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> item.<span class="property">graphic</span> !== graphic)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">fire</span>(<span class="string">&#x27;graphicDeleted&#x27;</span>, &#123; graphic &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清空所有绘制</span></span><br><span class="line">  <span class="title function_">clear</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawLayer</span>.<span class="title function_">clear</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawHistory</span> = []</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">fire</span>(<span class="string">&#x27;drawCleared&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 撤销上一步绘制</span></span><br><span class="line">  <span class="title function_">undo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">drawHistory</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> lastItem = <span class="variable language_">this</span>.<span class="property">drawHistory</span>.<span class="title function_">pop</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawLayer</span>.<span class="title function_">removeGraphic</span>(lastItem.<span class="property">graphic</span>)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">fire</span>(<span class="string">&#x27;drawUndo&#x27;</span>, &#123; <span class="attr">graphic</span>: lastItem.<span class="property">graphic</span> &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取绘制结果</span></span><br><span class="line">  <span class="title function_">getDrawResults</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">drawHistory</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> (&#123;</span><br><span class="line">      <span class="attr">type</span>: item.<span class="property">type</span>,</span><br><span class="line">      <span class="attr">positions</span>: item.<span class="property">positions</span>,</span><br><span class="line">      <span class="attr">graphic</span>: item.<span class="property">graphic</span>,</span><br><span class="line">      <span class="attr">timestamp</span>: item.<span class="property">timestamp</span>,</span><br><span class="line">    &#125;))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 导出为GeoJSON</span></span><br><span class="line">  <span class="title function_">exportToGeoJSON</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">drawLayer</span>.<span class="title function_">toGeoJSON</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 从GeoJSON导入</span></span><br><span class="line">  <span class="title function_">importFromGeoJSON</span>(<span class="params">geojson, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawLayer</span>.<span class="title function_">loadGeoJSON</span>(geojson, options)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置绘制样式</span></span><br><span class="line">  <span class="title function_">setDrawStyle</span>(<span class="params">type, style</span>) &#123;</span><br><span class="line">    <span class="comment">// 保存样式，用于下次绘制</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span>[<span class="string">`<span class="subst">$&#123;type&#125;</span>Style`</span>] = style</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 启用/禁用编辑</span></span><br><span class="line">  <span class="title function_">enableEdit</span>(<span class="params">enabled = <span class="literal">true</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawLayer</span>.<span class="property">hasEdit</span> = enabled</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawLayer</span>.<span class="title function_">enableEdit</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawLayer</span>.<span class="title function_">disableEdit</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 事件处理</span></span><br><span class="line">  <span class="title function_">fire</span>(<span class="params">eventType, data = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">map</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">map</span>.<span class="property">fire</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">map</span>.<span class="title function_">fire</span>(<span class="string">`drawManager<span class="subst">$&#123;eventType&#125;</span>`</span>, data)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="绘制控件"><a href="#绘制控件" class="headerlink" title="绘制控件"></a>绘制控件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 绘制控件</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DrawControl</span> <span class="keyword">extends</span> <span class="title class_ inherited__">BaseControl</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(options)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绘制管理器</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawManager</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 工具配置</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tools</span> = options.<span class="property">tools</span> || [</span><br><span class="line">      &#123; <span class="attr">type</span>: <span class="string">&#x27;point&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;点&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;📍&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">type</span>: <span class="string">&#x27;polyline&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;线&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;📝&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">type</span>: <span class="string">&#x27;polygon&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;面&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;🔲&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">type</span>: <span class="string">&#x27;rectangle&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;矩形&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;⬛&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">type</span>: <span class="string">&#x27;circle&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;圆&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;⭕&#x27;</span> &#125;,</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前激活的工具</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">activeTool</span> = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onCreate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>.<span class="title function_">onCreate</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">className</span> += <span class="string">&#x27; mars3d-draw-control&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;rgba(0, 0, 0, 0.8)&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">borderRadius</span> = <span class="string">&#x27;4px&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">padding</span> = <span class="string">&#x27;8px&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;flex&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">flexDirection</span> = <span class="string">&#x27;column&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="property">style</span>.<span class="property">gap</span> = <span class="string">&#x27;4px&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建绘制管理器</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawManager</span> = <span class="keyword">new</span> <span class="title class_">DrawManager</span>(<span class="variable language_">this</span>.<span class="property">map</span>)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createTools</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createActions</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createTools</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> toolsContainer = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    toolsContainer.<span class="property">className</span> = <span class="string">&#x27;draw-tools&#x27;</span></span><br><span class="line">    toolsContainer.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;flex&#x27;</span></span><br><span class="line">    toolsContainer.<span class="property">style</span>.<span class="property">flexDirection</span> = <span class="string">&#x27;column&#x27;</span></span><br><span class="line">    toolsContainer.<span class="property">style</span>.<span class="property">gap</span> = <span class="string">&#x27;2px&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tools</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">tool</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> button = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;button&#x27;</span>)</span><br><span class="line">      button.<span class="property">className</span> = <span class="string">&#x27;draw-tool-button&#x27;</span></span><br><span class="line">      button.<span class="title function_">setAttribute</span>(<span class="string">&#x27;data-type&#x27;</span>, tool.<span class="property">type</span>)</span><br><span class="line">      button.<span class="property">innerHTML</span> = <span class="string">`<span class="subst">$&#123;tool.icon&#125;</span> <span class="subst">$&#123;tool.name&#125;</span>`</span></span><br><span class="line">      button.<span class="property">title</span> = <span class="string">`绘制<span class="subst">$&#123;tool.name&#125;</span>`</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 按钮样式</span></span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">assign</span>(button.<span class="property">style</span>, &#123;</span><br><span class="line">        <span class="attr">padding</span>: <span class="string">&#x27;6px 12px&#x27;</span>,</span><br><span class="line">        <span class="attr">border</span>: <span class="string">&#x27;none&#x27;</span>,</span><br><span class="line">        <span class="attr">borderRadius</span>: <span class="string">&#x27;3px&#x27;</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;transparent&#x27;</span>,</span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">        <span class="attr">cursor</span>: <span class="string">&#x27;pointer&#x27;</span>,</span><br><span class="line">        <span class="attr">fontSize</span>: <span class="string">&#x27;12px&#x27;</span>,</span><br><span class="line">        <span class="attr">textAlign</span>: <span class="string">&#x27;left&#x27;</span>,</span><br><span class="line">        <span class="attr">transition</span>: <span class="string">&#x27;background-color 0.3s&#x27;</span>,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 悬停效果</span></span><br><span class="line">      button.<span class="title function_">addEventListener</span>(<span class="string">&#x27;mouseenter&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">activeTool</span> !== tool.<span class="property">type</span>) &#123;</span><br><span class="line">          button.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;rgba(255, 255, 255, 0.1)&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      button.<span class="title function_">addEventListener</span>(<span class="string">&#x27;mouseleave&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">activeTool</span> !== tool.<span class="property">type</span>) &#123;</span><br><span class="line">          button.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;transparent&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 点击事件</span></span><br><span class="line">      button.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">selectTool</span>(tool.<span class="property">type</span>, button)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      toolsContainer.<span class="title function_">appendChild</span>(button)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="title function_">appendChild</span>(toolsContainer)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createActions</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> actionsContainer = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    actionsContainer.<span class="property">className</span> = <span class="string">&#x27;draw-actions&#x27;</span></span><br><span class="line">    actionsContainer.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;flex&#x27;</span></span><br><span class="line">    actionsContainer.<span class="property">style</span>.<span class="property">flexDirection</span> = <span class="string">&#x27;column&#x27;</span></span><br><span class="line">    actionsContainer.<span class="property">style</span>.<span class="property">gap</span> = <span class="string">&#x27;2px&#x27;</span></span><br><span class="line">    actionsContainer.<span class="property">style</span>.<span class="property">borderTop</span> = <span class="string">&#x27;1px solid rgba(255, 255, 255, 0.2)&#x27;</span></span><br><span class="line">    actionsContainer.<span class="property">style</span>.<span class="property">paddingTop</span> = <span class="string">&#x27;6px&#x27;</span></span><br><span class="line">    actionsContainer.<span class="property">style</span>.<span class="property">marginTop</span> = <span class="string">&#x27;6px&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> actions = [</span><br><span class="line">      &#123; <span class="attr">id</span>: <span class="string">&#x27;stop&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;停止&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;⏹️&#x27;</span>, <span class="attr">action</span>: <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">stopDraw</span>() &#125;,</span><br><span class="line">      &#123; <span class="attr">id</span>: <span class="string">&#x27;undo&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;撤销&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;↶&#x27;</span>, <span class="attr">action</span>: <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">drawManager</span>.<span class="title function_">undo</span>() &#125;,</span><br><span class="line">      &#123; <span class="attr">id</span>: <span class="string">&#x27;clear&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;清空&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;🗑️&#x27;</span>, <span class="attr">action</span>: <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">drawManager</span>.<span class="title function_">clear</span>() &#125;,</span><br><span class="line">      &#123; <span class="attr">id</span>: <span class="string">&#x27;export&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;导出&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;📤&#x27;</span>, <span class="attr">action</span>: <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">exportData</span>() &#125;,</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    actions.<span class="title function_">forEach</span>(<span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> button = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;button&#x27;</span>)</span><br><span class="line">      button.<span class="property">className</span> = <span class="string">&#x27;draw-action-button&#x27;</span></span><br><span class="line">      button.<span class="property">innerHTML</span> = <span class="string">`<span class="subst">$&#123;action.icon&#125;</span> <span class="subst">$&#123;action.name&#125;</span>`</span></span><br><span class="line">      button.<span class="property">title</span> = action.<span class="property">name</span></span><br><span class="line"></span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">assign</span>(button.<span class="property">style</span>, &#123;</span><br><span class="line">        <span class="attr">padding</span>: <span class="string">&#x27;4px 8px&#x27;</span>,</span><br><span class="line">        <span class="attr">border</span>: <span class="string">&#x27;none&#x27;</span>,</span><br><span class="line">        <span class="attr">borderRadius</span>: <span class="string">&#x27;3px&#x27;</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;transparent&#x27;</span>,</span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">        <span class="attr">cursor</span>: <span class="string">&#x27;pointer&#x27;</span>,</span><br><span class="line">        <span class="attr">fontSize</span>: <span class="string">&#x27;11px&#x27;</span>,</span><br><span class="line">        <span class="attr">textAlign</span>: <span class="string">&#x27;left&#x27;</span>,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      button.<span class="title function_">addEventListener</span>(<span class="string">&#x27;mouseenter&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        button.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;rgba(255, 255, 255, 0.1)&#x27;</span></span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      button.<span class="title function_">addEventListener</span>(<span class="string">&#x27;mouseleave&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        button.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;transparent&#x27;</span></span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      button.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, action.<span class="property">action</span>)</span><br><span class="line"></span><br><span class="line">      actionsContainer.<span class="title function_">appendChild</span>(button)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="title function_">appendChild</span>(actionsContainer)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 选择工具</span></span><br><span class="line">  <span class="title function_">selectTool</span>(<span class="params">toolType, buttonElement</span>) &#123;</span><br><span class="line">    <span class="comment">// 重置所有按钮状态</span></span><br><span class="line">    <span class="keyword">const</span> buttons = <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.draw-tool-button&#x27;</span>)</span><br><span class="line">    buttons.<span class="title function_">forEach</span>(<span class="function">(<span class="params">btn</span>) =&gt;</span> &#123;</span><br><span class="line">      btn.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;transparent&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">activeTool</span> === toolType) &#123;</span><br><span class="line">      <span class="comment">// 如果点击的是当前激活的工具，则停止绘制</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">stopDraw</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 激活新工具</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">activeTool</span> = toolType</span><br><span class="line">      buttonElement.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;rgba(255, 255, 255, 0.2)&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 开始绘制</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">drawManager</span>.<span class="title function_">startDraw</span>(toolType, <span class="variable language_">this</span>.<span class="title function_">getToolOptions</span>(toolType))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 停止绘制</span></span><br><span class="line">  <span class="title function_">stopDraw</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">activeTool</span> = <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">drawManager</span>.<span class="title function_">stopDraw</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重置按钮状态</span></span><br><span class="line">    <span class="keyword">const</span> buttons = <span class="variable language_">this</span>.<span class="property">domElement</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.draw-tool-button&#x27;</span>)</span><br><span class="line">    buttons.<span class="title function_">forEach</span>(<span class="function">(<span class="params">btn</span>) =&gt;</span> &#123;</span><br><span class="line">      btn.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;transparent&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取工具选项</span></span><br><span class="line">  <span class="title function_">getToolOptions</span>(<span class="params">toolType</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> options = &#123;</span><br><span class="line">      <span class="attr">clampToGround</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">hasEdit</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据工具类型设置默认样式</span></span><br><span class="line">    <span class="keyword">switch</span> (toolType) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;point&#x27;</span>:</span><br><span class="line">        options.<span class="property">style</span> = &#123;</span><br><span class="line">          <span class="attr">color</span>: <span class="string">&#x27;#ff0000&#x27;</span>,</span><br><span class="line">          <span class="attr">pixelSize</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">outlineColor</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">          <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;polyline&#x27;</span>:</span><br><span class="line">        options.<span class="property">style</span> = &#123;</span><br><span class="line">          <span class="attr">color</span>: <span class="string">&#x27;#ffff00&#x27;</span>,</span><br><span class="line">          <span class="attr">width</span>: <span class="number">3</span>,</span><br><span class="line">          <span class="attr">materialType</span>: <span class="string">&#x27;Color&#x27;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;polygon&#x27;</span>:</span><br><span class="line">        options.<span class="property">style</span> = &#123;</span><br><span class="line">          <span class="attr">color</span>: <span class="string">&#x27;#00ff00&#x27;</span>,</span><br><span class="line">          <span class="attr">opacity</span>: <span class="number">0.5</span>,</span><br><span class="line">          <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">outlineColor</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">          <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;rectangle&#x27;</span>:</span><br><span class="line">        options.<span class="property">style</span> = &#123;</span><br><span class="line">          <span class="attr">color</span>: <span class="string">&#x27;#0000ff&#x27;</span>,</span><br><span class="line">          <span class="attr">opacity</span>: <span class="number">0.5</span>,</span><br><span class="line">          <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">outlineColor</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">          <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;circle&#x27;</span>:</span><br><span class="line">        options.<span class="property">style</span> = &#123;</span><br><span class="line">          <span class="attr">color</span>: <span class="string">&#x27;#ff00ff&#x27;</span>,</span><br><span class="line">          <span class="attr">opacity</span>: <span class="number">0.5</span>,</span><br><span class="line">          <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">outlineColor</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">          <span class="attr">outlineWidth</span>: <span class="number">2</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> options</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 导出数据</span></span><br><span class="line">  <span class="title function_">exportData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> geojson = <span class="variable language_">this</span>.<span class="property">drawManager</span>.<span class="title function_">exportToGeoJSON</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建下载链接</span></span><br><span class="line">    <span class="keyword">const</span> dataStr = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(geojson, <span class="literal">null</span>, <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">const</span> dataBlob = <span class="keyword">new</span> <span class="title class_">Blob</span>([dataStr], &#123; <span class="attr">type</span>: <span class="string">&#x27;application/json&#x27;</span> &#125;)</span><br><span class="line">    <span class="keyword">const</span> url = <span class="variable constant_">URL</span>.<span class="title function_">createObjectURL</span>(dataBlob)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> link = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    link.<span class="property">href</span> = url</span><br><span class="line">    link.<span class="property">download</span> = <span class="string">`draw-data-<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().getTime()&#125;</span>.geojson`</span></span><br><span class="line">    link.<span class="title function_">click</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable constant_">URL</span>.<span class="title function_">revokeObjectURL</span>(url)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绘制功能使用示例</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建绘制控件</span></span><br><span class="line"><span class="keyword">const</span> drawControl = <span class="keyword">new</span> <span class="title class_">DrawControl</span>(&#123;</span><br><span class="line">  <span class="attr">position</span>: <span class="string">&#x27;top-left&#x27;</span>,</span><br><span class="line">  <span class="attr">tools</span>: [</span><br><span class="line">    &#123; <span class="attr">type</span>: <span class="string">&#x27;point&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;标注&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;📍&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">type</span>: <span class="string">&#x27;polyline&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;路径&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;📝&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">type</span>: <span class="string">&#x27;polygon&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;区域&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;🔲&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">type</span>: <span class="string">&#x27;rectangle&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;矩形&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;⬛&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">type</span>: <span class="string">&#x27;circle&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;圆形&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;⭕&#x27;</span> &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">drawControl.<span class="title function_">addTo</span>(map)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听绘制事件</span></span><br><span class="line">map.<span class="title function_">on</span>(<span class="string">&#x27;drawManager:drawComplete&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;绘制完成:&#x27;</span>, event.<span class="property">graphic</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 可以在这里添加自定义处理逻辑</span></span><br><span class="line">  <span class="comment">// 比如保存到数据库、计算面积等</span></span><br><span class="line">  <span class="keyword">if</span> (event.<span class="property">type</span> === <span class="string">&#x27;polygon&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> area = mars3d.<span class="property">MeasureUtil</span>.<span class="title function_">measureArea</span>(event.<span class="property">positions</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;多边形面积:&#x27;</span>, mars3d.<span class="property">MeasureUtil</span>.<span class="title function_">formatArea</span>(area))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 程序化绘制示例</span></span><br><span class="line"><span class="keyword">const</span> drawManager = <span class="keyword">new</span> <span class="title class_">DrawManager</span>(map)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 直接开始绘制</span></span><br><span class="line">drawManager.<span class="title function_">startDraw</span>(<span class="string">&#x27;polygon&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&#x27;#ff0000&#x27;</span>,</span><br><span class="line">    <span class="attr">opacity</span>: <span class="number">0.6</span>,</span><br><span class="line">    <span class="attr">outline</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">outlineColor</span>: <span class="string">&#x27;#ffffff&#x27;</span>,</span><br><span class="line">    <span class="attr">outlineWidth</span>: <span class="number">3</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">clampToGround</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">hasEdit</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置绘制样式</span></span><br><span class="line">drawManager.<span class="title function_">setDrawStyle</span>(<span class="string">&#x27;polyline&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">color</span>: <span class="string">&#x27;#00ffff&#x27;</span>,</span><br><span class="line">  <span class="attr">width</span>: <span class="number">5</span>,</span><br><span class="line">  <span class="attr">materialType</span>: <span class="string">&#x27;PolylineGlow&#x27;</span>,</span><br><span class="line">  <span class="attr">materialOptions</span>: &#123;</span><br><span class="line">    <span class="attr">glowPower</span>: <span class="number">0.3</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>这个绘制功能模块提供了完整的绘制解决方案，包括：</p><ol><li><strong>绘制工具基类</strong> - 提供统一的绘制接口和事件处理</li><li><strong>具体绘制工具</strong> - 点、线、面、矩形、圆形等图形的绘制</li><li><strong>绘制管理器</strong> - 统一管理绘制过程和结果</li><li><strong>绘制控件</strong> - 提供用户界面和交互功能</li></ol><p>每个工具都支持自定义样式、贴地模式、编辑功能等特性，可以满足各种绘制需求。</p><h2 id="📚-总结"><a href="#📚-总结" class="headerlink" title="📚 总结"></a>📚 总结</h2><p>本指南涵盖了Mars3D离线开发的所有核心概念和详细属性说明，包括：</p><ul><li><strong>环境配置</strong>: 完整的离线开发环境搭建</li><li><strong>Map配置</strong>: 详细的构造参数和地图选项</li><li><strong>坐标系统</strong>: 完整的坐标转换和投影系统</li><li><strong>图层系统</strong>: 各种类型图层的详细配置</li><li><strong>矢量数据</strong>: 点、线、面等图形的完整属性</li><li><strong>三维模型</strong>: 模型加载和瓦片集的配置选项</li><li><strong>相机控制</strong>: 完整的相机操作方法</li><li><strong>事件处理</strong>: 地图和图形的事件处理机制</li><li><strong>材质系统</strong>: 各种内置和自定义材质</li><li><strong>动画系统</strong>: 轨迹动画和属性动画</li><li><strong>分析功能</strong>: 空间分析和测量工具</li><li><strong>控件系统</strong>: 各种内置控件的配置和使用</li><li><strong>绘制功能</strong>: 完整的绘制工具解决方案</li></ul><p>这份指南为离线Mars3D开发提供了完整的参考，每个属性都包含了作用说明、默认值、使用示例，帮助开发者在无网络环境下也能高效开发Mars3D应用。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Mars3D-完整离线开发指南&quot;&gt;&lt;a href=&quot;#Mars3D-完整离线开发指南&quot; class=&quot;headerlink&quot; title=&quot;Mars3D 完整离线开发指南&quot;&gt;&lt;/a&gt;Mars3D 完整离线开发指南&lt;/h1&gt;&lt;h2 id=&quot;📋-目录&quot;&gt;&lt;a hre</summary>
      
    
    
    
    
    <category term="三维GIS" scheme="https://aoayaoa.github.io/tags/%E4%B8%89%E7%BB%B4GIS/"/>
    
    <category term="mars3d" scheme="https://aoayaoa.github.io/tags/mars3d/"/>
    
    <category term="教程" scheme="https://aoayaoa.github.io/tags/%E6%95%99%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Go语言学习总结</title>
    <link href="https://aoayaoa.github.io/2025/04/25/Go%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/"/>
    <id>https://aoayaoa.github.io/2025/04/25/Go%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/</id>
    <published>2025-04-24T16:00:00.000Z</published>
    <updated>2025-05-04T13:38:00.698Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Go语言学习总结"><a href="#Go语言学习总结" class="headerlink" title="Go语言学习总结"></a>Go语言学习总结</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul><li><a href="#%E4%B8%80go%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80">一、Go语言基础</a><ul><li><a href="#1-%E5%AE%89%E8%A3%85%E4%B8%8E%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE">1. 安装与环境配置</a></li><li><a href="#2-go%E8%AF%AD%E8%A8%80%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5">2. Go语言核心概念</a><ul><li><a href="#%E5%8C%85%E4%B8%8E%E6%A8%A1%E5%9D%97">包与模块</a></li><li><a href="#%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">基本数据类型</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">数据类型使用场景</a></li><li><a href="#%E5%A4%8D%E6%95%B0%E7%B1%BB%E5%9E%8B%E8%AF%A6%E8%A7%A3">复数类型详解</a></li><li><a href="#%E5%8F%98%E9%87%8F%E4%B8%8E%E5%B8%B8%E9%87%8F">变量与常量</a></li><li><a href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6">流程控制</a></li></ul></li><li><a href="#3-%E5%87%BD%E6%95%B0%E4%B8%8E%E6%96%B9%E6%B3%95">3. 函数与方法</a></li><li><a href="#4-%E7%BB%93%E6%9E%84%E4%BD%93%E4%B8%8E%E6%8E%A5%E5%8F%A3">4. 结构体与接口</a></li><li><a href="#5-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B">5. 并发编程</a></li><li><a href="#%E9%80%9A%E9%81%93%E8%AF%A6%E8%A7%A3">6. 通道详解</a></li><li><a href="#context%E4%B8%8A%E4%B8%8B%E6%96%87">7. Context上下文</a></li></ul></li><li><a href="#%E4%BA%8C%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84%E4%B8%8E%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F">二、项目架构与设计模式</a><ul><li><a href="#1-%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84">1. 分层架构</a></li><li><a href="#2-%E4%BB%93%E5%82%A8%E6%A8%A1%E5%BC%8Frepository-pattern">2. 仓储模式</a></li><li><a href="#3-%E6%9C%8D%E5%8A%A1%E5%B1%82service-layer">3. 服务层</a></li><li><a href="#4-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86">4. 配置管理</a></li><li><a href="#5-%E4%B8%AD%E9%97%B4%E4%BB%B6%E8%AE%BE%E8%AE%A1">5. 中间件设计</a></li><li><a href="#6-%E6%97%A5%E5%BF%97%E5%B7%A5%E5%85%B7">6. 日志工具</a></li></ul></li><li><a href="#%E4%B8%89web%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91gin%E6%A1%86%E6%9E%B6">三、Web应用开发</a><ul><li><a href="#1-%E8%B7%AF%E7%94%B1%E8%AE%BE%E7%BD%AE">1. 路由设置</a></li><li><a href="#2-%E6%8E%A7%E5%88%B6%E5%99%A8%E5%AE%9E%E7%8E%B0">2. 控制器实现</a></li><li><a href="#3-%E4%B8%BB%E7%A8%8B%E5%BA%8F%E5%85%A5%E5%8F%A3">3. 主程序入口</a></li></ul></li><li><a href="#%E5%9B%9B%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B8%8E%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83">四、最佳实践与编码规范</a><ul><li><a href="#1-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">1. 错误处理</a></li><li><a href="#2-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6">2. 并发控制</a></li><li><a href="#3-%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95">3. 单元测试</a></li><li><a href="#4-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">4. 性能优化</a></li><li><a href="#5-api%E8%AE%BE%E8%AE%A1">5. API设计</a></li></ul></li><li><a href="#%E4%BA%94%E8%BF%9B%E9%98%B6%E4%B8%BB%E9%A2%98%E4%B8%8E%E6%89%A9%E5%B1%95">五、进阶主题与扩展</a><ul><li><a href="#1-%E9%83%A8%E7%BD%B2%E4%B8%8Ecicd">1. 部署与CI&#x2F;CD</a></li><li><a href="#2-%E7%9B%91%E6%8E%A7%E4%B8%8E%E6%97%A5%E5%BF%97">2. 监控与日志</a></li><li><a href="#3-%E5%AE%89%E5%85%A8%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">3. 安全最佳实践</a></li></ul></li><li><a href="#%E5%85%AD%E5%B8%B8%E8%A7%81%E9%99%B7%E9%98%B1%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">六、常见陷阱与解决方案</a><ul><li><a href="#1-%E5%88%9D%E5%AD%A6%E8%80%85%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF">1. 初学者常见错误</a></li><li><a href="#2-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%8F%90%E7%A4%BA">2. 性能优化提示</a></li><li><a href="#3-%E4%BB%A3%E7%A0%81%E9%A3%8E%E6%A0%BC%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">3. 代码风格最佳实践</a></li></ul></li><li><a href="#%E4%B8%83%E6%B3%9B%E5%9E%8B%E7%BC%96%E7%A8%8B-go-118">七、泛型编程 (Go 1.18+)</a><ul><li><a href="#1-%E6%B3%9B%E5%9E%8B%E5%87%BD%E6%95%B0">1. 泛型函数</a></li><li><a href="#2-%E6%B3%9B%E5%9E%8B%E7%B1%BB%E5%9E%8B">2. 泛型类型</a></li><li><a href="#3-%E4%BD%BF%E7%94%A8%E6%B3%9B%E5%9E%8B%E7%B1%BB%E5%9E%8B">3. 使用泛型类型</a></li><li><a href="#4-%E6%B3%9B%E5%9E%8B%E7%BA%A6%E6%9D%9F">4. 泛型约束</a></li><li><a href="#5-%E6%B3%9B%E5%9E%8B%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">5. 泛型使用场景</a></li><li><a href="#6-%E6%B3%9B%E5%9E%8B%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">6. 泛型最佳实践</a></li></ul></li><li><a href="#%E5%85%AB%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E7%82%B9%E5%9B%9E%E9%A1%BE">八、核心知识点回顾</a></li></ul><hr><h2 id="一、Go语言基础"><a href="#一、Go语言基础" class="headerlink" title="一、Go语言基础"></a>一、Go语言基础</h2><h3 id="1-安装与环境配置"><a href="#1-安装与环境配置" class="headerlink" title="1. 安装与环境配置"></a>1. 安装与环境配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载安装Go</span></span><br><span class="line">brew install go  <span class="comment"># macOS</span></span><br><span class="line"><span class="comment"># 或 apt-get install golang-go  # Ubuntu</span></span><br><span class="line"><span class="comment"># 或从 https://golang.org/dl/ 下载安装包</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置环境变量</span></span><br><span class="line"><span class="built_in">export</span> GOROOT=/usr/local/go  <span class="comment"># Go安装路径</span></span><br><span class="line"><span class="built_in">export</span> GOPATH=<span class="variable">$HOME</span>/go       <span class="comment"># Go工作区</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$GOROOT</span>/bin:<span class="variable">$GOPATH</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证安装</span></span><br><span class="line">go version</span><br></pre></td></tr></table></figure><h3 id="2-Go语言核心概念"><a href="#2-Go语言核心概念" class="headerlink" title="2. Go语言核心概念"></a>2. Go语言核心概念</h3><h4 id="包与模块"><a href="#包与模块" class="headerlink" title="包与模块"></a>包与模块</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明包</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导入包</span></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span>  <span class="comment">// 第三方包</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化模块</span></span><br><span class="line"><span class="comment">// go mod init go-app</span></span><br></pre></td></tr></table></figure><h4 id="基本数据类型"><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基本类型</span></span><br><span class="line"><span class="keyword">var</span> i <span class="type">int</span> = <span class="number">10</span>            <span class="comment">// 整数</span></span><br><span class="line"><span class="keyword">var</span> f <span class="type">float64</span> = <span class="number">3.14</span>      <span class="comment">// 浮点数</span></span><br><span class="line"><span class="keyword">var</span> b <span class="type">bool</span> = <span class="literal">true</span>         <span class="comment">// 布尔值</span></span><br><span class="line"><span class="keyword">var</span> s <span class="type">string</span> = <span class="string">&quot;hello&quot;</span>    <span class="comment">// 字符串</span></span><br><span class="line"><span class="keyword">var</span> r <span class="type">rune</span> = <span class="string">&#x27;你&#x27;</span>         <span class="comment">// Unicode字符</span></span><br><span class="line"><span class="keyword">var</span> by <span class="type">byte</span> = <span class="string">&#x27;A&#x27;</span>         <span class="comment">// ASCII字符</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 复合类型</span></span><br><span class="line"><span class="keyword">var</span> arr [<span class="number">5</span>]<span class="type">int</span>                   <span class="comment">// 数组</span></span><br><span class="line"><span class="keyword">var</span> slice = []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;       <span class="comment">// 切片</span></span><br><span class="line"><span class="keyword">var</span> m = <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>&#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;   <span class="comment">// 映射</span></span><br><span class="line"><span class="keyword">var</span> p *<span class="type">int</span>                       <span class="comment">// 指针</span></span><br></pre></td></tr></table></figure><h4 id="数据类型使用场景"><a href="#数据类型使用场景" class="headerlink" title="数据类型使用场景"></a>数据类型使用场景</h4><p><strong>数值类型</strong>：</p><ul><li><p><code>int</code>&#x2F;<code>int8</code>&#x2F;<code>int16</code>&#x2F;<code>int32</code>&#x2F;<code>int64</code>：用于表示整数值</p><ul><li>使用场景：循环计数器、数组索引、ID、年龄等</li><li>选择建议：通常使用<code>int</code>，Go会根据平台选择合适的位数(32位或64位)</li></ul></li><li><p><code>uint</code>&#x2F;<code>uint8</code>&#x2F;<code>uint16</code>&#x2F;<code>uint32</code>&#x2F;<code>uint64</code>：无符号整数</p><ul><li>使用场景：文件大小、内存大小、位操作等必须为非负数的场合</li><li><code>uint8</code>等同于<code>byte</code>，常用于处理二进制数据</li></ul></li><li><p><code>float32</code>&#x2F;<code>float64</code>：浮点数</p><ul><li>使用场景：科学计算、金融计算(注意精度问题)、坐标值等</li><li>选择建议：通常优先使用<code>float64</code>以获得更高精度</li></ul></li><li><p><code>complex64</code>&#x2F;<code>complex128</code>：复数</p><ul><li>使用场景：科学计算、信号处理、电气工程计算</li></ul></li></ul><p><strong>字符相关类型</strong>：</p><ul><li><p><code>string</code>：字符串</p><ul><li>使用场景：文本处理、用户输入、配置信息等</li><li>特点：不可变，UTF-8编码，可使用+连接或strings.Builder构建</li></ul></li><li><p><code>rune</code>：等同于<code>int32</code>，表示一个Unicode码点</p><ul><li>使用场景：处理国际化文本、需要遍历Unicode字符的场景</li><li>示例：<code>for _, r := range &quot;你好世界&quot; &#123; fmt.Printf(&quot;%c&quot;, r) &#125;</code></li></ul></li><li><p><code>byte</code>：等同于<code>uint8</code>，表示一个ASCII字符或二进制数据的一个字节</p><ul><li>使用场景：文件I&#x2F;O、网络传输、加密解密、图像处理等</li></ul></li></ul><p><strong>布尔类型</strong>：</p><ul><li><code>bool</code>：true或false<ul><li>使用场景：条件判断、标志位、状态表示</li><li>注意：Go中不允许将整数隐式转换为布尔值</li></ul></li></ul><p><strong>复合类型</strong>：</p><ul><li><p>数组<code>[n]T</code>：固定长度的元素序列</p><ul><li>使用场景：知道元素个数且不会变化的集合</li><li>注意：作为函数参数时会复制整个数组，通常使用切片代替</li></ul></li><li><p>切片<code>[]T</code>：动态数组</p><ul><li>使用场景：大多数需要序列的场合，如函数返回多个同类结果</li><li>特点：可动态增长，底层引用数组，传递时是引用传递</li></ul></li><li><p>映射<code>map[K]V</code>：键值对集合</p><ul><li>使用场景：需要通过键快速查找值，配置设置，缓存</li><li>特点：无序，键必须可比较（不能用切片作键）</li></ul></li><li><p>指针<code>*T</code>：指向变量的内存地址</p><ul><li>使用场景：需要修改函数外的变量，避免大对象复制</li><li>示例：<code>func updateValue(ptr *int) &#123; *ptr = 100 &#125;</code></li></ul></li><li><p>结构体<code>struct</code>：自定义复合类型</p><ul><li>使用场景：表示实体对象、数据模型、请求&#x2F;响应结构</li><li>示例：<code>type User struct &#123; Name string; Age int &#125;</code></li></ul></li><li><p>接口<code>interface</code>：方法集合</p><ul><li>使用场景：实现多态、依赖注入、抽象行为</li><li>零值：<code>nil</code>，代表没有具体类型实现</li></ul></li><li><p>通道<code>chan</code>：goroutine间通信的管道</p><ul><li>使用场景：并发编程，数据流控制，同步多个goroutine</li><li>示例：<code>ch := make(chan int, 10) // 有缓冲通道</code></li></ul></li><li><p>函数类型<code>func</code>：函数作为值传递</p><ul><li>使用场景：回调函数、策略模式实现、事件处理</li><li>示例：<code>var handler func(w http.ResponseWriter, r *http.Request)</code></li></ul></li></ul><p><strong>特殊类型</strong>：</p><ul><li><p><code>error</code>：错误接口</p><ul><li>使用场景：错误处理和传播</li><li>惯例：函数最后一个返回值通常是error</li></ul></li><li><p><code>nil</code>：零值</p><ul><li>适用类型：指针、切片、映射、通道、函数和接口</li></ul></li></ul><h4 id="变量与常量"><a href="#变量与常量" class="headerlink" title="变量与常量"></a>变量与常量</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 变量声明</span></span><br><span class="line"><span class="keyword">var</span> name <span class="type">string</span>     <span class="comment">// 声明变量</span></span><br><span class="line">name = <span class="string">&quot;Go&quot;</span>         <span class="comment">// 赋值</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> name = <span class="string">&quot;Go&quot;</span>     <span class="comment">// 声明并初始化（类型推断）</span></span><br><span class="line">name := <span class="string">&quot;Go&quot;</span>        <span class="comment">// 短变量声明（函数内部使用）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 常量声明</span></span><br><span class="line"><span class="keyword">const</span> Pi = <span class="number">3.14159</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    StatusOK = <span class="number">200</span></span><br><span class="line">    StatusNotFound = <span class="number">404</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><h4 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 条件语句</span></span><br><span class="line"><span class="keyword">if</span> x &gt; <span class="number">10</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> x &gt; <span class="number">5</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// switch语句</span></span><br><span class="line"><span class="keyword">switch</span> status &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="number">200</span>:</span><br><span class="line">    fmt.Println(<span class="string">&quot;OK&quot;</span>)</span><br><span class="line"><span class="keyword">case</span> <span class="number">404</span>:</span><br><span class="line">    fmt.Println(<span class="string">&quot;Not Found&quot;</span>)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">    fmt.Println(<span class="string">&quot;Unknown&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 循环</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">    <span class="comment">// 传统for循环</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i &lt; <span class="number">10</span> &#123;</span><br><span class="line">    <span class="comment">// while风格循环</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">    <span class="comment">// 无限循环</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 范围循环</span></span><br><span class="line"><span class="keyword">for</span> i, v := <span class="keyword">range</span> slice &#123;</span><br><span class="line">    <span class="comment">// 遍历切片</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v := <span class="keyword">range</span> m &#123;</span><br><span class="line">    <span class="comment">// 遍历映射</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-函数与方法"><a href="#3-函数与方法" class="headerlink" title="3. 函数与方法"></a>3. 函数与方法</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 函数定义</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(a, b <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多返回值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">divide</span><span class="params">(a, b <span class="type">float64</span>)</span></span> (<span class="type">float64</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, fmt.Errorf(<span class="string">&quot;除数不能为0&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> a / b, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法（带接收者的函数）</span></span><br><span class="line"><span class="keyword">type</span> Rectangle <span class="keyword">struct</span> &#123;</span><br><span class="line">    Width, Height <span class="type">float64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 值接收者</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r Rectangle)</span></span> Area() <span class="type">float64</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> r.Width * r.Height</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 指针接收者（可修改接收者）</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Rectangle)</span></span> Scale(factor <span class="type">float64</span>) &#123;</span><br><span class="line">    r.Width *= factor</span><br><span class="line">    r.Height *= factor</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-结构体与接口"><a href="#4-结构体与接口" class="headerlink" title="4. 结构体与接口"></a>4. 结构体与接口</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 结构体定义</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID        <span class="type">uint</span>      <span class="string">`json:&quot;id&quot;`</span></span><br><span class="line">    Username  <span class="type">string</span>    <span class="string">`json:&quot;username&quot;`</span></span><br><span class="line">    Email     <span class="type">string</span>    <span class="string">`json:&quot;email&quot;`</span></span><br><span class="line">    Password  <span class="type">string</span>    <span class="string">`json:&quot;-&quot;`</span> <span class="comment">// 不输出到JSON</span></span><br><span class="line">    CreatedAt time.Time <span class="string">`json:&quot;created_at&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建实例</span></span><br><span class="line">user := User&#123;</span><br><span class="line">    Username: <span class="string">&quot;zhang&quot;</span>,</span><br><span class="line">    Email:    <span class="string">&quot;zhang@example.com&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接口定义</span></span><br><span class="line"><span class="keyword">type</span> UserRepository <span class="keyword">interface</span> &#123;</span><br><span class="line">    FindByID(id <span class="type">uint</span>) (*User, <span class="type">error</span>)</span><br><span class="line">    Create(user *User) <span class="type">error</span></span><br><span class="line">    Update(user *User) <span class="type">error</span></span><br><span class="line">    Delete(id <span class="type">uint</span>) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现接口（隐式实现）</span></span><br><span class="line"><span class="keyword">type</span> MongoUserRepository <span class="keyword">struct</span> &#123;</span><br><span class="line">    db *mongodb.Database</span><br><span class="line">    collection *mongodb.Collection</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *MongoUserRepository)</span></span> FindByID(id <span class="type">uint</span>) (*User, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 实现代码...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-并发编程"><a href="#5-并发编程" class="headerlink" title="5. 并发编程"></a>5. 并发编程</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Goroutine</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 在新的goroutine中执行</span></span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通道</span></span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)      <span class="comment">// 无缓冲通道</span></span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">10</span>)  <span class="comment">// 带缓冲通道</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送和接收</span></span><br><span class="line">ch &lt;- <span class="number">42</span>        <span class="comment">// 发送数据</span></span><br><span class="line">value := &lt;-ch   <span class="comment">// 接收数据</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Select语句</span></span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> msg := &lt;-ch1:</span><br><span class="line">    <span class="comment">// 处理ch1接收的消息</span></span><br><span class="line"><span class="keyword">case</span> ch2 &lt;- <span class="number">42</span>:</span><br><span class="line">    <span class="comment">// 向ch2发送数据成功</span></span><br><span class="line"><span class="keyword">case</span> &lt;-time.After(time.Second):</span><br><span class="line">    <span class="comment">// 超时处理</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">    <span class="comment">// 非阻塞操作</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 同步工具</span></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"><span class="keyword">var</span> mu sync.Mutex</span><br></pre></td></tr></table></figure><h4 id="复数类型详解"><a href="#复数类型详解" class="headerlink" title="复数类型详解"></a>复数类型详解</h4><p>复数在Go中有两种类型：<code>complex64</code>和<code>complex128</code>，分别由float32和float64的实部和虚部组成。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明复数</span></span><br><span class="line"><span class="keyword">var</span> c1 <span class="type">complex64</span> = <span class="number">1</span> + <span class="number">2i</span>      <span class="comment">// complex64类型</span></span><br><span class="line"><span class="keyword">var</span> c2 <span class="type">complex128</span> = <span class="number">3.14</span> + <span class="number">5.6i</span> <span class="comment">// complex128类型</span></span><br><span class="line">c3 := <span class="built_in">complex</span>(<span class="number">1.0</span>, <span class="number">2.0</span>)        <span class="comment">// 使用complex函数创建</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取实部和虚部</span></span><br><span class="line">realPart := <span class="built_in">real</span>(c1)  <span class="comment">// 获取实部：1.0</span></span><br><span class="line">imagPart := <span class="built_in">imag</span>(c1)  <span class="comment">// 获取虚部：2.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 复数运算</span></span><br><span class="line">sum := c1 + <span class="type">complex64</span>(c2)  <span class="comment">// 复数加法</span></span><br><span class="line">product := c1 * <span class="type">complex64</span>(c2)  <span class="comment">// 复数乘法</span></span><br><span class="line">conjugate := <span class="built_in">complex</span>(<span class="built_in">real</span>(c1), -<span class="built_in">imag</span>(c1))  <span class="comment">// 复数共轭</span></span><br></pre></td></tr></table></figure><p><strong>复数使用场景</strong>:</p><ul><li>傅里叶变换和频谱分析</li><li>信号处理</li><li>电气和电子工程计算</li><li>平面几何和向量计算</li><li>量子计算模拟</li></ul><p><strong>复数标准库</strong>:<br>Go提供了<code>math/cmplx</code>包用于复数计算:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;math/cmplx&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算复数的绝对值</span></span><br><span class="line">abs := cmplx.Abs(<span class="number">2</span> + <span class="number">3i</span>)  <span class="comment">// 结果: 3.605551275463989</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算复数的相位角</span></span><br><span class="line">phase := cmplx.Phase(<span class="number">2</span> + <span class="number">2i</span>)  <span class="comment">// 结果: 0.7853981633974483 (π/4)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 其他函数</span></span><br><span class="line">sqrt := cmplx.Sqrt(<span class="number">-1</span>)  <span class="comment">// 复数平方根: 0+1i</span></span><br><span class="line">exp := cmplx.Exp(<span class="number">1i</span> * math.Pi)  <span class="comment">// 欧拉公式: -1+0i</span></span><br></pre></td></tr></table></figure><h3 id="通道详解"><a href="#通道详解" class="headerlink" title="通道详解"></a>通道详解</h3><p>通道(Channel)是Go语言的一个核心特性，用于goroutine之间的通信和同步。</p><h4 id="通道基础"><a href="#通道基础" class="headerlink" title="通道基础"></a>通道基础</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建通道</span></span><br><span class="line">unbuffered := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)        <span class="comment">// 无缓冲通道</span></span><br><span class="line">buffered := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>, <span class="number">10</span>)   <span class="comment">// 有缓冲通道，容量为10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送数据到通道 (会阻塞直到有人接收)</span></span><br><span class="line">unbuffered &lt;- <span class="number">42</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 从通道接收数据 (会阻塞直到有数据可接收)</span></span><br><span class="line">value := &lt;-unbuffered</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭通道 (通常由发送方完成)</span></span><br><span class="line"><span class="built_in">close</span>(buffered)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查通道是否关闭</span></span><br><span class="line">val, ok := &lt;-buffered  <span class="comment">// ok为false表示通道已关闭</span></span><br></pre></td></tr></table></figure><h4 id="通道类型与方向"><a href="#通道类型与方向" class="headerlink" title="通道类型与方向"></a>通道类型与方向</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 双向通道 (可发送也可接收)</span></span><br><span class="line"><span class="keyword">chan</span> T</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只读通道 (只能接收)</span></span><br><span class="line">&lt;-<span class="keyword">chan</span> T</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只写通道 (只能发送)</span></span><br><span class="line"><span class="keyword">chan</span>&lt;- T</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类型转换示例</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(in &lt;-<span class="keyword">chan</span> <span class="type">int</span>, out <span class="keyword">chan</span>&lt;- <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// worker只能从in接收数据，向out发送数据</span></span><br><span class="line">    val := &lt;-in</span><br><span class="line">    out &lt;- val * <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="缓冲与非缓冲通道"><a href="#缓冲与非缓冲通道" class="headerlink" title="缓冲与非缓冲通道"></a>缓冲与非缓冲通道</h4><p><strong>无缓冲通道</strong>:</p><ul><li>发送操作会阻塞，直到有接收方准备好接收</li><li>接收操作会阻塞，直到有发送方发送数据</li><li>提供了同步保证 - 发送方知道接收方已经接收了数据</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)  <span class="comment">// 无缓冲通道</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 这会导致死锁，因为没有goroutine能接收</span></span><br><span class="line">ch &lt;- <span class="number">1</span>  <span class="comment">// 阻塞在这里</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确使用需要另一个goroutine接收</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(&lt;-ch)  <span class="comment">// 接收数据</span></span><br><span class="line">&#125;()</span><br><span class="line">ch &lt;- <span class="number">1</span>  <span class="comment">// 发送数据后继续执行</span></span><br></pre></td></tr></table></figure><p><strong>有缓冲通道</strong>:</p><ul><li>发送操作只在缓冲区满时阻塞</li><li>接收操作只在缓冲区空时阻塞</li><li>可以用于解耦生产者和消费者</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">3</span>)  <span class="comment">// 容量为3的缓冲通道</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 不会阻塞，因为通道有足够缓冲空间</span></span><br><span class="line">ch &lt;- <span class="number">1</span></span><br><span class="line">ch &lt;- <span class="number">2</span></span><br><span class="line">ch &lt;- <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 第四个发送会阻塞，直到有空间</span></span><br><span class="line"><span class="comment">// ch &lt;- 4  // 如果没有人接收，这里会导致死锁</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收值并释放缓冲空间</span></span><br><span class="line">fmt.Println(&lt;-ch)  <span class="comment">// 输出: 1</span></span><br><span class="line">fmt.Println(&lt;-ch)  <span class="comment">// 输出: 2</span></span><br></pre></td></tr></table></figure><h4 id="Select语句详解"><a href="#Select语句详解" class="headerlink" title="Select语句详解"></a>Select语句详解</h4><p><code>select</code>语句是Go中用于多通道操作的关键结构:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> v1 := &lt;-ch1:</span><br><span class="line">    <span class="comment">// 从ch1接收到数据</span></span><br><span class="line"><span class="keyword">case</span> ch2 &lt;- v2:</span><br><span class="line">    <span class="comment">// 成功向ch2发送数据</span></span><br><span class="line"><span class="keyword">case</span> &lt;-time.After(<span class="number">1</span> * time.Second):</span><br><span class="line">    <span class="comment">// 超时处理</span></span><br><span class="line"><span class="keyword">case</span> &lt;-done:</span><br><span class="line">    <span class="comment">// 完成信号，通常用于取消</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">    <span class="comment">// 如果所有通道都阻塞，执行这里(非阻塞操作)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>select特性</strong>:</p><ul><li>如果多个case同时就绪，随机选择一个执行</li><li>没有case就绪且无default时，select会阻塞</li><li>default使select变成非阻塞操作</li></ul><h4 id="通道的常见使用模式"><a href="#通道的常见使用模式" class="headerlink" title="通道的常见使用模式"></a>通道的常见使用模式</h4><p><strong>工作池模式</strong>:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(id <span class="type">int</span>, jobs &lt;-<span class="keyword">chan</span> <span class="type">int</span>, results <span class="keyword">chan</span>&lt;- <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> j := <span class="keyword">range</span> jobs &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;worker %d processing job %d\n&quot;</span>, id, j)</span><br><span class="line">        results &lt;- j * <span class="number">2</span>  <span class="comment">// 执行工作并发送结果</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    jobs := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">100</span>)</span><br><span class="line">    results := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动3个worker</span></span><br><span class="line">    <span class="keyword">for</span> w := <span class="number">1</span>; w &lt;= <span class="number">3</span>; w++ &#123;</span><br><span class="line">        <span class="keyword">go</span> worker(w, jobs, results)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送工作</span></span><br><span class="line">    <span class="keyword">for</span> j := <span class="number">1</span>; j &lt;= <span class="number">9</span>; j++ &#123;</span><br><span class="line">        jobs &lt;- j</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(jobs)  <span class="comment">// 关闭通道表示没有更多工作</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 收集结果</span></span><br><span class="line">    <span class="keyword">for</span> a := <span class="number">1</span>; a &lt;= <span class="number">9</span>; a++ &#123;</span><br><span class="line">        &lt;-results</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>超时控制</strong>:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> res := &lt;-c:</span><br><span class="line">    fmt.Println(<span class="string">&quot;接收到结果:&quot;</span>, res)</span><br><span class="line"><span class="keyword">case</span> &lt;-time.After(<span class="number">1</span> * time.Second):</span><br><span class="line">    fmt.Println(<span class="string">&quot;操作超时&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>取消和终止</strong>:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">            <span class="comment">// 接收到取消信号</span></span><br><span class="line">            fmt.Println(<span class="string">&quot;工作取消&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// 继续工作</span></span><br><span class="line">            fmt.Println(<span class="string">&quot;工作中...&quot;</span>)</span><br><span class="line">            time.Sleep(<span class="number">100</span> * time.Millisecond)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ctx, cancel := context.WithTimeout(context.Background(), <span class="number">1</span>*time.Second)</span><br><span class="line">    <span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> worker(ctx)</span><br><span class="line">    time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>限速器</strong>:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个限制每秒处理5个请求的限速器</span></span><br><span class="line">limiter := time.Tick(<span class="number">200</span> * time.Millisecond)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理请求</span></span><br><span class="line"><span class="keyword">for</span> req := <span class="keyword">range</span> requests &#123;</span><br><span class="line">    &lt;-limiter  <span class="comment">// 等待下一个令牌</span></span><br><span class="line">    <span class="keyword">go</span> process(req)  <span class="comment">// 处理请求</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="通道常见陷阱与解决方案"><a href="#通道常见陷阱与解决方案" class="headerlink" title="通道常见陷阱与解决方案"></a>通道常见陷阱与解决方案</h4><ol><li><p><strong>从关闭的通道接收数据</strong>:</p><ul><li>从已关闭的通道接收会立即返回通道元素类型的零值</li><li>应使用<code>val, ok := &lt;-ch</code>形式检查通道状态</li></ul></li><li><p><strong>向关闭的通道发送数据</strong>:</p><ul><li>会导致panic</li><li>确保只有发送方关闭通道，接收方不应关闭</li></ul></li><li><p><strong>重复关闭通道</strong>:</p><ul><li>会导致panic</li><li>使用<code>sync.Once</code>确保只关闭一次，或使用专门的终止通道</li></ul></li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用sync.Once安全关闭通道</span></span><br><span class="line"><span class="keyword">var</span> once sync.Once</span><br><span class="line"><span class="built_in">close</span> := <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">close</span>(ch)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="5"><li><strong>泄漏的goroutine</strong>:<ul><li>当goroutine在通道上永久阻塞时发生</li><li>总是确保有终止条件，或使用context包管理生命周期</li></ul></li></ol><h3 id="7-Context上下文"><a href="#7-Context上下文" class="headerlink" title="7. Context上下文"></a>7. Context上下文</h3><p>Context是Go语言中用于跨API边界和进程间传递截止时间、取消信号和其他请求范围值的标准方式。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建Context</span></span><br><span class="line">ctx := context.Background()  <span class="comment">// 空Context，不会被取消</span></span><br><span class="line">ctx := context.TODO()        <span class="comment">// 临时Context，表示不确定使用哪种Context</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建带有截止时间的Context</span></span><br><span class="line">deadline := time.Now().Add(<span class="number">5</span> * time.Second)</span><br><span class="line">ctx, cancel := context.WithDeadline(parentCtx, deadline)</span><br><span class="line"><span class="keyword">defer</span> cancel()  <span class="comment">// 即使截止时间到了，也最好调用cancel</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建带有超时的Context</span></span><br><span class="line">ctx, cancel := context.WithTimeout(parentCtx, <span class="number">5</span> * time.Second)</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建可取消的Context</span></span><br><span class="line">ctx, cancel := context.WithCancel(parentCtx)</span><br><span class="line"><span class="comment">// 在某个条件下取消</span></span><br><span class="line"><span class="keyword">if</span> shouldCancel &#123;</span><br><span class="line">    cancel()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建带值的Context</span></span><br><span class="line">ctx = context.WithValue(parentCtx, <span class="string">&quot;userID&quot;</span>, <span class="string">&quot;12345&quot;</span>)</span><br><span class="line"><span class="comment">// 获取Context中的值</span></span><br><span class="line"><span class="keyword">if</span> userID, ok := ctx.Value(<span class="string">&quot;userID&quot;</span>).(<span class="type">string</span>); ok &#123;</span><br><span class="line">    <span class="comment">// 使用userID</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Context使用规则</strong>:</p><ol><li>不要将Context存储在结构体中，而是显式传递给每个需要它的函数</li><li>不要传递nil Context，如果不确定使用哪个Context，使用context.TODO()</li><li>Context应该是第一个参数，通常命名为ctx</li><li>不要对同一个Context多次调用cancel函数</li><li>Context值应该是请求范围的数据，不要用于传递可选参数</li></ol><p><strong>实际应用示例</strong>:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleRequest</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 从请求创建Context</span></span><br><span class="line">    ctx := r.Context()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加超时</span></span><br><span class="line">    ctx, cancel := context.WithTimeout(ctx, <span class="number">2</span>*time.Second)</span><br><span class="line">    <span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用需要Context的函数</span></span><br><span class="line">    result, err := doSomethingSlowly(ctx)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        http.Error(w, err.Error(), http.StatusInternalServerError)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回结果</span></span><br><span class="line">    fmt.Fprintf(w, <span class="string">&quot;Result: %s&quot;</span>, result)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doSomethingSlowly</span><span class="params">(ctx context.Context)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 创建结果通道</span></span><br><span class="line">    resultCh := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在goroutine中执行耗时操作</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// 模拟耗时操作</span></span><br><span class="line">        time.Sleep(<span class="number">3</span> * time.Second)</span><br><span class="line">        resultCh &lt;- <span class="string">&quot;操作完成&quot;</span></span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用select监听多个通道</span></span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> result := &lt;-resultCh:</span><br><span class="line">        <span class="keyword">return</span> result, <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, ctx.Err() <span class="comment">// 可能是DeadlineExceeded或Canceled</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Context在中间件中的应用</strong>:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loggingMiddleware</span><span class="params">(next http.Handler)</span></span> http.Handler &#123;</span><br><span class="line">    <span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 从请求创建Context</span></span><br><span class="line">        ctx := r.Context()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加请求ID到Context</span></span><br><span class="line">        requestID := uuid.New().String()</span><br><span class="line">        ctx = context.WithValue(ctx, <span class="string">&quot;requestID&quot;</span>, requestID)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用新Context创建新请求</span></span><br><span class="line">        r = r.WithContext(ctx)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 记录请求开始</span></span><br><span class="line">        log.Printf(<span class="string">&quot;Request %s started&quot;</span>, requestID)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用下一个处理器</span></span><br><span class="line">        next.ServeHTTP(w, r)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 记录请求结束</span></span><br><span class="line">        log.Printf(<span class="string">&quot;Request %s completed&quot;</span>, requestID)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>使用Context传递数据库事务</strong>:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Context键类型</span></span><br><span class="line"><span class="keyword">type</span> txKey <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将事务放入Context</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithTx</span><span class="params">(ctx context.Context, tx *sql.Tx)</span></span> context.Context &#123;</span><br><span class="line">    <span class="keyword">return</span> context.WithValue(ctx, txKey&#123;&#125;, tx)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从Context获取事务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetTx</span><span class="params">(ctx context.Context)</span></span> (*sql.Tx, <span class="type">bool</span>) &#123;</span><br><span class="line">    tx, ok := ctx.Value(txKey&#123;&#125;).(*sql.Tx)</span><br><span class="line">    <span class="keyword">return</span> tx, ok</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateUser</span><span class="params">(ctx context.Context, user User)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    tx, ok := GetTx(ctx)</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        <span class="comment">// 没有事务，创建新事务</span></span><br><span class="line">        <span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">        tx, err = db.BeginTx(ctx, <span class="literal">nil</span>)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">defer</span> tx.Rollback()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行创建用户</span></span><br><span class="line">        <span class="keyword">if</span> err := insertUser(ctx, tx, user); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> tx.Commit()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在现有事务中执行</span></span><br><span class="line">    <span class="keyword">return</span> insertUser(ctx, tx, user)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="二、项目架构与设计模式"><a href="#二、项目架构与设计模式" class="headerlink" title="二、项目架构与设计模式"></a>二、项目架构与设计模式</h2><h3 id="1-分层架构"><a href="#1-分层架构" class="headerlink" title="1. 分层架构"></a>1. 分层架构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">go-app/</span><br><span class="line">├── config/                # 配置相关</span><br><span class="line">│   └── config.go          # 应用配置</span><br><span class="line">├── controller/            # 控制器层（处理HTTP请求）</span><br><span class="line">│   └── user_controller.go</span><br><span class="line">├── service/               # 服务层（业务逻辑）</span><br><span class="line">│   └── user_service.go</span><br><span class="line">├── database/              # 数据库相关</span><br><span class="line">│   ├── database.go        # 数据库初始化</span><br><span class="line">│   └── repositories/      # 数据访问层</span><br><span class="line">│       ├── repository.go  # 通用接口</span><br><span class="line">│       └── mongo_repository.go</span><br><span class="line">├── middleware/            # HTTP中间件</span><br><span class="line">│   ├── logger.go          # 日志中间件</span><br><span class="line">│   └── auth.go            # 认证中间件</span><br><span class="line">├── models/                # 数据模型</span><br><span class="line">│   └── user.go</span><br><span class="line">├── utils/                 # 工具函数</span><br><span class="line">│   └── logger.go          # 日志工具</span><br><span class="line">├── router/                # 路由设置</span><br><span class="line">│   └── router.go</span><br><span class="line">├── main.go                # 程序入口</span><br><span class="line">└── go.mod                 # 依赖管理</span><br></pre></td></tr></table></figure><h3 id="2-仓储模式（Repository-Pattern）"><a href="#2-仓储模式（Repository-Pattern）" class="headerlink" title="2. 仓储模式（Repository Pattern）"></a>2. 仓储模式（Repository Pattern）</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通用仓储接口</span></span><br><span class="line"><span class="keyword">type</span> Repository <span class="keyword">interface</span> &#123;</span><br><span class="line">    FindByID(id <span class="type">string</span>) (bson.M, <span class="type">error</span>)</span><br><span class="line">    FindAll(filter bson.M, skip, limit <span class="type">int64</span>, sort bson.D) ([]bson.M, <span class="type">int64</span>, <span class="type">error</span>)</span><br><span class="line">    Create(document <span class="keyword">interface</span>&#123;&#125;) (<span class="type">string</span>, <span class="type">error</span>)</span><br><span class="line">    Update(id <span class="type">string</span>, update bson.M) <span class="type">error</span></span><br><span class="line">    Delete(id <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MongoDB实现</span></span><br><span class="line"><span class="keyword">type</span> MongoRepository <span class="keyword">struct</span> &#123;</span><br><span class="line">    db         *mongodb.Database</span><br><span class="line">    collection *mongodb.Collection</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建MongoDB存储库</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMongoRepository</span><span class="params">(db *mongodb.Database, collectionName <span class="type">string</span>)</span></span> *MongoRepository &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;MongoRepository&#123;</span><br><span class="line">        db:         db,</span><br><span class="line">        collection: db.Collection(collectionName),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *MongoRepository)</span></span> FindByID(id <span class="type">string</span>) (bson.M, <span class="type">error</span>) &#123;</span><br><span class="line">    ctx, cancel := context.WithTimeout(context.Background(), <span class="number">10</span>*time.Second)</span><br><span class="line">    <span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">    objID, err := primitive.ObjectIDFromHex(id)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;无效的ID格式: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> result bson.M</span><br><span class="line">    err = r.collection.FindOne(ctx, bson.M&#123;<span class="string">&quot;_id&quot;</span>: objID&#125;).Decode(&amp;result)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> err == mongodb.ErrNoDocuments &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;文档不存在&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-服务层（Service-Layer）"><a href="#3-服务层（Service-Layer）" class="headerlink" title="3. 服务层（Service Layer）"></a>3. 服务层（Service Layer）</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用户服务接口</span></span><br><span class="line"><span class="keyword">type</span> UserService <span class="keyword">interface</span> &#123;</span><br><span class="line">    GetUserByID(id <span class="type">string</span>) (*User, <span class="type">error</span>)</span><br><span class="line">    CreateUser(user *User) (<span class="type">string</span>, <span class="type">error</span>)</span><br><span class="line">    UpdateUser(id <span class="type">string</span>, user *User) <span class="type">error</span></span><br><span class="line">    DeleteUser(id <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用户服务实现</span></span><br><span class="line"><span class="keyword">type</span> UserServiceImpl <span class="keyword">struct</span> &#123;</span><br><span class="line">    repo Repository</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建用户服务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewUserService</span><span class="params">(repo Repository)</span></span> UserService &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;UserServiceImpl&#123;repo: repo&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *UserServiceImpl)</span></span> GetUserByID(id <span class="type">string</span>) (*User, <span class="type">error</span>) &#123;</span><br><span class="line">    doc, err := s.repo.FindByID(id)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转换为用户对象</span></span><br><span class="line">    <span class="keyword">var</span> user User</span><br><span class="line">    <span class="comment">// ...处理转换逻辑</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &amp;user, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-配置管理"><a href="#4-配置管理" class="headerlink" title="4. 配置管理"></a>4. 配置管理</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config/config.go</span></span><br><span class="line"><span class="keyword">package</span> config</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/spf13/viper&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置结构体</span></span><br><span class="line"><span class="keyword">type</span> Config <span class="keyword">struct</span> &#123;</span><br><span class="line">    Server <span class="keyword">struct</span> &#123;</span><br><span class="line">        Port         <span class="type">string</span>        <span class="string">`mapstructure:&quot;SERVER_PORT&quot;`</span></span><br><span class="line">        Mode         <span class="type">string</span>        <span class="string">`mapstructure:&quot;SERVER_MODE&quot;`</span></span><br><span class="line">        ReadTimeout  time.Duration <span class="string">`mapstructure:&quot;SERVER_READ_TIMEOUT&quot;`</span></span><br><span class="line">        WriteTimeout time.Duration <span class="string">`mapstructure:&quot;SERVER_WRITE_TIMEOUT&quot;`</span></span><br><span class="line">        IdleTimeout  time.Duration <span class="string">`mapstructure:&quot;SERVER_IDLE_TIMEOUT&quot;`</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Database <span class="keyword">struct</span> &#123;</span><br><span class="line">        <span class="comment">// MySQL配置...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MongoDB <span class="keyword">struct</span> &#123;</span><br><span class="line">        URI      <span class="type">string</span> <span class="string">`mapstructure:&quot;MONGODB_URI&quot;`</span></span><br><span class="line">        Database <span class="type">string</span> <span class="string">`mapstructure:&quot;MONGODB_DATABASE&quot;`</span></span><br><span class="line">        Username <span class="type">string</span> <span class="string">`mapstructure:&quot;MONGODB_USERNAME&quot;`</span></span><br><span class="line">        Password <span class="type">string</span> <span class="string">`mapstructure:&quot;MONGODB_PASSWORD&quot;`</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    JWT <span class="keyword">struct</span> &#123;</span><br><span class="line">        Secret <span class="type">string</span>        <span class="string">`mapstructure:&quot;JWT_SECRET&quot;`</span></span><br><span class="line">        Expire time.Duration <span class="string">`mapstructure:&quot;JWT_EXPIRE&quot;`</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Logger <span class="keyword">struct</span> &#123;</span><br><span class="line">        Dir          <span class="type">string</span> <span class="string">`mapstructure:&quot;LOGGER_DIR&quot;`</span></span><br><span class="line">        FileName     <span class="type">string</span> <span class="string">`mapstructure:&quot;LOGGER_FILENAME&quot;`</span></span><br><span class="line">        MaxSize      <span class="type">int</span>    <span class="string">`mapstructure:&quot;LOGGER_MAX_SIZE&quot;`</span></span><br><span class="line">        MaxBackups   <span class="type">int</span>    <span class="string">`mapstructure:&quot;LOGGER_MAX_BACKUPS&quot;`</span></span><br><span class="line">        MaxAge       <span class="type">int</span>    <span class="string">`mapstructure:&quot;LOGGER_MAX_AGE&quot;`</span></span><br><span class="line">        Compress     <span class="type">bool</span>   <span class="string">`mapstructure:&quot;LOGGER_COMPRESS&quot;`</span></span><br><span class="line">        ConsoleOutput <span class="type">bool</span>  <span class="string">`mapstructure:&quot;LOGGER_CONSOLE_OUTPUT&quot;`</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载配置</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LoadConfig</span><span class="params">()</span></span> *Config &#123;</span><br><span class="line">    <span class="comment">// 获取环境变量</span></span><br><span class="line">    env := os.Getenv(<span class="string">&quot;APP_ENV&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> env == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        env = <span class="string">&quot;test&quot;</span> <span class="comment">// 默认测试环境</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置配置文件</span></span><br><span class="line">    viper.SetConfigName(<span class="string">&quot;.env.&quot;</span> + env)</span><br><span class="line">    viper.SetConfigType(<span class="string">&quot;env&quot;</span>)</span><br><span class="line">    viper.AddConfigPath(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">    viper.AutomaticEnv()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取配置文件</span></span><br><span class="line">    <span class="keyword">if</span> err := viper.ReadInConfig(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;无法读取配置文件: &quot;</span> + err.Error())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析配置</span></span><br><span class="line">    <span class="keyword">var</span> config Config</span><br><span class="line">    <span class="keyword">if</span> err := viper.Unmarshal(&amp;config); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;无法解析配置文件: &quot;</span> + err.Error())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &amp;config</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-中间件设计"><a href="#5-中间件设计" class="headerlink" title="5. 中间件设计"></a>5. 中间件设计</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// middleware/logger.go</span></span><br><span class="line"><span class="keyword">package</span> middleware</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;go-app/utils&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">    <span class="string">&quot;go.uber.org/zap&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 日志中间件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Logger</span><span class="params">()</span></span> gin.HandlerFunc &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 开始时间</span></span><br><span class="line">        start := time.Now()</span><br><span class="line">        path := c.Request.URL.Path</span><br><span class="line">        query := c.Request.URL.RawQuery</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理请求</span></span><br><span class="line">        c.Next()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 结束时间</span></span><br><span class="line">        end := time.Now()</span><br><span class="line">        latency := end.Sub(start)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取状态</span></span><br><span class="line">        status := c.Writer.Status()</span><br><span class="line">        clientIP := c.ClientIP()</span><br><span class="line">        method := c.Request.Method</span><br><span class="line">        userAgent := c.Request.UserAgent()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构建日志字段</span></span><br><span class="line">        fields := []zap.Field&#123;</span><br><span class="line">            zap.Int(<span class="string">&quot;status&quot;</span>, status),</span><br><span class="line">            zap.String(<span class="string">&quot;method&quot;</span>, method),</span><br><span class="line">            zap.String(<span class="string">&quot;path&quot;</span>, path),</span><br><span class="line">            zap.String(<span class="string">&quot;query&quot;</span>, query),</span><br><span class="line">            zap.String(<span class="string">&quot;ip&quot;</span>, clientIP),</span><br><span class="line">            zap.String(<span class="string">&quot;user-agent&quot;</span>, userAgent),</span><br><span class="line">            zap.Duration(<span class="string">&quot;latency&quot;</span>, latency),</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据状态码记录不同级别的日志</span></span><br><span class="line">        msg := fmt.Sprintf(<span class="string">&quot;[GIN] %d %s %s&quot;</span>, status, method, path)</span><br><span class="line">        <span class="keyword">if</span> status &gt;= <span class="number">500</span> &#123;</span><br><span class="line">            utils.Error(msg, fields...)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> status &gt;= <span class="number">400</span> &#123;</span><br><span class="line">            utils.Warn(msg, fields...)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            utils.Info(msg, fields...)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// middleware/middleware.go</span></span><br><span class="line"><span class="keyword">package</span> middleware</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;go-app/config&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置所有中间件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetupMiddlewares</span><span class="params">(r *gin.Engine, cfg *config.Config)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 日志中间件（放在最前面，记录所有请求）</span></span><br><span class="line">    r.Use(Logger())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 全局错误处理中间件</span></span><br><span class="line">    r.Use(ErrorHandler())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跨域中间件</span></span><br><span class="line">    r.Use(Cors())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 签名验证中间件</span></span><br><span class="line">    r.Use(Signature(&amp;SignatureConfig&#123;</span><br><span class="line">        AppKey:    cfg.Signature.AppKey,</span><br><span class="line">        AppSecret: cfg.Signature.AppSecret,</span><br><span class="line">        Expire:    cfg.Signature.Expire,</span><br><span class="line">    &#125;))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-日志工具"><a href="#6-日志工具" class="headerlink" title="6. 日志工具"></a>6. 日志工具</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utils/logger.go</span></span><br><span class="line"><span class="keyword">package</span> utils</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;path/filepath&quot;</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;go.uber.org/zap&quot;</span></span><br><span class="line">    <span class="string">&quot;go.uber.org/zap/zapcore&quot;</span></span><br><span class="line">    <span class="string">&quot;gopkg.in/natefinch/lumberjack.v2&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    logger      *zap.Logger</span><br><span class="line">    sugarLogger *zap.SugaredLogger</span><br><span class="line">    once        sync.Once</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 日志配置</span></span><br><span class="line"><span class="keyword">type</span> LogConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">    LogDir        <span class="type">string</span> <span class="comment">// 日志目录</span></span><br><span class="line">    LogFileName   <span class="type">string</span> <span class="comment">// 日志文件名</span></span><br><span class="line">    MaxSize       <span class="type">int</span>    <span class="comment">// 单个日志文件最大大小，单位MB</span></span><br><span class="line">    MaxBackups    <span class="type">int</span>    <span class="comment">// 最大保留旧日志文件数</span></span><br><span class="line">    MaxAge        <span class="type">int</span>    <span class="comment">// 日志文件保留天数</span></span><br><span class="line">    Compress      <span class="type">bool</span>   <span class="comment">// 是否压缩旧日志文件</span></span><br><span class="line">    ConsoleOutput <span class="type">bool</span>   <span class="comment">// 是否输出到控制台</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认日志配置</span></span><br><span class="line"><span class="keyword">var</span> defaultLogConfig = LogConfig&#123;</span><br><span class="line">    LogDir:        <span class="string">&quot;logs&quot;</span>,</span><br><span class="line">    LogFileName:   <span class="string">&quot;app.log&quot;</span>,</span><br><span class="line">    MaxSize:       <span class="number">100</span>,</span><br><span class="line">    MaxBackups:    <span class="number">10</span>,</span><br><span class="line">    MaxAge:        <span class="number">30</span>,</span><br><span class="line">    Compress:      <span class="literal">true</span>,</span><br><span class="line">    ConsoleOutput: <span class="literal">true</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化日志</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitLogger</span><span class="params">()</span></span> &#123;</span><br><span class="line">    InitLoggerWithConfig(defaultLogConfig)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用配置初始化日志</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitLoggerWithConfig</span><span class="params">(config LogConfig)</span></span> &#123;</span><br><span class="line">    once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// 确保日志目录存在</span></span><br><span class="line">        <span class="keyword">if</span> err := os.MkdirAll(config.LogDir, <span class="number">0755</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="built_in">panic</span>(<span class="string">&quot;无法创建日志目录: &quot;</span> + err.Error())</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 配置编码器</span></span><br><span class="line">        encoderConfig := zapcore.EncoderConfig&#123;</span><br><span class="line">            TimeKey:        <span class="string">&quot;time&quot;</span>,</span><br><span class="line">            LevelKey:       <span class="string">&quot;level&quot;</span>,</span><br><span class="line">            NameKey:        <span class="string">&quot;logger&quot;</span>,</span><br><span class="line">            CallerKey:      <span class="string">&quot;caller&quot;</span>,</span><br><span class="line">            FunctionKey:    zapcore.OmitKey,</span><br><span class="line">            MessageKey:     <span class="string">&quot;msg&quot;</span>,</span><br><span class="line">            StacktraceKey:  <span class="string">&quot;stacktrace&quot;</span>,</span><br><span class="line">            LineEnding:     zapcore.DefaultLineEnding,</span><br><span class="line">            EncodeLevel:    zapcore.LowercaseLevelEncoder,</span><br><span class="line">            EncodeTime:     zapcore.ISO8601TimeEncoder,</span><br><span class="line">            EncodeDuration: zapcore.SecondsDurationEncoder,</span><br><span class="line">            EncodeCaller:   zapcore.ShortCallerEncoder,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 日志输出配置</span></span><br><span class="line">        <span class="comment">// ... [详细配置省略]</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建日志记录器</span></span><br><span class="line">        logger = zap.New(core, zap.AddCaller(), zap.AddCallerSkip(<span class="number">1</span>))</span><br><span class="line">        sugarLogger = logger.Sugar()</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取日志记录器</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetLogger</span><span class="params">()</span></span> *zap.Logger &#123;</span><br><span class="line">    <span class="keyword">if</span> logger == <span class="literal">nil</span> &#123;</span><br><span class="line">        InitLogger()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> logger</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 日志方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Info</span><span class="params">(msg <span class="type">string</span>, fields ...zap.Field)</span></span> &#123;</span><br><span class="line">    GetLogger().Info(msg, fields...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Error</span><span class="params">(msg <span class="type">string</span>, fields ...zap.Field)</span></span> &#123;</span><br><span class="line">    GetLogger().Error(msg, fields...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Fatal</span><span class="params">(msg <span class="type">string</span>, fields ...zap.Field)</span></span> &#123;</span><br><span class="line">    GetLogger().Fatal(msg, fields...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="三、Web应用开发（Gin框架）"><a href="#三、Web应用开发（Gin框架）" class="headerlink" title="三、Web应用开发（Gin框架）"></a>三、Web应用开发（Gin框架）</h2><h3 id="1-路由设置"><a href="#1-路由设置" class="headerlink" title="1. 路由设置"></a>1. 路由设置</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router/router.go</span></span><br><span class="line"><span class="keyword">package</span> router</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;go-app/config&quot;</span></span><br><span class="line">    <span class="string">&quot;go-app/controller&quot;</span></span><br><span class="line">    <span class="string">&quot;go-app/database/repositories&quot;</span></span><br><span class="line">    <span class="string">&quot;go-app/middleware&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Setup</span><span class="params">(r *gin.Engine, cfg *config.Config, repoManager *repositories.RepositoryManager)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 公共路由组</span></span><br><span class="line">    public := r.Group(<span class="string">&quot;/api&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 认证路由组</span></span><br><span class="line">    authorized := r.Group(<span class="string">&quot;/api&quot;</span>)</span><br><span class="line">    authorized.Use(middleware.JWTAuth(cfg))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用户相关路由</span></span><br><span class="line">    setupUserRoutes(public, authorized, controller.NewUserController(repoManager.UserRepo, cfg))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 产品相关路由</span></span><br><span class="line">    setupProductRoutes(public, authorized, controller.NewProductController(repoManager.ProductRepo, cfg))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setupUserRoutes</span><span class="params">(public, authorized *gin.RouterGroup, controller *controller.UserController)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 公共接口</span></span><br><span class="line">    public.POST(<span class="string">&quot;/login&quot;</span>, controller.Login)</span><br><span class="line">    public.POST(<span class="string">&quot;/register&quot;</span>, controller.Register)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 需要认证的接口</span></span><br><span class="line">    users := authorized.Group(<span class="string">&quot;/users&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        users.GET(<span class="string">&quot;&quot;</span>, controller.GetUsers)</span><br><span class="line">        users.GET(<span class="string">&quot;/:id&quot;</span>, controller.GetUser)</span><br><span class="line">        users.PUT(<span class="string">&quot;/:id&quot;</span>, controller.UpdateUser)</span><br><span class="line">        users.DELETE(<span class="string">&quot;/:id&quot;</span>, controller.DeleteUser)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-控制器实现"><a href="#2-控制器实现" class="headerlink" title="2. 控制器实现"></a>2. 控制器实现</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// controller/user_controller.go</span></span><br><span class="line"><span class="keyword">package</span> controller</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">    <span class="string">&quot;strconv&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;go-app/config&quot;</span></span><br><span class="line">    <span class="string">&quot;go-app/database/repositories&quot;</span></span><br><span class="line">    <span class="string">&quot;go-app/models&quot;</span></span><br><span class="line">    <span class="string">&quot;go-app/service&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> UserController <span class="keyword">struct</span> &#123;</span><br><span class="line">    userService service.UserService</span><br><span class="line">    cfg         *config.Config</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewUserController</span><span class="params">(userRepo repositories.UserRepository, cfg *config.Config)</span></span> *UserController &#123;</span><br><span class="line">    userService := service.NewUserService(userRepo, cfg)</span><br><span class="line">    <span class="keyword">return</span> &amp;UserController&#123;</span><br><span class="line">        userService: userService,</span><br><span class="line">        cfg:         cfg,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 登录</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *UserController)</span></span> Login(ctx *gin.Context) &#123;</span><br><span class="line">    <span class="keyword">var</span> loginReq models.LoginRequest</span><br><span class="line">    <span class="keyword">if</span> err := ctx.ShouldBindJSON(&amp;loginReq); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        ctx.JSON(http.StatusBadRequest, gin.H&#123;<span class="string">&quot;error&quot;</span>: err.Error()&#125;)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    user, token, err := c.userService.Login(loginReq)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        ctx.JSON(http.StatusUnauthorized, gin.H&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;用户名或密码错误&quot;</span>&#125;)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">        <span class="string">&quot;user&quot;</span>:  user,</span><br><span class="line">        <span class="string">&quot;token&quot;</span>: token,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取用户列表</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *UserController)</span></span> GetUsers(ctx *gin.Context) &#123;</span><br><span class="line">    page, _ := strconv.Atoi(ctx.DefaultQuery(<span class="string">&quot;page&quot;</span>, <span class="string">&quot;1&quot;</span>))</span><br><span class="line">    pageSize, _ := strconv.Atoi(ctx.DefaultQuery(<span class="string">&quot;pageSize&quot;</span>, <span class="string">&quot;10&quot;</span>))</span><br><span class="line"></span><br><span class="line">    users, total, err := c.userService.GetUsers(page, pageSize)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        ctx.JSON(http.StatusInternalServerError, gin.H&#123;<span class="string">&quot;error&quot;</span>: err.Error()&#125;)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">        <span class="string">&quot;data&quot;</span>: users,</span><br><span class="line">        <span class="string">&quot;meta&quot;</span>: gin.H&#123;</span><br><span class="line">            <span class="string">&quot;total&quot;</span>:     total,</span><br><span class="line">            <span class="string">&quot;page&quot;</span>:      page,</span><br><span class="line">            <span class="string">&quot;page_size&quot;</span>: pageSize,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 其他方法...</span></span><br></pre></td></tr></table></figure><h3 id="3-主程序入口"><a href="#3-主程序入口" class="headerlink" title="3. 主程序入口"></a>3. 主程序入口</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;os/signal&quot;</span></span><br><span class="line">    <span class="string">&quot;syscall&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;go-app/config&quot;</span></span><br><span class="line">    <span class="string">&quot;go-app/database&quot;</span></span><br><span class="line">    <span class="string">&quot;go-app/database/repositories&quot;</span></span><br><span class="line">    <span class="string">&quot;go-app/middleware&quot;</span></span><br><span class="line">    <span class="string">&quot;go-app/router&quot;</span></span><br><span class="line">    <span class="string">&quot;go-app/utils&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/joho/godotenv&quot;</span></span><br><span class="line">    <span class="string">&quot;go.uber.org/zap&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 加载环境变量</span></span><br><span class="line">    <span class="keyword">if</span> err := godotenv.Load(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;警告: .env文件未找到，使用系统环境变量&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载配置</span></span><br><span class="line">    cfg := config.LoadConfig()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化日志</span></span><br><span class="line">    initLogger(cfg)</span><br><span class="line">    <span class="keyword">defer</span> utils.Sync() <span class="comment">// 确保日志写入</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置运行模式</span></span><br><span class="line">    gin.SetMode(cfg.Server.Mode)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化数据库连接</span></span><br><span class="line">    err := database.InitDB()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        utils.Error(<span class="string">&quot;MySQL数据库初始化失败&quot;</span>, zap.Error(err))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化MongoDB连接</span></span><br><span class="line">    _, err = database.InitMongoDB(cfg)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        utils.Error(<span class="string">&quot;MongoDB初始化失败&quot;</span>, zap.Error(err))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建存储库管理器</span></span><br><span class="line">    repoManager := repositories.NewRepositoryManager(database.DB, database.MongoDB)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建Gin引擎</span></span><br><span class="line">    r := gin.New()</span><br><span class="line">    r.Use(gin.Recovery())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置中间件</span></span><br><span class="line">    middleware.SetupMiddlewares(r, cfg)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置路由</span></span><br><span class="line">    router.Setup(r, cfg, repoManager)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置HTTP服务器</span></span><br><span class="line">    server := &amp;http.Server&#123;</span><br><span class="line">        Addr:         <span class="string">&quot;:&quot;</span> + cfg.Server.Port,</span><br><span class="line">        Handler:      r,</span><br><span class="line">        ReadTimeout:  cfg.Server.ReadTimeout,</span><br><span class="line">        WriteTimeout: cfg.Server.WriteTimeout,</span><br><span class="line">        IdleTimeout:  cfg.Server.IdleTimeout,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动HTTP服务器</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        utils.Info(fmt.Sprintf(<span class="string">&quot;服务器启动于 http://localhost:%s&quot;</span>, cfg.Server.Port))</span><br><span class="line">        <span class="keyword">if</span> err := server.ListenAndServe(); err != <span class="literal">nil</span> &amp;&amp; err != http.ErrServerClosed &#123;</span><br><span class="line">            utils.Fatal(<span class="string">&quot;服务器启动失败&quot;</span>, zap.Error(err))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待中断信号</span></span><br><span class="line">    quit := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)</span><br><span class="line">    signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)</span><br><span class="line">    &lt;-quit</span><br><span class="line"></span><br><span class="line">    utils.Info(<span class="string">&quot;正在关闭服务器...&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化日志</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initLogger</span><span class="params">(cfg *config.Config)</span></span> &#123;</span><br><span class="line">    logConfig := utils.LogConfig&#123;</span><br><span class="line">        LogDir:        <span class="string">&quot;logs&quot;</span>,</span><br><span class="line">        LogFileName:   <span class="string">&quot;app.log&quot;</span>,</span><br><span class="line">        MaxSize:       <span class="number">100</span>,</span><br><span class="line">        MaxBackups:    <span class="number">10</span>,</span><br><span class="line">        MaxAge:        <span class="number">30</span>,</span><br><span class="line">        Compress:      <span class="literal">true</span>,</span><br><span class="line">        ConsoleOutput: <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用配置文件的设置（如果有）</span></span><br><span class="line">    <span class="keyword">if</span> cfg.Logger.Dir != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        logConfig.LogDir = cfg.Logger.Dir</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...其他配置项</span></span><br><span class="line"></span><br><span class="line">    utils.InitLoggerWithConfig(logConfig)</span><br><span class="line">    utils.Info(<span class="string">&quot;应用程序启动&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="四、最佳实践与编码规范"><a href="#四、最佳实践与编码规范" class="headerlink" title="四、最佳实践与编码规范"></a>四、最佳实践与编码规范</h2><h3 id="1-错误处理"><a href="#1-错误处理" class="headerlink" title="1. 错误处理"></a>1. 错误处理</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基本错误检查</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    result, err := someOperation()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;操作失败: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理结果...</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义错误类型</span></span><br><span class="line"><span class="keyword">type</span> NotFoundError <span class="keyword">struct</span> &#123;</span><br><span class="line">    Resource <span class="type">string</span></span><br><span class="line">    ID       <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *NotFoundError)</span></span> Error() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;%s ID=%s 不存在&quot;</span>, e.Resource, e.ID)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误类型判断</span></span><br><span class="line"><span class="keyword">if</span> errors.Is(err, sql.ErrNoRows) &#123;</span><br><span class="line">    <span class="comment">// 处理记录不存在的情况</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取原始错误</span></span><br><span class="line"><span class="keyword">var</span> notFoundErr *NotFoundError</span><br><span class="line"><span class="keyword">if</span> errors.As(err, &amp;notFoundErr) &#123;</span><br><span class="line">    <span class="comment">// 处理特定类型的错误</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-并发控制"><a href="#2-并发控制" class="headerlink" title="2. 并发控制"></a>2. 并发控制</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用Context控制超时和取消</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processWithTimeout</span><span class="params">(data []<span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    ctx, cancel := context.WithTimeout(context.Background(), <span class="number">5</span>*time.Second)</span><br><span class="line">    <span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">    results := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>, <span class="built_in">len</span>(data))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, item := <span class="keyword">range</span> data &#123;</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(item <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">            <span class="keyword">select</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">                <span class="keyword">return</span> <span class="comment">// 超时或被取消</span></span><br><span class="line">            <span class="keyword">case</span> results &lt;- processItem(item):</span><br><span class="line">                <span class="comment">// 处理完成</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;(item)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 收集结果...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用WaitGroup同步多个goroutine</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processItems</span><span class="params">(items []<span class="type">string</span>)</span></span> []<span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">    results := <span class="built_in">make</span>([]<span class="type">string</span>, <span class="built_in">len</span>(items))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, item := <span class="keyword">range</span> items &#123;</span><br><span class="line">        wg.Add(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="type">int</span>, item <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">            <span class="keyword">defer</span> wg.Done()</span><br><span class="line">            results[i] = processItem(item)</span><br><span class="line">        &#125;(i, item)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    wg.Wait() <span class="comment">// 等待所有处理完成</span></span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用worker池模式</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">workerPool</span><span class="params">(tasks &lt;-<span class="keyword">chan</span> Task, results <span class="keyword">chan</span>&lt;- Result, numWorkers <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动固定数量的worker</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; numWorkers; i++ &#123;</span><br><span class="line">        wg.Add(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(workerID <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">            <span class="keyword">defer</span> wg.Done()</span><br><span class="line">            <span class="keyword">for</span> task := <span class="keyword">range</span> tasks &#123;</span><br><span class="line">                results &lt;- processTask(task)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;(i)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    wg.Wait()</span><br><span class="line">    <span class="built_in">close</span>(results)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-单元测试"><a href="#3-单元测试" class="headerlink" title="3. 单元测试"></a>3. 单元测试</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// service/user_service_test.go</span></span><br><span class="line"><span class="keyword">package</span> service</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;testing&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;go-app/models&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/stretchr/testify/assert&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/stretchr/testify/mock&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模拟用户存储库</span></span><br><span class="line"><span class="keyword">type</span> MockUserRepository <span class="keyword">struct</span> &#123;</span><br><span class="line">    mock.Mock</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *MockUserRepository)</span></span> FindByID(id <span class="type">string</span>) (*models.User, <span class="type">error</span>) &#123;</span><br><span class="line">    args := m.Called(id)</span><br><span class="line">    <span class="keyword">if</span> args.Get(<span class="number">0</span>) == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, args.Error(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> args.Get(<span class="number">0</span>).(*models.User), args.Error(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试获取用户</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestGetUser</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    mockRepo := <span class="built_in">new</span>(MockUserRepository)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置模拟行为</span></span><br><span class="line">    mockRepo.On(<span class="string">&quot;FindByID&quot;</span>, <span class="string">&quot;1&quot;</span>).Return(&amp;models.User&#123;</span><br><span class="line">        ID:       <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        Username: <span class="string">&quot;testuser&quot;</span>,</span><br><span class="line">    &#125;, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建服务</span></span><br><span class="line">    service := NewUserService(mockRepo, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行测试</span></span><br><span class="line">    user, err := service.GetUserByID(<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 断言结果</span></span><br><span class="line">    assert.NoError(t, err)</span><br><span class="line">    assert.NotNil(t, user)</span><br><span class="line">    assert.Equal(t, <span class="string">&quot;1&quot;</span>, user.ID)</span><br><span class="line">    assert.Equal(t, <span class="string">&quot;testuser&quot;</span>, user.Username)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证模拟调用</span></span><br><span class="line">    mockRepo.AssertExpectations(t)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-性能优化"><a href="#4-性能优化" class="headerlink" title="4. 性能优化"></a>4. 性能优化</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用适当的数据结构</span></span><br><span class="line"><span class="comment">// 例如，使用sync.Map代替加锁的map</span></span><br><span class="line"><span class="keyword">var</span> cache sync.Map</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取缓存</span></span><br><span class="line">value, ok := cache.Load(<span class="string">&quot;key&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> ok &#123;</span><br><span class="line">    <span class="comment">// 使用缓存的值</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 计算新值</span></span><br><span class="line">    newValue := computeExpensiveValue()</span><br><span class="line">    cache.Store(<span class="string">&quot;key&quot;</span>, newValue)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用字符串拼接</span></span><br><span class="line"><span class="comment">// 低效方式</span></span><br><span class="line">s := <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">    s += <span class="string">&quot;x&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 高效方式</span></span><br><span class="line"><span class="keyword">var</span> sb strings.Builder</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">    sb.WriteString(<span class="string">&quot;x&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">s := sb.String()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 避免不必要的内存分配</span></span><br><span class="line">preallocated := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">0</span>, expectedSize) <span class="comment">// 预分配容量</span></span><br></pre></td></tr></table></figure><h3 id="5-API设计"><a href="#5-API设计" class="headerlink" title="5. API设计"></a>5. API设计</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RESTful API设计</span></span><br><span class="line"><span class="comment">// GET /api/users      - 获取所有用户</span></span><br><span class="line"><span class="comment">// GET /api/users/:id  - 获取单个用户</span></span><br><span class="line"><span class="comment">// POST /api/users     - 创建用户</span></span><br><span class="line"><span class="comment">// PUT /api/users/:id  - 更新用户</span></span><br><span class="line"><span class="comment">// DELETE /api/users/:id - 删除用户</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 统一的响应格式</span></span><br><span class="line"><span class="keyword">type</span> Response <span class="keyword">struct</span> &#123;</span><br><span class="line">    Code    <span class="type">int</span>         <span class="string">`json:&quot;code&quot;`</span></span><br><span class="line">    Message <span class="type">string</span>      <span class="string">`json:&quot;message&quot;`</span></span><br><span class="line">    Data    <span class="keyword">interface</span>&#123;&#125; <span class="string">`json:&quot;data,omitempty&quot;`</span></span><br><span class="line">    Meta    <span class="keyword">interface</span>&#123;&#125; <span class="string">`json:&quot;meta,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetUsers</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">    users, total, err := userService.GetUsers(page, pageSize)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        c.JSON(http.StatusInternalServerError, Response&#123;</span><br><span class="line">            Code:    <span class="number">500</span>,</span><br><span class="line">            Message: <span class="string">&quot;获取用户列表失败&quot;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    c.JSON(http.StatusOK, Response&#123;</span><br><span class="line">        Code:    <span class="number">200</span>,</span><br><span class="line">        Message: <span class="string">&quot;成功&quot;</span>,</span><br><span class="line">        Data:    users,</span><br><span class="line">        Meta: <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">            <span class="string">&quot;total&quot;</span>:     total,</span><br><span class="line">            <span class="string">&quot;page&quot;</span>:      page,</span><br><span class="line">            <span class="string">&quot;page_size&quot;</span>: pageSize,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="五、进阶主题与扩展"><a href="#五、进阶主题与扩展" class="headerlink" title="五、进阶主题与扩展"></a>五、进阶主题与扩展</h2><h3 id="1-部署与CI-CD"><a href="#1-部署与CI-CD" class="headerlink" title="1. 部署与CI&#x2F;CD"></a>1. 部署与CI&#x2F;CD</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dockerfile</span></span><br><span class="line"><span class="string">FROM</span> <span class="string">golang:1.19-alpine</span> <span class="string">AS</span> <span class="string">builder</span></span><br><span class="line"></span><br><span class="line"><span class="string">WORKDIR</span> <span class="string">/app</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">.</span> <span class="string">.</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">go</span> <span class="string">mod</span> <span class="string">download</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">go</span> <span class="string">build</span> <span class="string">-o</span> <span class="string">app</span></span><br><span class="line"></span><br><span class="line"><span class="string">FROM</span> <span class="string">alpine:latest</span></span><br><span class="line"><span class="string">WORKDIR</span> <span class="string">/app</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">--from=builder</span> <span class="string">/app/app</span> <span class="string">.</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">--from=builder</span> <span class="string">/app/configs</span> <span class="string">./configs</span></span><br><span class="line"></span><br><span class="line"><span class="string">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"><span class="string">CMD</span> [<span class="string">&quot;./app&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker-compose.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">app:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">APP_ENV=prod</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mongodb</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">mongodb:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mongo:latest</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mongo-data:/data/db</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;27017:27017&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">mongo-data:</span></span><br></pre></td></tr></table></figure><h3 id="2-监控与日志"><a href="#2-监控与日志" class="headerlink" title="2. 监控与日志"></a>2. 监控与日志</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 指标收集</span></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;github.com/prometheus/client_golang/prometheus&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/prometheus/client_golang/prometheus/promhttp&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    httpRequestsTotal = prometheus.NewCounterVec(</span><br><span class="line">        prometheus.CounterOpts&#123;</span><br><span class="line">            Name: <span class="string">&quot;http_requests_total&quot;</span>,</span><br><span class="line">            Help: <span class="string">&quot;HTTP请求总数&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        []<span class="type">string</span>&#123;<span class="string">&quot;method&quot;</span>, <span class="string">&quot;path&quot;</span>, <span class="string">&quot;status&quot;</span>&#125;,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    httpRequestDuration = prometheus.NewHistogramVec(</span><br><span class="line">        prometheus.HistogramOpts&#123;</span><br><span class="line">            Name:    <span class="string">&quot;http_request_duration_seconds&quot;</span>,</span><br><span class="line">            Help:    <span class="string">&quot;HTTP请求处理时间&quot;</span>,</span><br><span class="line">            Buckets: prometheus.DefBuckets,</span><br><span class="line">        &#125;,</span><br><span class="line">        []<span class="type">string</span>&#123;<span class="string">&quot;method&quot;</span>, <span class="string">&quot;path&quot;</span>&#125;,</span><br><span class="line">    )</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    prometheus.MustRegister(httpRequestsTotal)</span><br><span class="line">    prometheus.MustRegister(httpRequestDuration)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在Gin中添加指标端点</span></span><br><span class="line">r.GET(<span class="string">&quot;/metrics&quot;</span>, gin.WrapH(promhttp.Handler()))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 日志聚合与分析</span></span><br><span class="line"><span class="comment">// 1. 使用ELK/EFK堆栈</span></span><br><span class="line"><span class="comment">// 2. 使用OpenTelemetry进行分布式追踪</span></span><br></pre></td></tr></table></figure><h3 id="3-安全最佳实践"><a href="#3-安全最佳实践" class="headerlink" title="3. 安全最佳实践"></a>3. 安全最佳实践</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 安全最佳实践</span></span><br><span class="line"><span class="comment">// 1. 密码哈希</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hashPassword</span><span class="params">(password <span class="type">string</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    hash, err := bcrypt.GenerateFromPassword([]<span class="type">byte</span>(password), bcrypt.DefaultCost)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">string</span>(hash), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">verifyPassword</span><span class="params">(hashedPassword, password <span class="type">string</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    err := bcrypt.CompareHashAndPassword([]<span class="type">byte</span>(hashedPassword), []<span class="type">byte</span>(password))</span><br><span class="line">    <span class="keyword">return</span> err == <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. CSRF保护</span></span><br><span class="line">r.Use(csrf.Middleware(csrf.Options&#123;</span><br><span class="line">    Secret: <span class="string">&quot;32-byte-long-auth-key&quot;</span>,</span><br><span class="line">    ErrorFunc: <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        c.JSON(http.StatusForbidden, gin.H&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;CSRF token mismatch&quot;</span>&#125;)</span><br><span class="line">        c.Abort()</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 安全标头</span></span><br><span class="line">r.Use(secure.New(secure.Options&#123;</span><br><span class="line">    AllowedHosts:          []<span class="type">string</span>&#123;<span class="string">&quot;example.com&quot;</span>, <span class="string">&quot;ssl.example.com&quot;</span>&#125;,</span><br><span class="line">    SSLRedirect:           <span class="literal">true</span>,</span><br><span class="line">    SSLHost:               <span class="string">&quot;ssl.example.com&quot;</span>,</span><br><span class="line">    STSSeconds:            <span class="number">315360000</span>,</span><br><span class="line">    STSIncludeSubdomains:  <span class="literal">true</span>,</span><br><span class="line">    FrameDeny:             <span class="literal">true</span>,</span><br><span class="line">    ContentTypeNosniff:    <span class="literal">true</span>,</span><br><span class="line">    BrowserXssFilter:      <span class="literal">true</span>,</span><br><span class="line">    ContentSecurityPolicy: <span class="string">&quot;default-src &#x27;self&#x27;&quot;</span>,</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure><hr><h2 id="六、常见陷阱与解决方案"><a href="#六、常见陷阱与解决方案" class="headerlink" title="六、常见陷阱与解决方案"></a>六、常见陷阱与解决方案</h2><h3 id="1-初学者常见错误"><a href="#1-初学者常见错误" class="headerlink" title="1. 初学者常见错误"></a>1. 初学者常见错误</h3><blockquote><p>⚠️ <strong>陷阱</strong>: 在循环中使用 goroutine 时闭包捕获迭代变量</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误示例</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        fmt.Println(i)  <span class="comment">// 大多数情况下会打印出同一个值(10)</span></span><br><span class="line">    &#125;()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确示例</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">    i := i  <span class="comment">// 在循环内部创建新变量</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        fmt.Println(i)  <span class="comment">// 每个 goroutine 有自己的 i 值</span></span><br><span class="line">    &#125;()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者通过参数传递</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">        fmt.Println(i)  <span class="comment">// i 作为参数传入</span></span><br><span class="line">    &#125;(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>⚠️ <strong>陷阱</strong>: nil 切片与空切片的混淆</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s1 []<span class="type">int</span>         <span class="comment">// nil 切片，s1 == nil 为 true</span></span><br><span class="line">s2 := []<span class="type">int</span>&#123;&#125;        <span class="comment">// 空切片，s2 == nil 为 false，但 len(s2) == 0</span></span><br><span class="line">s3 := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">0</span>) <span class="comment">// 空切片，s3 == nil 为 false，但 len(s3) == 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意：虽然 nil 切片和空切片行为相似，都可以安全地调用 append</span></span><br><span class="line"><span class="comment">// 但是在序列化(如JSON)或比较时可能产生不同结果</span></span><br></pre></td></tr></table></figure></blockquote><blockquote><p>⚠️ <strong>陷阱</strong>: 未检查 map 中键是否存在</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误示例</span></span><br><span class="line">m := <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>&#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;</span><br><span class="line">value := m[<span class="string">&quot;b&quot;</span>] <span class="comment">// 如果键不存在，返回值类型的零值(这里是0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确示例</span></span><br><span class="line">value, exists := m[<span class="string">&quot;b&quot;</span>] <span class="comment">// exists 将为 false</span></span><br><span class="line"><span class="keyword">if</span> exists &#123;</span><br><span class="line">    <span class="comment">// 键存在</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 键不存在</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>⚠️ <strong>陷阱</strong>: 并发访问 map 引起 panic</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可能导致 panic 的并发代码</span></span><br><span class="line">m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">        m[fmt.Sprintf(<span class="string">&quot;key%d&quot;</span>, i)] = i <span class="comment">// 写入 map</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">        _ = m[fmt.Sprintf(<span class="string">&quot;key%d&quot;</span>, i)] <span class="comment">// 读取 map</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确示例：使用 sync.Map 或互斥锁</span></span><br><span class="line"><span class="keyword">var</span> m sync.Map</span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line"><span class="keyword">var</span> mu sync.Mutex</span><br><span class="line">m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写入时</span></span><br><span class="line">mu.Lock()</span><br><span class="line">m[<span class="string">&quot;key&quot;</span>] = value</span><br><span class="line">mu.Unlock()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取时</span></span><br><span class="line">mu.Lock()</span><br><span class="line">value := m[<span class="string">&quot;key&quot;</span>]</span><br><span class="line">mu.Unlock()</span><br></pre></td></tr></table></figure></blockquote><h3 id="2-性能优化提示"><a href="#2-性能优化提示" class="headerlink" title="2. 性能优化提示"></a>2. 性能优化提示</h3><blockquote><p>🚀 <strong>性能提示</strong>: 预分配内存以减少分配次数</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 低效方式</span></span><br><span class="line">s := []<span class="type">int</span>&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</span><br><span class="line">    s = <span class="built_in">append</span>(s, i) <span class="comment">// 可能导致多次重新分配</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 高效方式</span></span><br><span class="line">s := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">0</span>, <span class="number">10000</span>) <span class="comment">// 预分配容量</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</span><br><span class="line">    s = <span class="built_in">append</span>(s, i) <span class="comment">// 不会重新分配</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>🚀 <strong>性能提示</strong>: 在热路径上避免使用反射</p><p>反射在Go中是强大的特性，但性能代价很高。对于频繁调用的代码，尽量避免使用反射。</p><p>考虑使用代码生成、接口或类型断言等替代方案。</p></blockquote><blockquote><p>🚀 <strong>性能提示</strong>: 减少垃圾回收压力</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重用对象</span></span><br><span class="line"><span class="keyword">var</span> bufPool = sync.Pool&#123;</span><br><span class="line">    New: <span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 从池中获取</span></span><br><span class="line">    buf := bufPool.Get().(*bytes.Buffer)</span><br><span class="line">    <span class="keyword">defer</span> bufPool.Put(buf) <span class="comment">// 使用完放回池中</span></span><br><span class="line"></span><br><span class="line">    buf.Reset() <span class="comment">// 重置缓冲区</span></span><br><span class="line">    <span class="comment">// 使用 buf...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><h3 id="3-代码风格最佳实践"><a href="#3-代码风格最佳实践" class="headerlink" title="3. 代码风格最佳实践"></a>3. 代码风格最佳实践</h3><blockquote><p>💎 <strong>最佳实践</strong>: 使用命名返回值提高可读性</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不使用命名返回值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">divide</span><span class="params">(a, b <span class="type">float64</span>)</span></span> (<span class="type">float64</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">&quot;除数不能为0&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> a / b, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用命名返回值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">divide</span><span class="params">(a, b <span class="type">float64</span>)</span></span> (result <span class="type">float64</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0</span> &#123;</span><br><span class="line">        err = errors.New(<span class="string">&quot;除数不能为0&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="comment">// 自动返回 result=0, err=错误</span></span><br><span class="line">    &#125;</span><br><span class="line">    result = a / b</span><br><span class="line">    <span class="keyword">return</span> <span class="comment">// 自动返回 result=计算结果, err=nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>💎 <strong>最佳实践</strong>: 优雅处理资源清理</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">f, err := os.Open(<span class="string">&quot;file.txt&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> f.Close() <span class="comment">// 确保函数返回前关闭文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理文件...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 多个defer语句按LIFO顺序执行</span></span><br></pre></td></tr></table></figure></blockquote><blockquote><p>💎 <strong>最佳实践</strong>: 有意义的错误处理</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不推荐：丢弃错误</span></span><br><span class="line">_ = SomeFunction()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不推荐：空的if err != nil</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> err <span class="comment">// 没有添加上下文</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 推荐：添加上下文</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;处理文件时出错: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 推荐：根据错误类型分别处理</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> errors.Is(err, os.ErrNotExist) &#123;</span><br><span class="line">        <span class="comment">// 处理文件不存在的情况</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> errors.Is(err, os.ErrPermission) &#123;</span><br><span class="line">        <span class="comment">// 处理权限错误</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 处理其他错误</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><hr><h2 id="七、泛型编程-Go-1-18"><a href="#七、泛型编程-Go-1-18" class="headerlink" title="七、泛型编程 (Go 1.18+)"></a>七、泛型编程 (Go 1.18+)</h2><h3 id="1-泛型函数"><a href="#1-泛型函数" class="headerlink" title="1. 泛型函数"></a>1. 泛型函数</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 泛型函数</span></span><br><span class="line"><span class="comment">// 约束T为可比较的数字类型(int, float等)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Min</span>[<span class="title">T</span> <span class="title">constraints</span>.<span class="title">Ordered</span>]<span class="params">(x, y T)</span></span> T &#123;</span><br><span class="line">    <span class="keyword">if</span> x &lt; y &#123;</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> y</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用方式</span></span><br><span class="line">minInt := Min[<span class="type">int</span>](<span class="number">10</span>, <span class="number">20</span>)      <span class="comment">// 显式指定类型</span></span><br><span class="line">minFloat := Min(<span class="number">10.5</span>, <span class="number">20.5</span>)     <span class="comment">// 类型推断为float64</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 泛型类型</span></span><br><span class="line"><span class="keyword">type</span> Stack[T any] <span class="keyword">struct</span> &#123;</span><br><span class="line">    elements []T</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 泛型类型的方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Stack[T])</span></span> Push(value T) &#123;</span><br><span class="line">    s.elements = <span class="built_in">append</span>(s.elements, value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Stack[T])</span></span> Pop() (T, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> zero T</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(s.elements) == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> zero, errors.New(<span class="string">&quot;stack is empty&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    value := s.elements[<span class="built_in">len</span>(s.elements)<span class="number">-1</span>]</span><br><span class="line">    s.elements = s.elements[:<span class="built_in">len</span>(s.elements)<span class="number">-1</span>]</span><br><span class="line">    <span class="keyword">return</span> value, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用泛型类型</span></span><br><span class="line">stringStack := Stack[<span class="type">string</span>]&#123;&#125;</span><br><span class="line">stringStack.Push(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">stringStack.Push(<span class="string">&quot;world&quot;</span>)</span><br><span class="line">value, _ := stringStack.Pop() <span class="comment">// &quot;world&quot;</span></span><br></pre></td></tr></table></figure><p><strong>泛型约束</strong>:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用constraints包中的约束</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;golang.org/x/exp/constraints&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 数值类型约束</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sum</span>[<span class="title">T</span> <span class="title">constraints</span>.<span class="title">Integer</span> | <span class="title">constraints</span>.<span class="title">Float</span>]<span class="params">(values []T)</span></span> T &#123;</span><br><span class="line">    <span class="keyword">var</span> sum T</span><br><span class="line">    <span class="keyword">for</span> _, v := <span class="keyword">range</span> values &#123;</span><br><span class="line">        sum += v</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义约束</span></span><br><span class="line"><span class="keyword">type</span> Comparable <span class="keyword">interface</span> &#123;</span><br><span class="line">    comparable  <span class="comment">// 内建约束，表示可以用==和!=比较</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复合约束</span></span><br><span class="line"><span class="keyword">type</span> Number <span class="keyword">interface</span> &#123;</span><br><span class="line">    constraints.Integer | constraints.Float</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 带方法的约束</span></span><br><span class="line"><span class="keyword">type</span> Stringer <span class="keyword">interface</span> &#123;</span><br><span class="line">    String() <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 结构化类型约束</span></span><br><span class="line"><span class="keyword">type</span> HasAge <span class="keyword">interface</span> &#123;</span><br><span class="line">    Age() <span class="type">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>泛型使用场景</strong>:</p><ul><li>通用容器类型（栈、队列、树等）</li><li>算法实现（排序、搜索等）</li><li>避免接口+类型断言或反射的性能开销</li><li>减少代码重复</li></ul><p><strong>泛型最佳实践</strong>:</p><ul><li>只在真正需要泛型的地方使用它</li><li>优先使用简单的约束</li><li>提供有意义的类型参数名（如<code>[K, V]</code>用于键值对）</li><li>不要过度设计泛型类型</li></ul><hr><h2 id="八、核心知识点回顾"><a href="#八、核心知识点回顾" class="headerlink" title="八、核心知识点回顾"></a>八、核心知识点回顾</h2><p>以下是Go语言学习过程中的核心知识点总结，作为快速参考和复习使用。</p><h3 id="1-语法与基础结构"><a href="#1-语法与基础结构" class="headerlink" title="1. 语法与基础结构"></a>1. 语法与基础结构</h3><table><thead><tr><th>知识点</th><th>关键要点</th><th>重要度</th></tr></thead><tbody><tr><td>基本语法</td><td>强类型，编译型，垃圾回收，并发支持</td><td>★★★★★</td></tr><tr><td>包管理</td><td>package声明，import导入，go mod管理</td><td>★★★★★</td></tr><tr><td>变量声明</td><td>var声明，:&#x3D;短声明，多变量声明，类型推断</td><td>★★★★★</td></tr><tr><td>基本类型</td><td>int&#x2F;uint, float, string, bool, byte, rune</td><td>★★★★★</td></tr><tr><td>复合类型</td><td>array, slice, map, struct, pointer, interface</td><td>★★★★★</td></tr><tr><td>控制流</td><td>if&#x2F;else, switch, for循环, range</td><td>★★★★★</td></tr></tbody></table><h3 id="2-函数与数据结构"><a href="#2-函数与数据结构" class="headerlink" title="2. 函数与数据结构"></a>2. 函数与数据结构</h3><table><thead><tr><th>知识点</th><th>关键要点</th><th>重要度</th></tr></thead><tbody><tr><td>函数定义</td><td>值传递，多返回值，命名返回值，可变参数</td><td>★★★★★</td></tr><tr><td>方法</td><td>值接收者vs指针接收者，方法集</td><td>★★★★★</td></tr><tr><td>结构体</td><td>字段，嵌套，标签，零值，初始化</td><td>★★★★★</td></tr><tr><td>接口</td><td>隐式实现，空接口，类型断言，接口组合</td><td>★★★★★</td></tr><tr><td>错误处理</td><td>error接口，error wrap&#x2F;unwrap</td><td>★★★★★</td></tr><tr><td>defer</td><td>资源清理，函数结束执行，LIFO顺序</td><td>★★★★☆</td></tr></tbody></table><h3 id="3-并发编程"><a href="#3-并发编程" class="headerlink" title="3. 并发编程"></a>3. 并发编程</h3><table><thead><tr><th>知识点</th><th>关键要点</th><th>重要度</th></tr></thead><tbody><tr><td>goroutine</td><td>轻量级线程，启动方式，生命周期</td><td>★★★★★</td></tr><tr><td>channel</td><td>有缓冲vs无缓冲，关闭通道，range通道</td><td>★★★★★</td></tr><tr><td>select</td><td>多通道操作，超时处理，非阻塞IO</td><td>★★★★★</td></tr><tr><td>sync包</td><td>Mutex, RWMutex, WaitGroup, Once, Map</td><td>★★★★☆</td></tr><tr><td>context</td><td>超时控制，取消操作，值传递</td><td>★★★★★</td></tr><tr><td>竞态检测</td><td>go build&#x2F;test -race，避免数据竞争</td><td>★★★★☆</td></tr></tbody></table><h3 id="4-工程实践"><a href="#4-工程实践" class="headerlink" title="4. 工程实践"></a>4. 工程实践</h3><table><thead><tr><th>知识点</th><th>关键要点</th><th>重要度</th></tr></thead><tbody><tr><td>项目结构</td><td>标准布局，DDD分层，模块化设计</td><td>★★★★☆</td></tr><tr><td>依赖管理</td><td>go.mod, go.sum, replace, 版本管理</td><td>★★★★☆</td></tr><tr><td>测试</td><td>表驱动测试，测试辅助函数，Mock测试</td><td>★★★★☆</td></tr><tr><td>文档</td><td>godoc, 示例测试，pkgsite</td><td>★★★☆☆</td></tr><tr><td>性能</td><td>pprof, trace, benchmark, 内存管理</td><td>★★★★☆</td></tr><tr><td>部署</td><td>交叉编译，Docker容器化，CI&#x2F;CD</td><td>★★★★☆</td></tr></tbody></table><h3 id="5-Web开发"><a href="#5-Web开发" class="headerlink" title="5. Web开发"></a>5. Web开发</h3><table><thead><tr><th>知识点</th><th>关键要点</th><th>重要度</th></tr></thead><tbody><tr><td>net&#x2F;http</td><td>ListenAndServe, Handler接口, ServeMux</td><td>★★★★☆</td></tr><tr><td>中间件</td><td>处理链，装饰器模式，恢复和日志</td><td>★★★★☆</td></tr><tr><td>数据库</td><td>database&#x2F;sql接口，ORM工具，事务处理</td><td>★★★★☆</td></tr><tr><td>API设计</td><td>RESTful, JSON处理，状态码，错误响应</td><td>★★★★☆</td></tr><tr><td>认证授权</td><td>JWT，OAuth2，会话管理</td><td>★★★★☆</td></tr><tr><td>并发模型</td><td>请求处理模型，goroutine管理</td><td>★★★★☆</td></tr></tbody></table><blockquote><p><strong>总结使用提示</strong>：</p><ul><li>重要度从★☆☆☆☆(最低)到★★★★★(最高)，表示在实际项目中的使用频率和重要性</li><li>这些知识点是相互关联的，应综合理解和应用</li><li>定期回顾这些核心知识点，巩固对Go语言的理解</li></ul></blockquote><hr>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Go语言学习总结&quot;&gt;&lt;a href=&quot;#Go语言学习总结&quot; class=&quot;headerlink&quot; title=&quot;Go语言学习总结&quot;&gt;&lt;/a&gt;Go语言学习总结&lt;/h1&gt;&lt;h2 id=&quot;目录&quot;&gt;&lt;a href=&quot;#目录&quot; class=&quot;headerlink&quot; titl</summary>
      
    
    
    
    
    <category term="Golang" scheme="https://aoayaoa.github.io/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>Deno学习记录</title>
    <link href="https://aoayaoa.github.io/2025/04/15/deno%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"/>
    <id>https://aoayaoa.github.io/2025/04/15/deno%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/</id>
    <published>2025-04-14T16:00:00.000Z</published>
    <updated>2025-04-16T02:50:03.343Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Deno学习记录-📘"><a href="#Deno学习记录-📘" class="headerlink" title="Deno学习记录 📘"></a>Deno学习记录 📘</h1><div align="left"><p><img src= "/img/loading.gif" data-lazy-src="https://img.shields.io/badge/Deno-v1.x-black?logo=deno" alt="Deno"><br><img src= "/img/loading.gif" data-lazy-src="https://img.shields.io/badge/TypeScript-v5.x-blue?logo=typescript" alt="TypeScript"><br><img src= "/img/loading.gif" data-lazy-src="https://img.shields.io/badge/MongoDB-v6.x-green?logo=mongodb" alt="MongoDB"><br><img src= "/img/loading.gif" data-lazy-src="https://img.shields.io/badge/Oak-v12.x-lightgrey" alt="Oak"></p><h2 id="📋-目录"><a href="#📋-目录" class="headerlink" title="📋 目录"></a>📋 目录</h2><h3 id="一、Deno基础技术"><a href="#一、Deno基础技术" class="headerlink" title="一、Deno基础技术"></a>一、Deno基础技术</h3><ul><li><a href="#%E9%A1%B9%E7%9B%AE%E6%A6%82%E8%BF%B0">项目概述</a></li><li><a href="#%E6%8A%80%E6%9C%AF%E6%A0%88">技术栈</a></li><li><a href="#deno%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95">Deno基础用法</a></li><li><a href="#%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86">权限管理</a></li><li><a href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4">常用命令</a></li><li><a href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F">环境变量</a></li><li><a href="#%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E5%92%8C%E4%BE%9D%E8%B5%96%E7%AE%A1%E7%90%86">第三方库和依赖管理</a></li><li><a href="#deno%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97">Deno部署指南</a></li></ul><h3 id="二、项目具体实现"><a href="#二、项目具体实现" class="headerlink" title="二、项目具体实现"></a>二、项目具体实现</h3><ul><li><a href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84">项目结构</a></li><li><a href="#api%E8%B7%AF%E7%94%B1">API路由</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B">数据模型</a></li><li><a href="#mongodb%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C">MongoDB数据库操作</a></li><li><a href="#mbti%E6%B5%8B%E8%AF%95%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82">MBTI测试实现细节</a></li></ul><h3 id="三、最佳实践和扩展"><a href="#三、最佳实践和扩展" class="headerlink" title="三、最佳实践和扩展"></a>三、最佳实践和扩展</h3><ul><li><a href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%E5%92%8C%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">注意事项和最佳实践</a></li><li><a href="#%E5%89%8D%E7%AB%AF%E5%B1%95%E7%A4%BA%E4%B8%8Eui%E4%BC%98%E5%8C%96">前端展示与UI优化</a></li><li><a href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5">常见问题排查</a></li><li><a href="#%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83">代码规范</a></li><li><a href="#%E6%89%A9%E5%B1%95%E5%92%8C%E6%94%B9%E8%BF%9B">扩展和改进</a></li><li><a href="#%E8%B5%84%E6%BA%90%E9%93%BE%E6%8E%A5">资源链接</a></li></ul><hr><h2 id="🚀-项目概述"><a href="#🚀-项目概述" class="headerlink" title="🚀 项目概述"></a>🚀 项目概述</h2><p>这是一个基于Deno运行时的后端服务项目，主要功能包括MBTI人格测试系统。项目采用TypeScript语言开发，使用Oak HTTP服务器框架处理HTTP请求，MongoDB作为数据存储解决方案。</p><hr><h2 id="💻-技术栈"><a href="#💻-技术栈" class="headerlink" title="💻 技术栈"></a>💻 技术栈</h2><table><thead><tr><th>分类</th><th>技术</th><th>描述</th></tr></thead><tbody><tr><td><strong>运行时环境</strong></td><td>Deno</td><td>安全的JavaScript和TypeScript运行时</td></tr><tr><td><strong>语言</strong></td><td>TypeScript</td><td>带有类型系统的JavaScript超集</td></tr><tr><td><strong>HTTP服务器框架</strong></td><td>Oak</td><td>受Koa启发的Deno中间件框架</td></tr><tr><td><strong>数据库</strong></td><td>MongoDB</td><td>NoSQL文档数据库</td></tr><tr><td><strong>ODM</strong></td><td>Mongoose</td><td>MongoDB对象模型工具</td></tr><tr><td><strong>API文档</strong></td><td>暂无</td><td>可考虑添加Swagger</td></tr><tr><td><strong>测试框架</strong></td><td>Deno内置测试工具</td><td>Deno自带的测试功能</td></tr></tbody></table><hr><h2 id="🛠️-环境准备"><a href="#🛠️-环境准备" class="headerlink" title="🛠️ 环境准备"></a>🛠️ 环境准备</h2><p>在开始项目之前，请准备以下环境：</p><h3 id="1-安装Deno"><a href="#1-安装Deno" class="headerlink" title="1. 安装Deno"></a>1. 安装Deno</h3><p>Deno 是一个现代的JavaScript和TypeScript运行时环境。推荐使用以下命令安装：</p><table><thead><tr><th>操作系统</th><th>命令</th></tr></thead><tbody><tr><td>macOS &#x2F; Linux</td><td>`curl -fsSL <a href="https://deno.land/install.sh">https://deno.land/install.sh</a></td></tr><tr><td>Windows</td><td>`irm <a href="https://deno.land/install.ps1">https://deno.land/install.ps1</a></td></tr></tbody></table><p>验证安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deno --version</span><br></pre></td></tr></table></figure><blockquote><p><strong>注</strong>：更多安装选项（如Homebrew）请参考 Deno安装指南。</p></blockquote><h3 id="2-安装MongoDB"><a href="#2-安装MongoDB" class="headerlink" title="2. 安装MongoDB"></a>2. 安装MongoDB</h3><p>项目使用 MongoDB 作为数据库。您可以选择本地安装或使用Docker。</p><h4 id="2-1-本地安装MongoDB"><a href="#2-1-本地安装MongoDB" class="headerlink" title="2.1 本地安装MongoDB"></a>2.1 本地安装MongoDB</h4><p>请访问 MongoDB安装指南 安装。启动服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod</span><br></pre></td></tr></table></figure><h4 id="2-2-使用Docker运行MongoDB"><a href="#2-2-使用Docker运行MongoDB" class="headerlink" title="2.2 使用Docker运行MongoDB"></a>2.2 使用Docker运行MongoDB</h4><p>运行以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 27017:27017 --name mongodb mongo:latest</span><br></pre></td></tr></table></figure><h2 id="🦕-Deno基础用法"><a href="#🦕-Deno基础用法" class="headerlink" title="🦕 Deno基础用法"></a>🦕 Deno基础用法</h2><h2 id="⚡-常用命令"><a href="#⚡-常用命令" class="headerlink" title="⚡ 常用命令"></a>⚡ 常用命令</h2><p>项目中定义了多个Deno任务，可以通过<code>deno task &lt;task_name&gt;</code>执行：</p><table><thead><tr><th>命令</th><th>描述</th></tr></thead><tbody><tr><td><code>deno task dev</code></td><td>开发模式启动</td></tr><tr><td><code>deno task start</code></td><td>生产模式启动</td></tr><tr><td><code>deno task hot-reload</code></td><td>热重载模式</td></tr><tr><td><code>deno task test</code></td><td>运行测试</td></tr><tr><td><code>deno task mongo:init</code></td><td>初始化MongoDB</td></tr><tr><td><code>deno task mongo:generate-mbti</code></td><td>生成MBTI测试数据</td></tr><tr><td><code>deno run task -- watch</code></td><td>监听文件变化</td></tr></tbody></table><h3 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h3><h4 id="读取文件"><a href="#读取文件" class="headerlink" title="读取文件"></a>读取文件</h4><p>Deno提供了简单直观的文件API：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 同步读取文件</span></span><br><span class="line"><span class="keyword">const</span> text = <span class="title class_">Deno</span>.<span class="title function_">readTextFileSync</span>(<span class="string">&quot;./data/config.json&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(text);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 异步读取文件</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> text = <span class="keyword">await</span> <span class="title class_">Deno</span>.<span class="title function_">readTextFile</span>(<span class="string">&quot;./data/users.json&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> users = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(text);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(users);</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;读取文件失败:&quot;</span>, error);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取二进制文件</span></span><br><span class="line"><span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title class_">Deno</span>.<span class="title function_">readFile</span>(<span class="string">&quot;./assets/image.png&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="写入文件"><a href="#写入文件" class="headerlink" title="写入文件"></a>写入文件</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 同步写入文本文件</span></span><br><span class="line"><span class="keyword">const</span> data = &#123; <span class="attr">name</span>: <span class="string">&quot;Test User&quot;</span>, <span class="attr">email</span>: <span class="string">&quot;test@example.com&quot;</span> &#125;;</span><br><span class="line"><span class="title class_">Deno</span>.<span class="title function_">writeTextFileSync</span>(<span class="string">&quot;./data/user.json&quot;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data, <span class="literal">null</span>, <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 异步写入文件</span></span><br><span class="line"><span class="keyword">await</span> <span class="title class_">Deno</span>.<span class="title function_">writeTextFile</span>(<span class="string">&quot;./logs/app.log&quot;</span>, <span class="string">`[<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().toISOString()&#125;</span>] Server started\n`</span>, &#123; <span class="attr">append</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写入二进制文件</span></span><br><span class="line"><span class="keyword">await</span> <span class="title class_">Deno</span>.<span class="title function_">writeFile</span>(<span class="string">&quot;./output/data.bin&quot;</span>, <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]));</span><br></pre></td></tr></table></figure><h4 id="文件操作工具函数"><a href="#文件操作工具函数" class="headerlink" title="文件操作工具函数"></a>文件操作工具函数</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断文件是否存在</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fileExists</span>(<span class="params"><span class="attr">path</span>: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">Deno</span>.<span class="title function_">stat</span>(path);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="keyword">if</span> (error <span class="keyword">instanceof</span> <span class="title class_">Deno</span>.<span class="property">errors</span>.<span class="property">NotFound</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> error;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建目录（如果不存在）</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">ensureDir</span>(<span class="params"><span class="attr">dir</span>: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> fileInfo = <span class="keyword">await</span> <span class="title class_">Deno</span>.<span class="title function_">stat</span>(dir);</span><br><span class="line">    <span class="keyword">if</span> (!fileInfo.<span class="property">isDirectory</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`路径存在但不是目录: <span class="subst">$&#123;dir&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="keyword">if</span> (error <span class="keyword">instanceof</span> <span class="title class_">Deno</span>.<span class="property">errors</span>.<span class="property">NotFound</span>) &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="title class_">Deno</span>.<span class="title function_">mkdir</span>(dir, &#123; <span class="attr">recursive</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> error;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="处理静态资源"><a href="#处理静态资源" class="headerlink" title="处理静态资源"></a>处理静态资源</h3><p>在Oak HTTP服务器框架中使用静态文件中间件：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Application</span>, <span class="title class_">Router</span> &#125; <span class="keyword">from</span> <span class="string">&quot;oak&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; send &#125; <span class="keyword">from</span> <span class="string">&quot;https://deno.land/x/oak@v12.6.1/send.ts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Application</span>();</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 静态文件处理中间件</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 处理静态文件请求</span></span><br><span class="line">    <span class="keyword">if</span> (ctx.<span class="property">request</span>.<span class="property">url</span>.<span class="property">pathname</span>.<span class="title function_">startsWith</span>(<span class="string">&quot;/static&quot;</span>)) &#123;</span><br><span class="line">      <span class="keyword">const</span> path = ctx.<span class="property">request</span>.<span class="property">url</span>.<span class="property">pathname</span>.<span class="title function_">replace</span>(<span class="string">&quot;/static&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">send</span>(ctx, path, &#123;</span><br><span class="line">        <span class="attr">root</span>: <span class="string">`<span class="subst">$&#123;Deno.cwd()&#125;</span>/public`</span>,</span><br><span class="line">        <span class="attr">index</span>: <span class="string">&quot;index.html&quot;</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="keyword">if</span> (err.<span class="property">status</span> !== <span class="number">404</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义静态文件服务函数</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">serveStaticFile</span>(<span class="params"><span class="attr">ctx</span>: <span class="title class_">Context</span>, <span class="attr">filePath</span>: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> fullPath = <span class="string">`<span class="subst">$&#123;Deno.cwd()&#125;</span>/public/<span class="subst">$&#123;filePath&#125;</span>`</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查文件是否存在</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="title class_">Deno</span>.<span class="title function_">stat</span>(fullPath);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="keyword">if</span> (error <span class="keyword">instanceof</span> <span class="title class_">Deno</span>.<span class="property">errors</span>.<span class="property">NotFound</span>) &#123;</span><br><span class="line">        ctx.<span class="property">response</span>.<span class="property">status</span> = <span class="number">404</span>;</span><br><span class="line">        ctx.<span class="property">response</span>.<span class="property">body</span> = &#123; <span class="attr">error</span>: <span class="string">&quot;File not found&quot;</span> &#125;;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">throw</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置内容类型</span></span><br><span class="line">    <span class="keyword">let</span> contentType = <span class="string">&quot;application/octet-stream&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (filePath.<span class="title function_">endsWith</span>(<span class="string">&quot;.html&quot;</span>)) contentType = <span class="string">&quot;text/html&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (filePath.<span class="title function_">endsWith</span>(<span class="string">&quot;.css&quot;</span>)) contentType = <span class="string">&quot;text/css&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (filePath.<span class="title function_">endsWith</span>(<span class="string">&quot;.js&quot;</span>)) contentType = <span class="string">&quot;text/javascript&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (filePath.<span class="title function_">endsWith</span>(<span class="string">&quot;.json&quot;</span>)) contentType = <span class="string">&quot;application/json&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (filePath.<span class="title function_">endsWith</span>(<span class="string">&quot;.png&quot;</span>)) contentType = <span class="string">&quot;image/png&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (filePath.<span class="title function_">endsWith</span>(<span class="string">&quot;.jpg&quot;</span>) || filePath.<span class="title function_">endsWith</span>(<span class="string">&quot;.jpeg&quot;</span>)) contentType = <span class="string">&quot;image/jpeg&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 读取并发送文件</span></span><br><span class="line">    <span class="keyword">const</span> content = <span class="keyword">await</span> <span class="title class_">Deno</span>.<span class="title function_">readFile</span>(fullPath);</span><br><span class="line">    ctx.<span class="property">response</span>.<span class="property">headers</span>.<span class="title function_">set</span>(<span class="string">&quot;Content-Type&quot;</span>, contentType);</span><br><span class="line">    ctx.<span class="property">response</span>.<span class="property">body</span> = content;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`提供静态文件失败: <span class="subst">$&#123;filePath&#125;</span>`</span>, error);</span><br><span class="line">    ctx.<span class="property">response</span>.<span class="property">status</span> = <span class="number">500</span>;</span><br><span class="line">    ctx.<span class="property">response</span>.<span class="property">body</span> = &#123; <span class="attr">error</span>: <span class="string">&quot;Internal server error&quot;</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/images/:filename&quot;</span>, <span class="title function_">async</span> (ctx) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> filename = ctx.<span class="property">params</span>.<span class="property">filename</span>;</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">serveStaticFile</span>(ctx, <span class="string">`images/<span class="subst">$&#123;filename&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="使用Web标准API"><a href="#使用Web标准API" class="headerlink" title="使用Web标准API"></a>使用Web标准API</h3><p>Deno使用Web标准API进行开发，无需额外的库：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用fetch API发起网络请求</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchData</span>(<span class="params"><span class="attr">url</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(url);</span><br><span class="line">    <span class="keyword">if</span> (!response.<span class="property">ok</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`HTTP错误: <span class="subst">$&#123;response.status&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;请求失败:&quot;</span>, error);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用URL API解析URL</span></span><br><span class="line"><span class="keyword">const</span> url = <span class="keyword">new</span> <span class="title function_">URL</span>(<span class="string">&quot;https://example.com/api/users?page=1&amp;limit=10&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(url.<span class="property">searchParams</span>.<span class="title function_">get</span>(<span class="string">&quot;page&quot;</span>)); <span class="comment">// &quot;1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用EventTarget</span></span><br><span class="line"><span class="keyword">const</span> target = <span class="keyword">new</span> <span class="title class_">EventTarget</span>();</span><br><span class="line">target.<span class="title function_">addEventListener</span>(<span class="string">&quot;message&quot;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;收到消息:&quot;</span>, event.<span class="property">detail</span>);</span><br><span class="line">&#125;);</span><br><span class="line">target.<span class="title function_">dispatchEvent</span>(<span class="keyword">new</span> <span class="title class_">CustomEvent</span>(<span class="string">&quot;message&quot;</span>, &#123; <span class="attr">detail</span>: <span class="string">&quot;Hello Deno!&quot;</span> &#125;));</span><br></pre></td></tr></table></figure><h3 id="使用Web-Worker"><a href="#使用Web-Worker" class="headerlink" title="使用Web Worker"></a>使用Web Worker</h3><p>Deno支持多线程处理：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.ts</span></span><br><span class="line"><span class="comment">// 创建Web Worker</span></span><br><span class="line"><span class="keyword">const</span> worker = <span class="keyword">new</span> <span class="title class_">Worker</span>(<span class="keyword">new</span> <span class="title function_">URL</span>(<span class="string">&quot;./worker.ts&quot;</span>, <span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">url</span>).<span class="property">href</span>, &#123; <span class="attr">type</span>: <span class="string">&quot;module&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送消息到Worker</span></span><br><span class="line">worker.<span class="title function_">postMessage</span>(&#123; <span class="attr">type</span>: <span class="string">&quot;process&quot;</span>, <span class="attr">data</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>] &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理Worker返回的消息</span></span><br><span class="line">worker.<span class="property">onmessage</span> = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Worker结果:&quot;</span>, e.<span class="property">data</span>);</span><br><span class="line">  <span class="comment">// 完成后终止Worker</span></span><br><span class="line">  worker.<span class="title function_">terminate</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// worker.ts</span></span><br><span class="line"><span class="comment">// 接收并处理主线程消息</span></span><br><span class="line">self.<span class="property">onmessage</span> = <span class="title function_">async</span> (e) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="keyword">type</span>, data &#125; = e.<span class="property">data</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">type</span> === <span class="string">&quot;process&quot;</span>) &#123;</span><br><span class="line">    <span class="comment">// 执行耗时操作</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">processData</span>(data);</span><br><span class="line">    <span class="comment">// 返回结果给主线程</span></span><br><span class="line">    self.<span class="title function_">postMessage</span>(result);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">processData</span>(<span class="params"><span class="attr">numbers</span>: <span class="built_in">number</span>[]</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">number</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// 模拟耗时计算</span></span><br><span class="line">  <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(resolve, <span class="number">1000</span>));</span><br><span class="line">  <span class="keyword">return</span> numbers.<span class="title function_">reduce</span>(<span class="function">(<span class="params">sum, num</span>) =&gt;</span> sum + num, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="执行Shell命令"><a href="#执行Shell命令" class="headerlink" title="执行Shell命令"></a>执行Shell命令</h3><p>Deno提供API执行子进程：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 简单命令执行</span></span><br><span class="line"><span class="keyword">const</span> process = <span class="title class_">Deno</span>.<span class="title function_">run</span>(&#123;</span><br><span class="line">  <span class="attr">cmd</span>: [<span class="string">&quot;ls&quot;</span>, <span class="string">&quot;-la&quot;</span>],</span><br><span class="line">  <span class="attr">stdout</span>: <span class="string">&quot;piped&quot;</span>,</span><br><span class="line">  <span class="attr">stderr</span>: <span class="string">&quot;piped&quot;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 等待命令完成并获取输出</span></span><br><span class="line"><span class="keyword">const</span> &#123; code &#125; = <span class="keyword">await</span> process.<span class="title function_">status</span>();</span><br><span class="line"><span class="keyword">if</span> (code === <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> output = <span class="keyword">await</span> process.<span class="title function_">output</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">new</span> <span class="title class_">TextDecoder</span>().<span class="title function_">decode</span>(output));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> errorOutput = <span class="keyword">await</span> process.<span class="title function_">stderrOutput</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="keyword">new</span> <span class="title class_">TextDecoder</span>().<span class="title function_">decode</span>(errorOutput));</span><br><span class="line">&#125;</span><br><span class="line">process.<span class="title function_">close</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 传递环境变量</span></span><br><span class="line"><span class="keyword">const</span> process = <span class="title class_">Deno</span>.<span class="title function_">run</span>(&#123;</span><br><span class="line">  <span class="attr">cmd</span>: [<span class="string">&quot;printenv&quot;</span>, <span class="string">&quot;MY_VARIABLE&quot;</span>],</span><br><span class="line">  <span class="attr">env</span>: &#123; <span class="string">&quot;MY_VARIABLE&quot;</span>: <span class="string">&quot;Hello Deno!&quot;</span> &#125;,</span><br><span class="line">  <span class="attr">stdout</span>: <span class="string">&quot;piped&quot;</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="使用WebSocket"><a href="#使用WebSocket" class="headerlink" title="使用WebSocket"></a>使用WebSocket</h3><p>Deno支持WebSocket进行实时通信：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 服务端WebSocket</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Application</span> &#125; <span class="keyword">from</span> <span class="string">&quot;oak&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Server</span> &#125; <span class="keyword">from</span> <span class="string">&quot;https://deno.land/std@0.196.0/http/server.ts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">WebSocketServer</span> &#125; <span class="keyword">from</span> <span class="string">&quot;https://deno.land/x/websocket@v0.1.4/mod.ts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建WebSocket服务器</span></span><br><span class="line"><span class="keyword">const</span> wss = <span class="keyword">new</span> <span class="title class_">WebSocketServer</span>(&#123; <span class="attr">port</span>: <span class="number">8080</span> &#125;);</span><br><span class="line"></span><br><span class="line">wss.<span class="title function_">on</span>(<span class="string">&quot;connection&quot;</span>, <span class="function">(<span class="params">ws</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;新客户端连接&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 处理消息</span></span><br><span class="line">  ws.<span class="title function_">on</span>(<span class="string">&quot;message&quot;</span>, <span class="function">(<span class="params">message</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;收到消息:&quot;</span>, message);</span><br><span class="line">    <span class="comment">// 广播消息给所有客户端</span></span><br><span class="line">    wss.<span class="property">clients</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">client</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (client.<span class="property">readyState</span> === <span class="title class_">WebSocket</span>.<span class="property">OPEN</span>) &#123;</span><br><span class="line">        client.<span class="title function_">send</span>(<span class="string">`服务器时间: <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().toISOString()&#125;</span>, 消息: <span class="subst">$&#123;message&#125;</span>`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 处理连接关闭</span></span><br><span class="line">  ws.<span class="title function_">on</span>(<span class="string">&quot;close&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;客户端断开连接&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端WebSocket</span></span><br><span class="line"><span class="keyword">const</span> socket = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&quot;ws://localhost:8080&quot;</span>);</span><br><span class="line"></span><br><span class="line">socket.<span class="property">onopen</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;连接已建立&quot;</span>);</span><br><span class="line">  socket.<span class="title function_">send</span>(<span class="string">&quot;Hello Server!&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">socket.<span class="property">onmessage</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;收到消息:&quot;</span>, event.<span class="property">data</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">socket.<span class="property">onclose</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;连接已关闭&quot;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><hr><h2 id="🔐-环境变量"><a href="#🔐-环境变量" class="headerlink" title="🔐 环境变量"></a>🔐 环境变量</h2><p>项目通过<code>.env</code>文件和<code>Deno.env.get()</code>方法管理环境变量：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MONGODB_URI=mongodb://[username]:[password]@[host]/</span><br><span class="line">MONGODB_DATABASE=database_name</span><br></pre></td></tr></table></figure><blockquote><p>⚠️ <strong>警告</strong>: 切勿将包含敏感信息的.env文件提交到版本控制系统。</p></blockquote><hr><h2 id="🛡️-权限管理"><a href="#🛡️-权限管理" class="headerlink" title="🛡️ 权限管理"></a>🛡️ 权限管理</h2><p>Deno需要明确的权限才能访问系统资源：</p><table><thead><tr><th>权限标志</th><th>描述</th></tr></thead><tbody><tr><td><code>--allow-net</code></td><td>网络访问权限</td></tr><tr><td><code>--allow-env</code></td><td>环境变量访问权限</td></tr><tr><td><code>--allow-read</code></td><td>文件读取权限</td></tr><tr><td><code>--allow-write</code></td><td>文件写入权限</td></tr><tr><td><code>--allow-sys</code></td><td>系统信息访问权限</td></tr></tbody></table><p>在<code>deno.json</code>中，这些权限已通过task配置进行预设。</p><hr><h2 id="📦-第三方库和依赖管理"><a href="#📦-第三方库和依赖管理" class="headerlink" title="📦 第三方库和依赖管理"></a>📦 第三方库和依赖管理</h2><h3 id="常用第三方库"><a href="#常用第三方库" class="headerlink" title="常用第三方库"></a>常用第三方库</h3><table><thead><tr><th>库名</th><th>来源</th><th>作用</th><th>用法示例</th></tr></thead><tbody><tr><td><strong>Oak</strong></td><td>JSR</td><td>HTTP服务器框架</td><td><code>import &#123; Application &#125; from &quot;oak&quot;;</code></td></tr><tr><td><strong>Mongoose</strong></td><td>npm</td><td>MongoDB对象建模工具</td><td><code>import mongoose from &quot;mongoose&quot;;</code></td></tr><tr><td><strong>Zod</strong></td><td>npm</td><td>类型验证库</td><td><code>import &#123; z &#125; from &quot;zod&quot;;</code></td></tr><tr><td><strong>std&#x2F;assert</strong></td><td>JSR</td><td>断言库</td><td><code>import &#123; assertEquals &#125; from &quot;@std/assert&quot;;</code></td></tr><tr><td><strong>cliffy</strong></td><td>deno.land</td><td>CLI框架和工具</td><td><code>import &#123; Command &#125; from &quot;cliffy&quot;;</code></td></tr><tr><td><strong>Fresh</strong></td><td>JSR</td><td>Web框架</td><td><code>import &#123; defineConfig &#125; from &quot;fresh&quot;;</code></td></tr><tr><td><strong>MD5</strong></td><td>npm</td><td>哈希加密算法</td><td><code>import md5 from &quot;md5&quot;;</code></td></tr><tr><td><strong>AJV</strong></td><td>esm.sh</td><td>JSON Schema验证器</td><td><code>import Ajv from &quot;ajv&quot;;</code></td></tr><tr><td><strong>JWT</strong></td><td>deno.land</td><td>JSON Web Token处理</td><td><code>import &#123; create, verify &#125; from &quot;djwt&quot;;</code></td></tr></tbody></table><h3 id="数据验证与安全相关库"><a href="#数据验证与安全相关库" class="headerlink" title="数据验证与安全相关库"></a>数据验证与安全相关库</h3><h4 id="1-AJV-和-JSON-Schema"><a href="#1-AJV-和-JSON-Schema" class="headerlink" title="1. AJV 和 JSON Schema"></a>1. AJV 和 JSON Schema</h4><p><a href="https://ajv.js.org/">AJV</a>是一个高性能的JSON Schema验证器，用于验证数据结构是否符合预定义的模式：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Ajv</span> <span class="keyword">from</span> <span class="string">&quot;ajv&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> addFormats <span class="keyword">from</span> <span class="string">&quot;ajv-formats&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化AJV</span></span><br><span class="line"><span class="keyword">const</span> ajv = <span class="keyword">new</span> <span class="title class_">Ajv</span>(&#123;</span><br><span class="line">  <span class="attr">allErrors</span>: <span class="literal">true</span>,      <span class="comment">// 报告所有错误（而不是第一个）</span></span><br><span class="line">  <span class="attr">removeAdditional</span>: <span class="literal">true</span>, <span class="comment">// 删除schema中未定义的属性</span></span><br><span class="line">  <span class="attr">useDefaults</span>: <span class="literal">true</span>     <span class="comment">// 使用模式中定义的默认值</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加格式验证</span></span><br><span class="line"><span class="title function_">addFormats</span>(ajv);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义JSON Schema</span></span><br><span class="line"><span class="keyword">const</span> userSchema = &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">  <span class="attr">properties</span>: &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123; <span class="attr">type</span>: <span class="string">&quot;string&quot;</span> &#125;,</span><br><span class="line">    <span class="attr">name</span>: &#123; <span class="attr">type</span>: <span class="string">&quot;string&quot;</span>, <span class="attr">minLength</span>: <span class="number">2</span> &#125;,</span><br><span class="line">    <span class="attr">email</span>: &#123; <span class="attr">type</span>: <span class="string">&quot;string&quot;</span>, <span class="attr">format</span>: <span class="string">&quot;email&quot;</span> &#125;,</span><br><span class="line">    <span class="attr">age</span>: &#123; <span class="attr">type</span>: <span class="string">&quot;number&quot;</span>, <span class="attr">minimum</span>: <span class="number">0</span> &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">required</span>: [<span class="string">&quot;id&quot;</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;email&quot;</span>],</span><br><span class="line">  <span class="attr">additionalProperties</span>: <span class="literal">false</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 编译schema以便重复使用</span></span><br><span class="line"><span class="keyword">const</span> validateUser = ajv.<span class="title function_">compile</span>(userSchema);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用封装的验证工具</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">validateData</span>(<span class="params"><span class="attr">data</span>: <span class="built_in">unknown</span>, <span class="attr">schema</span>: <span class="built_in">object</span></span>): &#123; <span class="attr">isValid</span>: <span class="built_in">boolean</span>; <span class="attr">errors</span>: <span class="built_in">any</span>[] &#125; &#123;</span><br><span class="line">  <span class="keyword">const</span> validate = ajv.<span class="title function_">compile</span>(schema);</span><br><span class="line">  <span class="keyword">const</span> isValid = <span class="title function_">validate</span>(data);</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    isValid,</span><br><span class="line">    <span class="attr">errors</span>: isValid ? [] : (validate.<span class="property">errors</span> || [])</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例使用</span></span><br><span class="line"><span class="keyword">const</span> result = <span class="title function_">validateData</span>(userData, userSchema);</span><br><span class="line"><span class="keyword">if</span> (!result.<span class="property">isValid</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;数据验证失败:&quot;</span>, result.<span class="property">errors</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>最佳实践：</strong></p><ul><li>集中管理所有JSON Schema定义</li><li>为复杂API创建可重用的验证函数</li><li>使用AJV的自定义关键字和格式拓展特定需求</li><li>在API端点处理前验证请求数据</li></ul><h4 id="2-MD5"><a href="#2-MD5" class="headerlink" title="2. MD5"></a>2. MD5</h4><p>MD5是一种广泛使用的哈希算法，在项目中常用于密码加密或生成唯一标识符：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> md5 <span class="keyword">from</span> <span class="string">&quot;md5&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基本使用</span></span><br><span class="line"><span class="keyword">const</span> hash = <span class="title function_">md5</span>(<span class="string">&quot;some-string&quot;</span>); <span class="comment">// 返回32字符的哈希字符串</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于密码加密（推荐添加盐值）</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hashPassword</span>(<span class="params"><span class="attr">password</span>: <span class="built_in">string</span>, <span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">md5</span>(password + salt);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于生成API请求签名</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">generateSignature</span>(<span class="params"><span class="attr">params</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;, <span class="attr">secretKey</span>: <span class="built_in">string</span></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="comment">// 按字母顺序排序参数</span></span><br><span class="line">  <span class="keyword">const</span> sortedKeys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(params).<span class="title function_">sort</span>();</span><br><span class="line">  <span class="keyword">let</span> signStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 构建签名字符串</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">of</span> sortedKeys) &#123;</span><br><span class="line">    signStr += <span class="string">`<span class="subst">$&#123;key&#125;</span>=<span class="subst">$&#123;params[key]&#125;</span>&amp;`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 添加密钥并生成最终签名</span></span><br><span class="line">  signStr += secretKey;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">md5</span>(signStr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>安全提示：</strong></p><ul><li>⚠️ MD5不再被认为是安全的密码哈希算法</li><li>对于密码存储，推荐使用更安全的算法如bcrypt或Argon2</li><li>MD5适用于非安全场景如缓存键生成、内容完整性校验等</li></ul><h4 id="3-JWT-JSON-Web-Token"><a href="#3-JWT-JSON-Web-Token" class="headerlink" title="3. JWT (JSON Web Token)"></a>3. JWT (JSON Web Token)</h4><p>JWT用于创建和验证令牌，常用于身份验证和授权：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; create, verify, decode &#125; <span class="keyword">from</span> <span class="string">&quot;djwt&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; crypto &#125; <span class="keyword">from</span> <span class="string">&quot;std/crypto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成密钥</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">generateKey</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">CryptoKey</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> crypto.<span class="property">subtle</span>.<span class="title function_">generateKey</span>(</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&quot;HMAC&quot;</span>, <span class="attr">hash</span>: <span class="string">&quot;SHA-512&quot;</span> &#125;,</span><br><span class="line">    <span class="literal">true</span>,</span><br><span class="line">    [<span class="string">&quot;sign&quot;</span>, <span class="string">&quot;verify&quot;</span>]</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建JWT令牌</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createToken</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">payload</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt;, </span></span><br><span class="line"><span class="params">  <span class="attr">expiresIn</span>: <span class="built_in">number</span> = <span class="number">60</span> * <span class="number">60</span> <span class="comment">// 1小时，以秒为单位</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> key = <span class="keyword">await</span> <span class="title function_">generateKey</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> jwt = <span class="keyword">await</span> <span class="title function_">create</span>(</span><br><span class="line">    &#123; <span class="attr">alg</span>: <span class="string">&quot;HS512&quot;</span>, <span class="attr">typ</span>: <span class="string">&quot;JWT&quot;</span> &#125;,</span><br><span class="line">    &#123; </span><br><span class="line">      ...payload, </span><br><span class="line">      <span class="attr">exp</span>: <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Date</span>.<span class="title function_">now</span>() / <span class="number">1000</span>) + expiresIn </span><br><span class="line">    &#125;,</span><br><span class="line">    key</span><br><span class="line">  );</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> jwt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证JWT令牌</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">verifyToken</span>(<span class="params"><span class="attr">token</span>: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt; | <span class="literal">null</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> key = <span class="keyword">await</span> <span class="title function_">generateKey</span>(); <span class="comment">// 生产环境中应该重用密钥</span></span><br><span class="line">    <span class="keyword">const</span> payload = <span class="keyword">await</span> <span class="title function_">verify</span>(token, key);</span><br><span class="line">    <span class="keyword">return</span> payload;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;JWT验证失败:&quot;</span>, err);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> userToken = <span class="keyword">await</span> <span class="title function_">createToken</span>(&#123; <span class="attr">userId</span>: <span class="string">&quot;123&quot;</span>, <span class="attr">role</span>: <span class="string">&quot;admin&quot;</span> &#125;);</span><br><span class="line"><span class="comment">// 在请求头中使用: Authorization: Bearer &lt;token&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 身份验证中间件</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">authMiddleware</span>(<span class="params"><span class="attr">ctx</span>: <span class="title class_">Context</span>, <span class="attr">next</span>: <span class="title class_">Next</span></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> authHeader = ctx.<span class="property">request</span>.<span class="property">headers</span>.<span class="title function_">get</span>(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!authHeader || !authHeader.<span class="title function_">startsWith</span>(<span class="string">&quot;Bearer &quot;</span>)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;缺少有效的授权令牌&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> token = authHeader.<span class="title function_">replace</span>(<span class="string">&quot;Bearer &quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> payload = <span class="keyword">await</span> <span class="title function_">verifyToken</span>(token);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!payload) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;无效的令牌&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将用户信息附加到上下文</span></span><br><span class="line">    ctx.<span class="property">state</span>.<span class="property">user</span> = payload;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    ctx.<span class="property">response</span>.<span class="property">status</span> = <span class="number">401</span>;</span><br><span class="line">    ctx.<span class="property">response</span>.<span class="property">body</span> = &#123;</span><br><span class="line">      <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">code</span>: <span class="number">401</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&quot;未授权访问&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>JWT最佳实践：</strong></p><ul><li>设置合理的过期时间，避免令牌永久有效</li><li>仅在令牌中存储必要信息，避免存储敏感数据</li><li>使用HTTPS传输令牌</li><li>实现令牌刷新机制</li><li>考虑使用Redis等存储机制来支持令牌吊销</li></ul><h3 id="实际应用示例"><a href="#实际应用示例" class="headerlink" title="实际应用示例"></a>实际应用示例</h3><h4 id="JSON-Schema用于API验证"><a href="#JSON-Schema用于API验证" class="headerlink" title="JSON Schema用于API验证"></a>JSON Schema用于API验证</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/schemas/user.schema.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> createUserSchema = &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">  <span class="attr">properties</span>: &#123;</span><br><span class="line">    <span class="attr">username</span>: &#123; <span class="attr">type</span>: <span class="string">&quot;string&quot;</span>, <span class="attr">minLength</span>: <span class="number">3</span>, <span class="attr">maxLength</span>: <span class="number">20</span> &#125;,</span><br><span class="line">    <span class="attr">email</span>: &#123; <span class="attr">type</span>: <span class="string">&quot;string&quot;</span>, <span class="attr">format</span>: <span class="string">&quot;email&quot;</span> &#125;,</span><br><span class="line">    <span class="attr">password</span>: &#123; <span class="attr">type</span>: <span class="string">&quot;string&quot;</span>, <span class="attr">minLength</span>: <span class="number">8</span> &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">required</span>: [<span class="string">&quot;username&quot;</span>, <span class="string">&quot;email&quot;</span>, <span class="string">&quot;password&quot;</span>],</span><br><span class="line">  <span class="attr">additionalProperties</span>: <span class="literal">false</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// src/middlewares/validate.middleware.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Context</span>, <span class="title class_">Next</span> &#125; <span class="keyword">from</span> <span class="string">&quot;oak&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; validateSchema &#125; <span class="keyword">from</span> <span class="string">&quot;../utils/json-schema.ts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">validateRequest</span>(<span class="params"><span class="attr">schema</span>: <span class="built_in">object</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">async</span> (<span class="attr">ctx</span>: <span class="title class_">Context</span>, <span class="attr">next</span>: <span class="title class_">Next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> body = <span class="keyword">await</span> ctx.<span class="property">request</span>.<span class="title function_">body</span>().<span class="property">value</span>;</span><br><span class="line">      <span class="keyword">const</span> &#123; isValid, errors &#125; = <span class="title function_">validateSchema</span>(body, schema);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (!isValid) &#123;</span><br><span class="line">        ctx.<span class="property">response</span>.<span class="property">status</span> = <span class="number">400</span>;</span><br><span class="line">        ctx.<span class="property">response</span>.<span class="property">body</span> = &#123;</span><br><span class="line">          <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">code</span>: <span class="number">400</span>,</span><br><span class="line">          <span class="attr">message</span>: <span class="string">&quot;请求数据验证失败&quot;</span>,</span><br><span class="line">          <span class="attr">errors</span>: errors</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      ctx.<span class="property">response</span>.<span class="property">status</span> = <span class="number">400</span>;</span><br><span class="line">      ctx.<span class="property">response</span>.<span class="property">body</span> = &#123;</span><br><span class="line">        <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">code</span>: <span class="number">400</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&quot;无效的请求数据&quot;</span></span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由中使用验证中间件</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/api/users&quot;</span>, <span class="title function_">validateRequest</span>(createUserSchema), userController.<span class="property">createUser</span>);</span><br></pre></td></tr></table></figure><h4 id="MD5用于生成唯一标识符"><a href="#MD5用于生成唯一标识符" class="headerlink" title="MD5用于生成唯一标识符"></a>MD5用于生成唯一标识符</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生成测试ID</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">generateTestId</span>(<span class="params"><span class="attr">userId</span>: <span class="built_in">string</span>, <span class="attr">timestamp</span>: <span class="built_in">number</span></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">md5</span>(<span class="string">`<span class="subst">$&#123;userId&#125;</span>-<span class="subst">$&#123;timestamp&#125;</span>-<span class="subst">$&#123;<span class="built_in">Math</span>.random()&#125;</span>`</span>).<span class="title function_">substring</span>(<span class="number">0</span>, <span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MBTI测试提交</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">submitTest</span>(<span class="params"><span class="attr">testData</span>: <span class="title class_">MBTITestSubmission</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> now = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">  <span class="keyword">const</span> testId = <span class="title function_">generateTestId</span>(testData.<span class="property">user_id</span>, now.<span class="title function_">getTime</span>());</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 存储测试数据...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="JSR-Deno包注册表"><a href="#JSR-Deno包注册表" class="headerlink" title="JSR (Deno包注册表)"></a>JSR (Deno包注册表)</h3><p>JSR是官方的Deno包注册表，提供TypeScript和JavaScript包：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从JSR导入包</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Application</span>, <span class="title class_">Router</span> &#125; <span class="keyword">from</span> <span class="string">&quot;jsr:@oak/oak@^12.6.1&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; assertEquals &#125; <span class="keyword">from</span> <span class="string">&quot;jsr:@std/assert@1&quot;</span>;</span><br></pre></td></tr></table></figure><h4 id="在项目中使用JSR"><a href="#在项目中使用JSR" class="headerlink" title="在项目中使用JSR"></a>在项目中使用JSR</h4><ol><li>在<code>deno.json</code>中配置imports：</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;imports&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@std/assert&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jsr:@std/assert@1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;oak&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jsr:@oak/oak@^12.6.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fresh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jsr:@denoland/fresh@^2.0.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>然后在代码中导入：</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Application</span> &#125; <span class="keyword">from</span> <span class="string">&quot;oak&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; assertEquals &#125; <span class="keyword">from</span> <span class="string">&quot;@std/assert&quot;</span>;</span><br></pre></td></tr></table></figure><h3 id="NPM支持"><a href="#NPM支持" class="headerlink" title="NPM支持"></a>NPM支持</h3><p>Deno支持直接使用NPM包，无需转换或额外工具：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 直接从npm导入</span></span><br><span class="line"><span class="keyword">import</span> mongoose <span class="keyword">from</span> <span class="string">&quot;npm:mongoose@^8.0.0&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; z &#125; <span class="keyword">from</span> <span class="string">&quot;npm:zod@^3.22.4&quot;</span>;</span><br></pre></td></tr></table></figure><h4 id="在项目中使用NPM包"><a href="#在项目中使用NPM包" class="headerlink" title="在项目中使用NPM包"></a>在项目中使用NPM包</h4><ol><li>在<code>deno.json</code>中配置imports：</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;imports&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;mongoose&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npm:mongoose@^8.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;zod&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npm:zod@^3.22.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;md5&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npm:md5@^2.3.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>然后在代码中导入：</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mongoose <span class="keyword">from</span> <span class="string">&quot;mongoose&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; z &#125; <span class="keyword">from</span> <span class="string">&quot;zod&quot;</span>;</span><br></pre></td></tr></table></figure><h3 id="其他源导入"><a href="#其他源导入" class="headerlink" title="其他源导入"></a>其他源导入</h3><p>Deno还支持从URL直接导入：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从URL导入</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Command</span> &#125; <span class="keyword">from</span> <span class="string">&quot;https://deno.land/x/cliffy@v0.25.7/command/mod.ts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MySQLConnector</span> &#125; <span class="keyword">from</span> <span class="string">&quot;https://deno.land/x/mysql@v2.12.1/mod.ts&quot;</span>;</span><br></pre></td></tr></table></figure><h3 id="包版本管理"><a href="#包版本管理" class="headerlink" title="包版本管理"></a>包版本管理</h3><hr><h2 id="📁-项目结构"><a href="#📁-项目结构" class="headerlink" title="📁 项目结构"></a>📁 项目结构</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/</span><br><span class="line">├── main.ts                # 主入口文件</span><br><span class="line">├── src/</span><br><span class="line">│   ├── routes/            # 路由定义</span><br><span class="line">│   ├── controllers/       # 控制器</span><br><span class="line">│   ├── services/          # 服务层</span><br><span class="line">│   ├── middleware/        # 中间件</span><br><span class="line">│   ├── utils/             # 工具函数</span><br><span class="line">│   ├── scripts/           # 脚本文件</span><br><span class="line">│   └── examples/          # 示例代码</span><br><span class="line">├── deno.json              # Deno项目配置</span><br><span class="line">└── .env                   # 环境变量</span><br></pre></td></tr></table></figure><hr><h2 id="🔌-API路由"><a href="#🔌-API路由" class="headerlink" title="🔌 API路由"></a>🔌 API路由</h2><p>项目使用Oak HTTP服务器框架定义路由，主要API路由包括：</p><h3 id="MBTI测试API"><a href="#MBTI测试API" class="headerlink" title="MBTI测试API"></a>MBTI测试API</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MBTI测试相关路由</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/api/mbti/questions&quot;</span>, mbtiController.<span class="property">getQuestions</span>);</span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/api/mbti/types&quot;</span>, mbtiController.<span class="property">getAllTypes</span>);</span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/api/mbti/types/:type&quot;</span>, mbtiController.<span class="property">getTypeDetails</span>);</span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/api/mbti/roles&quot;</span>, mbtiController.<span class="property">getRoles</span>);</span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/api/mbti/test&quot;</span>, mbtiController.<span class="property">submitTest</span>);</span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/api/mbti/user/:userId/history&quot;</span>, authMiddleware, mbtiController.<span class="property">getUserTestHistory</span>);</span><br></pre></td></tr></table></figure><blockquote><p>📝 <strong>注意</strong>：用户历史记录API需要身份验证。</p></blockquote><hr><h2 id="📊-数据模型"><a href="#📊-数据模型" class="headerlink" title="📊 数据模型"></a>📊 数据模型</h2><h3 id="MBTI相关模型"><a href="#MBTI相关模型" class="headerlink" title="MBTI相关模型"></a>MBTI相关模型</h3><details><summary><b>MBTIQuestion</b>: MBTI测试问题</summary><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">MBTIQuestion</span> &#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="built_in">number</span>;</span><br><span class="line">  <span class="attr">question</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">options</span>: <span class="title class_">Array</span>&lt;&#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="built_in">string</span>;</span><br><span class="line">    <span class="attr">text</span>: <span class="built_in">string</span>;</span><br><span class="line">  &#125;&gt;;</span><br><span class="line">  <span class="attr">dimension</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><details><summary><b>MBTIType</b>: MBTI人格类型</summary><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">MBTIType</span> &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="built_in">string</span>;       <span class="comment">// 如 &quot;INTJ-A&quot;</span></span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;       <span class="comment">// 如 &quot;建筑师&quot;</span></span><br><span class="line">  <span class="attr">title</span>: <span class="built_in">string</span>;      <span class="comment">// 如 &quot;建筑师 (自信型)&quot;</span></span><br><span class="line">  <span class="attr">description</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">strengths</span>: <span class="built_in">string</span>[];</span><br><span class="line">  <span class="attr">weaknesses</span>: <span class="built_in">string</span>[];</span><br><span class="line">  <span class="attr">roles</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">careers</span>: <span class="built_in">string</span>[];</span><br><span class="line">  <span class="attr">famousPeople</span>: <span class="built_in">string</span>[];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><details><summary><b>MBTIRole</b>: MBTI角色分类</summary><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">MBTIRole</span> &#123;</span><br><span class="line">  <span class="attr">role</span>: <span class="built_in">string</span>;      <span class="comment">// 如 &quot;分析师&quot;</span></span><br><span class="line">  <span class="attr">types</span>: <span class="built_in">string</span>[];   <span class="comment">// 如 [&quot;INTJ&quot;, &quot;INTP&quot;, &quot;ENTJ&quot;, &quot;ENTP&quot;]</span></span><br><span class="line">  <span class="attr">description</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">traits</span>: <span class="built_in">string</span>[];</span><br><span class="line">  <span class="attr">color</span>: <span class="built_in">string</span>;     <span class="comment">// 如 &quot;#88619A&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><details><summary><b>MBTITestResult</b>: 测试结果</summary><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">MBTITestResult</span> &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="built_in">string</span>;  <span class="comment">// 如 &quot;INTJ-A&quot;</span></span><br><span class="line">  <span class="attr">scores</span>: &#123;</span><br><span class="line">    <span class="attr">EI_E</span>: <span class="built_in">number</span>, <span class="attr">EI_I</span>: <span class="built_in">number</span>,</span><br><span class="line">    <span class="attr">SN_S</span>: <span class="built_in">number</span>, <span class="attr">SN_N</span>: <span class="built_in">number</span>,</span><br><span class="line">    <span class="attr">TF_T</span>: <span class="built_in">number</span>, <span class="attr">TF_F</span>: <span class="built_in">number</span>,</span><br><span class="line">    <span class="attr">JP_J</span>: <span class="built_in">number</span>, <span class="attr">JP_P</span>: <span class="built_in">number</span>,</span><br><span class="line">    <span class="attr">AT_A</span>: <span class="built_in">number</span>, <span class="attr">AT_T</span>: <span class="built_in">number</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="🧩-MBTI测试实现细节"><a href="#🧩-MBTI测试实现细节" class="headerlink" title="🧩 MBTI测试实现细节"></a>🧩 MBTI测试实现细节</h2><h3 id="1-测试流程"><a href="#1-测试流程" class="headerlink" title="1. 测试流程"></a>1. 测试流程</h3><pre><code class="highlight mermaid">graph LR    A[获取问题] --&gt; B[提交答案]    B --&gt; C[计算结果]    C --&gt; D[保存结果]    D --&gt; E[查看历史]</code></pre><ol><li>用户获取测试问题 (<code>GET /api/mbti/questions</code>)</li><li>用户提交测试答案 (<code>POST /api/mbti/test</code>)</li><li>系统计算测试结果并保存</li><li>用户可查看测试历史 (<code>GET /api/mbti/user/:userId/history</code>)</li></ol><h3 id="2-结果计算逻辑"><a href="#2-结果计算逻辑" class="headerlink" title="2. 结果计算逻辑"></a>2. 结果计算逻辑</h3><details><summary>展开查看结果计算代码</summary><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">calculateTestResult</span>(<span class="attr">responses</span>: <span class="title class_">MBTITestResponse</span>[]): <span class="title class_">MBTITestResult</span> &#123;</span><br><span class="line">  <span class="comment">// 初始化分数</span></span><br><span class="line">  <span class="keyword">const</span> scores = &#123;</span><br><span class="line">    <span class="attr">EI_E</span>: <span class="number">0</span>, <span class="attr">EI_I</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">SN_S</span>: <span class="number">0</span>, <span class="attr">SN_N</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">TF_T</span>: <span class="number">0</span>, <span class="attr">TF_F</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">JP_J</span>: <span class="number">0</span>, <span class="attr">JP_P</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">AT_A</span>: <span class="number">0</span>, <span class="attr">AT_T</span>: <span class="number">0</span></span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 累计每个维度的分数</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> response <span class="keyword">of</span> responses) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (response.<span class="property">selected_value</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;E&#x27;</span>: scores.<span class="property">EI_E</span>++; <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;I&#x27;</span>: scores.<span class="property">EI_I</span>++; <span class="keyword">break</span>;</span><br><span class="line">      <span class="comment">// ...其他维度</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 确定每个维度的主导特质</span></span><br><span class="line">  <span class="keyword">const</span> <span class="variable constant_">E_I</span> = scores.<span class="property">EI_E</span> &gt; scores.<span class="property">EI_I</span> ? <span class="string">&#x27;E&#x27;</span> : <span class="string">&#x27;I&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="variable constant_">S_N</span> = scores.<span class="property">SN_S</span> &gt; scores.<span class="property">SN_N</span> ? <span class="string">&#x27;S&#x27;</span> : <span class="string">&#x27;N&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="variable constant_">T_F</span> = scores.<span class="property">TF_T</span> &gt; scores.<span class="property">TF_F</span> ? <span class="string">&#x27;T&#x27;</span> : <span class="string">&#x27;F&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="variable constant_">J_P</span> = scores.<span class="property">JP_J</span> &gt; scores.<span class="property">JP_P</span> ? <span class="string">&#x27;J&#x27;</span> : <span class="string">&#x27;P&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="variable constant_">A_T</span> = scores.<span class="property">AT_A</span> &gt; scores.<span class="property">AT_T</span> ? <span class="string">&#x27;A&#x27;</span> : <span class="string">&#x27;T&#x27;</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 组合MBTI类型</span></span><br><span class="line">  <span class="keyword">const</span> mbtiType = <span class="string">`<span class="subst">$&#123;E_I&#125;</span><span class="subst">$&#123;S_N&#125;</span><span class="subst">$&#123;T_F&#125;</span><span class="subst">$&#123;J_P&#125;</span>-<span class="subst">$&#123;A_T&#125;</span>`</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">type</span>: mbtiType,</span><br><span class="line">    scores</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-数据库集合"><a href="#3-数据库集合" class="headerlink" title="3. 数据库集合"></a>3. 数据库集合</h3><p>MBTI测试系统使用了以下MongoDB集合：</p><table><thead><tr><th>集合名称</th><th>用途</th></tr></thead><tbody><tr><td><code>mbti_questions</code></td><td>存储测试问题</td></tr><tr><td><code>mbti_types</code></td><td>存储MBTI类型描述</td></tr><tr><td><code>mbti_roles</code></td><td>存储MBTI角色分类</td></tr><tr><td><code>mbti_test_results</code></td><td>存储用户测试记录</td></tr></tbody></table><hr><h2 id="🗄️-MongoDB数据库操作"><a href="#🗄️-MongoDB数据库操作" class="headerlink" title="🗄️ MongoDB数据库操作"></a>🗄️ MongoDB数据库操作</h2><p>项目使用自定义的<code>MongoDBService</code>类进行数据库操作，主要方法如下：</p><h3 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化连接</span></span><br><span class="line"><span class="keyword">const</span> mongoDBService = <span class="keyword">new</span> <span class="title class_">MongoDBService</span>(&#123;</span><br><span class="line">  <span class="attr">uri</span>: <span class="string">&quot;mongodb://[username]:[password]@[host]/&quot;</span>,</span><br><span class="line">  <span class="attr">dbName</span>: <span class="string">&quot;database_name&quot;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接数据库</span></span><br><span class="line"><span class="keyword">await</span> mongoDBService.<span class="title function_">connect</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭连接</span></span><br><span class="line"><span class="keyword">await</span> mongoDBService.<span class="title function_">close</span>();</span><br></pre></td></tr></table></figure><h3 id="基本CRUD操作"><a href="#基本CRUD操作" class="headerlink" title="基本CRUD操作"></a>基本CRUD操作</h3><details><summary>展开查看CRUD操作示例</summary><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询文档</span></span><br><span class="line"><span class="keyword">const</span> documents = <span class="keyword">await</span> mongoDBService.<span class="title function_">find</span>(<span class="string">&quot;collection_name&quot;</span>, &#123; <span class="attr">field</span>: <span class="string">&quot;value&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据ID查询</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable language_">document</span> = <span class="keyword">await</span> mongoDBService.<span class="title function_">findById</span>(<span class="string">&quot;collection_name&quot;</span>, <span class="string">&quot;id&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 插入文档</span></span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> mongoDBService.<span class="title function_">insertOne</span>(<span class="string">&quot;collection_name&quot;</span>, &#123; <span class="attr">field</span>: <span class="string">&quot;value&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 批量插入</span></span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> mongoDBService.<span class="title function_">insertMany</span>(<span class="string">&quot;collection_name&quot;</span>, [&#123; <span class="attr">field</span>: <span class="string">&quot;value&quot;</span> &#125;]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新文档</span></span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> mongoDBService.<span class="title function_">updateOne</span>(</span><br><span class="line">  <span class="string">&quot;collection_name&quot;</span>, </span><br><span class="line">  &#123; <span class="attr">field</span>: <span class="string">&quot;value&quot;</span> &#125;, </span><br><span class="line">  &#123; <span class="attr">$set</span>: &#123; <span class="attr">field</span>: <span class="string">&quot;new_value&quot;</span> &#125; &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据ID更新</span></span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> mongoDBService.<span class="title function_">updateById</span>(<span class="string">&quot;collection_name&quot;</span>, <span class="string">&quot;id&quot;</span>, &#123; <span class="attr">field</span>: <span class="string">&quot;value&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除文档</span></span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> mongoDBService.<span class="title function_">deleteOne</span>(<span class="string">&quot;collection_name&quot;</span>, &#123; <span class="attr">field</span>: <span class="string">&quot;value&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据ID删除</span></span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> mongoDBService.<span class="title function_">deleteById</span>(<span class="string">&quot;collection_name&quot;</span>, <span class="string">&quot;id&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 聚合查询</span></span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> mongoDBService.<span class="title function_">aggregate</span>(<span class="string">&quot;collection_name&quot;</span>, [</span><br><span class="line">  &#123; <span class="attr">$match</span>: &#123; <span class="attr">field</span>: <span class="string">&quot;value&quot;</span> &#125; &#125;,</span><br><span class="line">  &#123; <span class="attr">$group</span>: &#123; <span class="attr">_id</span>: <span class="string">&quot;$field&quot;</span>, <span class="attr">count</span>: &#123; <span class="attr">$sum</span>: <span class="number">1</span> &#125; &#125; &#125;</span><br><span class="line">]);</span><br></pre></td></tr></table></figure><h3 id="MBTI实际数据库操作示例"><a href="#MBTI实际数据库操作示例" class="headerlink" title="MBTI实际数据库操作示例"></a>MBTI实际数据库操作示例</h3><details><summary>查询所有MBTI类型</summary><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">getAllTypes</span>(): <span class="title class_">Promise</span>&lt;<span class="title class_">MBTIType</span>[]&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">mongoDBService</span>.<span class="title function_">connect</span>();</span><br><span class="line">    <span class="keyword">const</span> types = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">mongoDBService</span>.<span class="title function_">find</span>(<span class="variable language_">this</span>.<span class="property">typesCollection</span>, &#123;&#125;);</span><br><span class="line">    <span class="keyword">return</span> types <span class="keyword">as</span> <span class="built_in">unknown</span> <span class="keyword">as</span> <span class="title class_">MBTIType</span>[];</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">error</span>(<span class="string">&quot;获取所有MBTI类型失败:&quot;</span>, error);</span><br><span class="line">    <span class="keyword">throw</span> error;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">mongoDBService</span>.<span class="title function_">close</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details><details><summary>保存测试结果</summary><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 新用户，创建记录</span></span><br><span class="line"><span class="keyword">const</span> newUserData = &#123;</span><br><span class="line">  <span class="attr">user_id</span>: testData.<span class="property">user_id</span>,</span><br><span class="line">  <span class="attr">nickname</span>: testData.<span class="property">nickname</span> || testData.<span class="property">user_id</span>,</span><br><span class="line">  <span class="attr">tests</span>: [&#123;</span><br><span class="line">    <span class="attr">test_id</span>: testId,</span><br><span class="line">    <span class="attr">test_date</span>: now,</span><br><span class="line">    <span class="attr">completed</span>: isCompleted,</span><br><span class="line">    <span class="attr">responses</span>: testData.<span class="property">responses</span>,</span><br><span class="line">    <span class="attr">result</span>: testResult</span><br><span class="line">  &#125;],</span><br><span class="line">  <span class="attr">test_count</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">latest_type</span>: testResult?.<span class="property">type</span> || <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">created_at</span>: now,</span><br><span class="line">  <span class="attr">updated_at</span>: now</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">mongoDBService</span>.<span class="title function_">insertOne</span>(<span class="variable language_">this</span>.<span class="property">testResultsCollection</span>, newUserData);</span><br></pre></td></tr></table></figure><details><summary>更新现有记录</summary><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 现有用户，更新记录</span></span><br><span class="line"><span class="keyword">const</span> userData = existingUsers[<span class="number">0</span>] <span class="keyword">as</span> <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt;;</span><br><span class="line"><span class="keyword">const</span> tests = userData.<span class="property">tests</span> <span class="keyword">as</span> <span class="title class_">Array</span>&lt;<span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt;&gt; || [];</span><br><span class="line"></span><br><span class="line">tests.<span class="title function_">push</span>(&#123;</span><br><span class="line">  <span class="attr">test_id</span>: testId,</span><br><span class="line">  <span class="attr">test_date</span>: now,</span><br><span class="line">  <span class="attr">completed</span>: isCompleted,</span><br><span class="line">  <span class="attr">responses</span>: testData.<span class="property">responses</span>,</span><br><span class="line">  <span class="attr">result</span>: testResult</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">updateData</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt; = &#123;</span><br><span class="line">  tests,</span><br><span class="line">  <span class="attr">test_count</span>: tests.<span class="property">length</span>,</span><br><span class="line">  <span class="attr">updated_at</span>: now</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果测试完成，更新最新类型</span></span><br><span class="line"><span class="keyword">if</span> (isCompleted &amp;&amp; testResult) &#123;</span><br><span class="line">  updateData.<span class="property">latest_type</span> = testResult.<span class="property">type</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">mongoDBService</span>.<span class="title function_">updateOne</span>(</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">testResultsCollection</span>,</span><br><span class="line">  &#123; <span class="attr">user_id</span>: testData.<span class="property">user_id</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">$set</span>: updateData &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h3 id="分页查询"><a href="#分页查询" class="headerlink" title="分页查询"></a>分页查询</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> mongoDBService.<span class="title function_">paginate</span>(</span><br><span class="line">  <span class="string">&quot;collection_name&quot;</span>,   <span class="comment">// 集合名称</span></span><br><span class="line">  <span class="number">1</span>,                   <span class="comment">// 页码</span></span><br><span class="line">  <span class="number">10</span>,                  <span class="comment">// 每页记录数</span></span><br><span class="line">  &#123; <span class="attr">field</span>: <span class="string">&quot;value&quot;</span> &#125;,  <span class="comment">// 查询条件</span></span><br><span class="line">  &#123; <span class="attr">sort</span>: &#123; <span class="attr">field</span>: <span class="number">1</span> &#125; &#125; <span class="comment">// 排序选项</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><h4 id="返回结果格式"><a href="#返回结果格式" class="headerlink" title="返回结果格式"></a>返回结果格式</h4><table><thead><tr><th>字段</th><th>描述</th></tr></thead><tbody><tr><td><code>data</code></td><td>数据数组</td></tr><tr><td><code>total</code></td><td>总记录数</td></tr><tr><td><code>page</code></td><td>当前页码</td></tr><tr><td><code>limit</code></td><td>每页记录数</td></tr><tr><td><code>pageCount</code></td><td>总页数</td></tr></tbody></table><hr><h2 id="🧰-MongoDB查询语法"><a href="#🧰-MongoDB查询语法" class="headerlink" title="🧰 MongoDB查询语法"></a>🧰 MongoDB查询语法</h2><h3 id="常用操作符"><a href="#常用操作符" class="headerlink" title="常用操作符"></a>常用操作符</h3><details><summary>展开查看常用查询操作符</summary><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 相等查询</span></span><br><span class="line">&#123; <span class="attr">field</span>: <span class="string">&quot;value&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不等查询</span></span><br><span class="line">&#123; <span class="attr">field</span>: &#123; <span class="attr">$ne</span>: <span class="string">&quot;value&quot;</span> &#125; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 大于/小于</span></span><br><span class="line">&#123; <span class="attr">field</span>: &#123; <span class="attr">$gt</span>: <span class="number">10</span> &#125; &#125;  <span class="comment">// 大于</span></span><br><span class="line">&#123; <span class="attr">field</span>: &#123; <span class="attr">$lt</span>: <span class="number">10</span> &#125; &#125;  <span class="comment">// 小于</span></span><br><span class="line">&#123; <span class="attr">field</span>: &#123; <span class="attr">$gte</span>: <span class="number">10</span> &#125; &#125; <span class="comment">// 大于等于</span></span><br><span class="line">&#123; <span class="attr">field</span>: &#123; <span class="attr">$lte</span>: <span class="number">10</span> &#125; &#125; <span class="comment">// 小于等于</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// IN查询</span></span><br><span class="line">&#123; <span class="attr">field</span>: &#123; <span class="attr">$in</span>: [<span class="string">&quot;value1&quot;</span>, <span class="string">&quot;value2&quot;</span>] &#125; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 逻辑操作符</span></span><br><span class="line">&#123; <span class="attr">$and</span>: [&#123; <span class="attr">field1</span>: <span class="string">&quot;value1&quot;</span> &#125;, &#123; <span class="attr">field2</span>: <span class="string">&quot;value2&quot;</span> &#125;] &#125;</span><br><span class="line">&#123; <span class="attr">$or</span>: [&#123; <span class="attr">field1</span>: <span class="string">&quot;value1&quot;</span> &#125;, &#123; <span class="attr">field1</span>: <span class="string">&quot;value2&quot;</span> &#125;] &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正则表达式</span></span><br><span class="line">&#123; <span class="attr">field</span>: &#123; <span class="attr">$regex</span>: <span class="string">&quot;pattern&quot;</span>, <span class="attr">$options</span>: <span class="string">&quot;i&quot;</span> &#125; &#125; <span class="comment">// i表示不区分大小写</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 存在性检查</span></span><br><span class="line">&#123; <span class="attr">field</span>: &#123; <span class="attr">$exists</span>: <span class="literal">true</span> &#125; &#125;</span><br></pre></td></tr></table></figure><h3 id="更新操作符"><a href="#更新操作符" class="headerlink" title="更新操作符"></a>更新操作符</h3><details><summary>展开查看常用更新操作符</summary><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置字段值</span></span><br><span class="line">&#123; <span class="attr">$set</span>: &#123; <span class="attr">field</span>: <span class="string">&quot;new_value&quot;</span> &#125; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 增加数值</span></span><br><span class="line">&#123; <span class="attr">$inc</span>: &#123; <span class="attr">counter</span>: <span class="number">1</span> &#125; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加到数组</span></span><br><span class="line">&#123; <span class="attr">$push</span>: &#123; <span class="attr">array_field</span>: <span class="string">&quot;new_item&quot;</span> &#125; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从数组移除</span></span><br><span class="line">&#123; <span class="attr">$pull</span>: &#123; <span class="attr">array_field</span>: <span class="string">&quot;item_to_remove&quot;</span> &#125; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加到集合（不重复）</span></span><br><span class="line">&#123; <span class="attr">$addToSet</span>: &#123; <span class="attr">array_field</span>: <span class="string">&quot;new_unique_item&quot;</span> &#125; &#125;</span><br></pre></td></tr></table></figure><hr><h2 id="📝-注意事项和最佳实践"><a href="#📝-注意事项和最佳实践" class="headerlink" title="📝 注意事项和最佳实践"></a>📝 注意事项和最佳实践</h2><h3 id="数据库连接管理"><a href="#数据库连接管理" class="headerlink" title="数据库连接管理"></a>数据库连接管理</h3><ul><li>✅ 始终在操作结束后关闭数据库连接（使用<code>finally</code>块）</li><li>✅ 使用try-catch-finally处理数据库操作可能出现的异常</li></ul><h3 id="错误处理和日志"><a href="#错误处理和日志" class="headerlink" title="错误处理和日志"></a>错误处理和日志</h3><ul><li>✅ 使用统一的Logger类进行日志记录</li><li>✅ 所有外部调用（数据库、API）都应有错误处理</li></ul><h3 id="MongoDB操作"><a href="#MongoDB操作" class="headerlink" title="MongoDB操作"></a>MongoDB操作</h3><ul><li>✅ 使用<code>countDocuments</code>而不是已废弃的<code>count</code>方法</li><li>✅ 使用<code>find</code>方法时添加合适的投影(projection)以减少数据传输</li><li>✅ 对大结果集使用分页查询</li></ul><h3 id="安全性"><a href="#安全性" class="headerlink" title="安全性"></a>安全性</h3><ul><li>🔒 敏感API使用<code>authMiddleware</code>进行保护</li><li>🔒 不要在代码中硬编码敏感信息（如数据库密码）</li></ul><h3 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h3><ul><li>⚡ 大量文档使用批量操作（insertMany, updateMany）</li><li>⚡ 添加适当的索引以加速查询</li><li>⚡ 使用投影限制返回字段</li></ul><h3 id="特定项目注意事项"><a href="#特定项目注意事项" class="headerlink" title="特定项目注意事项"></a>特定项目注意事项</h3><ul><li>📋 MBTI测试需要至少16个问题才能完成</li><li>📋 每个用户可以有多个测试记录</li><li>📋 API响应格式保持一致（包含success, code, data&#x2F;message字段）</li></ul><hr><h3 id="API响应格式设计"><a href="#API响应格式设计" class="headerlink" title="API响应格式设计"></a>API响应格式设计</h3><p>为确保前端能高效处理API响应，所有API应遵循一致的响应格式：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">ApiResponse</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="attr">success</span>: <span class="built_in">boolean</span>;     <span class="comment">// 请求是否成功</span></span><br><span class="line">  <span class="attr">code</span>: <span class="built_in">number</span>;         <span class="comment">// 状态码，与HTTP状态码保持一致</span></span><br><span class="line">  <span class="attr">data</span>?: T;             <span class="comment">// 成功时返回的数据</span></span><br><span class="line">  <span class="attr">message</span>?: <span class="built_in">string</span>;     <span class="comment">// 错误时的消息</span></span><br><span class="line">  <span class="attr">pagination</span>?: &#123;        <span class="comment">// 分页信息（如适用）</span></span><br><span class="line">    <span class="attr">total</span>: <span class="built_in">number</span>;</span><br><span class="line">    <span class="attr">page</span>: <span class="built_in">number</span>;</span><br><span class="line">    <span class="attr">limit</span>: <span class="built_in">number</span>;</span><br><span class="line">    <span class="attr">pageCount</span>: <span class="built_in">number</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="前端实现建议"><a href="#前端实现建议" class="headerlink" title="前端实现建议"></a>前端实现建议</h3><ol><li><p><strong>MBTI测试界面设计</strong>:</p><ul><li>采用分步骤展示问题，减轻用户负担</li><li>进度指示器显示完成情况</li><li>使用直观的选项设计（如滑块、单选按钮）</li><li>结果页面突出显示用户的MBTI类型和特点</li></ul></li><li><p><strong>响应式设计</strong>:</p><ul><li>确保在移动设备和桌面设备上都有良好的用户体验</li><li>针对不同屏幕尺寸优化布局</li><li>考虑触摸操作的便利性</li></ul></li><li><p><strong>性能优化</strong>:</p><ul><li>实施懒加载技术，特别是对MBTI类型详情页面</li><li>缓存用户历史测试结果</li><li>优化图片和资源加载</li></ul></li><li><p><strong>交互体验优化</strong>:</p><ul><li>添加适当的动画和过渡效果</li><li>实现即时反馈机制</li><li>考虑离线支持，允许用户在无网络情况下完成测试</li></ul></li></ol><h3 id="用户体验优化建议"><a href="#用户体验优化建议" class="headerlink" title="用户体验优化建议"></a>用户体验优化建议</h3><ul><li>📱 <strong>引导式测试流程</strong>: 提供清晰的指引和说明</li><li>🎯 <strong>个性化结果展示</strong>: 根据用户的MBTI类型提供个性化的结果页面</li><li>🔄 <strong>社交分享功能</strong>: 允许用户分享他们的测试结果到社交媒体</li><li>🌓 <strong>主题定制</strong>: 提供浅色&#x2F;深色模式切换</li></ul><hr><h2 id="❓-常见问题排查"><a href="#❓-常见问题排查" class="headerlink" title="❓ 常见问题排查"></a>❓ 常见问题排查</h2><h3 id="MongoDB连接问题"><a href="#MongoDB连接问题" class="headerlink" title="MongoDB连接问题"></a>MongoDB连接问题</h3><ul><li>🔍 检查URI和数据库名称配置</li><li>🔍 确认MongoDB服务器运行状态</li><li>🔍 检查网络连接和防火墙设置</li></ul><h3 id="API返回空数据"><a href="#API返回空数据" class="headerlink" title="API返回空数据"></a>API返回空数据</h3><ul><li>🔍 检查数据库连接</li><li>🔍 确认集合中有数据</li><li>🔍 验证查询条件是否正确</li></ul><h3 id="权限问题"><a href="#权限问题" class="headerlink" title="权限问题"></a>权限问题</h3><ul><li>🔍 确认用户有正确的数据库权限</li><li>🔍 验证授权令牌是否有效</li></ul><h3 id="部署相关问题"><a href="#部署相关问题" class="headerlink" title="部署相关问题"></a>部署相关问题</h3><ul><li>🔍 确保目标环境包含所有必要的环境变量</li><li>🔍 检查运行命令是否包含所有必要的权限标志</li></ul><hr><h2 id="🚀-扩展和改进"><a href="#🚀-扩展和改进" class="headerlink" title="🚀 扩展和改进"></a>🚀 扩展和改进</h2><ol><li><strong>API文档</strong>: 考虑添加Swagger或类似工具</li><li><strong>缓存层</strong>: 为频繁访问的数据添加缓存</li><li><strong>监控</strong>: 添加性能监控和健康检查</li><li><strong>CI&#x2F;CD</strong>: 设置自动化测试和部署</li></ol><hr><p>建议在<code>deno.json</code>中集中管理所有依赖的版本，便于后续升级和维护：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;imports&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;oak&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jsr:@oak/oak@^12.6.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mongoose&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npm:mongoose@^8.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;std/&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://deno.land/std@0.196.0/&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><hr><h2 id="🚢-Deno部署指南"><a href="#🚢-Deno部署指南" class="headerlink" title="🚢 Deno部署指南"></a>🚢 Deno部署指南</h2><h3 id="使用Deno-Deploy"><a href="#使用Deno-Deploy" class="headerlink" title="使用Deno Deploy"></a>使用Deno Deploy</h3><p><a href="https://deno.com/deploy">Deno Deploy</a>是官方的serverless平台，可以轻松部署Deno应用。</p><h4 id="1-使用deployctl工具"><a href="#1-使用deployctl工具" class="headerlink" title="1. 使用deployctl工具"></a>1. 使用deployctl工具</h4><p>首先安装deployctl工具：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deno install --allow-read --allow-write --allow-env --allow-net --allow-run --no-check -r -f https://deno.land/x/deploy/deployctl.ts</span><br></pre></td></tr></table></figure><h4 id="2-部署项目"><a href="#2-部署项目" class="headerlink" title="2. 部署项目"></a>2. 部署项目</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 直接部署</span></span><br><span class="line">deployctl deploy --project=your-project-name main.ts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定环境变量</span></span><br><span class="line">deployctl deploy --project=your-project-name --env-file=.<span class="built_in">env</span> main.ts</span><br></pre></td></tr></table></figure><h4 id="3-通过deno-json配置"><a href="#3-通过deno-json配置" class="headerlink" title="3. 通过deno.json配置"></a>3. 通过deno.json配置</h4><p>项目的<code>deno.json</code>可以包含部署配置：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;deploy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;project&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-project-id&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;exclude&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;**/node_modules&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;include&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;entrypoint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;main.ts&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>然后执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deno task deploy</span><br></pre></td></tr></table></figure><h3 id="部署前的准备"><a href="#部署前的准备" class="headerlink" title="部署前的准备"></a>部署前的准备</h3><ol><li><p><strong>确保项目结构正确</strong>：</p><ul><li>入口文件应该是自包含的，或者能够访问所有依赖</li><li>确保所有路径正确（相对路径和绝对路径）</li></ul></li><li><p><strong>环境变量处理</strong>：</p><ul><li>部署环境需要设置所有必需的环境变量</li><li>可以在Deno Deploy控制台中配置环境变量</li><li>敏感信息不应硬编码或包含在版本控制中</li></ul></li><li><p><strong>文件系统限制</strong>：</p><ul><li>Deno Deploy不支持本地文件系统写入</li><li>所有文件操作应替换为存储服务(如MongoDB)或内存存储</li></ul></li><li><p><strong>网络访问和第三方服务</strong>：</p><ul><li>确保所有外部服务都能从Deno Deploy访问</li><li>使用适当的超时和重试策略处理间歇性连接问题</li></ul></li></ol><h3 id="注意事项和限制"><a href="#注意事项和限制" class="headerlink" title="注意事项和限制"></a>注意事项和限制</h3><ol><li><p><strong>冷启动</strong>:</p><ul><li>Serverless环境可能有冷启动延迟</li><li>关键服务应优化以快速初始化</li></ul></li><li><p><strong>执行时间限制</strong>:</p><ul><li>请求处理时间有限制，长时间操作应拆分或异步处理</li></ul></li><li><p><strong>内存限制</strong>:</p><ul><li>遵循内存最佳实践，避免内存泄漏</li><li>大型对象应分块处理或使用流处理</li></ul></li><li><p><strong>依赖项</strong>:</p><ul><li>确保所有依赖项都与Deno Deploy兼容</li><li>某些依赖于Node.js API的npm包可能不兼容</li><li>使用Deno标准库或专门的Deno包以获得最佳体验</li></ul></li><li><p><strong>数据库连接</strong>:</p><ul><li>使用连接池和合适的连接管理策略</li><li>防止连接泄漏，确保在请求结束时关闭连接</li></ul></li><li><p><strong>定时任务</strong>:</p><ul><li>Deno Deploy支持通过Cron触发器运行定时任务</li><li>对于复杂的调度需求，可能需要外部服务</li></ul></li></ol><h3 id="部署后的监控"><a href="#部署后的监控" class="headerlink" title="部署后的监控"></a>部署后的监控</h3><ul><li>使用Deno Deploy提供的日志和指标监控应用性能</li><li>考虑添加自定义日志记录以跟踪关键操作</li><li>实现健康检查端点以监控服务状态</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 健康检查端点示例</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/health&quot;</span>, <span class="function">(<span class="params">ctx</span>) =&gt;</span> &#123;</span><br><span class="line">  ctx.<span class="property">response</span>.<span class="property">status</span> = <span class="number">200</span>;</span><br><span class="line">  ctx.<span class="property">response</span>.<span class="property">body</span> = &#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&quot;ok&quot;</span>,</span><br><span class="line">    <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toISOString</span>(),</span><br><span class="line">    <span class="attr">version</span>: <span class="string">&quot;1.0.0&quot;</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><hr><h2 id="📐-代码规范"><a href="#📐-代码规范" class="headerlink" title="📐 代码规范"></a>📐 代码规范</h2><ul><li>📄 使用TSDoc风格的注释</li><li>🔄 保持一致的错误处理和日志记录模式</li><li>🧩 遵循模块化设计原则</li></ul><hr><h2 id="📚-资源链接"><a href="#📚-资源链接" class="headerlink" title="📚 资源链接"></a>📚 资源链接</h2><ul><li><a href="https://deno.land/manual">Deno官方文档</a></li><li><a href="https://deno.land/x/oak">Oak HTTP服务器框架文档</a></li><li><a href="https://www.mongodb.com/docs/">MongoDB文档</a></li><li><a href="https://mongoosejs.com/docs/">Mongoose文档</a></li><li><a href="https://www.myersbriggs.org/">MBTI官方网站</a></li><li><a href="https://www.16personalities.com/">16Personalities</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Deno学习记录-📘&quot;&gt;&lt;a href=&quot;#Deno学习记录-📘&quot; class=&quot;headerlink&quot; title=&quot;Deno学习记录 📘&quot;&gt;&lt;/a&gt;Deno学习记录 📘&lt;/h1&gt;&lt;div align=&quot;left&quot;&gt;

&lt;p&gt;&lt;img src= &quot;/im</summary>
      
    
    
    
    
    <category term="Deno" scheme="https://aoayaoa.github.io/tags/Deno/"/>
    
  </entry>
  
  <entry>
    <title>react总结</title>
    <link href="https://aoayaoa.github.io/2025/03/15/react/"/>
    <id>https://aoayaoa.github.io/2025/03/15/react/</id>
    <published>2025-03-14T16:00:00.000Z</published>
    <updated>2025-04-26T09:19:06.682Z</updated>
    
    <content type="html"><![CDATA[<h1 id="React-18-19-学习总结"><a href="#React-18-19-学习总结" class="headerlink" title="React 18&#x2F;19 学习总结"></a>React 18&#x2F;19 学习总结</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul><li><a href="#react-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5">React 基础概念</a></li><li><a href="#%E5%B8%B8%E8%A7%81%E7%94%A8%E6%B3%95%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">常见用法与最佳实践</a></li><li><a href="#hook-%E8%AF%A6%E8%A7%A3%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">Hook 详解与最佳实践</a></li><li><a href="#%E6%98%93%E9%94%99%E7%82%B9%E4%B8%8E%E9%99%B7%E9%98%B1">易错点与陷阱</a></li><li><a href="#%E9%A1%B9%E7%9B%AE%E5%AE%9E%E8%B7%B5%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">项目实践注意事项</a></li><li><a href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A7">性能优化技巧</a></li><li><a href="#react-18-%E6%A0%B8%E5%BF%83%E7%89%B9%E6%80%A7">React 18 核心特性</a></li><li><a href="#react-19-%E6%96%B0%E7%89%B9%E6%80%A7%E4%B8%8E%E5%B1%95%E6%9C%9B">React 19 新特性与展望</a></li><li><a href="#%E9%A2%9D%E5%A4%96%E8%B5%84%E6%BA%90">额外资源</a></li></ul><hr><h2 id="React-基础概念"><a href="#React-基础概念" class="headerlink" title="React 基础概念"></a>React 基础概念</h2><h3 id="组件与JSX"><a href="#组件与JSX" class="headerlink" title="组件与JSX"></a>组件与JSX</h3><p>React 的核心理念是将 UI 分解成独立、可复用的组件。每个组件都是一个自包含的模块，负责渲染 UI 的一部分。</p><div style="background-color: #f0f7fb; padding: 15px; border-left: 5px solid #3498db; margin-bottom: 15px;"><strong>关键概念</strong>：组件是 React 应用的构建块，可以使用函数组件或类组件创建。</div><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 函数组件</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Welcome</span>(<span class="params">props</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, &#123;props.name&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类组件</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Welcome</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, &#123;this.props.name&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>JSX 是 JavaScript 的语法扩展，它允许我们在 JavaScript 中编写类似 HTML 的代码。</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JSX 基本语法</span></span><br><span class="line"><span class="keyword">const</span> element = <span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, world!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// JSX 可以包含 JavaScript 表达式</span></span><br><span class="line"><span class="keyword">const</span> name = <span class="string">&#x27;Josh&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> element = <span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, &#123;name&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// JSX 属性使用驼峰命名</span></span><br><span class="line"><span class="keyword">const</span> element = <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;container&quot;</span> <span class="attr">tabIndex</span>=<span class="string">&quot;0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br></pre></td></tr></table></figure><h3 id="状态与生命周期"><a href="#状态与生命周期" class="headerlink" title="状态与生命周期"></a>状态与生命周期</h3><p>组件可以有自己的状态，并且会随着时间推移而改变。</p><div style="background-color: #fff8dc; padding: 15px; border-left: 5px solid #f1c40f; margin-bottom: 15px;"><strong>注意</strong>：理解组件生命周期对于正确管理状态和副作用至关重要。</div><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 类组件中的状态和生命周期</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Clock</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123; <span class="attr">date</span>: <span class="keyword">new</span> <span class="title class_">Date</span>() &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">timerID</span> = <span class="built_in">setInterval</span>(</span><br><span class="line">      <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">tick</span>(),</span><br><span class="line">      <span class="number">1000</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">componentWillUnmount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="built_in">clearInterval</span>(<span class="variable language_">this</span>.<span class="property">timerID</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">tick</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">      <span class="attr">date</span>: <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, world!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>It is &#123;this.state.date.toLocaleTimeString()&#125;.<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="事件处理"><a href="#事件处理" class="headerlink" title="事件处理"></a>事件处理</h3><p>React 事件使用驼峰命名约定，并传递一个函数作为事件处理程序。</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 事件处理示例</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Toggle</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [isToggleOn, setIsToggleOn] = <span class="title function_">useState</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用箭头函数避免绑定 this</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleClick</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">setIsToggleOn</span>(!isToggleOn);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;isToggleOn ? &#x27;ON&#x27; : &#x27;OFF&#x27;&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="条件渲染和列表"><a href="#条件渲染和列表" class="headerlink" title="条件渲染和列表"></a>条件渲染和列表</h3><p>可以使用条件运算符、逻辑运算符或 if 语句来进行条件渲染。</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 条件渲染示例</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Greeting</span>(<span class="params">&#123; isLoggedIn &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;isLoggedIn ? <span class="tag">&lt;<span class="name">UserGreeting</span> /&gt;</span> : <span class="tag">&lt;<span class="name">GuestGreeting</span> /&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">      </span></span><br><span class="line"><span class="language-xml">      &#123;/* 或使用逻辑与 */&#125;</span></span><br><span class="line"><span class="language-xml">      &#123;isLoggedIn &amp;&amp; <span class="tag">&lt;<span class="name">UserGreeting</span> /&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>列表渲染通常使用 <code>map</code> 方法。</p><div style="background-color: #f8e5e5; padding: 15px; border-left: 5px solid #e74c3c; margin-bottom: 15px;"><strong>重要</strong>：在列表渲染时，每个子元素都需要一个唯一的 <code>key</code> 属性，以帮助 React 识别已更改的项目。</div><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 列表渲染示例</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">NumberList</span>(<span class="params">&#123; numbers &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;numbers.map(number =&gt; (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;number.toString()&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          &#123;number&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      ))&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="常见用法与最佳实践"><a href="#常见用法与最佳实践" class="headerlink" title="常见用法与最佳实践"></a>常见用法与最佳实践</h2><h3 id="函数组件与-Hooks"><a href="#函数组件与-Hooks" class="headerlink" title="函数组件与 Hooks"></a>函数组件与 Hooks</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 推荐的函数组件写法</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">UserProfile</span>(<span class="params">&#123; userId &#125;</span>) &#123;</span><br><span class="line">  <span class="comment">// 状态管理</span></span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = <span class="title function_">useState</span>(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">const</span> [isLoading, setIsLoading] = <span class="title function_">useState</span>(<span class="literal">true</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 使用 useEffect 处理副作用</span></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> isMounted = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchUser</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title function_">setIsLoading</span>(<span class="literal">true</span>);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">fetchUserData</span>(userId);</span><br><span class="line">        <span class="keyword">if</span> (isMounted) &#123;</span><br><span class="line">          <span class="title function_">setUser</span>(data);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(error);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isMounted) &#123;</span><br><span class="line">          <span class="title function_">setIsLoading</span>(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">fetchUser</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清理函数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      isMounted = <span class="literal">false</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, [userId]); <span class="comment">// 依赖项数组</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (isLoading) <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Loading</span> /&gt;</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (!user) <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">NotFound</span> /&gt;</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;user.name&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;user.email&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="状态管理最佳实践"><a href="#状态管理最佳实践" class="headerlink" title="状态管理最佳实践"></a>状态管理最佳实践</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在顶层组件中管理共享状态</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [theme, setTheme] = <span class="title function_">useState</span>(<span class="string">&#x27;light&#x27;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 提供状态变更函数</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">toggleTheme</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">setTheme</span>(<span class="function"><span class="params">prevTheme</span> =&gt;</span> prevTheme === <span class="string">&#x27;light&#x27;</span> ? <span class="string">&#x27;dark&#x27;</span> : <span class="string">&#x27;light&#x27;</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 通过 context 或 props 向下传递</span></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">ThemeContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;&#123;</span> <span class="attr">theme</span>, <span class="attr">toggleTheme</span> &#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Main</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ThemeContext.Provider</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 useReducer 处理复杂状态</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">taskReducer</span>(<span class="params">state, action</span>) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.<span class="property">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;ADD_TASK&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> [...state, &#123; <span class="attr">id</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(), <span class="attr">text</span>: action.<span class="property">payload</span>, <span class="attr">completed</span>: <span class="literal">false</span> &#125;];</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;TOGGLE_TASK&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> state.<span class="title function_">map</span>(<span class="function"><span class="params">task</span> =&gt;</span> </span><br><span class="line">        task.<span class="property">id</span> === action.<span class="property">payload</span> ? &#123; ...task, <span class="attr">completed</span>: !task.<span class="property">completed</span> &#125; : task</span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;DELETE_TASK&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> state.<span class="title function_">filter</span>(<span class="function"><span class="params">task</span> =&gt;</span> task.<span class="property">id</span> !== action.<span class="property">payload</span>);</span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">TaskList</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [tasks, dispatch] = <span class="title function_">useReducer</span>(taskReducer, []);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">AddTask</span> <span class="attr">onAdd</span>=<span class="string">&#123;text</span> =&gt;</span> dispatch(&#123; type: &#x27;ADD_TASK&#x27;, payload: text &#125;)&#125; /&gt;</span></span><br><span class="line"><span class="language-xml">      &#123;tasks.map(task =&gt; (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Task</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">key</span>=<span class="string">&#123;task.id&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">task</span>=<span class="string">&#123;task&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onToggle</span>=<span class="string">&#123;()</span> =&gt;</span> dispatch(&#123; type: &#x27;TOGGLE_TASK&#x27;, payload: task.id &#125;)&#125;</span></span><br><span class="line"><span class="language-xml">          onDelete=&#123;() =&gt; dispatch(&#123; type: &#x27;DELETE_TASK&#x27;, payload: task.id &#125;)&#125;</span></span><br><span class="line"><span class="language-xml">        /&gt;</span></span><br><span class="line"><span class="language-xml">      ))&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="自定义-Hooks"><a href="#自定义-Hooks" class="headerlink" title="自定义 Hooks"></a>自定义 Hooks</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建可复用的逻辑</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useLocalStorage</span>(<span class="params">key, initialValue</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [storedValue, setStoredValue] = <span class="title function_">useState</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> item = <span class="variable language_">window</span>.<span class="property">localStorage</span>.<span class="title function_">getItem</span>(key);</span><br><span class="line">      <span class="keyword">return</span> item ? <span class="title class_">JSON</span>.<span class="title function_">parse</span>(item) : initialValue;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(error);</span><br><span class="line">      <span class="keyword">return</span> initialValue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">setValue</span> = value =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> valueToStore = value <span class="keyword">instanceof</span> <span class="title class_">Function</span> ? <span class="title function_">value</span>(storedValue) : value;</span><br><span class="line">      <span class="title function_">setStoredValue</span>(valueToStore);</span><br><span class="line">      <span class="variable language_">window</span>.<span class="property">localStorage</span>.<span class="title function_">setItem</span>(key, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(valueToStore));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> [storedValue, setValue];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用自定义 Hook</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">SettingsForm</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [settings, setSettings] = <span class="title function_">useLocalStorage</span>(<span class="string">&#x27;user-settings&#x27;</span>, &#123; <span class="attr">theme</span>: <span class="string">&#x27;light&#x27;</span>, <span class="attr">notifications</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 使用和普通 state 一样</span></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">select</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">value</span>=<span class="string">&#123;settings.theme&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">onChange</span>=<span class="string">&#123;e</span> =&gt;</span> setSettings(&#123;...settings, theme: e.target.value&#125;)&#125;</span></span><br><span class="line"><span class="language-xml">      &gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;light&quot;</span>&gt;</span>浅色<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;dark&quot;</span>&gt;</span>深色<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Hook-详解与最佳实践"><a href="#Hook-详解与最佳实践" class="headerlink" title="Hook 详解与最佳实践"></a>Hook 详解与最佳实践</h2><h3 id="常见-Hook-用法总结"><a href="#常见-Hook-用法总结" class="headerlink" title="常见 Hook 用法总结"></a>常见 Hook 用法总结</h3><table><tr>  <th>Hook</th>  <th>用途</th>  <th>使用场景</th></tr><tr>  <td><code>useState</code></td>  <td>管理组件状态</td>  <td>需要响应式更新的数据</td></tr><tr>  <td><code>useEffect</code></td>  <td>处理副作用</td>  <td>API请求、订阅、DOM操作</td></tr><tr>  <td><code>useContext</code></td>  <td>消费上下文</td>  <td>深层传递数据</td></tr><tr>  <td><code>useReducer</code></td>  <td>管理复杂状态</td>  <td>多个相关状态或复杂逻辑</td></tr><tr>  <td><code>useCallback</code></td>  <td>记忆化函数</td>  <td>优化子组件渲染</td></tr><tr>  <td><code>useMemo</code></td>  <td>记忆化计算值</td>  <td>避免复杂计算重复执行</td></tr><tr>  <td><code>useRef</code></td>  <td>保存可变引用</td>  <td>访问DOM、保存不触发渲染的值</td></tr></table><h4 id="useState"><a href="#useState" class="headerlink" title="useState"></a>useState</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基础用法</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);  <span class="comment">// 声明状态变量和更新函数</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 使用函数初始化（惰性初始化）- 适用于昂贵计算</span></span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = <span class="title function_">useState</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 此函数只在组件首次渲染时执行</span></span><br><span class="line">    <span class="keyword">const</span> savedUser = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;user&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> savedUser ? <span class="title class_">JSON</span>.<span class="title function_">parse</span>(savedUser) : <span class="literal">null</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 管理多个状态</span></span><br><span class="line">  <span class="keyword">const</span> [loading, setLoading] = <span class="title function_">useState</span>(<span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">const</span> [error, setError] = <span class="title function_">useState</span>(<span class="literal">null</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>Count: &#123;count&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setCount(count + 1)&#125;&gt;增加<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div style="background-color: #eafaf1; padding: 15px; border-left: 5px solid #2ecc71; margin: 15px 0;"><strong>💡 最佳实践</strong>：将相关状态分组到一个对象中，但注意更新时需要保持不可变性（使用展开运算符）。</div><h4 id="useEffect"><a href="#useEffect" class="headerlink" title="useEffect"></a>useEffect</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">DataFetcher</span>(<span class="params">&#123; userId &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [data, setData] = <span class="title function_">useState</span>(<span class="literal">null</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 1️⃣ 基础用法 - 组件挂载和依赖项变化时执行</span></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">fetchData</span>(userId).<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> <span class="title function_">setData</span>(data));</span><br><span class="line">  &#125;, [userId]); <span class="comment">// 依赖项数组</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 2️⃣ 清理函数 - 组件卸载或依赖项变化前执行</span></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> subscription = <span class="title function_">subscribe</span>(userId);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 返回清理函数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">unsubscribe</span>(subscription);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, [userId]);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 3️⃣ 只在挂载时执行一次</span></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">logComponentMount</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">logComponentUnmount</span>();</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, []); <span class="comment">// 空依赖数组</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 4️⃣ 每次渲染后执行</span></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">updateDocumentTitle</span>(<span class="string">`Data for <span class="subst">$&#123;userId&#125;</span>`</span>);</span><br><span class="line">  &#125;); <span class="comment">// 没有第二个参数</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;/* 渲染数据 */&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div style="background-color: #fff8dc; padding: 15px; border-left: 5px solid #f1c40f; margin: 15px 0;"><strong>⚠️ 注意</strong>：useEffect 依赖项数组必须包含所有在 effect 中使用的组件作用域中的值，否则会导致闭包陷阱。</div><h4 id="useContext"><a href="#useContext" class="headerlink" title="useContext"></a>useContext</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建上下文</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ThemeContext</span> = <span class="title function_">createContext</span>(<span class="string">&#x27;light&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费上下文</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ThemeButton</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> theme = <span class="title function_">useContext</span>(<span class="title class_">ThemeContext</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">background:</span> <span class="attr">theme</span> === <span class="string">&#x27;dark&#x27;</span> ? &#x27;#<span class="attr">000</span>&#x27; <span class="attr">:</span> &#x27;#<span class="attr">fff</span>&#x27; &#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">      主题按钮</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 提供上下文</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">ThemeContext.Provider</span> <span class="attr">value</span>=<span class="string">&quot;dark&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">ThemeButton</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ThemeContext.Provider</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="useReducer"><a href="#useReducer" class="headerlink" title="useReducer"></a>useReducer</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义reducer</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">todoReducer</span>(<span class="params">state, action</span>) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.<span class="property">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;ADD_TODO&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> [...state, &#123; <span class="attr">id</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(), <span class="attr">text</span>: action.<span class="property">text</span>, <span class="attr">completed</span>: <span class="literal">false</span> &#125;];</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;TOGGLE_TODO&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> state.<span class="title function_">map</span>(<span class="function"><span class="params">todo</span> =&gt;</span></span><br><span class="line">        todo.<span class="property">id</span> === action.<span class="property">id</span> ? &#123; ...todo, <span class="attr">completed</span>: !todo.<span class="property">completed</span> &#125; : todo</span><br><span class="line">      );</span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">TodoApp</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// state: 当前状态, dispatch: 发送更新的函数</span></span><br><span class="line">  <span class="keyword">const</span> [todos, dispatch] = <span class="title function_">useReducer</span>(todoReducer, []); <span class="comment">// 初始状态为空数组</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 使用dispatch触发更新</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleAddTodo</span> = (<span class="params">text</span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="string">&#x27;ADD_TODO&#x27;</span>, text &#125;);  <span class="comment">// 发送action对象</span></span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">TodoForm</span> <span class="attr">onSubmit</span>=<span class="string">&#123;handleAddTodo&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">TodoList</span> <span class="attr">todos</span>=<span class="string">&#123;todos&#125;</span> <span class="attr">dispatch</span>=<span class="string">&#123;dispatch&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div style="display: flex; margin: 20px 0; border: 1px solid #ddd; border-radius: 5px; overflow: hidden;">  <div style="background-color: #f9f9f9; padding: 15px; width: 50%; box-sizing: border-box;">    <strong>useReducer 适用场景</strong>    <ul>      <li>状态逻辑复杂</li>      <li>下一个状态依赖前一个状态</li>      <li>状态由多个子值组成的对象</li>    </ul>  </div>  <div style="background-color: #f0f0f0; padding: 15px; width: 50%; box-sizing: border-box;">    <strong>useState 适用场景</strong>    <ul>      <li>简单的状态逻辑</li>      <li>独立的状态更新</li>      <li>简单基本类型的状态</li>    </ul>  </div></div><h3 id="生命周期方法与Hooks对比"><a href="#生命周期方法与Hooks对比" class="headerlink" title="生命周期方法与Hooks对比"></a>生命周期方法与Hooks对比</h3><table><thead><tr><th align="left">类组件生命周期</th><th align="left">Hook替代方式</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><code>constructor()</code></td><td align="left"><code>useState()</code>, <code>useReducer()</code></td><td align="left">使用useState或useReducer初始化状态</td></tr><tr><td align="left"><code>componentDidMount()</code></td><td align="left"><code>useEffect(() =&gt; &#123;&#125;, [])</code></td><td align="left">传入空依赖数组的useEffect</td></tr><tr><td align="left"><code>componentDidUpdate()</code></td><td align="left"><code>useEffect(() =&gt; &#123;&#125;, [deps])</code></td><td align="left">有依赖项的useEffect</td></tr><tr><td align="left"><code>componentWillUnmount()</code></td><td align="left"><code>useEffect</code>的清理函数</td><td align="left"><code>useEffect(() =&gt; &#123; return () =&gt; &#123;&#125; &#125;, [])</code></td></tr><tr><td align="left"><code>shouldComponentUpdate()</code></td><td align="left"><code>React.memo</code>, <code>useMemo</code></td><td align="left">使用React.memo包裹组件，或useMemo优化特定计算</td></tr><tr><td align="left"><code>getSnapshotBeforeUpdate()</code></td><td align="left">通常使用<code>useRef</code> + <code>useLayoutEffect</code></td><td align="left">组合使用这两个Hook模拟此功能</td></tr><tr><td align="left"><code>getDerivedStateFromProps()</code></td><td align="left"><code>useMemo</code> 或 直接在渲染期间计算</td><td align="left">在渲染过程中计算派生值</td></tr><tr><td align="left"><code>static getDerivedStateFromError()</code> <br /> <code>componentDidCatch()</code></td><td align="left">目前仍需要使用类组件的错误边界</td><td align="left">React团队计划提供Hook版本</td></tr></tbody></table><h3 id="为何生命周期被Hook取代？"><a href="#为何生命周期被Hook取代？" class="headerlink" title="为何生命周期被Hook取代？"></a>为何生命周期被Hook取代？</h3><h4 id="复杂性与关注点分离"><a href="#复杂性与关注点分离" class="headerlink" title="复杂性与关注点分离"></a>复杂性与关注点分离</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 类组件中的生命周期混杂问题</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserDashboard</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">      <span class="attr">user</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">posts</span>: [],</span><br><span class="line">      <span class="attr">isOnline</span>: <span class="literal">false</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 获取用户数据</span></span><br><span class="line">    <span class="title function_">fetchUser</span>(<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">userId</span>).<span class="title function_">then</span>(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; user &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取帖子数据</span></span><br><span class="line">    <span class="title function_">fetchPosts</span>(<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">userId</span>).<span class="title function_">then</span>(<span class="function"><span class="params">posts</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; posts &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置在线状态监听</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">onlineListener</span> = onlineStatus.<span class="title function_">subscribe</span>(<span class="function">(<span class="params">status</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">isOnline</span>: status &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">componentDidUpdate</span>(<span class="params">prevProps</span>) &#123;</span><br><span class="line">    <span class="comment">// 用户ID变化时更新</span></span><br><span class="line">    <span class="keyword">if</span> (prevProps.<span class="property">userId</span> !== <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">userId</span>) &#123;</span><br><span class="line">      <span class="comment">// 重复上面的数据获取逻辑</span></span><br><span class="line">      <span class="title function_">fetchUser</span>(<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">userId</span>).<span class="title function_">then</span>(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; user &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">      </span><br><span class="line">      <span class="title function_">fetchPosts</span>(<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">userId</span>).<span class="title function_">then</span>(<span class="function"><span class="params">posts</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; posts &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">componentWillUnmount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 清理在线状态监听</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">onlineListener</span>.<span class="title function_">unsubscribe</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 渲染方法...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook方式：按关注点分离</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">UserDashboard</span>(<span class="params">&#123; userId &#125;</span>) &#123;</span><br><span class="line">  <span class="comment">// 用户数据逻辑</span></span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = <span class="title function_">useState</span>(<span class="literal">null</span>);</span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">fetchUser</span>(userId).<span class="title function_">then</span>(setUser);</span><br><span class="line">  &#125;, [userId]); <span class="comment">// 当userId变化时自动重新获取</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 帖子数据逻辑</span></span><br><span class="line">  <span class="keyword">const</span> [posts, setPosts] = <span class="title function_">useState</span>([]);</span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">fetchPosts</span>(userId).<span class="title function_">then</span>(setPosts);</span><br><span class="line">  &#125;, [userId]);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 在线状态逻辑</span></span><br><span class="line">  <span class="keyword">const</span> [isOnline, setIsOnline] = <span class="title function_">useState</span>(<span class="literal">false</span>);</span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> listener = onlineStatus.<span class="title function_">subscribe</span>(setIsOnline);</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> listener.<span class="title function_">unsubscribe</span>();</span><br><span class="line">  &#125;, []); <span class="comment">// 只在挂载和卸载时处理</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 渲染...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="代码重用和逻辑提取"><a href="#代码重用和逻辑提取" class="headerlink" title="代码重用和逻辑提取"></a>代码重用和逻辑提取</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 类组件中重用逻辑困难</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserPostsA</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="comment">// 重复的获取用户帖子逻辑</span></span><br><span class="line">  <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">fetchPosts</span>(<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">userId</span>).<span class="title function_">then</span>(<span class="function"><span class="params">posts</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; posts &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">componentDidUpdate</span>(<span class="params">prevProps</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (prevProps.<span class="property">userId</span> !== <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">userId</span>) &#123;</span><br><span class="line">      <span class="title function_">fetchPosts</span>(<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">userId</span>).<span class="title function_">then</span>(<span class="function"><span class="params">posts</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; posts &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 渲染方法...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserPostsB</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="comment">// 几乎相同的逻辑复制</span></span><br><span class="line">  <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">fetchPosts</span>(<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">userId</span>).<span class="title function_">then</span>(<span class="function"><span class="params">posts</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; posts &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">componentDidUpdate</span>(<span class="params">prevProps</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (prevProps.<span class="property">userId</span> !== <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">userId</span>) &#123;</span><br><span class="line">      <span class="title function_">fetchPosts</span>(<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">userId</span>).<span class="title function_">then</span>(<span class="function"><span class="params">posts</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; posts &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 略有不同的渲染方法...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook方式：逻辑提取到自定义Hook</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">usePosts</span>(<span class="params">userId</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [posts, setPosts] = <span class="title function_">useState</span>([]);</span><br><span class="line">  <span class="keyword">const</span> [loading, setLoading] = <span class="title function_">useState</span>(<span class="literal">true</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setLoading</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="title function_">fetchPosts</span>(userId)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">setPosts</span>(data);</span><br><span class="line">        <span class="title function_">setLoading</span>(<span class="literal">false</span>);</span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(error);</span><br><span class="line">        <span class="title function_">setLoading</span>(<span class="literal">false</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;, [userId]);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> &#123; posts, loading &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在多个组件中复用</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">UserPostsA</span>(<span class="params">&#123; userId &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; posts, loading &#125; = <span class="title function_">usePosts</span>(userId);</span><br><span class="line">  <span class="comment">// 组件特定的渲染逻辑...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">UserPostsB</span>(<span class="params">&#123; userId &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; posts, loading &#125; = <span class="title function_">usePosts</span>(userId);</span><br><span class="line">  <span class="comment">// 不同的渲染逻辑...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="闭包与this问题"><a href="#闭包与this问题" class="headerlink" title="闭包与this问题"></a>闭包与this问题</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 类组件中的this绑定问题</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Counter</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123; <span class="attr">count</span>: <span class="number">0</span> &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 需要手动绑定this</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handleClick</span> = <span class="variable language_">this</span>.<span class="property">handleClick</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">handleClick</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">count</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">count</span> + <span class="number">1</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;this.handleClick&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        Click me: &#123;this.state.count&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook中没有this问题</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 不需要绑定，闭包自然捕获当前变量</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleClick</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">setCount</span>(count + <span class="number">1</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      Click me: &#123;count&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="一致性与可预测性"><a href="#一致性与可预测性" class="headerlink" title="一致性与可预测性"></a>一致性与可预测性</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 类组件中的生命周期不一致性</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Example</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123; <span class="attr">count</span>: <span class="number">0</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">title</span> = <span class="string">`Count: <span class="subst">$&#123;<span class="variable language_">this</span>.state.count&#125;</span>`</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">interval</span> = <span class="built_in">setInterval</span>(<span class="variable language_">this</span>.<span class="property">tick</span>, <span class="number">1000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">componentDidUpdate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">title</span> = <span class="string">`Count: <span class="subst">$&#123;<span class="variable language_">this</span>.state.count&#125;</span>`</span>;</span><br><span class="line">    <span class="comment">// 忘记检查props或state变化可能导致问题</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">componentWillUnmount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="built_in">clearInterval</span>(<span class="variable language_">this</span>.<span class="property">interval</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  tick = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">count</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">count</span> + <span class="number">1</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;this.state.count&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook带来的一致性</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Example</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 统一处理标题更新效果</span></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">title</span> = <span class="string">`Count: <span class="subst">$&#123;count&#125;</span>`</span>;</span><br><span class="line">  &#125;, [count]); <span class="comment">// 明确依赖</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 定时器效果</span></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> interval = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">setCount</span>(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="built_in">clearInterval</span>(interval);</span><br><span class="line">  &#125;, []); <span class="comment">// 明确只执行一次</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="总结：Hook的优势"><a href="#总结：Hook的优势" class="headerlink" title="总结：Hook的优势"></a>总结：Hook的优势</h3><ol><li><strong>关注点分离</strong>：可以按功能而非生命周期划分代码</li><li><strong>代码复用</strong>：自定义Hook使逻辑复用变得简单直观</li><li><strong>避免this</strong>：不需要理解JavaScript中的this绑定问题</li><li><strong>减少模板代码</strong>：不需要编写类、构造函数等模板代码</li><li><strong>优化编译</strong>：函数组件更容易被编译器优化</li><li><strong>更好的TypeScript支持</strong>：泛型和类型推断在函数组件中工作得更好</li><li><strong>一致性</strong>：使用相同模式处理不同种类的副作用</li><li><strong>避免重复</strong>：避免在不同生命周期方法中复制相同的代码</li><li><strong>更小的包体积</strong>：通常生成更小的代码</li></ol><h2 id="项目实践注意事项"><a href="#项目实践注意事项" class="headerlink" title="项目实践注意事项"></a>项目实践注意事项</h2><h3 id="合理的组件拆分"><a href="#合理的组件拆分" class="headerlink" title="合理的组件拆分"></a>合理的组件拆分</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误：臃肿的组件</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Dashboard</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 大量状态和逻辑...</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;/* 大量 JSX... */&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确：拆分为小型、专注的组件</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Dashboard</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Header</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Sidebar</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">MainContent</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Summary</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">RecentActivity</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Statistics</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">MainContent</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Footer</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="数据获取与状态管理"><a href="#数据获取与状态管理" class="headerlink" title="数据获取与状态管理"></a>数据获取与状态管理</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 使用 React Query 等库管理数据获取状态</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">UserList</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; data, isLoading, error &#125; = <span class="title function_">useQuery</span>(<span class="string">&#x27;users&#x27;</span>, fetchUsers);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (isLoading) <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Loading</span> /&gt;</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Error</span> <span class="attr">message</span>=<span class="string">&#123;error.message&#125;</span> /&gt;</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;data.map(user =&gt; (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;user.id&#125;</span>&gt;</span>&#123;user.name&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      ))&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 使用状态管理库处理全局状态</span></span><br><span class="line"><span class="comment">// 例如 Redux Toolkit</span></span><br><span class="line"><span class="keyword">import</span> &#123; createSlice, configureStore &#125; <span class="keyword">from</span> <span class="string">&#x27;@reduxjs/toolkit&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> counterSlice = <span class="title function_">createSlice</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;counter&#x27;</span>,</span><br><span class="line">  <span class="attr">initialState</span>: &#123; <span class="attr">value</span>: <span class="number">0</span> &#125;,</span><br><span class="line">  <span class="attr">reducers</span>: &#123;</span><br><span class="line">    <span class="attr">increment</span>: <span class="function"><span class="params">state</span> =&gt;</span> &#123;</span><br><span class="line">      state.<span class="property">value</span> += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = <span class="title function_">configureStore</span>(&#123;</span><br><span class="line">  <span class="attr">reducer</span>: &#123;</span><br><span class="line">    <span class="attr">counter</span>: counterSlice.<span class="property">reducer</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="组件通信策略"><a href="#组件通信策略" class="headerlink" title="组件通信策略"></a>组件通信策略</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 对于深层组件通信，使用 Context API</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ThemeContext</span> = <span class="title function_">createContext</span>(<span class="string">&#x27;light&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [theme, setTheme] = <span class="title function_">useState</span>(<span class="string">&#x27;light&#x27;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">ThemeContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;&#123;</span> <span class="attr">theme</span>, <span class="attr">setTheme</span> &#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Main</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ThemeContext.Provider</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在深层组件中使用</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ThemedButton</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; theme, setTheme &#125; = <span class="title function_">useContext</span>(<span class="title class_">ThemeContext</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">background:</span> <span class="attr">theme</span> === <span class="string">&#x27;light&#x27;</span> ? &#x27;#<span class="attr">fff</span>&#x27; <span class="attr">:</span> &#x27;#<span class="attr">000</span>&#x27; &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setTheme(theme === &#x27;light&#x27; ? &#x27;dark&#x27; : &#x27;light&#x27;)&#125;</span></span><br><span class="line"><span class="language-xml">    &gt;</span></span><br><span class="line"><span class="language-xml">      切换主题</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="错误边界处理"><a href="#错误边界处理" class="headerlink" title="错误边界处理"></a>错误边界处理</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义错误边界组件</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ErrorBoundary</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123; <span class="attr">hasError</span>: <span class="literal">false</span>, <span class="attr">error</span>: <span class="literal">null</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">getDerivedStateFromError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">hasError</span>: <span class="literal">true</span>, error &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">componentDidCatch</span>(<span class="params">error, errorInfo</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;Caught error:&quot;</span>, error, errorInfo);</span><br><span class="line">    <span class="comment">// 可以发送到错误追踪服务</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">hasError</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">fallback</span> || <span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>出错了<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">children</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用错误边界包裹可能出错的组件</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">ErrorBoundary</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">p</span>&gt;</span>头部加载失败<span class="tag">&lt;/<span class="name">p</span>&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Header</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">ErrorBoundary</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">ErrorBoundary</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">p</span>&gt;</span>内容加载失败<span class="tag">&lt;/<span class="name">p</span>&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Content</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">ErrorBoundary</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="性能优化技巧"><a href="#性能优化技巧" class="headerlink" title="性能优化技巧"></a>性能优化技巧</h2><div style="background-color: #eafaf1; padding: 20px; border-radius: 5px; margin: 20px 0;"><h3 style="margin-top: 0; color: #27ae60;">⚡ 性能优化核心原则</h3><ol>  <li><strong>减少渲染次数</strong>：避免不必要的重新渲染</li>  <li><strong>减少计算量</strong>：缓存计算结果和回调函数</li>  <li><strong>减少渲染量</strong>：只渲染用户可见的内容</li>  <li><strong>代码分割</strong>：按需加载代码</li>  <li><strong>资源优化</strong>：优化图片和其他资源</li></ol></div><h3 id="React-memo-useMemo-和-useCallback"><a href="#React-memo-useMemo-和-useCallback" class="headerlink" title="React.memo, useMemo 和 useCallback"></a>React.memo, useMemo 和 useCallback</h3><p>这些API帮助我们控制组件和值的重新计算，避免不必要的渲染和计算。</p><div style="display: flex; flex-wrap: wrap; gap: 20px; margin: 20px 0;">  <div style="flex: 1; min-width: 300px; border: 1px solid #ddd; border-radius: 5px; padding: 15px;">    <h4>React.memo</h4>    <p>记忆化组件，当props不变时跳过重新渲染</p>    <pre><code>const MemoComponent = React.memo(MyComponent);</code></pre>  </div>  <div style="flex: 1; min-width: 300px; border: 1px solid #ddd; border-radius: 5px; padding: 15px;">    <h4>useMemo</h4>    <p>记忆化计算结果，依赖项不变时跳过重新计算</p>    <pre><code>const result = useMemo(() => compute(a, b), [a, b]);</code></pre>  </div>  <div style="flex: 1; min-width: 300px; border: 1px solid #ddd; border-radius: 5px; padding: 15px;">    <h4>useCallback</h4>    <p>记忆化回调函数，依赖项不变时保持函数引用不变</p>    <pre><code>const handler = useCallback(() => doSomething(a), [a]);</code></pre>  </div></div><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 React.memo 避免不必要的重渲染</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MemoizedComponent</span> = <span class="title class_">React</span>.<span class="title function_">memo</span>(<span class="keyword">function</span> <span class="title function_">MyComponent</span>(<span class="params">props</span>) &#123;</span><br><span class="line">  <span class="comment">// 只有当 props 变化时才会重新渲染</span></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;props.name&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义比较函数 - 深度控制重新渲染的条件</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">areEqual</span> = (<span class="params">prevProps, nextProps</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 只比较关心的 props</span></span><br><span class="line">  <span class="keyword">return</span> prevProps.<span class="property">id</span> === nextProps.<span class="property">id</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MemoizedWithCustomCompare</span> = <span class="title class_">React</span>.<span class="title function_">memo</span>(<span class="title class_">MyComponent</span>, areEqual);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配合 useCallback 使用以稳定化传递给子组件的函数引用</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ParentComponent</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 不使用 useCallback 时，每次 ParentComponent 重新渲染，handleClick 都是新函数</span></span><br><span class="line">  <span class="comment">// 导致 MemoizedComponent 尽管使用了 React.memo 也会重新渲染</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 使用 useCallback 记忆化函数，保持引用稳定</span></span><br><span class="line">  <span class="keyword">const</span> handleClick = <span class="title function_">useCallback</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Button clicked&#x27;</span>);</span><br><span class="line">  &#125;, []); <span class="comment">// 依赖项为空数组，handleClick 引用永远不变</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">MemoizedComponent</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setCount(count + 1)&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        更新计数: &#123;count&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div style="background-color: #fff8dc; padding: 15px; border-left: 5px solid #f1c40f; margin: 15px 0;"><strong>⚠️ 注意</strong>：过度优化可能导致代码复杂性增加。在应用这些技术前，确保你已经遇到了真正的性能问题。</div><h3 id="虚拟列表渲染"><a href="#虚拟列表渲染" class="headerlink" title="虚拟列表渲染"></a>虚拟列表渲染</h3><p>当需要渲染大量数据时，可以使用虚拟列表技术只渲染可视区域内的项目。</p><div style="text-align: center; margin: 20px 0;"><pre style="display: inline-block; text-align: left; background-color: #f9f9f9; padding: 15px; border-radius: 5px;">┌─────────────────────────┐│    可视区域 (例如600px)   │├─────────────────────────┤│ Item 1                  │ ◄── 只渲染这些可见项│ Item 2                  ││ Item 3                  ││ ...                     ││ Item 20                 │├─────────────────────────┤│                         ││  (其他1000个项不渲染)     │ ◄── 节省内存和CPU│                         │└─────────────────────────┘</pre></div><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 react-window 实现虚拟列表</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">FixedSizeList</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react-window&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">VirtualizedList</span>(<span class="params">&#123; items &#125;</span>) &#123;</span><br><span class="line">  <span class="comment">// Row 组件复用 - 根据提供的 index 渲染不同的内容</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">Row</span> = (<span class="params">&#123; index, style &#125;</span>) =&gt; (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;style&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      Item &#123;items[index]&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">FixedSizeList</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">height</span>=<span class="string">&#123;500&#125;</span>        // <span class="attr">列表可视区域高度</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">width</span>=<span class="string">&quot;100%&quot;</span>        // <span class="attr">列表宽度</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">itemCount</span>=<span class="string">&#123;items.length&#125;</span>  // <span class="attr">总项目数量</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">itemSize</span>=<span class="string">&#123;35&#125;</span>       // <span class="attr">每项高度</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    &gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;Row&#125;  // 渲染每行的组件</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">FixedSizeList</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="代码分割与懒加载"><a href="#代码分割与懒加载" class="headerlink" title="代码分割与懒加载"></a>代码分割与懒加载</h3><div style="background-color: #f0f7fb; padding: 15px; border-left: 5px solid #3498db; margin: 15px 0;"><strong>💡 最佳实践</strong>：将应用拆分成较小的代码块，并按需加载，可以显著减少初始加载时间。</div><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 React.lazy 和 Suspense 实现代码分割和懒加载</span></span><br><span class="line"><span class="comment">// 不导入整个组件，而是返回一个动态加载组件的Promise</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">LazyComponent</span> = <span class="title class_">React</span>.<span class="title function_">lazy</span>(<span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;./LazyComponent&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">MyComponent</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="comment">// Suspense 在组件加载时显示 fallback 内容</span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">div</span>&gt;</span>Loading...<span class="tag">&lt;/<span class="name">div</span>&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">LazyComponent</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基于路由的代码分割 - 按页面拆分代码</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BrowserRouter</span> <span class="keyword">as</span> <span class="title class_">Router</span>, <span class="title class_">Routes</span>, <span class="title class_">Route</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Home</span> = <span class="title class_">React</span>.<span class="title function_">lazy</span>(<span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;./routes/Home&#x27;</span>));</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">About</span> = <span class="title class_">React</span>.<span class="title function_">lazy</span>(<span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;./routes/About&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Router</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">div</span>&gt;</span>Loading...<span class="tag">&lt;/<span class="name">div</span>&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Routes</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;/&quot;</span> <span class="attr">element</span>=<span class="string">&#123;</span>&lt;<span class="attr">Home</span> /&gt;</span>&#125; /&gt;</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;/about&quot;</span> <span class="attr">element</span>=<span class="string">&#123;</span>&lt;<span class="attr">About</span> /&gt;</span>&#125; /&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Routes</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Router</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="使用-React-DevTools-进行性能分析"><a href="#使用-React-DevTools-进行性能分析" class="headerlink" title="使用 React DevTools 进行性能分析"></a>使用 React DevTools 进行性能分析</h3><div style="display: flex; flex-direction: column; gap: 10px; margin: 20px 0; background-color: #f9f9f9; padding: 15px; border-radius: 5px;">  <div><strong>性能分析步骤：</strong></div>  <div>1️⃣ 安装 React DevTools 扩展</div>  <div>2️⃣ 打开开发者工具，切换到 Profiler 选项卡</div>  <div>3️⃣ 点击录制按钮，执行要分析的操作</div>  <div>4️⃣ 停止录制，分析火焰图和排名图表</div>  <div>5️⃣ 找出重新渲染次数过多或渲染时间过长的组件</div>  <div>6️⃣ 使用 memo, useMemo, useCallback 等优化</div></div><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 Profiler API 进行程序化性能测量</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Profiler</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 性能数据回调函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">onRenderCallback</span>(<span class="params"></span></span><br><span class="line"><span class="params">  id,            <span class="comment">// 发生提交的 Profiler 树的 &quot;id&quot;</span></span></span><br><span class="line"><span class="params">  phase,         <span class="comment">// &quot;mount&quot; (首次挂载) 或 &quot;update&quot; (重新渲染)</span></span></span><br><span class="line"><span class="params">  actualDuration, <span class="comment">// 本次更新中渲染花费的时间</span></span></span><br><span class="line"><span class="params">  baseDuration,  <span class="comment">// 估计不使用 memoization 的情况下渲染整个子树需要的时间</span></span></span><br><span class="line"><span class="params">  startTime,     <span class="comment">// 本次更新中 React 开始渲染的时间戳</span></span></span><br><span class="line"><span class="params">  commitTime,    <span class="comment">// 本次更新中 React 提交更新的时间戳</span></span></span><br><span class="line"><span class="params">  interactions   <span class="comment">// 属于本次更新的 interactions 集合</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 将性能数据发送到分析服务或记录到控制台</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`组件 <span class="subst">$&#123;id&#125;</span> <span class="subst">$&#123;phase&#125;</span> 渲染耗时: <span class="subst">$&#123;actualDuration&#125;</span>ms`</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">MyApp</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Profiler</span> <span class="attr">id</span>=<span class="string">&quot;App&quot;</span> <span class="attr">onRender</span>=<span class="string">&#123;onRenderCallback&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">App</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Profiler</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="React-18-核心特性"><a href="#React-18-核心特性" class="headerlink" title="React 18 核心特性"></a>React 18 核心特性</h2><h3 id="并发渲染-Concurrent-Rendering"><a href="#并发渲染-Concurrent-Rendering" class="headerlink" title="并发渲染 (Concurrent Rendering)"></a>并发渲染 (Concurrent Rendering)</h3><p>React 18 引入的最重要特性是并发渲染，这使 React 能够同时准备多个UI状态，而不会阻塞主线程。</p><h4 id="实际应用"><a href="#实际应用" class="headerlink" title="实际应用"></a>实际应用</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 Transition API 进行非阻塞更新</span></span><br><span class="line"><span class="keyword">import</span> &#123; startTransition, useTransition &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">SearchResults</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [query, setQuery] = <span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> [isPending, startTransition] = <span class="title function_">useTransition</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">updateQuery</span> = (<span class="params">e</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 紧急更新：立即响应用户输入</span></span><br><span class="line">    <span class="title function_">setInputValue</span>(e.<span class="property">target</span>.<span class="property">value</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 非紧急更新：可以被中断的搜索结果更新</span></span><br><span class="line">    <span class="title function_">startTransition</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">setQuery</span>(e.<span class="property">target</span>.<span class="property">value</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">onChange</span>=<span class="string">&#123;updateQuery&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;isPending &amp;&amp; <span class="tag">&lt;<span class="name">div</span>&gt;</span>加载中...<span class="tag">&lt;/<span class="name">div</span>&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">SearchResults</span> <span class="attr">query</span>=<span class="string">&#123;query&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="自动批处理-Automatic-Batching"><a href="#自动批处理-Automatic-Batching" class="headerlink" title="自动批处理 (Automatic Batching)"></a>自动批处理 (Automatic Batching)</h3><p>React 18 默认对所有更新进行批处理，包括事件处理程序、定时器、promises等，减少不必要的重新渲染。</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在 React 18 之前</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handleClick</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 这些会导致两次单独的渲染</span></span><br><span class="line">  <span class="title function_">setCount</span>(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>);</span><br><span class="line">  <span class="title function_">setFlag</span>(<span class="function"><span class="params">f</span> =&gt;</span> !f);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// React 18 中自动批处理 - 只有一次渲染</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handleClick</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">setCount</span>(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>);</span><br><span class="line">  <span class="title function_">setFlag</span>(<span class="function"><span class="params">f</span> =&gt;</span> !f);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 禁用批处理（如果需要）</span></span><br><span class="line"><span class="keyword">import</span> &#123; flushSync &#125; <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handleClick</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">flushSync</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setCount</span>(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 立即渲染</span></span><br><span class="line">  <span class="title function_">flushSync</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setFlag</span>(<span class="function"><span class="params">f</span> =&gt;</span> !f);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 再次立即渲染</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Suspense-改进"><a href="#Suspense-改进" class="headerlink" title="Suspense 改进"></a>Suspense 改进</h3><p>React 18 对 Suspense 组件进行了增强，支持服务端渲染和并发特性。</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Suspense</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">Loading</span> /&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">SomeComponent</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="新的客户端渲染-API"><a href="#新的客户端渲染-API" class="headerlink" title="新的客户端渲染 API"></a>新的客户端渲染 API</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// React 18 之前</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ReactDOM</span> <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span>;</span><br><span class="line"><span class="title class_">ReactDOM</span>.<span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span></span>, container);</span><br><span class="line"></span><br><span class="line"><span class="comment">// React 18</span></span><br><span class="line"><span class="keyword">import</span> &#123; createRoot &#125; <span class="keyword">from</span> <span class="string">&#x27;react-dom/client&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> root = <span class="title function_">createRoot</span>(container);</span><br><span class="line">root.<span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span></span>);</span><br></pre></td></tr></table></figure><h3 id="useId-Hook"><a href="#useId-Hook" class="headerlink" title="useId Hook"></a>useId Hook</h3><p>生成服务端和客户端一致的唯一 ID。</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">NameFields</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> id = <span class="title function_">useId</span>();</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">label</span> <span class="attr">htmlFor</span>=<span class="string">&#123;</span>`$&#123;<span class="attr">id</span>&#125;<span class="attr">-firstName</span>`&#125;&gt;</span>First Name<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&#123;</span>`$&#123;<span class="attr">id</span>&#125;<span class="attr">-firstName</span>`&#125; /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">label</span> <span class="attr">htmlFor</span>=<span class="string">&#123;</span>`$&#123;<span class="attr">id</span>&#125;<span class="attr">-lastName</span>`&#125;&gt;</span>Last Name<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&#123;</span>`$&#123;<span class="attr">id</span>&#125;<span class="attr">-lastName</span>`&#125; /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="useDeferredValue"><a href="#useDeferredValue" class="headerlink" title="useDeferredValue"></a>useDeferredValue</h3><p>允许延迟更新非关键UI部分。</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">SearchResults</span>(<span class="params">&#123; query &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> deferredQuery = <span class="title function_">useDeferredValue</span>(query);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 使用 deferredQuery 进行搜索，这部分可能会&quot;滞后&quot;于输入</span></span><br><span class="line">  <span class="comment">// 但不会阻塞用户交互</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Results</span> <span class="attr">query</span>=<span class="string">&#123;deferredQuery&#125;</span> /&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="React-19-新特性与展望"><a href="#React-19-新特性与展望" class="headerlink" title="React 19 新特性与展望"></a>React 19 新特性与展望</h2><blockquote><p>注：React 19 仍在开发中，以下内容基于官方已公布信息和开发路线图。</p></blockquote><h3 id="新的-React-编译器"><a href="#新的-React-编译器" class="headerlink" title="新的 React 编译器"></a>新的 React 编译器</h3><p>React 19 将引入一个新的编译器，可以自动优化组件渲染，减少不必要的重新渲染。</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编译前</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>You clicked &#123;count&#125; times<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setCount(count + 1)&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        Click me</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 编译后 (示意，实际编译结果可能不同)</span></span><br><span class="line"><span class="comment">// 编译器会自动分析并优化组件渲染逻辑</span></span><br></pre></td></tr></table></figure><h3 id="Actions"><a href="#Actions" class="headerlink" title="Actions"></a>Actions</h3><p>React 19 的一个主要新特性是 Actions，它将允许直接在组件中定义与服务器交互的逻辑。</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// React 19 中的 Actions (示例)</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">MyForm</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 定义一个可以直接提交到服务器的动作</span></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">saveAction</span>(<span class="params">formData</span>) &#123;</span><br><span class="line">    <span class="string">&#x27;use server&#x27;</span>;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">saveToDatabase</span>(formData);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&#123;saveAction&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>保存<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Hooks-的改进"><a href="#Hooks-的改进" class="headerlink" title="Hooks 的改进"></a>Hooks 的改进</h3><p>React 19 将进一步改进 Hooks API，以解决一些现有的限制和问题。</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// React 19 中可能的新 Hook (示例)</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">MyComponent</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; value, setValue &#125; = <span class="title function_">useSignal</span>(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>当前值: &#123;value&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setValue(value + 1)&#125;&gt;增加<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Asset-Loading"><a href="#Asset-Loading" class="headerlink" title="Asset Loading"></a>Asset Loading</h3><p>改进资源加载机制，更好地处理图片、字体等资源。</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// React 19 中可能的资源加载API</span></span><br><span class="line"><span class="keyword">import</span> &#123; useAsset &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Avatar</span>(<span class="params">&#123; src &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> imgAsset = <span class="title function_">useAsset</span>(src);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (imgAsset.<span class="property">loading</span>) <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Spinner</span> /&gt;</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (imgAsset.<span class="property">error</span>) <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">ErrorFallback</span> <span class="attr">error</span>=<span class="string">&#123;imgAsset.error&#125;</span> /&gt;</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#123;imgAsset.url&#125;</span> /&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="易错点与陷阱"><a href="#易错点与陷阱" class="headerlink" title="易错点与陷阱"></a>易错点与陷阱</h2><h3 id="常见的错误和陷阱"><a href="#常见的错误和陷阱" class="headerlink" title="常见的错误和陷阱"></a>常见的错误和陷阱</h3><ol><li><strong>状态管理</strong>：不正确的状态管理可能导致组件无法正确渲染或更新。</li><li><strong>事件处理</strong>：不正确的事件处理可能导致组件无法响应用户输入。</li><li><strong>条件渲染</strong>：不正确的条件渲染可能导致组件无法正确显示或隐藏。</li><li><strong>性能优化</strong>：不正确的性能优化可能导致应用性能下降。</li></ol><h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><ol><li><strong>使用正确的状态管理库</strong>：例如，Redux Toolkit 或 React Context API。</li><li><strong>正确处理事件</strong>：确保事件处理程序正确绑定和执行。</li><li><strong>使用条件渲染</strong>：确保条件逻辑正确，避免不必要的重新渲染。</li><li><strong>进行性能测试</strong>：使用 React DevTools 或 Profiler API 进行性能分析。</li></ol><h3 id="依赖项数组处理不当"><a href="#依赖项数组处理不当" class="headerlink" title="依赖项数组处理不当"></a>依赖项数组处理不当</h3><div style="background-color: #f8e5e5; padding: 15px; border-left: 5px solid #e74c3c; margin: 15px 0;"><strong>🚫 常见错误</strong>：在 useEffect 的依赖项数组中遗漏使用的变量，可能导致过时闭包问题。</div><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误：缺少依赖项</span></span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">fetchData</span>(userId);</span><br><span class="line">&#125;, []); <span class="comment">// 应该包含 userId</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确：包含所有依赖项</span></span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">fetchData</span>(userId);</span><br><span class="line">&#125;, [userId]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 更好的做法：使用 useCallback 稳定化函数</span></span><br><span class="line"><span class="keyword">const</span> fetchUserData = <span class="title function_">useCallback</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">fetchData</span>(userId);</span><br><span class="line">&#125;, [userId]);</span><br><span class="line"></span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">fetchUserData</span>();</span><br><span class="line">&#125;, [fetchUserData]);</span><br></pre></td></tr></table></figure><h3 id="状态更新后无法立即获取最新值"><a href="#状态更新后无法立即获取最新值" class="headerlink" title="状态更新后无法立即获取最新值"></a>状态更新后无法立即获取最新值</h3><div style="display: flex; margin: 20px 0;">  <div style="background-color: #ffcccc; padding: 15px; border-radius: 5px 0 0 5px; width: 48%;">    <strong>❌ 问题</strong>    <p>React 状态更新是异步的，因此在调用 setState 之后立即尝试读取状态值会得到更新前的旧值。</p>  </div>  <div style="background-color: #ccffcc; padding: 15px; border-radius: 0 5px 5px 0; width: 48%;">    <strong>✅ 解决方案</strong>    <p>使用 useEffect 监听状态变化，或使用函数式更新回调访问最新状态。</p>  </div></div><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误：状态更新后立即使用</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleClick</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">setCount</span>(count + <span class="number">1</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(count); <span class="comment">// 仍然是旧值，不会立即更新</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 错误地尝试基于更新后的状态执行操作</span></span><br><span class="line">    <span class="keyword">if</span> (count === <span class="number">10</span>) &#123;</span><br><span class="line">      <span class="title function_">alert</span>(<span class="string">&#x27;达到10次点击！&#x27;</span>); <span class="comment">// 无法正确触发，因为count还是旧值</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      点击次数: &#123;count&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确：使用useEffect监听状态变化</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 当count变化时触发</span></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (count === <span class="number">10</span>) &#123;</span><br><span class="line">      <span class="title function_">alert</span>(<span class="string">&#x27;达到10次点击！&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [count]);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleClick</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">setCount</span>(count + <span class="number">1</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      点击次数: &#123;count&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 另一种方式：使用函数式更新的回调</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleClick</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">setCount</span>(<span class="function"><span class="params">prevCount</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> newCount = prevCount + <span class="number">1</span>;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 在这里可以访问到更新后的值</span></span><br><span class="line">      <span class="keyword">if</span> (newCount === <span class="number">10</span>) &#123;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&#x27;达到10次点击！&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> newCount;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      点击次数: &#123;count&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="对象和数组状态更新"><a href="#对象和数组状态更新" class="headerlink" title="对象和数组状态更新"></a>对象和数组状态更新</h3><div style="background-color: #f0f7fb; padding: 15px; border-left: 5px solid #3498db; margin: 15px 0;"><strong>💡 关键概念</strong>：React 使用浅比较来检测状态变化。当更新对象或数组状态时，必须创建新的引用，而不是修改现有引用。</div><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误：直接修改状态对象</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">UserProfile</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = <span class="title function_">useState</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;张三&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">25</span>,</span><br><span class="line">    <span class="attr">address</span>: &#123;</span><br><span class="line">      <span class="attr">city</span>: <span class="string">&#x27;北京&#x27;</span>,</span><br><span class="line">      <span class="attr">street</span>: <span class="string">&#x27;朝阳区&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">updateStreet</span> = (<span class="params">newStreet</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 直接修改状态，不会触发重新渲染</span></span><br><span class="line">    user.<span class="property">address</span>.<span class="property">street</span> = newStreet;</span><br><span class="line">    <span class="title function_">setUser</span>(user); <span class="comment">// 这没用，因为引用没变</span></span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ❌ 错误：数组操作同样的问题</span></span><br><span class="line">  <span class="keyword">const</span> [items, setItems] = <span class="title function_">useState</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">addItem</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    items.<span class="title function_">push</span>(<span class="number">4</span>); <span class="comment">// 直接修改数组</span></span><br><span class="line">    <span class="title function_">setItems</span>(items); <span class="comment">// 不会触发重新渲染，因为引用没变</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确：使用展开运算符创建新对象</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">UserProfile</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = <span class="title function_">useState</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;张三&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">25</span>,</span><br><span class="line">    <span class="attr">address</span>: &#123;</span><br><span class="line">      <span class="attr">city</span>: <span class="string">&#x27;北京&#x27;</span>,</span><br><span class="line">      <span class="attr">street</span>: <span class="string">&#x27;朝阳区&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">updateStreet</span> = (<span class="params">newStreet</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 正确地创建新对象</span></span><br><span class="line">    <span class="title function_">setUser</span>(&#123;</span><br><span class="line">      ...user,</span><br><span class="line">      <span class="attr">address</span>: &#123;</span><br><span class="line">        ...user.<span class="property">address</span>,</span><br><span class="line">        <span class="attr">street</span>: newStreet</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ✅ 正确：数组操作</span></span><br><span class="line">  <span class="keyword">const</span> [items, setItems] = <span class="title function_">useState</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">addItem</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">setItems</span>([...items, <span class="number">4</span>]); <span class="comment">// 创建新数组</span></span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 使用数组的filter、map等不可变方法</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">removeItem</span> = (<span class="params">index</span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">setItems</span>(items.<span class="title function_">filter</span>(<span class="function">(<span class="params">_, i</span>) =&gt;</span> i !== index));</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="条件渲染中的Hook使用"><a href="#条件渲染中的Hook使用" class="headerlink" title="条件渲染中的Hook使用"></a>条件渲染中的Hook使用</h3><div style="background-color: #f8e5e5; padding: 15px; border: 2px dashed #e74c3c; margin: 15px 0; border-radius: 5px;"><strong>⚠️ Hook规则</strong>：<ol><li>只在函数组件或自定义Hook的顶层调用Hook</li><li>不要在循环、条件或嵌套函数中调用Hook</li><li>遵循这些规则确保Hook在每次渲染时都以相同的顺序被调用</li></ol></div><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误：条件性调用Hooks</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ConditionalHook</span>(<span class="params">&#123; isLoggedIn &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (isLoggedIn) &#123;</span><br><span class="line">    <span class="comment">// 错误：不能在条件语句中调用Hook</span></span><br><span class="line">    <span class="keyword">const</span> [name, setName] = <span class="title function_">useState</span>(<span class="string">&#x27;user&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 错误：不能在循环中调用Hook</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> [item, setItem] = <span class="title function_">useState</span>(i);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 错误：不能在普通函数中调用Hook</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">handleClick</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> [clicked, setClicked] = <span class="title function_">useState</span>(<span class="literal">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确：Hooks必须在组件顶层无条件调用</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">CorrectHookUsage</span>(<span class="params">&#123; isLoggedIn &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> [name, setName] = <span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>);  <span class="comment">// 始终调用，不管isLoggedIn的值</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 正确：条件语句在Hook调用之后</span></span><br><span class="line">  <span class="keyword">if</span> (isLoggedIn) &#123;</span><br><span class="line">    <span class="comment">// 使用已声明的state</span></span><br><span class="line">    <span class="title function_">setName</span>(<span class="string">&#x27;user&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;isLoggedIn &amp;&amp; <span class="tag">&lt;<span class="name">p</span>&gt;</span>欢迎, &#123;name&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>点击次数: &#123;count&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setCount(count + 1)&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        点击</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="额外资源"><a href="#额外资源" class="headerlink" title="额外资源"></a>额外资源</h2><ol><li><a href="https://react.dev/">React 官方文档</a></li><li><a href="https://github.com/facebook/react">React GitHub 存储库</a></li><li><a href="https://reactjs.org/blog/">React 团队博客</a></li><li><a href="https://github.com/reactwg/react-18">React 18 工作组讨论</a></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;React-18-19-学习总结&quot;&gt;&lt;a href=&quot;#React-18-19-学习总结&quot; class=&quot;headerlink&quot; title=&quot;React 18&amp;#x2F;19 学习总结&quot;&gt;&lt;/a&gt;React 18&amp;#x2F;19 学习总结&lt;/h1&gt;&lt;h2 id=</summary>
      
    
    
    
    
    <category term="react" scheme="https://aoayaoa.github.io/tags/react/"/>
    
  </entry>
  
  <entry>
    <title>nginx 学习配置记录</title>
    <link href="https://aoayaoa.github.io/2025/01/07/nginx/"/>
    <id>https://aoayaoa.github.io/2025/01/07/nginx/</id>
    <published>2025-01-06T16:00:00.000Z</published>
    <updated>2025-04-14T08:05:46.547Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Nginx-Web-服务器配置"><a href="#Nginx-Web-服务器配置" class="headerlink" title="Nginx Web 服务器配置"></a>Nginx Web 服务器配置</h1><p>一个生产环境ready的Nginx配置模板，包含HTTP&#x2F;2、SSL、安全头信息和性能优化。</p><h2 id="📋-特性"><a href="#📋-特性" class="headerlink" title="📋 特性"></a>📋 特性</h2><ul><li>支持HTTP&#x2F;2以提升性能</li><li>自动HTTP到HTTPS重定向</li><li>现代SSL&#x2F;TLS配置与安全密码套件</li><li>静态文件缓存以提高性能</li><li>Gzip压缩以减少带宽使用</li><li>PHP-FPM支持PHP应用</li><li>后端服务的反向代理配置</li><li>包括HSTS在内的安全头信息</li><li>优化的性能设置</li></ul><h2 id="🚀-安装"><a href="#🚀-安装" class="headerlink" title="🚀 安装"></a>🚀 安装</h2><h3 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h3><ul><li>Nginx (建议1.18+版本)</li><li>用于SSL&#x2F;TLS支持的OpenSSL</li><li>有效的SSL证书(用于HTTPS支持)</li></ul><h3 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h3><ol><li><p><strong>安装Nginx:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Debian/Ubuntu</span></span><br><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS/RHEL</span></span><br><span class="line"><span class="built_in">sudo</span> yum install epel-release</span><br><span class="line"><span class="built_in">sudo</span> yum install nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># macOS</span></span><br><span class="line">brew install nginx</span><br></pre></td></tr></table></figure></li><li><p><strong>替换默认Nginx配置:</strong></p><p>将<code>nginx.conf</code>文件复制到Nginx配置目录:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> nginx.conf /etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure></li><li><p><strong>创建SSL证书目录:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /etc/nginx/ssl</span><br></pre></td></tr></table></figure></li><li><p><strong>安装SSL证书:</strong></p><p>将SSL证书和密钥文件放在<code>/etc/nginx/ssl/</code>目录中:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> example.com.crt /etc/nginx/ssl/</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> example.com.key /etc/nginx/ssl/</span><br></pre></td></tr></table></figure><p>如果你没有证书，可以使用Let’s Encrypt生成:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install certbot python3-certbot-nginx</span><br><span class="line"><span class="built_in">sudo</span> certbot --nginx -d example.com -d www.example.com</span><br></pre></td></tr></table></figure></li><li><p><strong>更新域名:</strong></p><p>编辑配置文件，将<code>example.com</code>替换为你的实际域名。</p></li><li><p><strong>测试配置:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nginx -t</span><br></pre></td></tr></table></figure></li><li><p><strong>重启Nginx:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl restart nginx</span><br></pre></td></tr></table></figure></li></ol><h2 id="⚙️-配置详情"><a href="#⚙️-配置详情" class="headerlink" title="⚙️ 配置详情"></a>⚙️ 配置详情</h2><h3 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h3><p>配置分为以下几个部分:</p><ul><li><strong>全局设置</strong>: 用户、进程、日志和PID文件</li><li><strong>事件块</strong>: 连接处理</li><li><strong>HTTP块</strong>: MIME类型、日志和性能优化</li><li><strong>Server块</strong>: 单个网站配置</li></ul><h3 id="关键配置元素"><a href="#关键配置元素" class="headerlink" title="关键配置元素"></a>关键配置元素</h3><h4 id="SSL-TLS设置"><a href="#SSL-TLS设置" class="headerlink" title="SSL&#x2F;TLS设置"></a>SSL&#x2F;TLS设置</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line"><span class="attribute">ssl_ciphers</span> ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;</span><br><span class="line"><span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">off</span>;</span><br></pre></td></tr></table></figure><h4 id="HSTS设置"><a href="#HSTS设置" class="headerlink" title="HSTS设置"></a>HSTS设置</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">add_header</span> Strict-Transport-Security <span class="string">&quot;max-age=63072000&quot;</span> always;</span><br></pre></td></tr></table></figure><h4 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /api/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:8080/;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    <span class="comment"># 其他头信息...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="🔧-自定义"><a href="#🔧-自定义" class="headerlink" title="🔧 自定义"></a>🔧 自定义</h2><h3 id="添加新站点"><a href="#添加新站点" class="headerlink" title="添加新站点"></a>添加新站点</h3><ol><li><p>在<code>/etc/nginx/conf.d/example.conf</code>创建新的server块:</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl http2;</span><br><span class="line">    <span class="attribute">server_name</span> newsite.com;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/nginx/ssl/newsite.com.crt;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/nginx/ssl/newsite.com.key;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">root</span> /var/www/newsite.com;</span><br><span class="line">    <span class="comment"># 其他配置...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>创建HTTP到HTTPS重定向:</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> newsite.com;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="调整性能设置"><a href="#调整性能设置" class="headerlink" title="调整性能设置"></a>调整性能设置</h3><p>你可以根据服务器资源调整以下设置:</p><ul><li><code>worker_processes</code>: 设置为CPU核心数</li><li><code>worker_connections</code>: 高流量站点可增加此值</li><li><code>keepalive_timeout</code>: 根据应用需求调整</li><li><code>client_max_body_size</code>: 根据上传需求设置</li></ul><h2 id="🛡️-安全考虑"><a href="#🛡️-安全考虑" class="headerlink" title="🛡️ 安全考虑"></a>🛡️ 安全考虑</h2><p>此配置包含几项安全增强:</p><ul><li>现代TLS协议和密码套件</li><li>HTTP严格传输安全(HSTS)</li><li>限制访问隐藏文件</li><li>防止MIME类型嗅探的头信息</li></ul><p>额外建议:</p><ul><li>为登录页面和API端点启用速率限制</li><li>考虑添加ModSecurity作为Web应用防火墙</li><li>实现Content-Security-Policy头信息</li><li>定期更新Nginx到最新版本</li></ul><h2 id="📊-监控和日志"><a href="#📊-监控和日志" class="headerlink" title="📊 监控和日志"></a>📊 监控和日志</h2><h3 id="日志位置"><a href="#日志位置" class="headerlink" title="日志位置"></a>日志位置</h3><ul><li>访问日志: <code>/var/log/nginx/access.log</code></li><li>错误日志: <code>/var/log/nginx/error.log</code></li></ul><h3 id="实用命令"><a href="#实用命令" class="headerlink" title="实用命令"></a>实用命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看实时日志</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/nginx/error.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查语法错误</span></span><br><span class="line">nginx -t</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新加载配置</span></span><br><span class="line">nginx -s reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查Nginx状态</span></span><br><span class="line">systemctl status nginx</span><br></pre></td></tr></table></figure><h2 id="📝-许可"><a href="#📝-许可" class="headerlink" title="📝 许可"></a>📝 许可</h2><p>此配置基于MIT许可提供。你可以自由修改并用于你的项目。</p><h2 id="🙏-致谢"><a href="#🙏-致谢" class="headerlink" title="🙏 致谢"></a>🙏 致谢</h2><p>此配置整合了以下来源的最佳实践:</p><ul><li><a href="https://ssl-config.mozilla.org/">Mozilla SSL配置生成器</a></li><li><a href="https://www.acunetix.com/blog/web-security-zone/hardening-nginx/">Nginx加固指南</a></li><li>各种DevOps社区资源</li></ul><hr><p>⭐ 如果你觉得这个配置有用，请为仓库点星 ⭐ </p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Nginx-Web-服务器配置&quot;&gt;&lt;a href=&quot;#Nginx-Web-服务器配置&quot; class=&quot;headerlink&quot; title=&quot;Nginx Web 服务器配置&quot;&gt;&lt;/a&gt;Nginx Web 服务器配置&lt;/h1&gt;&lt;p&gt;一个生产环境ready的Nginx配</summary>
      
    
    
    
    
    <category term="性能优化" scheme="https://aoayaoa.github.io/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>深入理解Promise</title>
    <link href="https://aoayaoa.github.io/2024/12/13/Promise/"/>
    <id>https://aoayaoa.github.io/2024/12/13/Promise/</id>
    <published>2024-12-12T16:00:00.000Z</published>
    <updated>2025-03-07T03:59:37.941Z</updated>
    
    <content type="html"><![CDATA[<h1 id="深入理解-JavaScript-Promise：从入门到精通"><a href="#深入理解-JavaScript-Promise：从入门到精通" class="headerlink" title="深入理解 JavaScript Promise：从入门到精通"></a>深入理解 JavaScript Promise：从入门到精通</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Promise 是 JavaScript 中处理异步操作的核心机制，它的出现让我们告别了回调地狱，使异步代码更加清晰和易于维护。本文将深入探讨 Promise 的方方面面，从基础概念到高级应用，帮助你全面掌握这一重要特性。</p><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul><li><a href="#1-promise-%E5%9F%BA%E7%A1%80">1. Promise 基础</a></li><li><a href="#2-promise-%E7%8A%B6%E6%80%81">2. Promise 状态</a></li><li><a href="#3-promise-%E6%96%B9%E6%B3%95">3. Promise 方法</a></li><li><a href="#4-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">4. 错误处理</a></li><li><a href="#5-promise-%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8">5. Promise 链式调用</a></li><li><a href="#6-promise-%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95">6. Promise 静态方法</a></li><li><a href="#7-asyncawait">7. async&#x2F;await</a></li><li><a href="#8-%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF">8. 实际应用场景</a></li><li><a href="#9-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">9. 最佳实践</a></li><li><a href="#10-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E5%92%8C%E9%99%B7%E9%98%B1">10. 常见问题和陷阱</a></li><li><a href="#11-%E6%9B%B4%E5%A4%9A%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF">11. 更多实际应用场景</a></li><li><a href="#12-%E8%AF%A6%E7%BB%86%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E6%8C%87%E5%8D%97">12. 详细错误处理指南</a></li><li><a href="#13-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">13. 性能优化最佳实践</a></li><li><a href="#14-%E8%A1%A5%E5%85%85%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E5%BB%BA%E8%AE%AE">14. 补充最佳实践建议</a></li></ul><h2 id="1-Promise-基础"><a href="#1-Promise-基础" class="headerlink" title="1. Promise 基础"></a>1. Promise 基础</h2><h3 id="1-1-什么是-Promise？"><a href="#1-1-什么是-Promise？" class="headerlink" title="1.1 什么是 Promise？"></a>1.1 什么是 Promise？</h3><p>Promise 是异步编程的一种解决方案，比传统的回调函数更加优雅。它是一个代表了异步操作最终完成或失败的对象。通过 Promise，我们可以用同步操作的流程写法来处理异步操作，避免了回调函数层层嵌套的问题。</p><h3 id="1-2-基本语法"><a href="#1-2-基本语法" class="headerlink" title="1.2 基本语法"></a>1.2 基本语法</h3><p>Promise 的基本语法非常简单，让我们通过一个例子来了解：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 异步操作</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="comment">/* 操作成功 */</span>) &#123;</span><br><span class="line">        <span class="title function_">resolve</span>(value);  <span class="comment">// 成功时调用</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">reject</span>(error);   <span class="comment">// 失败时调用</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>这个构造函数接收一个执行器（executor）函数作为参数，该函数会立即执行。执行器函数接收两个参数：resolve 和 reject，它们是由 JavaScript 引擎提供的函数。</p><h3 id="1-3-基本用法"><a href="#1-3-基本用法" class="headerlink" title="1.3 基本用法"></a>1.3 基本用法</h3><p>Promise 对象创建后，我们可以通过它的方法来处理异步操作的结果：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">promise</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 处理成功情况</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;成功：&#x27;</span>, result);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 处理错误情况</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;错误：&#x27;</span>, error);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">finally</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 总是执行</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;操作完成&#x27;</span>);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><p>这种链式调用的方式使得异步操作的流程更加清晰，代码更易于理解和维护。</p><h2 id="2-Promise-状态"><a href="#2-Promise-状态" class="headerlink" title="2. Promise 状态"></a>2. Promise 状态</h2><p>Promise 的状态是它的核心特性之一，理解 Promise 的状态对于正确使用它至关重要。</p><h3 id="2-1-三种状态"><a href="#2-1-三种状态" class="headerlink" title="2.1 三种状态"></a>2.1 三种状态</h3><p>Promise 有且仅有三种状态：</p><ul><li><strong>pending（进行中）</strong>：初始状态，既不是成功，也不是失败</li><li><strong>fulfilled（已成功）</strong>：操作成功完成</li><li><strong>rejected（已失败）</strong>：操作失败</li></ul><h3 id="2-2-状态转换"><a href="#2-2-状态转换" class="headerlink" title="2.2 状态转换"></a>2.2 状态转换</h3><p>Promise 的状态转换是单向的，一旦状态改变，就不会再变。这种特性称为”状态的不可逆性”。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 状态转换示例</span></span><br><span class="line"><span class="keyword">const</span> successPromise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">resolve</span>(<span class="string">&#x27;成功&#x27;</span>);  <span class="comment">// pending -&gt; fulfilled</span></span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> failedPromise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">reject</span>(<span class="string">&#x27;失败&#x27;</span>);   <span class="comment">// pending -&gt; rejected</span></span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="2-3-状态的不可逆性"><a href="#2-3-状态的不可逆性" class="headerlink" title="2.3 状态的不可逆性"></a>2.3 状态的不可逆性</h3><p>一旦 Promise 的状态改变，后续的状态修改操作将被忽略：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">resolve</span>(<span class="string">&#x27;成功&#x27;</span>);    <span class="comment">// 状态变为 fulfilled</span></span><br><span class="line">    <span class="title function_">reject</span>(<span class="string">&#x27;失败&#x27;</span>);     <span class="comment">// 这行代码会被忽略</span></span><br><span class="line">    <span class="title function_">resolve</span>(<span class="string">&#x27;再次成功&#x27;</span>); <span class="comment">// 这行代码也会被忽略</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="3-Promise-方法"><a href="#3-Promise-方法" class="headerlink" title="3. Promise 方法"></a>3. Promise 方法</h2><p>Promise 提供了几个关键的实例方法，让我们能够优雅地处理异步操作的结果。</p><h3 id="3-1-then-方法"><a href="#3-1-then-方法" class="headerlink" title="3.1 then() 方法"></a>3.1 then() 方法</h3><p><code>then()</code> 是最常用的 Promise 方法，它可以接收两个回调函数：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">promise.<span class="title function_">then</span>(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 处理成功的情况</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;成功：&#x27;</span>, result);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 处理失败的情况（可选）</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;失败：&#x27;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h3 id="3-2-catch-方法"><a href="#3-2-catch-方法" class="headerlink" title="3.2 catch() 方法"></a>3.2 catch() 方法</h3><p><code>catch()</code> 方法用于处理 Promise 中的错误，它是 <code>.then(null, rejection)</code> 的语法糖：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">promise.<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 处理错误</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;发生错误：&#x27;</span>, error);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="3-3-finally-方法"><a href="#3-3-finally-方法" class="headerlink" title="3.3 finally() 方法"></a>3.3 finally() 方法</h3><p><code>finally()</code> 方法用于指定无论 Promise 对象最后状态如何，都会执行的操作：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">promise.<span class="title function_">finally</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 清理工作</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Promise 已完成&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="4-错误处理"><a href="#4-错误处理" class="headerlink" title="4. 错误处理"></a>4. 错误处理</h2><h3 id="4-1-错误捕获方式"><a href="#4-1-错误捕获方式" class="headerlink" title="4.1 错误捕获方式"></a>4.1 错误捕获方式</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方式 1：使用 catch</span></span><br><span class="line">promise</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;&#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式 2：使用 then 的第二个参数</span></span><br><span class="line">promise.<span class="title function_">then</span>(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> &#123;&#125;,</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> &#123;&#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h3 id="4-2-错误处理逻辑"><a href="#4-2-错误处理逻辑" class="headerlink" title="4.2 错误处理逻辑"></a>4.2 错误处理逻辑</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">promise</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 返回普通值 - 恢复到 fulfilled 状态</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;recovered&#x27;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 抛出错误 - 继续 rejected 状态</span></span><br><span class="line">        <span class="keyword">throw</span> error;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 返回 rejected promise - 继续 rejected 状态</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><h2 id="5-Promise-链式调用"><a href="#5-Promise-链式调用" class="headerlink" title="5. Promise 链式调用"></a>5. Promise 链式调用</h2><h3 id="5-1-基本链式调用"><a href="#5-1-基本链式调用" class="headerlink" title="5.1 基本链式调用"></a>5.1 基本链式调用</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">promise</span><br><span class="line">    .<span class="title function_">then</span>(step1)</span><br><span class="line">    .<span class="title function_">then</span>(step2)</span><br><span class="line">    .<span class="title function_">then</span>(step3)</span><br><span class="line">    .<span class="title function_">catch</span>(handleError);</span><br></pre></td></tr></table></figure><h3 id="5-2-值的传递"><a href="#5-2-值的传递" class="headerlink" title="5.2 值的传递"></a>5.2 值的传递</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="number">1</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">x</span> =&gt;</span> x + <span class="number">1</span>)     <span class="comment">// 2</span></span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">x</span> =&gt;</span> x * <span class="number">2</span>)     <span class="comment">// 4</span></span><br><span class="line">    .<span class="title function_">then</span>(<span class="variable language_">console</span>.<span class="property">log</span>);   <span class="comment">// 输出: 4</span></span><br></pre></td></tr></table></figure><h3 id="5-3-Promise-链中的错误处理"><a href="#5-3-Promise-链中的错误处理" class="headerlink" title="5.3 Promise 链中的错误处理"></a>5.3 Promise 链中的错误处理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetchUser</span>()</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!user.<span class="property">id</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Invalid user&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">fetchProfile</span>(user.<span class="property">id</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">profile</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">updateProfile</span>(profile);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 处理任何步骤中的错误</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><h2 id="6-Promise-静态方法"><a href="#6-Promise-静态方法" class="headerlink" title="6. Promise 静态方法"></a>6. Promise 静态方法</h2><h3 id="6-1-Promise-resolve"><a href="#6-1-Promise-resolve" class="headerlink" title="6.1 Promise.resolve()"></a>6.1 Promise.resolve()</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个立即 resolve 的 Promise</span></span><br><span class="line"><span class="keyword">const</span> resolved = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(value);</span><br></pre></td></tr></table></figure><h3 id="6-2-Promise-reject"><a href="#6-2-Promise-reject" class="headerlink" title="6.2 Promise.reject()"></a>6.2 Promise.reject()</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个立即 reject 的 Promise</span></span><br><span class="line"><span class="keyword">const</span> rejected = <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br></pre></td></tr></table></figure><h3 id="6-3-Promise-all"><a href="#6-3-Promise-all" class="headerlink" title="6.3 Promise.all()"></a>6.3 Promise.all()</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 等待所有 Promise 完成</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">all</span>([promise1, promise2, promise3])</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">results</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// results 是一个数组，包含所有 Promise 的结果</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><h3 id="6-4-Promise-race"><a href="#6-4-Promise-race" class="headerlink" title="6.4 Promise.race()"></a>6.4 Promise.race()</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回最先完成的 Promise 结果</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">race</span>([promise1, promise2])</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">firstResult</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// firstResult 是最先完成的 Promise 的结果</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><h3 id="6-5-Promise-allSettled"><a href="#6-5-Promise-allSettled" class="headerlink" title="6.5 Promise.allSettled()"></a>6.5 Promise.allSettled()</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 等待所有 Promise 完成（无论成功或失败）</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">allSettled</span>([promise1, promise2])</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">results</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// results 包含所有 Promise 的状态和结果</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><h2 id="7-async-await"><a href="#7-async-await" class="headerlink" title="7. async&#x2F;await"></a>7. async&#x2F;await</h2><h3 id="7-1-基本用法"><a href="#7-1-基本用法" class="headerlink" title="7.1 基本用法"></a>7.1 基本用法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(url);</span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error:&#x27;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-2-与-Promise-的关系"><a href="#7-2-与-Promise-的关系" class="headerlink" title="7.2 与 Promise 的关系"></a>7.2 与 Promise 的关系</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Promise 方式</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fetchData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(url)</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>())</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(error));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// async/await 方式</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(url);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="8-实际应用场景"><a href="#8-实际应用场景" class="headerlink" title="8. 实际应用场景"></a>8. 实际应用场景</h2><h3 id="8-1-API-请求"><a href="#8-1-API-请求" class="headerlink" title="8.1 API 请求"></a>8.1 API 请求</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">fetchUserData</span>(<span class="params">userId</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">`/api/users/<span class="subst">$&#123;userId&#125;</span>`</span>)</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!response.<span class="property">ok</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Network response was not ok&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> response.<span class="title function_">json</span>();</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error fetching user:&#x27;</span>, error);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-2-并行请求"><a href="#8-2-并行请求" class="headerlink" title="8.2 并行请求"></a>8.2 并行请求</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchAllData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> [users, posts, comments] = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">            <span class="title function_">fetchUsers</span>(),</span><br><span class="line">            <span class="title function_">fetchPosts</span>(),</span><br><span class="line">            <span class="title function_">fetchComments</span>()</span><br><span class="line">        ]);</span><br><span class="line">        <span class="keyword">return</span> &#123; users, posts, comments &#125;;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error fetching data:&#x27;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-3-串行请求"><a href="#8-3-串行请求" class="headerlink" title="8.3 串行请求"></a>8.3 串行请求</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchUserAndPosts</span>(<span class="params">userId</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="title function_">fetchUser</span>(userId);</span><br><span class="line">        <span class="keyword">const</span> posts = <span class="keyword">await</span> <span class="title function_">fetchUserPosts</span>(user.<span class="property">id</span>);</span><br><span class="line">        <span class="keyword">return</span> &#123; user, posts &#125;;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error:&#x27;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="9-最佳实践"><a href="#9-最佳实践" class="headerlink" title="9. 最佳实践"></a>9. 最佳实践</h2><h3 id="9-1-错误处理"><a href="#9-1-错误处理" class="headerlink" title="9.1 错误处理"></a>9.1 错误处理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">handleAsyncOperation</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">asyncOperation</span>();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="comment">// 记录错误</span></span><br><span class="line">        <span class="title function_">logError</span>(error);</span><br><span class="line">        <span class="comment">// 返回默认值或重新抛出</span></span><br><span class="line">        <span class="keyword">throw</span> error;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 清理工作</span></span><br><span class="line">        <span class="title function_">cleanup</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="9-2-Promise-超时处理"><a href="#9-2-Promise-超时处理" class="headerlink" title="9.2 Promise 超时处理"></a>9.2 Promise 超时处理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">timeoutPromise</span>(<span class="params">promise, timeout</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">race</span>([</span><br><span class="line">        promise,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">_, reject</span>) =&gt;</span></span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Timeout&#x27;</span>)), timeout)</span><br><span class="line">        )</span><br><span class="line">    ]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="9-3-取消操作"><a href="#9-3-取消操作" class="headerlink" title="9.3 取消操作"></a>9.3 取消操作</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createCancellablePromise</span>(<span class="params">promise</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> isCancelled = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> wrappedPromise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        promise.<span class="title function_">then</span>(</span><br><span class="line">            <span class="function"><span class="params">value</span> =&gt;</span> isCancelled ? <span class="title function_">reject</span>(<span class="string">&#x27;Cancelled&#x27;</span>) : <span class="title function_">resolve</span>(value),</span><br><span class="line">            <span class="function"><span class="params">error</span> =&gt;</span> isCancelled ? <span class="title function_">reject</span>(<span class="string">&#x27;Cancelled&#x27;</span>) : <span class="title function_">reject</span>(error)</span><br><span class="line">        );</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">promise</span>: wrappedPromise,</span><br><span class="line">        <span class="attr">cancel</span>: <span class="function">() =&gt;</span> &#123; isCancelled = <span class="literal">true</span>; &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="10-常见问题和陷阱"><a href="#10-常见问题和陷阱" class="headerlink" title="10. 常见问题和陷阱"></a>10. 常见问题和陷阱</h2><h3 id="10-1-Promise-执行顺序"><a href="#10-1-Promise-执行顺序" class="headerlink" title="10.1 Promise 执行顺序"></a>10.1 Promise 执行顺序</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误理解：认为 Promise 中的所有操作都是异步的</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2&#x27;</span>));</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;3&#x27;</span>), <span class="number">0</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;4&#x27;</span>);</span><br><span class="line"><span class="comment">// 输出: 1, 4, 2, 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ⚠️ 特别注意：Promise 中的同步和异步操作</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;开始&#x27;</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;同步代码1&#x27;</span>); <span class="comment">// Promise 构造函数中的代码是同步执行的</span></span><br><span class="line">    <span class="title function_">resolve</span>(<span class="string">&#x27;同步代码2&#x27;</span>);     <span class="comment">// resolve/reject 是同步执行的</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;同步代码3&#x27;</span>); <span class="comment">// 这行也会同步执行</span></span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;异步微任务1&#x27;</span>); <span class="comment">// then 回调是异步微任务</span></span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;异步微任务2&#x27;</span>); <span class="comment">// 链式调用的 then 也是异步微任务</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;结束&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出顺序：</span></span><br><span class="line"><span class="comment">// 开始</span></span><br><span class="line"><span class="comment">// 同步代码1</span></span><br><span class="line"><span class="comment">// 同步代码2</span></span><br><span class="line"><span class="comment">// 同步代码3</span></span><br><span class="line"><span class="comment">// 结束</span></span><br><span class="line"><span class="comment">// 异步微任务1</span></span><br><span class="line"><span class="comment">// 异步微任务2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 更复杂的执行顺序示例</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;script start&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;setTimeout&#x27;</span>); <span class="comment">// 宏任务</span></span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;Promise 1&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(msg); <span class="comment">// 微任务</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Promise 2&#x27;</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(msg); <span class="comment">// 微任务</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;Promise 3&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(msg); <span class="comment">// 微任务</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;script end&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出顺序：</span></span><br><span class="line"><span class="comment">// script start</span></span><br><span class="line"><span class="comment">// script end</span></span><br><span class="line"><span class="comment">// Promise 1</span></span><br><span class="line"><span class="comment">// Promise 3</span></span><br><span class="line"><span class="comment">// Promise 2</span></span><br><span class="line"><span class="comment">// setTimeout</span></span><br></pre></td></tr></table></figure><h3 id="10-1-1-Promise-中的同步和异步操作"><a href="#10-1-1-Promise-中的同步和异步操作" class="headerlink" title="10.1.1 Promise 中的同步和异步操作"></a>10.1.1 Promise 中的同步和异步操作</h3><ol><li><p><strong>同步执行的部分</strong>：</p><ul><li>Promise 构造函数中的代码</li><li>resolve() 或 reject() 的调用</li><li>直接在 Promise 中的代码</li></ul></li><li><p><strong>异步微任务</strong>：</p><ul><li>.then() 的回调</li><li>.catch() 的回调</li><li>.finally() 的回调</li></ul></li><li><p><strong>执行顺序规则</strong>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 示例：混合同步和异步操作</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1 - 同步&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2 - 同步&#x27;</span>);</span><br><span class="line">    <span class="title function_">resolve</span>(<span class="string">&#x27;3 - 同步&#x27;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;4 - 同步&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;5 - 异步微任务&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;6 - 同步&#x27;</span>);</span><br><span class="line">        <span class="title function_">resolve</span>(<span class="string">&#x27;7 - 同步&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;8 - 异步微任务&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;9 - 异步宏任务&#x27;</span>);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;10 - 同步&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出顺序：</span></span><br><span class="line"><span class="comment">// 1 - 同步</span></span><br><span class="line"><span class="comment">// 2 - 同步</span></span><br><span class="line"><span class="comment">// 4 - 同步</span></span><br><span class="line"><span class="comment">// 10 - 同步</span></span><br><span class="line"><span class="comment">// 5 - 异步微任务</span></span><br><span class="line"><span class="comment">// 6 - 同步</span></span><br><span class="line"><span class="comment">// 8 - 异步微任务</span></span><br><span class="line"><span class="comment">// 9 - 异步宏任务</span></span><br></pre></td></tr></table></figure></li><li><p><strong>注意事项</strong>：</p><ul><li>Promise 构造函数是同步执行的</li><li>resolve&#x2F;reject 的调用是同步的，但其触发的 then&#x2F;catch 是异步的</li><li>微任务优先于宏任务执行</li><li>同一轮事件循环中的微任务会在下一个宏任务之前执行完</li></ul></li><li><p><strong>实际应用示例</strong>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">example</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1 - 同步&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2 - 同步&#x27;</span>);</span><br><span class="line">        <span class="title function_">resolve</span>(<span class="string">&#x27;3 - 同步&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;4 - 同步&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">await</span> p; <span class="comment">// await 后面的代码会被转换成 then 的回调（微任务）</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;5 - 异步&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">example</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;6 - 同步&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出顺序：</span></span><br><span class="line"><span class="comment">// 1 - 同步</span></span><br><span class="line"><span class="comment">// 2 - 同步</span></span><br><span class="line"><span class="comment">// 4 - 同步</span></span><br><span class="line"><span class="comment">// 6 - 同步</span></span><br><span class="line"><span class="comment">// 5 - 异步</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="10-2-Promise-错误处理"><a href="#10-2-Promise-错误处理" class="headerlink" title="10.2 Promise 错误处理"></a>10.2 Promise 错误处理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误示例</span></span><br><span class="line">promise.<span class="title function_">then</span>(success).<span class="title function_">catch</span>(error).<span class="title function_">then</span>(next);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确示例</span></span><br><span class="line">promise</span><br><span class="line">    .<span class="title function_">then</span>(success)</span><br><span class="line">    .<span class="title function_">then</span>(next)</span><br><span class="line">    .<span class="title function_">catch</span>(error);</span><br></pre></td></tr></table></figure><h3 id="10-3-内存泄漏"><a href="#10-3-内存泄漏" class="headerlink" title="10.3 内存泄漏"></a>10.3 内存泄漏</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 避免这样</span></span><br><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 永远不会 resolve 或 reject</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 建议这样</span></span><br><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 添加超时处理</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Timeout&#x27;</span>)), <span class="number">5000</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="10-4-Promise-嵌套"><a href="#10-4-Promise-嵌套" class="headerlink" title="10.4 Promise 嵌套"></a>10.4 Promise 嵌套</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 避免嵌套</span></span><br><span class="line"><span class="title function_">fetchUser</span>().<span class="title function_">then</span>(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">fetchPosts</span>(user.<span class="property">id</span>).<span class="title function_">then</span>(<span class="function"><span class="params">posts</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">fetchComments</span>(posts[<span class="number">0</span>].<span class="property">id</span>).<span class="title function_">then</span>(<span class="function"><span class="params">comments</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 处理数据</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用链式调用</span></span><br><span class="line"><span class="title function_">fetchUser</span>()</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">user</span> =&gt;</span> <span class="title function_">fetchPosts</span>(user.<span class="property">id</span>))</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">posts</span> =&gt;</span> <span class="title function_">fetchComments</span>(posts[<span class="number">0</span>].<span class="property">id</span>))</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">comments</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 处理数据</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><h3 id="10-5-常见易错点和特别提示"><a href="#10-5-常见易错点和特别提示" class="headerlink" title="10.5 常见易错点和特别提示"></a>10.5 常见易错点和特别提示</h3><h4 id="1-Promise-构造函数中的代码立即执行"><a href="#1-Promise-构造函数中的代码立即执行" class="headerlink" title="1. Promise 构造函数中的代码立即执行"></a>1. Promise 构造函数中的代码立即执行</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误理解：认为 Promise 中的代码是异步执行</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;开始&#x27;</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Promise 内部&#x27;</span>);</span><br><span class="line">    <span class="title function_">resolve</span>(<span class="string">&#x27;完成&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;结束&#x27;</span>);</span><br><span class="line"><span class="comment">// 实际输出：</span></span><br><span class="line"><span class="comment">// 开始</span></span><br><span class="line"><span class="comment">// Promise 内部</span></span><br><span class="line"><span class="comment">// 结束</span></span><br></pre></td></tr></table></figure><h4 id="2-resolve-reject-后的代码仍会执行"><a href="#2-resolve-reject-后的代码仍会执行" class="headerlink" title="2. resolve&#x2F;reject 后的代码仍会执行"></a>2. resolve&#x2F;reject 后的代码仍会执行</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误示例</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">resolve</span>(<span class="string">&#x27;完成&#x27;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;这里仍会执行&#x27;</span>); <span class="comment">// 这行代码会执行</span></span><br><span class="line">    <span class="keyword">return</span>; <span class="comment">// 显式返回也无法阻止后续代码执行</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确做法</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (condition) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">resolve</span>(<span class="string">&#x27;完成&#x27;</span>); <span class="comment">// 使用 return 来确保后续代码不执行</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 其他代码</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="3-then-catch-返回值的问题"><a href="#3-then-catch-返回值的问题" class="headerlink" title="3. then&#x2F;catch 返回值的问题"></a>3. then&#x2F;catch 返回值的问题</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3.1 错误恢复模式</span></span><br><span class="line"><span class="comment">// ❌ 错误理解：认为错误一旦发生，后续的 then 都不会执行</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">reject</span>(<span class="string">&quot;initial error&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;不会执行&quot;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;捕获错误:&quot;</span>, error);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;recovered&quot;</span>;  <span class="comment">// 返回普通值，Promise 变为 fulfilled 状态</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;会执行，值为:&quot;</span>, result); <span class="comment">// 会执行，因为上一个 then 返回了正常值</span></span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;不会执行，因为错误已经被处理&quot;</span>); <span class="comment">// 不会执行</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.2 错误传播模式</span></span><br><span class="line"><span class="comment">// ❌ 错误理解：认为使用了 catch 就一定能捕获所有错误</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">reject</span>(<span class="string">&quot;error1&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;不会执行&quot;</span>),</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;捕获 error1&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="string">&quot;error2&quot;</span>;  <span class="comment">// 抛出新错误，Promise 变为 rejected 状态</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">.<span class="title function_">then</span>(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;不会执行&quot;</span>),</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;捕获 error2&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="string">&quot;error3&quot;</span>);  <span class="comment">// 返回 rejected promise</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">.<span class="title function_">then</span>(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;不会执行&quot;</span>),</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;捕获 error3&quot;</span>);</span><br><span class="line">        <span class="comment">// 没有返回值，默认返回 undefined，Promise 变为 fulfilled 状态</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">.<span class="title function_">then</span>(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;会执行&quot;</span>),</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;不会执行&quot;</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.3 Promise 状态转换规则</span></span><br><span class="line"><span class="comment">// ✅ 正确理解：Promise 状态转换取决于返回值</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">reject</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 情况1：返回普通值（包括 undefined）</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;normal&quot;</span>;  <span class="comment">// Promise 变为 fulfilled 状态</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 情况2：抛出错误</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>();  <span class="comment">// Promise 变为 rejected 状态</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 情况3：返回 resolved 的 Promise</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&quot;ok&quot;</span>);  <span class="comment">// Promise 变为 fulfilled 状态</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 情况4：返回 rejected 的 Promise</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="string">&quot;fail&quot;</span>);  <span class="comment">// Promise 变为 rejected 状态</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 情况5：不返回任何值</span></span><br><span class="line">        <span class="comment">// 默认返回 undefined，Promise 变为 fulfilled 状态</span></span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.4 错误处理最佳实践</span></span><br><span class="line"><span class="comment">// ✅ 推荐做法：根据错误类型决定是恢复还是继续传播</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">handleError</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">riskyOperation</span>();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="keyword">if</span> (error.<span class="property">isRecoverable</span>) &#123;</span><br><span class="line">            <span class="comment">// 可恢复错误，返回默认值</span></span><br><span class="line">            <span class="keyword">return</span> defaultValue;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 不可恢复错误，继续传播</span></span><br><span class="line">            <span class="keyword">throw</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.5 注意事项总结：</span></span><br><span class="line"><span class="comment">// 1. then 的第二个参数（错误处理函数）只处理当前 Promise 的错误</span></span><br><span class="line"><span class="comment">// 2. 错误处理函数的返回值决定了下一个 Promise 的状态</span></span><br><span class="line"><span class="comment">// 3. 返回普通值会将 Promise 转为 fulfilled 状态</span></span><br><span class="line"><span class="comment">// 4. 抛出错误或返回 rejected Promise 会将 Promise 转为 rejected 状态</span></span><br><span class="line"><span class="comment">// 5. 不返回值默认返回 undefined，Promise 变为 fulfilled 状态</span></span><br></pre></td></tr></table></figure><h4 id="4-Promise-all-的错误处理"><a href="#4-Promise-all-的错误处理" class="headerlink" title="4. Promise.all 的错误处理"></a>4. Promise.all 的错误处理</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误用法：未考虑部分 Promise 失败的情况</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">all</span>([promise1, promise2, promise3])</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">results</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 如果任何一个 Promise 失败，这里都不会执行</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确做法：为每个 Promise 添加错误处理</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">    promise1.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> (&#123; <span class="attr">error</span>: err &#125;)),</span><br><span class="line">    promise2.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> (&#123; <span class="attr">error</span>: err &#125;)),</span><br><span class="line">    promise3.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> (&#123; <span class="attr">error</span>: err &#125;))</span><br><span class="line">])</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">results</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 即使部分 Promise 失败，这里也会执行</span></span><br><span class="line">    results.<span class="title function_">forEach</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (result.<span class="property">error</span>) &#123;</span><br><span class="line">            <span class="comment">// 处理错误情况</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="5-async-await-常见错误"><a href="#5-async-await-常见错误" class="headerlink" title="5. async&#x2F;await 常见错误"></a>5. async&#x2F;await 常见错误</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误：在普通函数中使用 await</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">fetchData</span>(); <span class="comment">// 语法错误</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ❌ 错误：忘记错误处理</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">fetchData</span>(); <span class="comment">// 如果出错，将导致未捕获的异常</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确做法</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">fetchData</span>();</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error:&#x27;</span>, error);</span><br><span class="line">        <span class="comment">// 处理错误</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-特别提示"><a href="#6-特别提示" class="headerlink" title="6. 特别提示"></a>6. 特别提示</h4><ol><li><p><strong>Promise 状态变化</strong></p><ul><li>Promise 状态一旦改变就不可逆</li><li>只有 pending 状态可以变为 fulfilled 或 rejected</li><li>状态变化后的值不可变</li></ul></li><li><p><strong>链式调用注意事项</strong></p><ul><li>每个 then&#x2F;catch 都返回新的 Promise</li><li>返回值会被自动包装成 Promise</li><li>没有显式返回值时，默认返回 undefined</li></ul></li><li><p><strong>错误处理最佳实践</strong></p><ul><li>总是在 Promise 链的末尾添加 catch</li><li>在适当的位置使用 finally 进行清理</li><li>避免在 Promise 链中静默失败</li></ul></li><li><p><strong>async&#x2F;await 使用建议</strong></p><ul><li>总是使用 try&#x2F;catch 包裹 await</li><li>注意 await 的位置，避免不必要的等待</li><li>并行操作使用 Promise.all</li></ul></li><li><p><strong>性能考虑</strong></p><ul><li>避免创建不必要的 Promise</li><li>注意内存泄漏（未处理的 Promise）</li><li>合理使用 Promise.all 进行并行处理</li></ul></li></ol><h3 id="10-6-高级注意事项和陷阱"><a href="#10-6-高级注意事项和陷阱" class="headerlink" title="10.6 高级注意事项和陷阱"></a>10.6 高级注意事项和陷阱</h3><h4 id="1-Promise-resolve-reject-的特殊行为"><a href="#1-Promise-resolve-reject-的特殊行为" class="headerlink" title="1. Promise.resolve&#x2F;reject 的特殊行为"></a>1. Promise.resolve&#x2F;reject 的特殊行为</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误理解：认为 Promise.resolve 总是同步执行</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="number">1</span>))  <span class="comment">// Promise 嵌套的情况</span></span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(value));  <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ⚠️ 特别注意：传入 thenable 对象</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>(&#123;</span><br><span class="line">    <span class="attr">then</span>: <span class="keyword">function</span>(<span class="params">resolve</span>) &#123;</span><br><span class="line">        <span class="title function_">resolve</span>(<span class="number">42</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(value));  <span class="comment">// 42</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意：Promise.resolve 会展平 Promise</span></span><br><span class="line"><span class="keyword">const</span> p1 = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">const</span> p2 = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(p1); <span class="comment">// p2 和 p1 是同一个 Promise</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(p1 === p2); <span class="comment">// true</span></span><br></pre></td></tr></table></figure><h4 id="2-Promise-的并发控制"><a href="#2-Promise-的并发控制" class="headerlink" title="2. Promise 的并发控制"></a>2. Promise 的并发控制</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误做法：无控制地并发请求</span></span><br><span class="line">urls.<span class="title function_">map</span>(<span class="function"><span class="params">url</span> =&gt;</span> <span class="title function_">fetch</span>(url));  <span class="comment">// 可能导致服务器压力过大</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确做法：控制并发数量</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchWithConcurrency</span>(<span class="params">urls, concurrency = <span class="number">3</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> results = [];</span><br><span class="line">    <span class="keyword">const</span> executing = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> url <span class="keyword">of</span> urls) &#123;</span><br><span class="line">        <span class="keyword">const</span> promise = <span class="title function_">fetch</span>(url).<span class="title function_">then</span>(<span class="function"><span class="params">r</span> =&gt;</span> r.<span class="title function_">json</span>());</span><br><span class="line">        results.<span class="title function_">push</span>(promise);</span><br><span class="line">        </span><br><span class="line">        executing.<span class="title function_">add</span>(promise);</span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">clean</span> = (<span class="params"></span>) =&gt; executing.<span class="title function_">delete</span>(promise);</span><br><span class="line">        promise.<span class="title function_">then</span>(clean, clean);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (executing.<span class="property">size</span> &gt;= concurrency) &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">race</span>(executing);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(results);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> urls = [<span class="string">&#x27;url1&#x27;</span>, <span class="string">&#x27;url2&#x27;</span>, <span class="string">&#x27;url3&#x27;</span>, <span class="string">&#x27;url4&#x27;</span>, <span class="string">&#x27;url5&#x27;</span>];</span><br><span class="line"><span class="title function_">fetchWithConcurrency</span>(urls, <span class="number">2</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">results</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;所有请求完成&#x27;</span>));</span><br></pre></td></tr></table></figure><h4 id="3-循环中的-Promise-处理"><a href="#3-循环中的-Promise-处理" class="headerlink" title="3. 循环中的 Promise 处理"></a>3. 循环中的 Promise 处理</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误做法：在循环中使用 await</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">wrong</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> urls = [<span class="string">&#x27;url1&#x27;</span>, <span class="string">&#x27;url2&#x27;</span>, <span class="string">&#x27;url3&#x27;</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> url <span class="keyword">of</span> urls) &#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">fetch</span>(url);  <span class="comment">// 串行执行，效率低</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确做法：并行执行</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">right</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> urls = [<span class="string">&#x27;url1&#x27;</span>, <span class="string">&#x27;url2&#x27;</span>, <span class="string">&#x27;url3&#x27;</span>];</span><br><span class="line">    <span class="keyword">const</span> promises = urls.<span class="title function_">map</span>(<span class="function"><span class="params">url</span> =&gt;</span> <span class="title function_">fetch</span>(url));</span><br><span class="line">    <span class="keyword">const</span> results = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(promises);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 需要按顺序执行时的正确做法</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">sequential</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> urls = [<span class="string">&#x27;url1&#x27;</span>, <span class="string">&#x27;url2&#x27;</span>, <span class="string">&#x27;url3&#x27;</span>];</span><br><span class="line">    <span class="keyword">const</span> results = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> url <span class="keyword">of</span> urls) &#123;</span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">fetch</span>(url);</span><br><span class="line">        results.<span class="title function_">push</span>(<span class="keyword">await</span> result.<span class="title function_">json</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> results;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-Promise-竞态问题处理"><a href="#4-Promise-竞态问题处理" class="headerlink" title="4. Promise 竞态问题处理"></a>4. Promise 竞态问题处理</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 潜在问题：多个请求的响应顺序不确定</span></span><br><span class="line"><span class="keyword">let</span> currentData;</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchData</span>(<span class="params">id</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">`/api/<span class="subst">$&#123;id&#125;</span>`</span>);</span><br><span class="line">    currentData = <span class="keyword">await</span> response.<span class="title function_">json</span>();  <span class="comment">// 可能被后发先至的请求覆盖</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确做法：使用标记或取消机制</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createFetchWithAbort</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> currentController = <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchData</span>(<span class="params">id</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (currentController) &#123;</span><br><span class="line">            currentController.<span class="title function_">abort</span>();  <span class="comment">// 取消之前的请求</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        currentController = <span class="keyword">new</span> <span class="title class_">AbortController</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">`/api/<span class="subst">$&#123;id&#125;</span>`</span>, &#123;</span><br><span class="line">                <span class="attr">signal</span>: currentController.<span class="property">signal</span></span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="keyword">if</span> (error.<span class="property">name</span> === <span class="string">&#x27;AbortError&#x27;</span>) &#123;</span><br><span class="line">                <span class="comment">// 请求被取消，忽略错误</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> fetchWithAbort = <span class="title function_">createFetchWithAbort</span>();</span><br><span class="line"><span class="title function_">fetchWithAbort</span>(<span class="string">&#x27;id1&#x27;</span>);</span><br><span class="line"><span class="title function_">fetchWithAbort</span>(<span class="string">&#x27;id2&#x27;</span>); <span class="comment">// id1 的请求会被取消</span></span><br></pre></td></tr></table></figure><h4 id="5-async-await-与-Promise-混用的陷阱"><a href="#5-async-await-与-Promise-混用的陷阱" class="headerlink" title="5. async&#x2F;await 与 Promise 混用的陷阱"></a>5. async&#x2F;await 与 Promise 混用的陷阱</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误做法：混合使用可能导致错误处理混乱</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">mixed</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">somePromise</span>()</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> <span class="title function_">process</span>(data))  <span class="comment">// 这里的错误不会被 catch 捕获</span></span><br><span class="line">            .<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> <span class="title function_">handle</span>(err));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="comment">// 这里捕获不到 .then 中的错误</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确做法：统一使用 async/await</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">consistent</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">somePromise</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">process</span>(data);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">handle</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 如果必须混用，确保错误处理的完整性</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">mixedButSafe</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">somePromise</span>()</span><br><span class="line">            .<span class="title function_">then</span>(<span class="keyword">async</span> data =&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">process</span>(data);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> error; <span class="comment">// 确保错误能被外层 catch 捕获</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">handle</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-Promise-内存泄漏的其他情况"><a href="#6-Promise-内存泄漏的其他情况" class="headerlink" title="6. Promise 内存泄漏的其他情况"></a>6. Promise 内存泄漏的其他情况</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 潜在问题：事件监听器中的 Promise</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataLoader</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listener</span> = <span class="variable language_">this</span>.<span class="property">handleData</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">        eventEmitter.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="variable language_">this</span>.<span class="property">listener</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">handleData</span>(<span class="params">data</span>) &#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">processData</span>(data);  <span class="comment">// 如果组件被销毁，这个 Promise 可能永远挂着</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确做法：确保清理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataLoader</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">abortController</span> = <span class="keyword">new</span> <span class="title class_">AbortController</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listener</span> = <span class="variable language_">this</span>.<span class="property">handleData</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">        eventEmitter.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="variable language_">this</span>.<span class="property">listener</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">handleData</span>(<span class="params">data</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">abortController</span>.<span class="property">signal</span>.<span class="property">aborted</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">processData</span>(data);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">destroy</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">abortController</span>.<span class="title function_">abort</span>();</span><br><span class="line">        eventEmitter.<span class="title function_">off</span>(<span class="string">&#x27;data&#x27;</span>, <span class="variable language_">this</span>.<span class="property">listener</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 React 组件中的使用示例</span></span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> loader = <span class="keyword">new</span> <span class="title class_">DataLoader</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> loader.<span class="title function_">destroy</span>(); <span class="comment">// 清理函数</span></span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure><h4 id="7-特殊场景的注意事项"><a href="#7-特殊场景的注意事项" class="headerlink" title="7. 特殊场景的注意事项"></a>7. 特殊场景的注意事项</h4><ol><li><strong>Promise 链中的值传递</strong>：</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误做法：没有正确传递值</span></span><br><span class="line">promise</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">process</span>(value);</span><br><span class="line">        <span class="comment">// 没有返回值，下一个 then 将收到 undefined</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// value 是 undefined</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确做法：确保正确传递值</span></span><br><span class="line">promise</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">process</span>(value);</span><br><span class="line">        <span class="keyword">return</span> value; <span class="comment">// 显式返回需要传递的值</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// value 是上一步返回的值</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><ol start="2"><li><strong>Promise 的错误恢复链</strong>：</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 高级错误恢复模式</span></span><br><span class="line"><span class="title function_">fetchData</span>()</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (error.<span class="property">type</span> === <span class="string">&#x27;network&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">fetchFromCache</span>(); <span class="comment">// 尝试从缓存获取</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> error; <span class="comment">// 其他错误继续传播</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (error.<span class="property">type</span> === <span class="string">&#x27;cache&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">fetchFromBackup</span>(); <span class="comment">// 尝试从备份获取</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> error;</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> defaultValue; <span class="comment">// 最后的降级处理</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><ol start="3"><li><strong>条件 Promise 执行</strong>：</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 根据条件决定是否执行 Promise</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">conditionalFetch</span>(<span class="params">condition</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!condition) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;/api/data&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Fetch failed:&#x27;</span>, error);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise">MDN Promise 文档</a></li><li><a href="https://promisesaplus.com/">JavaScript Promise 规范</a></li><li><a href="https://tc39.es/ecma262/#sec-promise-objects">ECMAScript Promise 规范</a></li></ul><h2 id="11-更多实际应用场景"><a href="#11-更多实际应用场景" class="headerlink" title="11. 更多实际应用场景"></a>11. 更多实际应用场景</h2><h3 id="11-1-文件上传与进度监控"><a href="#11-1-文件上传与进度监控" class="headerlink" title="11.1 文件上传与进度监控"></a>11.1 文件上传与进度监控</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">uploadFileWithProgress</span>(<span class="params">file, onProgress</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">        <span class="keyword">const</span> formData = <span class="keyword">new</span> <span class="title class_">FormData</span>();</span><br><span class="line">        formData.<span class="title function_">append</span>(<span class="string">&#x27;file&#x27;</span>, file);</span><br><span class="line"></span><br><span class="line">        xhr.<span class="property">upload</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;progress&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (event.<span class="property">lengthComputable</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> progress = (event.<span class="property">loaded</span> / event.<span class="property">total</span>) * <span class="number">100</span>;</span><br><span class="line">                <span class="title function_">onProgress</span>(progress);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        xhr.<span class="title function_">addEventListener</span>(<span class="string">&#x27;load&#x27;</span>, <span class="function">() =&gt;</span> <span class="title function_">resolve</span>(xhr.<span class="property">response</span>));</span><br><span class="line">        xhr.<span class="title function_">addEventListener</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">() =&gt;</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Upload failed&#x27;</span>)));</span><br><span class="line">        xhr.<span class="title function_">addEventListener</span>(<span class="string">&#x27;abort&#x27;</span>, <span class="function">() =&gt;</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Upload aborted&#x27;</span>)));</span><br><span class="line"></span><br><span class="line">        xhr.<span class="title function_">open</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/api/upload&#x27;</span>);</span><br><span class="line">        xhr.<span class="title function_">send</span>(formData);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> fileInput = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;input[type=&quot;file&quot;]&#x27;</span>);</span><br><span class="line">fileInput.<span class="title function_">addEventListener</span>(<span class="string">&#x27;change&#x27;</span>, <span class="title function_">async</span> (e) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> file = e.<span class="property">target</span>.<span class="property">files</span>[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">uploadFileWithProgress</span>(file, <span class="function">(<span class="params">progress</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Upload progress: <span class="subst">$&#123;progress&#125;</span>%`</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Upload complete&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Upload error:&#x27;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="11-2-带重试机制的API请求"><a href="#11-2-带重试机制的API请求" class="headerlink" title="11.2 带重试机制的API请求"></a>11.2 带重试机制的API请求</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchWithRetry</span>(<span class="params">url, options = &#123;&#125;, maxRetries = <span class="number">3</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">delay</span> = (<span class="params">ms</span>) =&gt; <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(resolve, ms));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; maxRetries; i++) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(url, options);</span><br><span class="line">            <span class="keyword">if</span> (!response.<span class="property">ok</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`HTTP error! status: <span class="subst">$&#123;response.status&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i === maxRetries - <span class="number">1</span>) <span class="keyword">throw</span> error;</span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">delay</span>(<span class="title class_">Math</span>.<span class="title function_">pow</span>(<span class="number">2</span>, i) * <span class="number">1000</span>); <span class="comment">// 指数退避</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Retrying... (<span class="subst">$&#123;i + <span class="number">1</span>&#125;</span>/<span class="subst">$&#123;maxRetries&#125;</span>)`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="title function_">fetchWithRetry</span>(<span class="string">&#x27;/api/data&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Success:&#x27;</span>, data))</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Final error:&#x27;</span>, error));</span><br></pre></td></tr></table></figure><h3 id="11-3-资源预加载"><a href="#11-3-资源预加载" class="headerlink" title="11.3 资源预加载"></a>11.3 资源预加载</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ResourcePreloader</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cache</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">preload</span>(<span class="params">url</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">has</span>(url)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">get</span>(url));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> promise = <span class="title function_">fetch</span>(url)</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>())</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">set</span>(url, data);</span><br><span class="line">                <span class="keyword">return</span> data;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">set</span>(url, promise);</span><br><span class="line">        <span class="keyword">return</span> promise;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">get</span>(<span class="params">url</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">get</span>(url) || <span class="variable language_">this</span>.<span class="title function_">preload</span>(url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> preloader = <span class="keyword">new</span> <span class="title class_">ResourcePreloader</span>();</span><br><span class="line"><span class="comment">// 预加载资源</span></span><br><span class="line">preloader.<span class="title function_">preload</span>(<span class="string">&#x27;/api/user/1&#x27;</span>);</span><br><span class="line">preloader.<span class="title function_">preload</span>(<span class="string">&#x27;/api/user/2&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 稍后使用</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">displayUser</span>(<span class="params">id</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> userData = <span class="keyword">await</span> preloader.<span class="title function_">get</span>(<span class="string">`/api/user/<span class="subst">$&#123;id&#125;</span>`</span>);</span><br><span class="line">    <span class="comment">// 使用预加载的数据</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="11-4-并发请求限制器"><a href="#11-4-并发请求限制器" class="headerlink" title="11.4 并发请求限制器"></a>11.4 并发请求限制器</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RequestLimiter</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">maxConcurrent = <span class="number">5</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">maxConcurrent</span> = maxConcurrent;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentRequests</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">queue</span> = [];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">add</span>(<span class="params">promiseFactory</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">currentRequests</span> &gt;= <span class="variable language_">this</span>.<span class="property">maxConcurrent</span>) &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="variable language_">this</span>.<span class="property">queue</span>.<span class="title function_">push</span>(resolve));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentRequests</span>++;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">promiseFactory</span>();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">currentRequests</span>--;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">queue</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> next = <span class="variable language_">this</span>.<span class="property">queue</span>.<span class="title function_">shift</span>();</span><br><span class="line">                <span class="title function_">next</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> limiter = <span class="keyword">new</span> <span class="title class_">RequestLimiter</span>(<span class="number">3</span>);</span><br><span class="line"><span class="keyword">const</span> urls = <span class="title class_">Array</span>.<span class="title function_">from</span>(&#123; <span class="attr">length</span>: <span class="number">10</span> &#125;, <span class="function">(<span class="params">_, i</span>) =&gt;</span> <span class="string">`/api/item/<span class="subst">$&#123;i&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">all</span>(</span><br><span class="line">    urls.<span class="title function_">map</span>(<span class="function"><span class="params">url</span> =&gt;</span> </span><br><span class="line">        limiter.<span class="title function_">add</span>(<span class="function">() =&gt;</span> <span class="title function_">fetch</span>(url).<span class="title function_">then</span>(<span class="function"><span class="params">r</span> =&gt;</span> r.<span class="title function_">json</span>()))</span><br><span class="line">    )</span><br><span class="line">).<span class="title function_">then</span>(<span class="function"><span class="params">results</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;All requests completed&#x27;</span>));</span><br></pre></td></tr></table></figure><h2 id="12-详细错误处理指南"><a href="#12-详细错误处理指南" class="headerlink" title="12. 详细错误处理指南"></a>12. 详细错误处理指南</h2><h3 id="12-1-错误类型分类"><a href="#12-1-错误类型分类" class="headerlink" title="12.1 错误类型分类"></a>12.1 错误类型分类</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">NetworkError</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Error</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(message);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">name</span> = <span class="string">&#x27;NetworkError&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ValidationError</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Error</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(message);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">name</span> = <span class="string">&#x27;ValidationError&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TimeoutError</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Error</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(message);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">name</span> = <span class="string">&#x27;TimeoutError&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchWithErrorHandling</span>(<span class="params">url</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(url);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!response.<span class="property">ok</span>) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (response.<span class="property">status</span>) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">404</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ValidationError</span>(<span class="string">&#x27;Resource not found&#x27;</span>);</span><br><span class="line">                <span class="keyword">case</span> <span class="number">401</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ValidationError</span>(<span class="string">&#x27;Unauthorized&#x27;</span>);</span><br><span class="line">                <span class="keyword">case</span> <span class="number">503</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NetworkError</span>(<span class="string">&#x27;Service unavailable&#x27;</span>);</span><br><span class="line">                <span class="attr">default</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`HTTP error! status: <span class="subst">$&#123;response.status&#125;</span>`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="keyword">if</span> (error <span class="keyword">instanceof</span> <span class="title class_">ValidationError</span>) &#123;</span><br><span class="line">            <span class="comment">// 处理验证错误</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Validation error:&#x27;</span>, error.<span class="property">message</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error <span class="keyword">instanceof</span> <span class="title class_">NetworkError</span>) &#123;</span><br><span class="line">            <span class="comment">// 处理网络错误</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Network error:&#x27;</span>, error.<span class="property">message</span>);</span><br><span class="line">            <span class="keyword">throw</span> error; <span class="comment">// 重新抛出网络错误</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 处理其他错误</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Unexpected error:&#x27;</span>, error);</span><br><span class="line">            <span class="keyword">throw</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="12-2-全局错误处理"><a href="#12-2-全局错误处理" class="headerlink" title="12.2 全局错误处理"></a>12.2 全局错误处理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ErrorHandler</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">handle</span>(<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (error <span class="keyword">instanceof</span> <span class="title class_">ValidationError</span>) &#123;</span><br><span class="line">            <span class="comment">// 处理验证错误</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">handleValidationError</span>(error);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error <span class="keyword">instanceof</span> <span class="title class_">NetworkError</span>) &#123;</span><br><span class="line">            <span class="comment">// 处理网络错误</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">handleNetworkError</span>(error);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error <span class="keyword">instanceof</span> <span class="title class_">TimeoutError</span>) &#123;</span><br><span class="line">            <span class="comment">// 处理超时错误</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">handleTimeoutError</span>(error);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 处理未知错误</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">handleUnknownError</span>(error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">handleValidationError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Validation Error:&#x27;</span>, error.<span class="property">message</span>);</span><br><span class="line">        <span class="comment">// 显示用户友好的错误消息</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">handleNetworkError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Network Error:&#x27;</span>, error.<span class="property">message</span>);</span><br><span class="line">        <span class="comment">// 尝试重新连接</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">handleTimeoutError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Timeout Error:&#x27;</span>, error.<span class="property">message</span>);</span><br><span class="line">        <span class="comment">// 提示用户重试</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">handleUnknownError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Unknown Error:&#x27;</span>, error);</span><br><span class="line">        <span class="comment">// 记录错误并通知开发团队</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;unhandledrejection&#x27;</span>, <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">ErrorHandler</span>.<span class="title function_">handle</span>(event.<span class="property">reason</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="13-性能优化最佳实践"><a href="#13-性能优化最佳实践" class="headerlink" title="13. 性能优化最佳实践"></a>13. 性能优化最佳实践</h2><h3 id="13-1-Promise-批处理"><a href="#13-1-Promise-批处理" class="headerlink" title="13.1 Promise 批处理"></a>13.1 Promise 批处理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PromiseBatcher</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">batchSize = <span class="number">100</span>, interval = <span class="number">50</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">batchSize</span> = batchSize;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">interval</span> = interval;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">queue</span> = [];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">pending</span> = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">add</span>(<span class="params">item</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">queue</span>.<span class="title function_">push</span>(&#123; item, resolve, reject &#125;);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">process</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">process</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">pending</span> || <span class="variable language_">this</span>.<span class="property">queue</span>.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">pending</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(resolve, <span class="variable language_">this</span>.<span class="property">interval</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> batch = <span class="variable language_">this</span>.<span class="property">queue</span>.<span class="title function_">splice</span>(<span class="number">0</span>, <span class="variable language_">this</span>.<span class="property">batchSize</span>);</span><br><span class="line">        <span class="keyword">const</span> items = batch.<span class="title function_">map</span>(<span class="function">(<span class="params">&#123; item &#125;</span>) =&gt;</span> item);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> results = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">processBatch</span>(items);</span><br><span class="line">            batch.<span class="title function_">forEach</span>(<span class="function">(<span class="params">&#123; resolve &#125;, index</span>) =&gt;</span> <span class="title function_">resolve</span>(results[index]));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            batch.<span class="title function_">forEach</span>(<span class="function">(<span class="params">&#123; reject &#125;</span>) =&gt;</span> <span class="title function_">reject</span>(error));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">pending</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">queue</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">process</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">processBatch</span>(<span class="params">items</span>) &#123;</span><br><span class="line">        <span class="comment">// 实现批处理逻辑</span></span><br><span class="line">        <span class="keyword">return</span> items.<span class="title function_">map</span>(<span class="function"><span class="params">item</span> =&gt;</span> <span class="string">`Processed <span class="subst">$&#123;item&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> batcher = <span class="keyword">new</span> <span class="title class_">PromiseBatcher</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">    batcher.<span class="title function_">add</span>(i).<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(result));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="13-2-Promise-缓存优化"><a href="#13-2-Promise-缓存优化" class="headerlink" title="13.2 Promise 缓存优化"></a>13.2 Promise 缓存优化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PromiseCache</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">ttl = <span class="number">60000</span></span>) &#123; <span class="comment">// 默认缓存时间 1 分钟</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cache</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ttl</span> = ttl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">get</span>(<span class="params">key, promiseFactory</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> cached = <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">get</span>(key);</span><br><span class="line">        <span class="keyword">if</span> (cached &amp;&amp; <span class="title class_">Date</span>.<span class="title function_">now</span>() - cached.<span class="property">timestamp</span> &lt; <span class="variable language_">this</span>.<span class="property">ttl</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> cached.<span class="property">data</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">promiseFactory</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">set</span>(key, &#123;</span><br><span class="line">            data,</span><br><span class="line">            <span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">invalidate</span>(<span class="params">key</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">delete</span>(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">clear</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">clear</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> cache = <span class="keyword">new</span> <span class="title class_">PromiseCache</span>();</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchUserWithCache</span>(<span class="params">userId</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cache.<span class="title function_">get</span>(</span><br><span class="line">        <span class="string">`user_<span class="subst">$&#123;userId&#125;</span>`</span>,</span><br><span class="line">        <span class="function">() =&gt;</span> <span class="title function_">fetch</span>(<span class="string">`/api/users/<span class="subst">$&#123;userId&#125;</span>`</span>).<span class="title function_">then</span>(<span class="function"><span class="params">r</span> =&gt;</span> r.<span class="title function_">json</span>())</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="13-3-内存优化"><a href="#13-3-内存优化" class="headerlink" title="13.3 内存优化"></a>13.3 内存优化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MemoryEfficientPromise</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">async</span> <span class="title function_">batch</span>(<span class="params">items, processor, batchSize = <span class="number">100</span></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> results = [];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; items.<span class="property">length</span>; i += batchSize) &#123;</span><br><span class="line">            <span class="keyword">const</span> batch = items.<span class="title function_">slice</span>(i, i + batchSize);</span><br><span class="line">            <span class="keyword">const</span> batchResults = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(</span><br><span class="line">                batch.<span class="title function_">map</span>(processor)</span><br><span class="line">            );</span><br><span class="line">            results.<span class="title function_">push</span>(...batchResults);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 允许垃圾回收</span></span><br><span class="line">            <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(resolve, <span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> results;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">async</span> <span class="title function_">stream</span>(<span class="params">asyncIterable, processor</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> results = [];</span><br><span class="line">        <span class="keyword">for</span> <span class="title function_">await</span> (<span class="keyword">const</span> item <span class="keyword">of</span> asyncIterable) &#123;</span><br><span class="line">            results.<span class="title function_">push</span>(<span class="keyword">await</span> <span class="title function_">processor</span>(item));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 定期清理</span></span><br><span class="line">            <span class="keyword">if</span> (results.<span class="property">length</span> % <span class="number">1000</span> === <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(resolve, <span class="number">0</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> results;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> items = <span class="title class_">Array</span>.<span class="title function_">from</span>(&#123; <span class="attr">length</span>: <span class="number">10000</span> &#125;, <span class="function">(<span class="params">_, i</span>) =&gt;</span> i);</span><br><span class="line"><span class="title class_">MemoryEfficientPromise</span>.<span class="title function_">batch</span>(items, <span class="title function_">async</span> (item) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 处理每个项目</span></span><br><span class="line">    <span class="keyword">return</span> item * <span class="number">2</span>;</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">results</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Processed items:&#x27;</span>, results.<span class="property">length</span>));</span><br></pre></td></tr></table></figure><h2 id="14-补充最佳实践建议"><a href="#14-补充最佳实践建议" class="headerlink" title="14. 补充最佳实践建议"></a>14. 补充最佳实践建议</h2><h3 id="14-1-Promise-链优化"><a href="#14-1-Promise-链优化" class="headerlink" title="14.1 Promise 链优化"></a>14.1 Promise 链优化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 优化 Promise 链</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">optimizedChain</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 并行执行无依赖的 Promise</span></span><br><span class="line">        <span class="keyword">const</span> [data1, data2] = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">            <span class="title function_">fetchData1</span>(),</span><br><span class="line">            <span class="title function_">fetchData2</span>()</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 串行执行有依赖的 Promise</span></span><br><span class="line">        <span class="keyword">const</span> result1 = <span class="keyword">await</span> <span class="title function_">processData</span>(data1);</span><br><span class="line">        <span class="keyword">const</span> result2 = <span class="keyword">await</span> <span class="title function_">processData</span>(data2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 条件执行</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">needsExtra</span>(result1)) &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">extraProcessing</span>(result1);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [result1, result2];</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="comment">// 统一错误处理</span></span><br><span class="line">        <span class="title class_">ErrorHandler</span>.<span class="title function_">handle</span>(error);</span><br><span class="line">        <span class="keyword">throw</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="14-2-资源管理"><a href="#14-2-资源管理" class="headerlink" title="14.2 资源管理"></a>14.2 资源管理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ResourceManager</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">resources</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">locks</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">acquire</span>(<span class="params">key</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">locks</span>.<span class="title function_">has</span>(key)) &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">locks</span>.<span class="title function_">get</span>(key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> lock = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">locks</span>.<span class="title function_">set</span>(key, resolve);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">resources</span>.<span class="title function_">has</span>(key)) &#123;</span><br><span class="line">                <span class="keyword">const</span> resource = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">createResource</span>(key);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">resources</span>.<span class="title function_">set</span>(key, resource);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">resources</span>.<span class="title function_">get</span>(key);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">locks</span>.<span class="title function_">delete</span>(key);</span><br><span class="line">            lock.<span class="title function_">resolve</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">release</span>(<span class="params">key</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">resources</span>.<span class="title function_">has</span>(key)) &#123;</span><br><span class="line">            <span class="keyword">const</span> resource = <span class="variable language_">this</span>.<span class="property">resources</span>.<span class="title function_">get</span>(key);</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">cleanupResource</span>(resource);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">resources</span>.<span class="title function_">delete</span>(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">createResource</span>(<span class="params">key</span>) &#123;</span><br><span class="line">        <span class="comment">// 实现资源创建逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">cleanupResource</span>(<span class="params">resource</span>) &#123;</span><br><span class="line">        <span class="comment">// 实现资源清理逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="14-3-监控和日志"><a href="#14-3-监控和日志" class="headerlink" title="14.3 监控和日志"></a>14.3 监控和日志</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PromiseMonitor</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">metrics</span> = &#123;</span><br><span class="line">            <span class="attr">total</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">success</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">failure</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">timing</span>: []</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">track</span>(<span class="params">promise, metadata = &#123;&#125;</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> startTime = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">total</span>++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> result = <span class="keyword">await</span> promise;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">success</span>++;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">recordTiming</span>(startTime, metadata);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">failure</span>++;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">recordError</span>(error, metadata);</span><br><span class="line">            <span class="keyword">throw</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">recordTiming</span>(<span class="params">startTime, metadata</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> duration = <span class="title class_">Date</span>.<span class="title function_">now</span>() - startTime;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">timing</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">            duration,</span><br><span class="line">            ...metadata,</span><br><span class="line">            <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">recordError</span>(<span class="params">error, metadata</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Promise Error:&#x27;</span>, &#123;</span><br><span class="line">            <span class="attr">error</span>: error.<span class="property">message</span>,</span><br><span class="line">            <span class="attr">stack</span>: error.<span class="property">stack</span>,</span><br><span class="line">            ...metadata,</span><br><span class="line">            <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">getMetrics</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            ...<span class="variable language_">this</span>.<span class="property">metrics</span>,</span><br><span class="line">            <span class="attr">successRate</span>: <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">success</span> / <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">total</span>,</span><br><span class="line">            <span class="attr">averageDuration</span>: <span class="variable language_">this</span>.<span class="title function_">calculateAverageDuration</span>()</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">calculateAverageDuration</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">timing</span>.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">const</span> sum = <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">timing</span>.<span class="title function_">reduce</span>(<span class="function">(<span class="params">acc, &#123; duration &#125;</span>) =&gt;</span> acc + duration, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> sum / <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">timing</span>.<span class="property">length</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> monitor = <span class="keyword">new</span> <span class="title class_">PromiseMonitor</span>();</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">monitoredOperation</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> monitor.<span class="title function_">track</span>(</span><br><span class="line">        <span class="title function_">fetch</span>(<span class="string">&#x27;/api/data&#x27;</span>),</span><br><span class="line">        &#123; <span class="attr">operation</span>: <span class="string">&#x27;fetchData&#x27;</span>, <span class="attr">priority</span>: <span class="string">&#x27;high&#x27;</span> &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="14-4-测试最佳实践"><a href="#14-4-测试最佳实践" class="headerlink" title="14.4 测试最佳实践"></a>14.4 测试最佳实践</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Promise 测试辅助函数</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PromiseTestUtils</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">async</span> <span class="title function_">expectResolve</span>(<span class="params">promise</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> error;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> promise;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            error = e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">expect</span>(error).<span class="title function_">toBeUndefined</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">async</span> <span class="title function_">expectReject</span>(<span class="params">promise</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> error;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> promise;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            error = e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">expect</span>(error).<span class="title function_">toBeDefined</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">createDeferred</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> resolve, reject;</span><br><span class="line">        <span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">            resolve = res;</span><br><span class="line">            reject = rej;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> &#123; promise, resolve, reject &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试示例</span></span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;Promise Tests&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">it</span>(<span class="string">&#x27;should handle successful operations&#x27;</span>, <span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; promise, resolve &#125; = <span class="title class_">PromiseTestUtils</span>.<span class="title function_">createDeferred</span>();</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">resolve</span>(<span class="string">&#x27;success&#x27;</span>), <span class="number">100</span>);</span><br><span class="line">        <span class="keyword">await</span> <span class="title class_">PromiseTestUtils</span>.<span class="title function_">expectResolve</span>(promise);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">it</span>(<span class="string">&#x27;should handle failures&#x27;</span>, <span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; promise, reject &#125; = <span class="title class_">PromiseTestUtils</span>.<span class="title function_">createDeferred</span>();</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;fail&#x27;</span>)), <span class="number">100</span>);</span><br><span class="line">        <span class="keyword">await</span> <span class="title class_">PromiseTestUtils</span>.<span class="title function_">expectReject</span>(promise);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;深入理解-JavaScript-Promise：从入门到精通&quot;&gt;&lt;a href=&quot;#深入理解-JavaScript-Promise：从入门到精通&quot; class=&quot;headerlink&quot; title=&quot;深入理解 JavaScript Promise：从入门到精通&quot;&gt;</summary>
      
    
    
    
    <category term="教程" scheme="https://aoayaoa.github.io/categories/%E6%95%99%E7%A8%8B/"/>
    
    
    <category term="Promise" scheme="https://aoayaoa.github.io/tags/Promise/"/>
    
    <category term="入门" scheme="https://aoayaoa.github.io/tags/%E5%85%A5%E9%97%A8/"/>
    
  </entry>
  
  <entry>
    <title>Taro使用记录</title>
    <link href="https://aoayaoa.github.io/2024/09/08/taro/"/>
    <id>https://aoayaoa.github.io/2024/09/08/taro/</id>
    <published>2024-09-07T16:00:00.000Z</published>
    <updated>2025-04-16T04:30:22.713Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Deno学习记录-📘"><a href="#Deno学习记录-📘" class="headerlink" title="Deno学习记录 📘"></a>Deno学习记录 📘</h1><h1 id="📱-Taro-学习总结"><a href="#📱-Taro-学习总结" class="headerlink" title="📱 Taro 学习总结"></a>📱 Taro 学习总结</h1><p>Taro 是一个开放式跨端跨框架解决方案，助力开发者快速构建小程序、H5和原生应用</p><h2 id="📑-目录"><a href="#📑-目录" class="headerlink" title="📑 目录"></a>📑 目录</h2><ul><li><a href="#-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5">基础概念</a></li><li><a href="#-%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84">项目结构</a></li><li><a href="#-%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8">基础使用</a></li><li><a href="#-%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">小程序开发注意事项</a></li><li><a href="#-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">常见问题与解决方案</a></li><li><a href="#-%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%89%93%E5%8C%85%E4%B8%8E%E5%8F%91%E5%B8%83">小程序打包与发布</a></li><li><a href="#-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">性能优化最佳实践</a></li><li><a href="#-%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%89%B9%E6%9C%89%E5%8A%9F%E8%83%BD">小程序特有功能</a></li><li><a href="#-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">最佳实践</a></li></ul><hr><h2 id="🔰-基础概念"><a href="#🔰-基础概念" class="headerlink" title="🔰 基础概念"></a>🔰 基础概念</h2><p>Taro 是一个开放式跨端跨框架解决方案，支持使用 React&#x2F;Vue&#x2F;Nerv 等框架来开发小程序、H5、RN 等应用。</p><hr><h2 id="📂-项目结构"><a href="#📂-项目结构" class="headerlink" title="📂 项目结构"></a>📂 项目结构</h2><p>一个典型的 Taro 项目结构：</p><table><thead><tr><th align="left">目录&#x2F;文件</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">📁 <code>config/</code></td><td align="left">项目编译配置目录</td></tr><tr><td align="left">📁 <code>src/</code></td><td align="left">源码目录</td></tr><tr><td align="left">├─ 📄 <code>app.config.ts</code></td><td align="left">全局配置文件</td></tr><tr><td align="left">├─ 📄 <code>app.ts</code></td><td align="left">入口文件</td></tr><tr><td align="left">├─ 📄 <code>app.scss</code></td><td align="left">全局样式文件</td></tr><tr><td align="left">├─ 📁 <code>pages/</code></td><td align="left">页面文件目录</td></tr><tr><td align="left">├─ 📁 <code>components/</code></td><td align="left">组件目录</td></tr><tr><td align="left">├─ 📁 <code>assets/</code></td><td align="left">静态资源目录</td></tr><tr><td align="left">├─ 📁 <code>utils/</code></td><td align="left">工具函数目录</td></tr><tr><td align="left">├─ 📁 <code>stores/</code></td><td align="left">状态管理目录</td></tr><tr><td align="left">└─ 📁 <code>services/</code></td><td align="left">服务接口目录</td></tr></tbody></table><hr><h2 id="🚀-基础使用"><a href="#🚀-基础使用" class="headerlink" title="🚀 基础使用"></a>🚀 基础使用</h2><h3 id="1️⃣-项目创建和启动"><a href="#1️⃣-项目创建和启动" class="headerlink" title="1️⃣ 项目创建和启动"></a>1️⃣ 项目创建和启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 Taro CLI</span></span><br><span class="line">npm install -g @tarojs/cli</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建项目</span></span><br><span class="line">taro init myApp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开发微信小程序</span></span><br><span class="line">npm run dev:weapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打包微信小程序</span></span><br><span class="line">npm run build:weapp</span><br></pre></td></tr></table></figure><h3 id="2️⃣-配置文件"><a href="#2️⃣-配置文件" class="headerlink" title="2️⃣ 配置文件"></a>2️⃣ 配置文件</h3><p><code>app.config.ts</code> 用于项目全局配置：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// 页面路径列表</span></span><br><span class="line">  <span class="attr">pages</span>: [</span><br><span class="line">    <span class="string">&#x27;pages/home/index&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;pages/mine/index&#x27;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="comment">// 全局窗口配置</span></span><br><span class="line">  <span class="attr">window</span>: &#123;</span><br><span class="line">    <span class="attr">backgroundTextStyle</span>: <span class="string">&#x27;light&#x27;</span>,</span><br><span class="line">    <span class="attr">navigationBarBackgroundColor</span>: <span class="string">&#x27;#fff&#x27;</span>,</span><br><span class="line">    <span class="attr">navigationBarTitleText</span>: <span class="string">&#x27;WeChat&#x27;</span>,</span><br><span class="line">    <span class="attr">navigationBarTextStyle</span>: <span class="string">&#x27;black&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 底部 TabBar 配置</span></span><br><span class="line">  <span class="attr">tabBar</span>: &#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&#x27;#999&#x27;</span>,</span><br><span class="line">    <span class="attr">selectedColor</span>: <span class="string">&#x27;#dc2743&#x27;</span>,</span><br><span class="line">    <span class="attr">backgroundColor</span>: <span class="string">&#x27;#fff&#x27;</span>,</span><br><span class="line">    <span class="attr">list</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">pagePath</span>: <span class="string">&#x27;pages/home/index&#x27;</span>,</span><br><span class="line">        <span class="attr">text</span>: <span class="string">&#x27;首页&#x27;</span>,</span><br><span class="line">        <span class="attr">iconPath</span>: <span class="string">&#x27;./assets/images/home.png&#x27;</span>,</span><br><span class="line">        <span class="attr">selectedIconPath</span>: <span class="string">&#x27;./assets/images/home-active.png&#x27;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">pagePath</span>: <span class="string">&#x27;pages/mine/index&#x27;</span>,</span><br><span class="line">        <span class="attr">text</span>: <span class="string">&#x27;我的&#x27;</span>,</span><br><span class="line">        <span class="attr">iconPath</span>: <span class="string">&#x27;./assets/images/mine.png&#x27;</span>,</span><br><span class="line">        <span class="attr">selectedIconPath</span>: <span class="string">&#x27;./assets/images/mine-active.png&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3️⃣-应用入口"><a href="#3️⃣-应用入口" class="headerlink" title="3️⃣ 应用入口"></a>3️⃣ 应用入口</h3><p><code>app.ts</code> 是应用入口文件：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; createPinia &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./app.scss&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建应用实例</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">App</span> = <span class="title function_">createApp</span>(&#123;</span><br><span class="line">  <span class="title function_">onLaunch</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 应用启动时触发</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;App launched&#x27;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">onShow</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="comment">// 应用显示时触发</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;App shown&#x27;</span>, options)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用状态管理</span></span><br><span class="line"><span class="keyword">const</span> pinia = <span class="title function_">createPinia</span>()</span><br><span class="line"><span class="title class_">App</span>.<span class="title function_">use</span>(pinia)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span></span><br></pre></td></tr></table></figure><h3 id="4️⃣-页面开发"><a href="#4️⃣-页面开发" class="headerlink" title="4️⃣ 页面开发"></a>4️⃣ 页面开发</h3><p>每个页面通常包含三个文件：</p><ul><li><code>index.vue</code> - 页面组件</li><li><code>index.scss</code> - 页面样式</li><li><code>index.config.ts</code> - 页面配置</li></ul><p><strong>页面组件示例（Vue3）：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;view class=&quot;page&quot;&gt;</span><br><span class="line">    &lt;text&gt;&#123;&#123; message &#125;&#125;&lt;/text&gt;</span><br><span class="line">    &lt;button @tap=&quot;handleClick&quot;&gt;点击我&lt;/button&gt;</span><br><span class="line">  &lt;/view&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref &#125; from &#x27;vue&#x27;</span><br><span class="line">import Taro from &#x27;@tarojs/taro&#x27;</span><br><span class="line"></span><br><span class="line">const message = ref(&#x27;Hello World&#x27;)</span><br><span class="line"></span><br><span class="line">const handleClick = () =&gt; &#123;</span><br><span class="line">  Taro.showToast(&#123;</span><br><span class="line">    title: &#x27;点击成功&#x27;,</span><br><span class="line">    icon: &#x27;success&#x27;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;scss&quot;&gt;</span><br><span class="line">.page &#123;</span><br><span class="line">  padding: 20px;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure><p><strong>页面配置示例：</strong></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">navigationBarTitleText</span>: <span class="string">&#x27;页面标题&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="⚠️-小程序开发注意事项"><a href="#⚠️-小程序开发注意事项" class="headerlink" title="⚠️ 小程序开发注意事项"></a>⚠️ 小程序开发注意事项</h2><h3 id="📌-生命周期"><a href="#📌-生命周期" class="headerlink" title="📌 生命周期"></a>📌 生命周期</h3><h4 id="Taro-框架生命周期："><a href="#Taro-框架生命周期：" class="headerlink" title="Taro 框架生命周期："></a>Taro 框架生命周期：</h4><table><thead><tr><th align="left">生命周期</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">🔄 <code>onLaunch</code></td><td align="left">应用初始化</td></tr><tr><td align="left">👁️ <code>onShow</code></td><td align="left">应用显示</td></tr><tr><td align="left">🙈 <code>onHide</code></td><td align="left">应用隐藏</td></tr><tr><td align="left">❌ <code>onError</code></td><td align="left">应用发生错误</td></tr></tbody></table><h4 id="页面生命周期："><a href="#页面生命周期：" class="headerlink" title="页面生命周期："></a>页面生命周期：</h4><table><thead><tr><th align="left">生命周期</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">📥 <code>onLoad</code></td><td align="left">页面加载</td></tr><tr><td align="left">✅ <code>onReady</code></td><td align="left">页面初次渲染完成</td></tr><tr><td align="left">👁️ <code>onShow</code></td><td align="left">页面显示</td></tr><tr><td align="left">🙈 <code>onHide</code></td><td align="left">页面隐藏</td></tr><tr><td align="left">📤 <code>onUnload</code></td><td align="left">页面卸载</td></tr><tr><td align="left">⬇️ <code>onPullDownRefresh</code></td><td align="left">下拉刷新</td></tr><tr><td align="left">⬆️ <code>onReachBottom</code></td><td align="left">上拉触底</td></tr><tr><td align="left">📜 <code>onPageScroll</code></td><td align="left">页面滚动</td></tr><tr><td align="left">📤 <code>onShareAppMessage</code></td><td align="left">用户点击右上角分享</td></tr></tbody></table><h4 id="组合式-API-中使用生命周期："><a href="#组合式-API-中使用生命周期：" class="headerlink" title="组合式 API 中使用生命周期："></a>组合式 API 中使用生命周期：</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; onMounted, onUnmounted &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; useDidShow, useDidHide &#125; <span class="keyword">from</span> <span class="string">&#x27;@tarojs/taro&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Vue 生命周期</span></span><br><span class="line"><span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;组件挂载&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">onUnmounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;组件卸载&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Taro 页面生命周期</span></span><br><span class="line"><span class="title function_">useDidShow</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;页面显示&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">useDidHide</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;页面隐藏&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="📌-路由与导航"><a href="#📌-路由与导航" class="headerlink" title="📌 路由与导航"></a>📌 路由与导航</h3><p>Taro 导航 API：</p><table><thead><tr><th align="left">API</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">🔀 <code>Taro.navigateTo</code></td><td align="left">保留当前页面，跳转到应用内的某个页面</td></tr><tr><td align="left">🔄 <code>Taro.redirectTo</code></td><td align="left">关闭当前页面，跳转到应用内的某个页面</td></tr><tr><td align="left">📑 <code>Taro.switchTab</code></td><td align="left">跳转到 tabBar 页面，并关闭其他所有非 tabBar 页面</td></tr><tr><td align="left">◀️ <code>Taro.navigateBack</code></td><td align="left">关闭当前页面，返回上一页面或多级页面</td></tr><tr><td align="left">🔃 <code>Taro.reLaunch</code></td><td align="left">关闭所有页面，打开到应用内的某个页面</td></tr></tbody></table><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 示例用法</span></span><br><span class="line"><span class="title class_">Taro</span>.<span class="title function_">navigateTo</span>(&#123;</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;/pages/detail/index?id=123&#x27;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="📌-状态管理"><a href="#📌-状态管理" class="headerlink" title="📌 状态管理"></a>📌 状态管理</h3><p><strong>Pinia (Vue3)：</strong></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建 store</span></span><br><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useCounterStore = <span class="title function_">defineStore</span>(<span class="string">&#x27;counter&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">state</span>: <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">count</span>: <span class="number">0</span></span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    <span class="title function_">increment</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">count</span>++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 store</span></span><br><span class="line"><span class="keyword">import</span> &#123; useCounterStore &#125; <span class="keyword">from</span> <span class="string">&#x27;../stores/counter&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> counterStore = <span class="title function_">useCounterStore</span>()</span><br><span class="line">counterStore.<span class="title function_">increment</span>()</span><br></pre></td></tr></table></figure><h3 id="📌-数据存储"><a href="#📌-数据存储" class="headerlink" title="📌 数据存储"></a>📌 数据存储</h3><p>小程序数据存储 API：</p><table><thead><tr><th align="left">API</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">💾 <code>Taro.setStorage</code></td><td align="left">异步存储数据</td></tr><tr><td align="left">💾 <code>Taro.setStorageSync</code></td><td align="left">同步存储数据</td></tr><tr><td align="left">📂 <code>Taro.getStorage</code></td><td align="left">异步获取数据</td></tr><tr><td align="left">📂 <code>Taro.getStorageSync</code></td><td align="left">同步获取数据</td></tr><tr><td align="left">🗑️ <code>Taro.removeStorage</code></td><td align="left">异步移除数据</td></tr><tr><td align="left">🗑️ <code>Taro.removeStorageSync</code></td><td align="left">同步移除数据</td></tr><tr><td align="left">🧹 <code>Taro.clearStorage</code></td><td align="left">清除所有数据</td></tr></tbody></table><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 示例用法</span></span><br><span class="line"><span class="title class_">Taro</span>.<span class="title function_">setStorageSync</span>(<span class="string">&#x27;token&#x27;</span>, <span class="string">&#x27;abc123&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> token = <span class="title class_">Taro</span>.<span class="title function_">getStorageSync</span>(<span class="string">&#x27;token&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="📌-网络请求"><a href="#📌-网络请求" class="headerlink" title="📌 网络请求"></a>📌 网络请求</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基本用法</span></span><br><span class="line"><span class="title class_">Taro</span>.<span class="title function_">request</span>(&#123;</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;https://api.example.com/data&#x27;</span>,</span><br><span class="line">  <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">  <span class="attr">data</span>: &#123; <span class="attr">id</span>: <span class="number">123</span> &#125;,</span><br><span class="line">  <span class="attr">header</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">&#x27;Bearer token&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">success</span>: <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;请求成功：&#x27;</span>, res.<span class="property">data</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">fail</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;请求失败：&#x27;</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Promise 用法</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">Taro</span>.<span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;https://api.example.com/data&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;请求成功：&#x27;</span>, res.<span class="property">data</span>)</span><br><span class="line">&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;请求失败：&#x27;</span>, err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="📌-UI-组件使用"><a href="#📌-UI-组件使用" class="headerlink" title="📌 UI 组件使用"></a>📌 UI 组件使用</h3><p>Taro 内置基础组件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;view class=&quot;container&quot;&gt;</span><br><span class="line">    &lt;!-- 文本 --&gt;</span><br><span class="line">    &lt;text&gt;文本内容&lt;/text&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!-- 按钮 --&gt;</span><br><span class="line">    &lt;button type=&quot;primary&quot; @tap=&quot;handleClick&quot;&gt;按钮&lt;/button&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!-- 图片 --&gt;</span><br><span class="line">    &lt;image src=&quot;/assets/logo.png&quot; mode=&quot;aspectFit&quot; /&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!-- 滚动视图 --&gt;</span><br><span class="line">    &lt;scroll-view scroll-y style=&quot;height: 300px&quot;&gt;</span><br><span class="line">      &lt;view v-for=&quot;item in list&quot; :key=&quot;item.id&quot;&gt;&#123;&#123; item.name &#125;&#125;&lt;/view&gt;</span><br><span class="line">    &lt;/scroll-view&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!-- 表单组件 --&gt;</span><br><span class="line">    &lt;input type=&quot;text&quot; v-model=&quot;inputValue&quot; placeholder=&quot;请输入&quot; /&gt;</span><br><span class="line">  &lt;/view&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure><h3 id="📌-小程序分享功能"><a href="#📌-小程序分享功能" class="headerlink" title="📌 小程序分享功能"></a>📌 小程序分享功能</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 页面内设置分享</span></span><br><span class="line"><span class="title class_">Taro</span>.<span class="title function_">useShareAppMessage</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;分享标题&#x27;</span>,</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/pages/home/index?share=true&#x27;</span>,</span><br><span class="line">    <span class="attr">imageUrl</span>: <span class="string">&#x27;/assets/share.png&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 分享到朋友圈</span></span><br><span class="line"><span class="title class_">Taro</span>.<span class="title function_">useShareTimeline</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;分享到朋友圈的标题&#x27;</span>,</span><br><span class="line">    <span class="attr">query</span>: <span class="string">&#x27;share=true&#x27;</span>,</span><br><span class="line">    <span class="attr">imageUrl</span>: <span class="string">&#x27;/assets/share.png&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><hr><h2 id="🚫-易错点与开发陷阱"><a href="#🚫-易错点与开发陷阱" class="headerlink" title="🚫 易错点与开发陷阱"></a>🚫 易错点与开发陷阱</h2><h3 id="⛔-生命周期使用错误"><a href="#⛔-生命周期使用错误" class="headerlink" title="⛔ 生命周期使用错误"></a>⛔ 生命周期使用错误</h3><blockquote><p>❌ <strong>不要在 <code>onLoad</code> 中使用 <code>useState</code> 等 hooks</strong><br>应在函数组件顶层使用</p></blockquote><blockquote><p>❌ <strong>不要在 <code>onLoad</code> 中直接修改 data</strong><br>可能导致视图不更新</p></blockquote><blockquote><p>❌ <strong>不要在小程序 App 的 <code>onLaunch</code> 里调用页面跳转相关的 API</strong></p></blockquote><h3 id="⛔-JSX-模板语法差异"><a href="#⛔-JSX-模板语法差异" class="headerlink" title="⛔ JSX&#x2F;模板语法差异"></a>⛔ JSX&#x2F;模板语法差异</h3><p>条件渲染：小程序不支持 <code>&amp;&amp;</code> 短路运算符条件渲染，应使用三元运算符</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ❌ 错误 */</span></span><br><span class="line">&#123; isShow &amp;&amp; <span class="language-xml"><span class="tag">&lt;<span class="name">View</span>&gt;</span>内容<span class="tag">&lt;/<span class="name">View</span>&gt;</span></span> &#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">/* ✅ 正确 */</span></span><br><span class="line">&#123; isShow ? <span class="language-xml"><span class="tag">&lt;<span class="name">View</span>&gt;</span>内容<span class="tag">&lt;/<span class="name">View</span>&gt;</span></span> : <span class="literal">null</span> &#125;</span><br></pre></td></tr></table></figure><h3 id="⛔-事件处理"><a href="#⛔-事件处理" class="headerlink" title="⛔ 事件处理"></a>⛔ 事件处理</h3><blockquote><p>✅ <strong>事件名称使用小驼峰</strong>（onTap），而非原生小程序的连字符写法（bind:tap）<br>✅ <strong>阻止事件冒泡需使用 <code>stopPropagation</code></strong>，而非 <code>return false</code></p></blockquote><h3 id="⛔-样式问题"><a href="#⛔-样式问题" class="headerlink" title="⛔ 样式问题"></a>⛔ 样式问题</h3><blockquote><p>❌ <strong>选择器错误</strong>：小程序不支持所有 CSS 选择器（如一些伪类选择器）<br>⚠️ <strong>样式隔离</strong>：页面样式会影响到组件，需注意作用域<br>⚠️ <strong>rpx 计算</strong>：设计稿尺寸非 750px 时，需要做等比例换算</p></blockquote><h3 id="⛔-API-使用误区"><a href="#⛔-API-使用误区" class="headerlink" title="⛔ API 使用误区"></a>⛔ API 使用误区</h3><blockquote><p>⚠️ <code>Taro.navigateTo</code> 最多只能打开 10 层页面<br>⚠️ <code>Taro.setStorage</code> 存储的数据不能超过 10MB<br>⚠️ 微信小程序单个页面的逻辑层初始化耗时不能超过 20s</p></blockquote><hr><h2 id="🛠️-常见问题与解决方案"><a href="#🛠️-常见问题与解决方案" class="headerlink" title="🛠️ 常见问题与解决方案"></a>🛠️ 常见问题与解决方案</h2><h3 id="🎨-样式问题"><a href="#🎨-样式问题" class="headerlink" title="🎨 样式问题"></a>🎨 样式问题</h3><ul><li>Taro 中使用 <code>px</code> 单位会自动转换为小程序的 <code>rpx</code></li><li>如需使用原生单位，可使用 <code>Px</code> 或 <code>PX</code></li><li>推荐使用 SCSS&#x2F;SASS 预处理器</li></ul><h3 id="🔄-平台差异处理"><a href="#🔄-平台差异处理" class="headerlink" title="🔄 平台差异处理"></a>🔄 平台差异处理</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Taro</span> <span class="keyword">from</span> <span class="string">&#x27;@tarojs/taro&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取当前环境</span></span><br><span class="line"><span class="keyword">const</span> env = <span class="title class_">Taro</span>.<span class="title function_">getEnv</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断平台</span></span><br><span class="line"><span class="keyword">if</span> (env === <span class="title class_">Taro</span>.<span class="property">ENV_TYPE</span>.<span class="property">WEAPP</span>) &#123;</span><br><span class="line">  <span class="comment">// 微信小程序环境</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;当前是微信小程序环境&#x27;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (env === <span class="title class_">Taro</span>.<span class="property">ENV_TYPE</span>.<span class="property">ALIPAY</span>) &#123;</span><br><span class="line">  <span class="comment">// 支付宝小程序环境</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;当前是支付宝小程序环境&#x27;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (env === <span class="title class_">Taro</span>.<span class="property">ENV_TYPE</span>.<span class="property">H5</span>) &#123;</span><br><span class="line">  <span class="comment">// H5环境</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;当前是H5环境&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="⚡-性能优化"><a href="#⚡-性能优化" class="headerlink" title="⚡ 性能优化"></a>⚡ 性能优化</h3><ul><li>避免频繁的数据更新导致不必要的渲染</li><li>列表组件使用唯一且稳定的 key</li><li>合理使用缓存机制</li><li>按需加载资源</li></ul><h3 id="⏳-异步-API-的处理"><a href="#⏳-异步-API-的处理" class="headerlink" title="⏳ 异步 API 的处理"></a>⏳ 异步 API 的处理</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Promise 化</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">Taro</span>.<span class="title function_">showModal</span>(&#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;提示&#x27;</span>,</span><br><span class="line">    <span class="attr">content</span>: <span class="string">&#x27;确认删除？&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">if</span> (res.<span class="property">confirm</span>) &#123;</span><br><span class="line">    <span class="comment">// 用户点击确定</span></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">deleteItem</span>()</span><br><span class="line">    <span class="title class_">Taro</span>.<span class="title function_">showToast</span>(&#123; <span class="attr">title</span>: <span class="string">&#x27;删除成功&#x27;</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;操作失败&#x27;</span>, error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="📦-小程序打包与发布"><a href="#📦-小程序打包与发布" class="headerlink" title="📦 小程序打包与发布"></a>📦 小程序打包与发布</h2><h3 id="📱-分包配置"><a href="#📱-分包配置" class="headerlink" title="📱 分包配置"></a>📱 分包配置</h3><blockquote><p>小程序有体积限制，主包最大 2MB，单个分包最大 2MB，总体积不超过 20MB</p></blockquote><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.config.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">pages</span>: [</span><br><span class="line">    <span class="string">&#x27;pages/index/index&#x27;</span>, <span class="comment">// 主包页面</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">subPackages</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">root</span>: <span class="string">&#x27;packageA&#x27;</span>, <span class="comment">// 分包根目录</span></span><br><span class="line">      <span class="attr">pages</span>: [</span><br><span class="line">        <span class="string">&#x27;pages/detail/index&#x27;</span>, <span class="comment">// 实际路径: packageA/pages/detail/index</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">root</span>: <span class="string">&#x27;packageB&#x27;</span>,</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;pack2&#x27;</span>, <span class="comment">// 分包别名，可选</span></span><br><span class="line">      <span class="attr">pages</span>: [</span><br><span class="line">        <span class="string">&#x27;pages/list/index&#x27;</span>,</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="📊-分包优化策略"><a href="#📊-分包优化策略" class="headerlink" title="📊 分包优化策略"></a>📊 分包优化策略</h3><table><thead><tr><th align="left">策略</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">📋 <strong>按功能拆分</strong></td><td align="left">将功能相近的页面放入同一分包</td></tr><tr><td align="left">🔄 <strong>按访问频率拆分</strong></td><td align="left">高频页面放主包，低频页面放分包</td></tr><tr><td align="left">🔗 <strong>公共资源处理</strong></td><td align="left">配置预加载规则提高体验</td></tr></tbody></table><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.config.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">preloadRule</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;pages/index/index&#x27;</span>: &#123; <span class="comment">// 页面路径</span></span><br><span class="line">      <span class="attr">network</span>: <span class="string">&#x27;all&#x27;</span>, <span class="comment">// 在指定网络下预下载，all表示不限网络</span></span><br><span class="line">      <span class="attr">packages</span>: [<span class="string">&#x27;packageA&#x27;</span>] <span class="comment">// 进入页面后预下载分包</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="🏞️-独立分包"><a href="#🏞️-独立分包" class="headerlink" title="🏞️ 独立分包"></a>🏞️ 独立分包</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.config.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">subPackages</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">root</span>: <span class="string">&#x27;independentPackage&#x27;</span>,</span><br><span class="line">      <span class="attr">pages</span>: [</span><br><span class="line">        <span class="string">&#x27;pages/independent/index&#x27;</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">independent</span>: <span class="literal">true</span> <span class="comment">// 设置为独立分包</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>独立分包特点：</strong></p><ul><li>✅ 不依赖主包即可运行</li><li>✅ 适合广告页、活动页等临时页面</li><li>✅ 可减少启动时加载时间</li></ul><h3 id="🔄-分包预加载"><a href="#🔄-分包预加载" class="headerlink" title="🔄 分包预加载"></a>🔄 分包预加载</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.config.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">preloadRule</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;pages/index/index&#x27;</span>: &#123;</span><br><span class="line">      <span class="attr">network</span>: <span class="string">&#x27;all&#x27;</span>,</span><br><span class="line">      <span class="attr">packages</span>: [<span class="string">&#x27;packageA&#x27;</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;packageA/pages/detail/index&#x27;</span>: &#123;</span><br><span class="line">      <span class="attr">network</span>: <span class="string">&#x27;wifi&#x27;</span>, <span class="comment">// 仅在WiFi环境下预加载</span></span><br><span class="line">      <span class="attr">packages</span>: [<span class="string">&#x27;packageB&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="📉-包体积优化"><a href="#📉-包体积优化" class="headerlink" title="📉 包体积优化"></a>📉 包体积优化</h3><h4 id="🗜️-代码压缩"><a href="#🗜️-代码压缩" class="headerlink" title="🗜️ 代码压缩"></a>🗜️ 代码压缩</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config/index.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">mini</span>: &#123;</span><br><span class="line">    <span class="comment">// 压缩配置</span></span><br><span class="line">    <span class="attr">optimizeMainPackage</span>: &#123;</span><br><span class="line">      <span class="attr">enable</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 混淆配置</span></span><br><span class="line">    <span class="title function_">webpackChain</span>(<span class="params">chain</span>) &#123;</span><br><span class="line">      chain.<span class="property">optimization</span>.<span class="title function_">minimizer</span>(<span class="string">&#x27;terser&#x27;</span>)</span><br><span class="line">        .<span class="title function_">tap</span>(<span class="function"><span class="params">args</span> =&gt;</span> &#123;</span><br><span class="line">          args[<span class="number">0</span>].<span class="property">terserOptions</span> = &#123;</span><br><span class="line">            <span class="attr">compress</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">keep_classnames</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">keep_fnames</span>: <span class="literal">true</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> args</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="🖼️-资源优化"><a href="#🖼️-资源优化" class="headerlink" title="🖼️ 资源优化"></a>🖼️ 资源优化</h4><table><thead><tr><th align="left">优化方式</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">🗜️ 压缩图片</td><td align="left">使用 WebP 等高压缩比格式</td></tr><tr><td align="left">☁️ CDN 加载</td><td align="left">大图片放 CDN，通过网络加载</td></tr><tr><td align="left">📝 使用图标字体</td><td align="left">替代图片图标，减少体积</td></tr><tr><td align="left">🔗 资源合并</td><td align="left">减少网络请求数量</td></tr></tbody></table><h4 id="📥-按需引入"><a href="#📥-按需引入" class="headerlink" title="📥 按需引入"></a>📥 按需引入</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误：全量引入</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Button</span>, <span class="title class_">Input</span>, <span class="title class_">Form</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@tarojs/components&#x27;</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">// ✅ 正确：按需引入</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Button</span> <span class="keyword">from</span> <span class="string">&#x27;@tarojs/components/button&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Input</span> <span class="keyword">from</span> <span class="string">&#x27;@tarojs/components/input&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="🚀-发布流程与审核"><a href="#🚀-发布流程与审核" class="headerlink" title="🚀 发布流程与审核"></a>🚀 发布流程与审核</h3><h4 id="📋-版本号管理"><a href="#📋-版本号管理" class="headerlink" title="📋 版本号管理"></a>📋 版本号管理</h4><p>遵循语义化版本规范（SemVer）</p><h4 id="📝-提审材料准备"><a href="#📝-提审材料准备" class="headerlink" title="📝 提审材料准备"></a>📝 提审材料准备</h4><ul><li>📋 完整的小程序功能介绍</li><li>🔑 测试账号（如需登录）</li><li>📜 相关资质材料</li><li>📑 隐私协议和用户协议</li></ul><h4 id="⚠️-常见审核问题"><a href="#⚠️-常见审核问题" class="headerlink" title="⚠️ 常见审核问题"></a>⚠️ 常见审核问题</h4><ul><li>❌ 诱导分享&#x2F;评价</li><li>❌ 不合规内容和功能</li><li>❌ 个人信息收集不规范</li><li>❌ UI与体验不符合平台规范</li></ul><h3 id="🔄-CI-CD-自动化发布"><a href="#🔄-CI-CD-自动化发布" class="headerlink" title="🔄 CI&#x2F;CD 自动化发布"></a>🔄 CI&#x2F;CD 自动化发布</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .github/workflows/deploy.yml</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">Deploy</span> <span class="string">Mini</span> <span class="string">Program</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span> [ <span class="string">main</span> ]</span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Use</span> <span class="string">Node.js</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-node@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">node-version:</span> <span class="string">&#x27;16&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">npm</span> <span class="string">ci</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build:weapp</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Upload</span> <span class="string">to</span> <span class="string">WeChat</span> <span class="string">DevTools</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">zhuowenli/taro-build-action@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">project-path:</span> <span class="string">&#x27;./dist&#x27;</span></span><br><span class="line">          <span class="attr">private-key:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PRIVATE_KEY</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">private-key-id:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PRIVATE_KEY_ID</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">upload-desc:</span> <span class="string">&#x27;Auto deploy from Github Actions&#x27;</span></span><br></pre></td></tr></table></figure><hr><h2 id="⚡-性能优化最佳实践"><a href="#⚡-性能优化最佳实践" class="headerlink" title="⚡ 性能优化最佳实践"></a>⚡ 性能优化最佳实践</h2><h3 id="🚀-启动性能优化"><a href="#🚀-启动性能优化" class="headerlink" title="🚀 启动性能优化"></a>🚀 启动性能优化</h3><table><thead><tr><th align="left">优化方式</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">📦 精简主包</td><td align="left">将非必要页面移至分包</td></tr><tr><td align="left">🔄 预下载分包</td><td align="left">提前加载可能需要的分包</td></tr><tr><td align="left">⚡ 启用初始渲染缓存</td><td align="left">提高页面显示速度</td></tr></tbody></table><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.config.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">window</span>: &#123;</span><br><span class="line">    <span class="attr">initialRenderingCache</span>: <span class="string">&#x27;static&#x27;</span> <span class="comment">// 开启静态初始渲染缓存</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="⏱️-运行时性能优化"><a href="#⏱️-运行时性能优化" class="headerlink" title="⏱️ 运行时性能优化"></a>⏱️ 运行时性能优化</h3><h4 id="🛑-避免不必要的渲染"><a href="#🛑-避免不必要的渲染" class="headerlink" title="🛑 避免不必要的渲染"></a>🛑 避免不必要的渲染</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; throttle &#125; <span class="keyword">from</span> <span class="string">&#x27;../utils/tools&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 节流处理</span></span><br><span class="line"><span class="keyword">const</span> handleScroll = <span class="title function_">throttle</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 处理滚动逻辑</span></span><br><span class="line">&#125;, <span class="number">200</span>)</span><br></pre></td></tr></table></figure><h4 id="📜-长列表优化"><a href="#📜-长列表优化" class="headerlink" title="📜 长列表优化"></a>📜 长列表优化</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;scroll-view </span><br><span class="line">  scroll-y </span><br><span class="line">  style=&quot;height: 500px&quot;</span><br><span class="line">  virtual-item-height=&quot;50&quot; </span><br><span class="line">  enableVirtualList&gt;</span><br><span class="line">  &lt;virtual-item v-for=&quot;item in list&quot; :key=&quot;item.id&quot;&gt;</span><br><span class="line">    &#123;&#123; item.name &#125;&#125;</span><br><span class="line">  &lt;/virtual-item&gt;</span><br><span class="line">&lt;/scroll-view&gt;</span><br></pre></td></tr></table></figure><h4 id="🖼️-图片懒加载"><a href="#🖼️-图片懒加载" class="headerlink" title="🖼️ 图片懒加载"></a>🖼️ 图片懒加载</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;image lazy-load src=&quot;&#123;&#123;imageUrl&#125;&#125;&quot; /&gt;</span><br></pre></td></tr></table></figure><h3 id="💀-骨架屏优化"><a href="#💀-骨架屏优化" class="headerlink" title="💀 骨架屏优化"></a>💀 骨架屏优化</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.config.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">initialRenderingCache</span>: &#123;</span><br><span class="line">    <span class="attr">skeleton</span>: &#123; <span class="comment">// 配置骨架屏</span></span><br><span class="line">      <span class="attr">mode</span>: <span class="string">&#x27;fullscreen&#x27;</span>, <span class="comment">// 全屏骨架屏</span></span><br><span class="line">      <span class="attr">source</span>: <span class="string">&#x27;native&#x27;</span>, <span class="comment">// 使用原生骨架屏</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="🌐-网络请求优化"><a href="#🌐-网络请求优化" class="headerlink" title="🌐 网络请求优化"></a>🌐 网络请求优化</h3><table><thead><tr><th align="left">优化方式</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">🔗 合并请求</td><td align="left">减少请求次数</td></tr><tr><td align="left">📋 请求队列</td><td align="left">避免同时发起过多请求</td></tr><tr><td align="left">⏱️ 超时与重试</td><td align="left">合理设置请求超时和重试策略</td></tr><tr><td align="left">🚀 HTTP&#x2F;2</td><td align="left">启用 HTTP&#x2F;2 优化连接</td></tr></tbody></table><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Taro</span>.<span class="title function_">request</span>(&#123;</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;https://api.example.com/data&#x27;</span>,</span><br><span class="line">  <span class="attr">enableHttp2</span>: <span class="literal">true</span>, <span class="comment">// 开启HTTP/2</span></span><br><span class="line">  <span class="attr">enableQuic</span>: <span class="literal">true</span>, <span class="comment">// 开启QUIC</span></span><br><span class="line">  <span class="attr">enableCache</span>: <span class="literal">true</span>, <span class="comment">// 开启缓存</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><hr><h2 id="🔐-小程序特有功能"><a href="#🔐-小程序特有功能" class="headerlink" title="🔐 小程序特有功能"></a>🔐 小程序特有功能</h2><h3 id="🔑-小程序登录流程优化"><a href="#🔑-小程序登录流程优化" class="headerlink" title="🔑 小程序登录流程优化"></a>🔑 小程序登录流程优化</h3><h4 id="完整登录流程图"><a href="#完整登录流程图" class="headerlink" title="完整登录流程图"></a>完整登录流程图</h4><p><img src= "/img/loading.gif" data-lazy-src="/img/taroLogin.png"      srcset="/img/taroLogin.png 480w, /img/taroLogin.png 1200w"      sizes="(max-width:600px) 100vw, 50vw"></p><h4 id="登录流程说明"><a href="#登录流程说明" class="headerlink" title="登录流程说明"></a>登录流程说明</h4><ol><li><p><strong>本地验证阶段</strong>：</p><ul><li>检查本地是否有登录凭证(token)</li><li>若有token，验证其有效性</li><li>若无token或token无效，进入微信登录流程</li></ul></li><li><p><strong>获取凭证阶段</strong>：</p><ul><li>调用<code>Taro.login()</code>获取临时登录凭证code</li><li>将code发送至应用服务器</li></ul></li><li><p><strong>服务端身份验证</strong>：</p><ul><li>应用服务器携带code、appid和secret请求微信服务器</li><li>微信服务器返回openid和session_key</li><li>应用服务器根据openid查询用户是否存在</li></ul></li><li><p><strong>用户处理阶段</strong>：</p><ul><li>若用户已存在：更新用户登录时间，生成新token</li><li>若用户不存在：创建新用户记录，生成token</li><li>将token和用户基本信息返回小程序前端</li></ul></li><li><p><strong>登录完成阶段</strong>：</p><ul><li>小程序保存token到本地存储</li><li>保存必要的用户信息</li><li>更新应用的登录状态</li><li>进入小程序主界面</li></ul></li></ol><h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><h5 id="前端实现（Taro）"><a href="#前端实现（Taro）" class="headerlink" title="前端实现（Taro）"></a>前端实现（Taro）</h5><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// login.ts</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Taro</span> <span class="keyword">from</span> <span class="string">&#x27;@tarojs/taro&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; login <span class="keyword">as</span> apiLogin &#125; <span class="keyword">from</span> <span class="string">&#x27;../services/auth&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 登录状态检查与登录流程</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">ensureLogin</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 1. 检查本地是否有有效的 token</span></span><br><span class="line">  <span class="keyword">const</span> token = <span class="title class_">Taro</span>.<span class="title function_">getStorageSync</span>(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (token) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 2. 验证 token 是否有效</span></span><br><span class="line">      <span class="keyword">const</span> checkResult = <span class="keyword">await</span> <span class="title function_">checkTokenValidity</span>(token)</span><br><span class="line">      <span class="keyword">if</span> (checkResult.<span class="property">valid</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;token 有效，已登录&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;token 校验失败，需要重新登录&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 3. token 无效或不存在，进行登录流程</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">wxLogin</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 微信登录流程</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">wxLogin</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 显示加载提示</span></span><br><span class="line">    <span class="title class_">Taro</span>.<span class="title function_">showLoading</span>(&#123; <span class="attr">title</span>: <span class="string">&#x27;登录中...&#x27;</span> &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. 调用微信登录，获取 code</span></span><br><span class="line">    <span class="keyword">const</span> &#123; code &#125; = <span class="keyword">await</span> <span class="title class_">Taro</span>.<span class="title function_">login</span>()</span><br><span class="line">    <span class="keyword">if</span> (!code) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;微信登录失败，获取 code 失败&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. 将 code 发送给后端</span></span><br><span class="line">    <span class="keyword">const</span> loginResult = <span class="keyword">await</span> <span class="title function_">apiLogin</span>(&#123; code &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. 存储登录状态和用户信息</span></span><br><span class="line">    <span class="title class_">Taro</span>.<span class="title function_">setStorageSync</span>(<span class="string">&#x27;token&#x27;</span>, loginResult.<span class="property">token</span>)</span><br><span class="line">    <span class="title class_">Taro</span>.<span class="title function_">setStorageSync</span>(<span class="string">&#x27;userInfo&#x27;</span>, loginResult.<span class="property">userInfo</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 判断是否是新用户，如果是新用户可以引导完善资料</span></span><br><span class="line">    <span class="keyword">if</span> (loginResult.<span class="property">isNewUser</span>) &#123;</span><br><span class="line">      <span class="title class_">Taro</span>.<span class="title function_">navigateTo</span>(&#123; <span class="attr">url</span>: <span class="string">&#x27;/pages/user-profile/index&#x27;</span> &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">Taro</span>.<span class="title function_">hideLoading</span>()</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;登录失败&#x27;</span>, error)</span><br><span class="line">    <span class="title class_">Taro</span>.<span class="title function_">hideLoading</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">Taro</span>.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&#x27;登录失败，请重试&#x27;</span>,</span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 校验 token 有效性</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">checkTokenValidity</span>(<span class="params">token</span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">Taro</span>.<span class="title function_">request</span>(&#123;</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&#x27;/api/auth/check-token&#x27;</span>,</span><br><span class="line">      <span class="attr">header</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">`Bearer <span class="subst">$&#123;token&#125;</span>`</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">valid</span>: res.<span class="property">data</span>.<span class="property">valid</span> &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">valid</span>: <span class="literal">false</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="服务端实现（Node-js）"><a href="#服务端实现（Node-js）" class="headerlink" title="服务端实现（Node.js）"></a>服务端实现（Node.js）</h5><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// auth.controller.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Request</span>, <span class="title class_">Response</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span></span><br><span class="line"><span class="keyword">import</span> jwt <span class="keyword">from</span> <span class="string">&#x27;jsonwebtoken&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">User</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../models/user.model&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 微信登录配置</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">WX_CONFIG</span> = &#123;</span><br><span class="line">  <span class="attr">appId</span>: process.<span class="property">env</span>.<span class="property">WX_APP_ID</span>,</span><br><span class="line">  <span class="attr">appSecret</span>: process.<span class="property">env</span>.<span class="property">WX_APP_SECRET</span>,</span><br><span class="line">  <span class="attr">loginUrl</span>: <span class="string">&#x27;https://api.weixin.qq.com/sns/jscode2session&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 登录接口</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">login</span>(<span class="params"><span class="attr">req</span>: <span class="title class_">Request</span>, <span class="attr">res</span>: <span class="title class_">Response</span></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; code &#125; = req.<span class="property">body</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!code) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">json</span>(&#123; </span><br><span class="line">        <span class="attr">success</span>: <span class="literal">false</span>, </span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;缺少登录code&#x27;</span> </span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. 请求微信API获取openid和session_key</span></span><br><span class="line">    <span class="keyword">const</span> wxResponse = <span class="keyword">await</span> axios.<span class="title function_">get</span>(<span class="variable constant_">WX_CONFIG</span>.<span class="property">loginUrl</span>, &#123;</span><br><span class="line">      <span class="attr">params</span>: &#123;</span><br><span class="line">        <span class="attr">appid</span>: <span class="variable constant_">WX_CONFIG</span>.<span class="property">appId</span>,</span><br><span class="line">        <span class="attr">secret</span>: <span class="variable constant_">WX_CONFIG</span>.<span class="property">appSecret</span>,</span><br><span class="line">        <span class="attr">js_code</span>: code,</span><br><span class="line">        <span class="attr">grant_type</span>: <span class="string">&#x27;authorization_code&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> &#123; openid, session_key &#125; = wxResponse.<span class="property">data</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!openid) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">json</span>(&#123; </span><br><span class="line">        <span class="attr">success</span>: <span class="literal">false</span>, </span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;获取openid失败&#x27;</span> </span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 根据openid查询数据库，判断用户是否存在</span></span><br><span class="line">    <span class="keyword">let</span> user = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findOne</span>(&#123; openid &#125;)</span><br><span class="line">    <span class="keyword">let</span> isNewUser = <span class="literal">false</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 如果用户不存在，则创建新用户</span></span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      isNewUser = <span class="literal">true</span></span><br><span class="line">      user = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">        openid,</span><br><span class="line">        <span class="attr">createdAt</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">        <span class="comment">// 其他默认数据</span></span><br><span class="line">        <span class="attr">nickname</span>: <span class="string">`用户<span class="subst">$&#123;<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">10000</span>)&#125;</span>`</span>,</span><br><span class="line">        <span class="attr">avatarUrl</span>: <span class="string">&#x27;&#x27;</span>, <span class="comment">// 默认头像</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. 生成token</span></span><br><span class="line">    <span class="keyword">const</span> token = jwt.<span class="title function_">sign</span>(</span><br><span class="line">      &#123; <span class="attr">userId</span>: user.<span class="property">_id</span>, openid &#125;,</span><br><span class="line">      process.<span class="property">env</span>.<span class="property">JWT_SECRET</span>,</span><br><span class="line">      &#123; <span class="attr">expiresIn</span>: <span class="string">&#x27;7d&#x27;</span> &#125;</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. 更新用户的最后登录时间</span></span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">updateOne</span>(</span><br><span class="line">      &#123; <span class="attr">_id</span>: user.<span class="property">_id</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">$set</span>: &#123; <span class="attr">lastLoginAt</span>: <span class="keyword">new</span> <span class="title class_">Date</span>() &#125; &#125;</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. 返回登录结果</span></span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">success</span>: <span class="literal">true</span>,</span><br><span class="line">      token,</span><br><span class="line">      <span class="attr">userInfo</span>: &#123;</span><br><span class="line">        <span class="attr">_id</span>: user.<span class="property">_id</span>,</span><br><span class="line">        <span class="attr">nickname</span>: user.<span class="property">nickname</span>,</span><br><span class="line">        <span class="attr">avatarUrl</span>: user.<span class="property">avatarUrl</span>,</span><br><span class="line">        <span class="comment">// 其他需要的用户信息</span></span><br><span class="line">      &#125;,</span><br><span class="line">      isNewUser</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;登录异常:&#x27;</span>, error)</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&#x27;服务器错误&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证token接口</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">checkToken</span>(<span class="params"><span class="attr">req</span>: <span class="title class_">Request</span>, <span class="attr">res</span>: <span class="title class_">Response</span></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// token已经在中间件中验证过，能到这里说明token有效</span></span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">valid</span>: <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">valid</span>: <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="请求封装"><a href="#请求封装" class="headerlink" title="请求封装"></a>请求封装</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// request.ts</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Taro</span> <span class="keyword">from</span> <span class="string">&#x27;@tarojs/taro&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; ensureLogin &#125; <span class="keyword">from</span> <span class="string">&#x27;./login&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 封装请求方法，自动携带token和处理登录态</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">request</span>(<span class="params">options</span>) &#123;</span><br><span class="line">  <span class="comment">// 获取存储的token</span></span><br><span class="line">  <span class="keyword">const</span> token = <span class="title class_">Taro</span>.<span class="title function_">getStorageSync</span>(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 合并请求头</span></span><br><span class="line">  <span class="keyword">const</span> header = &#123;</span><br><span class="line">    <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">    ...options.<span class="property">header</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 如果有token，则添加到请求头</span></span><br><span class="line">  <span class="keyword">if</span> (token) &#123;</span><br><span class="line">    header[<span class="string">&#x27;Authorization&#x27;</span>] = <span class="string">`Bearer <span class="subst">$&#123;token&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title class_">Taro</span>.<span class="title function_">request</span>(&#123;</span><br><span class="line">      ...options,</span><br><span class="line">      header</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 请求成功</span></span><br><span class="line">    <span class="keyword">if</span> (response.<span class="property">statusCode</span> &gt;= <span class="number">200</span> &amp;&amp; response.<span class="property">statusCode</span> &lt; <span class="number">300</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> response.<span class="property">data</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// token 失效（401）</span></span><br><span class="line">    <span class="keyword">if</span> (response.<span class="property">statusCode</span> === <span class="number">401</span>) &#123;</span><br><span class="line">      <span class="comment">// 清除已失效的token</span></span><br><span class="line">      <span class="title class_">Taro</span>.<span class="title function_">removeStorageSync</span>(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 重新登录</span></span><br><span class="line">      <span class="keyword">const</span> loginSuccess = <span class="keyword">await</span> <span class="title function_">ensureLogin</span>()</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (loginSuccess) &#123;</span><br><span class="line">        <span class="comment">// 登录成功，重试原请求</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">request</span>(options)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;登录失败，无法完成请求&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 其他错误</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(response.<span class="property">data</span>.<span class="property">message</span> || <span class="string">&#x27;请求失败&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;请求异常:&#x27;</span>, error)</span><br><span class="line">    <span class="keyword">throw</span> error</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="登录状态管理（使用Pinia）"><a href="#登录状态管理（使用Pinia）" class="headerlink" title="登录状态管理（使用Pinia）"></a>登录状态管理（使用Pinia）</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// stores/user.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Taro</span> <span class="keyword">from</span> <span class="string">&#x27;@tarojs/taro&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; ensureLogin &#125; <span class="keyword">from</span> <span class="string">&#x27;../utils/login&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; getUserInfo &#125; <span class="keyword">from</span> <span class="string">&#x27;../services/user&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useUserStore = <span class="title function_">defineStore</span>(<span class="string">&#x27;user&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">state</span>: <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">token</span>: <span class="title class_">Taro</span>.<span class="title function_">getStorageSync</span>(<span class="string">&#x27;token&#x27;</span>) || <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">userInfo</span>: <span class="title class_">Taro</span>.<span class="title function_">getStorageSync</span>(<span class="string">&#x27;userInfo&#x27;</span>) || <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">isLoggedIn</span>: !!<span class="title class_">Taro</span>.<span class="title function_">getStorageSync</span>(<span class="string">&#x27;token&#x27;</span>),</span><br><span class="line">    <span class="attr">isLoading</span>: <span class="literal">false</span></span><br><span class="line">  &#125;),</span><br><span class="line">  </span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    <span class="comment">// 初始化检查登录状态</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">checkLoginStatus</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isLoggedIn</span>) &#123;</span><br><span class="line">          <span class="comment">// 刷新用户信息</span></span><br><span class="line">          <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">fetchUserInfo</span>()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="comment">// 出错则置为未登录状态</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isLoggedIn</span> = <span class="literal">false</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">token</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">userInfo</span> = <span class="literal">null</span></span><br><span class="line">        <span class="title class_">Taro</span>.<span class="title function_">removeStorageSync</span>(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">        <span class="title class_">Taro</span>.<span class="title function_">removeStorageSync</span>(<span class="string">&#x27;userInfo&#x27;</span>)</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 登录</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> success = <span class="keyword">await</span> <span class="title function_">ensureLogin</span>()</span><br><span class="line">        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">token</span> = <span class="title class_">Taro</span>.<span class="title function_">getStorageSync</span>(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">userInfo</span> = <span class="title class_">Taro</span>.<span class="title function_">getStorageSync</span>(<span class="string">&#x27;userInfo&#x27;</span>)</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">isLoggedIn</span> = <span class="literal">true</span></span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;登录失败&#x27;</span>, error)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取用户信息</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">fetchUserInfo</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">token</span>) <span class="keyword">return</span></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> userInfo = <span class="keyword">await</span> <span class="title function_">getUserInfo</span>()</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">userInfo</span> = userInfo</span><br><span class="line">        <span class="title class_">Taro</span>.<span class="title function_">setStorageSync</span>(<span class="string">&#x27;userInfo&#x27;</span>, userInfo)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;获取用户信息失败&#x27;</span>, error)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 退出登录</span></span><br><span class="line">    <span class="title function_">logout</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">token</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">userInfo</span> = <span class="literal">null</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">isLoggedIn</span> = <span class="literal">false</span></span><br><span class="line">      <span class="title class_">Taro</span>.<span class="title function_">removeStorageSync</span>(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">      <span class="title class_">Taro</span>.<span class="title function_">removeStorageSync</span>(<span class="string">&#x27;userInfo&#x27;</span>)</span><br><span class="line">      <span class="title class_">Taro</span>.<span class="title function_">showToast</span>(&#123; <span class="attr">title</span>: <span class="string">&#x27;已退出登录&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;success&#x27;</span> &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="登录流程使用示例"><a href="#登录流程使用示例" class="headerlink" title="登录流程使用示例"></a>登录流程使用示例</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;view class=&quot;login-page&quot;&gt;</span><br><span class="line">    &lt;view v-if=&quot;!userStore.isLoggedIn&quot;&gt;</span><br><span class="line">      &lt;button @tap=&quot;handleLogin&quot; :loading=&quot;userStore.isLoading&quot;&gt;</span><br><span class="line">        微信一键登录</span><br><span class="line">      &lt;/button&gt;</span><br><span class="line">    &lt;/view&gt;</span><br><span class="line">    &lt;view v-else&gt;</span><br><span class="line">      &lt;view class=&quot;user-info&quot;&gt;</span><br><span class="line">        &lt;image :src=&quot;userStore.userInfo?.avatarUrl || defaultAvatar&quot; class=&quot;avatar&quot; /&gt;</span><br><span class="line">        &lt;text class=&quot;nickname&quot;&gt;&#123;&#123; userStore.userInfo?.nickname || &#x27;未设置昵称&#x27; &#125;&#125;&lt;/text&gt;</span><br><span class="line">      &lt;/view&gt;</span><br><span class="line">      &lt;button @tap=&quot;userStore.logout&quot; type=&quot;default&quot;&gt;退出登录&lt;/button&gt;</span><br><span class="line">    &lt;/view&gt;</span><br><span class="line">  &lt;/view&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">import &#123; onLoad &#125; from &#x27;@tarojs/taro&#x27;</span><br><span class="line">import &#123; useUserStore &#125; from &#x27;../../stores/user&#x27;</span><br><span class="line"></span><br><span class="line">const userStore = useUserStore()</span><br><span class="line">const defaultAvatar = &#x27;../../assets/default-avatar.png&#x27;</span><br><span class="line"></span><br><span class="line">// 页面加载时检查登录状态</span><br><span class="line">onLoad(() =&gt; &#123;</span><br><span class="line">  userStore.checkLoginStatus()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 处理登录</span><br><span class="line">const handleLogin = async () =&gt; &#123;</span><br><span class="line">  const success = await userStore.login()</span><br><span class="line">  if (success) &#123;</span><br><span class="line">    console.log(&#x27;登录成功&#x27;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h4 id="登录安全最佳实践"><a href="#登录安全最佳实践" class="headerlink" title="登录安全最佳实践"></a>登录安全最佳实践</h4><ol><li><p><strong>使用 HTTPS</strong>：所有接口通信必须使用 HTTPS 加密传输</p></li><li><p><strong>TOKEN 处理</strong>：</p><ul><li>设置合理的过期时间（通常7天以内）</li><li>支持主动刷新 TOKEN</li><li>退出登录时清除 TOKEN</li></ul></li><li><p><strong>敏感信息存储</strong>：</p><ul><li>不在客户端存储用户敏感信息</li><li>使用小程序提供的安全存储 API</li></ul></li><li><p><strong>防刷防暴力</strong>：</p><ul><li>登录接口增加频率限制</li><li>多次失败后要求图形验证码或延时</li></ul></li><li><p><strong>用户信息保护</strong>：</p><ul><li>只返回必要的用户信息</li><li>敏感操作需要二次验证</li></ul></li></ol><h3 id="👤-获取用户信息"><a href="#👤-获取用户信息" class="headerlink" title="👤 获取用户信息"></a>👤 获取用户信息</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;button </span><br><span class="line">    open-type=&quot;chooseAvatar&quot; </span><br><span class="line">    @chooseavatar=&quot;onChooseAvatar&quot;&gt;</span><br><span class="line">    选择头像</span><br><span class="line">  &lt;/button&gt;</span><br><span class="line">  </span><br><span class="line">  &lt;input </span><br><span class="line">    type=&quot;nickname&quot; </span><br><span class="line">    placeholder=&quot;请输入昵称&quot; </span><br><span class="line">    @change=&quot;onNicknameChange&quot; </span><br><span class="line">  /&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">import &#123; ref &#125; from &#x27;vue&#x27;</span><br><span class="line">import Taro from &#x27;@tarojs/taro&#x27;</span><br><span class="line"></span><br><span class="line">const avatarUrl = ref(&#x27;&#x27;)</span><br><span class="line">const nickname = ref(&#x27;&#x27;)</span><br><span class="line"></span><br><span class="line">const onChooseAvatar = (e) =&gt; &#123;</span><br><span class="line">  avatarUrl.value = e.detail.avatarUrl</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const onNicknameChange = (e) =&gt; &#123;</span><br><span class="line">  nickname.value = e.detail.value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const saveUserInfo = async () =&gt; &#123;</span><br><span class="line">  if (!avatarUrl.value || !nickname.value) &#123;</span><br><span class="line">    Taro.showToast(&#123;</span><br><span class="line">      title: &#x27;请完善信息&#x27;,</span><br><span class="line">      icon: &#x27;none&#x27;</span><br><span class="line">    &#125;)</span><br><span class="line">    return</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  // 上传头像到服务器</span><br><span class="line">  const uploadRes = await uploadFile(avatarUrl.value)</span><br><span class="line">  </span><br><span class="line">  // 保存用户信息</span><br><span class="line">  await updateUserInfo(&#123;</span><br><span class="line">    avatarUrl: uploadRes.url,</span><br><span class="line">    nickname: nickname.value</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h3 id="📱-小程序适配与兼容性"><a href="#📱-小程序适配与兼容性" class="headerlink" title="📱 小程序适配与兼容性"></a>📱 小程序适配与兼容性</h3><h4 id="📊-基础库版本"><a href="#📊-基础库版本" class="headerlink" title="📊 基础库版本"></a>📊 基础库版本</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.config.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">miniprogramRoot</span>: <span class="string">&#x27;./&#x27;</span>,</span><br><span class="line">  <span class="attr">projectname</span>: <span class="string">&#x27;MyApp&#x27;</span>,</span><br><span class="line">  <span class="attr">setting</span>: &#123;</span><br><span class="line">    <span class="attr">minified</span>: <span class="literal">true</span>, <span class="comment">// 压缩代码</span></span><br><span class="line">    <span class="attr">es6</span>: <span class="literal">true</span>, <span class="comment">// 开启ES6转换</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">libVersion</span>: <span class="string">&#x27;2.24.7&#x27;</span>, <span class="comment">// 指定基础库版本</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="🔄-版本检测与提示"><a href="#🔄-版本检测与提示" class="headerlink" title="🔄 版本检测与提示"></a>🔄 版本检测与提示</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">checkVersion</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 获取微信版本信息</span></span><br><span class="line">  <span class="keyword">const</span> version = <span class="title class_">Taro</span>.<span class="title function_">getSystemInfoSync</span>().<span class="property">SDKVersion</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 比较版本号</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Taro</span>.<span class="title function_">compareVersion</span>(version, <span class="string">&#x27;2.21.0&#x27;</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="title class_">Taro</span>.<span class="title function_">showModal</span>(&#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&#x27;提示&#x27;</span>,</span><br><span class="line">      <span class="attr">content</span>: <span class="string">&#x27;当前微信版本过低，请更新至最新版本&#x27;</span>,</span><br><span class="line">      <span class="attr">showCancel</span>: <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="🎨-WeUI-组件使用"><a href="#🎨-WeUI-组件使用" class="headerlink" title="🎨 WeUI 组件使用"></a>🎨 WeUI 组件使用</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.config.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">useExtendedLib</span>: &#123;</span><br><span class="line">    <span class="attr">weui</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;weui-form&gt;</span><br><span class="line">    &lt;weui-cells title=&quot;表单&quot;&gt;</span><br><span class="line">      &lt;weui-cell&gt;</span><br><span class="line">        &lt;weui-input placeholder=&quot;请输入&quot; /&gt;</span><br><span class="line">      &lt;/weui-cell&gt;</span><br><span class="line">    &lt;/weui-cells&gt;</span><br><span class="line">    &lt;weui-button type=&quot;primary&quot;&gt;提交&lt;/weui-button&gt;</span><br><span class="line">  &lt;/weui-form&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure><hr><h2 id="✨-最佳实践"><a href="#✨-最佳实践" class="headerlink" title="✨ 最佳实践"></a>✨ 最佳实践</h2><table><thead><tr><th align="left">实践</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">📁 <strong>代码组织</strong></td><td align="left">按功能模块拆分组件，避免过大的页面文件</td></tr><tr><td align="left">🔄 <strong>状态管理</strong></td><td align="left">复杂应用使用 Pinia 等状态管理工具</td></tr><tr><td align="left">🎨 <strong>样式管理</strong></td><td align="left">使用预处理器，模块化CSS</td></tr><tr><td align="left">🔄 <strong>兼容性</strong></td><td align="left">注意小程序平台差异，做好兼容处理</td></tr><tr><td align="left">🔒 <strong>安全性</strong></td><td align="left">敏感数据不存储在本地，使用token验证请求</td></tr><tr><td align="left">⚠️ <strong>错误处理</strong></td><td align="left">完善的错误捕获和提示机制</td></tr><tr><td align="left">🔄 <strong>代码复用</strong></td><td align="left">抽取公共逻辑到 hooks&#x2F;composables 中</td></tr><tr><td align="left">🔌 <strong>接口封装</strong></td><td align="left">统一封装网络请求，便于管理</td></tr></tbody></table>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Deno学习记录-📘&quot;&gt;&lt;a href=&quot;#Deno学习记录-📘&quot; class=&quot;headerlink&quot; title=&quot;Deno学习记录 📘&quot;&gt;&lt;/a&gt;Deno学习记录 📘&lt;/h1&gt;&lt;h1 id=&quot;📱-Taro-学习总结&quot;&gt;&lt;a href=&quot;#📱-Ta</summary>
      
    
    
    
    
    <category term="Taro" scheme="https://aoayaoa.github.io/tags/Taro/"/>
    
  </entry>
  
  <entry>
    <title>性能优化</title>
    <link href="https://aoayaoa.github.io/2024/07/07/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"/>
    <id>https://aoayaoa.github.io/2024/07/07/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/</id>
    <published>2024-07-06T16:00:00.000Z</published>
    <updated>2025-04-16T04:38:58.278Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Web-性能优化完全指南"><a href="#Web-性能优化完全指南" class="headerlink" title="Web 性能优化完全指南"></a>Web 性能优化完全指南</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul><li><a href="#1-%E5%8A%A0%E8%BD%BD%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">1. 加载性能优化</a></li><li><a href="#2-%E6%B8%B2%E6%9F%93%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">2. 渲染性能优化</a></li><li><a href="#3-%E8%B5%84%E6%BA%90%E4%BC%98%E5%8C%96">3. 资源优化</a></li><li><a href="#4-%E7%BD%91%E7%BB%9C%E5%B1%82%E4%BC%98%E5%8C%96">4. 网络层优化</a></li><li><a href="#5-%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5">5. 缓存策略</a></li><li><a href="#6-%E6%A1%86%E6%9E%B6%E7%BA%A7%E4%BC%98%E5%8C%96">6. 框架级优化</a></li><li><a href="#7-%E7%A7%BB%E5%8A%A8%E7%AB%AF%E4%B8%93%E9%A1%B9%E4%BC%98%E5%8C%96">7. 移动端专项优化</a></li><li><a href="#8-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%88%86%E6%9E%90">8. 性能监控与分析</a></li><li><a href="#9-%E8%BF%9B%E9%98%B6%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5">9. 进阶优化策略</a></li><li><a href="#10-%E5%B7%A5%E5%85%B7%E9%93%BE%E6%8E%A8%E8%8D%90">10. 工具链推荐</a></li></ul><p><a id="1-加载性能优化"></a></p><h2 id="1-加载性能优化"><a href="#1-加载性能优化" class="headerlink" title="1. 加载性能优化"></a>1. 加载性能优化</h2><h3 id="1-1-关键渲染路径优化"><a href="#1-1-关键渲染路径优化" class="headerlink" title="1.1 关键渲染路径优化"></a>1.1 关键渲染路径优化</h3><h4 id="1-1-1-CSS优化"><a href="#1-1-1-CSS优化" class="headerlink" title="1.1.1 CSS优化"></a>1.1.1 CSS优化</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 内联关键CSS</span></span><br><span class="line">&lt;style&gt;</span><br><span class="line">  <span class="comment">/* 首屏关键样式 */</span></span><br><span class="line">  .<span class="property">header</span> &#123; ... &#125;</span><br><span class="line">  .<span class="property">hero</span>-section &#123; ... &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 异步加载非关键CSS</span></span><br><span class="line">&lt;link rel=&quot;preload&quot; href=&quot;critical.css&quot; as=&quot;style&quot; onload=&quot;this.rel=&#x27;stylesheet&#x27;&quot;&gt;</span><br><span class="line">&lt;noscript&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;critical.css&quot;&gt;&lt;/noscript&gt;</span><br><span class="line"></span><br><span class="line">// 3. 媒体查询优化</span><br><span class="line">&lt;link rel=&quot;stylesheet&quot; href=&quot;print.css&quot; media=&quot;print&quot;&gt;</span><br><span class="line">&lt;link rel=&quot;stylesheet&quot; href=&quot;desktop.css&quot; media=&quot;(min-width: 1024px)&quot;&gt;</span><br></pre></td></tr></table></figure><h4 id="1-1-2-JavaScript优化"><a href="#1-1-2-JavaScript优化" class="headerlink" title="1.1.2 JavaScript优化"></a>1.1.2 JavaScript优化</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 脚本加载策略</span></span><br><span class="line">&lt;script src=<span class="string">&quot;critical.js&quot;</span>&gt;&lt;<span class="regexp">/script&gt;           /</span>/ 关键脚本</span><br><span class="line">&lt;script src=<span class="string">&quot;app.js&quot;</span> defer&gt;&lt;<span class="regexp">/script&gt;          /</span>/ 延迟执行</span><br><span class="line">&lt;script src=<span class="string">&quot;analytics.js&quot;</span> <span class="keyword">async</span>&gt;&lt;<span class="regexp">/script&gt;    /</span>/ 异步加载</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 模块化加载</span></span><br><span class="line">&lt;script type=<span class="string">&quot;module&quot;</span> src=<span class="string">&quot;app.mjs&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 条件加载</span></span><br><span class="line"><span class="keyword">if</span> (<span class="string">&#x27;IntersectionObserver&#x27;</span> <span class="keyword">in</span> <span class="variable language_">window</span>) &#123;</span><br><span class="line">  <span class="keyword">import</span>(<span class="string">&#x27;./lazyload.js&#x27;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">module</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 实现懒加载</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-2-资源预加载策略"><a href="#1-2-资源预加载策略" class="headerlink" title="1.2 资源预加载策略"></a>1.2 资源预加载策略</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 1. DNS预解析 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;dns-prefetch&quot;</span> <span class="attr">href</span>=<span class="string">&quot;//api.example.com&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 2. 预连接 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;preconnect&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://cdn.example.com&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 3. 预加载关键资源 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;preload&quot;</span> <span class="attr">href</span>=<span class="string">&quot;font.woff2&quot;</span> <span class="attr">as</span>=<span class="string">&quot;font&quot;</span> <span class="attr">type</span>=<span class="string">&quot;font/woff2&quot;</span> <span class="attr">crossorigin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;preload&quot;</span> <span class="attr">href</span>=<span class="string">&quot;hero-image.jpg&quot;</span> <span class="attr">as</span>=<span class="string">&quot;image&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 4. 预获取下一页资源 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;prefetch&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/next-page.js&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 5. 预渲染下一页 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;prerender&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/likely-next-page.html&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="1-3-智能代码分割"><a href="#1-3-智能代码分割" class="headerlink" title="1.3 智能代码分割"></a>1.3 智能代码分割</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 路由级别分割</span></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/dashboard&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(</span><br><span class="line">      <span class="comment">/* webpackChunkName: &quot;dashboard&quot; */</span></span><br><span class="line">      <span class="string">&#x27;./views/Dashboard.vue&#x27;</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 组件级别分割</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">HeavyComponent</span> = <span class="title class_">React</span>.<span class="title function_">lazy</span>(<span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;./HeavyComponent&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 条件分割</span></span><br><span class="line"><span class="keyword">if</span> (user.<span class="property">isPremium</span>) &#123;</span><br><span class="line">  <span class="keyword">import</span>(<span class="string">&#x27;./premium-features&#x27;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">module</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">module</span>.<span class="title function_">initPremiumFeatures</span>();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 库分割</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">loadLuxuryFeatures</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">    <span class="keyword">import</span>(<span class="string">&#x27;chart.js&#x27;</span>),</span><br><span class="line">    <span class="keyword">import</span>(<span class="string">&#x27;@google/model-viewer&#x27;</span>)</span><br><span class="line">  ]).<span class="title function_">then</span>(<span class="function">(<span class="params">[Chart, ModelViewer]</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 初始化高级功能</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><a id="2-渲染性能优化"></a></p><h2 id="2-渲染性能优化"><a href="#2-渲染性能优化" class="headerlink" title="2. 渲染性能优化"></a>2. 渲染性能优化</h2><h3 id="2-1-DOM操作优化"><a href="#2-1-DOM操作优化" class="headerlink" title="2.1 DOM操作优化"></a>2.1 DOM操作优化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 批量DOM操作</span></span><br><span class="line"><span class="keyword">const</span> container = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;list&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fragment = <span class="variable language_">document</span>.<span class="title function_">createDocumentFragment</span>();</span><br><span class="line"><span class="keyword">const</span> items = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">1000</span>).<span class="title function_">fill</span>(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">requestAnimationFrame</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  items.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> li = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;li&#x27;</span>);</span><br><span class="line">    li.<span class="property">textContent</span> = <span class="string">`Item <span class="subst">$&#123;item&#125;</span>`</span>;</span><br><span class="line">    fragment.<span class="title function_">appendChild</span>(li);</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  container.<span class="title function_">appendChild</span>(fragment);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 虚拟列表实现</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VirtualList</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">container, items, rowHeight</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">container</span> = container;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">items</span> = items;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">rowHeight</span> = rowHeight;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">visibleItems</span> = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(container.<span class="property">clientHeight</span> / rowHeight);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scrollTop</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">startIndex</span> = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">init</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">container</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;scroll&#x27;</span>, <span class="variable language_">this</span>.<span class="property">onScroll</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>));</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">render</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">onScroll</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scrollTop</span> = <span class="variable language_">this</span>.<span class="property">container</span>.<span class="property">scrollTop</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">startIndex</span> = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="variable language_">this</span>.<span class="property">scrollTop</span> / <span class="variable language_">this</span>.<span class="property">rowHeight</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">render</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> visibleItems = <span class="variable language_">this</span>.<span class="property">items</span>.<span class="title function_">slice</span>(</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">startIndex</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">startIndex</span> + <span class="variable language_">this</span>.<span class="property">visibleItems</span></span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 渲染可视区域内容</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-CSS性能优化"><a href="#2-2-CSS性能优化" class="headerlink" title="2.2 CSS性能优化"></a>2.2 CSS性能优化</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 1. 选择器优化 */</span></span><br><span class="line"><span class="comment">/* 避免 */</span></span><br><span class="line"><span class="selector-tag">div</span><span class="selector-class">.header</span> <span class="selector-tag">ul</span> <span class="selector-tag">li</span> <span class="selector-tag">a</span> &#123; ... &#125;</span><br><span class="line"><span class="selector-id">#nav</span> <span class="selector-class">.list</span> <span class="selector-class">.item</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 推荐 */</span></span><br><span class="line"><span class="selector-class">.nav-link</span> &#123; ... &#125;</span><br><span class="line"><span class="selector-class">.list-item</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 2. 硬件加速 */</span></span><br><span class="line"><span class="selector-class">.hardware-accelerated</span> &#123;</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">translateZ</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="attribute">will-change</span>: transform;</span><br><span class="line">  <span class="attribute">backface-visibility</span>: hidden;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 3. 动画性能优化 */</span></span><br><span class="line"><span class="keyword">@keyframes</span> optimized-animation &#123;</span><br><span class="line">  <span class="selector-tag">from</span> &#123;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translateX</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="attribute">opacity</span>: <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-tag">to</span> &#123;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translateX</span>(<span class="number">100px</span>);</span><br><span class="line">    <span class="attribute">opacity</span>: <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.smooth-animation</span> &#123;</span><br><span class="line">  <span class="attribute">animation</span>: optimized-animation <span class="number">300ms</span> ease-out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 4. 关键CSS属性 */</span></span><br><span class="line"><span class="selector-class">.performance-critical</span> &#123;</span><br><span class="line">  <span class="attribute">contain</span>: content;  <span class="comment">/* 隔离DOM子树 */</span></span><br><span class="line">  <span class="attribute">content-visibility</span>: auto;  <span class="comment">/* 智能渲染 */</span></span><br><span class="line">  <span class="attribute">contain-intrinsic-size</span>: <span class="number">0</span> <span class="number">500px</span>;  <span class="comment">/* 预估大小 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-3-渲染优化策略"><a href="#2-3-渲染优化策略" class="headerlink" title="2.3 渲染优化策略"></a>2.3 渲染优化策略</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 避免强制同步布局</span></span><br><span class="line"><span class="keyword">const</span> cards = <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.card&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> heights = [];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不好的做法</span></span><br><span class="line">cards.<span class="title function_">forEach</span>(<span class="function"><span class="params">card</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> height = card.<span class="property">offsetHeight</span>;  <span class="comment">// 强制重排</span></span><br><span class="line">  card.<span class="property">style</span>.<span class="property">height</span> = <span class="string">`<span class="subst">$&#123;height * <span class="number">1.5</span>&#125;</span>px`</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 优化后的做法</span></span><br><span class="line"><span class="title function_">requestAnimationFrame</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 读取</span></span><br><span class="line">  cards.<span class="title function_">forEach</span>(<span class="function"><span class="params">card</span> =&gt;</span> &#123;</span><br><span class="line">    heights.<span class="title function_">push</span>(card.<span class="property">offsetHeight</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 写入</span></span><br><span class="line">  cards.<span class="title function_">forEach</span>(<span class="function">(<span class="params">card, i</span>) =&gt;</span> &#123;</span><br><span class="line">    card.<span class="property">style</span>.<span class="property">height</span> = <span class="string">`<span class="subst">$&#123;heights[i] * <span class="number">1.5</span>&#125;</span>px`</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 使用IntersectionObserver优化滚动</span></span><br><span class="line"><span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">IntersectionObserver</span>(<span class="function">(<span class="params">entries</span>) =&gt;</span> &#123;</span><br><span class="line">  entries.<span class="title function_">forEach</span>(<span class="function"><span class="params">entry</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (entry.<span class="property">isIntersecting</span>) &#123;</span><br><span class="line">      entry.<span class="property">target</span>.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;visible&#x27;</span>);</span><br><span class="line">      observer.<span class="title function_">unobserve</span>(entry.<span class="property">target</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  <span class="attr">threshold</span>: <span class="number">0.1</span>,</span><br><span class="line">  <span class="attr">rootMargin</span>: <span class="string">&#x27;50px&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.lazy-load&#x27;</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">el</span> =&gt;</span> observer.<span class="title function_">observe</span>(el));</span><br></pre></td></tr></table></figure><p><a id="3-资源优化"></a></p><h2 id="3-资源优化"><a href="#3-资源优化" class="headerlink" title="3. 资源优化"></a>3. 资源优化</h2><h3 id="3-1-图片优化策略"><a href="#3-1-图片优化策略" class="headerlink" title="3.1 图片优化策略"></a>3.1 图片优化策略</h3><table><thead><tr><th>格式</th><th>适用场景</th><th>优化工具</th></tr></thead><tbody><tr><td>WebP</td><td>全平台支持场景</td><td>cwebp</td></tr><tr><td>AVIF</td><td>现代浏览器</td><td>avifenc</td></tr><tr><td>渐进式JPEG</td><td>大图加载体验优化</td><td>jpegtran</td></tr></tbody></table><h3 id="3-2-字体优化"><a href="#3-2-字体优化" class="headerlink" title="3.2 字体优化"></a>3.2 字体优化</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@font-face</span> &#123;</span><br><span class="line">  <span class="attribute">font-family</span>: <span class="string">&#x27;CustomFont&#x27;</span>;</span><br><span class="line">  <span class="attribute">src</span>: <span class="built_in">url</span>(<span class="string">&#x27;font.woff2&#x27;</span>) <span class="built_in">format</span>(<span class="string">&#x27;woff2&#x27;</span>),</span><br><span class="line">       <span class="built_in">url</span>(<span class="string">&#x27;font.woff&#x27;</span>) <span class="built_in">format</span>(<span class="string">&#x27;woff&#x27;</span>);</span><br><span class="line">  <span class="attribute">font-display</span>: swap;</span><br><span class="line">  unicode-range: U+<span class="number">000</span>-<span class="number">5</span>FF;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a id="4-网络层优化"></a></p><h2 id="4-网络层优化"><a href="#4-网络层优化" class="headerlink" title="4. 网络层优化"></a>4. 网络层优化</h2><h3 id="4-1-HTTP-2优化"><a href="#4-1-HTTP-2优化" class="headerlink" title="4.1 HTTP&#x2F;2优化"></a>4.1 HTTP&#x2F;2优化</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Nginx配置</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">443</span> ssl http2;</span><br><span class="line">  <span class="attribute">ssl_certificate</span> /path/to/cert.pem;</span><br><span class="line">  <span class="attribute">ssl_certificate_key</span> /path/to/key.pem;</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 启用服务器推送</span></span><br><span class="line">  <span class="attribute">http2_push</span> /style.css;</span><br><span class="line">  <span class="attribute">http2_push</span> /app.js;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-CDN策略"><a href="#4-2-CDN策略" class="headerlink" title="4.2 CDN策略"></a>4.2 CDN策略</h3><pre><code class="highlight mermaid">graph TD  A[用户] --&gt; B[边缘节点]  B --&gt;|缓存命中| C[快速响应]  B --&gt;|缓存未命中| D[回源拉取]  D --&gt; E[源站服务器]</code></pre><p><a id="5-缓存策略"></a></p><h2 id="5-缓存策略"><a href="#5-缓存策略" class="headerlink" title="5. 缓存策略"></a>5. 缓存策略</h2><h3 id="5-1-缓存头设置"><a href="#5-1-缓存头设置" class="headerlink" title="5.1 缓存头设置"></a>5.1 缓存头设置</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>public, max-age=31536000, immutable</span><br><span class="line"><span class="attribute">ETag</span><span class="punctuation">: </span>&quot;xyzzy&quot;</span><br><span class="line"><span class="attribute">Vary</span><span class="punctuation">: </span>Accept-Encoding</span><br></pre></td></tr></table></figure><h3 id="5-2-Service-Worker缓存"><a href="#5-2-Service-Worker缓存" class="headerlink" title="5.2 Service Worker缓存"></a>5.2 Service Worker缓存</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">CACHE_NAME</span> = <span class="string">&#x27;v1&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">ASSETS</span> = [<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;/app.js&#x27;</span>,<span class="string">&#x27;/style.css&#x27;</span>];</span><br><span class="line"></span><br><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;install&#x27;</span>, <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">  e.<span class="title function_">waitUntil</span>(</span><br><span class="line">    caches.<span class="title function_">open</span>(<span class="variable constant_">CACHE_NAME</span>)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function"><span class="params">cache</span> =&gt;</span> cache.<span class="title function_">addAll</span>(<span class="variable constant_">ASSETS</span>))</span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><a id="6-框架级优化"></a></p><h2 id="6-框架级优化"><a href="#6-框架级优化" class="headerlink" title="6. 框架级优化"></a>6. 框架级优化</h2><h3 id="6-1-React优化"><a href="#6-1-React优化" class="headerlink" title="6.1 React优化"></a>6.1 React优化</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用memo优化组件</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MemoComponent</span> = <span class="title class_">React</span>.<span class="title function_">memo</span>(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> (</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;data&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 虚拟列表实现</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">FixedSizeList</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react-window&#x27;</span>;</span><br></pre></td></tr></table></figure><h3 id="6-2-Vue优化"><a href="#6-2-Vue优化" class="headerlink" title="6.2 Vue优化"></a>6.2 Vue优化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 组件懒加载</span></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>, <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;./Home.vue&#x27;</span>) &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 冻结大数据</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">largeData</span> = <span class="title class_">Object</span>.<span class="title function_">freeze</span>(bigData);</span><br></pre></td></tr></table></figure><p><a id="7-移动端专项优化"></a></p><h2 id="7-移动端专项优化"><a href="#7-移动端专项优化" class="headerlink" title="7. 移动端专项优化"></a>7. 移动端专项优化</h2><h3 id="7-1-首屏加速"><a href="#7-1-首屏加速" class="headerlink" title="7.1 首屏加速"></a>7.1 首屏加速</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 骨架屏 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;skeleton&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;skeleton-header&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;skeleton-content&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="7-2-手势优化"><a href="#7-2-手势优化" class="headerlink" title="7.2 手势优化"></a>7.2 手势优化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 防抖处理</span></span><br><span class="line"><span class="keyword">let</span> tapTimer;</span><br><span class="line">element.<span class="title function_">addEventListener</span>(<span class="string">&#x27;touchstart&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  tapTimer = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 处理点击</span></span><br><span class="line">  &#125;, <span class="number">300</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">element.<span class="title function_">addEventListener</span>(<span class="string">&#x27;touchend&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">clearTimeout</span>(tapTimer);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><a id="8-性能监控与分析"></a></p><h2 id="8-性能监控与分析"><a href="#8-性能监控与分析" class="headerlink" title="8. 性能监控与分析"></a>8. 性能监控与分析</h2><h3 id="8-1-核心性能指标详解"><a href="#8-1-核心性能指标详解" class="headerlink" title="8.1 核心性能指标详解"></a>8.1 核心性能指标详解</h3><table><thead><tr><th>指标</th><th>全称</th><th>中文解释</th><th>优化建议</th><th>达标标准</th><th>测量方式</th></tr></thead><tbody><tr><td><strong>FCP</strong></td><td>First Contentful Paint</td><td>首次内容渲染时间</td><td>1. 优化服务器响应时间<br>2. 移除阻塞渲染的资源<br>3. 压缩CSS&#x2F;JS文件</td><td>&lt;1.8s</td><td><code>performance.getEntriesByName(&#39;first-contentful-paint&#39;)[0]</code></td></tr><tr><td><strong>LCP</strong></td><td>Largest Contentful Paint</td><td>最大内容渲染时间</td><td>1. 优化图片加载<br>2. 预加载关键资源<br>3. 使用CDN</td><td>&lt;2.5s</td><td>PerformanceObserver API</td></tr><tr><td><strong>CLS</strong></td><td>Cumulative Layout Shift</td><td>累计布局偏移</td><td>1. 设置图片尺寸<br>2. 预留广告位置<br>3. 使用transform动画</td><td>&lt;0.1</td><td>Layout Instability API</td></tr><tr><td><strong>TTI</strong></td><td>Time to Interactive</td><td>可交互时间</td><td>1. 减少JavaScript执行时间<br>2. 延迟加载非关键资源<br>3. 代码分割</td><td>&lt;3.9s</td><td>web-vitals库</td></tr><tr><td><strong>FID</strong></td><td>First Input Delay</td><td>首次输入延迟</td><td>1. 减少主线程阻塞<br>2. 使用Web Workers<br>3. 代码分割</td><td>&lt;100ms</td><td>PerformanceObserver API</td></tr><tr><td><strong>TBT</strong></td><td>Total Blocking Time</td><td>总阻塞时间</td><td>1. 优化长任务<br>2. 使用requestIdleCallback<br>3. 代码优化</td><td>&lt;300ms</td><td>Performance API</td></tr><tr><td><strong>FMP</strong></td><td>First Meaningful Paint</td><td>首次有效绘制</td><td>1. 服务端渲染<br>2. 预渲染<br>3. 骨架屏</td><td>&lt;2.0s</td><td>Chrome DevTools</td></tr></tbody></table><h3 id="8-2-全面性能监控实现"><a href="#8-2-全面性能监控实现" class="headerlink" title="8.2 全面性能监控实现"></a>8.2 全面性能监控实现</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 性能指标监控</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PerformanceMonitor</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">metrics</span> = &#123;&#125;;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">init</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// FCP和LCP监控</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">PerformanceObserver</span>(<span class="function">(<span class="params">entryList</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> entry <span class="keyword">of</span> entryList.<span class="title function_">getEntries</span>()) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">metrics</span>[entry.<span class="property">name</span>] = entry.<span class="property">startTime</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">sendToAnalytics</span>(&#123;</span><br><span class="line">          <span class="attr">metric</span>: entry.<span class="property">name</span>,</span><br><span class="line">          <span class="attr">value</span>: entry.<span class="property">startTime</span></span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).<span class="title function_">observe</span>(&#123; <span class="attr">entryTypes</span>: [<span class="string">&#x27;paint&#x27;</span>, <span class="string">&#x27;largest-contentful-paint&#x27;</span>] &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CLS监控</span></span><br><span class="line">    <span class="keyword">let</span> clsValue = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">PerformanceObserver</span>(<span class="function">(<span class="params">entryList</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> entry <span class="keyword">of</span> entryList.<span class="title function_">getEntries</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!entry.<span class="property">hadRecentInput</span>) &#123;</span><br><span class="line">          clsValue += entry.<span class="property">value</span>;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">CLS</span> = clsValue;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).<span class="title function_">observe</span>(&#123; <span class="attr">entryTypes</span>: [<span class="string">&#x27;layout-shift&#x27;</span>] &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 长任务监控</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">PerformanceObserver</span>(<span class="function">(<span class="params">entryList</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> entry <span class="keyword">of</span> entryList.<span class="title function_">getEntries</span>()) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">longTasks</span> = (<span class="variable language_">this</span>.<span class="property">metrics</span>.<span class="property">longTasks</span> || <span class="number">0</span>) + <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).<span class="title function_">observe</span>(&#123; <span class="attr">entryTypes</span>: [<span class="string">&#x27;longtask&#x27;</span>] &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 自定义性能标记</span></span><br><span class="line">  <span class="title function_">mark</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    performance.<span class="title function_">mark</span>(name);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 测量两个标记之间的时间</span></span><br><span class="line">  <span class="title function_">measure</span>(<span class="params">name, startMark, endMark</span>) &#123;</span><br><span class="line">    performance.<span class="title function_">measure</span>(name, startMark, endMark);</span><br><span class="line">    <span class="keyword">const</span> duration = performance.<span class="title function_">getEntriesByName</span>(name)[<span class="number">0</span>].<span class="property">duration</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">sendToAnalytics</span>(&#123;</span><br><span class="line">      <span class="attr">metric</span>: name,</span><br><span class="line">      <span class="attr">value</span>: duration</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 发送数据到分析服务</span></span><br><span class="line">  <span class="title function_">sendToAnalytics</span>(<span class="params">data</span>) &#123;</span><br><span class="line">    <span class="comment">// 实现数据上报逻辑</span></span><br><span class="line">    navigator.<span class="title function_">sendBeacon</span>(<span class="string">&#x27;/analytics&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 错误监控</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 错误上报</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;JavaScript Error:&#x27;</span>, event.<span class="property">error</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;unhandledrejection&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// Promise错误上报</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Unhandled Promise Rejection:&#x27;</span>, event.<span class="property">reason</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 资源加载监控</span></span><br><span class="line"><span class="keyword">const</span> resourceObserver = <span class="keyword">new</span> <span class="title class_">PerformanceObserver</span>(<span class="function">(<span class="params">list</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> entry <span class="keyword">of</span> list.<span class="title function_">getEntries</span>()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (entry.<span class="property">initiatorType</span> === <span class="string">&#x27;img&#x27;</span> || entry.<span class="property">initiatorType</span> === <span class="string">&#x27;script&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Resource <span class="subst">$&#123;entry.name&#125;</span> took <span class="subst">$&#123;entry.duration&#125;</span>ms to load`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">resourceObserver.<span class="title function_">observe</span>(&#123; <span class="attr">entryTypes</span>: [<span class="string">&#x27;resource&#x27;</span>] &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 网络状态监控</span></span><br><span class="line">navigator.<span class="property">connection</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;change&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> connection = navigator.<span class="property">connection</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Network type changed: <span class="subst">$&#123;connection.effectiveType&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><a id="9-进阶优化策略"></a></p><h2 id="9-进阶优化策略"><a href="#9-进阶优化策略" class="headerlink" title="9. 进阶优化策略"></a>9. 进阶优化策略</h2><h3 id="9-1-预渲染"><a href="#9-1-预渲染" class="headerlink" title="9.1 预渲染"></a>9.1 预渲染</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Next.js静态生成</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getStaticProps</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">fetchData</span>();</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">props</span>: &#123; data &#125; &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="9-2-边缘计算"><a href="#9-2-边缘计算" class="headerlink" title="9.2 边缘计算"></a>9.2 边缘计算</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cloudflare Workers示例</span></span><br><span class="line"><span class="title function_">addEventListener</span>(<span class="string">&#x27;fetch&#x27;</span>, <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">  event.<span class="title function_">respondWith</span>(<span class="title function_">handleRequest</span>(event.<span class="property">request</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">handleRequest</span>(<span class="params">request</span>) &#123;</span><br><span class="line">  <span class="comment">// 边缘节点处理逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a id="10-工具链推荐"></a></p><h2 id="10-工具链推荐"><a href="#10-工具链推荐" class="headerlink" title="10. 工具链推荐"></a>10. 工具链推荐</h2><h3 id="10-1-性能分析工具"><a href="#10-1-性能分析工具" class="headerlink" title="10.1 性能分析工具"></a>10.1 性能分析工具</h3><ul><li><strong>Lighthouse</strong>: 全面性能审计</li><li><strong>WebPageTest</strong>: 多地点测试</li><li><strong>Chrome DevTools</strong>: 性能面板</li></ul><h3 id="10-2-构建优化工具"><a href="#10-2-构建优化工具" class="headerlink" title="10.2 构建优化工具"></a>10.2 构建优化工具</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用Vite进行构建</span></span><br><span class="line">npm create vite@latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用Brotli压缩</span></span><br><span class="line">npm install compression-webpack-plugin --save-dev</span><br></pre></td></tr></table></figure><h2 id="最佳实践原则"><a href="#最佳实践原则" class="headerlink" title="最佳实践原则"></a>最佳实践原则</h2><ol><li><p><strong>性能预算制定</strong></p><ul><li>设置具体的性能指标目标</li><li>建立CI&#x2F;CD中的性能检查点</li><li>定期进行性能审计</li></ul></li><li><p><strong>监控与报警</strong></p><ul><li>实时监控关键性能指标</li><li>设置合理的报警阈值</li><li>建立性能劣化预警机制</li></ul></li><li><p><strong>优化策略分层</strong></p><ul><li>网络层：CDN、HTTP&#x2F;2、压缩</li><li>资源层：代码分割、图片优化</li><li>渲染层：CSS优化、DOM操作优化</li><li>运行时：JavaScript执行优化</li></ul></li><li><p><strong>持续优化流程</strong></p><ul><li>性能数据收集</li><li>问题分析定位</li><li>优化方案实施</li><li>效果评估复盘</li></ul></li></ol><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>⚠️ 性能优化需要数据支撑，避免主观臆断<br>⚠️ 优化措施要考虑投入产出比<br>⚠️ 保持代码可维护性，避免过度优化<br>⚠️ 优先解决对用户体验影响最大的问题<br>⚠️ 定期回顾和更新优化策略</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Web-性能优化完全指南&quot;&gt;&lt;a href=&quot;#Web-性能优化完全指南&quot; class=&quot;headerlink&quot; title=&quot;Web 性能优化完全指南&quot;&gt;&lt;/a&gt;Web 性能优化完全指南&lt;/h1&gt;&lt;h2 id=&quot;目录&quot;&gt;&lt;a href=&quot;#目录&quot; class=&quot;</summary>
      
    
    
    
    
    <category term="性能优化" scheme="https://aoayaoa.github.io/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>Qiankun 微前端的使用</title>
    <link href="https://aoayaoa.github.io/2024/04/08/qiankun/"/>
    <id>https://aoayaoa.github.io/2024/04/08/qiankun/</id>
    <published>2024-04-07T16:00:00.000Z</published>
    <updated>2025-03-07T03:59:53.389Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Qiankun-微前端企业级实践指南"><a href="#Qiankun-微前端企业级实践指南" class="headerlink" title="Qiankun 微前端企业级实践指南"></a>Qiankun 微前端企业级实践指南</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol><li><a href="#%E4%B8%80%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE">基础配置</a></li><li><a href="#%E4%BA%8C%E9%80%9A%E4%BF%A1%E6%96%B9%E6%A1%88">通信方案</a></li><li><a href="#%E4%B8%89%E8%B7%AF%E7%94%B1%E7%AE%A1%E7%90%86">路由管理</a></li><li><a href="#%E5%9B%9B%E6%A0%B7%E5%BC%8F%E9%9A%94%E7%A6%BB">样式隔离</a></li><li><a href="#%E4%BA%94%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">性能优化</a></li><li><a href="#%E5%85%AD%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">问题解决方案</a></li><li><a href="#%E4%B8%83%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">最佳实践</a></li><li><a href="#%E5%85%AB%E5%AD%90%E5%BA%94%E7%94%A8%E9%97%B4%E8%B7%B3%E8%BD%AC%E4%B8%8E%E4%BC%A0%E5%80%BC">子应用间跳转与传值</a></li><li><a href="#%E4%B9%9D%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">常见问题解决方案</a></li><li><a href="#%E5%8D%81%E6%80%BB%E7%BB%93%E4%B8%8E%E5%B1%95%E6%9C%9B">总结与展望</a></li><li><a href="#%E5%8D%81%E4%B8%80%E5%AD%90%E5%BA%94%E7%94%A8%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5">子应用优化策略</a></li></ol><p><a id="一基础配置"></a></p><h2 id="一、基础配置"><a href="#一、基础配置" class="headerlink" title="一、基础配置"></a>一、基础配置</h2><h3 id="1-1-主应用初始化"><a href="#1-1-主应用初始化" class="headerlink" title="1.1 主应用初始化"></a>1.1 主应用初始化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main-app.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; registerMicroApps, start &#125; <span class="keyword">from</span> <span class="string">&#x27;qiankun&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> apps = [</span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">name</span>: <span class="string">&#x27;sub-app&#x27;</span>,</span><br><span class="line"><span class="attr">entry</span>: process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;development&#x27;</span></span><br><span class="line">? <span class="string">&#x27;//localhost:7100&#x27;</span></span><br><span class="line">: <span class="string">&#x27;/sub-app/&#x27;</span>,</span><br><span class="line"><span class="attr">container</span>: <span class="string">&#x27;#subContainer&#x27;</span>,</span><br><span class="line"><span class="attr">activeRule</span>: <span class="string">&#x27;/sub&#x27;</span>,</span><br><span class="line"><span class="attr">props</span>: &#123;</span><br><span class="line"><span class="attr">basePath</span>: <span class="string">&#x27;/main-app/sub&#x27;</span>,</span><br><span class="line"><span class="attr">mainToken</span>: <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">];</span><br><span class="line"><span class="title function_">registerMicroApps</span>(apps);</span><br><span class="line"><span class="title function_">start</span>(&#123;</span><br><span class="line"><span class="attr">sandbox</span>: &#123;</span><br><span class="line"><span class="attr">strictStyleIsolation</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">experimentalStyleIsolation</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">speedy</span>: <span class="literal">false</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">prefetch</span>: <span class="string">&#x27;all&#x27;</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="1-2-子应用接入规范"><a href="#1-2-子应用接入规范" class="headerlink" title="1.2 子应用接入规范"></a>1.2 子应用接入规范</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sub-app.js</span></span><br><span class="line"><span class="keyword">let</span> vueInstance = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">bootstrap</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[SubApp] Bootstrap&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">mount</span>(<span class="params">props</span>) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[SubApp] Mount&#x27;</span>, props);</span><br><span class="line">vueInstance = <span class="title function_">createApp</span>(&#123;</span><br><span class="line"><span class="attr">router</span>: <span class="title function_">createRouter</span>(&#123;</span><br><span class="line"><span class="attr">history</span>: <span class="title function_">createWebHistory</span>(props.<span class="property">basePath</span>),</span><br><span class="line"><span class="attr">routes</span>: [</span><br><span class="line">&#123; <span class="attr">path</span>: <span class="string">&#x27;/page1&#x27;</span>, <span class="attr">component</span>: <span class="title class_">Page1</span> &#125;,</span><br><span class="line">&#123; <span class="attr">path</span>: <span class="string">&#x27;/page2&#x27;</span>, <span class="attr">component</span>: <span class="title class_">Page2</span> &#125;</span><br><span class="line">]</span><br><span class="line">&#125;)</span><br><span class="line">&#125;).<span class="title function_">mount</span>(props.<span class="property">container</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#app&#x27;</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">unmount</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[SubApp] Unmount&#x27;</span>);</span><br><span class="line">vueInstance.$destroy();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a id="二通信方案"></a></p><h2 id="二、通信方案"><a href="#二、通信方案" class="headerlink" title="二、通信方案"></a>二、通信方案</h2><h3 id="2-1-全局状态管理"><a href="#2-1-全局状态管理" class="headerlink" title="2.1 全局状态管理"></a>2.1 全局状态管理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主应用状态初始化</span></span><br><span class="line"><span class="keyword">const</span> actions = <span class="title function_">initGlobalState</span>(&#123;</span><br><span class="line"><span class="attr">user</span>: <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;user&#x27;</span>)),</span><br><span class="line"><span class="attr">token</span>: &#123;</span><br><span class="line"><span class="attr">value</span>: <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;token&#x27;</span>),</span><br><span class="line"><span class="attr">expire</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>() + <span class="number">3600000</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">systemTime</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 子应用状态同步</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">mount</span>(<span class="params">props</span>) &#123;</span><br><span class="line"><span class="comment">// 初始化同步</span></span><br><span class="line"><span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;token&#x27;</span>, props.<span class="title function_">getGlobalState</span>().<span class="property">token</span>.<span class="property">value</span>);</span><br><span class="line"><span class="comment">// 动态更新</span></span><br><span class="line">props.<span class="title function_">onGlobalStateChange</span>(<span class="function">(<span class="params">state, prev</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (state.<span class="property">token</span>.<span class="property">expire</span> !== prev.<span class="property">token</span>.<span class="property">expire</span>) &#123;</span><br><span class="line"><span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;token_expire&#x27;</span>, state.<span class="property">token</span>.<span class="property">expire</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-跨应用事件总线"><a href="#2-2-跨应用事件总线" class="headerlink" title="2.2 跨应用事件总线"></a>2.2 跨应用事件总线</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// event-bus.js</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CrossAppEvent</span> &#123;</span><br><span class="line"><span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">events</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">on</span>(<span class="params">eventName, callback</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> handlers = <span class="variable language_">this</span>.<span class="property">events</span>.<span class="title function_">get</span>(eventName) || [];</span><br><span class="line">handlers.<span class="title function_">push</span>(callback);</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">events</span>.<span class="title function_">set</span>(eventName, handlers);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">emit</span>(<span class="params">eventName, payload</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> handlers = <span class="variable language_">this</span>.<span class="property">events</span>.<span class="title function_">get</span>(eventName) || [];</span><br><span class="line">handlers.<span class="title function_">forEach</span>(<span class="function"><span class="params">handler</span> =&gt;</span> <span class="title function_">handler</span>(payload));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 主应用初始化</span></span><br><span class="line"><span class="keyword">const</span> eventBus = <span class="keyword">new</span> <span class="title class_">CrossAppEvent</span>();</span><br><span class="line"><span class="comment">// 子应用A发送事件</span></span><br><span class="line">eventBus.<span class="title function_">emit</span>(<span class="string">&#x27;ORDER_CREATED&#x27;</span>, &#123; <span class="attr">orderId</span>: <span class="number">12345</span> &#125;);</span><br><span class="line"><span class="comment">// 子应用B监听事件</span></span><br><span class="line">eventBus.<span class="title function_">on</span>(<span class="string">&#x27;ORDER_CREATED&#x27;</span>, <span class="function">(<span class="params">payload</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;收到订单创建事件:&#x27;</span>, payload);</span><br><span class="line"><span class="title function_">refreshOrderList</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><a id="三路由管理"></a></p><h2 id="三、路由管理"><a href="#三、路由管理" class="headerlink" title="三、路由管理"></a>三、路由管理</h2><h3 id="3-1-路由配置规范"><a href="#3-1-路由配置规范" class="headerlink" title="3.1 路由配置规范"></a>3.1 路由配置规范</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 子应用路由守卫</span></span><br><span class="line">router.<span class="title function_">beforeEach</span>(<span class="function">(<span class="params">to, <span class="keyword">from</span>, next</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">__POWERED_BY_QIANKUN__</span>) &#123;</span><br><span class="line"><span class="comment">// 验证路由合法性</span></span><br><span class="line"><span class="keyword">const</span> validPaths = [<span class="string">&#x27;/page1&#x27;</span>, <span class="string">&#x27;/page2&#x27;</span>, <span class="string">&#x27;/detail&#x27;</span>];</span><br><span class="line"><span class="keyword">const</span> isValid = validPaths.<span class="title function_">some</span>(<span class="function"><span class="params">path</span> =&gt;</span> to.<span class="property">path</span>.<span class="title function_">startsWith</span>(path));</span><br><span class="line"><span class="comment">// 验证Token有效性</span></span><br><span class="line"><span class="keyword">const</span> isAuthenticated = <span class="title function_">checkToken</span>(<span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;token&#x27;</span>));</span><br><span class="line"><span class="keyword">if</span> (!isValid || !isAuthenticated) &#123;</span><br><span class="line"><span class="title function_">next</span>(<span class="string">&#x27;/error&#x27;</span>);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">next</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 主应用路由跳转封装</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">microAppNavigate</span> = (<span class="params">appName, path</span>) =&gt; &#123;</span><br><span class="line"><span class="keyword">const</span> appConfig = qiankunApps.<span class="title function_">find</span>(<span class="function"><span class="params">app</span> =&gt;</span> app.<span class="property">name</span> === appName);</span><br><span class="line"><span class="keyword">if</span> (appConfig) &#123;</span><br><span class="line">router.<span class="title function_">push</span>(<span class="string">`<span class="subst">$&#123;appConfig.activeRule&#125;</span><span class="subst">$&#123;path&#125;</span>`</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`未找到应用 <span class="subst">$&#123;appName&#125;</span> 的配置`</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="title function_">microAppNavigate</span>(<span class="string">&#x27;sub-app&#x27;</span>, <span class="string">&#x27;/page1&#x27;</span>);</span><br></pre></td></tr></table></figure><p><a id="四样式隔离"></a></p><h2 id="四、样式隔离"><a href="#四、样式隔离" class="headerlink" title="四、样式隔离"></a>四、样式隔离</h2><h3 id="4-1-组件库解决方案"><a href="#4-1-组件库解决方案" class="headerlink" title="4.1 组件库解决方案"></a>4.1 组件库解决方案</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- Element UI 组件 --&gt;</span><br><span class="line">&lt;el-date-picker</span><br><span class="line">:popper-append-to-body=&quot;false&quot;</span><br><span class="line">popper-class=&quot;micro-app-picker&quot;</span><br><span class="line">/&gt;</span><br><span class="line">&lt;!-- Ant Design 组件 --&gt;</span><br><span class="line">&lt;a-select</span><br><span class="line">:getPopupContainer=&quot;trigger =&gt; trigger.parentElement&quot;</span><br><span class="line">popupClassName=&quot;micro-app-select&quot;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure><h3 id="4-2-全局样式策略"><a href="#4-2-全局样式策略" class="headerlink" title="4.2 全局样式策略"></a>4.2 全局样式策略</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 微应用容器样式隔离 */</span></span><br><span class="line"><span class="selector-id">#sub-container</span> &#123;</span><br><span class="line"><span class="attribute">all</span>: initial; <span class="comment">/* 重置继承样式 */</span></span><br><span class="line"><span class="comment">/* 限制样式作用域 */</span></span><br><span class="line">* &#123;</span><br><span class="line"><span class="attribute">box-sizing</span>: border-box;</span><br><span class="line"><span class="attribute">font-family</span>: inherit;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 弹出层样式重置 */</span></span><br><span class="line"><span class="selector-class">.micro-app-picker</span> &#123;</span><br><span class="line"><span class="attribute">z-index</span>: <span class="number">1000</span> <span class="meta">!important</span>;</span><br><span class="line"><span class="attribute">position</span>: absolute <span class="meta">!important</span>;</span><br><span class="line"><span class="selector-class">.el-picker__popper</span> &#123;</span><br><span class="line"><span class="attribute">transform</span>: none <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a id="五性能优化"></a></p><h2 id="五、性能优化"><a href="#五、性能优化" class="headerlink" title="五、性能优化"></a>五、性能优化</h2><h3 id="5-1-资源加载策略"><a href="#5-1-资源加载策略" class="headerlink" title="5.1 资源加载策略"></a>5.1 资源加载策略</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 按需加载配置</span></span><br><span class="line"><span class="title function_">start</span>(&#123;</span><br><span class="line"><span class="attr">prefetch</span>: <span class="function">(<span class="params">apps</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">const</span> hotApps = [<span class="string">&#x27;dashboard&#x27;</span>, <span class="string">&#x27;monitor&#x27;</span>];</span><br><span class="line"><span class="keyword">return</span> apps.<span class="title function_">filter</span>(<span class="function"><span class="params">app</span> =&gt;</span> hotApps.<span class="title function_">includes</span>(app.<span class="property">name</span>));</span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">sandbox</span>: &#123;</span><br><span class="line"><span class="attr">experimentalStyleIsolation</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="5-2-内存优化方案"><a href="#5-2-内存优化方案" class="headerlink" title="5.2 内存优化方案"></a>5.2 内存优化方案</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 子应用卸载处理</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">unmount</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="comment">// 清理事件监听</span></span><br><span class="line">eventBus.<span class="title function_">offAll</span>();</span><br><span class="line"><span class="comment">// 释放内存</span></span><br><span class="line">vueInstance.$destroy();</span><br><span class="line">vueInstance = <span class="literal">null</span>;</span><br><span class="line"><span class="comment">// 清理全局状态</span></span><br><span class="line">actions.<span class="title function_">offGlobalStateChange</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a id="六问题解决方案"></a></p><h2 id="六、问题解决方案"><a href="#六、问题解决方案" class="headerlink" title="六、问题解决方案"></a>六、问题解决方案</h2><h3 id="6-1-常见问题速查表"><a href="#6-1-常见问题速查表" class="headerlink" title="6.1 常见问题速查表"></a>6.1 常见问题速查表</h3><table><thead><tr><th>问题现象</th><th>解决方案</th><th>相关文件</th></tr></thead><tbody><tr><td>样式污染</td><td>严格样式隔离 + 组件级配置</td><td><code>src/styles/global.css</code></td></tr><tr><td>路由跳转失效</td><td>动态basePath + 路由守卫增强</td><td><code>src/router/index.js</code></td></tr><tr><td>Token不同步</td><td>全局状态管理 + 定时刷新</td><td><code>src/utils/auth.js</code></td></tr><tr><td>内存泄漏</td><td>严格卸载处理 + 内存分析工具</td><td><code>src/main.js</code></td></tr></tbody></table><h3 id="6-2-错误监控方案"><a href="#6-2-错误监控方案" class="headerlink" title="6.2 错误监控方案"></a>6.2 错误监控方案</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 全局错误处理</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="title function_">trackError</span>(&#123;</span><br><span class="line"><span class="attr">type</span>: <span class="string">&#x27;RUNTIME_ERROR&#x27;</span>,</span><br><span class="line"><span class="attr">message</span>: event.<span class="property">message</span>,</span><br><span class="line"><span class="attr">stack</span>: event.<span class="property">error</span>.<span class="property">stack</span>,</span><br><span class="line"><span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Qiankun错误捕获</span></span><br><span class="line"><span class="title function_">start</span>(&#123;</span><br><span class="line"><span class="attr">onError</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;微应用加载失败:&#x27;</span>, err);</span><br><span class="line"><span class="title function_">showErrorNotification</span>(&#123;</span><br><span class="line"><span class="attr">title</span>: <span class="string">&#x27;系统加载失败&#x27;</span>,</span><br><span class="line"><span class="attr">content</span>: <span class="string">&#x27;请检查网络连接后重试&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><a id="七最佳实践"></a></p><h2 id="七、最佳实践"><a href="#七、最佳实践" class="headerlink" title="七、最佳实践"></a>七、最佳实践</h2><h3 id="7-1-架构规范"><a href="#7-1-架构规范" class="headerlink" title="7.1 架构规范"></a>7.1 架构规范</h3><pre><code class="highlight mermaid">graph TDA[主应用] --&gt; B(用户中心)A --&gt; C(订单系统)A --&gt; D(监控平台)B --&gt; E(权限管理)C --&gt; F(支付模块)D --&gt; G(日志分析)F --&gt; H(第三方支付)G --&gt; I(数据分析)</code></pre><h3 id="7-2-性能指标"><a href="#7-2-性能指标" class="headerlink" title="7.2 性能指标"></a>7.2 性能指标</h3><table><thead><tr><th>指标</th><th>标准值</th><th>监控工具</th><th>报警阈值</th></tr></thead><tbody><tr><td>加载时间</td><td>&lt;1.5s</td><td>Lighthouse</td><td>&gt;3s</td></tr><tr><td>内存占用</td><td>&lt;200MB</td><td>Chrome DevTools</td><td>&gt;300MB</td></tr><tr><td>FCP</td><td>&lt;1.2s</td><td>Web Vitals</td><td>&gt;2s</td></tr><tr><td>API成功率</td><td>&gt;99.9%</td><td>Prometheus</td><td>&lt;99%</td></tr></tbody></table><h3 id="7-3-未来演进"><a href="#7-3-未来演进" class="headerlink" title="7.3 未来演进"></a>7.3 未来演进</h3><ol><li><strong>动态模块加载</strong></li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 动态加载示例</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">loadModule</span> = <span class="keyword">async</span> (<span class="params">moduleName</span>) =&gt; &#123;</span><br><span class="line"><span class="keyword">const</span> &#123; bootstrap, mount, unmount &#125; = <span class="keyword">await</span> <span class="keyword">import</span>(<span class="string">`./modules/<span class="subst">$&#123;moduleName&#125;</span>`</span>);</span><br><span class="line"><span class="keyword">return</span> &#123; bootstrap, mount, unmount &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title function_">registerMicroApps</span>([</span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">name</span>: <span class="string">&#x27;dynamic-module&#x27;</span>,</span><br><span class="line"><span class="attr">entry</span>: <span class="function">() =&gt;</span> <span class="title function_">loadModule</span>(<span class="string">&#x27;analytics&#x27;</span>),</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line">]);</span><br></pre></td></tr></table></figure><ol start="2"><li><strong>微前端DevTools</strong></li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开发工具集成</span></span><br><span class="line"><span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;development&#x27;</span>) &#123;</span><br><span class="line"><span class="keyword">import</span>(<span class="string">&#x27;qiankun-devtools&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; init &#125;</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="title function_">init</span>(&#123;</span><br><span class="line"><span class="attr">traceDeps</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">logComm</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">perfMonitor</span>: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a id="八子应用间跳转与传值"></a></p><h2 id="八、子应用间跳转与传值"><a href="#八、子应用间跳转与传值" class="headerlink" title="八、子应用间跳转与传值"></a>八、子应用间跳转与传值</h2><h3 id="8-1-子应用间跳转方案"><a href="#8-1-子应用间跳转方案" class="headerlink" title="8.1 子应用间跳转方案"></a>8.1 子应用间跳转方案</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主应用中定义统一跳转服务</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AppNavigationService</span> &#123;</span><br><span class="line"><span class="title function_">constructor</span>(<span class="params">apps, router</span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">apps</span> = apps;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">router</span> = router;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 跳转到指定应用的指定路径</span></span><br><span class="line"><span class="title function_">navigateTo</span>(<span class="params">appName, path, query = &#123;&#125;</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> app = <span class="variable language_">this</span>.<span class="property">apps</span>.<span class="title function_">find</span>(<span class="function"><span class="params">a</span> =&gt;</span> a.<span class="property">name</span> === appName);</span><br><span class="line"><span class="keyword">if</span> (!app) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`应用 <span class="subst">$&#123;appName&#125;</span> 不存在`</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构建完整路径</span></span><br><span class="line"><span class="keyword">const</span> queryString = <span class="title class_">Object</span>.<span class="title function_">keys</span>(query).<span class="property">length</span></span><br><span class="line">? <span class="string">`?<span class="subst">$&#123;<span class="keyword">new</span> URLSearchParams(query)&#125;</span>`</span></span><br><span class="line">: <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> fullPath = <span class="string">`<span class="subst">$&#123;app.activeRule&#125;</span><span class="subst">$&#123;path&#125;</span><span class="subst">$&#123;queryString&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">router</span>.<span class="title function_">push</span>(fullPath);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实例化导航服务</span></span><br><span class="line"><span class="keyword">const</span> navigationService = <span class="keyword">new</span> <span class="title class_">AppNavigationService</span>(apps, router);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子应用中注入导航服务</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">mount</span>(<span class="params">props</span>) &#123;</span><br><span class="line">props.<span class="property">navigationService</span> = navigationService;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子应用中使用</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">jumpToAnotherApp</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">props.<span class="property">navigationService</span>.<span class="title function_">navigateTo</span>(<span class="string">&#x27;another-app&#x27;</span>, <span class="string">&#x27;/dashboard&#x27;</span>, &#123; <span class="attr">id</span>: <span class="number">123</span> &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="8-2-子应用间数据传递"><a href="#8-2-子应用间数据传递" class="headerlink" title="8.2 子应用间数据传递"></a>8.2 子应用间数据传递</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方案一：通过全局状态</span></span><br><span class="line"><span class="comment">// 子应用A中设置数据</span></span><br><span class="line">props.<span class="title function_">setGlobalState</span>(&#123;</span><br><span class="line"><span class="attr">transferData</span>: &#123;</span><br><span class="line"><span class="attr">type</span>: <span class="string">&#x27;ORDER_DATA&#x27;</span>,</span><br><span class="line"><span class="attr">payload</span>: &#123; <span class="attr">orderId</span>: <span class="number">12345</span> &#125;,</span><br><span class="line"><span class="attr">targetApp</span>: <span class="string">&#x27;another-app&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子应用B中接收数据</span></span><br><span class="line">props.<span class="title function_">onGlobalStateChange</span>(<span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (state.<span class="property">transferData</span> &amp;&amp; state.<span class="property">transferData</span>.<span class="property">targetApp</span> === <span class="string">&#x27;another-app&#x27;</span>) &#123;</span><br><span class="line"><span class="title function_">handleReceivedData</span>(state.<span class="property">transferData</span>.<span class="property">payload</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方案二：通过URL参数</span></span><br><span class="line"><span class="comment">// 子应用A跳转时携带数据</span></span><br><span class="line">props.<span class="property">navigationService</span>.<span class="title function_">navigateTo</span>(<span class="string">&#x27;another-app&#x27;</span>, <span class="string">&#x27;/detail&#x27;</span>, &#123;</span><br><span class="line"><span class="attr">orderId</span>: <span class="number">12345</span>,</span><br><span class="line"><span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子应用B接收URL参数</span></span><br><span class="line"><span class="keyword">const</span> route = <span class="title function_">useRoute</span>();</span><br><span class="line"><span class="keyword">const</span> orderId = route.<span class="property">query</span>.<span class="property">orderId</span>;</span><br></pre></td></tr></table></figure><h3 id="8-3-数据持久化策略"><a href="#8-3-数据持久化策略" class="headerlink" title="8.3 数据持久化策略"></a>8.3 数据持久化策略</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用localStorage与sessionStorage</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">saveAppState</span> = (<span class="params">appName, state</span>) =&gt; &#123;</span><br><span class="line"><span class="keyword">const</span> key = <span class="string">`MICRO_APP_<span class="subst">$&#123;appName&#125;</span>_STATE`</span>;</span><br><span class="line"><span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(key, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line"><span class="attr">data</span>: state,</span><br><span class="line"><span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">&#125;));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getAppState</span> = (<span class="params">appName</span>) =&gt; &#123;</span><br><span class="line"><span class="keyword">const</span> key = <span class="string">`MICRO_APP_<span class="subst">$&#123;appName&#125;</span>_STATE`</span>;</span><br><span class="line"><span class="keyword">const</span> stateStr = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(key);</span><br><span class="line"><span class="keyword">if</span> (!stateStr) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">const</span> state = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(stateStr);</span><br><span class="line"><span class="comment">// 检查数据是否过期（30分钟）</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title class_">Date</span>.<span class="title function_">now</span>() - state.<span class="property">timestamp</span> &gt; <span class="number">30</span> * <span class="number">60</span> * <span class="number">1000</span>) &#123;</span><br><span class="line"><span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(key);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> state.<span class="property">data</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><a id="九常见问题解决方案"></a></p><h2 id="九、常见问题解决方案"><a href="#九、常见问题解决方案" class="headerlink" title="九、常见问题解决方案"></a>九、常见问题解决方案</h2><h3 id="9-1-子应用加载主应用路由的问题"><a href="#9-1-子应用加载主应用路由的问题" class="headerlink" title="9.1 子应用加载主应用路由的问题"></a>9.1 子应用加载主应用路由的问题</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 问题：子应用错误加载了主应用的路由组件</span></span><br><span class="line"><span class="comment">// 原因：路由前缀配置不正确，导致路径匹配混乱</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 解决方案一：严格的路由守卫</span></span><br><span class="line">router.<span class="title function_">beforeEach</span>(<span class="function">(<span class="params">to, <span class="keyword">from</span>, next</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// 检测是否在qiankun环境中</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">__POWERED_BY_QIANKUN__</span>) &#123;</span><br><span class="line"><span class="comment">// 检测当前路径是否合法</span></span><br><span class="line"><span class="keyword">const</span> appPrefix = <span class="string">&#x27;/sub-app&#x27;</span>; <span class="comment">// 子应用路径前缀</span></span><br><span class="line"><span class="keyword">if</span> (!to.<span class="property">path</span>.<span class="title function_">startsWith</span>(appPrefix)) &#123;</span><br><span class="line"><span class="comment">// 路径不合法，重定向到子应用首页</span></span><br><span class="line"><span class="title function_">next</span>(<span class="string">`<span class="subst">$&#123;appPrefix&#125;</span>/home`</span>);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">next</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解决方案二：修正路由base配置</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line"><span class="attr">history</span>: <span class="title function_">createWebHistory</span>(</span><br><span class="line"><span class="variable language_">window</span>.<span class="property">__POWERED_BY_QIANKUN__</span></span><br><span class="line">? <span class="variable language_">window</span>.<span class="property">__INJECTED_PUBLIC_PATH_BY_QIANKUN__</span> <span class="comment">// 使用qiankun注入的路径</span></span><br><span class="line">: <span class="string">&#x27;/&#x27;</span></span><br><span class="line">),</span><br><span class="line"><span class="attr">routes</span>: [...]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="9-2-Token时间不统一问题"><a href="#9-2-Token时间不统一问题" class="headerlink" title="9.2 Token时间不统一问题"></a>9.2 Token时间不统一问题</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 问题：多个子应用的token过期时间不一致</span></span><br><span class="line"><span class="comment">// 解决方案：主应用维护统一的token刷新机制</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 主应用中定义token管理服务</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TokenService</span> &#123;</span><br><span class="line"><span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">tokenInfo</span> = &#123;</span><br><span class="line"><span class="attr">value</span>: <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;token&#x27;</span>),</span><br><span class="line"><span class="attr">expire</span>: <span class="built_in">parseInt</span>(<span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;token_expire&#x27;</span>) || <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定时检查token是否即将过期</span></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">checkTokenExpiration</span>(), <span class="number">60000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查token是否过期</span></span><br><span class="line"><span class="title function_">checkTokenExpiration</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> now = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line"><span class="keyword">const</span> timeToExpire = <span class="variable language_">this</span>.<span class="property">tokenInfo</span>.<span class="property">expire</span> - now;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果token将在15分钟内过期，刷新token</span></span><br><span class="line"><span class="keyword">if</span> (timeToExpire &gt; <span class="number">0</span> &amp;&amp; timeToExpire &lt; <span class="number">15</span> * <span class="number">60</span> * <span class="number">1000</span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">refreshToken</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 刷新token</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">refreshToken</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;/api/refresh-token&#x27;</span>, &#123;</span><br><span class="line"><span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line"><span class="attr">headers</span>: &#123;</span><br><span class="line"><span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Authorization&#x27;</span>: <span class="string">`Bearer <span class="subst">$&#123;<span class="variable language_">this</span>.tokenInfo.value&#125;</span>`</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line"><span class="keyword">if</span> (data.<span class="property">success</span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">updateToken</span>(data.<span class="property">token</span>, data.<span class="property">expire</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;刷新token失败:&#x27;</span>, error);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新token</span></span><br><span class="line"><span class="title function_">updateToken</span>(<span class="params">token, expire</span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">tokenInfo</span> = &#123; <span class="attr">value</span>: token, expire &#125;;</span><br><span class="line"><span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;token&#x27;</span>, token);</span><br><span class="line"><span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;token_expire&#x27;</span>, expire.<span class="title function_">toString</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通知所有应用token已更新</span></span><br><span class="line">actions.<span class="title function_">setGlobalState</span>(&#123;</span><br><span class="line"><span class="attr">tokenUpdated</span>: &#123;</span><br><span class="line"><span class="attr">value</span>: token,</span><br><span class="line"><span class="attr">expire</span>: expire,</span><br><span class="line"><span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化token服务</span></span><br><span class="line"><span class="keyword">const</span> tokenService = <span class="keyword">new</span> <span class="title class_">TokenService</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子应用中监听token更新</span></span><br><span class="line">props.<span class="title function_">onGlobalStateChange</span>(<span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (state.<span class="property">tokenUpdated</span> &amp;&amp; state.<span class="property">tokenUpdated</span>.<span class="property">timestamp</span>) &#123;</span><br><span class="line"><span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;token&#x27;</span>, state.<span class="property">tokenUpdated</span>.<span class="property">value</span>);</span><br><span class="line"><span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;token_expire&#x27;</span>, state.<span class="property">tokenUpdated</span>.<span class="property">expire</span>.<span class="title function_">toString</span>());</span><br><span class="line">&#125;</span><br><span class="line">&#125;, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure><p><a id="十总结与展望"></a></p><h2 id="十、总结与展望"><a href="#十、总结与展望" class="headerlink" title="十、总结与展望"></a>十、总结与展望</h2><h3 id="10-1-Qiankun技术优势"><a href="#10-1-Qiankun技术优势" class="headerlink" title="10.1 Qiankun技术优势"></a>10.1 Qiankun技术优势</h3><ol><li><strong>技术栈无关</strong> - 支持不同前端框架混合使用</li><li><strong>独立开发部署</strong> - 子应用可独立维护迭代</li><li><strong>沙箱隔离</strong> - 确保应用间不会互相干扰</li><li><strong>资源预加载</strong> - 提升多应用加载性能</li></ol><h3 id="10-2-架构最佳实践"><a href="#10-2-架构最佳实践" class="headerlink" title="10.2 架构最佳实践"></a>10.2 架构最佳实践</h3><ol><li><strong>标准化路由配置</strong> - 统一应用间路由规则</li><li><strong>统一认证授权</strong> - 一处登录，处处生效</li><li><strong>性能优先策略</strong> - 按需加载、预加载结合</li><li><strong>完善的监控体系</strong> - 及时发现并解决问题</li></ol><h3 id="10-3-未来发展方向"><a href="#10-3-未来发展方向" class="headerlink" title="10.3 未来发展方向"></a>10.3 未来发展方向</h3><ol><li><strong>微模块化</strong> - 进一步细化应用颗粒度</li><li><strong>AI辅助加载</strong> - 基于用户行为智能预测需要加载的应用</li><li><strong>更强大的隔离</strong> - 隔离更彻底的同时保持更高效的性能</li></ol><p><a id="十一子应用优化策略"></a></p><h2 id="十一、子应用优化策略（增强版）"><a href="#十一、子应用优化策略（增强版）" class="headerlink" title="十一、子应用优化策略（增强版）"></a>十一、子应用优化策略（增强版）</h2><h3 id="11-1-智能预加载策略"><a href="#11-1-智能预加载策略" class="headerlink" title="11.1 智能预加载策略"></a>11.1 智能预加载策略</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主应用智能预加载控制器</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PreloadController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">usageStats</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">observer</span> = <span class="keyword">new</span> <span class="title class_">IntersectionObserver</span>(<span class="variable language_">this</span>.<span class="property">handleIntersection</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 记录应用使用频率</span></span><br><span class="line">  <span class="title function_">trackAppUsage</span>(<span class="params">appName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> count = <span class="variable language_">this</span>.<span class="property">usageStats</span>.<span class="title function_">get</span>(appName) || <span class="number">0</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">usageStats</span>.<span class="title function_">set</span>(appName, count + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 基于可视区域预加载</span></span><br><span class="line">  <span class="title function_">handleIntersection</span>(<span class="params">entries</span>) &#123;</span><br><span class="line">    entries.<span class="title function_">forEach</span>(<span class="function"><span class="params">entry</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (entry.<span class="property">isIntersecting</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> appName = entry.<span class="property">target</span>.<span class="property">dataset</span>.<span class="property">appName</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">preloadApp</span>(appName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 智能预加载算法</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">preloadApp</span>(<span class="params">appName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> appConfig = qiankunApps.<span class="title function_">find</span>(<span class="function"><span class="params">app</span> =&gt;</span> app.<span class="property">name</span> === appName);</span><br><span class="line">    <span class="keyword">if</span> (!appConfig || appConfig.<span class="property">preloaded</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据使用频率决定预加载优先级</span></span><br><span class="line">    <span class="keyword">const</span> priority = <span class="variable language_">this</span>.<span class="property">usageStats</span>.<span class="title function_">get</span>(appName) &gt; <span class="number">5</span> ? <span class="string">&#x27;high&#x27;</span> : <span class="string">&#x27;low&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 requestIdleCallback 优化性能</span></span><br><span class="line">    <span class="keyword">if</span> (priority === <span class="string">&#x27;high&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">loadMicroApp</span>(appConfig);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">requestIdleCallback</span>(<span class="function">() =&gt;</span> <span class="title function_">loadMicroApp</span>(appConfig));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    appConfig.<span class="property">preloaded</span> = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 注册可观察元素</span></span><br><span class="line">  <span class="title function_">registerTrigger</span>(<span class="params">element</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">observer</span>.<span class="title function_">observe</span>(element);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> preloader = <span class="keyword">new</span> <span class="title class_">PreloadController</span>();</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;[data-app-trigger]&#x27;</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">el</span> =&gt;</span> &#123;</span><br><span class="line">  preloader.<span class="title function_">registerTrigger</span>(el);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="11-2-高级加载状态管理（支持SLA监控）"><a href="#11-2-高级加载状态管理（支持SLA监控）" class="headerlink" title="11.2 高级加载状态管理（支持SLA监控）"></a>11.2 高级加载状态管理（支持SLA监控）</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 增强版加载状态管理器</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AdvancedLoadingManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">states</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">slaThresholds</span> = &#123;</span><br><span class="line">      <span class="attr">loadTime</span>: <span class="number">3000</span>,  <span class="comment">// 3秒加载阈值</span></span><br><span class="line">      <span class="attr">successRate</span>: <span class="number">0.95</span> <span class="comment">// 95%成功率</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 记录加载指标</span></span><br><span class="line">  <span class="title function_">recordMetric</span>(<span class="params">appName, metric</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> appState = <span class="variable language_">this</span>.<span class="property">states</span>.<span class="title function_">get</span>(appName) || &#123;</span><br><span class="line">      <span class="attr">loadCount</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">successCount</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">totalLoadTime</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">errors</span>: []</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    appState.<span class="property">loadCount</span>++;</span><br><span class="line">    appState.<span class="property">totalLoadTime</span> += metric.<span class="property">duration</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (metric.<span class="property">success</span>) &#123;</span><br><span class="line">      appState.<span class="property">successCount</span>++;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      appState.<span class="property">errors</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">        <span class="attr">error</span>: metric.<span class="property">error</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">states</span>.<span class="title function_">set</span>(appName, appState);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">checkSLA</span>(appName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 检查SLA合规性</span></span><br><span class="line">  <span class="title function_">checkSLA</span>(<span class="params">appName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> state = <span class="variable language_">this</span>.<span class="property">states</span>.<span class="title function_">get</span>(appName);</span><br><span class="line">    <span class="keyword">const</span> avgLoadTime = state.<span class="property">totalLoadTime</span> / state.<span class="property">loadCount</span>;</span><br><span class="line">    <span class="keyword">const</span> successRate = state.<span class="property">successCount</span> / state.<span class="property">loadCount</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (avgLoadTime &gt; <span class="variable language_">this</span>.<span class="property">slaThresholds</span>.<span class="property">loadTime</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`[SLA告警] <span class="subst">$&#123;appName&#125;</span> 平均加载时间 <span class="subst">$&#123;avgLoadTime&#125;</span>ms`</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (successRate &lt; <span class="variable language_">this</span>.<span class="property">slaThresholds</span>.<span class="property">successRate</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`[SLA违规] <span class="subst">$&#123;appName&#125;</span> 成功率 <span class="subst">$&#123;successRate * <span class="number">100</span>&#125;</span>%`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 生成性能报告</span></span><br><span class="line">  <span class="title function_">generateReport</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="variable language_">this</span>.<span class="property">states</span>.<span class="title function_">entries</span>()).<span class="title function_">map</span>(<span class="function">(<span class="params">[name, state]</span>) =&gt;</span> (&#123;</span><br><span class="line">      <span class="attr">app</span>: name,</span><br><span class="line">      <span class="attr">avgLoadTime</span>: state.<span class="property">totalLoadTime</span> / state.<span class="property">loadCount</span>,</span><br><span class="line">      <span class="attr">successRate</span>: state.<span class="property">successCount</span> / state.<span class="property">loadCount</span>,</span><br><span class="line">      <span class="attr">errorCount</span>: state.<span class="property">errors</span>.<span class="property">length</span></span><br><span class="line">    &#125;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 集成到微应用配置</span></span><br><span class="line"><span class="keyword">const</span> loadingManager = <span class="keyword">new</span> <span class="title class_">AdvancedLoadingManager</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_">registerMicroApps</span>(apps.<span class="title function_">map</span>(<span class="function"><span class="params">app</span> =&gt;</span> (&#123;</span><br><span class="line">  ...app,</span><br><span class="line">  <span class="title function_">loader</span>(<span class="params">loading</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> startTime = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">    <span class="keyword">let</span> metric = &#123; <span class="attr">duration</span>: <span class="number">0</span>, <span class="attr">success</span>: <span class="literal">false</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!loading) &#123;</span><br><span class="line">      metric.<span class="property">duration</span> = <span class="title class_">Date</span>.<span class="title function_">now</span>() - startTime;</span><br><span class="line">      metric.<span class="property">success</span> = <span class="literal">true</span>;</span><br><span class="line">      loadingManager.<span class="title function_">recordMetric</span>(app.<span class="property">name</span>, metric);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="title function_">errorHandler</span> = (<span class="params">err</span>) =&gt; &#123;</span><br><span class="line">        metric.<span class="property">duration</span> = <span class="title class_">Date</span>.<span class="title function_">now</span>() - startTime;</span><br><span class="line">        metric.<span class="property">error</span> = err;</span><br><span class="line">        loadingManager.<span class="title function_">recordMetric</span>(app.<span class="property">name</span>, metric);</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;error&#x27;</span>, errorHandler);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)));</span><br></pre></td></tr></table></figure><h3 id="11-3-动态资源调配（根据网络状况）"><a href="#11-3-动态资源调配（根据网络状况）" class="headerlink" title="11.3 动态资源调配（根据网络状况）"></a>11.3 动态资源调配（根据网络状况）</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 网络感知型资源加载</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NetworkAwareLoader</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">connection</span> = navigator.<span class="property">connection</span> || &#123;</span><br><span class="line">      <span class="attr">effectiveType</span>: <span class="string">&#x27;4g&#x27;</span>,</span><br><span class="line">      <span class="attr">saveData</span>: <span class="literal">false</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">presets</span> = &#123;</span><br><span class="line">      <span class="string">&#x27;4g&#x27;</span>: &#123; <span class="attr">prefetch</span>: <span class="string">&#x27;all&#x27;</span>, <span class="attr">sandbox</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      <span class="string">&#x27;3g&#x27;</span>: &#123; <span class="attr">prefetch</span>: <span class="string">&#x27;current&#x27;</span>, <span class="attr">sandbox</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">      <span class="string">&#x27;2g&#x27;</span>: &#123; <span class="attr">prefetch</span>: <span class="string">&#x27;none&#x27;</span>, <span class="attr">sandbox</span>: <span class="literal">false</span> &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化加载策略</span></span><br><span class="line">  <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">updateStrategy</span>();</span><br><span class="line">    navigator.<span class="property">connection</span>?.<span class="title function_">addEventListener</span>(<span class="string">&#x27;change&#x27;</span>, <span class="variable language_">this</span>.<span class="property">updateStrategy</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新加载策略</span></span><br><span class="line">  updateStrategy = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; effectiveType, saveData &#125; = <span class="variable language_">this</span>.<span class="property">connection</span>;</span><br><span class="line">    <span class="keyword">const</span> strategy = saveData ? <span class="variable language_">this</span>.<span class="property">presets</span>[<span class="string">&#x27;2g&#x27;</span>] : <span class="variable language_">this</span>.<span class="property">presets</span>[effectiveType];</span><br><span class="line"></span><br><span class="line">    <span class="title function_">start</span>(&#123;</span><br><span class="line">      <span class="attr">prefetch</span>: strategy.<span class="property">prefetch</span>,</span><br><span class="line">      <span class="attr">sandbox</span>: &#123;</span><br><span class="line">        <span class="attr">strictStyleIsolation</span>: strategy.<span class="property">sandbox</span>,</span><br><span class="line">        <span class="attr">experimentalStyleIsolation</span>: strategy.<span class="property">sandbox</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 动态调整资源质量</span></span><br><span class="line">  <span class="title function_">adjustResourceQuality</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> imgQuality = <span class="variable language_">this</span>.<span class="property">connection</span>.<span class="property">saveData</span> ? <span class="string">&#x27;low&#x27;</span> : <span class="string">&#x27;high&#x27;</span>;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="property">style</span>.<span class="title function_">setProperty</span>(</span><br><span class="line">      <span class="string">&#x27;--image-quality&#x27;</span>,</span><br><span class="line">      <span class="string">`url(?quality=<span class="subst">$&#123;imgQuality&#125;</span>)`</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> networkLoader = <span class="keyword">new</span> <span class="title class_">NetworkAwareLoader</span>();</span><br><span class="line">networkLoader.<span class="title function_">init</span>();</span><br></pre></td></tr></table></figure><h3 id="11-4-安全增强策略"><a href="#11-4-安全增强策略" class="headerlink" title="11.4 安全增强策略"></a>11.4 安全增强策略</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 子应用安全沙箱增强</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">createSecureSandbox</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="variable language_">window</span>, &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">target, prop</span>) &#123;</span><br><span class="line">      <span class="comment">// 拦截危险API</span></span><br><span class="line">      <span class="keyword">if</span> ([<span class="string">&#x27;localStorage&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;Function&#x27;</span>].<span class="title function_">includes</span>(prop)) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`禁止访问 <span class="subst">$&#123;prop&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> target[prop];</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">target, prop, value</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (prop === <span class="string">&#x27;document&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;禁止修改document对象&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      target[prop] = value;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">bootstrap</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;安全沙箱启动&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">mount</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">window</span>.<span class="property">__SANDBOX_PROXY__</span> = proxy;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">unmount</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">delete</span> <span class="variable language_">window</span>.<span class="property">__SANDBOX_PROXY__</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 集成到启动配置</span></span><br><span class="line"><span class="title function_">start</span>(&#123;</span><br><span class="line">  <span class="attr">sandbox</span>: <span class="title function_">createSecureSandbox</span>()</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="11-5-性能追踪与可视化"><a href="#11-5-性能追踪与可视化" class="headerlink" title="11.5 性能追踪与可视化"></a>11.5 性能追踪与可视化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 性能追踪装饰器</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">tracePerformance</span>(<span class="params">target, name, descriptor</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> original = descriptor.<span class="property">value</span>;</span><br><span class="line"></span><br><span class="line">  descriptor.<span class="property">value</span> = <span class="keyword">async</span> <span class="keyword">function</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> start = performance.<span class="title function_">now</span>();</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> original.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args);</span><br><span class="line">    <span class="keyword">const</span> duration = performance.<span class="title function_">now</span>() - start;</span><br><span class="line"></span><br><span class="line">    performanceTrack.<span class="title function_">addEntry</span>(&#123;</span><br><span class="line">      name,</span><br><span class="line">      duration,</span><br><span class="line">      <span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">      <span class="attr">args</span>: args.<span class="property">length</span> &gt; <span class="number">0</span> ? args : <span class="literal">undefined</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> descriptor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在关键生命周期使用</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AppController</span> &#123;</span><br><span class="line">  @tracePerformance</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadApp</span>(<span class="params">config</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">loadMicroApp</span>(config);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @tracePerformance</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">unloadApp</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> app = <span class="variable language_">this</span>.<span class="property">apps</span>.<span class="title function_">get</span>(name);</span><br><span class="line">    <span class="keyword">return</span> app.<span class="title function_">unmount</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 性能数据可视化</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">renderPerformanceDashboard</span> = (<span class="params">data</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> metrics = &#123;</span><br><span class="line">    <span class="attr">loadTime</span>: data.<span class="title function_">filter</span>(<span class="function"><span class="params">d</span> =&gt;</span> d.<span class="property">name</span> === <span class="string">&#x27;loadApp&#x27;</span>),</span><br><span class="line">    <span class="attr">unloadTime</span>: data.<span class="title function_">filter</span>(<span class="function"><span class="params">d</span> =&gt;</span> d.<span class="property">name</span> === <span class="string">&#x27;unloadApp&#x27;</span>)</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用图表库渲染可视化视图</span></span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Chart</span>(<span class="string">&#x27;#load-times&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;line&#x27;</span>,</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">      <span class="attr">labels</span>: metrics.<span class="property">loadTime</span>.<span class="title function_">map</span>(<span class="function"><span class="params">d</span> =&gt;</span> <span class="keyword">new</span> <span class="title class_">Date</span>(d.<span class="property">timestamp</span>).<span class="title function_">toLocaleTimeString</span>()),</span><br><span class="line">      <span class="attr">datasets</span>: [&#123;</span><br><span class="line">        <span class="attr">label</span>: <span class="string">&#x27;应用加载时间 (ms)&#x27;</span>,</span><br><span class="line">        <span class="attr">data</span>: metrics.<span class="property">loadTime</span>.<span class="title function_">map</span>(<span class="function"><span class="params">d</span> =&gt;</span> d.<span class="property">duration</span>),</span><br><span class="line">        <span class="attr">borderColor</span>: <span class="string">&#x27;#4CAF50&#x27;</span></span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><hr><blockquote><p>本次优化重点增强以下方面：</p><ol><li><strong>智能预加载</strong> - 基于用户行为和可视区域预测加载</li><li><strong>SLA监控</strong> - 实时跟踪性能指标并预警</li><li><strong>网络适配</strong> - 根据网络状况动态调整策略</li><li><strong>安全增强</strong> - 严格限制敏感API访问</li><li><strong>性能可视化</strong> - 提供直观的性能分析视图</li></ol></blockquote><p>[🔗 性能监控示例] | [📊 可视化模板] | [🛡️ 安全审计指南]</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Qiankun-微前端企业级实践指南&quot;&gt;&lt;a href=&quot;#Qiankun-微前端企业级实践指南&quot; class=&quot;headerlink&quot; title=&quot;Qiankun 微前端企业级实践指南&quot;&gt;&lt;/a&gt;Qiankun 微前端企业级实践指南&lt;/h1&gt;&lt;h2 id=&quot;目</summary>
      
    
    
    
    <category term="教程" scheme="https://aoayaoa.github.io/categories/%E6%95%99%E7%A8%8B/"/>
    
    
    <category term="入门" scheme="https://aoayaoa.github.io/tags/%E5%85%A5%E9%97%A8/"/>
    
    <category term="Hexo" scheme="https://aoayaoa.github.io/tags/Hexo/"/>
    
  </entry>
  
  <entry>
    <title>vite</title>
    <link href="https://aoayaoa.github.io/2024/02/01/vite/"/>
    <id>https://aoayaoa.github.io/2024/02/01/vite/</id>
    <published>2024-01-31T16:00:00.000Z</published>
    <updated>2025-03-07T04:00:05.349Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Vite-完全指南：从入门到精通"><a href="#Vite-完全指南：从入门到精通" class="headerlink" title="Vite 完全指南：从入门到精通"></a>Vite 完全指南：从入门到精通</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><h3 id="第一部分：基础入门"><a href="#第一部分：基础入门" class="headerlink" title="第一部分：基础入门"></a>第一部分：基础入门</h3><ol><li><p><a href="#1-%E8%AE%A4%E8%AF%86-vite">认识 Vite</a></p><ul><li>1.1 什么是 Vite</li><li>1.2 核心优势</li><li>1.3 基本原理</li><li>1.4 应用场景</li></ul></li><li><p><a href="#2-%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B">快速开始</a></p><ul><li>2.1 环境准备</li><li>2.2 创建项目</li><li>2.3 项目结构</li><li>2.4 基本命令</li><li>2.5 开发调试</li></ul></li></ol><h3 id="第二部分：核心概念"><a href="#第二部分：核心概念" class="headerlink" title="第二部分：核心概念"></a>第二部分：核心概念</h3><ol start="3"><li><p><a href="#3-%E6%9E%84%E5%BB%BA%E5%9F%BA%E7%A1%80">构建基础</a></p><ul><li>3.1 开发服务器</li><li>3.2 构建过程</li><li>3.3 依赖预构建</li><li>3.4 HMR 机制</li></ul></li><li><p><a href="#4-%E8%B5%84%E6%BA%90%E5%A4%84%E7%90%86">资源处理</a></p><ul><li>4.1 静态资源</li><li>4.2 样式处理</li><li>4.3 JavaScript&#x2F;TypeScript</li><li>4.4 JSON 和 Web Workers</li><li>4.5 动态导入</li></ul></li></ol><h3 id="第三部分：进阶使用"><a href="#第三部分：进阶使用" class="headerlink" title="第三部分：进阶使用"></a>第三部分：进阶使用</h3><ol start="5"><li><p><a href="#5-%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3">配置详解</a></p><ul><li>5.1 基础配置</li><li>5.2 开发服务器配置</li><li>5.3 构建配置</li><li>5.4 依赖优化</li><li>5.5 环境变量</li></ul></li><li><p><a href="#6-%E6%8F%92%E4%BB%B6%E7%B3%BB%E7%BB%9F">插件系统</a></p><ul><li>6.1 插件机制</li><li>6.2 常用插件</li><li>6.3 插件开发</li><li>6.4 插件钩子</li><li>6.5 最佳实践</li></ul></li></ol><h3 id="第四部分：框架集成"><a href="#第四部分：框架集成" class="headerlink" title="第四部分：框架集成"></a>第四部分：框架集成</h3><ol start="7"><li><p><a href="#7-%E4%B8%BB%E6%B5%81%E6%A1%86%E6%9E%B6">主流框架</a></p><ul><li>7.1 Vue 生态</li><li>7.2 React 生态</li><li>7.3 其他框架</li><li>7.4 迁移指南</li></ul></li><li><p><a href="#8-%E5%B7%A5%E5%85%B7%E9%93%BE%E9%9B%86%E6%88%90">工具链集成</a></p><ul><li>8.1 TypeScript</li><li>8.2 CSS 预处理器</li><li>8.3 PostCSS</li><li>8.4 ESLint&#x2F;Prettier</li><li>8.5 单元测试</li></ul></li></ol><h3 id="第五部分：生产优化"><a href="#第五部分：生产优化" class="headerlink" title="第五部分：生产优化"></a>第五部分：生产优化</h3><ol start="9"><li><p><a href="#9-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">性能优化</a></p><ul><li>9.1 构建优化</li><li>9.2 代码分割</li><li>9.3 懒加载</li><li>9.4 预加载</li><li>9.5 缓存策略</li></ul></li><li><p><a href="#10-%E9%83%A8%E7%BD%B2%E8%BF%90%E7%BB%B4">部署运维</a></p><ul><li>10.1 构建策略</li><li>10.2 部署方案</li><li>10.3 CI&#x2F;CD</li><li>10.4 监控分析</li><li>10.5 安全考虑</li></ul></li></ol><h2 id="1-认识-Vite"><a href="#1-认识-Vite" class="headerlink" title="1. 认识 Vite"></a>1. 认识 Vite</h2><h3 id="1-1-什么是-Vite"><a href="#1-1-什么是-Vite" class="headerlink" title="1.1 什么是 Vite"></a>1.1 什么是 Vite</h3><p>Vite（法语意为”快速”）是新一代前端构建工具，由 Vue.js 的作者尤雨溪开发。它针对现代 Web 开发的痛点，提供了一套完整的开发解决方案。</p><h4 id="核心特点"><a href="#核心特点" class="headerlink" title="核心特点"></a>核心特点</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 极速的服务器启动</span></span><br><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"><span class="comment">// Vite 直接提供 ESM 源码</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 轻量快速的热更新</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">hot</span>) &#123;</span><br><span class="line">  <span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">hot</span>.<span class="title function_">accept</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 开箱即用的各种功能</span></span><br><span class="line"><span class="keyword">import</span> styles <span class="keyword">from</span> <span class="string">&#x27;./style.module.css&#x27;</span></span><br><span class="line"><span class="keyword">import</span> data <span class="keyword">from</span> <span class="string">&#x27;./data.json&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="1-2-核心优势"><a href="#1-2-核心优势" class="headerlink" title="1.2 核心优势"></a>1.2 核心优势</h3><h4 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h4><pre><code class="highlight mermaid">graph LR    A[源代码] --&gt; B[Vite Dev Server]    B --&gt; C[浏览器原生 ESM]    C --&gt; D[即时编译]    D --&gt; E[快速更新]</code></pre><h4 id="生产环境"><a href="#生产环境" class="headerlink" title="生产环境"></a>生产环境</h4><pre><code class="highlight mermaid">graph LR    A[源代码] --&gt; B[Rollup]    B --&gt; C[优化打包]    C --&gt; D[高性能产物]</code></pre><h3 id="1-3-基本原理"><a href="#1-3-基本原理" class="headerlink" title="1.3 基本原理"></a>1.3 基本原理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开发服务器原理</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">server</span>: &#123;</span><br><span class="line">    <span class="comment">// 1. 基于 ESM 的开发服务器</span></span><br><span class="line">    <span class="attr">middlewareMode</span>: <span class="literal">false</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 智能的 HMR</span></span><br><span class="line">    <span class="attr">hmr</span>: &#123;</span><br><span class="line">      <span class="attr">protocol</span>: <span class="string">&#x27;ws&#x27;</span>,</span><br><span class="line">      <span class="attr">timeout</span>: <span class="number">1000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 按需编译</span></span><br><span class="line">    <span class="attr">fs</span>: &#123;</span><br><span class="line">      <span class="attr">strict</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">allow</span>: [<span class="string">&#x27;..&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="1-4-应用场景"><a href="#1-4-应用场景" class="headerlink" title="1.4 应用场景"></a>1.4 应用场景</h3><table><thead><tr><th>场景</th><th>特点</th><th>适用性</th></tr></thead><tbody><tr><td>SPA</td><td>快速开发、即时反馈</td><td>极佳</td></tr><tr><td>SSR</td><td>支持服务端渲染</td><td>良好</td></tr><tr><td>库开发</td><td>插件化、可扩展</td><td>适中</td></tr><tr><td>MPA</td><td>多页面应用支持</td><td>良好</td></tr></tbody></table><h2 id="2-快速开始"><a href="#2-快速开始" class="headerlink" title="2. 快速开始"></a>2. 快速开始</h2><h3 id="2-1-环境准备"><a href="#2-1-环境准备" class="headerlink" title="2.1 环境准备"></a>2.1 环境准备</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查 Node.js 版本（需要 14.18+ / 16+）</span></span><br><span class="line">node -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># 包管理器选择</span></span><br><span class="line">npm -v  <span class="comment"># npm 6.14.0+</span></span><br><span class="line">yarn -v <span class="comment"># yarn 1.22.0+</span></span><br><span class="line">pnpm -v <span class="comment"># pnpm 7.0.0+</span></span><br></pre></td></tr></table></figure><h3 id="2-2-创建项目"><a href="#2-2-创建项目" class="headerlink" title="2.2 创建项目"></a>2.2 创建项目</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 npm</span></span><br><span class="line">npm create vite@latest my-vite-app -- --template vue</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 yarn</span></span><br><span class="line">yarn create vite my-vite-app --template vue</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 pnpm</span></span><br><span class="line">pnpm create vite my-vite-app -- --template vue</span><br></pre></td></tr></table></figure><h4 id="支持的模板"><a href="#支持的模板" class="headerlink" title="支持的模板"></a>支持的模板</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">TEMPLATES</span> = &#123;</span><br><span class="line">  <span class="attr">vanilla</span>: <span class="string">&#x27;原生 JavaScript&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;vanilla-ts&#x27;</span>: <span class="string">&#x27;原生 TypeScript&#x27;</span>,</span><br><span class="line">  <span class="attr">vue</span>: <span class="string">&#x27;Vue&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;vue-ts&#x27;</span>: <span class="string">&#x27;Vue + TypeScript&#x27;</span>,</span><br><span class="line">  <span class="attr">react</span>: <span class="string">&#x27;React&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;react-ts&#x27;</span>: <span class="string">&#x27;React + TypeScript&#x27;</span>,</span><br><span class="line">  <span class="attr">preact</span>: <span class="string">&#x27;Preact&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;preact-ts&#x27;</span>: <span class="string">&#x27;Preact + TypeScript&#x27;</span>,</span><br><span class="line">  <span class="attr">lit</span>: <span class="string">&#x27;Lit&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;lit-ts&#x27;</span>: <span class="string">&#x27;Lit + TypeScript&#x27;</span>,</span><br><span class="line">  <span class="attr">svelte</span>: <span class="string">&#x27;Svelte&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;svelte-ts&#x27;</span>: <span class="string">&#x27;Svelte + TypeScript&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-3-项目结构"><a href="#2-3-项目结构" class="headerlink" title="2.3 项目结构"></a>2.3 项目结构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── node_modules/</span><br><span class="line">├── public/</span><br><span class="line">│   └── favicon.ico</span><br><span class="line">├── src/</span><br><span class="line">│   ├── assets/</span><br><span class="line">│   ├── components/</span><br><span class="line">│   ├── views/</span><br><span class="line">│   ├── App.vue</span><br><span class="line">│   └── main.js</span><br><span class="line">├── .gitignore</span><br><span class="line">├── index.html</span><br><span class="line">├── package.json</span><br><span class="line">├── README.md</span><br><span class="line">└── vite.config.js</span><br></pre></td></tr></table></figure><h1 id=""><a href="#" class="headerlink" title=""></a></h1><h2 id="3-构建基础"><a href="#3-构建基础" class="headerlink" title="3. 构建基础"></a>3. 构建基础</h2><h3 id="3-1-开发服务器"><a href="#3-1-开发服务器" class="headerlink" title="3.1 开发服务器"></a>3.1 开发服务器</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">server</span>: &#123;</span><br><span class="line">    <span class="attr">port</span>: <span class="number">3000</span>,</span><br><span class="line">    <span class="attr">open</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">proxy</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;/api&#x27;</span>: &#123;</span><br><span class="line">        <span class="attr">target</span>: <span class="string">&#x27;http://localhost:8080&#x27;</span>,</span><br><span class="line">        <span class="attr">changeOrigin</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">rewrite</span>: <span class="function">(<span class="params">path</span>) =&gt;</span> path.<span class="title function_">replace</span>(<span class="regexp">/^\/api/</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="3-2-构建配置"><a href="#3-2-构建配置" class="headerlink" title="3.2 构建配置"></a>3.2 构建配置</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">build</span>: &#123;</span><br><span class="line">    <span class="attr">target</span>: <span class="string">&#x27;modules&#x27;</span>,</span><br><span class="line">    <span class="attr">outDir</span>: <span class="string">&#x27;dist&#x27;</span>,</span><br><span class="line">    <span class="attr">assetsDir</span>: <span class="string">&#x27;assets&#x27;</span>,</span><br><span class="line">    <span class="attr">minify</span>: <span class="string">&#x27;terser&#x27;</span>,</span><br><span class="line">    <span class="attr">rollupOptions</span>: &#123;</span><br><span class="line">      <span class="attr">output</span>: &#123;</span><br><span class="line">        <span class="attr">manualChunks</span>: &#123;</span><br><span class="line">          <span class="string">&#x27;vendor&#x27;</span>: [<span class="string">&#x27;vue&#x27;</span>, <span class="string">&#x27;vue-router&#x27;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="4-资源处理"><a href="#4-资源处理" class="headerlink" title="4. 资源处理"></a>4. 资源处理</h2><h3 id="4-1-静态资源"><a href="#4-1-静态资源" class="headerlink" title="4.1 静态资源"></a>4.1 静态资源</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 图片资源</span></span><br><span class="line"><span class="keyword">import</span> imgUrl <span class="keyword">from</span> <span class="string">&#x27;./img.png&#x27;</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;hero&#x27;</span>).<span class="property">src</span> = imgUrl</span><br><span class="line"></span><br><span class="line"><span class="comment">// CSS 模块</span></span><br><span class="line"><span class="keyword">import</span> styles <span class="keyword">from</span> <span class="string">&#x27;./style.module.css&#x27;</span></span><br><span class="line">element.<span class="property">className</span> = styles.<span class="property">heading</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// JSON</span></span><br><span class="line"><span class="keyword">import</span> data <span class="keyword">from</span> <span class="string">&#x27;./data.json&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(data)</span><br></pre></td></tr></table></figure><h3 id="4-2-样式处理"><a href="#4-2-样式处理" class="headerlink" title="4.2 样式处理"></a>4.2 样式处理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CSS 预处理器</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./style.scss&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// PostCSS 配置</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">css</span>: &#123;</span><br><span class="line">    <span class="attr">postcss</span>: &#123;</span><br><span class="line">      <span class="attr">plugins</span>: [</span><br><span class="line">        <span class="title function_">autoprefixer</span>(),</span><br><span class="line">        <span class="title function_">postcssPresetEnv</span>()</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">modules</span>: &#123;</span><br><span class="line">      <span class="attr">localsConvention</span>: <span class="string">&#x27;camelCase&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-配置详解"><a href="#5-配置详解" class="headerlink" title="5. 配置详解"></a>5. 配置详解</h2><h3 id="5-1-基础配置"><a href="#5-1-基础配置" class="headerlink" title="5.1 基础配置"></a>5.1 基础配置</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; defineConfig &#125; <span class="keyword">from</span> <span class="string">&#x27;vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> vue <span class="keyword">from</span> <span class="string">&#x27;@vitejs/plugin-vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">root</span>: process.<span class="title function_">cwd</span>(),</span><br><span class="line">  <span class="attr">base</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">  <span class="attr">mode</span>: <span class="string">&#x27;development&#x27;</span>,</span><br><span class="line">  </span><br><span class="line">  <span class="attr">resolve</span>: &#123;</span><br><span class="line">    <span class="attr">alias</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;@&#x27;</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./src&#x27;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">extensions</span>: [<span class="string">&#x27;.mjs&#x27;</span>, <span class="string">&#x27;.js&#x27;</span>, <span class="string">&#x27;.ts&#x27;</span>, <span class="string">&#x27;.jsx&#x27;</span>, <span class="string">&#x27;.tsx&#x27;</span>, <span class="string">&#x27;.json&#x27;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="attr">plugins</span>: [<span class="title function_">vue</span>()]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="5-2-环境变量"><a href="#5-2-环境变量" class="headerlink" title="5.2 环境变量"></a>5.2 环境变量</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .env</span></span><br><span class="line">VITE_APP_TITLE=My App</span><br><span class="line">VITE_API_URL=http://api.example.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># .env.development</span></span><br><span class="line">VITE_APP_TITLE=Dev App</span><br><span class="line">VITE_API_URL=http://dev-api.example.com</span><br></pre></td></tr></table></figure><h2 id="6-插件系统"><a href="#6-插件系统" class="headerlink" title="6. 插件系统"></a>6. 插件系统</h2><h3 id="6-1-插件开发"><a href="#6-1-插件开发" class="headerlink" title="6.1 插件开发"></a>6.1 插件开发</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">myPlugin</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;my-plugin&#x27;</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">configureServer</span>(<span class="params">server</span>) &#123;</span><br><span class="line">      <span class="comment">// 服务器配置</span></span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">transform</span>(<span class="params">code, id</span>) &#123;</span><br><span class="line">      <span class="comment">// 代码转换</span></span><br><span class="line">      <span class="keyword">if</span> (id.<span class="title function_">endsWith</span>(<span class="string">&#x27;.vue&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          <span class="attr">code</span>: transformedCode,</span><br><span class="line">          <span class="attr">map</span>: sourceMap</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-2-常用插件"><a href="#6-2-常用插件" class="headerlink" title="6.2 常用插件"></a>6.2 常用插件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> vue <span class="keyword">from</span> <span class="string">&#x27;@vitejs/plugin-vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> vueJsx <span class="keyword">from</span> <span class="string">&#x27;@vitejs/plugin-vue-jsx&#x27;</span></span><br><span class="line"><span class="keyword">import</span> legacy <span class="keyword">from</span> <span class="string">&#x27;@vitejs/plugin-legacy&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="title function_">vue</span>(),</span><br><span class="line">    <span class="title function_">vueJsx</span>(),</span><br><span class="line">    <span class="title function_">legacy</span>(&#123;</span><br><span class="line">      <span class="attr">targets</span>: [<span class="string">&#x27;defaults&#x27;</span>, <span class="string">&#x27;not IE 11&#x27;</span>]</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="7-主流框架"><a href="#7-主流框架" class="headerlink" title="7. 主流框架"></a>7. 主流框架</h2><h3 id="7-1-Vue-集成"><a href="#7-1-Vue-集成" class="headerlink" title="7.1 Vue 集成"></a>7.1 Vue 集成</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.js</span></span><br><span class="line"><span class="keyword">import</span> vue <span class="keyword">from</span> <span class="string">&#x27;@vitejs/plugin-vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="title function_">vue</span>(&#123;</span><br><span class="line">      <span class="attr">template</span>: &#123;</span><br><span class="line">        <span class="attr">compilerOptions</span>: &#123;</span><br><span class="line">          <span class="attr">isCustomElement</span>: <span class="function"><span class="params">tag</span> =&gt;</span> tag.<span class="title function_">startsWith</span>(<span class="string">&#x27;ion-&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="7-2-React-集成"><a href="#7-2-React-集成" class="headerlink" title="7.2 React 集成"></a>7.2 React 集成</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.js</span></span><br><span class="line"><span class="keyword">import</span> react <span class="keyword">from</span> <span class="string">&#x27;@vitejs/plugin-react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="title function_">react</span>(&#123;</span><br><span class="line">      <span class="attr">babel</span>: &#123;</span><br><span class="line">        <span class="attr">plugins</span>: [</span><br><span class="line">          [<span class="string">&#x27;@babel/plugin-proposal-decorators&#x27;</span>, &#123; <span class="attr">legacy</span>: <span class="literal">true</span> &#125;]</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="8-工具链集成"><a href="#8-工具链集成" class="headerlink" title="8. 工具链集成"></a>8. 工具链集成</h2><h3 id="8-1-TypeScript"><a href="#8-1-TypeScript" class="headerlink" title="8.1 TypeScript"></a>8.1 TypeScript</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">build</span>: &#123;</span><br><span class="line">    <span class="attr">target</span>: <span class="string">&#x27;esnext&#x27;</span>,</span><br><span class="line">    <span class="attr">rollupOptions</span>: &#123;</span><br><span class="line">      <span class="attr">input</span>: &#123;</span><br><span class="line">        <span class="attr">main</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// tsconfig.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;compilerOptions&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;target&quot;</span>: <span class="string">&quot;esnext&quot;</span>,</span><br><span class="line">    <span class="string">&quot;module&quot;</span>: <span class="string">&quot;esnext&quot;</span>,</span><br><span class="line">    <span class="string">&quot;moduleResolution&quot;</span>: <span class="string">&quot;node&quot;</span>,</span><br><span class="line">    <span class="string">&quot;strict&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;jsx&quot;</span>: <span class="string">&quot;preserve&quot;</span>,</span><br><span class="line">    <span class="string">&quot;sourceMap&quot;</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="9-性能优化"><a href="#9-性能优化" class="headerlink" title="9. 性能优化"></a>9. 性能优化</h2><h3 id="9-1-构建优化"><a href="#9-1-构建优化" class="headerlink" title="9.1 构建优化"></a>9.1 构建优化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">build</span>: &#123;</span><br><span class="line">    <span class="attr">target</span>: <span class="string">&#x27;modules&#x27;</span>,</span><br><span class="line">    <span class="attr">minify</span>: <span class="string">&#x27;terser&#x27;</span>,</span><br><span class="line">    <span class="attr">terserOptions</span>: &#123;</span><br><span class="line">      <span class="attr">compress</span>: &#123;</span><br><span class="line">        <span class="attr">drop_console</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">drop_debugger</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">rollupOptions</span>: &#123;</span><br><span class="line">      <span class="attr">output</span>: &#123;</span><br><span class="line">        <span class="title function_">manualChunks</span>(<span class="params">id</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (id.<span class="title function_">includes</span>(<span class="string">&#x27;node_modules&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;vendor&#x27;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="9-2-代码分割"><a href="#9-2-代码分割" class="headerlink" title="9.2 代码分割"></a>9.2 代码分割</h3><h4 id="9-2-1-基础配置"><a href="#9-2-1-基础配置" class="headerlink" title="9.2.1 基础配置"></a>9.2.1 基础配置</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">build</span>: &#123;</span><br><span class="line">    <span class="attr">rollupOptions</span>: &#123;</span><br><span class="line">      <span class="attr">output</span>: &#123;</span><br><span class="line">        <span class="comment">// 1. 手动分块策略</span></span><br><span class="line">        <span class="attr">manualChunks</span>: &#123;</span><br><span class="line">          <span class="comment">// 将 Vue 全家桶拆分成单独的 chunk</span></span><br><span class="line">          <span class="string">&#x27;vue-vendor&#x27;</span>: [<span class="string">&#x27;vue&#x27;</span>, <span class="string">&#x27;vue-router&#x27;</span>, <span class="string">&#x27;pinia&#x27;</span>],</span><br><span class="line">          <span class="comment">// 将 UI 框架拆分</span></span><br><span class="line">          <span class="string">&#x27;element-plus&#x27;</span>: [<span class="string">&#x27;element-plus&#x27;</span>],</span><br><span class="line">          <span class="comment">// 将大型依赖拆分</span></span><br><span class="line">          <span class="string">&#x27;lodash&#x27;</span>: [<span class="string">&#x27;lodash-es&#x27;</span>],</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 2. 自定义 chunk 文件名</span></span><br><span class="line">        <span class="attr">chunkFileNames</span>: <span class="function">(<span class="params">chunkInfo</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> facadeModuleId = chunkInfo.<span class="property">facadeModuleId</span></span><br><span class="line">          <span class="keyword">if</span> (facadeModuleId) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">`js/[name]-[hash].js`</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> <span class="string">&#x27;js/vendor-[hash].js&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 3. 自定义资源文件名</span></span><br><span class="line">        <span class="attr">assetFileNames</span>: <span class="function">(<span class="params">assetInfo</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (assetInfo.<span class="property">name</span>.<span class="title function_">endsWith</span>(<span class="string">&#x27;.css&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;css/[name]-[hash][extname]&#x27;</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> <span class="string">&#x27;assets/[name]-[hash][extname]&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="9-2-2-动态导入"><a href="#9-2-2-动态导入" class="headerlink" title="9.2.2 动态导入"></a>9.2.2 动态导入</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 路由级别代码分割</span></span><br><span class="line"><span class="comment">// router/index.js</span></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;../views/Home.vue&#x27;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/about&#x27;</span>,</span><br><span class="line">    <span class="comment">// 添加注释以控制 chunk 名称</span></span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="comment">/* webpackChunkName: &quot;about&quot; */</span> <span class="string">&#x27;../views/About.vue&#x27;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/dashboard&#x27;</span>,</span><br><span class="line">    <span class="comment">// 预加载重要路由</span></span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="comment">/* webpackPrefetch: true */</span> <span class="string">&#x27;../views/Dashboard.vue&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 组件级别代码分割</span></span><br><span class="line"><span class="comment">// 按需加载组件</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MyHeavyComponent</span> = <span class="title function_">defineAsyncComponent</span>(<span class="function">() =&gt;</span> </span><br><span class="line">  <span class="keyword">import</span>(<span class="string">&#x27;../components/MyHeavyComponent.vue&#x27;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 条件导入</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">loadAnalytics</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> analytics = <span class="keyword">await</span> <span class="keyword">import</span>(<span class="string">&#x27;./analytics&#x27;</span>)</span><br><span class="line">    analytics.<span class="title function_">init</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9-2-3-分割策略"><a href="#9-2-3-分割策略" class="headerlink" title="9.2.3 分割策略"></a>9.2.3 分割策略</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">build</span>: &#123;</span><br><span class="line">    <span class="attr">rollupOptions</span>: &#123;</span><br><span class="line">      <span class="attr">output</span>: &#123;</span><br><span class="line">        <span class="title function_">manualChunks</span>(<span class="params">id</span>) &#123;</span><br><span class="line">          <span class="comment">// 1. 将 node_modules 中的代码单独打包</span></span><br><span class="line">          <span class="keyword">if</span> (id.<span class="title function_">includes</span>(<span class="string">&#x27;node_modules&#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 获取包名</span></span><br><span class="line">            <span class="keyword">const</span> packageName = id.<span class="title function_">toString</span>().<span class="title function_">split</span>(<span class="string">&#x27;node_modules/&#x27;</span>)[<span class="number">1</span>].<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="comment">// 将每个包单独打包</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">`vendor-<span class="subst">$&#123;packageName&#125;</span>`</span></span><br><span class="line">          &#125;</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 2. 将公共组件打包到一起</span></span><br><span class="line">          <span class="keyword">if</span> (id.<span class="title function_">includes</span>(<span class="string">&#x27;src/components&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;components&#x27;</span></span><br><span class="line">          &#125;</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 3. 将工具函数打包到一起</span></span><br><span class="line">          <span class="keyword">if</span> (id.<span class="title function_">includes</span>(<span class="string">&#x27;src/utils&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;utils&#x27;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="9-2-4-预加载和预获取"><a href="#9-2-4-预加载和预获取" class="headerlink" title="9.2.4 预加载和预获取"></a>9.2.4 预加载和预获取</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 使用 vite-plugin-imagemin 优化图片</span></span><br><span class="line"><span class="keyword">import</span> viteImagemin <span class="keyword">from</span> <span class="string">&#x27;vite-plugin-imagemin&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="title function_">viteImagemin</span>(&#123;</span><br><span class="line">      <span class="attr">gifsicle</span>: &#123; <span class="attr">optimizationLevel</span>: <span class="number">3</span> &#125;,</span><br><span class="line">      <span class="attr">mozjpeg</span>: &#123; <span class="attr">quality</span>: <span class="number">75</span> &#125;,</span><br><span class="line">      <span class="attr">pngquant</span>: &#123; <span class="attr">quality</span>: [<span class="number">0.7</span>, <span class="number">0.8</span>] &#125;,</span><br><span class="line">      <span class="attr">svgo</span>: &#123;</span><br><span class="line">        <span class="attr">plugins</span>: [</span><br><span class="line">          &#123; <span class="attr">removeViewBox</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">          &#123; <span class="attr">removeDimensions</span>: <span class="literal">true</span> &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 资源预加载</span></span><br><span class="line"><span class="comment">// index.html</span></span><br><span class="line">&lt;link rel=<span class="string">&quot;modulepreload&quot;</span> href=<span class="string">&quot;/src/heavy-module.js&quot;</span>&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;preload&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/assets/large-image.jpg&quot;</span> <span class="attr">as</span>=<span class="string">&quot;image&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">// 3. 动态预加载</span></span><br><span class="line"><span class="language-xml">const preloadComponent = () =&gt; &#123;</span></span><br><span class="line"><span class="language-xml">  const component = import(&#x27;./BigComponent.vue&#x27;)</span></span><br><span class="line"><span class="language-xml">  requestIdleCallback(() =&gt; &#123;</span></span><br><span class="line"><span class="language-xml">    // 在空闲时间预加载其他资源</span></span><br><span class="line"><span class="language-xml">    import(&#x27;./non-critical-module.js&#x27;)</span></span><br><span class="line"><span class="language-xml">  &#125;)</span></span><br><span class="line"><span class="language-xml">  return component</span></span><br><span class="line"><span class="language-xml">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="9-2-5-分割优化建议"><a href="#9-2-5-分割优化建议" class="headerlink" title="9.2.5 分割优化建议"></a>9.2.5 分割优化建议</h4><ol><li><strong>合理的分割粒度</strong></li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不好的实践 - 过度分割</span></span><br><span class="line"><span class="attr">manualChunks</span>: &#123;</span><br><span class="line">  <span class="string">&#x27;tiny-lib&#x27;</span>: [<span class="string">&#x27;tiny-lib&#x27;</span>], <span class="comment">// 这个库太小，不值得单独分割</span></span><br><span class="line">  <span class="string">&#x27;utils&#x27;</span>: [<span class="string">&#x27;./src/utils/format.js&#x27;</span>] <span class="comment">// 工具函数太小，应该合并</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 好的实践 - 适当分割</span></span><br><span class="line"><span class="attr">manualChunks</span>: &#123;</span><br><span class="line">  <span class="string">&#x27;core-vendor&#x27;</span>: [<span class="string">&#x27;vue&#x27;</span>, <span class="string">&#x27;vue-router&#x27;</span>, <span class="string">&#x27;pinia&#x27;</span>], <span class="comment">// 核心依赖打包在一起</span></span><br><span class="line">  <span class="string">&#x27;ui-vendor&#x27;</span>: [<span class="string">&#x27;element-plus&#x27;</span>], <span class="comment">// UI 框架单独打包</span></span><br><span class="line">  <span class="string">&#x27;big-vendor&#x27;</span>: [<span class="string">&#x27;echarts&#x27;</span>, <span class="string">&#x27;three.js&#x27;</span>] <span class="comment">// 大型依赖单独打包</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li><strong>动态导入最佳实践</strong></li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 组件动态导入</span></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/dashboard&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;./views/Dashboard.vue&#x27;</span>),</span><br><span class="line">    <span class="comment">// 使用 webpackPreload 确保关键路由快速加载</span></span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;overview&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="comment">/* webpackPrefetch: true */</span> <span class="string">&#x27;./views/Overview.vue&#x27;</span>)</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;analysis&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="comment">/* webpackPreload: true */</span> <span class="string">&#x27;./views/Analysis.vue&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><ol start="3"><li><strong>性能监控</strong></li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 监控代码分割性能</span></span><br><span class="line"><span class="keyword">import</span> &#123; onLCP, onFID &#125; <span class="keyword">from</span> <span class="string">&#x27;web-vitals&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 监控加载性能</span></span><br><span class="line"><span class="title function_">onLCP</span>(<span class="variable language_">console</span>.<span class="property">log</span>)</span><br><span class="line"><span class="title function_">onFID</span>(<span class="variable language_">console</span>.<span class="property">log</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监控 chunk 加载失败</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (event.<span class="property">target</span>.<span class="property">tagName</span> === <span class="string">&#x27;SCRIPT&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// 处理 chunk 加载失败</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Chunk load failed:&#x27;</span>, event.<span class="property">target</span>.<span class="property">src</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="literal">true</span>)</span><br></pre></td></tr></table></figure><p>这样的代码分割内容更加完整和准确，涵盖了：</p><ul><li>基础配置</li><li>动态导入</li><li>分割策略</li><li>预加载和预获取</li><li>最佳实践和性能监控</li></ul><p>每个部分都提供了具体的代码示例和实践建议，更有助于理解和实施代码分割。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 10. 部署运维</span><br><span class="line"></span><br><span class="line">### 10.1 静态部署</span><br><span class="line">```javascript</span><br><span class="line">// vite.config.js</span><br><span class="line">export default defineConfig(&#123;</span><br><span class="line">  base: production ? &#x27;/your-repo/&#x27; : &#x27;/&#x27;,</span><br><span class="line">  build: &#123;</span><br><span class="line">    outDir: &#x27;dist&#x27;,</span><br><span class="line">    emptyOutDir: true,</span><br><span class="line">    sourcemap: true,</span><br><span class="line">    manifest: true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="10-2-CI-CD-配置"><a href="#10-2-CI-CD-配置" class="headerlink" title="10.2 CI&#x2F;CD 配置"></a>10.2 CI&#x2F;CD 配置</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .github/workflows/deploy.yml</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">Deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span> [<span class="string">main</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build-and-deploy:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/setup-node@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">node-version:</span> <span class="string">&#x27;16&#x27;</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">and</span> <span class="string">Build</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          npm ci</span></span><br><span class="line"><span class="string">          npm run build</span></span><br><span class="line"><span class="string"></span>      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">peaceiris/actions-gh-pages@v3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">github_token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">publish_dir:</span> <span class="string">./dist</span></span><br></pre></td></tr></table></figure><h3 id="10-3-性能监控"><a href="#10-3-性能监控" class="headerlink" title="10.3 性能监控"></a>10.3 性能监控</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 性能指标监控</span></span><br><span class="line"><span class="keyword">import</span> &#123; onCLS, onFID, onLCP &#125; <span class="keyword">from</span> <span class="string">&#x27;web-vitals&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sendToAnalytics</span>(<span class="params">&#123; name, delta, id &#125;</span>) &#123;</span><br><span class="line">  <span class="comment">// 发送性能数据到分析服务</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Metric: <span class="subst">$&#123;name&#125;</span> ID: <span class="subst">$&#123;id&#125;</span> Value: <span class="subst">$&#123;delta&#125;</span>`</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">onCLS</span>(sendToAnalytics)</span><br><span class="line"><span class="title function_">onFID</span>(sendToAnalytics)</span><br><span class="line"><span class="title function_">onLCP</span>(sendToAnalytics)</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Vite-完全指南：从入门到精通&quot;&gt;&lt;a href=&quot;#Vite-完全指南：从入门到精通&quot; class=&quot;headerlink&quot; title=&quot;Vite 完全指南：从入门到精通&quot;&gt;&lt;/a&gt;Vite 完全指南：从入门到精通&lt;/h1&gt;&lt;h2 id=&quot;目录&quot;&gt;&lt;a hr</summary>
      
    
    
    
    
    <category term="入门" scheme="https://aoayaoa.github.io/tags/%E5%85%A5%E9%97%A8/"/>
    
    <category term="vite" scheme="https://aoayaoa.github.io/tags/vite/"/>
    
  </entry>
  
  <entry>
    <title>webpack</title>
    <link href="https://aoayaoa.github.io/2023/05/26/webpack/"/>
    <id>https://aoayaoa.github.io/2023/05/26/webpack/</id>
    <published>2023-05-25T16:00:00.000Z</published>
    <updated>2025-03-07T03:53:32.519Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Webpack-完全指南：从入门到精通"><a href="#Webpack-完全指南：从入门到精通" class="headerlink" title="Webpack 完全指南：从入门到精通"></a>Webpack 完全指南：从入门到精通</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul><li><a href="#1-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5">1. 基础概念</a></li><li><a href="#2-%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD">2. 核心功能</a></li><li><a href="#3-%E6%89%93%E5%8C%85%E5%8E%9F%E7%90%86">3. 打包原理</a></li><li><a href="#4-%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3">4. 配置详解</a></li><li><a href="#5-loader-%E4%BD%93%E7%B3%BB">5. Loader 体系</a></li><li><a href="#6-plugin-%E4%BD%93%E7%B3%BB">6. Plugin 体系</a></li><li><a href="#7-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">7. 性能优化</a></li><li><a href="#8-%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8">8. 实战应用</a></li><li><a href="#9-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7">9. 高级特性</a></li><li><a href="#10-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">10. 最佳实践</a></li></ul><h2 id="1-基础概念"><a href="#1-基础概念" class="headerlink" title="1. 基础概念"></a>1. 基础概念</h2><h3 id="1-1-什么是-Webpack？"><a href="#1-1-什么是-Webpack？" class="headerlink" title="1.1 什么是 Webpack？"></a>1.1 什么是 Webpack？</h3><p><img src= "/img/loading.gif" data-lazy-src="https://webpack.js.org/assets/what-is-webpack.png" alt="Webpack工作原理"></p><p>Webpack 是一个现代 JavaScript 应用程序的静态模块打包工具。它将项目中的所有资源视为模块，通过依赖关系图构建应用。</p><h3 id="1-2-核心概念"><a href="#1-2-核心概念" class="headerlink" title="1.2 核心概念"></a>1.2 核心概念</h3><h4 id="1-2-1-入口-Entry"><a href="#1-2-1-入口-Entry" class="headerlink" title="1.2.1 入口(Entry)"></a>1.2.1 入口(Entry)</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 单入口</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&#x27;./src/index.js&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多入口</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">entry</span>: &#123;</span><br><span class="line">    <span class="attr">main</span>: <span class="string">&#x27;./src/main.js&#x27;</span>,</span><br><span class="line">    <span class="attr">vendor</span>: <span class="string">&#x27;./src/vendor.js&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-2-2-输出-Output"><a href="#1-2-2-输出-Output" class="headerlink" title="1.2.2 输出(Output)"></a>1.2.2 输出(Output)</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;dist&#x27;</span>),</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&#x27;[name].[contenthash].js&#x27;</span>,</span><br><span class="line">    <span class="attr">clean</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">publicPath</span>: <span class="string">&#x27;/&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-2-3-模块-Module"><a href="#1-2-3-模块-Module" class="headerlink" title="1.2.3 模块(Module)"></a>1.2.3 模块(Module)</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="attr">use</span>: <span class="string">&#x27;babel-loader&#x27;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [<span class="string">&#x27;style-loader&#x27;</span>, <span class="string">&#x27;css-loader&#x27;</span>]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-2-4-插件-Plugin"><a href="#1-2-4-插件-Plugin" class="headerlink" title="1.2.4 插件(Plugin)"></a>1.2.4 插件(Plugin)</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">HtmlWebpackPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;html-webpack-plugin&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MiniCssExtractPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;mini-css-extract-plugin&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HtmlWebpackPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">template</span>: <span class="string">&#x27;./src/index.html&#x27;</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">MiniCssExtractPlugin</span>()</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-核心功能"><a href="#2-核心功能" class="headerlink" title="2. 核心功能"></a>2. 核心功能</h2><h3 id="2-1-模块解析"><a href="#2-1-模块解析" class="headerlink" title="2.1 模块解析"></a>2.1 模块解析</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">resolve</span>: &#123;</span><br><span class="line">    <span class="comment">// 模块别名</span></span><br><span class="line">    <span class="attr">alias</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;@&#x27;</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;src&#x27;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 扩展名</span></span><br><span class="line">    <span class="attr">extensions</span>: [<span class="string">&#x27;.js&#x27;</span>, <span class="string">&#x27;.jsx&#x27;</span>, <span class="string">&#x27;.ts&#x27;</span>, <span class="string">&#x27;.tsx&#x27;</span>],</span><br><span class="line">    <span class="comment">// 模块查找目录</span></span><br><span class="line">    <span class="attr">modules</span>: [<span class="string">&#x27;node_modules&#x27;</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-代码分割"><a href="#2-2-代码分割" class="headerlink" title="2.2 代码分割"></a>2.2 代码分割</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">optimization</span>: &#123;</span><br><span class="line">    <span class="attr">splitChunks</span>: &#123;</span><br><span class="line">      <span class="attr">chunks</span>: <span class="string">&#x27;all&#x27;</span>,</span><br><span class="line">      <span class="attr">minSize</span>: <span class="number">20000</span>,</span><br><span class="line">      <span class="attr">minChunks</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">maxAsyncRequests</span>: <span class="number">30</span>,</span><br><span class="line">      <span class="attr">maxInitialRequests</span>: <span class="number">30</span>,</span><br><span class="line">      <span class="attr">cacheGroups</span>: &#123;</span><br><span class="line">        <span class="attr">defaultVendors</span>: &#123;</span><br><span class="line">          <span class="attr">test</span>: <span class="regexp">/[\\/]node_modules[\\/]/</span>,</span><br><span class="line">          <span class="attr">priority</span>: -<span class="number">10</span>,</span><br><span class="line">          <span class="attr">reuseExistingChunk</span>: <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">default</span>: &#123;</span><br><span class="line">          <span class="attr">minChunks</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">priority</span>: -<span class="number">20</span>,</span><br><span class="line">          <span class="attr">reuseExistingChunk</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-3-资源模块"><a href="#2-3-资源模块" class="headerlink" title="2.3 资源模块"></a>2.3 资源模块</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      <span class="comment">// 图片处理</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.(png|svg|jpg|jpeg|gif)$/i</span>,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;asset&#x27;</span>,</span><br><span class="line">        <span class="attr">parser</span>: &#123;</span><br><span class="line">          <span class="attr">dataUrlCondition</span>: &#123;</span><br><span class="line">            <span class="attr">maxSize</span>: <span class="number">4</span> * <span class="number">1024</span> <span class="comment">// 4kb</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">generator</span>: &#123;</span><br><span class="line">          <span class="attr">filename</span>: <span class="string">&#x27;images/[hash][ext][query]&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 字体处理</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.(woff|woff2|eot|ttf|otf)$/i</span>,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;asset/resource&#x27;</span>,</span><br><span class="line">        <span class="attr">generator</span>: &#123;</span><br><span class="line">          <span class="attr">filename</span>: <span class="string">&#x27;fonts/[hash][ext][query]&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-打包原理"><a href="#3-打包原理" class="headerlink" title="3. 打包原理"></a>3. 打包原理</h2><h3 id="3-1-构建流程"><a href="#3-1-构建流程" class="headerlink" title="3.1 构建流程"></a>3.1 构建流程</h3><p><img src= "/img/loading.gif" data-lazy-src="https://webpack.js.org/assets/compilation.png" alt="Webpack构建流程"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Compiler</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span> = options;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hooks</span> = &#123;</span><br><span class="line">      <span class="attr">run</span>: <span class="keyword">new</span> <span class="title class_">SyncHook</span>(),</span><br><span class="line">      <span class="attr">emit</span>: <span class="keyword">new</span> <span class="title class_">AsyncSeriesHook</span>([<span class="string">&#x27;compilation&#x27;</span>]),</span><br><span class="line">      <span class="attr">done</span>: <span class="keyword">new</span> <span class="title class_">AsyncSeriesHook</span>([<span class="string">&#x27;stats&#x27;</span>])</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 1. 初始化参数</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">run</span>.<span class="title function_">call</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 开始编译</span></span><br><span class="line">    <span class="keyword">const</span> compilation = <span class="keyword">new</span> <span class="title class_">Compilation</span>(<span class="variable language_">this</span>.<span class="property">options</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 构建模块</span></span><br><span class="line">    compilation.<span class="title function_">build</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 优化</span></span><br><span class="line">    compilation.<span class="title function_">optimize</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 输出资源</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">emit</span>.<span class="title function_">callAsync</span>(compilation, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="title function_">callback</span>(err);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 6. 完成构建</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">done</span>.<span class="title function_">callAsync</span>(compilation.<span class="title function_">getStats</span>(), <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="title function_">callback</span>(err);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-2-模块依赖图"><a href="#3-2-模块依赖图" class="headerlink" title="3.2 模块依赖图"></a>3.2 模块依赖图</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DependencyGraph</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">modules</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">addModule</span>(<span class="params"><span class="variable language_">module</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">modules</span>.<span class="title function_">set</span>(<span class="variable language_">module</span>.<span class="property">id</span>, &#123;</span><br><span class="line">      <span class="attr">id</span>: <span class="variable language_">module</span>.<span class="property">id</span>,</span><br><span class="line">      <span class="attr">dependencies</span>: <span class="variable language_">module</span>.<span class="property">dependencies</span>,</span><br><span class="line">      <span class="attr">code</span>: <span class="variable language_">module</span>.<span class="property">code</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createBundle</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> modules = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">modules</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">module</span> =&gt;</span> &#123;</span><br><span class="line">      modules += <span class="string">`</span></span><br><span class="line"><span class="string">        <span class="subst">$&#123;<span class="variable language_">module</span>.id&#125;</span>: function(module, exports, require) &#123;</span></span><br><span class="line"><span class="string">          <span class="subst">$&#123;<span class="variable language_">module</span>.code&#125;</span></span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">      `</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">      (function(modules) &#123;</span></span><br><span class="line"><span class="string">        function require(id) &#123;</span></span><br><span class="line"><span class="string">          const module = &#123; exports: &#123;&#125; &#125;;</span></span><br><span class="line"><span class="string">          modules[id](module, module.exports, require);</span></span><br><span class="line"><span class="string">          return module.exports;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        require(0);</span></span><br><span class="line"><span class="string">      &#125;)(&#123;<span class="subst">$&#123;modules&#125;</span>&#125;)</span></span><br><span class="line"><span class="string">    `</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-配置详解"><a href="#4-配置详解" class="headerlink" title="4. 配置详解"></a>4. 配置详解</h2><h3 id="4-1-基础配置"><a href="#4-1-基础配置" class="headerlink" title="4.1 基础配置"></a>4.1 基础配置</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">HtmlWebpackPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;html-webpack-plugin&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MiniCssExtractPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;mini-css-extract-plugin&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">// 模式</span></span><br><span class="line">  <span class="attr">mode</span>: <span class="string">&#x27;production&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 入口</span></span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&#x27;./src/index.js&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 输出</span></span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;dist&#x27;</span>),</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&#x27;[name].[contenthash].js&#x27;</span>,</span><br><span class="line">    <span class="attr">clean</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 模块处理</span></span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="attr">exclude</span>: <span class="regexp">/node_modules/</span>,</span><br><span class="line">        <span class="attr">use</span>: &#123;</span><br><span class="line">          <span class="attr">loader</span>: <span class="string">&#x27;babel-loader&#x27;</span>,</span><br><span class="line">          <span class="attr">options</span>: &#123;</span><br><span class="line">            <span class="attr">presets</span>: [<span class="string">&#x27;@babel/preset-env&#x27;</span>]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [</span><br><span class="line">          <span class="title class_">MiniCssExtractPlugin</span>.<span class="property">loader</span>,</span><br><span class="line">          <span class="string">&#x27;css-loader&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;postcss-loader&#x27;</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 插件</span></span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HtmlWebpackPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">template</span>: <span class="string">&#x27;./src/index.html&#x27;</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">MiniCssExtractPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">filename</span>: <span class="string">&#x27;css/[name].[contenthash].css&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 优化</span></span><br><span class="line">  <span class="attr">optimization</span>: &#123;</span><br><span class="line">    <span class="attr">minimize</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">minimizer</span>: [</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">TerserPlugin</span>(),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">CssMinimizerPlugin</span>()</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="5-Loader-体系"><a href="#5-Loader-体系" class="headerlink" title="5. Loader 体系"></a>5. Loader 体系</h2><h3 id="5-1-Loader-原理"><a href="#5-1-Loader-原理" class="headerlink" title="5.1 Loader 原理"></a>5.1 Loader 原理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自定义 loader 示例</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span>(<span class="params">source</span>) &#123;</span><br><span class="line">  <span class="comment">// loader 上下文</span></span><br><span class="line">  <span class="keyword">const</span> options = <span class="variable language_">this</span>.<span class="title function_">getOptions</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 异步处理</span></span><br><span class="line">  <span class="keyword">const</span> callback = <span class="variable language_">this</span>.<span class="title function_">async</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 源码转换</span></span><br><span class="line">  <span class="keyword">const</span> transformedSource = <span class="title function_">transform</span>(source, options);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 返回转换后的代码</span></span><br><span class="line">  <span class="title function_">callback</span>(<span class="literal">null</span>, transformedSource);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="5-2-常用-Loader"><a href="#5-2-常用-Loader" class="headerlink" title="5.2 常用 Loader"></a>5.2 常用 Loader</h3><h4 id="5-2-1-样式处理"><a href="#5-2-1-样式处理" class="headerlink" title="5.2.1 样式处理"></a>5.2.1 样式处理</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      <span class="comment">// CSS处理</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [</span><br><span class="line">          <span class="string">&#x27;style-loader&#x27;</span>,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&#x27;css-loader&#x27;</span>,</span><br><span class="line">            <span class="attr">options</span>: &#123;</span><br><span class="line">              <span class="attr">modules</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">importLoaders</span>: <span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&#x27;postcss-loader&#x27;</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// SASS处理</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.scss$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [</span><br><span class="line">          <span class="string">&#x27;style-loader&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;css-loader&#x27;</span>,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&#x27;sass-loader&#x27;</span>,</span><br><span class="line">            <span class="attr">options</span>: &#123;</span><br><span class="line">              <span class="attr">implementation</span>: <span class="built_in">require</span>(<span class="string">&#x27;sass&#x27;</span>),</span><br><span class="line">              <span class="attr">sassOptions</span>: &#123;</span><br><span class="line">                <span class="attr">fiber</span>: <span class="literal">false</span>,</span><br><span class="line">              &#125;,</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-2-2-文件处理"><a href="#5-2-2-文件处理" class="headerlink" title="5.2.2 文件处理"></a>5.2.2 文件处理</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      <span class="comment">// 图片优化</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.(png|jpg|gif)$/i</span>,</span><br><span class="line">        <span class="attr">use</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&#x27;image-webpack-loader&#x27;</span>,</span><br><span class="line">            <span class="attr">options</span>: &#123;</span><br><span class="line">              <span class="attr">mozjpeg</span>: &#123;</span><br><span class="line">                <span class="attr">progressive</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">quality</span>: <span class="number">65</span></span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="attr">optipng</span>: &#123;</span><br><span class="line">                <span class="attr">enabled</span>: <span class="literal">false</span>,</span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="attr">pngquant</span>: &#123;</span><br><span class="line">                <span class="attr">quality</span>: [<span class="number">0.65</span>, <span class="number">0.90</span>],</span><br><span class="line">                <span class="attr">speed</span>: <span class="number">4</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// SVG处理</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.svg$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [<span class="string">&#x27;@svgr/webpack&#x27;</span>]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="6-Plugin-体系"><a href="#6-Plugin-体系" class="headerlink" title="6. Plugin 体系"></a>6. Plugin 体系</h2><h3 id="6-1-Plugin-原理"><a href="#6-1-Plugin-原理" class="headerlink" title="6.1 Plugin 原理"></a>6.1 Plugin 原理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyPlugin</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span> = options;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">apply</span>(<span class="params">compiler</span>) &#123;</span><br><span class="line">    <span class="comment">// 注册钩子</span></span><br><span class="line">    compiler.<span class="property">hooks</span>.<span class="property">emit</span>.<span class="title function_">tapAsync</span>(</span><br><span class="line">      <span class="string">&#x27;MyPlugin&#x27;</span>,</span><br><span class="line">      <span class="function">(<span class="params">compilation, callback</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 添加资源</span></span><br><span class="line">        compilation.<span class="property">assets</span>[<span class="string">&#x27;file.txt&#x27;</span>] = &#123;</span><br><span class="line">          <span class="attr">source</span>: <span class="function">() =&gt;</span> <span class="string">&#x27;generated content&#x27;</span>,</span><br><span class="line">          <span class="attr">size</span>: <span class="function">() =&gt;</span> <span class="string">&#x27;generated content&#x27;</span>.<span class="property">length</span></span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="title function_">callback</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">MyPlugin</span>;</span><br></pre></td></tr></table></figure><h3 id="6-2-常用-Plugin"><a href="#6-2-常用-Plugin" class="headerlink" title="6.2 常用 Plugin"></a>6.2 常用 Plugin</h3><h4 id="6-2-1-优化类"><a href="#6-2-1-优化类" class="headerlink" title="6.2.1 优化类"></a>6.2.1 优化类</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">CompressionPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;compression-webpack-plugin&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">BundleAnalyzerPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;webpack-bundle-analyzer&#x27;</span>).<span class="property">BundleAnalyzerPlugin</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="comment">// Gzip压缩</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">CompressionPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">algorithm</span>: <span class="string">&#x27;gzip&#x27;</span>,</span><br><span class="line">      <span class="attr">test</span>: <span class="regexp">/\.(js|css|html|svg)$/</span>,</span><br><span class="line">      <span class="attr">threshold</span>: <span class="number">10240</span>,</span><br><span class="line">      <span class="attr">minRatio</span>: <span class="number">0.8</span></span><br><span class="line">    &#125;),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 包分析</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">BundleAnalyzerPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">analyzerMode</span>: <span class="string">&#x27;static&#x27;</span>,</span><br><span class="line">      <span class="attr">openAnalyzer</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">reportFilename</span>: <span class="string">&#x27;bundle-report.html&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-2-2-功能增强类"><a href="#6-2-2-功能增强类" class="headerlink" title="6.2.2 功能增强类"></a>6.2.2 功能增强类</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">CopyPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;copy-webpack-plugin&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">WorkboxPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;workbox-webpack-plugin&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="comment">// 复制静态资源</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">CopyPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">patterns</span>: [</span><br><span class="line">        &#123; <span class="attr">from</span>: <span class="string">&#x27;public&#x27;</span>, <span class="attr">to</span>: <span class="string">&#x27;assets&#x27;</span> &#125;</span><br><span class="line">      ],</span><br><span class="line">    &#125;),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// PWA支持</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">WorkboxPlugin</span>.<span class="title class_">GenerateSW</span>(&#123;</span><br><span class="line">      <span class="attr">clientsClaim</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">skipWaiting</span>: <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="7-性能优化"><a href="#7-性能优化" class="headerlink" title="7. 性能优化"></a>7. 性能优化</h2><h3 id="7-1-构建性能优化"><a href="#7-1-构建性能优化" class="headerlink" title="7.1 构建性能优化"></a>7.1 构建性能优化</h3><h4 id="7-1-1-缓存优化"><a href="#7-1-1-缓存优化" class="headerlink" title="7.1.1 缓存优化"></a>7.1.1 缓存优化</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">cache</span>: &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;filesystem&#x27;</span>,</span><br><span class="line">    <span class="attr">buildDependencies</span>: &#123;</span><br><span class="line">      <span class="attr">config</span>: [__filename]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;production-cache&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&#x27;babel-loader&#x27;</span>,</span><br><span class="line">            <span class="attr">options</span>: &#123;</span><br><span class="line">              <span class="attr">cacheDirectory</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">cacheCompression</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7-1-2-多进程构建"><a href="#7-1-2-多进程构建" class="headerlink" title="7.1.2 多进程构建"></a>7.1.2 多进程构建</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> thread = <span class="built_in">require</span>(<span class="string">&#x27;thread-loader&#x27;</span>);</span><br><span class="line"></span><br><span class="line">thread.<span class="title function_">warmup</span>(&#123;</span><br><span class="line">  <span class="attr">workers</span>: <span class="number">4</span>,</span><br><span class="line">  <span class="attr">workerParallelJobs</span>: <span class="number">50</span>,</span><br><span class="line">&#125;, [</span><br><span class="line">  <span class="string">&#x27;babel-loader&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;css-loader&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;vue-loader&#x27;</span></span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&#x27;thread-loader&#x27;</span>,</span><br><span class="line">            <span class="attr">options</span>: &#123;</span><br><span class="line">              <span class="attr">workers</span>: <span class="number">4</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&#x27;babel-loader&#x27;</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-2-运行时性能优化"><a href="#7-2-运行时性能优化" class="headerlink" title="7.2 运行时性能优化"></a>7.2 运行时性能优化</h3><h4 id="7-2-1-代码分割"><a href="#7-2-1-代码分割" class="headerlink" title="7.2.1 代码分割"></a>7.2.1 代码分割</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">optimization</span>: &#123;</span><br><span class="line">    <span class="attr">moduleIds</span>: <span class="string">&#x27;deterministic&#x27;</span>,</span><br><span class="line">    <span class="attr">runtimeChunk</span>: <span class="string">&#x27;single&#x27;</span>,</span><br><span class="line">    <span class="attr">splitChunks</span>: &#123;</span><br><span class="line">      <span class="attr">cacheGroups</span>: &#123;</span><br><span class="line">        <span class="attr">vendor</span>: &#123;</span><br><span class="line">          <span class="attr">test</span>: <span class="regexp">/[\\/]node_modules[\\/]/</span>,</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&#x27;vendors&#x27;</span>,</span><br><span class="line">          <span class="attr">chunks</span>: <span class="string">&#x27;all&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7-2-2-懒加载"><a href="#7-2-2-懒加载" class="headerlink" title="7.2.2 懒加载"></a>7.2.2 懒加载</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 路由懒加载</span></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/dashboard&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(</span><br><span class="line">      <span class="comment">/* webpackChunkName: &quot;dashboard&quot; */</span></span><br><span class="line">      <span class="comment">/* webpackPrefetch: true */</span></span><br><span class="line">      <span class="string">&#x27;./views/Dashboard.vue&#x27;</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 组件懒加载</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">MyComponent</span> = (<span class="params"></span>) =&gt; <span class="keyword">import</span>(<span class="string">&#x27;./components/MyComponent.vue&#x27;</span>);</span><br></pre></td></tr></table></figure><h2 id="8-实战应用"><a href="#8-实战应用" class="headerlink" title="8. 实战应用"></a>8. 实战应用</h2><h3 id="8-1-Vue项目配置"><a href="#8-1-Vue项目配置" class="headerlink" title="8.1 Vue项目配置"></a>8.1 Vue项目配置</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">VueLoaderPlugin</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;vue-loader&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.vue$/</span>,</span><br><span class="line">        <span class="attr">loader</span>: <span class="string">&#x27;vue-loader&#x27;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="attr">loader</span>: <span class="string">&#x27;babel-loader&#x27;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [<span class="string">&#x27;vue-style-loader&#x27;</span>, <span class="string">&#x27;css-loader&#x27;</span>]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">VueLoaderPlugin</span>(),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">DefinePlugin</span>(&#123;</span><br><span class="line">      <span class="attr">__VUE_OPTIONS_API__</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">__VUE_PROD_DEVTOOLS__</span>: <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-2-React项目配置"><a href="#8-2-React项目配置" class="headerlink" title="8.2 React项目配置"></a>8.2 React项目配置</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.(js|jsx)$/</span>,</span><br><span class="line">        <span class="attr">exclude</span>: <span class="regexp">/node_modules/</span>,</span><br><span class="line">        <span class="attr">use</span>: &#123;</span><br><span class="line">          <span class="attr">loader</span>: <span class="string">&#x27;babel-loader&#x27;</span>,</span><br><span class="line">          <span class="attr">options</span>: &#123;</span><br><span class="line">            <span class="attr">presets</span>: [</span><br><span class="line">              <span class="string">&#x27;@babel/preset-env&#x27;</span>,</span><br><span class="line">              <span class="string">&#x27;@babel/preset-react&#x27;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">plugins</span>: [</span><br><span class="line">              <span class="string">&#x27;@babel/plugin-transform-runtime&#x27;</span></span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="9-高级特性"><a href="#9-高级特性" class="headerlink" title="9. 高级特性"></a>9. 高级特性</h2><h3 id="9-1-模块联邦"><a href="#9-1-模块联邦" class="headerlink" title="9.1 模块联邦"></a>9.1 模块联邦</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">ModuleFederationPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;webpack&#x27;</span>).<span class="property">container</span>.<span class="property">ModuleFederationPlugin</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ModuleFederationPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;host&#x27;</span>,</span><br><span class="line">      <span class="attr">filename</span>: <span class="string">&#x27;remoteEntry.js&#x27;</span>,</span><br><span class="line">      <span class="attr">remotes</span>: &#123;</span><br><span class="line">        <span class="attr">app1</span>: <span class="string">&#x27;app1@http://localhost:3001/remoteEntry.js&#x27;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">shared</span>: &#123;</span><br><span class="line">        <span class="attr">react</span>: &#123; <span class="attr">singleton</span>: <span class="literal">true</span> &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="9-2-Tree-Shaking-增强"><a href="#9-2-Tree-Shaking-增强" class="headerlink" title="9.2 Tree Shaking 增强"></a>9.2 Tree Shaking 增强</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">optimization</span>: &#123;</span><br><span class="line">    <span class="attr">usedExports</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">sideEffects</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">innerGraph</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">concatenateModules</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="10-最佳实践"><a href="#10-最佳实践" class="headerlink" title="10. 最佳实践"></a>10. 最佳实践</h2><h3 id="10-1-项目结构"><a href="#10-1-项目结构" class="headerlink" title="10.1 项目结构"></a>10.1 项目结构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">project/</span><br><span class="line">├── build/                # webpack配置</span><br><span class="line">├── public/              # 静态资源</span><br><span class="line">├── src/                 # 源代码</span><br><span class="line">│   ├── assets/         # 资源文件</span><br><span class="line">│   ├── components/     # 组件</span><br><span class="line">│   ├── views/          # 页面</span><br><span class="line">│   ├── router/         # 路由</span><br><span class="line">│   ├── store/          # 状态管理</span><br><span class="line">│   ├── utils/          # 工具函数</span><br><span class="line">│   ├── App.vue         # 根组件</span><br><span class="line">│   └── main.js         # 入口文件</span><br><span class="line">├── tests/              # 测试文件</span><br><span class="line">├── .env.*              # 环境变量</span><br><span class="line">├── package.json        # 项目配置</span><br><span class="line">└── README.md           # 项目说明</span><br></pre></td></tr></table></figure><h3 id="10-2-性能检查清单"><a href="#10-2-性能检查清单" class="headerlink" title="10.2 性能检查清单"></a>10.2 性能检查清单</h3><ul><li><input disabled="" type="checkbox"> 使用最新版本的 Webpack</li><li><input disabled="" type="checkbox"> 配置合适的 sourceMap</li><li><input disabled="" type="checkbox"> 启用压缩和代码分割</li><li><input disabled="" type="checkbox"> 利用缓存机制</li><li><input disabled="" type="checkbox"> 优化图片资源</li><li><input disabled="" type="checkbox"> 配置 CDN</li><li><input disabled="" type="checkbox"> 使用 Tree Shaking</li><li><input disabled="" type="checkbox"> 配置合理的 splitChunks</li><li><input disabled="" type="checkbox"> 使用动态导入</li><li><input disabled="" type="checkbox"> 优化第三方库的使用</li></ul><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>⚠️ 定期更新依赖包<br>⚠️ 关注构建性能指标<br>⚠️ 避免过度优化<br>⚠️ 保持配置的可维护性<br>⚠️ 做好错误处理和降级策略</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Webpack-完全指南：从入门到精通&quot;&gt;&lt;a href=&quot;#Webpack-完全指南：从入门到精通&quot; class=&quot;headerlink&quot; title=&quot;Webpack 完全指南：从入门到精通&quot;&gt;&lt;/a&gt;Webpack 完全指南：从入门到精通&lt;/h1&gt;&lt;h2 i</summary>
      
    
    
    
    
    <category term="入门" scheme="https://aoayaoa.github.io/tags/%E5%85%A5%E9%97%A8/"/>
    
    <category term="webpack" scheme="https://aoayaoa.github.io/tags/webpack/"/>
    
  </entry>
  
</feed>
