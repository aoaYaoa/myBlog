<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>BabylonJS | aoaYaoa</title><meta name="author" content="aoaYaoa"><meta name="copyright" content="aoaYaoa"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="BabylonJS 完整离线开发指南📋 目录 BabylonJS 完整离线开发指南 📋 目录 🚀 BabylonJS 简介 💻 离线环境配置 🎯 核心概念 🎬 Engine 引擎详解 🎭 Scene 场景详解 📷 Camera 相机系统详解 💡 Light 光照系统详解 🎨 Material 材质系统详解 🎭 Mesh 网格系统详解 🎬 Animation 动画系统详解 �">
<meta property="og:type" content="article">
<meta property="og:title" content="BabylonJS">
<meta property="og:url" content="https://aoayaoa.github.io/2025/07/31/babylonjs/index.html">
<meta property="og:site_name" content="aoaYaoa">
<meta property="og:description" content="BabylonJS 完整离线开发指南📋 目录 BabylonJS 完整离线开发指南 📋 目录 🚀 BabylonJS 简介 💻 离线环境配置 🎯 核心概念 🎬 Engine 引擎详解 🎭 Scene 场景详解 📷 Camera 相机系统详解 💡 Light 光照系统详解 🎨 Material 材质系统详解 🎭 Mesh 网格系统详解 🎬 Animation 动画系统详解 �">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://aoayaoa.github.io/img/babylonjs.png">
<meta property="article:published_time" content="2025-07-30T16:00:00.000Z">
<meta property="article:modified_time" content="2025-08-08T03:24:51.301Z">
<meta property="article:author" content="aoaYaoa">
<meta property="article:tag" content="BabylonJS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://aoayaoa.github.io/img/babylonjs.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "BabylonJS",
  "url": "https://aoayaoa.github.io/2025/07/31/babylonjs/",
  "image": "https://aoayaoa.github.io/img/babylonjs.png",
  "datePublished": "2025-07-30T16:00:00.000Z",
  "dateModified": "2025-08-08T03:24:51.301Z",
  "author": [
    {
      "@type": "Person",
      "name": "aoaYaoa",
      "url": "https://aoayaoa.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://aoayaoa.github.io/2025/07/31/babylonjs/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: aoaYaoa","link":"链接: ","source":"来源: aoaYaoa","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'BabylonJS',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/base.css"><script src="/js/resources.js"></script><link rel="alternate" href="/atom.xml" title="aoaYaoa" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">13</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">15</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-book-open"></i><span> 文章</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-calendar-alt"></i><span> 日常</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fas fa-comment-dots"></i><span> 说说</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/resources/"><i class="fa-fw fas fa-compass"></i><span> 资源</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(/img/babylonjs.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/img/avatar.jpg" alt="Logo"><span class="site-name">aoaYaoa</span></a><a class="nav-page-title" href="/"><span class="site-name">BabylonJS</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-book-open"></i><span> 文章</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-calendar-alt"></i><span> 日常</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fas fa-comment-dots"></i><span> 说说</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/resources/"><i class="fa-fw fas fa-compass"></i><span> 资源</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">BabylonJS</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-07-30T16:00:00.000Z" title="发表于 2025-07-31 00:00:00">2025-07-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-08-08T03:24:51.301Z" title="更新于 2025-08-08 11:24:51">2025-08-08</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">28.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>148分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="BabylonJS-完整离线开发指南"><a href="#BabylonJS-完整离线开发指南" class="headerlink" title="BabylonJS 完整离线开发指南"></a>BabylonJS 完整离线开发指南</h1><h2 id="📋-目录"><a href="#📋-目录" class="headerlink" title="📋 目录"></a>📋 目录</h2><ul>
<li><a href="#babylonjs-%E5%AE%8C%E6%95%B4%E7%A6%BB%E7%BA%BF%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97">BabylonJS 完整离线开发指南</a><ul>
<li><a href="#-%E7%9B%AE%E5%BD%95">📋 目录</a></li>
<li><a href="#-babylonjs-%E7%AE%80%E4%BB%8B">🚀 BabylonJS 简介</a></li>
<li><a href="#-%E7%A6%BB%E7%BA%BF%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE">💻 离线环境配置</a></li>
<li><a href="#-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5">🎯 核心概念</a></li>
<li><a href="#-engine-%E5%BC%95%E6%93%8E%E8%AF%A6%E8%A7%A3">🎬 Engine 引擎详解</a></li>
<li><a href="#-scene-%E5%9C%BA%E6%99%AF%E8%AF%A6%E8%A7%A3">🎭 Scene 场景详解</a></li>
<li><a href="#-camera-%E7%9B%B8%E6%9C%BA%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">📷 Camera 相机系统详解</a></li>
<li><a href="#-light-%E5%85%89%E7%85%A7%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">💡 Light 光照系统详解</a></li>
<li><a href="#-material-%E6%9D%90%E8%B4%A8%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">🎨 Material 材质系统详解</a></li>
<li><a href="#-mesh-%E7%BD%91%E6%A0%BC%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">🎭 Mesh 网格系统详解</a></li>
<li><a href="#-animation-%E5%8A%A8%E7%94%BB%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">🎬 Animation 动画系统详解</a></li>
<li><a href="#-particlesystem-%E7%B2%92%E5%AD%90%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">🎆 ParticleSystem 粒子系统详解</a></li>
<li><a href="#-audio-%E9%9F%B3%E9%A2%91%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">🔊 Audio 音频系统详解</a></li>
<li><a href="#-input-%E8%BE%93%E5%85%A5%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">🎮 Input 输入系统详解</a></li>
<li><a href="#-asset-%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E8%AF%A6%E8%A7%A3">🔧 Asset 资源管理详解</a></li>
<li><a href="#-performance-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E8%AF%A6%E8%A7%A3">⚡ Performance 性能优化详解</a></li>
<li><a href="#-%E4%B8%8E-cesium-%E5%90%8C%E5%B1%8F%E5%8F%A0%E5%8A%A0%E5%8D%95%E5%9B%BE%E5%B1%82%E5%AE%9E%E7%8E%B0">🤝 与 Cesium 同屏叠加（单图层）实现</a></li>
</ul>
</li>
<li><a href="#-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">🎯 最佳实践</a></li>
</ul>
<h2 id="🚀-BabylonJS-简介"><a href="#🚀-BabylonJS-简介" class="headerlink" title="🚀 BabylonJS 简介"></a>🚀 BabylonJS 简介</h2><p>BabylonJS 是一个强大的 3D JavaScript 引擎，用于在浏览器中创建令人惊叹的 3D 体验。它支持 WebGL、WebGPU 和 WebXR，为开发者提供了完整的 3D 开发工具链。</p>
<h3 id="核心特性"><a href="#核心特性" class="headerlink" title="核心特性"></a>核心特性</h3><ul>
<li><strong>跨平台支持</strong> - Web、移动端、桌面应用</li>
<li><strong>现代渲染</strong> - WebGL 2.0、WebGPU 支持</li>
<li><strong>完整工具链</strong> - 编辑器、调试器、优化工具</li>
<li><strong>丰富生态</strong> - 插件系统、社区资源</li>
<li><strong>高性能</strong> - 优化的渲染管线和内存管理</li>
</ul>
<h2 id="💻-离线环境配置"><a href="#💻-离线环境配置" class="headerlink" title="💻 离线环境配置"></a>💻 离线环境配置</h2><h3 id="Vite-配置"><a href="#Vite-配置" class="headerlink" title="Vite 配置"></a>Vite 配置</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.js - BabylonJS离线开发配置</span></span><br><span class="line"><span class="keyword">import</span> &#123; defineConfig &#125; <span class="keyword">from</span> <span class="string">&#x27;vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; resolve &#125; <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">define</span>: &#123;</span><br><span class="line">    <span class="attr">BABYLON_BASE_URL</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="string">&#x27;/babylon/&#x27;</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">publicDir</span>: <span class="string">&#x27;public&#x27;</span>,</span><br><span class="line">  <span class="attr">build</span>: &#123;</span><br><span class="line">    <span class="attr">rollupOptions</span>: &#123;</span><br><span class="line">      <span class="attr">external</span>: [],</span><br><span class="line">      <span class="attr">input</span>: &#123;</span><br><span class="line">        <span class="attr">main</span>: <span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;index.html&#x27;</span>),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">server</span>: &#123;</span><br><span class="line">    <span class="attr">fs</span>: &#123;</span><br><span class="line">      <span class="attr">allow</span>: [<span class="string">&#x27;..&#x27;</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;Cross-Origin-Embedder-Policy&#x27;</span>: <span class="string">&#x27;require-corp&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;Cross-Origin-Opener-Policy&#x27;</span>: <span class="string">&#x27;same-origin&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">optimizeDeps</span>: &#123;</span><br><span class="line">    <span class="attr">include</span>: [</span><br><span class="line">      <span class="string">&#x27;@babylonjs/core&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;@babylonjs/loaders&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;@babylonjs/materials&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;@babylonjs/post-processes&#x27;</span>,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">worker</span>: &#123;</span><br><span class="line">    <span class="attr">format</span>: <span class="string">&#x27;es&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">project/</span><br><span class="line">├── public/</span><br><span class="line">│   ├── models/          # 3D模型文件</span><br><span class="line">│   ├── textures/        # 纹理贴图</span><br><span class="line">│   ├── sounds/          # 音频文件</span><br><span class="line">│   └── environments/    # 环境贴图</span><br><span class="line">├── src/</span><br><span class="line">│   ├── babylon/</span><br><span class="line">│   │   ├── engine.js    # 引擎配置</span><br><span class="line">│   │   ├── scene.js     # 场景管理</span><br><span class="line">│   │   ├── cameras.js   # 相机控制</span><br><span class="line">│   │   ├── lights.js    # 光照设置</span><br><span class="line">│   │   ├── materials.js # 材质管理</span><br><span class="line">│   │   ├── meshes.js    # 网格操作</span><br><span class="line">│   │   └── animations.js # 动画控制</span><br><span class="line">│   └── main.js</span><br><span class="line">└── package.json</span><br></pre></td></tr></table></figure>

<h3 id="依赖安装"><a href="#依赖安装" class="headerlink" title="依赖安装"></a>依赖安装</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;dependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@babylonjs/core&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^6.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@babylonjs/loaders&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^6.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@babylonjs/materials&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^6.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@babylonjs/post-processes&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^6.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@babylonjs/procedural-textures&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^6.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@babylonjs/serializers&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^6.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@babylonjs/node-geometry-editor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^6.0.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;devDependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;vite&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^4.0.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="基础初始化"><a href="#基础初始化" class="headerlink" title="基础初始化"></a>基础初始化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js - BabylonJS基础初始化</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Engine</span>, <span class="title class_">Scene</span>, <span class="title class_">FreeCamera</span>, <span class="title class_">HemisphericLight</span>, <span class="title class_">Vector3</span>, <span class="title class_">MeshBuilder</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@babylonjs/core&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;@babylonjs/loaders/glTF&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 离线环境配置</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">BABYLON_BASE_URL</span> = <span class="string">&#x27;/babylon/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BabylonApp</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">canvasId</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(canvasId)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span> = <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">init</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 创建引擎</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span> = <span class="keyword">new</span> <span class="title class_">Engine</span>(<span class="variable language_">this</span>.<span class="property">canvas</span>, <span class="literal">true</span>, &#123;</span><br><span class="line">      <span class="attr">preserveDrawingBuffer</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">stencil</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">disableWebGL2Support</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建场景</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = <span class="keyword">new</span> <span class="title class_">Scene</span>(<span class="variable language_">this</span>.<span class="property">engine</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置基础场景</span></span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">createScene</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动渲染循环</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">startRenderLoop</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理窗口大小变化</span></span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;resize&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">resize</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">createScene</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 创建相机</span></span><br><span class="line">    <span class="keyword">const</span> camera = <span class="keyword">new</span> <span class="title class_">FreeCamera</span>(<span class="string">&#x27;camera&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">5</span>, -<span class="number">10</span>), <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    camera.<span class="title function_">setTarget</span>(<span class="title class_">Vector3</span>.<span class="title class_">Zero</span>())</span><br><span class="line">    camera.<span class="title function_">attachControls</span>(<span class="variable language_">this</span>.<span class="property">canvas</span>, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建光源</span></span><br><span class="line">    <span class="keyword">const</span> light = <span class="keyword">new</span> <span class="title class_">HemisphericLight</span>(<span class="string">&#x27;light&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>), <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    light.<span class="property">intensity</span> = <span class="number">0.7</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建基础几何体</span></span><br><span class="line">    <span class="keyword">const</span> sphere = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateSphere</span>(<span class="string">&#x27;sphere&#x27;</span>, &#123; <span class="attr">diameter</span>: <span class="number">2</span> &#125;, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    sphere.<span class="property">position</span>.<span class="property">y</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> ground = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateGround</span>(<span class="string">&#x27;ground&#x27;</span>, &#123; <span class="attr">width</span>: <span class="number">6</span>, <span class="attr">height</span>: <span class="number">6</span> &#125;, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">startRenderLoop</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">runRenderLoop</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">render</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>?.<span class="title function_">dispose</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>?.<span class="title function_">dispose</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动应用</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">BabylonApp</span>(<span class="string">&#x27;babylonCanvas&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="🎯-核心概念"><a href="#🎯-核心概念" class="headerlink" title="🎯 核心概念"></a>🎯 核心概念</h2><h3 id="坐标系统"><a href="#坐标系统" class="headerlink" title="坐标系统"></a>坐标系统</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BabylonJS坐标系统详解</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CoordinateSystem</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 右手坐标系</span></span><br><span class="line">  <span class="comment">// X轴: 向右为正</span></span><br><span class="line">  <span class="comment">// Y轴: 向上为正</span></span><br><span class="line">  <span class="comment">// Z轴: 向前为正（朝向观察者）</span></span><br><span class="line">  <span class="title function_">createCoordinateAxes</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> axisLength = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// X轴 - 红色</span></span><br><span class="line">    <span class="keyword">const</span> xAxis = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateCylinder</span>(</span><br><span class="line">      <span class="string">&#x27;xAxis&#x27;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">height</span>: axisLength,</span><br><span class="line">        <span class="attr">diameterTop</span>: <span class="number">0.1</span>,</span><br><span class="line">        <span class="attr">diameterBottom</span>: <span class="number">0.1</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">    )</span><br><span class="line">    xAxis.<span class="property">rotation</span>.<span class="property">z</span> = -<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">2</span></span><br><span class="line">    xAxis.<span class="property">position</span>.<span class="property">x</span> = axisLength / <span class="number">2</span></span><br><span class="line">    xAxis.<span class="property">material</span> = <span class="variable language_">this</span>.<span class="title function_">createAxisMaterial</span>(<span class="string">&#x27;red&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Y轴 - 绿色</span></span><br><span class="line">    <span class="keyword">const</span> yAxis = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateCylinder</span>(</span><br><span class="line">      <span class="string">&#x27;yAxis&#x27;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">height</span>: axisLength,</span><br><span class="line">        <span class="attr">diameterTop</span>: <span class="number">0.1</span>,</span><br><span class="line">        <span class="attr">diameterBottom</span>: <span class="number">0.1</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">    )</span><br><span class="line">    yAxis.<span class="property">position</span>.<span class="property">y</span> = axisLength / <span class="number">2</span></span><br><span class="line">    yAxis.<span class="property">material</span> = <span class="variable language_">this</span>.<span class="title function_">createAxisMaterial</span>(<span class="string">&#x27;green&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Z轴 - 蓝色</span></span><br><span class="line">    <span class="keyword">const</span> zAxis = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateCylinder</span>(</span><br><span class="line">      <span class="string">&#x27;zAxis&#x27;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">height</span>: axisLength,</span><br><span class="line">        <span class="attr">diameterTop</span>: <span class="number">0.1</span>,</span><br><span class="line">        <span class="attr">diameterBottom</span>: <span class="number">0.1</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">    )</span><br><span class="line">    zAxis.<span class="property">rotation</span>.<span class="property">x</span> = <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">2</span></span><br><span class="line">    zAxis.<span class="property">position</span>.<span class="property">z</span> = axisLength / <span class="number">2</span></span><br><span class="line">    zAxis.<span class="property">material</span> = <span class="variable language_">this</span>.<span class="title function_">createAxisMaterial</span>(<span class="string">&#x27;blue&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; xAxis, yAxis, zAxis &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createAxisMaterial</span>(<span class="params">color</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">StandardMaterial</span>(<span class="string">`<span class="subst">$&#123;color&#125;</span>Material`</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    material.<span class="property">diffuseColor</span> = <span class="title class_">Color3</span>.<span class="title class_">FromHexString</span>(</span><br><span class="line">      color === <span class="string">&#x27;red&#x27;</span> ? <span class="string">&#x27;#ff0000&#x27;</span> : color === <span class="string">&#x27;green&#x27;</span> ? <span class="string">&#x27;#00ff00&#x27;</span> : <span class="string">&#x27;#0000ff&#x27;</span>,</span><br><span class="line">    )</span><br><span class="line">    material.<span class="property">emissiveColor</span> = material.<span class="property">diffuseColor</span>.<span class="title function_">clone</span>()</span><br><span class="line">    <span class="keyword">return</span> material</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 位置变换</span></span><br><span class="line">  <span class="title function_">transformPosition</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 本地坐标到世界坐标</span></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateBox</span>(<span class="string">&#x27;box&#x27;</span>, &#123; <span class="attr">size</span>: <span class="number">1</span> &#125;, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="keyword">const</span> localPosition = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">const</span> worldPosition = <span class="title class_">Vector3</span>.<span class="title class_">TransformCoordinates</span>(localPosition, mesh.<span class="title function_">getWorldMatrix</span>())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 世界坐标到本地坐标</span></span><br><span class="line">    <span class="keyword">const</span> worldToLocal = <span class="title class_">Vector3</span>.<span class="title class_">TransformCoordinates</span>(</span><br><span class="line">      worldPosition,</span><br><span class="line">      <span class="title class_">Matrix</span>.<span class="title class_">Invert</span>(mesh.<span class="title function_">getWorldMatrix</span>()),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Local:&#x27;</span>, localPosition)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;World:&#x27;</span>, worldPosition)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Back to Local:&#x27;</span>, worldToLocal)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; localPosition, worldPosition, worldToLocal &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 旋转变换</span></span><br><span class="line">  <span class="title function_">transformRotation</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateBox</span>(<span class="string">&#x27;rotatedBox&#x27;</span>, &#123; <span class="attr">size</span>: <span class="number">1</span> &#125;, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 欧拉角设置</span></span><br><span class="line">    mesh.<span class="property">rotation</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>, <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">6</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 四元数设置</span></span><br><span class="line">    mesh.<span class="property">rotationQuaternion</span> = <span class="title class_">Quaternion</span>.<span class="title class_">FromEulerAngles</span>(<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>, <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">6</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从一个方向旋转到另一个方向</span></span><br><span class="line">    <span class="keyword">const</span> fromDirection = <span class="title class_">Vector3</span>.<span class="title class_">Forward</span>()</span><br><span class="line">    <span class="keyword">const</span> toDirection = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>).<span class="title function_">normalize</span>()</span><br><span class="line">    <span class="keyword">const</span> rotation = <span class="title class_">Quaternion</span>.<span class="title class_">FromLookRotation</span>(toDirection, <span class="title class_">Vector3</span>.<span class="title class_">Up</span>())</span><br><span class="line">    mesh.<span class="property">rotationQuaternion</span> = rotation</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 缩放变换</span></span><br><span class="line">  <span class="title function_">transformScale</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateBox</span>(<span class="string">&#x27;scaledBox&#x27;</span>, &#123; <span class="attr">size</span>: <span class="number">1</span> &#125;, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 统一缩放</span></span><br><span class="line">    mesh.<span class="property">scaling</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 非统一缩放</span></span><br><span class="line">    mesh.<span class="property">scaling</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">2</span>, <span class="number">1</span>, <span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="数学工具"><a href="#数学工具" class="headerlink" title="数学工具"></a>数学工具</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BabylonJS数学工具集</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MathUtils</span> &#123;</span><br><span class="line">  <span class="comment">// Vector3 详解</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">vector3Examples</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 创建向量</span></span><br><span class="line">    <span class="keyword">const</span> v1 = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">const</span> v2 = <span class="title class_">Vector3</span>.<span class="title class_">Zero</span>() <span class="comment">// (0, 0, 0)</span></span><br><span class="line">    <span class="keyword">const</span> v3 = <span class="title class_">Vector3</span>.<span class="title class_">One</span>() <span class="comment">// (1, 1, 1)</span></span><br><span class="line">    <span class="keyword">const</span> v4 = <span class="title class_">Vector3</span>.<span class="title class_">Up</span>() <span class="comment">// (0, 1, 0)</span></span><br><span class="line">    <span class="keyword">const</span> v5 = <span class="title class_">Vector3</span>.<span class="title class_">Forward</span>() <span class="comment">// (0, 0, 1)</span></span><br><span class="line">    <span class="keyword">const</span> v6 = <span class="title class_">Vector3</span>.<span class="title class_">Right</span>() <span class="comment">// (1, 0, 0)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向量运算</span></span><br><span class="line">    <span class="keyword">const</span> sum = v1.<span class="title function_">add</span>(v2) <span class="comment">// 向量加法</span></span><br><span class="line">    <span class="keyword">const</span> diff = v1.<span class="title function_">subtract</span>(v2) <span class="comment">// 向量减法</span></span><br><span class="line">    <span class="keyword">const</span> scaled = v1.<span class="title function_">scale</span>(<span class="number">2</span>) <span class="comment">// 标量乘法</span></span><br><span class="line">    <span class="keyword">const</span> dot = <span class="title class_">Vector3</span>.<span class="title class_">Dot</span>(v1, v2) <span class="comment">// 点积</span></span><br><span class="line">    <span class="keyword">const</span> cross = <span class="title class_">Vector3</span>.<span class="title class_">Cross</span>(v1, v2) <span class="comment">// 叉积</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向量属性</span></span><br><span class="line">    <span class="keyword">const</span> length = v1.<span class="title function_">length</span>() <span class="comment">// 向量长度</span></span><br><span class="line">    <span class="keyword">const</span> lengthSq = v1.<span class="title function_">lengthSquared</span>() <span class="comment">// 长度平方</span></span><br><span class="line">    <span class="keyword">const</span> normalized = v1.<span class="title function_">normalize</span>() <span class="comment">// 单位向量</span></span><br><span class="line">    <span class="keyword">const</span> distance = <span class="title class_">Vector3</span>.<span class="title class_">Distance</span>(v1, v2) <span class="comment">// 两点距离</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向量插值</span></span><br><span class="line">    <span class="keyword">const</span> lerp = <span class="title class_">Vector3</span>.<span class="title class_">Lerp</span>(v1, v2, <span class="number">0.5</span>) <span class="comment">// 线性插值</span></span><br><span class="line">    <span class="keyword">const</span> slerp = <span class="title class_">Vector3</span>.<span class="title class_">Slerp</span>(v1, v2, <span class="number">0.5</span>) <span class="comment">// 球面插值</span></span><br><span class="line">    <span class="keyword">const</span> hermite = <span class="title class_">Vector3</span>.<span class="title class_">Hermite</span>(v1, v2, v3, v4, <span class="number">0.5</span>) <span class="comment">// Hermite插值</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; v1, v2, sum, diff, scaled, dot, cross, length, normalized, lerp &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Matrix 详解</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">matrixExamples</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 创建矩阵</span></span><br><span class="line">    <span class="keyword">const</span> identity = <span class="title class_">Matrix</span>.<span class="title class_">Identity</span>() <span class="comment">// 单位矩阵</span></span><br><span class="line">    <span class="keyword">const</span> translation = <span class="title class_">Matrix</span>.<span class="title class_">Translation</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>) <span class="comment">// 平移矩阵</span></span><br><span class="line">    <span class="keyword">const</span> rotationX = <span class="title class_">Matrix</span>.<span class="title class_">RotationX</span>(<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>) <span class="comment">// X轴旋转</span></span><br><span class="line">    <span class="keyword">const</span> rotationY = <span class="title class_">Matrix</span>.<span class="title class_">RotationY</span>(<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>) <span class="comment">// Y轴旋转</span></span><br><span class="line">    <span class="keyword">const</span> rotationZ = <span class="title class_">Matrix</span>.<span class="title class_">RotationZ</span>(<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>) <span class="comment">// Z轴旋转</span></span><br><span class="line">    <span class="keyword">const</span> scaling = <span class="title class_">Matrix</span>.<span class="title class_">Scaling</span>(<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>) <span class="comment">// 缩放矩阵</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复合变换</span></span><br><span class="line">    <span class="keyword">const</span> trs = <span class="title class_">Matrix</span>.<span class="title class_">Compose</span>(</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>), <span class="comment">// 缩放</span></span><br><span class="line">      <span class="title class_">Quaternion</span>.<span class="title class_">FromEulerAngles</span>(<span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>, <span class="number">0</span>), <span class="comment">// 旋转</span></span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>), <span class="comment">// 平移</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 矩阵运算</span></span><br><span class="line">    <span class="keyword">const</span> multiplied = translation.<span class="title function_">multiply</span>(rotationY)</span><br><span class="line">    <span class="keyword">const</span> inverted = <span class="title class_">Matrix</span>.<span class="title class_">Invert</span>(trs)</span><br><span class="line">    <span class="keyword">const</span> transposed = <span class="title class_">Matrix</span>.<span class="title class_">Transpose</span>(trs)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从矩阵提取信息</span></span><br><span class="line">    <span class="keyword">const</span> decomposed = trs.<span class="title function_">decompose</span>()</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="attr">scaling</span>: s, <span class="attr">rotation</span>: r, <span class="attr">translation</span>: t &#125; = decomposed</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; identity, translation, trs, multiplied, inverted, decomposed &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Quaternion 详解</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">quaternionExamples</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 创建四元数</span></span><br><span class="line">    <span class="keyword">const</span> identity = <span class="title class_">Quaternion</span>.<span class="title class_">Identity</span>() <span class="comment">// 单位四元数</span></span><br><span class="line">    <span class="keyword">const</span> fromEuler = <span class="title class_">Quaternion</span>.<span class="title class_">FromEulerAngles</span>(<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>, <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">6</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">const</span> fromAxis = <span class="title class_">Quaternion</span>.<span class="title class_">RotationAxis</span>(<span class="title class_">Vector3</span>.<span class="title class_">Up</span>(), <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>)</span><br><span class="line">    <span class="keyword">const</span> fromYawPitchRoll = <span class="title class_">Quaternion</span>.<span class="title class_">RotationYawPitchRoll</span>(<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>, <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">6</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 四元数运算</span></span><br><span class="line">    <span class="keyword">const</span> multiplied = fromEuler.<span class="title function_">multiply</span>(fromAxis)</span><br><span class="line">    <span class="keyword">const</span> conjugate = <span class="title class_">Quaternion</span>.<span class="title class_">Conjugate</span>(fromEuler)</span><br><span class="line">    <span class="keyword">const</span> inverse = <span class="title class_">Quaternion</span>.<span class="title class_">Inverse</span>(fromEuler)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 四元数插值</span></span><br><span class="line">    <span class="keyword">const</span> slerp = <span class="title class_">Quaternion</span>.<span class="title class_">Slerp</span>(fromEuler, fromAxis, <span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转换</span></span><br><span class="line">    <span class="keyword">const</span> toEuler = fromEuler.<span class="title function_">toEulerAngles</span>()</span><br><span class="line">    <span class="keyword">const</span> toMatrix = fromEuler.<span class="title function_">toRotationMatrix</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 方向计算</span></span><br><span class="line">    <span class="keyword">const</span> forward = <span class="title class_">Vector3</span>.<span class="title class_">Forward</span>()</span><br><span class="line">    <span class="keyword">const</span> rotatedForward = forward.<span class="title function_">applyRotationQuaternion</span>(fromEuler)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; identity, fromEuler, multiplied, slerp, toEuler, rotatedForward &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Color 详解</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">colorExamples</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 创建颜色</span></span><br><span class="line">    <span class="keyword">const</span> red = <span class="title class_">Color3</span>.<span class="title class_">Red</span>() <span class="comment">// (1, 0, 0)</span></span><br><span class="line">    <span class="keyword">const</span> green = <span class="title class_">Color3</span>.<span class="title class_">Green</span>() <span class="comment">// (0, 1, 0)</span></span><br><span class="line">    <span class="keyword">const</span> blue = <span class="title class_">Color3</span>.<span class="title class_">Blue</span>() <span class="comment">// (0, 0, 1)</span></span><br><span class="line">    <span class="keyword">const</span> white = <span class="title class_">Color3</span>.<span class="title class_">White</span>() <span class="comment">// (1, 1, 1)</span></span><br><span class="line">    <span class="keyword">const</span> black = <span class="title class_">Color3</span>.<span class="title class_">Black</span>() <span class="comment">// (0, 0, 0)</span></span><br><span class="line">    <span class="keyword">const</span> custom = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.5</span>, <span class="number">0.7</span>, <span class="number">0.9</span>) <span class="comment">// 自定义RGB</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从十六进制创建</span></span><br><span class="line">    <span class="keyword">const</span> fromHex = <span class="title class_">Color3</span>.<span class="title class_">FromHexString</span>(<span class="string">&#x27;#ff6600&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从HSV创建</span></span><br><span class="line">    <span class="keyword">const</span> fromHSV = <span class="title class_">Color3</span>.<span class="title class_">FromHSV</span>(<span class="number">120</span>, <span class="number">0.8</span>, <span class="number">0.9</span>) <span class="comment">// 色相、饱和度、明度</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 颜色运算</span></span><br><span class="line">    <span class="keyword">const</span> added = red.<span class="title function_">add</span>(green) <span class="comment">// 颜色加法</span></span><br><span class="line">    <span class="keyword">const</span> scaled = red.<span class="title function_">scale</span>(<span class="number">0.5</span>) <span class="comment">// 颜色缩放</span></span><br><span class="line">    <span class="keyword">const</span> lerp = <span class="title class_">Color3</span>.<span class="title class_">Lerp</span>(red, blue, <span class="number">0.5</span>) <span class="comment">// 颜色插值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Color4 (带透明度)</span></span><br><span class="line">    <span class="keyword">const</span> transparent = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.5</span>) <span class="comment">// 半透明红色</span></span><br><span class="line">    <span class="keyword">const</span> fromColor3 = <span class="keyword">new</span> <span class="title class_">Color4</span>(red.<span class="property">r</span>, red.<span class="property">g</span>, red.<span class="property">b</span>, <span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 颜色转换</span></span><br><span class="line">    <span class="keyword">const</span> toHex = red.<span class="title function_">toHexString</span>() <span class="comment">// 转为十六进制</span></span><br><span class="line">    <span class="keyword">const</span> toHSV = red.<span class="title function_">toHSV</span>() <span class="comment">// 转为HSV</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; red, fromHex, fromHSV, added, lerp, transparent, toHex &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="🎬-Engine-引擎详解"><a href="#🎬-Engine-引擎详解" class="headerlink" title="🎬 Engine 引擎详解"></a>🎬 Engine 引擎详解</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Engine 引擎系统完整配置</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EngineManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">canvas, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span> = canvas</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span> = <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engineOptions</span> = <span class="variable language_">this</span>.<span class="title function_">getDefaultOptions</span>(options)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">init</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getDefaultOptions</span>(<span class="params">userOptions</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// antialias: boolean - 抗锯齿</span></span><br><span class="line">        <span class="attr">antialias</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// preserveDrawingBuffer: boolean - 保留绘制缓冲区</span></span><br><span class="line">        <span class="attr">preserveDrawingBuffer</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// stencil: boolean - 启用模板缓冲区</span></span><br><span class="line">        <span class="attr">stencil</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// alpha: boolean - 启用透明度</span></span><br><span class="line">        <span class="attr">alpha</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// premultipliedAlpha: boolean - 预乘透明度</span></span><br><span class="line">        <span class="attr">premultipliedAlpha</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// powerPreference: string - GPU功耗偏好</span></span><br><span class="line">        <span class="attr">powerPreference</span>: <span class="string">&#x27;high-performance&#x27;</span>, <span class="comment">// &#x27;default&#x27;, &#x27;high-performance&#x27;, &#x27;low-power&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// failIfMajorPerformanceCaveat: boolean - 性能警告时失败</span></span><br><span class="line">        <span class="attr">failIfMajorPerformanceCaveat</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// doNotHandleContextLost: boolean - 不处理上下文丢失</span></span><br><span class="line">        <span class="attr">doNotHandleContextLost</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// audioEngine: boolean - 启用音频引擎</span></span><br><span class="line">        <span class="attr">audioEngine</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// disableWebGL2Support: boolean - 禁用WebGL2</span></span><br><span class="line">        <span class="attr">disableWebGL2Support</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// xrCompatible: boolean - WebXR兼容</span></span><br><span class="line">        <span class="attr">xrCompatible</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// useHighPrecisionFloats: boolean - 使用高精度浮点数</span></span><br><span class="line">        <span class="attr">useHighPrecisionFloats</span>: <span class="literal">false</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      userOptions,</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 创建引擎</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">engine</span> = <span class="keyword">new</span> <span class="title class_">Engine</span>(<span class="variable language_">this</span>.<span class="property">canvas</span>, <span class="variable language_">this</span>.<span class="property">engineOptions</span>.<span class="property">antialias</span>, <span class="variable language_">this</span>.<span class="property">engineOptions</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 设置引擎属性</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">configureEngine</span>()</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 绑定事件</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">bindEvents</span>()</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;BabylonJS Engine 初始化成功&#x27;</span>)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;WebGL版本:&#x27;</span>, <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">webGLVersion</span>)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;GPU信息:&#x27;</span>, <span class="variable language_">this</span>.<span class="title function_">getGPUInfo</span>())</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;引擎初始化失败:&#x27;</span>, error)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleInitError</span>(error)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">configureEngine</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 设置渲染精度</span></span><br><span class="line">    <span class="comment">// 作用: 控制渲染精度，影响性能和质量</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">setHardwareScalingLevel</span>(<span class="number">1.0</span>) <span class="comment">// 1.0 = 原生分辨率，0.5 = 一半分辨率</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置视口</span></span><br><span class="line">    <span class="comment">// 作用: 定义渲染区域</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">setViewport</span>(<span class="keyword">new</span> <span class="title class_">Viewport</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启用自适应设备像素比</span></span><br><span class="line">    <span class="comment">// 作用: 自动适配高DPI显示器</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">enableAdaptiveDevicePixelRatio</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置最大纹理大小</span></span><br><span class="line">    <span class="comment">// 作用: 限制纹理大小，防止内存溢出</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">getCaps</span>().<span class="property">maxTextureSize</span> = <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">getCaps</span>().<span class="property">maxTextureSize</span>, <span class="number">4096</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启用深度测试</span></span><br><span class="line">    <span class="comment">// 作用: 正确处理物体前后关系</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">setDepthFunction</span>(<span class="title class_">Engine</span>.<span class="property">LEQUAL</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置默认材质</span></span><br><span class="line">    <span class="comment">// 作用: 为没有材质的网格提供默认材质</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">createDefaultRenderingPipeline</span> = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">bindEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 上下文丢失事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">onContextLostObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;WebGL上下文丢失&#x27;</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleContextLost</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 上下文恢复事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">onContextRestoredObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;WebGL上下文已恢复&#x27;</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleContextRestored</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开始渲染事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">onBeginFrameObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onBeginFrame</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 结束渲染事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">onEndFrameObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onEndFrame</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 窗口大小变化</span></span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;resize&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleResize</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 页面可见性变化</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;visibilitychange&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleVisibilityChange</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 渲染循环管理</span></span><br><span class="line">  <span class="title function_">startRenderLoop</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">runRenderLoop</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (scene.<span class="property">activeCamera</span>) &#123;</span><br><span class="line">        scene.<span class="title function_">render</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">stopRenderLoop</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">stopRenderLoop</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 性能监控</span></span><br><span class="line">  <span class="title function_">enablePerformanceMonitoring</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// FPS监控</span></span><br><span class="line">    <span class="keyword">const</span> fpsCounter = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    fpsCounter.<span class="property">style</span>.<span class="property">position</span> = <span class="string">&#x27;absolute&#x27;</span></span><br><span class="line">    fpsCounter.<span class="property">style</span>.<span class="property">top</span> = <span class="string">&#x27;10px&#x27;</span></span><br><span class="line">    fpsCounter.<span class="property">style</span>.<span class="property">left</span> = <span class="string">&#x27;10px&#x27;</span></span><br><span class="line">    fpsCounter.<span class="property">style</span>.<span class="property">color</span> = <span class="string">&#x27;white&#x27;</span></span><br><span class="line">    fpsCounter.<span class="property">style</span>.<span class="property">fontFamily</span> = <span class="string">&#x27;monospace&#x27;</span></span><br><span class="line">    fpsCounter.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;rgba(0,0,0,0.5)&#x27;</span></span><br><span class="line">    fpsCounter.<span class="property">style</span>.<span class="property">padding</span> = <span class="string">&#x27;5px&#x27;</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(fpsCounter)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">onEndFrameObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> fps = <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">getFps</span>()</span><br><span class="line">      <span class="keyword">const</span> deltaTime = <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">getDeltaTime</span>()</span><br><span class="line">      fpsCounter.<span class="property">textContent</span> = <span class="string">`FPS: <span class="subst">$&#123;fps.toFixed(<span class="number">1</span>)&#125;</span> | Delta: <span class="subst">$&#123;deltaTime.toFixed(<span class="number">2</span>)&#125;</span>ms`</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 性能分析</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">enablePerformanceMonitoring</span> = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取引擎信息</span></span><br><span class="line">  <span class="title function_">getEngineInfo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> caps = <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">getCaps</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="comment">// 基础信息</span></span><br><span class="line">      <span class="attr">webGLVersion</span>: <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">webGLVersion</span>,</span><br><span class="line">      <span class="attr">isWebGL2</span>: <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">isWebGL2</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 硬件信息</span></span><br><span class="line">      <span class="attr">maxTextureSize</span>: caps.<span class="property">maxTextureSize</span>,</span><br><span class="line">      <span class="attr">maxCubeTextureSize</span>: caps.<span class="property">maxCubeTextureSize</span>,</span><br><span class="line">      <span class="attr">maxRenderTextureSize</span>: caps.<span class="property">maxRenderTextureSize</span>,</span><br><span class="line">      <span class="attr">maxVertexAttribs</span>: caps.<span class="property">maxVertexAttribs</span>,</span><br><span class="line">      <span class="attr">maxVaryingVectors</span>: caps.<span class="property">maxVaryingVectors</span>,</span><br><span class="line">      <span class="attr">maxFragmentUniformVectors</span>: caps.<span class="property">maxFragmentUniformVectors</span>,</span><br><span class="line">      <span class="attr">maxVertexUniformVectors</span>: caps.<span class="property">maxVertexUniformVectors</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 扩展支持</span></span><br><span class="line">      <span class="attr">standardDerivatives</span>: caps.<span class="property">standardDerivatives</span>,</span><br><span class="line">      <span class="attr">textureFloat</span>: caps.<span class="property">textureFloat</span>,</span><br><span class="line">      <span class="attr">textureHalfFloat</span>: caps.<span class="property">textureHalfFloat</span>,</span><br><span class="line">      <span class="attr">textureAnisotropicFilterExtension</span>: caps.<span class="property">textureAnisotropicFilterExtension</span>,</span><br><span class="line">      <span class="attr">instancedArrays</span>: caps.<span class="property">instancedArrays</span>,</span><br><span class="line">      <span class="attr">uintIndices</span>: caps.<span class="property">uintIndices</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 渲染信息</span></span><br><span class="line">      <span class="attr">hardwareScalingLevel</span>: <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">getHardwareScalingLevel</span>(),</span><br><span class="line">      <span class="attr">loadedTexturesCache</span>: <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">getLoadedTexturesCache</span>().<span class="property">length</span>,</span><br><span class="line">      <span class="attr">activeRenderLoops</span>: <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">activeRenderLoops</span>.<span class="property">length</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// GPU信息</span></span><br><span class="line">  <span class="title function_">getGPUInfo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> gl = <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">_gl</span></span><br><span class="line">    <span class="keyword">const</span> debugInfo = gl.<span class="title function_">getExtension</span>(<span class="string">&#x27;WEBGL_debug_renderer_info&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (debugInfo) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">vendor</span>: gl.<span class="title function_">getParameter</span>(debugInfo.<span class="property">UNMASKED_VENDOR_WEBGL</span>),</span><br><span class="line">        <span class="attr">renderer</span>: gl.<span class="title function_">getParameter</span>(debugInfo.<span class="property">UNMASKED_RENDERER_WEBGL</span>),</span><br><span class="line">        <span class="attr">version</span>: gl.<span class="title function_">getParameter</span>(gl.<span class="property">VERSION</span>),</span><br><span class="line">        <span class="attr">shadingLanguageVersion</span>: gl.<span class="title function_">getParameter</span>(gl.<span class="property">SHADING_LANGUAGE_VERSION</span>),</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">vendor</span>: gl.<span class="title function_">getParameter</span>(gl.<span class="property">VENDOR</span>),</span><br><span class="line">      <span class="attr">renderer</span>: gl.<span class="title function_">getParameter</span>(gl.<span class="property">RENDERER</span>),</span><br><span class="line">      <span class="attr">version</span>: gl.<span class="title function_">getParameter</span>(gl.<span class="property">VERSION</span>),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 事件处理</span></span><br><span class="line">  <span class="title function_">handleContextLost</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 停止渲染循环</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">stopRenderLoop</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 显示加载提示</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">showContextLostMessage</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">handleContextRestored</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 隐藏加载提示</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">hideContextLostMessage</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重新开始渲染</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">scene</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">startRenderLoop</span>(<span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">handleResize</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 延迟执行，避免频繁调用</span></span><br><span class="line">    <span class="built_in">clearTimeout</span>(<span class="variable language_">this</span>.<span class="property">resizeTimeout</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">resizeTimeout</span> = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">resize</span>()</span><br><span class="line">    &#125;, <span class="number">100</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">handleVisibilityChange</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">hidden</span>) &#123;</span><br><span class="line">      <span class="comment">// 页面隐藏时暂停渲染</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">stopRenderLoop</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 页面显示时恢复渲染</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">scene</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">startRenderLoop</span>(<span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">handleInitError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 显示错误信息</span></span><br><span class="line">    <span class="keyword">const</span> errorDiv = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    errorDiv.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">      &lt;div style=&quot;position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); </span></span><br><span class="line"><span class="string">                  background: rgba(255,0,0,0.8); color: white; padding: 20px; border-radius: 10px;&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;h3&gt;BabylonJS 初始化失败&lt;/h3&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;错误信息: <span class="subst">$&#123;error.message&#125;</span>&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;请检查浏览器是否支持WebGL&lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;/div&gt;</span></span><br><span class="line"><span class="string">    `</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(errorDiv)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onBeginFrame</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 每帧开始时的处理</span></span><br><span class="line">    <span class="comment">// 可以在这里进行性能统计、资源管理等</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onEndFrame</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 每帧结束时的处理</span></span><br><span class="line">    <span class="comment">// 可以在这里进行清理工作、统计信息更新等</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">showContextLostMessage</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> messageDiv = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    messageDiv.<span class="property">id</span> = <span class="string">&#x27;context-lost-message&#x27;</span></span><br><span class="line">    messageDiv.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">      &lt;div style=&quot;position: fixed; top: 0; left: 0; width: 100%; height: 100%; </span></span><br><span class="line"><span class="string">                  background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999;&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div style=&quot;background: white; padding: 20px; border-radius: 10px; text-align: center;&quot;&gt;</span></span><br><span class="line"><span class="string">          &lt;h3&gt;连接丢失&lt;/h3&gt;</span></span><br><span class="line"><span class="string">          &lt;p&gt;正在尝试重新连接...&lt;/p&gt;</span></span><br><span class="line"><span class="string">          &lt;div class=&quot;spinner&quot; style=&quot;margin: 10px auto; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 2s linear infinite;&quot;&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">      &lt;/div&gt;</span></span><br><span class="line"><span class="string">    `</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(messageDiv)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">hideContextLostMessage</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> messageDiv = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;context-lost-message&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> (messageDiv) &#123;</span><br><span class="line">      messageDiv.<span class="title function_">remove</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 资源清理</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 停止渲染循环</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">stopRenderLoop</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 移除事件监听</span></span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;resize&#x27;</span>, <span class="variable language_">this</span>.<span class="property">handleResize</span>)</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;visibilitychange&#x27;</span>, <span class="variable language_">this</span>.<span class="property">handleVisibilityChange</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理引擎</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">engine</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">dispose</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">engine</span> = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> canvas = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;babylonCanvas&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> engineManager = <span class="keyword">new</span> <span class="title class_">EngineManager</span>(canvas, &#123;</span><br><span class="line">  <span class="attr">antialias</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">preserveDrawingBuffer</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">powerPreference</span>: <span class="string">&#x27;high-performance&#x27;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启用性能监控</span></span><br><span class="line">engineManager.<span class="title function_">enablePerformanceMonitoring</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取引擎信息</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;引擎信息:&#x27;</span>, engineManager.<span class="title function_">getEngineInfo</span>())</span><br></pre></td></tr></table></figure>

<h2 id="🎭-Scene-场景详解"><a href="#🎭-Scene-场景详解" class="headerlink" title="🎭 Scene 场景详解"></a>🎭 Scene 场景详解</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Scene 场景系统完整管理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SceneManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">engine</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span> = engine</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sceneOptions</span> = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">init</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 创建场景</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = <span class="keyword">new</span> <span class="title class_">Scene</span>(<span class="variable language_">this</span>.<span class="property">engine</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置场景</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">configureScene</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置环境</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupEnvironment</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绑定事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">bindEvents</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">configureScene</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 物理引擎配置</span></span><br><span class="line">    <span class="comment">// 作用: 启用物理模拟</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">enablePhysics</span>(<span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, -<span class="number">9.81</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">CannonJSPlugin</span>())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 碰撞检测</span></span><br><span class="line">    <span class="comment">// 作用: 启用网格间碰撞检测</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">collisionsEnabled</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重力设置</span></span><br><span class="line">    <span class="comment">// 作用: 设置场景重力</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">gravity</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, -<span class="number">0.9</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 动画速度</span></span><br><span class="line">    <span class="comment">// 作用: 控制动画播放速度倍率</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">animationTimeScale</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 渲染组</span></span><br><span class="line">    <span class="comment">// 作用: 控制渲染顺序</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">setRenderingOrder</span>(</span><br><span class="line">      <span class="number">0</span>, <span class="comment">// opaque sorting</span></span><br><span class="line">      <span class="number">1</span>, <span class="comment">// alpha test sorting</span></span><br><span class="line">      <span class="number">2</span>,</span><br><span class="line">    ) <span class="comment">// transparent sorting</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自动清理</span></span><br><span class="line">    <span class="comment">// 作用: 自动清理未使用的资源</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">autoClear</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">autoClearDepthAndStencil</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// LOD (Level of Detail) 配置</span></span><br><span class="line">    <span class="comment">// 作用: 距离相关的细节层次</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">lodGenerationOffset</span> = <span class="number">0.5</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">lodGenerationTransitionTime</span> = <span class="number">250</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupEnvironment</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 环境纹理</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupEnvironmentTexture</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 雾效</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupFog</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 天空盒</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupSkybox</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 全局光照</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupGlobalIllumination</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupEnvironmentTexture</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// HDR环境纹理</span></span><br><span class="line">    <span class="comment">// 作用: 提供真实的环境光照和反射</span></span><br><span class="line">    <span class="keyword">const</span> hdrTexture = <span class="title class_">CubeTexture</span>.<span class="title class_">CreateFromPrefilteredData</span>(</span><br><span class="line">      <span class="string">&#x27;/environments/environment.dds&#x27;</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">    )</span><br><span class="line">    hdrTexture.<span class="property">name</span> = <span class="string">&#x27;environmentTexture&#x27;</span></span><br><span class="line">    hdrTexture.<span class="property">gammaSpace</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">environmentTexture</span> = hdrTexture</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">createDefaultSkybox</span>(hdrTexture, <span class="literal">true</span>, <span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 环境强度</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">environmentIntensity</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// IBL (Image Based Lighting)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">imageProcessingConfiguration</span>.<span class="property">exposure</span> = <span class="number">1.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">imageProcessingConfiguration</span>.<span class="property">contrast</span> = <span class="number">1.0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">imageProcessingConfiguration</span>.<span class="property">toneMappingEnabled</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">imageProcessingConfiguration</span>.<span class="property">toneMappingType</span> =</span><br><span class="line">      <span class="title class_">ImageProcessingConfiguration</span>.<span class="property">TONEMAPPING_ACES</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupFog</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 雾效类型</span></span><br><span class="line">    <span class="comment">// FOG_NONE: 无雾</span></span><br><span class="line">    <span class="comment">// FOG_EXP: 指数雾</span></span><br><span class="line">    <span class="comment">// FOG_EXP2: 二次指数雾</span></span><br><span class="line">    <span class="comment">// FOG_LINEAR: 线性雾</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">fogMode</span> = <span class="title class_">Scene</span>.<span class="property">FOGMODE_LINEAR</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 雾的颜色</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">fogColor</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.9</span>, <span class="number">0.9</span>, <span class="number">0.85</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 线性雾参数</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">fogStart</span> = <span class="number">20.0</span> <span class="comment">// 雾开始距离</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">fogEnd</span> = <span class="number">60.0</span> <span class="comment">// 雾结束距离</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指数雾参数（当使用指数雾时）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">fogDensity</span> = <span class="number">0.01</span> <span class="comment">// 雾密度</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupSkybox</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 程序化天空盒</span></span><br><span class="line">    <span class="keyword">const</span> skybox = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateSphere</span>(<span class="string">&#x27;skyBox&#x27;</span>, &#123; <span class="attr">diameter</span>: <span class="number">1000</span> &#125;, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="keyword">const</span> skyboxMaterial = <span class="keyword">new</span> <span class="title class_">StandardMaterial</span>(<span class="string">&#x27;skyBox&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 天空盒材质配置</span></span><br><span class="line">    skyboxMaterial.<span class="property">backFaceCulling</span> = <span class="literal">false</span></span><br><span class="line">    skyboxMaterial.<span class="property">reflectionTexture</span> = <span class="keyword">new</span> <span class="title class_">CubeTexture</span>(<span class="string">&#x27;/textures/skybox/skybox&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    skyboxMaterial.<span class="property">reflectionTexture</span>.<span class="property">coordinatesMode</span> = <span class="title class_">Texture</span>.<span class="property">SKYBOX_MODE</span></span><br><span class="line">    skyboxMaterial.<span class="property">diffuseColor</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    skyboxMaterial.<span class="property">specularColor</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    skybox.<span class="property">material</span> = skyboxMaterial</span><br><span class="line">    skybox.<span class="property">infiniteDistance</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> skybox</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupGlobalIllumination</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 图像处理配置</span></span><br><span class="line">    <span class="keyword">const</span> imageProcessing = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">imageProcessingConfiguration</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 色调映射</span></span><br><span class="line">    imageProcessing.<span class="property">toneMappingEnabled</span> = <span class="literal">true</span></span><br><span class="line">    imageProcessing.<span class="property">toneMappingType</span> = <span class="title class_">ImageProcessingConfiguration</span>.<span class="property">TONEMAPPING_ACES</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 曝光度</span></span><br><span class="line">    imageProcessing.<span class="property">exposure</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对比度</span></span><br><span class="line">    imageProcessing.<span class="property">contrast</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 色彩平衡</span></span><br><span class="line">    imageProcessing.<span class="property">colorGradingEnabled</span> = <span class="literal">true</span></span><br><span class="line">    imageProcessing.<span class="property">colorGradingTexture</span> = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;/textures/colorgrading_lut.png&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Bloom效果</span></span><br><span class="line">    imageProcessing.<span class="property">vignetteEnabled</span> = <span class="literal">true</span></span><br><span class="line">    imageProcessing.<span class="property">vignetteWeight</span> = <span class="number">1.5</span></span><br><span class="line">    imageProcessing.<span class="property">vignetteStretch</span> = <span class="number">0.5</span></span><br><span class="line">    imageProcessing.<span class="property">vignetteCameraFov</span> = <span class="number">0.5</span></span><br><span class="line">    imageProcessing.<span class="property">vignetteColor</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">bindEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 场景准备就绪</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onReadyObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;场景准备就绪&#x27;</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onSceneReady</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 渲染前事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onBeforeRender</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 渲染后事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onAfterRenderObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onAfterRender</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 相机变化事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onActiveCameraChanged</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onActiveCameraChanged</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新网格添加事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onNewMeshAddedObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onNewMeshAdded</span>(mesh)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 网格移除事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onMeshRemovedObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onMeshRemoved</span>(mesh)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指针事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">actionManager</span> = <span class="keyword">new</span> <span class="title class_">ActionManager</span>(<span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupPointerEvents</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupPointerEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 鼠标点击事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onPointerObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">pointerInfo</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">switch</span> (pointerInfo.<span class="property">type</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">PointerEventTypes</span>.<span class="property">POINTERDOWN</span>:</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onPointerDown</span>(pointerInfo)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">PointerEventTypes</span>.<span class="property">POINTERUP</span>:</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onPointerUp</span>(pointerInfo)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">PointerEventTypes</span>.<span class="property">POINTERMOVE</span>:</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onPointerMove</span>(pointerInfo)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">PointerEventTypes</span>.<span class="property">POINTERWHEEL</span>:</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onPointerWheel</span>(pointerInfo)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拾取信息</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onPointerPick</span> = <span class="function">(<span class="params">evt, pickInfo</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (pickInfo.<span class="property">hit</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;拾取到网格:&#x27;</span>, pickInfo.<span class="property">pickedMesh</span>?.<span class="property">name</span>)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">onMeshPicked</span>(pickInfo.<span class="property">pickedMesh</span>, pickInfo.<span class="property">pickedPoint</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 场景优化</span></span><br><span class="line">  <span class="title function_">optimizeScene</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 合并网格</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">mergeMeshes</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置渲染组</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupRenderingGroups</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启用实例化</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">enableInstancing</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置LOD</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupLevelOfDetail</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 冻结变换矩阵</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">freezeTransformMatrices</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">mergeMeshes</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 合并静态网格以减少绘制调用</span></span><br><span class="line">    <span class="keyword">const</span> staticMeshes = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">meshes</span>.<span class="title function_">filter</span>(</span><br><span class="line">      <span class="function">(<span class="params">mesh</span>) =&gt;</span> mesh.<span class="property">name</span>.<span class="title function_">startsWith</span>(<span class="string">&#x27;static_&#x27;</span>) &amp;&amp; !mesh.<span class="property">skeleton</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (staticMeshes.<span class="property">length</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> merged = <span class="title class_">Mesh</span>.<span class="title class_">MergeMeshes</span>(staticMeshes, <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">true</span>)</span><br><span class="line">      <span class="keyword">if</span> (merged) &#123;</span><br><span class="line">        merged.<span class="property">name</span> = <span class="string">&#x27;merged_static_meshes&#x27;</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`合并了 <span class="subst">$&#123;staticMeshes.length&#125;</span> 个静态网格`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupRenderingGroups</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 渲染组：0-不透明物体，1-透明物体，2-UI元素</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (mesh.<span class="property">material</span> &amp;&amp; mesh.<span class="property">material</span>.<span class="property">alpha</span> &lt; <span class="number">1.0</span>) &#123;</span><br><span class="line">        mesh.<span class="property">renderingGroupId</span> = <span class="number">1</span> <span class="comment">// 透明物体</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mesh.<span class="property">renderingGroupId</span> = <span class="number">0</span> <span class="comment">// 不透明物体</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">enableInstancing</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 为重复的网格启用实例化</span></span><br><span class="line">    <span class="keyword">const</span> trees = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">meshes</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> mesh.<span class="property">name</span>.<span class="title function_">includes</span>(<span class="string">&#x27;tree&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> (trees.<span class="property">length</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> sourceMesh = trees[<span class="number">0</span>]</span><br><span class="line">      <span class="keyword">const</span> instances = []</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; trees.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> instance = sourceMesh.<span class="title function_">createInstance</span>(<span class="string">`tree_instance_<span class="subst">$&#123;i&#125;</span>`</span>)</span><br><span class="line">        instance.<span class="property">position</span> = trees[i].<span class="property">position</span></span><br><span class="line">        instance.<span class="property">rotation</span> = trees[i].<span class="property">rotation</span></span><br><span class="line">        instance.<span class="property">scaling</span> = trees[i].<span class="property">scaling</span></span><br><span class="line">        instances.<span class="title function_">push</span>(instance)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 移除原始网格</span></span><br><span class="line">        trees[i].<span class="title function_">dispose</span>()</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`创建了 <span class="subst">$&#123;instances.length&#125;</span> 个树木实例`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupLevelOfDetail</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 为大型网格设置LOD</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (mesh.<span class="title function_">getTotalVertices</span>() &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">        <span class="comment">// 创建简化版本</span></span><br><span class="line">        <span class="keyword">const</span> lod1 = mesh.<span class="title function_">clone</span>(<span class="string">`<span class="subst">$&#123;mesh.name&#125;</span>_lod1`</span>)</span><br><span class="line">        <span class="keyword">const</span> lod2 = mesh.<span class="title function_">clone</span>(<span class="string">`<span class="subst">$&#123;mesh.name&#125;</span>_lod2`</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里应该使用简化算法创建低模</span></span><br><span class="line">        <span class="comment">// 示例：可以集成第三方简化库</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置LOD距离</span></span><br><span class="line">        mesh.<span class="title function_">addLODLevel</span>(<span class="number">50</span>, lod1)</span><br><span class="line">        mesh.<span class="title function_">addLODLevel</span>(<span class="number">100</span>, lod2)</span><br><span class="line">        mesh.<span class="title function_">addLODLevel</span>(<span class="number">200</span>, <span class="literal">null</span>) <span class="comment">// 完全隐藏</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">freezeTransformMatrices</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 冻结不再移动的网格的变换矩阵</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (mesh.<span class="property">name</span>.<span class="title function_">includes</span>(<span class="string">&#x27;static_&#x27;</span>) || mesh.<span class="property">name</span>.<span class="title function_">includes</span>(<span class="string">&#x27;building_&#x27;</span>)) &#123;</span><br><span class="line">        mesh.<span class="title function_">freezeWorldMatrix</span>()</span><br><span class="line">        mesh.<span class="property">doNotSyncBoundingInfo</span> = <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 场景序列化和加载</span></span><br><span class="line">  <span class="title function_">serializeScene</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 序列化场景为JSON</span></span><br><span class="line">    <span class="keyword">const</span> serializedScene = <span class="title class_">SceneSerializer</span>.<span class="title class_">Serialize</span>(<span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存到本地存储</span></span><br><span class="line">    <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;babylonjs_scene&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(serializedScene))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> serializedScene</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadScene</span>(<span class="params">sceneData</span>) &#123;</span><br><span class="line">    <span class="comment">// 从序列化数据加载场景</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> sceneData === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">      sceneData = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(sceneData)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理当前场景</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">dispose</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建新场景</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = <span class="keyword">new</span> <span class="title class_">Scene</span>(<span class="variable language_">this</span>.<span class="property">engine</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 导入序列化数据</span></span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">SceneLoader</span>.<span class="title class_">ImportMeshAsync</span>(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, sceneData, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重新配置场景</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">configureScene</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">bindEvents</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 事件回调</span></span><br><span class="line">  <span class="title function_">onSceneReady</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 场景准备就绪后的处理</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">optimizeScene</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onBeforeRender</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 每帧渲染前的处理</span></span><br><span class="line">    <span class="comment">// 可以在这里更新动画、物理等</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onAfterRender</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 每帧渲染后的处理</span></span><br><span class="line">    <span class="comment">// 可以在这里进行后处理、UI更新等</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onActiveCameraChanged</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 相机切换时的处理</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;活动相机已切换:&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">activeCamera</span>?.<span class="property">name</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onNewMeshAdded</span>(<span class="params">mesh</span>) &#123;</span><br><span class="line">    <span class="comment">// 新网格添加时的处理</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;新网格已添加:&#x27;</span>, mesh.<span class="property">name</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自动设置物理属性</span></span><br><span class="line">    <span class="keyword">if</span> (mesh.<span class="property">name</span>.<span class="title function_">includes</span>(<span class="string">&#x27;physics_&#x27;</span>)) &#123;</span><br><span class="line">      mesh.<span class="property">physicsImpostor</span> = <span class="keyword">new</span> <span class="title class_">PhysicsImpostor</span>(</span><br><span class="line">        mesh,</span><br><span class="line">        <span class="title class_">PhysicsImpostor</span>.<span class="property">BoxImpostor</span>,</span><br><span class="line">        &#123; <span class="attr">mass</span>: <span class="number">1</span> &#125;,</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onMeshRemoved</span>(<span class="params">mesh</span>) &#123;</span><br><span class="line">    <span class="comment">// 网格移除时的处理</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;网格已移除:&#x27;</span>, mesh.<span class="property">name</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onPointerDown</span>(<span class="params">pointerInfo</span>) &#123;</span><br><span class="line">    <span class="comment">// 鼠标按下事件处理</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onPointerUp</span>(<span class="params">pointerInfo</span>) &#123;</span><br><span class="line">    <span class="comment">// 鼠标释放事件处理</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onPointerMove</span>(<span class="params">pointerInfo</span>) &#123;</span><br><span class="line">    <span class="comment">// 鼠标移动事件处理</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onPointerWheel</span>(<span class="params">pointerInfo</span>) &#123;</span><br><span class="line">    <span class="comment">// 鼠标滚轮事件处理</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onMeshPicked</span>(<span class="params">mesh, pickPoint</span>) &#123;</span><br><span class="line">    <span class="comment">// 网格拾取事件处理</span></span><br><span class="line">    <span class="keyword">if</span> (mesh) &#123;</span><br><span class="line">      <span class="comment">// 高亮被拾取的网格</span></span><br><span class="line">      mesh.<span class="property">renderOutline</span> = <span class="literal">true</span></span><br><span class="line">      mesh.<span class="property">outlineColor</span> = <span class="title class_">Color3</span>.<span class="title class_">Red</span>()</span><br><span class="line">      mesh.<span class="property">outlineWidth</span> = <span class="number">0.02</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 取消其他网格的高亮</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">m</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (m !== mesh) &#123;</span><br><span class="line">          m.<span class="property">renderOutline</span> = <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 资源清理</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">scene</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">dispose</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span> = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> sceneManager = <span class="keyword">new</span> <span class="title class_">SceneManager</span>(engine)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 序列化场景</span></span><br><span class="line"><span class="keyword">const</span> sceneData = sceneManager.<span class="title function_">serializeScene</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载场景</span></span><br><span class="line"><span class="comment">// sceneManager.loadScene(sceneData)</span></span><br></pre></td></tr></table></figure>

<h2 id="📷-Camera-相机系统详解"><a href="#📷-Camera-相机系统详解" class="headerlink" title="📷 Camera 相机系统详解"></a>📷 Camera 相机系统详解</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Camera 相机系统完整管理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CameraManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cameras</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">activeCamera</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupDefaultCameras</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupDefaultCameras</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 自由相机 - 第一人称视角</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createFreeCamera</span>(<span class="string">&#x27;freeCamera&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">5</span>, -<span class="number">10</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 弧形旋转相机 - 第三人称视角</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createArcRotateCamera</span>(<span class="string">&#x27;arcCamera&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通用相机 - 混合模式</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createUniversalCamera</span>(<span class="string">&#x27;universalCamera&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">5</span>, -<span class="number">10</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置默认相机</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setActiveCamera</span>(<span class="string">&#x27;arcCamera&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 自由相机 (FreeCamera)</span></span><br><span class="line">  <span class="title function_">createFreeCamera</span>(<span class="params">name, position</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="keyword">new</span> <span class="title class_">FreeCamera</span>(name, position, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 基础配置</span></span><br><span class="line">    camera.<span class="title function_">setTarget</span>(<span class="title class_">Vector3</span>.<span class="title class_">Zero</span>())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 移动速度配置</span></span><br><span class="line">    <span class="comment">// speed: number - 移动速度</span></span><br><span class="line">    camera.<span class="property">speed</span> = <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// angularSensibility: number - 鼠标灵敏度</span></span><br><span class="line">    camera.<span class="property">angularSensibility</span> = <span class="number">2000</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 键盘控制配置</span></span><br><span class="line">    camera.<span class="property">keysUp</span> = [<span class="number">87</span>] <span class="comment">// W键</span></span><br><span class="line">    camera.<span class="property">keysDown</span> = [<span class="number">83</span>] <span class="comment">// S键</span></span><br><span class="line">    camera.<span class="property">keysLeft</span> = [<span class="number">65</span>] <span class="comment">// A键</span></span><br><span class="line">    camera.<span class="property">keysRight</span> = [<span class="number">68</span>] <span class="comment">// D键</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 惯性配置</span></span><br><span class="line">    <span class="comment">// inertia: number - 惯性系数 (0-1)</span></span><br><span class="line">    camera.<span class="property">inertia</span> = <span class="number">0.9</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 碰撞检测</span></span><br><span class="line">    camera.<span class="property">checkCollisions</span> = <span class="literal">true</span></span><br><span class="line">    camera.<span class="property">collisionRadius</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0.5</span>, <span class="number">1.8</span>, <span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重力</span></span><br><span class="line">    camera.<span class="property">applyGravity</span> = <span class="literal">true</span></span><br><span class="line">    camera.<span class="property">needMoveForGravity</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 椭球体碰撞</span></span><br><span class="line">    camera.<span class="property">ellipsoid</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0.5</span>, <span class="number">1</span>, <span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跳跃</span></span><br><span class="line">    camera.<span class="property">setUpVector</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">set</span>(name, camera)</span><br><span class="line">    <span class="keyword">return</span> camera</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 弧形旋转相机 (ArcRotateCamera)</span></span><br><span class="line">  <span class="title function_">createArcRotateCamera</span>(<span class="params">name, target, radius</span>) &#123;</span><br><span class="line">    <span class="comment">// alpha: 水平角度 (弧度)</span></span><br><span class="line">    <span class="comment">// beta: 垂直角度 (弧度)</span></span><br><span class="line">    <span class="comment">// radius: 距离目标的距离</span></span><br><span class="line">    <span class="keyword">const</span> camera = <span class="keyword">new</span> <span class="title class_">ArcRotateCamera</span>(</span><br><span class="line">      name,</span><br><span class="line">      -<span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">2</span>,</span><br><span class="line">      <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">2.5</span>,</span><br><span class="line">      radius,</span><br><span class="line">      target,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 角度限制</span></span><br><span class="line">    camera.<span class="property">lowerAlphaLimit</span> = -<span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span> <span class="comment">// 水平最小角度</span></span><br><span class="line">    camera.<span class="property">upperAlphaLimit</span> = <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span> <span class="comment">// 水平最大角度</span></span><br><span class="line">    camera.<span class="property">lowerBetaLimit</span> = <span class="number">0.1</span> <span class="comment">// 垂直最小角度</span></span><br><span class="line">    camera.<span class="property">upperBetaLimit</span> = <span class="title class_">Math</span>.<span class="property">PI</span> - <span class="number">0.1</span> <span class="comment">// 垂直最大角度</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 距离限制</span></span><br><span class="line">    camera.<span class="property">lowerRadiusLimit</span> = <span class="number">2</span> <span class="comment">// 最小距离</span></span><br><span class="line">    camera.<span class="property">upperRadiusLimit</span> = <span class="number">50</span> <span class="comment">// 最大距离</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 平移限制</span></span><br><span class="line">    camera.<span class="property">lowerTargetOffsetLimit</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">10</span>, -<span class="number">10</span>, -<span class="number">10</span>)</span><br><span class="line">    camera.<span class="property">upperTargetOffsetLimit</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 鼠标控制配置</span></span><br><span class="line">    camera.<span class="property">angularSensibilityX</span> = <span class="number">1000</span> <span class="comment">// 水平灵敏度</span></span><br><span class="line">    camera.<span class="property">angularSensibilityY</span> = <span class="number">1000</span> <span class="comment">// 垂直灵敏度</span></span><br><span class="line">    camera.<span class="property">wheelDeltaPercentage</span> = <span class="number">0.01</span> <span class="comment">// 滚轮缩放速度</span></span><br><span class="line">    camera.<span class="property">pinchDeltaPercentage</span> = <span class="number">0.01</span> <span class="comment">// 触摸缩放速度</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 惯性</span></span><br><span class="line">    camera.<span class="property">inertia</span> = <span class="number">0.9</span></span><br><span class="line">    camera.<span class="property">panningInertia</span> = <span class="number">0.9</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自动旋转</span></span><br><span class="line">    camera.<span class="property">useAutoRotationBehavior</span> = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">if</span> (camera.<span class="property">useAutoRotationBehavior</span>) &#123;</span><br><span class="line">      camera.<span class="property">autoRotationBehavior</span>.<span class="property">idleRotationSpeed</span> = <span class="number">0.2</span></span><br><span class="line">      camera.<span class="property">autoRotationBehavior</span>.<span class="property">idleRotationWaitTime</span> = <span class="number">2000</span></span><br><span class="line">      camera.<span class="property">autoRotationBehavior</span>.<span class="property">idleRotationSpinupTime</span> = <span class="number">2000</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 边界行为</span></span><br><span class="line">    camera.<span class="property">useBouncingBehavior</span> = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> (camera.<span class="property">useBouncingBehavior</span>) &#123;</span><br><span class="line">      camera.<span class="property">bouncingBehavior</span>.<span class="property">transitionDuration</span> = <span class="number">450</span></span><br><span class="line">      camera.<span class="property">bouncingBehavior</span>.<span class="property">lowerRadiusTransitionRange</span> = <span class="number">2</span></span><br><span class="line">      camera.<span class="property">bouncingBehavior</span>.<span class="property">upperRadiusTransitionRange</span> = -<span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 框选行为</span></span><br><span class="line">    camera.<span class="property">useFramingBehavior</span> = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> (camera.<span class="property">useFramingBehavior</span>) &#123;</span><br><span class="line">      camera.<span class="property">framingBehavior</span>.<span class="property">mode</span> = <span class="title class_">FramingBehavior</span>.<span class="property">FitFrustumSidesMode</span></span><br><span class="line">      camera.<span class="property">framingBehavior</span>.<span class="property">radiusScale</span> = <span class="number">1.0</span></span><br><span class="line">      camera.<span class="property">framingBehavior</span>.<span class="property">positionScale</span> = <span class="number">0.5</span></span><br><span class="line">      camera.<span class="property">framingBehavior</span>.<span class="property">defaultElevation</span> = <span class="number">0.3</span></span><br><span class="line">      camera.<span class="property">framingBehavior</span>.<span class="property">elevationReturnTime</span> = <span class="number">1500</span></span><br><span class="line">      camera.<span class="property">framingBehavior</span>.<span class="property">elevationReturnWaitTime</span> = <span class="number">1000</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">set</span>(name, camera)</span><br><span class="line">    <span class="keyword">return</span> camera</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通用相机 (UniversalCamera)</span></span><br><span class="line">  <span class="title function_">createUniversalCamera</span>(<span class="params">name, position</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="keyword">new</span> <span class="title class_">UniversalCamera</span>(name, position, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 继承自FreeCamera的所有属性</span></span><br><span class="line">    camera.<span class="title function_">setTarget</span>(<span class="title class_">Vector3</span>.<span class="title class_">Zero</span>())</span><br><span class="line">    camera.<span class="property">speed</span> = <span class="number">0.5</span></span><br><span class="line">    camera.<span class="property">angularSensibility</span> = <span class="number">2000</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 触摸控制 (移动设备)</span></span><br><span class="line">    camera.<span class="property">touchAngularSensibility</span> = <span class="number">20000</span></span><br><span class="line">    camera.<span class="property">touchMoveSensibility</span> = <span class="number">250</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 游戏手柄支持</span></span><br><span class="line">    camera.<span class="property">gamepadAngularSensibility</span> = <span class="number">200</span></span><br><span class="line">    camera.<span class="property">gamepadMoveSensibility</span> = <span class="number">40</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">set</span>(name, camera)</span><br><span class="line">    <span class="keyword">return</span> camera</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// VR相机</span></span><br><span class="line">  <span class="title function_">createVRCamera</span>(<span class="params">name, position</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="keyword">new</span> <span class="title class_">WebVRFreeCamera</span>(name, position, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// VR设备检测</span></span><br><span class="line">    camera.<span class="property">deviceOrientationCamera</span>.<span class="property">angularSensibility</span> = <span class="number">2000</span></span><br><span class="line">    camera.<span class="property">deviceOrientationCamera</span>.<span class="property">moveSensibility</span> = <span class="number">50</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">set</span>(name, camera)</span><br><span class="line">    <span class="keyword">return</span> camera</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 跟随相机 (FollowCamera)</span></span><br><span class="line">  <span class="title function_">createFollowCamera</span>(<span class="params">name, target</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="keyword">new</span> <span class="title class_">FollowCamera</span>(name, <span class="title class_">Vector3</span>.<span class="title class_">Zero</span>(), <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跟随目标</span></span><br><span class="line">    camera.<span class="property">lockedTarget</span> = target</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跟随参数</span></span><br><span class="line">    camera.<span class="property">radius</span> = <span class="number">10</span> <span class="comment">// 跟随距离</span></span><br><span class="line">    camera.<span class="property">heightOffset</span> = <span class="number">5</span> <span class="comment">// 高度偏移</span></span><br><span class="line">    camera.<span class="property">rotationOffset</span> = <span class="number">0</span> <span class="comment">// 旋转偏移</span></span><br><span class="line">    camera.<span class="property">cameraAcceleration</span> = <span class="number">0.05</span> <span class="comment">// 加速度</span></span><br><span class="line">    camera.<span class="property">maxCameraSpeed</span> = <span class="number">20</span> <span class="comment">// 最大速度</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">set</span>(name, camera)</span><br><span class="line">    <span class="keyword">return</span> camera</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置活动相机</span></span><br><span class="line">  <span class="title function_">setActiveCamera</span>(<span class="params">cameraName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">get</span>(cameraName)</span><br><span class="line">    <span class="keyword">if</span> (camera) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">activeCamera</span> = camera</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">activeCamera</span> = camera</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 附加控制</span></span><br><span class="line">      camera.<span class="title function_">attachControls</span>(<span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>().<span class="title function_">getRenderingCanvas</span>(), <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 取消其他相机的控制</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">cam, name</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (name !== cameraName) &#123;</span><br><span class="line">          cam.<span class="title function_">detachControls</span>(<span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>().<span class="title function_">getRenderingCanvas</span>())</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`切换到相机: <span class="subst">$&#123;cameraName&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 相机动画</span></span><br><span class="line">  <span class="title function_">animateCameraTo</span>(<span class="params">targetPosition, targetTarget, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">activeCamera</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> camera = <span class="variable language_">this</span>.<span class="property">activeCamera</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 位置动画</span></span><br><span class="line">    <span class="keyword">const</span> positionAnimation = <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">      <span class="string">&#x27;cameraPosition&#x27;</span>,</span><br><span class="line">      camera,</span><br><span class="line">      <span class="string">&#x27;position&#x27;</span>,</span><br><span class="line">      <span class="number">30</span>, <span class="comment">// FPS</span></span><br><span class="line">      (duration / <span class="number">1000</span>) * <span class="number">30</span>, <span class="comment">// 总帧数</span></span><br><span class="line">      camera.<span class="property">position</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      targetPosition,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果是FreeCamera或UniversalCamera，也要动画目标</span></span><br><span class="line">    <span class="keyword">if</span> (camera <span class="keyword">instanceof</span> <span class="title class_">FreeCamera</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> targetAnimation = <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraTarget&#x27;</span>,</span><br><span class="line">        camera,</span><br><span class="line">        <span class="string">&#x27;target&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">        camera.<span class="title function_">getTarget</span>().<span class="title function_">clone</span>(),</span><br><span class="line">        targetTarget,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果是ArcRotateCamera，需要计算alpha、beta、radius</span></span><br><span class="line">    <span class="keyword">if</span> (camera <span class="keyword">instanceof</span> <span class="title class_">ArcRotateCamera</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> direction = targetPosition.<span class="title function_">subtract</span>(targetTarget)</span><br><span class="line">      <span class="keyword">const</span> radius = direction.<span class="title function_">length</span>()</span><br><span class="line">      <span class="keyword">const</span> alpha = <span class="title class_">Math</span>.<span class="title function_">atan2</span>(direction.<span class="property">x</span>, direction.<span class="property">z</span>)</span><br><span class="line">      <span class="keyword">const</span> beta = <span class="title class_">Math</span>.<span class="title function_">acos</span>(direction.<span class="property">y</span> / radius)</span><br><span class="line"></span><br><span class="line">      <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraAlpha&#x27;</span>,</span><br><span class="line">        camera,</span><br><span class="line">        <span class="string">&#x27;alpha&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">        camera.<span class="property">alpha</span>,</span><br><span class="line">        alpha,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraBeta&#x27;</span>,</span><br><span class="line">        camera,</span><br><span class="line">        <span class="string">&#x27;beta&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">        camera.<span class="property">beta</span>,</span><br><span class="line">        beta,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraRadius&#x27;</span>,</span><br><span class="line">        camera,</span><br><span class="line">        <span class="string">&#x27;radius&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">        camera.<span class="property">radius</span>,</span><br><span class="line">        radius,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraTarget&#x27;</span>,</span><br><span class="line">        camera,</span><br><span class="line">        <span class="string">&#x27;target&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">        camera.<span class="property">target</span>.<span class="title function_">clone</span>(),</span><br><span class="line">        targetTarget,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 相机聚焦到网格</span></span><br><span class="line">  <span class="title function_">focusOnMesh</span>(<span class="params">mesh, offset = <span class="keyword">new</span> Vector3(<span class="number">0</span>, <span class="number">5</span>, -<span class="number">10</span>)</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">activeCamera</span> || !mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> boundingInfo = mesh.<span class="title function_">getBoundingInfo</span>()</span><br><span class="line">    <span class="keyword">const</span> center = boundingInfo.<span class="property">boundingBox</span>.<span class="property">centerWorld</span></span><br><span class="line">    <span class="keyword">const</span> size = boundingInfo.<span class="property">boundingBox</span>.<span class="property">extendSizeWorld</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算合适的距离</span></span><br><span class="line">    <span class="keyword">const</span> maxSize = <span class="title class_">Math</span>.<span class="title function_">max</span>(size.<span class="property">x</span>, size.<span class="property">y</span>, size.<span class="property">z</span>)</span><br><span class="line">    <span class="keyword">const</span> distance = maxSize * <span class="number">2.5</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> targetPosition = center.<span class="title function_">add</span>(offset.<span class="title function_">normalize</span>().<span class="title function_">scale</span>(distance))</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">animateCameraTo</span>(targetPosition, center)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 保存相机状态</span></span><br><span class="line">  <span class="title function_">saveCameraState</span>(<span class="params">cameraName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">get</span>(cameraName)</span><br><span class="line">    <span class="keyword">if</span> (!camera) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> state = &#123;</span><br><span class="line">      <span class="attr">name</span>: cameraName,</span><br><span class="line">      <span class="attr">type</span>: camera.<span class="title function_">getClassName</span>(),</span><br><span class="line">      <span class="attr">position</span>: camera.<span class="property">position</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">target</span>: camera.<span class="title function_">getTarget</span>().<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">upVector</span>: camera.<span class="property">upVector</span>.<span class="title function_">clone</span>(),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ArcRotateCamera额外状态</span></span><br><span class="line">    <span class="keyword">if</span> (camera <span class="keyword">instanceof</span> <span class="title class_">ArcRotateCamera</span>) &#123;</span><br><span class="line">      state.<span class="property">alpha</span> = camera.<span class="property">alpha</span></span><br><span class="line">      state.<span class="property">beta</span> = camera.<span class="property">beta</span></span><br><span class="line">      state.<span class="property">radius</span> = camera.<span class="property">radius</span></span><br><span class="line">      state.<span class="property">target</span> = camera.<span class="property">target</span>.<span class="title function_">clone</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 恢复相机状态</span></span><br><span class="line">  <span class="title function_">restoreCameraState</span>(<span class="params">state</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">get</span>(state.<span class="property">name</span>)</span><br><span class="line">    <span class="keyword">if</span> (!camera) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    camera.<span class="property">position</span> = state.<span class="property">position</span>.<span class="title function_">clone</span>()</span><br><span class="line">    camera.<span class="property">upVector</span> = state.<span class="property">upVector</span>.<span class="title function_">clone</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (camera <span class="keyword">instanceof</span> <span class="title class_">ArcRotateCamera</span> &amp;&amp; state.<span class="property">alpha</span> !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      camera.<span class="property">alpha</span> = state.<span class="property">alpha</span></span><br><span class="line">      camera.<span class="property">beta</span> = state.<span class="property">beta</span></span><br><span class="line">      camera.<span class="property">radius</span> = state.<span class="property">radius</span></span><br><span class="line">      camera.<span class="property">target</span> = state.<span class="property">target</span>.<span class="title function_">clone</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (camera <span class="keyword">instanceof</span> <span class="title class_">FreeCamera</span>) &#123;</span><br><span class="line">      camera.<span class="title function_">setTarget</span>(state.<span class="property">target</span>.<span class="title function_">clone</span>())</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 相机摇晃效果</span></span><br><span class="line">  <span class="title function_">addShakeEffect</span>(<span class="params">intensity = <span class="number">0.1</span>, duration = <span class="number">1000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">activeCamera</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> camera = <span class="variable language_">this</span>.<span class="property">activeCamera</span></span><br><span class="line">    <span class="keyword">const</span> originalPosition = camera.<span class="property">position</span>.<span class="title function_">clone</span>()</span><br><span class="line">    <span class="keyword">const</span> shakeAnimation = <span class="keyword">new</span> <span class="title class_">Animation</span>(</span><br><span class="line">      <span class="string">&#x27;cameraShake&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;position&#x27;</span>,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> frameCount = (duration / <span class="number">1000</span>) * <span class="number">30</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= frameCount; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> progress = i / frameCount</span><br><span class="line">      <span class="keyword">const</span> shakeIntensity = intensity * (<span class="number">1</span> - progress) <span class="comment">// 逐渐减弱</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> shake = <span class="keyword">new</span> <span class="title class_">Vector3</span>(</span><br><span class="line">        (<span class="title class_">Math</span>.<span class="title function_">random</span>() - <span class="number">0.5</span>) * shakeIntensity,</span><br><span class="line">        (<span class="title class_">Math</span>.<span class="title function_">random</span>() - <span class="number">0.5</span>) * shakeIntensity,</span><br><span class="line">        (<span class="title class_">Math</span>.<span class="title function_">random</span>() - <span class="number">0.5</span>) * shakeIntensity,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: i,</span><br><span class="line">        <span class="attr">value</span>: originalPosition.<span class="title function_">add</span>(shake),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最后回到原位置</span></span><br><span class="line">    keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">      <span class="attr">frame</span>: frameCount,</span><br><span class="line">      <span class="attr">value</span>: originalPosition,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    shakeAnimation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> animatable = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">beginDirectAnimation</span>(</span><br><span class="line">      camera,</span><br><span class="line">      [shakeAnimation],</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      frameCount,</span><br><span class="line">      <span class="literal">false</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> animatable</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 第一人称射击游戏相机设置</span></span><br><span class="line">  <span class="title function_">setupFPSCamera</span>(<span class="params">cameraName = <span class="string">&#x27;fpsCamera&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="variable language_">this</span>.<span class="title function_">createFreeCamera</span>(cameraName, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">1.8</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// FPS专用设置</span></span><br><span class="line">    camera.<span class="property">speed</span> = <span class="number">0.2</span></span><br><span class="line">    camera.<span class="property">angularSensibility</span> = <span class="number">1500</span></span><br><span class="line">    camera.<span class="property">minZ</span> = <span class="number">0.1</span> <span class="comment">// 近裁剪面</span></span><br><span class="line">    camera.<span class="property">maxZ</span> = <span class="number">1000</span> <span class="comment">// 远裁剪面</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跳跃设置</span></span><br><span class="line">    camera.<span class="property">jumpSpeed</span> = <span class="number">0.3</span></span><br><span class="line">    camera.<span class="property">gravity</span> = <span class="number">0.9</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 鼠标锁定</span></span><br><span class="line">    camera.<span class="title function_">attachControls</span>(<span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>().<span class="title function_">getRenderingCanvas</span>(), <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 武器摇摆效果</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupWeaponSway</span>(camera)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> camera</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupWeaponSway</span>(<span class="params">camera</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> swayTime = <span class="number">0</span></span><br><span class="line">    <span class="keyword">const</span> swaySpeed = <span class="number">0.005</span></span><br><span class="line">    <span class="keyword">const</span> swayAmount = <span class="number">0.002</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (camera === <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">activeCamera</span>) &#123;</span><br><span class="line">        swayTime += <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>().<span class="title function_">getDeltaTime</span>() * swaySpeed</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算摇摆偏移</span></span><br><span class="line">        <span class="keyword">const</span> swayX = <span class="title class_">Math</span>.<span class="title function_">sin</span>(swayTime * <span class="number">2</span>) * swayAmount</span><br><span class="line">        <span class="keyword">const</span> swayY = <span class="title class_">Math</span>.<span class="title function_">sin</span>(swayTime) * swayAmount * <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 应用到相机</span></span><br><span class="line">        camera.<span class="property">position</span>.<span class="property">x</span> += swayX</span><br><span class="line">        camera.<span class="property">position</span>.<span class="property">y</span> += swayY</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 电影级相机运动</span></span><br><span class="line">  <span class="title function_">createCinematicPath</span>(<span class="params">waypoints, duration = <span class="number">10000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (waypoints.<span class="property">length</span> &lt; <span class="number">2</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建路径</span></span><br><span class="line">    <span class="keyword">const</span> path = []</span><br><span class="line">    waypoints.<span class="title function_">forEach</span>(<span class="function">(<span class="params">waypoint</span>) =&gt;</span> &#123;</span><br><span class="line">      path.<span class="title function_">push</span>(waypoint.<span class="property">position</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建平滑曲线</span></span><br><span class="line">    <span class="keyword">const</span> curve = <span class="title class_">Curve3</span>.<span class="title class_">CreateCatmullRomSpline</span>(path, path.<span class="property">length</span> * <span class="number">10</span>, <span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">const</span> curvePoints = curve.<span class="title function_">getPoints</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建动画</span></span><br><span class="line">    <span class="keyword">const</span> positionAnimation = <span class="keyword">new</span> <span class="title class_">Animation</span>(</span><br><span class="line">      <span class="string">&#x27;cinematicPosition&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;position&#x27;</span>,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">const</span> targetAnimation = <span class="keyword">new</span> <span class="title class_">Animation</span>(</span><br><span class="line">      <span class="string">&#x27;cinematicTarget&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;target&#x27;</span>,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * <span class="number">30</span></span><br><span class="line">    <span class="keyword">const</span> positionKeys = []</span><br><span class="line">    <span class="keyword">const</span> targetKeys = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= totalFrames; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> progress = i / totalFrames</span><br><span class="line">      <span class="keyword">const</span> pointIndex = <span class="title class_">Math</span>.<span class="title function_">floor</span>(progress * (curvePoints.<span class="property">length</span> - <span class="number">1</span>))</span><br><span class="line">      <span class="keyword">const</span> nextPointIndex = <span class="title class_">Math</span>.<span class="title function_">min</span>(pointIndex + <span class="number">1</span>, curvePoints.<span class="property">length</span> - <span class="number">1</span>)</span><br><span class="line">      <span class="keyword">const</span> localProgress = progress * (curvePoints.<span class="property">length</span> - <span class="number">1</span>) - pointIndex</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 插值位置</span></span><br><span class="line">      <span class="keyword">const</span> position = <span class="title class_">Vector3</span>.<span class="title class_">Lerp</span>(</span><br><span class="line">        curvePoints[pointIndex],</span><br><span class="line">        curvePoints[nextPointIndex],</span><br><span class="line">        localProgress,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 计算目标（向前看）</span></span><br><span class="line">      <span class="keyword">const</span> lookAheadIndex = <span class="title class_">Math</span>.<span class="title function_">min</span>(pointIndex + <span class="number">5</span>, curvePoints.<span class="property">length</span> - <span class="number">1</span>)</span><br><span class="line">      <span class="keyword">const</span> target = curvePoints[lookAheadIndex]</span><br><span class="line"></span><br><span class="line">      positionKeys.<span class="title function_">push</span>(&#123; <span class="attr">frame</span>: i, <span class="attr">value</span>: position &#125;)</span><br><span class="line">      targetKeys.<span class="title function_">push</span>(&#123; <span class="attr">frame</span>: i, <span class="attr">value</span>: target &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    positionAnimation.<span class="title function_">setKeys</span>(positionKeys)</span><br><span class="line">    targetAnimation.<span class="title function_">setKeys</span>(targetKeys)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [positionAnimation, targetAnimation]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取相机信息</span></span><br><span class="line">  <span class="title function_">getCameraInfo</span>(<span class="params">cameraName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> camera = <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">get</span>(cameraName)</span><br><span class="line">    <span class="keyword">if</span> (!camera) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> info = &#123;</span><br><span class="line">      <span class="attr">name</span>: cameraName,</span><br><span class="line">      <span class="attr">type</span>: camera.<span class="title function_">getClassName</span>(),</span><br><span class="line">      <span class="attr">position</span>: camera.<span class="property">position</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">target</span>: camera.<span class="title function_">getTarget</span>(),</span><br><span class="line">      <span class="attr">fov</span>: camera.<span class="property">fov</span>,</span><br><span class="line">      <span class="attr">minZ</span>: camera.<span class="property">minZ</span>,</span><br><span class="line">      <span class="attr">maxZ</span>: camera.<span class="property">maxZ</span>,</span><br><span class="line">      <span class="attr">isActive</span>: camera === <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">activeCamera</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (camera <span class="keyword">instanceof</span> <span class="title class_">ArcRotateCamera</span>) &#123;</span><br><span class="line">      info.<span class="property">alpha</span> = camera.<span class="property">alpha</span></span><br><span class="line">      info.<span class="property">beta</span> = camera.<span class="property">beta</span></span><br><span class="line">      info.<span class="property">radius</span> = camera.<span class="property">radius</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 资源清理</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">camera</span>) =&gt;</span> &#123;</span><br><span class="line">      camera.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cameras</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> cameraManager = <span class="keyword">new</span> <span class="title class_">CameraManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 切换相机</span></span><br><span class="line">cameraManager.<span class="title function_">setActiveCamera</span>(<span class="string">&#x27;arcCamera&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 聚焦到网格</span></span><br><span class="line">cameraManager.<span class="title function_">focusOnMesh</span>(someMesh)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加摇晃效果</span></span><br><span class="line">cameraManager.<span class="title function_">addShakeEffect</span>(<span class="number">0.2</span>, <span class="number">2000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置FPS相机</span></span><br><span class="line"><span class="keyword">const</span> fpsCamera = cameraManager.<span class="title function_">setupFPSCamera</span>()</span><br></pre></td></tr></table></figure>

<h2 id="💡-Light-光照系统详解"><a href="#💡-Light-光照系统详解" class="headerlink" title="💡 Light 光照系统详解"></a>💡 Light 光照系统详解</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Light 光照系统完整管理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LightManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadowGenerators</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupDefaultLighting</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupDefaultLighting</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 环境光</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createHemisphericLight</span>(<span class="string">&#x27;ambientLight&#x27;</span>, <span class="title class_">Vector3</span>.<span class="title class_">Up</span>(), <span class="number">0.3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 主光源</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createDirectionalLight</span>(<span class="string">&#x27;sunLight&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>), <span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 补光</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createSpotLight</span>(<span class="string">&#x27;fillLight&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">5</span>, <span class="number">10</span>, <span class="number">5</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, -<span class="number">1</span>, <span class="number">0</span>), <span class="number">0.5</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 半球光 (HemisphericLight) - 环境光</span></span><br><span class="line">  <span class="title function_">createHemisphericLight</span>(<span class="params">name, direction, intensity = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> light = <span class="keyword">new</span> <span class="title class_">HemisphericLight</span>(name, direction, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 基础属性</span></span><br><span class="line">    light.<span class="property">intensity</span> = intensity</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 颜色配置</span></span><br><span class="line">    <span class="comment">// diffuse: Color3 - 漫反射颜色</span></span><br><span class="line">    light.<span class="property">diffuse</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// specular: Color3 - 镜面反射颜色</span></span><br><span class="line">    light.<span class="property">specular</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// groundColor: Color3 - 地面颜色（半球光特有）</span></span><br><span class="line">    light.<span class="property">groundColor</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.2</span>, <span class="number">0.2</span>, <span class="number">0.3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 影响范围</span></span><br><span class="line">    light.<span class="property">range</span> = <span class="title class_">Number</span>.<span class="property">MAX_VALUE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 包含/排除网格</span></span><br><span class="line">    light.<span class="property">includedOnlyMeshes</span> = [] <span class="comment">// 只影响指定网格</span></span><br><span class="line">    light.<span class="property">excludedMeshes</span> = [] <span class="comment">// 排除指定网格</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">set</span>(name, light)</span><br><span class="line">    <span class="keyword">return</span> light</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 方向光 (DirectionalLight) - 太阳光</span></span><br><span class="line">  <span class="title function_">createDirectionalLight</span>(<span class="params">name, direction, intensity = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> light = <span class="keyword">new</span> <span class="title class_">DirectionalLight</span>(name, direction, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    light.<span class="property">intensity</span> = intensity</span><br><span class="line">    light.<span class="property">diffuse</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">0.9</span>, <span class="number">0.7</span>) <span class="comment">// 暖白色</span></span><br><span class="line">    light.<span class="property">specular</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0.8</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 方向光特有属性</span></span><br><span class="line">    <span class="comment">// direction: Vector3 - 光照方向</span></span><br><span class="line">    light.<span class="property">direction</span> = direction.<span class="title function_">normalize</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阴影配置</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupShadowGenerator</span>(name, light, &#123;</span><br><span class="line">      <span class="attr">mapSize</span>: <span class="number">2048</span>,</span><br><span class="line">      <span class="attr">useExponentialShadowMap</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">useBlurExponentialShadowMap</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">blurScale</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">blurBoxOffset</span>: <span class="number">1</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">set</span>(name, light)</span><br><span class="line">    <span class="keyword">return</span> light</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 点光源 (PointLight)</span></span><br><span class="line">  <span class="title function_">createPointLight</span>(<span class="params">name, position, intensity = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> light = <span class="keyword">new</span> <span class="title class_">PointLight</span>(name, position, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    light.<span class="property">intensity</span> = intensity</span><br><span class="line">    light.<span class="property">diffuse</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">0.8</span>, <span class="number">0.4</span>) <span class="comment">// 温暖的橙色</span></span><br><span class="line">    light.<span class="property">specular</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 点光源特有属性</span></span><br><span class="line">    <span class="comment">// range: number - 光照范围</span></span><br><span class="line">    light.<span class="property">range</span> = <span class="number">50</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 衰减函数: intensity / (1 + linear * d + quadratic * d^2)</span></span><br><span class="line">    <span class="comment">// 其中 d 是距离</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 线性衰减</span></span><br><span class="line">    light.<span class="property">diffuseLinearAttenuation</span> = <span class="number">0.1</span></span><br><span class="line">    light.<span class="property">specularLinearAttenuation</span> = <span class="number">0.1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 二次衰减</span></span><br><span class="line">    light.<span class="property">diffuseQuadraticAttenuation</span> = <span class="number">0.01</span></span><br><span class="line">    light.<span class="property">specularQuadraticAttenuation</span> = <span class="number">0.01</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阴影配置（可选）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupShadowGenerator</span>(name, light, &#123;</span><br><span class="line">      <span class="attr">mapSize</span>: <span class="number">1024</span>,</span><br><span class="line">      <span class="attr">useExponentialShadowMap</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">set</span>(name, light)</span><br><span class="line">    <span class="keyword">return</span> light</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 聚光灯 (SpotLight)</span></span><br><span class="line">  <span class="title function_">createSpotLight</span>(<span class="params">name, position, direction, intensity = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="comment">// angle: 聚光灯锥角（弧度）</span></span><br><span class="line">    <span class="comment">// exponent: 边缘衰减指数</span></span><br><span class="line">    <span class="keyword">const</span> light = <span class="keyword">new</span> <span class="title class_">SpotLight</span>(name, position, direction, <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">3</span>, <span class="number">2</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    light.<span class="property">intensity</span> = intensity</span><br><span class="line">    light.<span class="property">diffuse</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0.9</span>)</span><br><span class="line">    light.<span class="property">specular</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 聚光灯特有属性</span></span><br><span class="line">    <span class="comment">// angle: number - 锥角（弧度）</span></span><br><span class="line">    light.<span class="property">angle</span> = <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">3</span> <span class="comment">// 60度</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// exponent: number - 边缘衰减</span></span><br><span class="line">    light.<span class="property">exponent</span> = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 方向</span></span><br><span class="line">    light.<span class="property">direction</span> = direction.<span class="title function_">normalize</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内角和外角（用于平滑过渡）</span></span><br><span class="line">    light.<span class="property">innerAngle</span> = <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">6</span> <span class="comment">// 30度</span></span><br><span class="line">    light.<span class="property">outerAngle</span> = <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">3</span> <span class="comment">// 60度</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 距离衰减</span></span><br><span class="line">    light.<span class="property">range</span> = <span class="number">100</span></span><br><span class="line">    light.<span class="property">diffuseLinearAttenuation</span> = <span class="number">0.05</span></span><br><span class="line">    light.<span class="property">diffuseQuadraticAttenuation</span> = <span class="number">0.005</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阴影配置</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupShadowGenerator</span>(name, light, &#123;</span><br><span class="line">      <span class="attr">mapSize</span>: <span class="number">1024</span>,</span><br><span class="line">      <span class="attr">useExponentialShadowMap</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">useCloseExponentialShadowMap</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">set</span>(name, light)</span><br><span class="line">    <span class="keyword">return</span> light</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 阴影生成器配置</span></span><br><span class="line">  <span class="title function_">setupShadowGenerator</span>(<span class="params">lightName, light, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!light.<span class="property">canGenerateShadows</span>) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="attr">mapSize</span>: <span class="number">1024</span>,</span><br><span class="line">      <span class="attr">useExponentialShadowMap</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">useBlurExponentialShadowMap</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">useCloseExponentialShadowMap</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">usePoissonSampling</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">usePercentageCloserFiltering</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">filteringQuality</span>: <span class="title class_">ShadowGenerator</span>.<span class="property">QUALITY_HIGH</span>,</span><br><span class="line">      <span class="attr">blurScale</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">blurBoxOffset</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">bias</span>: <span class="number">0.00005</span>,</span><br><span class="line">      <span class="attr">normalBias</span>: <span class="number">0.0</span>,</span><br><span class="line">      <span class="attr">darkness</span>: <span class="number">0.0</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> config = <span class="title class_">Object</span>.<span class="title function_">assign</span>(defaultOptions, options)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建阴影生成器</span></span><br><span class="line">    <span class="keyword">const</span> shadowGenerator = <span class="keyword">new</span> <span class="title class_">ShadowGenerator</span>(config.<span class="property">mapSize</span>, light)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阴影映射类型</span></span><br><span class="line">    <span class="keyword">if</span> (config.<span class="property">useExponentialShadowMap</span>) &#123;</span><br><span class="line">      shadowGenerator.<span class="property">useExponentialShadowMap</span> = <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config.<span class="property">useBlurExponentialShadowMap</span>) &#123;</span><br><span class="line">      shadowGenerator.<span class="property">useBlurExponentialShadowMap</span> = <span class="literal">true</span></span><br><span class="line">      shadowGenerator.<span class="property">blurScale</span> = config.<span class="property">blurScale</span></span><br><span class="line">      shadowGenerator.<span class="property">blurBoxOffset</span> = config.<span class="property">blurBoxOffset</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config.<span class="property">useCloseExponentialShadowMap</span>) &#123;</span><br><span class="line">      shadowGenerator.<span class="property">useCloseExponentialShadowMap</span> = <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config.<span class="property">usePoissonSampling</span>) &#123;</span><br><span class="line">      shadowGenerator.<span class="property">usePoissonSampling</span> = <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config.<span class="property">usePercentageCloserFiltering</span>) &#123;</span><br><span class="line">      shadowGenerator.<span class="property">usePercentageCloserFiltering</span> = <span class="literal">true</span></span><br><span class="line">      shadowGenerator.<span class="property">filteringQuality</span> = config.<span class="property">filteringQuality</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阴影参数</span></span><br><span class="line">    shadowGenerator.<span class="property">bias</span> = config.<span class="property">bias</span></span><br><span class="line">    shadowGenerator.<span class="property">normalBias</span> = config.<span class="property">normalBias</span></span><br><span class="line">    shadowGenerator.<span class="property">darkness</span> = config.<span class="property">darkness</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 透明度阈值</span></span><br><span class="line">    shadowGenerator.<span class="property">transparencyShadow</span> = <span class="literal">true</span></span><br><span class="line">    shadowGenerator.<span class="property">forceBackFacesOnly</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 级联阴影（方向光）</span></span><br><span class="line">    <span class="keyword">if</span> (light <span class="keyword">instanceof</span> <span class="title class_">DirectionalLight</span>) &#123;</span><br><span class="line">      shadowGenerator.<span class="property">autoCalcDepthBounds</span> = <span class="literal">true</span></span><br><span class="line">      shadowGenerator.<span class="property">stabilizeCascades</span> = <span class="literal">true</span></span><br><span class="line">      shadowGenerator.<span class="property">lambda</span> = <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 多级联配置</span></span><br><span class="line">      <span class="keyword">if</span> (config.<span class="property">cascadeCount</span> &amp;&amp; config.<span class="property">cascadeCount</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        shadowGenerator.<span class="property">numCascades</span> = config.<span class="property">cascadeCount</span></span><br><span class="line">        shadowGenerator.<span class="property">cascadeBlendPercentage</span> = <span class="number">0.1</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadowGenerators</span>.<span class="title function_">set</span>(lightName, shadowGenerator)</span><br><span class="line">    <span class="keyword">return</span> shadowGenerator</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加投射阴影的网格</span></span><br><span class="line">  <span class="title function_">addShadowCaster</span>(<span class="params">lightName, mesh</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> shadowGenerator = <span class="variable language_">this</span>.<span class="property">shadowGenerators</span>.<span class="title function_">get</span>(lightName)</span><br><span class="line">    <span class="keyword">if</span> (shadowGenerator) &#123;</span><br><span class="line">      shadowGenerator.<span class="title function_">addShadowCaster</span>(mesh)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 批量添加阴影投射者</span></span><br><span class="line">  <span class="title function_">addShadowCasters</span>(<span class="params">lightName, meshes</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> shadowGenerator = <span class="variable language_">this</span>.<span class="property">shadowGenerators</span>.<span class="title function_">get</span>(lightName)</span><br><span class="line">    <span class="keyword">if</span> (shadowGenerator) &#123;</span><br><span class="line">      meshes.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">        shadowGenerator.<span class="title function_">addShadowCaster</span>(mesh)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置网格接收阴影</span></span><br><span class="line">  <span class="title function_">enableShadowReceiver</span>(<span class="params">mesh</span>) &#123;</span><br><span class="line">    mesh.<span class="property">receiveShadows</span> = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 光照动画</span></span><br><span class="line">  <span class="title function_">animateLight</span>(<span class="params">lightName, property, targetValue, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> light = <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">get</span>(lightName)</span><br><span class="line">    <span class="keyword">if</span> (!light) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> animation = <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;lightName&#125;</span>_<span class="subst">$&#123;property&#125;</span>`</span>,</span><br><span class="line">      light,</span><br><span class="line">      property,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">      light[property],</span><br><span class="line">      targetValue,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 光照闪烁效果</span></span><br><span class="line">  <span class="title function_">addFlickerEffect</span>(<span class="params">lightName, intensity = <span class="number">0.2</span>, speed = <span class="number">5</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> light = <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">get</span>(lightName)</span><br><span class="line">    <span class="keyword">if</span> (!light) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> baseIntensity = light.<span class="property">intensity</span></span><br><span class="line">    <span class="keyword">let</span> time = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> flickerObserver = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      time += <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>().<span class="title function_">getDeltaTime</span>() * <span class="number">0.001</span> * speed</span><br><span class="line">      <span class="keyword">const</span> flicker = <span class="title class_">Math</span>.<span class="title function_">sin</span>(time * <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>) * intensity + <span class="title class_">Math</span>.<span class="title function_">random</span>() * intensity * <span class="number">0.5</span></span><br><span class="line">      light.<span class="property">intensity</span> = baseIntensity + flicker</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">dispose</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">remove</span>(flickerObserver)</span><br><span class="line">        light.<span class="property">intensity</span> = baseIntensity</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 昼夜循环</span></span><br><span class="line">  <span class="title function_">setupDayNightCycle</span>(<span class="params">duration = <span class="number">120000</span></span>) &#123;</span><br><span class="line">    <span class="comment">// 2分钟一个周期</span></span><br><span class="line">    <span class="keyword">const</span> sunLight = <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">get</span>(<span class="string">&#x27;sunLight&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> ambientLight = <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">get</span>(<span class="string">&#x27;ambientLight&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!sunLight || !ambientLight) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> time = <span class="number">0</span></span><br><span class="line">    <span class="keyword">const</span> cycleSpeed = (<span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>) / duration <span class="comment">// 弧度/毫秒</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> cycleObserver = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      time += <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>().<span class="title function_">getDeltaTime</span>() * cycleSpeed</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 太阳高度角 (-90° 到 +90°)</span></span><br><span class="line">      <span class="keyword">const</span> sunElevation = (<span class="title class_">Math</span>.<span class="title function_">sin</span>(time) * <span class="title class_">Math</span>.<span class="property">PI</span>) / <span class="number">2</span></span><br><span class="line">      <span class="keyword">const</span> sunAzimuth = time</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 计算太阳方向</span></span><br><span class="line">      <span class="keyword">const</span> sunDirection = <span class="keyword">new</span> <span class="title class_">Vector3</span>(</span><br><span class="line">        <span class="title class_">Math</span>.<span class="title function_">cos</span>(sunElevation) * <span class="title class_">Math</span>.<span class="title function_">sin</span>(sunAzimuth),</span><br><span class="line">        <span class="title class_">Math</span>.<span class="title function_">sin</span>(sunElevation),</span><br><span class="line">        <span class="title class_">Math</span>.<span class="title function_">cos</span>(sunElevation) * <span class="title class_">Math</span>.<span class="title function_">cos</span>(sunAzimuth),</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      sunLight.<span class="property">direction</span> = sunDirection.<span class="title function_">negate</span>()</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 根据太阳高度调整光照强度和颜色</span></span><br><span class="line">      <span class="keyword">const</span> dayFactor = <span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="number">0</span>, <span class="title class_">Math</span>.<span class="title function_">sin</span>(time)) <span class="comment">// 0-1，白天为1，夜晚为0</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 太阳光强度</span></span><br><span class="line">      sunLight.<span class="property">intensity</span> = dayFactor * <span class="number">2.0</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 太阳光颜色（日出日落时偏红）</span></span><br><span class="line">      <span class="keyword">const</span> sunColor = <span class="variable language_">this</span>.<span class="title function_">calculateSunColor</span>(sunElevation)</span><br><span class="line">      sunLight.<span class="property">diffuse</span> = sunColor</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 环境光强度</span></span><br><span class="line">      ambientLight.<span class="property">intensity</span> = <span class="number">0.1</span> + dayFactor * <span class="number">0.4</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 环境光颜色</span></span><br><span class="line">      <span class="keyword">const</span> ambientColor = <span class="variable language_">this</span>.<span class="title function_">calculateAmbientColor</span>(dayFactor)</span><br><span class="line">      ambientLight.<span class="property">diffuse</span> = ambientColor</span><br><span class="line">      ambientLight.<span class="property">groundColor</span> = ambientColor.<span class="title function_">scale</span>(<span class="number">0.5</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">dispose</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">remove</span>(cycleObserver)</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">calculateSunColor</span>(<span class="params">elevation</span>) &#123;</span><br><span class="line">    <span class="comment">// 根据太阳高度角计算颜色</span></span><br><span class="line">    <span class="keyword">const</span> factor = <span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="number">0</span>, <span class="title class_">Math</span>.<span class="title function_">sin</span>(elevation))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (factor &gt; <span class="number">0.8</span>) &#123;</span><br><span class="line">      <span class="comment">// 正午 - 白色</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Color3</span>.<span class="title class_">White</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (factor &gt; <span class="number">0.3</span>) &#123;</span><br><span class="line">      <span class="comment">// 白天 - 暖白色</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Color3</span>.<span class="title class_">Lerp</span>(<span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">0.9</span>, <span class="number">0.7</span>), <span class="title class_">Color3</span>.<span class="title class_">White</span>(), (factor - <span class="number">0.3</span>) / <span class="number">0.5</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (factor &gt; <span class="number">0.1</span>) &#123;</span><br><span class="line">      <span class="comment">// 日出日落 - 橙红色</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Color3</span>.<span class="title class_">Lerp</span>(<span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">0.3</span>, <span class="number">0.1</span>), <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">0.9</span>, <span class="number">0.7</span>), (factor - <span class="number">0.1</span>) / <span class="number">0.2</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 夜晚 - 深蓝色</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.1</span>, <span class="number">0.1</span>, <span class="number">0.3</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">calculateAmbientColor</span>(<span class="params">dayFactor</span>) &#123;</span><br><span class="line">    <span class="comment">// 白天：浅蓝色天空光</span></span><br><span class="line">    <span class="keyword">const</span> dayColor = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.5</span>, <span class="number">0.7</span>, <span class="number">1.0</span>)</span><br><span class="line">    <span class="comment">// 夜晚：深蓝紫色</span></span><br><span class="line">    <span class="keyword">const</span> nightColor = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.1</span>, <span class="number">0.1</span>, <span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Color3</span>.<span class="title class_">Lerp</span>(nightColor, dayColor, dayFactor)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 体积光效果 (Volumetric Light)</span></span><br><span class="line">  <span class="title function_">setupVolumetricLight</span>(<span class="params">lightName, density = <span class="number">0.1</span>, decay = <span class="number">0.95</span>, weight = <span class="number">0.5</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> light = <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">get</span>(lightName)</span><br><span class="line">    <span class="keyword">if</span> (!light || !(light <span class="keyword">instanceof</span> <span class="title class_">SpotLight</span> || light <span class="keyword">instanceof</span> <span class="title class_">DirectionalLight</span>)) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;体积光只支持聚光灯和方向光&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建体积光后处理</span></span><br><span class="line">    <span class="keyword">const</span> volumetricLightPostProcess = <span class="keyword">new</span> <span class="title class_">VolumetricLightScatteringPostProcess</span>(</span><br><span class="line">      <span class="string">&#x27;volumetricLight&#x27;</span>,</span><br><span class="line">      <span class="number">1.0</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">activeCamera</span>,</span><br><span class="line">      <span class="literal">undefined</span>, <span class="comment">// 使用光源自身</span></span><br><span class="line">      <span class="number">100</span>,</span><br><span class="line">      <span class="title class_">Texture</span>.<span class="property">BILINEAR_SAMPLINGMODE</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>(),</span><br><span class="line">      <span class="literal">false</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置参数</span></span><br><span class="line">    volumetricLightPostProcess.<span class="property">density</span> = density</span><br><span class="line">    volumetricLightPostProcess.<span class="property">decay</span> = decay</span><br><span class="line">    volumetricLightPostProcess.<span class="property">weight</span> = weight</span><br><span class="line">    volumetricLightPostProcess.<span class="property">samples</span> = <span class="number">50</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> volumetricLightPostProcess</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// IES光度文件支持（真实光源分布）</span></span><br><span class="line">  <span class="title function_">loadIESProfile</span>(<span class="params">lightName, iesUrl</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> light = <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">get</span>(lightName)</span><br><span class="line">    <span class="keyword">if</span> (!light || !(light <span class="keyword">instanceof</span> <span class="title class_">SpotLight</span>)) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;IES光度文件只支持聚光灯&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载IES文件并创建纹理</span></span><br><span class="line">    <span class="keyword">const</span> iesTexture = <span class="keyword">new</span> <span class="title class_">Texture</span>(iesUrl, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    iesTexture.<span class="property">wrapU</span> = <span class="title class_">Texture</span>.<span class="property">CLAMP_ADDRESSMODE</span></span><br><span class="line">    iesTexture.<span class="property">wrapV</span> = <span class="title class_">Texture</span>.<span class="property">CLAMP_ADDRESSMODE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 应用到光源</span></span><br><span class="line">    light.<span class="property">projectionTexture</span> = iesTexture</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> iesTexture</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 光源调试工具</span></span><br><span class="line">  <span class="title function_">enableLightGizmos</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">light, name</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> lightGizmo = <span class="keyword">new</span> <span class="title class_">LightGizmo</span>()</span><br><span class="line">      lightGizmo.<span class="property">light</span> = light</span><br><span class="line">      lightGizmo.<span class="property">material</span>.<span class="property">emissiveColor</span> = light.<span class="property">diffuse</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 显示光源方向</span></span><br><span class="line">      <span class="keyword">if</span> (light <span class="keyword">instanceof</span> <span class="title class_">DirectionalLight</span> || light <span class="keyword">instanceof</span> <span class="title class_">SpotLight</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> helper = <span class="variable language_">this</span>.<span class="title function_">createLightHelper</span>(light)</span><br><span class="line">        helper.<span class="property">name</span> = <span class="string">`<span class="subst">$&#123;name&#125;</span>_helper`</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">createLightHelper</span>(<span class="params">light</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (light <span class="keyword">instanceof</span> <span class="title class_">DirectionalLight</span>) &#123;</span><br><span class="line">      <span class="comment">// 方向光帮助器</span></span><br><span class="line">      <span class="keyword">const</span> helper = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateLines</span>(</span><br><span class="line">        <span class="string">&#x27;lightHelper&#x27;</span>,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">points</span>: [<span class="title class_">Vector3</span>.<span class="title class_">Zero</span>(), light.<span class="property">direction</span>.<span class="title function_">scale</span>(<span class="number">10</span>)],</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">      )</span><br><span class="line">      helper.<span class="property">color</span> = light.<span class="property">diffuse</span></span><br><span class="line">      <span class="keyword">return</span> helper</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (light <span class="keyword">instanceof</span> <span class="title class_">SpotLight</span>) &#123;</span><br><span class="line">      <span class="comment">// 聚光灯锥形帮助器</span></span><br><span class="line">      <span class="keyword">const</span> angle = light.<span class="property">angle</span></span><br><span class="line">      <span class="keyword">const</span> range = light.<span class="property">range</span> || <span class="number">20</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> helper = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateCylinder</span>(</span><br><span class="line">        <span class="string">&#x27;lightHelper&#x27;</span>,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">diameterTop</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="attr">diameterBottom</span>: <span class="title class_">Math</span>.<span class="title function_">tan</span>(angle / <span class="number">2</span>) * range * <span class="number">2</span>,</span><br><span class="line">          <span class="attr">height</span>: range,</span><br><span class="line">          <span class="attr">tessellation</span>: <span class="number">8</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      helper.<span class="property">position</span> = light.<span class="property">position</span>.<span class="title function_">clone</span>()</span><br><span class="line">      helper.<span class="title function_">lookAt</span>(light.<span class="property">position</span>.<span class="title function_">add</span>(light.<span class="property">direction</span>))</span><br><span class="line">      helper.<span class="property">material</span> = <span class="keyword">new</span> <span class="title class_">StandardMaterial</span>(<span class="string">&#x27;lightHelperMat&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">      helper.<span class="property">material</span>.<span class="property">wireframe</span> = <span class="literal">true</span></span><br><span class="line">      helper.<span class="property">material</span>.<span class="property">emissiveColor</span> = light.<span class="property">diffuse</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> helper</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取光照信息</span></span><br><span class="line">  <span class="title function_">getLightInfo</span>(<span class="params">lightName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> light = <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">get</span>(lightName)</span><br><span class="line">    <span class="keyword">if</span> (!light) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> info = &#123;</span><br><span class="line">      <span class="attr">name</span>: lightName,</span><br><span class="line">      <span class="attr">type</span>: light.<span class="title function_">getClassName</span>(),</span><br><span class="line">      <span class="attr">intensity</span>: light.<span class="property">intensity</span>,</span><br><span class="line">      <span class="attr">diffuse</span>: light.<span class="property">diffuse</span>,</span><br><span class="line">      <span class="attr">specular</span>: light.<span class="property">specular</span>,</span><br><span class="line">      <span class="attr">range</span>: light.<span class="property">range</span>,</span><br><span class="line">      <span class="attr">enabled</span>: light.<span class="title function_">isEnabled</span>(),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (light <span class="keyword">instanceof</span> <span class="title class_">DirectionalLight</span>) &#123;</span><br><span class="line">      info.<span class="property">direction</span> = light.<span class="property">direction</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (light <span class="keyword">instanceof</span> <span class="title class_">PointLight</span>) &#123;</span><br><span class="line">      info.<span class="property">position</span> = light.<span class="property">position</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (light <span class="keyword">instanceof</span> <span class="title class_">SpotLight</span>) &#123;</span><br><span class="line">      info.<span class="property">position</span> = light.<span class="property">position</span></span><br><span class="line">      info.<span class="property">direction</span> = light.<span class="property">direction</span></span><br><span class="line">      info.<span class="property">angle</span> = light.<span class="property">angle</span></span><br><span class="line">      info.<span class="property">exponent</span> = light.<span class="property">exponent</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (light <span class="keyword">instanceof</span> <span class="title class_">HemisphericLight</span>) &#123;</span><br><span class="line">      info.<span class="property">direction</span> = light.<span class="property">direction</span></span><br><span class="line">      info.<span class="property">groundColor</span> = light.<span class="property">groundColor</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 保存光照设置</span></span><br><span class="line">  <span class="title function_">saveLightingSetup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> setup = &#123;</span><br><span class="line">      <span class="attr">lights</span>: [],</span><br><span class="line">      <span class="attr">shadows</span>: [],</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">light, name</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">lights</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: name,</span><br><span class="line">        ...<span class="variable language_">this</span>.<span class="title function_">getLightInfo</span>(name),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadowGenerators</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">generator, lightName</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">shadows</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">lightName</span>: lightName,</span><br><span class="line">        <span class="attr">mapSize</span>: generator.<span class="property">mapSize</span>,</span><br><span class="line">        <span class="attr">bias</span>: generator.<span class="property">bias</span>,</span><br><span class="line">        <span class="attr">darkness</span>: generator.<span class="property">darkness</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> setup</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 资源清理</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadowGenerators</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">generator</span>) =&gt;</span> &#123;</span><br><span class="line">      generator.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">shadowGenerators</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">light</span>) =&gt;</span> &#123;</span><br><span class="line">      light.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lights</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> lightManager = <span class="keyword">new</span> <span class="title class_">LightManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建自定义光源</span></span><br><span class="line"><span class="keyword">const</span> fireLight = lightManager.<span class="title function_">createPointLight</span>(<span class="string">&#x27;fireLight&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>), <span class="number">2.0</span>)</span><br><span class="line">fireLight.<span class="property">diffuse</span> = <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">0.5</span>, <span class="number">0.1</span>) <span class="comment">// 橙色火光</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加闪烁效果</span></span><br><span class="line"><span class="keyword">const</span> flicker = lightManager.<span class="title function_">addFlickerEffect</span>(<span class="string">&#x27;fireLight&#x27;</span>, <span class="number">0.3</span>, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置昼夜循环</span></span><br><span class="line"><span class="keyword">const</span> dayNight = lightManager.<span class="title function_">setupDayNightCycle</span>(<span class="number">60000</span>) <span class="comment">// 1分钟周期</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加阴影投射者</span></span><br><span class="line">lightManager.<span class="title function_">addShadowCasters</span>(<span class="string">&#x27;sunLight&#x27;</span>, scene.<span class="property">meshes</span>)</span><br></pre></td></tr></table></figure>

<h2 id="🎨-Material-材质系统详解"><a href="#🎨-Material-材质系统详解" class="headerlink" title="🎨 Material 材质系统详解"></a>🎨 Material 材质系统详解</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Material 材质系统完整管理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MaterialManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">textures</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">nodeMaterials</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupDefaultMaterials</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupDefaultMaterials</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 标准材质</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createStandardMaterial</span>(<span class="string">&#x27;defaultStandard&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// PBR材质</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createPBRMaterial</span>(<span class="string">&#x27;defaultPBR&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 无光材质</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">createUnlitMaterial</span>(<span class="string">&#x27;defaultUnlit&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 标准材质 (StandardMaterial)</span></span><br><span class="line">  <span class="title function_">createStandardMaterial</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">StandardMaterial</span>(name, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 基础颜色属性</span></span><br><span class="line">    <span class="comment">// diffuseColor: Color3 - 漫反射颜色</span></span><br><span class="line">    material.<span class="property">diffuseColor</span> = options.<span class="property">diffuseColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// specularColor: Color3 - 镜面反射颜色</span></span><br><span class="line">    material.<span class="property">specularColor</span> = options.<span class="property">specularColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// emissiveColor: Color3 - 自发光颜色</span></span><br><span class="line">    material.<span class="property">emissiveColor</span> = options.<span class="property">emissiveColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ambientColor: Color3 - 环境光颜色</span></span><br><span class="line">    material.<span class="property">ambientColor</span> = options.<span class="property">ambientColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 纹理属性</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">diffuseTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">diffuseTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">diffuseTexture</span>, name + <span class="string">&#x27;_diffuse&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">specularTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">specularTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">specularTexture</span>, name + <span class="string">&#x27;_specular&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">normalTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">bumpTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">normalTexture</span>, name + <span class="string">&#x27;_normal&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">emissiveTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">emissiveTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">emissiveTexture</span>, name + <span class="string">&#x27;_emissive&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">ambientTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">ambientTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">ambientTexture</span>, name + <span class="string">&#x27;_ambient&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 光照属性</span></span><br><span class="line">    <span class="comment">// specularPower: number - 镜面反射强度 (1-128)</span></span><br><span class="line">    material.<span class="property">specularPower</span> = options.<span class="property">specularPower</span> || <span class="number">64</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 透明度设置</span></span><br><span class="line">    <span class="comment">// alpha: number - 透明度 (0-1)</span></span><br><span class="line">    material.<span class="property">alpha</span> = options.<span class="property">alpha</span> !== <span class="literal">undefined</span> ? options.<span class="property">alpha</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 背面剔除</span></span><br><span class="line">    <span class="comment">// backFaceCulling: boolean - 是否剔除背面</span></span><br><span class="line">    material.<span class="property">backFaceCulling</span> =</span><br><span class="line">      options.<span class="property">backFaceCulling</span> !== <span class="literal">undefined</span> ? options.<span class="property">backFaceCulling</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 双面材质</span></span><br><span class="line">    <span class="comment">// twoSidedLighting: boolean - 双面光照</span></span><br><span class="line">    material.<span class="property">twoSidedLighting</span> = options.<span class="property">twoSidedLighting</span> || <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 线框模式</span></span><br><span class="line">    <span class="comment">// wireframe: boolean - 线框显示</span></span><br><span class="line">    material.<span class="property">wireframe</span> = options.<span class="property">wireframe</span> || <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 点模式</span></span><br><span class="line">    <span class="comment">// pointsCloud: boolean - 点云显示</span></span><br><span class="line">    material.<span class="property">pointsCloud</span> = options.<span class="property">pointsCloud</span> || <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// UV变换</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">uOffset</span> || options.<span class="property">vOffset</span> || options.<span class="property">uScale</span> || options.<span class="property">vScale</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setupUVTransform</span>(material.<span class="property">diffuseTexture</span>, options)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">set</span>(name, material)</span><br><span class="line">    <span class="keyword">return</span> material</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// PBR材质 (PBRMaterial) - 基于物理的渲染</span></span><br><span class="line">  <span class="title function_">createPBRMaterial</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">PBRMaterial</span>(name, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 基础颜色</span></span><br><span class="line">    <span class="comment">// baseColor: Color3 - 基础颜色</span></span><br><span class="line">    material.<span class="property">baseColor</span> = options.<span class="property">baseColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// baseTexture: Texture - 基础颜色纹理</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">baseTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">baseTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">baseTexture</span>, name + <span class="string">&#x27;_base&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 金属度和粗糙度</span></span><br><span class="line">    <span class="comment">// metallicFactor: number - 金属度 (0-1)</span></span><br><span class="line">    material.<span class="property">metallicFactor</span> = options.<span class="property">metallicFactor</span> !== <span class="literal">undefined</span> ? options.<span class="property">metallicFactor</span> : <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// roughnessFactor: number - 粗糙度 (0-1)</span></span><br><span class="line">    material.<span class="property">roughnessFactor</span> = options.<span class="property">roughnessFactor</span> !== <span class="literal">undefined</span> ? options.<span class="property">roughnessFactor</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// metallicRoughnessTexture: Texture - 金属度粗糙度纹理 (R通道-未使用, G通道-粗糙度, B通道-金属度)</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">metallicRoughnessTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">metallicRoughnessTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(</span><br><span class="line">        options.<span class="property">metallicRoughnessTexture</span>,</span><br><span class="line">        name + <span class="string">&#x27;_metallic_roughness&#x27;</span>,</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 法线贴图</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">normalTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">normalTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">normalTexture</span>, name + <span class="string">&#x27;_normal&#x27;</span>)</span><br><span class="line">      material.<span class="property">normalTextureScale</span> = options.<span class="property">normalScale</span> || <span class="number">1.0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 环境遮蔽</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">occlusionTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">ambientTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">occlusionTexture</span>, name + <span class="string">&#x27;_occlusion&#x27;</span>)</span><br><span class="line">      material.<span class="property">ambientTextureStrength</span> = options.<span class="property">occlusionStrength</span> || <span class="number">1.0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自发光</span></span><br><span class="line">    <span class="comment">// emissiveColor: Color3 - 自发光颜色</span></span><br><span class="line">    material.<span class="property">emissiveColor</span> = options.<span class="property">emissiveColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">emissiveTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">emissiveTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">emissiveTexture</span>, name + <span class="string">&#x27;_emissive&#x27;</span>)</span><br><span class="line">      material.<span class="property">emissiveIntensity</span> = options.<span class="property">emissiveIntensity</span> || <span class="number">1.0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 透明度</span></span><br><span class="line">    material.<span class="property">alpha</span> = options.<span class="property">alpha</span> !== <span class="literal">undefined</span> ? options.<span class="property">alpha</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 透明度模式</span></span><br><span class="line">    <span class="comment">// alphaMode: number - 透明度模式</span></span><br><span class="line">    <span class="comment">// ALPHA_DISABLE: 不透明</span></span><br><span class="line">    <span class="comment">// ALPHA_BLEND: 透明混合</span></span><br><span class="line">    <span class="comment">// ALPHA_MASK: 透明裁剪</span></span><br><span class="line">    material.<span class="property">transparencyMode</span> = options.<span class="property">transparencyMode</span> || <span class="title class_">PBRMaterial</span>.<span class="property">PBRMATERIAL_OPAQUE</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (material.<span class="property">transparencyMode</span> === <span class="title class_">PBRMaterial</span>.<span class="property">PBRMATERIAL_ALPHATEST</span>) &#123;</span><br><span class="line">      material.<span class="property">alphaCutOff</span> = options.<span class="property">alphaCutOff</span> || <span class="number">0.5</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 折射率</span></span><br><span class="line">    <span class="comment">// indexOfRefraction: number - 折射率</span></span><br><span class="line">    material.<span class="property">indexOfRefraction</span> = options.<span class="property">indexOfRefraction</span> || <span class="number">1.5</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清漆层 (Clear Coat)</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">clearCoat</span>) &#123;</span><br><span class="line">      material.<span class="property">clearCoat</span>.<span class="property">isEnabled</span> = <span class="literal">true</span></span><br><span class="line">      material.<span class="property">clearCoat</span>.<span class="property">intensity</span> = options.<span class="property">clearCoat</span>.<span class="property">intensity</span> || <span class="number">1.0</span></span><br><span class="line">      material.<span class="property">clearCoat</span>.<span class="property">roughness</span> = options.<span class="property">clearCoat</span>.<span class="property">roughness</span> || <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">clearCoat</span>.<span class="property">texture</span>) &#123;</span><br><span class="line">        material.<span class="property">clearCoat</span>.<span class="property">texture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(</span><br><span class="line">          options.<span class="property">clearCoat</span>.<span class="property">texture</span>,</span><br><span class="line">          name + <span class="string">&#x27;_clearcoat&#x27;</span>,</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">clearCoat</span>.<span class="property">normalTexture</span>) &#123;</span><br><span class="line">        material.<span class="property">clearCoat</span>.<span class="property">bumpTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(</span><br><span class="line">          options.<span class="property">clearCoat</span>.<span class="property">normalTexture</span>,</span><br><span class="line">          name + <span class="string">&#x27;_clearcoat_normal&#x27;</span>,</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 次表面散射 (Subsurface)</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">subsurface</span>) &#123;</span><br><span class="line">      material.<span class="property">subSurface</span>.<span class="property">isScatteringEnabled</span> = <span class="literal">true</span></span><br><span class="line">      material.<span class="property">subSurface</span>.<span class="property">scatteringColor</span> = options.<span class="property">subsurface</span>.<span class="property">color</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">      material.<span class="property">subSurface</span>.<span class="property">scatteringDistance</span> = options.<span class="property">subsurface</span>.<span class="property">distance</span> || <span class="number">1.0</span></span><br><span class="line">      material.<span class="property">subSurface</span>.<span class="property">scatteringIntensity</span> = options.<span class="property">subsurface</span>.<span class="property">intensity</span> || <span class="number">1.0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 光泽 (Sheen)</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">sheen</span>) &#123;</span><br><span class="line">      material.<span class="property">sheen</span>.<span class="property">isEnabled</span> = <span class="literal">true</span></span><br><span class="line">      material.<span class="property">sheen</span>.<span class="property">color</span> = options.<span class="property">sheen</span>.<span class="property">color</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">      material.<span class="property">sheen</span>.<span class="property">intensity</span> = options.<span class="property">sheen</span>.<span class="property">intensity</span> || <span class="number">1.0</span></span><br><span class="line">      material.<span class="property">sheen</span>.<span class="property">roughness</span> = options.<span class="property">sheen</span>.<span class="property">roughness</span> || <span class="number">0.0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 各向异性 (Anisotropy)</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">anisotropy</span>) &#123;</span><br><span class="line">      material.<span class="property">anisotropy</span>.<span class="property">isEnabled</span> = <span class="literal">true</span></span><br><span class="line">      material.<span class="property">anisotropy</span>.<span class="property">intensity</span> = options.<span class="property">anisotropy</span>.<span class="property">intensity</span> || <span class="number">1.0</span></span><br><span class="line">      material.<span class="property">anisotropy</span>.<span class="property">direction</span> = options.<span class="property">anisotropy</span>.<span class="property">direction</span> || <span class="keyword">new</span> <span class="title class_">Vector2</span>(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">set</span>(name, material)</span><br><span class="line">    <span class="keyword">return</span> material</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 无光材质 (UnlitMaterial) - 不受光照影响</span></span><br><span class="line">  <span class="title function_">createUnlitMaterial</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">UnlitMaterial</span>(name, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 基础颜色</span></span><br><span class="line">    material.<span class="property">diffuseColor</span> = options.<span class="property">diffuseColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 纹理</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">diffuseTexture</span>) &#123;</span><br><span class="line">      material.<span class="property">diffuseTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">diffuseTexture</span>, name + <span class="string">&#x27;_diffuse&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 透明度</span></span><br><span class="line">    material.<span class="property">alpha</span> = options.<span class="property">alpha</span> !== <span class="literal">undefined</span> ? options.<span class="property">alpha</span> : <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 背面剔除</span></span><br><span class="line">    material.<span class="property">backFaceCulling</span> =</span><br><span class="line">      options.<span class="property">backFaceCulling</span> !== <span class="literal">undefined</span> ? options.<span class="property">backFaceCulling</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">set</span>(name, material)</span><br><span class="line">    <span class="keyword">return</span> material</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 节点材质 (NodeMaterial) - 可视化节点编辑器材质</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">createNodeMaterial</span>(<span class="params">name, nodeJsonUrl</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">NodeMaterial</span>(name, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从JSON加载节点材质</span></span><br><span class="line">    <span class="keyword">await</span> material.<span class="title function_">loadFromUrl</span>(nodeJsonUrl)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建材质</span></span><br><span class="line">    material.<span class="title function_">build</span>(<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">nodeMaterials</span>.<span class="title function_">set</span>(name, material)</span><br><span class="line">    <span class="keyword">return</span> material</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 自定义着色器材质 (ShaderMaterial)</span></span><br><span class="line">  <span class="title function_">createShaderMaterial</span>(<span class="params">name, vertexShader, fragmentShader, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> shaderMaterial = <span class="keyword">new</span> <span class="title class_">ShaderMaterial</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">vertex</span>: vertexShader,</span><br><span class="line">        <span class="attr">fragment</span>: fragmentShader,</span><br><span class="line">      &#125;,</span><br><span class="line">      options,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置uniforms</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">uniforms</span>) &#123;</span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">keys</span>(options.<span class="property">uniforms</span>).<span class="title function_">forEach</span>(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">        shaderMaterial.<span class="title function_">setFloat</span>(key, options.<span class="property">uniforms</span>[key])</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置纹理</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">textures</span>) &#123;</span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">keys</span>(options.<span class="property">textures</span>).<span class="title function_">forEach</span>(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> texture = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(options.<span class="property">textures</span>[key], <span class="string">`<span class="subst">$&#123;name&#125;</span>_<span class="subst">$&#123;key&#125;</span>`</span>)</span><br><span class="line">        shaderMaterial.<span class="title function_">setTexture</span>(key, texture)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">set</span>(name, shaderMaterial)</span><br><span class="line">    <span class="keyword">return</span> shaderMaterial</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 程序化材质</span></span><br><span class="line">  <span class="title function_">createProceduralMaterial</span>(<span class="params">name, type, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> material</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;wood&#x27;</span>:</span><br><span class="line">        material = <span class="variable language_">this</span>.<span class="title function_">createWoodMaterial</span>(name, options)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;marble&#x27;</span>:</span><br><span class="line">        material = <span class="variable language_">this</span>.<span class="title function_">createMarbleMaterial</span>(name, options)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;fire&#x27;</span>:</span><br><span class="line">        material = <span class="variable language_">this</span>.<span class="title function_">createFireMaterial</span>(name, options)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;water&#x27;</span>:</span><br><span class="line">        material = <span class="variable language_">this</span>.<span class="title function_">createWaterMaterial</span>(name, options)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;grass&#x27;</span>:</span><br><span class="line">        material = <span class="variable language_">this</span>.<span class="title function_">createGrassMaterial</span>(name, options)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;未知的程序化材质类型:&#x27;</span>, type)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">set</span>(name, material)</span><br><span class="line">    <span class="keyword">return</span> material</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 木材材质</span></span><br><span class="line">  <span class="title function_">createWoodMaterial</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">WoodProceduralTexture</span>.<span class="title class_">WoodProceduralTexture</span>(name, <span class="number">256</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 木材参数</span></span><br><span class="line">    material.<span class="property">woodColor</span> = options.<span class="property">woodColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.49</span>, <span class="number">0.25</span>, <span class="number">0</span>)</span><br><span class="line">    material.<span class="property">ringColor</span> = options.<span class="property">ringColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.4</span>, <span class="number">0.1</span>, <span class="number">0.1</span>)</span><br><span class="line">    material.<span class="property">textureSize</span> = options.<span class="property">textureSize</span> || <span class="keyword">new</span> <span class="title class_">Vector2</span>(<span class="number">256</span>, <span class="number">256</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> standardMaterial = <span class="keyword">new</span> <span class="title class_">StandardMaterial</span>(name + <span class="string">&#x27;_standard&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    standardMaterial.<span class="property">diffuseTexture</span> = material</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> standardMaterial</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 大理石材质</span></span><br><span class="line">  <span class="title function_">createMarbleMaterial</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">MarbleProceduralTexture</span>.<span class="title class_">MarbleProceduralTexture</span>(name, <span class="number">256</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 大理石参数</span></span><br><span class="line">    material.<span class="property">marbleColor</span> = options.<span class="property">marbleColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.77</span>, <span class="number">0.47</span>, <span class="number">0.38</span>)</span><br><span class="line">    material.<span class="property">jointColor</span> = options.<span class="property">jointColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.72</span>, <span class="number">0.72</span>, <span class="number">0.72</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> standardMaterial = <span class="keyword">new</span> <span class="title class_">StandardMaterial</span>(name + <span class="string">&#x27;_standard&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    standardMaterial.<span class="property">diffuseTexture</span> = material</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> standardMaterial</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 火焰材质</span></span><br><span class="line">  <span class="title function_">createFireMaterial</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">FireProceduralTexture</span>.<span class="title class_">FireProceduralTexture</span>(name, <span class="number">256</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 火焰参数</span></span><br><span class="line">    material.<span class="property">fireColors</span> = options.<span class="property">fireColors</span> || <span class="title class_">FireProceduralTexture</span>.<span class="property">RedFireColors</span></span><br><span class="line">    material.<span class="property">speed</span> = options.<span class="property">speed</span> || <span class="keyword">new</span> <span class="title class_">Vector2</span>(<span class="number">1.0</span>, <span class="number">1.0</span>)</span><br><span class="line">    material.<span class="property">shift</span> = options.<span class="property">shift</span> || <span class="number">1.6</span></span><br><span class="line">    material.<span class="property">alpha</span> = options.<span class="property">alpha</span> || <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> unlitMaterial = <span class="keyword">new</span> <span class="title class_">UnlitMaterial</span>(name + <span class="string">&#x27;_unlit&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    unlitMaterial.<span class="property">diffuseTexture</span> = material</span><br><span class="line">    unlitMaterial.<span class="property">hasAlpha</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> unlitMaterial</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 水材质</span></span><br><span class="line">  <span class="title function_">createWaterMaterial</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> waterMesh = options.<span class="property">waterMesh</span></span><br><span class="line">    <span class="keyword">const</span> skybox = options.<span class="property">skybox</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> waterMaterial = <span class="keyword">new</span> <span class="title class_">WaterMaterial</span>(name, <span class="variable language_">this</span>.<span class="property">scene</span>, <span class="keyword">new</span> <span class="title class_">Vector2</span>(<span class="number">512</span>, <span class="number">512</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 水面参数</span></span><br><span class="line">    waterMaterial.<span class="property">backFaceCulling</span> = <span class="literal">true</span></span><br><span class="line">    waterMaterial.<span class="property">bumpTexture</span> = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(</span><br><span class="line">      options.<span class="property">bumpTexture</span> || <span class="string">&#x27;/textures/water_normal.jpg&#x27;</span>,</span><br><span class="line">      name + <span class="string">&#x27;_bump&#x27;</span>,</span><br><span class="line">    )</span><br><span class="line">    waterMaterial.<span class="property">windForce</span> = options.<span class="property">windForce</span> || -<span class="number">10</span></span><br><span class="line">    waterMaterial.<span class="property">waveHeight</span> = options.<span class="property">waveHeight</span> || <span class="number">0.5</span></span><br><span class="line">    waterMaterial.<span class="property">bumpHeight</span> = options.<span class="property">bumpHeight</span> || <span class="number">0.4</span></span><br><span class="line">    waterMaterial.<span class="property">windDirection</span> = options.<span class="property">windDirection</span> || <span class="keyword">new</span> <span class="title class_">Vector2</span>(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">    waterMaterial.<span class="property">waterColor</span> = options.<span class="property">waterColor</span> || <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.1</span>, <span class="number">0.1</span>, <span class="number">0.6</span>)</span><br><span class="line">    waterMaterial.<span class="property">colorBlendFactor</span> = options.<span class="property">colorBlendFactor</span> || <span class="number">0.2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加到渲染列表</span></span><br><span class="line">    <span class="keyword">if</span> (waterMesh) &#123;</span><br><span class="line">      waterMaterial.<span class="title function_">addToRenderList</span>(waterMesh)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (skybox) &#123;</span><br><span class="line">      waterMaterial.<span class="title function_">addToRenderList</span>(skybox)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> waterMaterial</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 草地材质</span></span><br><span class="line">  <span class="title function_">createGrassMaterial</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> <span class="title class_">GrassProceduralTexture</span>.<span class="title class_">GrassProceduralTexture</span>(name, <span class="number">256</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 草地参数</span></span><br><span class="line">    material.<span class="property">grassColors</span> = options.<span class="property">grassColors</span> || [</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.29</span>, <span class="number">0.38</span>, <span class="number">0.02</span>),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.36</span>, <span class="number">0.49</span>, <span class="number">0.09</span>),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.51</span>, <span class="number">0.6</span>, <span class="number">0.28</span>),</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> standardMaterial = <span class="keyword">new</span> <span class="title class_">StandardMaterial</span>(name + <span class="string">&#x27;_standard&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    standardMaterial.<span class="property">diffuseTexture</span> = material</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> standardMaterial</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 纹理加载和管理</span></span><br><span class="line">  <span class="title function_">loadTexture</span>(<span class="params">url, name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// 检查是否已加载</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">has</span>(name)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> texture = <span class="keyword">new</span> <span class="title class_">Texture</span>(url, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 纹理设置</span></span><br><span class="line">    texture.<span class="property">name</span> = name</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 包装模式</span></span><br><span class="line">    <span class="comment">// WRAP_ADDRESSMODE: 重复</span></span><br><span class="line">    <span class="comment">// CLAMP_ADDRESSMODE: 钳制</span></span><br><span class="line">    <span class="comment">// MIRROR_ADDRESSMODE: 镜像</span></span><br><span class="line">    texture.<span class="property">wrapU</span> = options.<span class="property">wrapU</span> || <span class="title class_">Texture</span>.<span class="property">WRAP_ADDRESSMODE</span></span><br><span class="line">    texture.<span class="property">wrapV</span> = options.<span class="property">wrapV</span> || <span class="title class_">Texture</span>.<span class="property">WRAP_ADDRESSMODE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 过滤模式</span></span><br><span class="line">    <span class="comment">// NEAREST_SAMPLINGMODE: 最近邻</span></span><br><span class="line">    <span class="comment">// BILINEAR_SAMPLINGMODE: 双线性</span></span><br><span class="line">    <span class="comment">// TRILINEAR_SAMPLINGMODE: 三线性</span></span><br><span class="line">    texture.<span class="property">samplingMode</span> = options.<span class="property">samplingMode</span> || <span class="title class_">Texture</span>.<span class="property">TRILINEAR_SAMPLINGMODE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Mipmap</span></span><br><span class="line">    texture.<span class="property">generateMipMaps</span> = options.<span class="property">generateMipMaps</span> !== <span class="literal">undefined</span> ? options.<span class="property">generateMipMaps</span> : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 各向异性过滤</span></span><br><span class="line">    texture.<span class="property">anisotropicFilteringLevel</span> = options.<span class="property">anisotropicFilteringLevel</span> || <span class="number">4</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// UV偏移和缩放</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">uOffset</span> !== <span class="literal">undefined</span>) texture.<span class="property">uOffset</span> = options.<span class="property">uOffset</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">vOffset</span> !== <span class="literal">undefined</span>) texture.<span class="property">vOffset</span> = options.<span class="property">vOffset</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">uScale</span> !== <span class="literal">undefined</span>) texture.<span class="property">uScale</span> = options.<span class="property">uScale</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">vScale</span> !== <span class="literal">undefined</span>) texture.<span class="property">vScale</span> = options.<span class="property">vScale</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// UV旋转</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">uAng</span> !== <span class="literal">undefined</span>) texture.<span class="property">uAng</span> = options.<span class="property">uAng</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">vAng</span> !== <span class="literal">undefined</span>) texture.<span class="property">vAng</span> = options.<span class="property">vAng</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">wAng</span> !== <span class="literal">undefined</span>) texture.<span class="property">wAng</span> = options.<span class="property">wAng</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 级别调整</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">level</span> !== <span class="literal">undefined</span>) texture.<span class="property">level</span> = options.<span class="property">level</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">set</span>(name, texture)</span><br><span class="line">    <span class="keyword">return</span> texture</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 立方体纹理加载 (Skybox/Environment)</span></span><br><span class="line">  <span class="title function_">loadCubeTexture</span>(<span class="params">urls, name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">has</span>(name)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> cubeTexture</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(urls)) &#123;</span><br><span class="line">      <span class="comment">// 6个面的纹理</span></span><br><span class="line">      cubeTexture = <span class="keyword">new</span> <span class="title class_">CubeTexture</span>.<span class="title class_">CreateFromImages</span>(urls, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// DDS或HDR格式</span></span><br><span class="line">      cubeTexture = <span class="keyword">new</span> <span class="title class_">CubeTexture</span>(urls, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cubeTexture.<span class="property">name</span> = name</span><br><span class="line">    cubeTexture.<span class="property">coordinatesMode</span> = options.<span class="property">coordinatesMode</span> || <span class="title class_">Texture</span>.<span class="property">SKYBOX_MODE</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">set</span>(name, cubeTexture)</span><br><span class="line">    <span class="keyword">return</span> cubeTexture</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// UV变换设置</span></span><br><span class="line">  <span class="title function_">setupUVTransform</span>(<span class="params">texture, options</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!texture) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">uOffset</span> !== <span class="literal">undefined</span>) texture.<span class="property">uOffset</span> = options.<span class="property">uOffset</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">vOffset</span> !== <span class="literal">undefined</span>) texture.<span class="property">vOffset</span> = options.<span class="property">vOffset</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">uScale</span> !== <span class="literal">undefined</span>) texture.<span class="property">uScale</span> = options.<span class="property">uScale</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">vScale</span> !== <span class="literal">undefined</span>) texture.<span class="property">vScale</span> = options.<span class="property">vScale</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">uAng</span> !== <span class="literal">undefined</span>) texture.<span class="property">uAng</span> = options.<span class="property">uAng</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">vAng</span> !== <span class="literal">undefined</span>) texture.<span class="property">vAng</span> = options.<span class="property">vAng</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// UV动画</span></span><br><span class="line">  <span class="title function_">animateUV</span>(<span class="params">textureName, property, targetValue, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> texture = <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">get</span>(textureName)</span><br><span class="line">    <span class="keyword">if</span> (!texture) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> animation = <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;textureName&#125;</span>_<span class="subst">$&#123;property&#125;</span>`</span>,</span><br><span class="line">      texture,</span><br><span class="line">      property,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">      texture[property],</span><br><span class="line">      targetValue,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 滚动UV效果</span></span><br><span class="line">  <span class="title function_">addScrollingUV</span>(<span class="params">textureName, speedU = <span class="number">0.01</span>, speedV = <span class="number">0.01</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> texture = <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">get</span>(textureName)</span><br><span class="line">    <span class="keyword">if</span> (!texture) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> observer = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      texture.<span class="property">uOffset</span> += speedU * <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>().<span class="title function_">getDeltaTime</span>() * <span class="number">0.001</span></span><br><span class="line">      texture.<span class="property">vOffset</span> += speedV * <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getEngine</span>().<span class="title function_">getDeltaTime</span>() * <span class="number">0.001</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 防止数值过大</span></span><br><span class="line">      <span class="keyword">if</span> (texture.<span class="property">uOffset</span> &gt; <span class="number">1</span>) texture.<span class="property">uOffset</span> -= <span class="number">1</span></span><br><span class="line">      <span class="keyword">if</span> (texture.<span class="property">vOffset</span> &gt; <span class="number">1</span>) texture.<span class="property">vOffset</span> -= <span class="number">1</span></span><br><span class="line">      <span class="keyword">if</span> (texture.<span class="property">uOffset</span> &lt; <span class="number">0</span>) texture.<span class="property">uOffset</span> += <span class="number">1</span></span><br><span class="line">      <span class="keyword">if</span> (texture.<span class="property">vOffset</span> &lt; <span class="number">0</span>) texture.<span class="property">vOffset</span> += <span class="number">1</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">dispose</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">remove</span>(observer)</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 材质混合</span></span><br><span class="line">  <span class="title function_">blendMaterials</span>(<span class="params">name, material1, material2, blendFactor = <span class="number">0.5</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> blendedMaterial = <span class="keyword">new</span> <span class="title class_">StandardMaterial</span>(name, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 混合颜色</span></span><br><span class="line">    blendedMaterial.<span class="property">diffuseColor</span> = <span class="title class_">Color3</span>.<span class="title class_">Lerp</span>(</span><br><span class="line">      material1.<span class="property">diffuseColor</span> || <span class="title class_">Color3</span>.<span class="title class_">White</span>(),</span><br><span class="line">      material2.<span class="property">diffuseColor</span> || <span class="title class_">Color3</span>.<span class="title class_">White</span>(),</span><br><span class="line">      blendFactor,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    blendedMaterial.<span class="property">specularColor</span> = <span class="title class_">Color3</span>.<span class="title class_">Lerp</span>(</span><br><span class="line">      material1.<span class="property">specularColor</span> || <span class="title class_">Color3</span>.<span class="title class_">White</span>(),</span><br><span class="line">      material2.<span class="property">specularColor</span> || <span class="title class_">Color3</span>.<span class="title class_">White</span>(),</span><br><span class="line">      blendFactor,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 混合纹理（通过混合着色器）</span></span><br><span class="line">    <span class="keyword">if</span> (material1.<span class="property">diffuseTexture</span> &amp;&amp; material2.<span class="property">diffuseTexture</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> mixedShader = <span class="variable language_">this</span>.<span class="title function_">createTextureBlendShader</span>(</span><br><span class="line">        name + <span class="string">&#x27;_blend&#x27;</span>,</span><br><span class="line">        material1.<span class="property">diffuseTexture</span>,</span><br><span class="line">        material2.<span class="property">diffuseTexture</span>,</span><br><span class="line">        blendFactor,</span><br><span class="line">      )</span><br><span class="line">      blendedMaterial.<span class="property">diffuseTexture</span> = mixedShader</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">set</span>(name, blendedMaterial)</span><br><span class="line">    <span class="keyword">return</span> blendedMaterial</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 纹理混合着色器</span></span><br><span class="line">  <span class="title function_">createTextureBlendShader</span>(<span class="params">name, texture1, texture2, blendFactor</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> shaderMaterial = <span class="keyword">new</span> <span class="title class_">ShaderMaterial</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">vertex</span>: <span class="string">`</span></span><br><span class="line"><span class="string">        precision highp float;</span></span><br><span class="line"><span class="string">        attribute vec3 position;</span></span><br><span class="line"><span class="string">        attribute vec2 uv;</span></span><br><span class="line"><span class="string">        uniform mat4 worldViewProjection;</span></span><br><span class="line"><span class="string">        varying vec2 vUV;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        void main(void) &#123;</span></span><br><span class="line"><span class="string">          gl_Position = worldViewProjection * vec4(position, 1.0);</span></span><br><span class="line"><span class="string">          vUV = uv;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      `</span>,</span><br><span class="line">        <span class="attr">fragment</span>: <span class="string">`</span></span><br><span class="line"><span class="string">        precision highp float;</span></span><br><span class="line"><span class="string">        varying vec2 vUV;</span></span><br><span class="line"><span class="string">        uniform sampler2D texture1;</span></span><br><span class="line"><span class="string">        uniform sampler2D texture2;</span></span><br><span class="line"><span class="string">        uniform float blendFactor;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        void main(void) &#123;</span></span><br><span class="line"><span class="string">          vec4 color1 = texture2D(texture1, vUV);</span></span><br><span class="line"><span class="string">          vec4 color2 = texture2D(texture2, vUV);</span></span><br><span class="line"><span class="string">          gl_FragColor = mix(color1, color2, blendFactor);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      `</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">attributes</span>: [<span class="string">&#x27;position&#x27;</span>, <span class="string">&#x27;uv&#x27;</span>],</span><br><span class="line">        <span class="attr">uniforms</span>: [<span class="string">&#x27;worldViewProjection&#x27;</span>, <span class="string">&#x27;blendFactor&#x27;</span>],</span><br><span class="line">        <span class="attr">samplers</span>: [<span class="string">&#x27;texture1&#x27;</span>, <span class="string">&#x27;texture2&#x27;</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    shaderMaterial.<span class="title function_">setTexture</span>(<span class="string">&#x27;texture1&#x27;</span>, texture1)</span><br><span class="line">    shaderMaterial.<span class="title function_">setTexture</span>(<span class="string">&#x27;texture2&#x27;</span>, texture2)</span><br><span class="line">    shaderMaterial.<span class="title function_">setFloat</span>(<span class="string">&#x27;blendFactor&#x27;</span>, blendFactor)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> shaderMaterial</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 材质动画</span></span><br><span class="line">  <span class="title function_">animateMaterial</span>(<span class="params">materialName, property, targetValue, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">get</span>(materialName)</span><br><span class="line">    <span class="keyword">if</span> (!material) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> animation = <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;materialName&#125;</span>_<span class="subst">$&#123;property&#125;</span>`</span>,</span><br><span class="line">      material,</span><br><span class="line">      property,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">      material[property],</span><br><span class="line">      targetValue,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 材质切换动画</span></span><br><span class="line">  <span class="title function_">createMaterialTransition</span>(<span class="params">mesh, fromMaterial, toMaterial, duration = <span class="number">1000</span></span>) &#123;</span><br><span class="line">    <span class="comment">// 创建过渡材质</span></span><br><span class="line">    <span class="keyword">const</span> transitionMaterial = fromMaterial.<span class="title function_">clone</span>(mesh.<span class="property">name</span> + <span class="string">&#x27;_transition&#x27;</span>)</span><br><span class="line">    mesh.<span class="property">material</span> = transitionMaterial</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果是StandardMaterial，可以动画颜色属性</span></span><br><span class="line">    <span class="keyword">if</span> (transitionMaterial <span class="keyword">instanceof</span> <span class="title class_">StandardMaterial</span> &amp;&amp; toMaterial <span class="keyword">instanceof</span> <span class="title class_">StandardMaterial</span>) &#123;</span><br><span class="line">      <span class="comment">// 颜色过渡</span></span><br><span class="line">      <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;materialTransition_diffuse&#x27;</span>,</span><br><span class="line">        transitionMaterial,</span><br><span class="line">        <span class="string">&#x27;diffuseColor&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">        fromMaterial.<span class="property">diffuseColor</span>.<span class="title function_">clone</span>(),</span><br><span class="line">        toMaterial.<span class="property">diffuseColor</span>.<span class="title function_">clone</span>(),</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// 动画完成后切换到目标材质</span></span><br><span class="line">          mesh.<span class="property">material</span> = toMaterial</span><br><span class="line">          transitionMaterial.<span class="title function_">dispose</span>()</span><br><span class="line">        &#125;,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;materialTransition_specular&#x27;</span>,</span><br><span class="line">        transitionMaterial,</span><br><span class="line">        <span class="string">&#x27;specularColor&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">        fromMaterial.<span class="property">specularColor</span>.<span class="title function_">clone</span>(),</span><br><span class="line">        toMaterial.<span class="property">specularColor</span>.<span class="title function_">clone</span>(),</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取材质信息</span></span><br><span class="line">  <span class="title function_">getMaterialInfo</span>(<span class="params">materialName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">get</span>(materialName)</span><br><span class="line">    <span class="keyword">if</span> (!material) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> info = &#123;</span><br><span class="line">      <span class="attr">name</span>: materialName,</span><br><span class="line">      <span class="attr">type</span>: material.<span class="title function_">getClassName</span>(),</span><br><span class="line">      <span class="attr">alpha</span>: material.<span class="property">alpha</span>,</span><br><span class="line">      <span class="attr">backFaceCulling</span>: material.<span class="property">backFaceCulling</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (material <span class="keyword">instanceof</span> <span class="title class_">StandardMaterial</span>) &#123;</span><br><span class="line">      info.<span class="property">diffuseColor</span> = material.<span class="property">diffuseColor</span></span><br><span class="line">      info.<span class="property">specularColor</span> = material.<span class="property">specularColor</span></span><br><span class="line">      info.<span class="property">emissiveColor</span> = material.<span class="property">emissiveColor</span></span><br><span class="line">      info.<span class="property">specularPower</span> = material.<span class="property">specularPower</span></span><br><span class="line">      info.<span class="property">hasTextures</span> = &#123;</span><br><span class="line">        <span class="attr">diffuse</span>: !!material.<span class="property">diffuseTexture</span>,</span><br><span class="line">        <span class="attr">specular</span>: !!material.<span class="property">specularTexture</span>,</span><br><span class="line">        <span class="attr">normal</span>: !!material.<span class="property">bumpTexture</span>,</span><br><span class="line">        <span class="attr">emissive</span>: !!material.<span class="property">emissiveTexture</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (material <span class="keyword">instanceof</span> <span class="title class_">PBRMaterial</span>) &#123;</span><br><span class="line">      info.<span class="property">baseColor</span> = material.<span class="property">baseColor</span></span><br><span class="line">      info.<span class="property">metallicFactor</span> = material.<span class="property">metallicFactor</span></span><br><span class="line">      info.<span class="property">roughnessFactor</span> = material.<span class="property">roughnessFactor</span></span><br><span class="line">      info.<span class="property">emissiveColor</span> = material.<span class="property">emissiveColor</span></span><br><span class="line">      info.<span class="property">hasTextures</span> = &#123;</span><br><span class="line">        <span class="attr">base</span>: !!material.<span class="property">baseTexture</span>,</span><br><span class="line">        <span class="attr">metallicRoughness</span>: !!material.<span class="property">metallicRoughnessTexture</span>,</span><br><span class="line">        <span class="attr">normal</span>: !!material.<span class="property">normalTexture</span>,</span><br><span class="line">        <span class="attr">emissive</span>: !!material.<span class="property">emissiveTexture</span>,</span><br><span class="line">        <span class="attr">occlusion</span>: !!material.<span class="property">ambientTexture</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 批量应用材质</span></span><br><span class="line">  <span class="title function_">applyMaterialToMeshes</span>(<span class="params">materialName, meshes</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">get</span>(materialName)</span><br><span class="line">    <span class="keyword">if</span> (!material) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    meshes.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      mesh.<span class="property">material</span> = material</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据距离切换材质LOD</span></span><br><span class="line">  <span class="title function_">setupMaterialLOD</span>(<span class="params">meshName, materials</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">getMeshByName</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// materials: [&#123; distance: number, material: string &#125;, ...]</span></span><br><span class="line">    <span class="keyword">const</span> sortedMaterials = materials.<span class="title function_">sort</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a.<span class="property">distance</span> - b.<span class="property">distance</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> observer = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">activeCamera</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> distance = <span class="title class_">Vector3</span>.<span class="title class_">Distance</span>(mesh.<span class="property">position</span>, <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">activeCamera</span>.<span class="property">position</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = sortedMaterials.<span class="property">length</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">if</span> (distance &gt;= sortedMaterials[i].<span class="property">distance</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> material = <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">get</span>(sortedMaterials[i].<span class="property">material</span>)</span><br><span class="line">          <span class="keyword">if</span> (material &amp;&amp; mesh.<span class="property">material</span> !== material) &#123;</span><br><span class="line">            mesh.<span class="property">material</span> = material</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">dispose</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onBeforeRenderObservable</span>.<span class="title function_">remove</span>(observer)</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 保存材质设置</span></span><br><span class="line">  <span class="title function_">saveMaterialSetup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> setup = &#123;</span><br><span class="line">      <span class="attr">materials</span>: [],</span><br><span class="line">      <span class="attr">textures</span>: [],</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">material, name</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">materials</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: name,</span><br><span class="line">        ...<span class="variable language_">this</span>.<span class="title function_">getMaterialInfo</span>(name),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">texture, name</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">textures</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: name,</span><br><span class="line">        <span class="attr">url</span>: texture.<span class="property">url</span>,</span><br><span class="line">        <span class="attr">wrapU</span>: texture.<span class="property">wrapU</span>,</span><br><span class="line">        <span class="attr">wrapV</span>: texture.<span class="property">wrapV</span>,</span><br><span class="line">        <span class="attr">uOffset</span>: texture.<span class="property">uOffset</span>,</span><br><span class="line">        <span class="attr">vOffset</span>: texture.<span class="property">vOffset</span>,</span><br><span class="line">        <span class="attr">uScale</span>: texture.<span class="property">uScale</span>,</span><br><span class="line">        <span class="attr">vScale</span>: texture.<span class="property">vScale</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> setup</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 资源清理</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">nodeMaterials</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">material</span>) =&gt;</span> &#123;</span><br><span class="line">      material.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">nodeMaterials</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">material</span>) =&gt;</span> &#123;</span><br><span class="line">      material.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">texture</span>) =&gt;</span> &#123;</span><br><span class="line">      texture.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> materialManager = <span class="keyword">new</span> <span class="title class_">MaterialManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建PBR金属材质</span></span><br><span class="line"><span class="keyword">const</span> metalMaterial = materialManager.<span class="title function_">createPBRMaterial</span>(<span class="string">&#x27;metal&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">baseColor</span>: <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.7</span>, <span class="number">0.7</span>, <span class="number">0.7</span>),</span><br><span class="line">  <span class="attr">metallicFactor</span>: <span class="number">1.0</span>,</span><br><span class="line">  <span class="attr">roughnessFactor</span>: <span class="number">0.2</span>,</span><br><span class="line">  <span class="attr">baseTexture</span>: <span class="string">&#x27;/textures/metal_base.jpg&#x27;</span>,</span><br><span class="line">  <span class="attr">normalTexture</span>: <span class="string">&#x27;/textures/metal_normal.jpg&#x27;</span>,</span><br><span class="line">  <span class="attr">metallicRoughnessTexture</span>: <span class="string">&#x27;/textures/metal_metallic_roughness.jpg&#x27;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建程序化木材材质</span></span><br><span class="line"><span class="keyword">const</span> woodMaterial = materialManager.<span class="title function_">createProceduralMaterial</span>(<span class="string">&#x27;wood&#x27;</span>, <span class="string">&#x27;wood&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">woodColor</span>: <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.6</span>, <span class="number">0.3</span>, <span class="number">0.1</span>),</span><br><span class="line">  <span class="attr">ringColor</span>: <span class="keyword">new</span> <span class="title class_">Color3</span>(<span class="number">0.4</span>, <span class="number">0.2</span>, <span class="number">0.05</span>),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 应用材质到网格</span></span><br><span class="line"><span class="keyword">const</span> sphere = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateSphere</span>(<span class="string">&#x27;sphere&#x27;</span>, &#123; <span class="attr">diameter</span>: <span class="number">2</span> &#125;, scene)</span><br><span class="line">sphere.<span class="property">material</span> = metalMaterial</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加UV滚动效果</span></span><br><span class="line"><span class="keyword">const</span> scrollEffect = materialManager.<span class="title function_">addScrollingUV</span>(<span class="string">&#x27;metal_metal_base&#x27;</span>, <span class="number">0.02</span>, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h2 id="🎭-Mesh-网格系统详解"><a href="#🎭-Mesh-网格系统详解" class="headerlink" title="🎭 Mesh 网格系统详解"></a>🎭 Mesh 网格系统详解</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Mesh 网格系统完整管理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MeshManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">instancedMeshes</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mergedMeshes</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupBuiltInGeometries</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupBuiltInGeometries</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 注册基础几何体创建器</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">geometryCreators</span> = &#123;</span><br><span class="line">      <span class="attr">box</span>: <span class="variable language_">this</span>.<span class="property">createBox</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">sphere</span>: <span class="variable language_">this</span>.<span class="property">createSphere</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">cylinder</span>: <span class="variable language_">this</span>.<span class="property">createCylinder</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">plane</span>: <span class="variable language_">this</span>.<span class="property">createPlane</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">ground</span>: <span class="variable language_">this</span>.<span class="property">createGround</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">torus</span>: <span class="variable language_">this</span>.<span class="property">createTorus</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">cone</span>: <span class="variable language_">this</span>.<span class="property">createCone</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">polyhedron</span>: <span class="variable language_">this</span>.<span class="property">createPolyhedron</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">ribbon</span>: <span class="variable language_">this</span>.<span class="property">createRibbon</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">tube</span>: <span class="variable language_">this</span>.<span class="property">createTube</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">lines</span>: <span class="variable language_">this</span>.<span class="property">createLines</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">      <span class="attr">dashedLines</span>: <span class="variable language_">this</span>.<span class="property">createDashedLines</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 立方体创建</span></span><br><span class="line">  <span class="title function_">createBox</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// size: number - 统一尺寸</span></span><br><span class="line">      <span class="attr">size</span>: options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// width, height, depth: number - 分别设置宽高深</span></span><br><span class="line">      <span class="attr">width</span>: options.<span class="property">width</span> || options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">height</span>: options.<span class="property">height</span> || options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">depth</span>: options.<span class="property">depth</span> || options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// faceUV: Vector4[] - 每个面的UV坐标</span></span><br><span class="line">      <span class="attr">faceUV</span>: options.<span class="property">faceUV</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// faceColors: Color4[] - 每个面的颜色</span></span><br><span class="line">      <span class="attr">faceColors</span>: options.<span class="property">faceColors</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number - 面朝向</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// frontUVs, backUVs: Vector4 - 正面背面UV</span></span><br><span class="line">      <span class="attr">frontUVs</span>: options.<span class="property">frontUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">      <span class="attr">backUVs</span>: options.<span class="property">backUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line"></span><br><span class="line">      <span class="comment">// wrap: boolean - 是否环绕</span></span><br><span class="line">      <span class="attr">wrap</span>: options.<span class="property">wrap</span> || <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// topBaseAt: number - 顶部位置</span></span><br><span class="line">      <span class="attr">topBaseAt</span>: options.<span class="property">topBaseAt</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// bottomBaseAt: number - 底部位置</span></span><br><span class="line">      <span class="attr">bottomBaseAt</span>: options.<span class="property">bottomBaseAt</span> || <span class="number">0</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateBox</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 球体创建</span></span><br><span class="line">  <span class="title function_">createSphere</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// diameter: number - 直径</span></span><br><span class="line">      <span class="attr">diameter</span>: options.<span class="property">diameter</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// diameterX, diameterY, diameterZ: number - 椭球参数</span></span><br><span class="line">      <span class="attr">diameterX</span>: options.<span class="property">diameterX</span> || options.<span class="property">diameter</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">diameterY</span>: options.<span class="property">diameterY</span> || options.<span class="property">diameter</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">diameterZ</span>: options.<span class="property">diameterZ</span> || options.<span class="property">diameter</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// segments: number - 分段数</span></span><br><span class="line">      <span class="attr">segments</span>: options.<span class="property">segments</span> || <span class="number">32</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// arc: number - 弧度（0-1，1为完整球体）</span></span><br><span class="line">      <span class="attr">arc</span>: options.<span class="property">arc</span> || <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// slice: number - 切片（0-1，1为完整球体）</span></span><br><span class="line">      <span class="attr">slice</span>: options.<span class="property">slice</span> || <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number - 面朝向</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// frontUVs, backUVs: Vector4</span></span><br><span class="line">      <span class="attr">frontUVs</span>: options.<span class="property">frontUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">      <span class="attr">backUVs</span>: options.<span class="property">backUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateSphere</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 圆柱体创建</span></span><br><span class="line">  <span class="title function_">createCylinder</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// height: number - 高度</span></span><br><span class="line">      <span class="attr">height</span>: options.<span class="property">height</span> || <span class="number">2</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// diameterTop: number - 顶部直径</span></span><br><span class="line">      <span class="attr">diameterTop</span>: options.<span class="property">diameterTop</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// diameterBottom: number - 底部直径</span></span><br><span class="line">      <span class="attr">diameterBottom</span>: options.<span class="property">diameterBottom</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// tessellation: number - 圆周分段数</span></span><br><span class="line">      <span class="attr">tessellation</span>: options.<span class="property">tessellation</span> || <span class="number">24</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// subdivisions: number - 高度细分数</span></span><br><span class="line">      <span class="attr">subdivisions</span>: options.<span class="property">subdivisions</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// arc: number - 弧度（0-1）</span></span><br><span class="line">      <span class="attr">arc</span>: options.<span class="property">arc</span> || <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// faceUV: Vector4[] - 面UV</span></span><br><span class="line">      <span class="attr">faceUV</span>: options.<span class="property">faceUV</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// faceColors: Color4[] - 面颜色</span></span><br><span class="line">      <span class="attr">faceColors</span>: options.<span class="property">faceColors</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// hasRings: boolean - 是否有环</span></span><br><span class="line">      <span class="attr">hasRings</span>: options.<span class="property">hasRings</span> || <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// enclose: boolean - 是否封闭</span></span><br><span class="line">      <span class="attr">enclose</span>: options.<span class="property">enclose</span> || <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateCylinder</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 平面创建</span></span><br><span class="line">  <span class="title function_">createPlane</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// size: number - 统一尺寸</span></span><br><span class="line">      <span class="attr">size</span>: options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// width, height: number - 宽度和高度</span></span><br><span class="line">      <span class="attr">width</span>: options.<span class="property">width</span> || options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">height</span>: options.<span class="property">height</span> || options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// frontUVs, backUVs: Vector4</span></span><br><span class="line">      <span class="attr">frontUVs</span>: options.<span class="property">frontUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">      <span class="attr">backUVs</span>: options.<span class="property">backUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sourcePlane: Plane - 源平面</span></span><br><span class="line">      <span class="attr">sourcePlane</span>: options.<span class="property">sourcePlane</span> || <span class="literal">undefined</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreatePlane</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 地面创建</span></span><br><span class="line">  <span class="title function_">createGround</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// width, height: number - 地面尺寸</span></span><br><span class="line">      <span class="attr">width</span>: options.<span class="property">width</span> || <span class="number">10</span>,</span><br><span class="line">      <span class="attr">height</span>: options.<span class="property">height</span> || <span class="number">10</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// subdivisions: number - 细分数</span></span><br><span class="line">      <span class="attr">subdivisions</span>: options.<span class="property">subdivisions</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// subdivisionsX, subdivisionsY: number - XY方向细分</span></span><br><span class="line">      <span class="attr">subdivisionsX</span>: options.<span class="property">subdivisionsX</span> || options.<span class="property">subdivisions</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">subdivisionsY</span>: options.<span class="property">subdivisionsY</span> || options.<span class="property">subdivisions</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// updatable: boolean - 是否可更新</span></span><br><span class="line">      <span class="attr">updatable</span>: options.<span class="property">updatable</span> || <span class="literal">false</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateGround</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 环面创建</span></span><br><span class="line">  <span class="title function_">createTorus</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// diameter: number - 外直径</span></span><br><span class="line">      <span class="attr">diameter</span>: options.<span class="property">diameter</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// thickness: number - 管子粗细</span></span><br><span class="line">      <span class="attr">thickness</span>: options.<span class="property">thickness</span> || <span class="number">0.5</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// tessellation: number - 分段数</span></span><br><span class="line">      <span class="attr">tessellation</span>: options.<span class="property">tessellation</span> || <span class="number">16</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// frontUVs, backUVs: Vector4</span></span><br><span class="line">      <span class="attr">frontUVs</span>: options.<span class="property">frontUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">      <span class="attr">backUVs</span>: options.<span class="property">backUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateTorus</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 圆锥创建</span></span><br><span class="line">  <span class="title function_">createCone</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// diameter: number - 底面直径</span></span><br><span class="line">      <span class="attr">diameter</span>: options.<span class="property">diameter</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// diameterTop: number - 顶面直径（0为尖锥）</span></span><br><span class="line">      <span class="attr">diameterTop</span>: options.<span class="property">diameterTop</span> || <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// diameterBottom: number - 底面直径</span></span><br><span class="line">      <span class="attr">diameterBottom</span>: options.<span class="property">diameterBottom</span> || options.<span class="property">diameter</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// height: number - 高度</span></span><br><span class="line">      <span class="attr">height</span>: options.<span class="property">height</span> || <span class="number">2</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// tessellation: number - 圆周分段</span></span><br><span class="line">      <span class="attr">tessellation</span>: options.<span class="property">tessellation</span> || <span class="number">24</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// subdivisions: number - 高度细分</span></span><br><span class="line">      <span class="attr">subdivisions</span>: options.<span class="property">subdivisions</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// arc: number - 弧度</span></span><br><span class="line">      <span class="attr">arc</span>: options.<span class="property">arc</span> || <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// faceUV: Vector4[]</span></span><br><span class="line">      <span class="attr">faceUV</span>: options.<span class="property">faceUV</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// faceColors: Color4[]</span></span><br><span class="line">      <span class="attr">faceColors</span>: options.<span class="property">faceColors</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateCylinder</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 多面体创建</span></span><br><span class="line">  <span class="title function_">createPolyhedron</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// type: number - 多面体类型</span></span><br><span class="line">      <span class="comment">// 0: 四面体, 1: 八面体, 2: 十二面体, 3: 二十面体, 4: 八面体, 5: 十二面体</span></span><br><span class="line">      <span class="attr">type</span>: options.<span class="property">type</span> || <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// size: number - 尺寸</span></span><br><span class="line">      <span class="attr">size</span>: options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sizeX, sizeY, sizeZ: number - 各轴尺寸</span></span><br><span class="line">      <span class="attr">sizeX</span>: options.<span class="property">sizeX</span> || options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">sizeY</span>: options.<span class="property">sizeY</span> || options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">sizeZ</span>: options.<span class="property">sizeZ</span> || options.<span class="property">size</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// custom: object - 自定义多面体数据</span></span><br><span class="line">      <span class="attr">custom</span>: options.<span class="property">custom</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// faceUV: Vector4[]</span></span><br><span class="line">      <span class="attr">faceUV</span>: options.<span class="property">faceUV</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// faceColors: Color4[]</span></span><br><span class="line">      <span class="attr">faceColors</span>: options.<span class="property">faceColors</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// flat: boolean - 是否平面着色</span></span><br><span class="line">      <span class="attr">flat</span>: options.<span class="property">flat</span> || <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreatePolyhedron</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 带状网格创建</span></span><br><span class="line">  <span class="title function_">createRibbon</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// pathArray: Vector3[][] - 路径数组</span></span><br><span class="line">      <span class="attr">pathArray</span>: options.<span class="property">pathArray</span> || [</span><br><span class="line">        [<span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)],</span><br><span class="line">        [<span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>)],</span><br><span class="line">      ],</span><br><span class="line"></span><br><span class="line">      <span class="comment">// closeArray: boolean - 是否闭合数组</span></span><br><span class="line">      <span class="attr">closeArray</span>: options.<span class="property">closeArray</span> || <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// closePath: boolean - 是否闭合路径</span></span><br><span class="line">      <span class="attr">closePath</span>: options.<span class="property">closePath</span> || <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// offset: number - 偏移</span></span><br><span class="line">      <span class="attr">offset</span>: options.<span class="property">offset</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// frontUVs, backUVs: Vector4</span></span><br><span class="line">      <span class="attr">frontUVs</span>: options.<span class="property">frontUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">      <span class="attr">backUVs</span>: options.<span class="property">backUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line"></span><br><span class="line">      <span class="comment">// invertUV: boolean - 是否反转UV</span></span><br><span class="line">      <span class="attr">invertUV</span>: options.<span class="property">invertUV</span> || <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// uvs: Vector2[] - UV坐标数组</span></span><br><span class="line">      <span class="attr">uvs</span>: options.<span class="property">uvs</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// colors: Color4[] - 颜色数组</span></span><br><span class="line">      <span class="attr">colors</span>: options.<span class="property">colors</span> || <span class="literal">undefined</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateRibbon</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 管状网格创建</span></span><br><span class="line">  <span class="title function_">createTube</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// path: Vector3[] - 路径点</span></span><br><span class="line">      <span class="attr">path</span>: options.<span class="property">path</span> || [<span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>)],</span><br><span class="line"></span><br><span class="line">      <span class="comment">// radius: number - 半径</span></span><br><span class="line">      <span class="attr">radius</span>: options.<span class="property">radius</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// tessellation: number - 圆周分段</span></span><br><span class="line">      <span class="attr">tessellation</span>: options.<span class="property">tessellation</span> || <span class="number">8</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// radiusFunction: function - 半径函数</span></span><br><span class="line">      <span class="attr">radiusFunction</span>: options.<span class="property">radiusFunction</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// cap: number - 端盖类型</span></span><br><span class="line">      <span class="attr">cap</span>: options.<span class="property">cap</span> || <span class="title class_">Mesh</span>.<span class="property">NO_CAP</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// arc: number - 弧度</span></span><br><span class="line">      <span class="attr">arc</span>: options.<span class="property">arc</span> || <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// sideOrientation: number</span></span><br><span class="line">      <span class="attr">sideOrientation</span>: options.<span class="property">sideOrientation</span> || <span class="title class_">Mesh</span>.<span class="property">DEFAULTSIDE</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// frontUVs, backUVs: Vector4</span></span><br><span class="line">      <span class="attr">frontUVs</span>: options.<span class="property">frontUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">      <span class="attr">backUVs</span>: options.<span class="property">backUVs</span> || <span class="keyword">new</span> <span class="title class_">Vector4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line"></span><br><span class="line">      <span class="comment">// invertUV: boolean</span></span><br><span class="line">      <span class="attr">invertUV</span>: options.<span class="property">invertUV</span> || <span class="literal">false</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateTube</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 线条创建</span></span><br><span class="line">  <span class="title function_">createLines</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// points: Vector3[] - 点数组</span></span><br><span class="line">      <span class="attr">points</span>: options.<span class="property">points</span> || [<span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)],</span><br><span class="line"></span><br><span class="line">      <span class="comment">// colors: Color4[] - 颜色数组</span></span><br><span class="line">      <span class="attr">colors</span>: options.<span class="property">colors</span> || <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// useVertexAlpha: boolean - 是否使用顶点透明度</span></span><br><span class="line">      <span class="attr">useVertexAlpha</span>: options.<span class="property">useVertexAlpha</span> || <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateLines</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 虚线创建</span></span><br><span class="line">  <span class="title function_">createDashedLines</span>(<span class="params">name, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">      <span class="comment">// points: Vector3[] - 点数组</span></span><br><span class="line">      <span class="attr">points</span>: options.<span class="property">points</span> || [<span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)],</span><br><span class="line"></span><br><span class="line">      <span class="comment">// dashSize: number - 虚线长度</span></span><br><span class="line">      <span class="attr">dashSize</span>: options.<span class="property">dashSize</span> || <span class="number">3</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// gapSize: number - 间隙长度</span></span><br><span class="line">      <span class="attr">gapSize</span>: options.<span class="property">gapSize</span> || <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// dashNb: number - 虚线数量</span></span><br><span class="line">      <span class="attr">dashNb</span>: options.<span class="property">dashNb</span> || <span class="number">200</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// useVertexAlpha: boolean</span></span><br><span class="line">      <span class="attr">useVertexAlpha</span>: options.<span class="property">useVertexAlpha</span> || <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="title class_">MeshBuilder</span>.<span class="title class_">CreateDashedLines</span>(name, defaultOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupMeshDefaults</span>(mesh, options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(name, mesh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置网格默认属性</span></span><br><span class="line">  <span class="title function_">setupMeshDefaults</span>(<span class="params">mesh, options</span>) &#123;</span><br><span class="line">    <span class="comment">// 位置变换</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">position</span>) mesh.<span class="property">position</span> = options.<span class="property">position</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">rotation</span>) mesh.<span class="property">rotation</span> = options.<span class="property">rotation</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">scaling</span>) mesh.<span class="property">scaling</span> = options.<span class="property">scaling</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 材质</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">material</span>) mesh.<span class="property">material</span> = options.<span class="property">material</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可见性</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">visibility</span> !== <span class="literal">undefined</span>) mesh.<span class="property">visibility</span> = options.<span class="property">visibility</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">isVisible</span> !== <span class="literal">undefined</span>) mesh.<span class="property">isVisible</span> = options.<span class="property">isVisible</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 渲染属性</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">receiveShadows</span> !== <span class="literal">undefined</span>) mesh.<span class="property">receiveShadows</span> = options.<span class="property">receiveShadows</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">checkCollisions</span> !== <span class="literal">undefined</span>) mesh.<span class="property">checkCollisions</span> = options.<span class="property">checkCollisions</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">isPickable</span> !== <span class="literal">undefined</span>) mesh.<span class="property">isPickable</span> = options.<span class="property">isPickable</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 渲染组</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">renderingGroupId</span> !== <span class="literal">undefined</span>) mesh.<span class="property">renderingGroupId</span> = options.<span class="property">renderingGroupId</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自定义属性</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">metadata</span>) mesh.<span class="property">metadata</span> = options.<span class="property">metadata</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 网格实例化</span></span><br><span class="line">  <span class="title function_">createInstances</span>(<span class="params">sourceMeshName, count, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> sourceMesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(sourceMeshName)</span><br><span class="line">    <span class="keyword">if</span> (!sourceMesh) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;源网格不存在:&#x27;</span>, sourceMeshName)</span><br><span class="line">      <span class="keyword">return</span> []</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> instances = []</span><br><span class="line">    <span class="keyword">const</span> instanceName = options.<span class="property">namePrefix</span> || sourceMeshName + <span class="string">&#x27;_instance&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> instance = sourceMesh.<span class="title function_">createInstance</span>(<span class="string">`<span class="subst">$&#123;instanceName&#125;</span>_<span class="subst">$&#123;i&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 随机或指定位置</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">positions</span> &amp;&amp; options.<span class="property">positions</span>[i]) &#123;</span><br><span class="line">        instance.<span class="property">position</span> = options.<span class="property">positions</span>[i]</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options.<span class="property">randomPosition</span>) &#123;</span><br><span class="line">        instance.<span class="property">position</span> = <span class="variable language_">this</span>.<span class="title function_">generateRandomPosition</span>(options.<span class="property">randomPosition</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 随机或指定旋转</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">rotations</span> &amp;&amp; options.<span class="property">rotations</span>[i]) &#123;</span><br><span class="line">        instance.<span class="property">rotation</span> = options.<span class="property">rotations</span>[i]</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options.<span class="property">randomRotation</span>) &#123;</span><br><span class="line">        instance.<span class="property">rotation</span> = <span class="variable language_">this</span>.<span class="title function_">generateRandomRotation</span>(options.<span class="property">randomRotation</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 随机或指定缩放</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">scalings</span> &amp;&amp; options.<span class="property">scalings</span>[i]) &#123;</span><br><span class="line">        instance.<span class="property">scaling</span> = options.<span class="property">scalings</span>[i]</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options.<span class="property">randomScaling</span>) &#123;</span><br><span class="line">        instance.<span class="property">scaling</span> = <span class="variable language_">this</span>.<span class="title function_">generateRandomScaling</span>(options.<span class="property">randomScaling</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      instances.<span class="title function_">push</span>(instance)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">instancedMeshes</span>.<span class="title function_">set</span>(sourceMeshName, instances)</span><br><span class="line">    <span class="keyword">return</span> instances</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 生成随机位置</span></span><br><span class="line">  <span class="title function_">generateRandomPosition</span>(<span class="params">bounds</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; min = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">10</span>, <span class="number">0</span>, -<span class="number">10</span>), max = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>) &#125; = bounds</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Vector3</span>(</span><br><span class="line">      min.<span class="property">x</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">x</span> - min.<span class="property">x</span>),</span><br><span class="line">      min.<span class="property">y</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">y</span> - min.<span class="property">y</span>),</span><br><span class="line">      min.<span class="property">z</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">z</span> - min.<span class="property">z</span>),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 生成随机旋转</span></span><br><span class="line">  <span class="title function_">generateRandomRotation</span>(<span class="params">bounds</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; min = <span class="title class_">Vector3</span>.<span class="title class_">Zero</span>(), max = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>) &#125; =</span><br><span class="line">      bounds</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Vector3</span>(</span><br><span class="line">      min.<span class="property">x</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">x</span> - min.<span class="property">x</span>),</span><br><span class="line">      min.<span class="property">y</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">y</span> - min.<span class="property">y</span>),</span><br><span class="line">      min.<span class="property">z</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">z</span> - min.<span class="property">z</span>),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 生成随机缩放</span></span><br><span class="line">  <span class="title function_">generateRandomScaling</span>(<span class="params">bounds</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; min = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>), max = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1.5</span>, <span class="number">1.5</span>, <span class="number">1.5</span>) &#125; = bounds</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Vector3</span>(</span><br><span class="line">      min.<span class="property">x</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">x</span> - min.<span class="property">x</span>),</span><br><span class="line">      min.<span class="property">y</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">y</span> - min.<span class="property">y</span>),</span><br><span class="line">      min.<span class="property">z</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * (max.<span class="property">z</span> - min.<span class="property">z</span>),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 网格合并</span></span><br><span class="line">  <span class="title function_">mergeMeshes</span>(<span class="params">meshNames, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> meshesToMerge = meshNames.<span class="title function_">map</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(name)).<span class="title function_">filter</span>(<span class="title class_">Boolean</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (meshesToMerge.<span class="property">length</span> &lt; <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;至少需要2个网格进行合并&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mergedMesh = <span class="title class_">Mesh</span>.<span class="title class_">MergeMeshes</span>(</span><br><span class="line">      meshesToMerge,</span><br><span class="line">      options.<span class="property">disposeSource</span> !== <span class="literal">false</span>, <span class="comment">// 默认销毁源网格</span></span><br><span class="line">      options.<span class="property">allow32BitsIndices</span> !== <span class="literal">false</span>, <span class="comment">// 允许32位索引</span></span><br><span class="line">      options.<span class="property">meshSubclass</span> || <span class="literal">undefined</span>,</span><br><span class="line">      options.<span class="property">subdivideWithSubMeshes</span> || <span class="literal">false</span>,</span><br><span class="line">      options.<span class="property">multiMultiMaterials</span> || <span class="literal">false</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mergedMesh) &#123;</span><br><span class="line">      <span class="keyword">const</span> mergedName = options.<span class="property">name</span> || <span class="string">&#x27;merged_&#x27;</span> + meshNames.<span class="title function_">join</span>(<span class="string">&#x27;_&#x27;</span>)</span><br><span class="line">      mergedMesh.<span class="property">name</span> = mergedName</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">mergedMeshes</span>.<span class="title function_">set</span>(mergedName, mergedMesh)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 从原始网格映射中移除已合并的网格</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">disposeSource</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">        meshNames.<span class="title function_">forEach</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">delete</span>(name))</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">set</span>(mergedName, mergedMesh)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mergedMesh</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 网格简化</span></span><br><span class="line">  <span class="title function_">simplifyMesh</span>(<span class="params">meshName, settings = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> simplificationSettings = [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">quality</span>: settings.<span class="property">quality</span> || <span class="number">0.5</span>,</span><br><span class="line">        <span class="attr">distance</span>: settings.<span class="property">distance</span> || <span class="number">10</span>,</span><br><span class="line">        <span class="attr">optimizeMesh</span>: settings.<span class="property">optimizeMesh</span> !== <span class="literal">false</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用四边形简化</span></span><br><span class="line">    <span class="keyword">const</span> task = mesh.<span class="title function_">simplify</span>(</span><br><span class="line">      simplificationSettings,</span><br><span class="line">      settings.<span class="property">parallelProcessing</span> !== <span class="literal">false</span>,</span><br><span class="line">      <span class="title class_">SimplificationType</span>.<span class="property">QUADRATIC</span>,</span><br><span class="line">      <span class="function">(<span class="params">simplifiedMesh</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;网格简化完成:&#x27;</span>, meshName)</span><br><span class="line">        <span class="keyword">if</span> (settings.<span class="property">onSuccess</span>) settings.<span class="title function_">onSuccess</span>(simplifiedMesh)</span><br><span class="line">      &#125;,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> task</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 网格优化</span></span><br><span class="line">  <span class="title function_">optimizeMesh</span>(<span class="params">meshName, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 冻结世界矩阵</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">freezeWorldMatrix</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">      mesh.<span class="title function_">freezeWorldMatrix</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 冻结法线</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">freezeNormals</span>) &#123;</span><br><span class="line">      mesh.<span class="title function_">freezeNormals</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置为不可更新</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">makeGeometryUnique</span>) &#123;</span><br><span class="line">      mesh.<span class="title function_">makeGeometryUnique</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转换为实例化</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">convertToInstancedMesh</span> &amp;&amp; mesh.<span class="property">instances</span>.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 创建单个实例以启用实例化优化</span></span><br><span class="line">      <span class="keyword">const</span> instance = mesh.<span class="title function_">createInstance</span>(mesh.<span class="property">name</span> + <span class="string">&#x27;_instance_0&#x27;</span>)</span><br><span class="line">      instance.<span class="property">position</span> = mesh.<span class="property">position</span>.<span class="title function_">clone</span>()</span><br><span class="line">      instance.<span class="property">rotation</span> = mesh.<span class="property">rotation</span>.<span class="title function_">clone</span>()</span><br><span class="line">      instance.<span class="property">scaling</span> = mesh.<span class="property">scaling</span>.<span class="title function_">clone</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;网格优化完成:&#x27;</span>, meshName)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 网格动画</span></span><br><span class="line">  <span class="title function_">animateMesh</span>(<span class="params">meshName, property, targetValue, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> animation = <span class="title class_">Animation</span>.<span class="title class_">CreateAndStartAnimation</span>(</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;meshName&#125;</span>_<span class="subst">$&#123;property&#125;</span>`</span>,</span><br><span class="line">      mesh,</span><br><span class="line">      property,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      (duration / <span class="number">1000</span>) * <span class="number">30</span>,</span><br><span class="line">      mesh[property],</span><br><span class="line">      targetValue,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 网格变形</span></span><br><span class="line">  <span class="title function_">morphMesh</span>(<span class="params">meshName, targetPositions, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> positions = mesh.<span class="title function_">getVerticesData</span>(<span class="title class_">VertexBuffer</span>.<span class="property">PositionKind</span>)</span><br><span class="line">    <span class="keyword">if</span> (!positions || positions.<span class="property">length</span> !== targetPositions.<span class="property">length</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;目标位置数据长度不匹配&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建变形动画</span></span><br><span class="line">    <span class="keyword">const</span> morphAnimation = <span class="keyword">new</span> <span class="title class_">Animation</span>(</span><br><span class="line">      <span class="string">&#x27;meshMorph&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;position&#x27;</span>,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> frameCount = (duration / <span class="number">1000</span>) * <span class="number">30</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= frameCount; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> progress = i / frameCount</span><br><span class="line">      <span class="keyword">const</span> interpolatedPositions = []</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; positions.<span class="property">length</span>; j += <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> startPos = <span class="keyword">new</span> <span class="title class_">Vector3</span>(positions[j], positions[j + <span class="number">1</span>], positions[j + <span class="number">2</span>])</span><br><span class="line">        <span class="keyword">const</span> endPos = <span class="keyword">new</span> <span class="title class_">Vector3</span>(</span><br><span class="line">          targetPositions[j],</span><br><span class="line">          targetPositions[j + <span class="number">1</span>],</span><br><span class="line">          targetPositions[j + <span class="number">2</span>],</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">const</span> interpolated = <span class="title class_">Vector3</span>.<span class="title class_">Lerp</span>(startPos, endPos, progress)</span><br><span class="line"></span><br><span class="line">        interpolatedPositions.<span class="title function_">push</span>(interpolated.<span class="property">x</span>, interpolated.<span class="property">y</span>, interpolated.<span class="property">z</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: i,</span><br><span class="line">        <span class="attr">value</span>: interpolatedPositions,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    morphAnimation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行动画</span></span><br><span class="line">    <span class="keyword">const</span> animatable = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">beginDirectAnimation</span>(</span><br><span class="line">      mesh,</span><br><span class="line">      [morphAnimation],</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      frameCount,</span><br><span class="line">      <span class="literal">false</span>,</span><br><span class="line">      <span class="number">1</span>,</span><br><span class="line">      <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 动画完成后更新顶点数据</span></span><br><span class="line">        mesh.<span class="title function_">updateVerticesData</span>(<span class="title class_">VertexBuffer</span>.<span class="property">PositionKind</span>, targetPositions)</span><br><span class="line">        mesh.<span class="title function_">refreshBoundingInfo</span>()</span><br><span class="line">      &#125;,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> animatable</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 网格碰撞检测</span></span><br><span class="line">  <span class="title function_">setupCollision</span>(<span class="params">meshName, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启用碰撞检测</span></span><br><span class="line">    mesh.<span class="property">checkCollisions</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置椭球体碰撞器</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">ellipsoid</span>) &#123;</span><br><span class="line">      mesh.<span class="property">ellipsoid</span> = options.<span class="property">ellipsoid</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置椭球体偏移</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">ellipsoidOffset</span>) &#123;</span><br><span class="line">      mesh.<span class="property">ellipsoidOffset</span> = options.<span class="property">ellipsoidOffset</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 移动碰撞回调</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">onCollide</span>) &#123;</span><br><span class="line">      mesh.<span class="property">onCollide</span> = options.<span class="property">onCollide</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 碰撞位置回调</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">onCollisionPositionChange</span>) &#123;</span><br><span class="line">      mesh.<span class="property">onCollisionPositionChange</span> = options.<span class="property">onCollisionPositionChange</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 网格物理设置</span></span><br><span class="line">  <span class="title function_">setupPhysics</span>(<span class="params">meshName, impostor, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> physicsOptions = &#123;</span><br><span class="line">      <span class="attr">mass</span>: options.<span class="property">mass</span> || <span class="number">1</span>,</span><br><span class="line">      <span class="attr">restitution</span>: options.<span class="property">restitution</span> || <span class="number">0.7</span>,</span><br><span class="line">      <span class="attr">friction</span>: options.<span class="property">friction</span> || <span class="number">0.2</span>,</span><br><span class="line">      ...options,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mesh.<span class="property">physicsImpostor</span> = <span class="keyword">new</span> <span class="title class_">PhysicsImpostor</span>(mesh, impostor, physicsOptions, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mesh.<span class="property">physicsImpostor</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 网格LOD系统</span></span><br><span class="line">  <span class="title function_">setupLOD</span>(<span class="params">meshName, lodMeshes</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// lodMeshes: [&#123; distance: number, mesh: string &#125;, ...]</span></span><br><span class="line">    lodMeshes.<span class="title function_">forEach</span>(<span class="function">(<span class="params">lod</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> lodMesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(lod.<span class="property">mesh</span>)</span><br><span class="line">      <span class="keyword">if</span> (lodMesh) &#123;</span><br><span class="line">        mesh.<span class="title function_">addLODLevel</span>(lod.<span class="property">distance</span>, lodMesh)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加完全隐藏级别</span></span><br><span class="line">    <span class="keyword">if</span> (lodMeshes.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> maxDistance = <span class="title class_">Math</span>.<span class="title function_">max</span>(...lodMeshes.<span class="title function_">map</span>(<span class="function">(<span class="params">lod</span>) =&gt;</span> lod.<span class="property">distance</span>))</span><br><span class="line">      mesh.<span class="title function_">addLODLevel</span>(maxDistance * <span class="number">2</span>, <span class="literal">null</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取网格信息</span></span><br><span class="line">  <span class="title function_">getMeshInfo</span>(<span class="params">meshName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(meshName)</span><br><span class="line">    <span class="keyword">if</span> (!mesh) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> info = &#123;</span><br><span class="line">      <span class="attr">name</span>: meshName,</span><br><span class="line">      <span class="attr">id</span>: mesh.<span class="property">id</span>,</span><br><span class="line">      <span class="attr">uniqueId</span>: mesh.<span class="property">uniqueId</span>,</span><br><span class="line">      <span class="attr">position</span>: mesh.<span class="property">position</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">rotation</span>: mesh.<span class="property">rotation</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">scaling</span>: mesh.<span class="property">scaling</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">visibility</span>: mesh.<span class="property">visibility</span>,</span><br><span class="line">      <span class="attr">isVisible</span>: mesh.<span class="property">isVisible</span>,</span><br><span class="line">      <span class="attr">isEnabled</span>: mesh.<span class="title function_">isEnabled</span>(),</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 几何信息</span></span><br><span class="line">      <span class="attr">totalVertices</span>: mesh.<span class="title function_">getTotalVertices</span>(),</span><br><span class="line">      <span class="attr">totalIndices</span>: mesh.<span class="title function_">getTotalIndices</span>(),</span><br><span class="line">      <span class="attr">boundingInfo</span>: &#123;</span><br><span class="line">        <span class="attr">boundingBox</span>: mesh.<span class="title function_">getBoundingInfo</span>().<span class="property">boundingBox</span>,</span><br><span class="line">        <span class="attr">boundingSphere</span>: mesh.<span class="title function_">getBoundingInfo</span>().<span class="property">boundingSphere</span>,</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 材质信息</span></span><br><span class="line">      <span class="attr">material</span>: mesh.<span class="property">material</span> ? mesh.<span class="property">material</span>.<span class="property">name</span> : <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 实例信息</span></span><br><span class="line">      <span class="attr">hasInstances</span>: mesh.<span class="property">instances</span>.<span class="property">length</span> &gt; <span class="number">0</span>,</span><br><span class="line">      <span class="attr">instanceCount</span>: mesh.<span class="property">instances</span>.<span class="property">length</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 物理信息</span></span><br><span class="line">      <span class="attr">hasPhysics</span>: !!mesh.<span class="property">physicsImpostor</span>,</span><br><span class="line">      <span class="attr">checkCollisions</span>: mesh.<span class="property">checkCollisions</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// LOD信息</span></span><br><span class="line">      <span class="attr">hasLODLevels</span>: mesh.<span class="title function_">getLODLevels</span>().<span class="property">length</span> &gt; <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 性能信息</span></span><br><span class="line">      <span class="attr">isWorldMatrixFrozen</span>: mesh.<span class="property">isWorldMatrixFrozen</span>,</span><br><span class="line">      <span class="attr">doNotSyncBoundingInfo</span>: mesh.<span class="property">doNotSyncBoundingInfo</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 网格搜索和过滤</span></span><br><span class="line">  <span class="title function_">findMeshes</span>(<span class="params">filter</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> results = []</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh, name</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> match = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (filter.<span class="property">name</span> &amp;&amp; !name.<span class="title function_">includes</span>(filter.<span class="property">name</span>)) match = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">if</span> (filter.<span class="property">tag</span> &amp;&amp; (!mesh.<span class="property">metadata</span> || !mesh.<span class="property">metadata</span>.<span class="property">tag</span> || mesh.<span class="property">metadata</span>.<span class="property">tag</span> !== filter.<span class="property">tag</span>))</span><br><span class="line">        match = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">if</span> (filter.<span class="property">material</span> &amp;&amp; (!mesh.<span class="property">material</span> || mesh.<span class="property">material</span>.<span class="property">name</span> !== filter.<span class="property">material</span>))</span><br><span class="line">        match = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">if</span> (filter.<span class="property">hasPhysics</span> !== <span class="literal">undefined</span> &amp;&amp; !!mesh.<span class="property">physicsImpostor</span> !== filter.<span class="property">hasPhysics</span>)</span><br><span class="line">        match = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">if</span> (filter.<span class="property">isVisible</span> !== <span class="literal">undefined</span> &amp;&amp; mesh.<span class="property">isVisible</span> !== filter.<span class="property">isVisible</span>) match = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (match) &#123;</span><br><span class="line">        results.<span class="title function_">push</span>(&#123; name, mesh &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 批量操作</span></span><br><span class="line">  <span class="title function_">batchOperation</span>(<span class="params">meshNames, operation, ...args</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> results = []</span><br><span class="line"></span><br><span class="line">    meshNames.<span class="title function_">forEach</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> mesh = <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">get</span>(name)</span><br><span class="line">      <span class="keyword">if</span> (mesh &amp;&amp; <span class="keyword">typeof</span> mesh[operation] === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> result = mesh[operation](...args)</span><br><span class="line">        results.<span class="title function_">push</span>(&#123; name, result &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 保存网格设置</span></span><br><span class="line">  <span class="title function_">saveMeshSetup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> setup = &#123;</span><br><span class="line">      <span class="attr">meshes</span>: [],</span><br><span class="line">      <span class="attr">instances</span>: [],</span><br><span class="line">      <span class="attr">merged</span>: [],</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh, name</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">meshes</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: name,</span><br><span class="line">        ...<span class="variable language_">this</span>.<span class="title function_">getMeshInfo</span>(name),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">instancedMeshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">instances, sourceName</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">instances</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">sourceName</span>: sourceName,</span><br><span class="line">        <span class="attr">count</span>: instances.<span class="property">length</span>,</span><br><span class="line">        <span class="attr">instances</span>: instances.<span class="title function_">map</span>(<span class="function">(<span class="params">instance</span>) =&gt;</span> (&#123;</span><br><span class="line">          <span class="attr">position</span>: instance.<span class="property">position</span>,</span><br><span class="line">          <span class="attr">rotation</span>: instance.<span class="property">rotation</span>,</span><br><span class="line">          <span class="attr">scaling</span>: instance.<span class="property">scaling</span>,</span><br><span class="line">        &#125;)),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mergedMeshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh, name</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">merged</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: name,</span><br><span class="line">        <span class="attr">info</span>: <span class="variable language_">this</span>.<span class="title function_">getMeshInfo</span>(name),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> setup</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 资源清理</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">instancedMeshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">instances</span>) =&gt;</span> &#123;</span><br><span class="line">      instances.<span class="title function_">forEach</span>(<span class="function">(<span class="params">instance</span>) =&gt;</span> instance.<span class="title function_">dispose</span>())</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">instancedMeshes</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mergedMeshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      mesh.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mergedMeshes</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      mesh.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">meshes</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> meshManager = <span class="keyword">new</span> <span class="title class_">MeshManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建基础几何体</span></span><br><span class="line"><span class="keyword">const</span> box = meshManager.<span class="title function_">createBox</span>(<span class="string">&#x27;myBox&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">size</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">position</span>: <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">  <span class="attr">material</span>: someMaterial,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sphere = meshManager.<span class="title function_">createSphere</span>(<span class="string">&#x27;mySphere&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">diameter</span>: <span class="number">1.5</span>,</span><br><span class="line">  <span class="attr">segments</span>: <span class="number">32</span>,</span><br><span class="line">  <span class="attr">position</span>: <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建实例化网格</span></span><br><span class="line"><span class="keyword">const</span> treeInstances = meshManager.<span class="title function_">createInstances</span>(<span class="string">&#x27;tree&#x27;</span>, <span class="number">100</span>, &#123;</span><br><span class="line">  <span class="attr">randomPosition</span>: &#123;</span><br><span class="line">    <span class="attr">min</span>: <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">50</span>, <span class="number">0</span>, -<span class="number">50</span>),</span><br><span class="line">    <span class="attr">max</span>: <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">50</span>, <span class="number">0</span>, <span class="number">50</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">randomRotation</span>: &#123;</span><br><span class="line">    <span class="attr">min</span>: <span class="title class_">Vector3</span>.<span class="title class_">Zero</span>(),</span><br><span class="line">    <span class="attr">max</span>: <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>, <span class="number">0</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">randomScaling</span>: &#123;</span><br><span class="line">    <span class="attr">min</span>: <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0.8</span>, <span class="number">0.8</span>, <span class="number">0.8</span>),</span><br><span class="line">    <span class="attr">max</span>: <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1.2</span>, <span class="number">1.2</span>, <span class="number">1.2</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置物理属性</span></span><br><span class="line">meshManager.<span class="title function_">setupPhysics</span>(<span class="string">&#x27;myBox&#x27;</span>, <span class="title class_">PhysicsImpostor</span>.<span class="property">BoxImpostor</span>, &#123;</span><br><span class="line">  <span class="attr">mass</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">restitution</span>: <span class="number">0.8</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 网格动画</span></span><br><span class="line">meshManager.<span class="title function_">animateMesh</span>(<span class="string">&#x27;mySphere&#x27;</span>, <span class="string">&#x27;position.y&#x27;</span>, <span class="number">5</span>, <span class="number">3000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 合并网格</span></span><br><span class="line"><span class="keyword">const</span> mergedMesh = meshManager.<span class="title function_">mergeMeshes</span>([<span class="string">&#x27;box1&#x27;</span>, <span class="string">&#x27;box2&#x27;</span>, <span class="string">&#x27;box3&#x27;</span>], &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;combinedBoxes&#x27;</span>,</span><br><span class="line">  <span class="attr">disposeSource</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="🎬-Animation-动画系统详解"><a href="#🎬-Animation-动画系统详解" class="headerlink" title="🎬 Animation 动画系统详解"></a>🎬 Animation 动画系统详解</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Animation 动画系统完整管理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AnimationManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animations</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animationGroups</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animatables</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupDefaultAnimations</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupDefaultAnimations</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 预定义常用动画类型</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animationTypes</span> = &#123;</span><br><span class="line">      <span class="attr">FLOAT</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_FLOAT</span>,</span><br><span class="line">      <span class="title class_">VECTOR2</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR2</span>,</span><br><span class="line">      <span class="title class_">VECTOR3</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      <span class="title class_">COLOR3</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_COLOR3</span>,</span><br><span class="line">      <span class="title class_">COLOR4</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_COLOR4</span>,</span><br><span class="line">      <span class="attr">QUATERNION</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_QUATERNION</span>,</span><br><span class="line">      <span class="attr">MATRIX</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_MATRIX</span>,</span><br><span class="line">      <span class="attr">SIZE</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_SIZE</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 预定义循环模式</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loopModes</span> = &#123;</span><br><span class="line">      <span class="attr">RELATIVE</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_RELATIVE</span>,</span><br><span class="line">      <span class="attr">CYCLE</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">      <span class="attr">CONSTANT</span>: <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建基础动画</span></span><br><span class="line">  <span class="title function_">createAnimation</span>(<span class="params">name, targetProperty, frameRate, animationType, loopMode</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="keyword">new</span> <span class="title class_">Animation</span>(</span><br><span class="line">      name,</span><br><span class="line">      targetProperty,</span><br><span class="line">      frameRate || <span class="number">30</span>,</span><br><span class="line">      animationType || <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_FLOAT</span>,</span><br><span class="line">      loopMode || <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animations</span>.<span class="title function_">set</span>(name, animation)</span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 位置动画</span></span><br><span class="line">  <span class="title function_">createPositionAnimation</span>(<span class="params">name, positions, frameRate = <span class="number">30</span>, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="string">&#x27;position&#x27;</span>,</span><br><span class="line">      frameRate,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * frameRate</span><br><span class="line"></span><br><span class="line">    positions.<span class="title function_">forEach</span>(<span class="function">(<span class="params">position, index</span>) =&gt;</span> &#123;</span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: (totalFrames / (positions.<span class="property">length</span> - <span class="number">1</span>)) * index,</span><br><span class="line">        <span class="attr">value</span>: position,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    animation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置缓动函数</span></span><br><span class="line">    animation.<span class="title function_">setEasingFunction</span>(<span class="keyword">new</span> <span class="title class_">CubicEase</span>())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 旋转动画</span></span><br><span class="line">  <span class="title function_">createRotationAnimation</span>(<span class="params">name, rotations, frameRate = <span class="number">30</span>, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="string">&#x27;rotation&#x27;</span>,</span><br><span class="line">      frameRate,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * frameRate</span><br><span class="line"></span><br><span class="line">    rotations.<span class="title function_">forEach</span>(<span class="function">(<span class="params">rotation, index</span>) =&gt;</span> &#123;</span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: (totalFrames / (rotations.<span class="property">length</span> - <span class="number">1</span>)) * index,</span><br><span class="line">        <span class="attr">value</span>: rotation,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    animation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 缩放动画</span></span><br><span class="line">  <span class="title function_">createScalingAnimation</span>(<span class="params">name, scalings, frameRate = <span class="number">30</span>, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="string">&#x27;scaling&#x27;</span>,</span><br><span class="line">      frameRate,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * frameRate</span><br><span class="line"></span><br><span class="line">    scalings.<span class="title function_">forEach</span>(<span class="function">(<span class="params">scaling, index</span>) =&gt;</span> &#123;</span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: (totalFrames / (scalings.<span class="property">length</span> - <span class="number">1</span>)) * index,</span><br><span class="line">        <span class="attr">value</span>: scaling,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    animation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 透明度动画</span></span><br><span class="line">  <span class="title function_">createAlphaAnimation</span>(<span class="params">name, alphaValues, frameRate = <span class="number">30</span>, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="string">&#x27;visibility&#x27;</span>,</span><br><span class="line">      frameRate,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_FLOAT</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * frameRate</span><br><span class="line"></span><br><span class="line">    alphaValues.<span class="title function_">forEach</span>(<span class="function">(<span class="params">alpha, index</span>) =&gt;</span> &#123;</span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: (totalFrames / (alphaValues.<span class="property">length</span> - <span class="number">1</span>)) * index,</span><br><span class="line">        <span class="attr">value</span>: alpha,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    animation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 颜色动画（材质）</span></span><br><span class="line">  <span class="title function_">createColorAnimation</span>(<span class="params">name, colors, frameRate = <span class="number">30</span>, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="string">&#x27;material.diffuseColor&#x27;</span>,</span><br><span class="line">      frameRate,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_COLOR3</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * frameRate</span><br><span class="line"></span><br><span class="line">    colors.<span class="title function_">forEach</span>(<span class="function">(<span class="params">color, index</span>) =&gt;</span> &#123;</span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: (totalFrames / (colors.<span class="property">length</span> - <span class="number">1</span>)) * index,</span><br><span class="line">        <span class="attr">value</span>: color,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    animation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 纹理偏移动画</span></span><br><span class="line">  <span class="title function_">createTextureOffsetAnimation</span>(<span class="params">name, property = <span class="string">&#x27;uOffset&#x27;</span>, speed = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="string">`material.diffuseTexture.<span class="subst">$&#123;property&#125;</span>`</span>,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_FLOAT</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = [</span><br><span class="line">      &#123; <span class="attr">frame</span>: <span class="number">0</span>, <span class="attr">value</span>: <span class="number">0</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">frame</span>: <span class="number">30</span>, <span class="attr">value</span>: speed &#125;,</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    animation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 相机动画</span></span><br><span class="line">  <span class="title function_">createCameraAnimation</span>(<span class="params">camera, targetPosition, targetTarget, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animationGroup = <span class="keyword">new</span> <span class="title class_">AnimationGroup</span>(<span class="string">&#x27;cameraAnimation&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 位置动画</span></span><br><span class="line">    <span class="keyword">const</span> positionAnimation = <span class="variable language_">this</span>.<span class="title function_">createPositionAnimation</span>(</span><br><span class="line">      <span class="string">&#x27;cameraPosition&#x27;</span>,</span><br><span class="line">      [camera.<span class="property">position</span>.<span class="title function_">clone</span>(), targetPosition],</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      duration,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 目标动画（对于FreeCamera）</span></span><br><span class="line">    <span class="keyword">if</span> (camera <span class="keyword">instanceof</span> <span class="title class_">FreeCamera</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> targetAnimation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraTarget&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;target&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      targetAnimation.<span class="title function_">setKeys</span>([</span><br><span class="line">        &#123; <span class="attr">frame</span>: <span class="number">0</span>, <span class="attr">value</span>: camera.<span class="title function_">getTarget</span>().<span class="title function_">clone</span>() &#125;,</span><br><span class="line">        &#123; <span class="attr">frame</span>: (duration / <span class="number">1000</span>) * <span class="number">30</span>, <span class="attr">value</span>: targetTarget &#125;,</span><br><span class="line">      ])</span><br><span class="line"></span><br><span class="line">      animationGroup.<span class="title function_">addTargetedAnimation</span>(targetAnimation, camera)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ArcRotateCamera特殊处理</span></span><br><span class="line">    <span class="keyword">if</span> (camera <span class="keyword">instanceof</span> <span class="title class_">ArcRotateCamera</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> direction = targetPosition.<span class="title function_">subtract</span>(targetTarget)</span><br><span class="line">      <span class="keyword">const</span> radius = direction.<span class="title function_">length</span>()</span><br><span class="line">      <span class="keyword">const</span> alpha = <span class="title class_">Math</span>.<span class="title function_">atan2</span>(direction.<span class="property">x</span>, direction.<span class="property">z</span>)</span><br><span class="line">      <span class="keyword">const</span> beta = <span class="title class_">Math</span>.<span class="title function_">acos</span>(direction.<span class="property">y</span> / radius)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> alphaAnimation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraAlpha&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;alpha&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_FLOAT</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> betaAnimation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraBeta&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;beta&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_FLOAT</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> radiusAnimation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraRadius&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;radius&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_FLOAT</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> targetAnimation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">        <span class="string">&#x27;cameraTarget&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;target&#x27;</span>,</span><br><span class="line">        <span class="number">30</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">        <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * <span class="number">30</span></span><br><span class="line"></span><br><span class="line">      alphaAnimation.<span class="title function_">setKeys</span>([</span><br><span class="line">        &#123; <span class="attr">frame</span>: <span class="number">0</span>, <span class="attr">value</span>: camera.<span class="property">alpha</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">frame</span>: totalFrames, <span class="attr">value</span>: alpha &#125;,</span><br><span class="line">      ])</span><br><span class="line"></span><br><span class="line">      betaAnimation.<span class="title function_">setKeys</span>([</span><br><span class="line">        &#123; <span class="attr">frame</span>: <span class="number">0</span>, <span class="attr">value</span>: camera.<span class="property">beta</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">frame</span>: totalFrames, <span class="attr">value</span>: beta &#125;,</span><br><span class="line">      ])</span><br><span class="line"></span><br><span class="line">      radiusAnimation.<span class="title function_">setKeys</span>([</span><br><span class="line">        &#123; <span class="attr">frame</span>: <span class="number">0</span>, <span class="attr">value</span>: camera.<span class="property">radius</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">frame</span>: totalFrames, <span class="attr">value</span>: radius &#125;,</span><br><span class="line">      ])</span><br><span class="line"></span><br><span class="line">      targetAnimation.<span class="title function_">setKeys</span>([</span><br><span class="line">        &#123; <span class="attr">frame</span>: <span class="number">0</span>, <span class="attr">value</span>: camera.<span class="property">target</span>.<span class="title function_">clone</span>() &#125;,</span><br><span class="line">        &#123; <span class="attr">frame</span>: totalFrames, <span class="attr">value</span>: targetTarget &#125;,</span><br><span class="line">      ])</span><br><span class="line"></span><br><span class="line">      animationGroup.<span class="title function_">addTargetedAnimation</span>(alphaAnimation, camera)</span><br><span class="line">      animationGroup.<span class="title function_">addTargetedAnimation</span>(betaAnimation, camera)</span><br><span class="line">      animationGroup.<span class="title function_">addTargetedAnimation</span>(radiusAnimation, camera)</span><br><span class="line">      animationGroup.<span class="title function_">addTargetedAnimation</span>(targetAnimation, camera)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    animationGroup.<span class="title function_">addTargetedAnimation</span>(positionAnimation, camera)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">set</span>(<span class="string">&#x27;cameraAnimation&#x27;</span>, animationGroup)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> animationGroup</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 骨骼动画</span></span><br><span class="line">  <span class="title function_">createSkeletonAnimation</span>(<span class="params">skeleton, animationName</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!skeleton || !skeleton.<span class="property">animations</span>) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> skeletonAnimation = skeleton.<span class="property">animations</span>.<span class="title function_">find</span>(<span class="function">(<span class="params">anim</span>) =&gt;</span> anim.<span class="property">name</span> === animationName)</span><br><span class="line">    <span class="keyword">if</span> (!skeletonAnimation) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`骨骼动画 <span class="subst">$&#123;animationName&#125;</span> 未找到`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> skeletonAnimation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 变形目标动画</span></span><br><span class="line">  <span class="title function_">createMorphTargetAnimation</span>(<span class="params">mesh, morphTargetIndex, influences, duration = <span class="number">2000</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!mesh.<span class="property">morphTargetManager</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;网格没有变形目标管理器&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">      <span class="string">`morphTarget_<span class="subst">$&#123;morphTargetIndex&#125;</span>`</span>,</span><br><span class="line">      <span class="string">`morphTargetManager.getTarget(<span class="subst">$&#123;morphTargetIndex&#125;</span>).influence`</span>,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_FLOAT</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * <span class="number">30</span></span><br><span class="line"></span><br><span class="line">    influences.<span class="title function_">forEach</span>(<span class="function">(<span class="params">influence, index</span>) =&gt;</span> &#123;</span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: (totalFrames / (influences.<span class="property">length</span> - <span class="number">1</span>)) * index,</span><br><span class="line">        <span class="attr">value</span>: influence,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    animation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 路径动画</span></span><br><span class="line">  <span class="title function_">createPathAnimation</span>(<span class="params">name, path, duration = <span class="number">5000</span>, loop = <span class="literal">true</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="title function_">createAnimation</span>(</span><br><span class="line">      name,</span><br><span class="line">      <span class="string">&#x27;position&#x27;</span>,</span><br><span class="line">      <span class="number">30</span>,</span><br><span class="line">      <span class="title class_">Animation</span>.<span class="property">ANIMATIONTYPE_VECTOR3</span>,</span><br><span class="line">      loop ? <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CYCLE</span> : <span class="title class_">Animation</span>.<span class="property">ANIMATIONLOOPMODE_CONSTANT</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">const</span> totalFrames = (duration / <span class="number">1000</span>) * <span class="number">30</span></span><br><span class="line"></span><br><span class="line">    path.<span class="title function_">forEach</span>(<span class="function">(<span class="params">point, index</span>) =&gt;</span> &#123;</span><br><span class="line">      keys.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">frame</span>: (totalFrames / (path.<span class="property">length</span> - <span class="number">1</span>)) * index,</span><br><span class="line">        <span class="attr">value</span>: point,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    animation.<span class="title function_">setKeys</span>(keys)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加插值器以平滑路径</span></span><br><span class="line">    animation.<span class="title function_">setEasingFunction</span>(<span class="keyword">new</span> <span class="title class_">BezierCurveEase</span>(<span class="number">0.25</span>, <span class="number">0.1</span>, <span class="number">0.25</span>, <span class="number">1.0</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> animation</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 动画组管理</span></span><br><span class="line">  <span class="title function_">createAnimationGroup</span>(<span class="params">name, targetedAnimations = []</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animationGroup = <span class="keyword">new</span> <span class="title class_">AnimationGroup</span>(name, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    targetedAnimations.<span class="title function_">forEach</span>(<span class="function">(<span class="params">&#123; animation, target &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      animationGroup.<span class="title function_">addTargetedAnimation</span>(animation, target)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">set</span>(name, animationGroup)</span><br><span class="line">    <span class="keyword">return</span> animationGroup</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 播放动画</span></span><br><span class="line">  <span class="title function_">playAnimation</span>(<span class="params">target, animationName, loop = <span class="literal">true</span>, speed = <span class="number">1.0</span>, onComplete = <span class="literal">null</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="property">animations</span>.<span class="title function_">get</span>(animationName)</span><br><span class="line">    <span class="keyword">if</span> (!animation) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`动画 <span class="subst">$&#123;animationName&#125;</span> 未找到`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 停止现有动画</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">stopAnimation</span>(target)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开始新动画</span></span><br><span class="line">    <span class="keyword">const</span> animatable = <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">beginAnimation</span>(</span><br><span class="line">      target,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      animation.<span class="title function_">getKeys</span>()[animation.<span class="title function_">getKeys</span>().<span class="property">length</span> - <span class="number">1</span>].<span class="property">frame</span>,</span><br><span class="line">      loop,</span><br><span class="line">      speed,</span><br><span class="line">      onComplete,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animatables</span>.<span class="title function_">set</span>(<span class="string">`<span class="subst">$&#123;target.name&#125;</span>_<span class="subst">$&#123;animationName&#125;</span>`</span>, animatable)</span><br><span class="line">    <span class="keyword">return</span> animatable</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 播放动画组</span></span><br><span class="line">  <span class="title function_">playAnimationGroup</span>(<span class="params">groupName, loop = <span class="literal">true</span>, speed = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> group = <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">get</span>(groupName)</span><br><span class="line">    <span class="keyword">if</span> (!group) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`动画组 <span class="subst">$&#123;groupName&#125;</span> 未找到`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    group.<span class="title function_">play</span>(loop)</span><br><span class="line">    group.<span class="property">speedRatio</span> = speed</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> group</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 暂停动画</span></span><br><span class="line">  <span class="title function_">pauseAnimation</span>(<span class="params">target, animationName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = <span class="string">`<span class="subst">$&#123;target.name&#125;</span>_<span class="subst">$&#123;animationName&#125;</span>`</span></span><br><span class="line">    <span class="keyword">const</span> animatable = <span class="variable language_">this</span>.<span class="property">animatables</span>.<span class="title function_">get</span>(key)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (animatable) &#123;</span><br><span class="line">      animatable.<span class="title function_">pause</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 恢复动画</span></span><br><span class="line">  <span class="title function_">resumeAnimation</span>(<span class="params">target, animationName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = <span class="string">`<span class="subst">$&#123;target.name&#125;</span>_<span class="subst">$&#123;animationName&#125;</span>`</span></span><br><span class="line">    <span class="keyword">const</span> animatable = <span class="variable language_">this</span>.<span class="property">animatables</span>.<span class="title function_">get</span>(key)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (animatable) &#123;</span><br><span class="line">      animatable.<span class="title function_">restart</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 停止动画</span></span><br><span class="line">  <span class="title function_">stopAnimation</span>(<span class="params">target, animationName = <span class="literal">null</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (animationName) &#123;</span><br><span class="line">      <span class="keyword">const</span> key = <span class="string">`<span class="subst">$&#123;target.name&#125;</span>_<span class="subst">$&#123;animationName&#125;</span>`</span></span><br><span class="line">      <span class="keyword">const</span> animatable = <span class="variable language_">this</span>.<span class="property">animatables</span>.<span class="title function_">get</span>(key)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (animatable) &#123;</span><br><span class="line">        animatable.<span class="title function_">stop</span>()</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">animatables</span>.<span class="title function_">delete</span>(key)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 停止目标对象的所有动画</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">stopAnimation</span>(target)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 清理相关的animatable记录</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> [key, animatable] <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">animatables</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key.<span class="title function_">startsWith</span>(target.<span class="property">name</span> + <span class="string">&#x27;_&#x27;</span>)) &#123;</span><br><span class="line">          animatable.<span class="title function_">stop</span>()</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">animatables</span>.<span class="title function_">delete</span>(key)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 缓动函数</span></span><br><span class="line">  <span class="title function_">createEasingFunction</span>(<span class="params">type, ...params</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;linear&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span> <span class="comment">// 默认线性</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;cubic&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CubicEase</span>()</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;quadratic&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">QuadraticEase</span>()</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;quartic&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">QuarticEase</span>()</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;quintic&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">QuinticEase</span>()</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;sine&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SineEase</span>()</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;exponential&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ExponentialEase</span>()</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;circle&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CircleEase</span>()</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;back&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BackEase</span>(params[<span class="number">0</span>] || <span class="number">1.7</span>)</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;elastic&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ElasticEase</span>(params[<span class="number">0</span>] || <span class="number">3</span>, params[<span class="number">1</span>] || <span class="number">1</span>)</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;bounce&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BounceEase</span>(params[<span class="number">0</span>] || <span class="number">3</span>, params[<span class="number">1</span>] || <span class="number">2</span>)</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;bezier&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BezierCurveEase</span>(</span><br><span class="line">          params[<span class="number">0</span>] || <span class="number">0.25</span>,</span><br><span class="line">          params[<span class="number">1</span>] || <span class="number">0.1</span>,</span><br><span class="line">          params[<span class="number">2</span>] || <span class="number">0.25</span>,</span><br><span class="line">          params[<span class="number">3</span>] || <span class="number">1.0</span>,</span><br><span class="line">        )</span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CubicEase</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 动画事件</span></span><br><span class="line">  <span class="title function_">addAnimationEvent</span>(<span class="params">animation, frame, action</span>) &#123;</span><br><span class="line">    animation.<span class="title function_">addEvent</span>(</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">AnimationEvent</span>(</span><br><span class="line">        frame,</span><br><span class="line">        action,</span><br><span class="line">        <span class="literal">false</span>, <span class="comment">// 只执行一次</span></span><br><span class="line">      ),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取动画信息</span></span><br><span class="line">  <span class="title function_">getAnimationInfo</span>(<span class="params">animationName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> animation = <span class="variable language_">this</span>.<span class="property">animations</span>.<span class="title function_">get</span>(animationName)</span><br><span class="line">    <span class="keyword">if</span> (!animation) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = animation.<span class="title function_">getKeys</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">name</span>: animationName,</span><br><span class="line">      <span class="attr">targetProperty</span>: animation.<span class="property">targetProperty</span>,</span><br><span class="line">      <span class="attr">framePerSecond</span>: animation.<span class="property">framePerSecond</span>,</span><br><span class="line">      <span class="attr">dataType</span>: animation.<span class="property">dataType</span>,</span><br><span class="line">      <span class="attr">loopMode</span>: animation.<span class="property">loopBehavior</span>,</span><br><span class="line">      <span class="attr">keyFrameCount</span>: keys.<span class="property">length</span>,</span><br><span class="line">      <span class="attr">duration</span>: keys.<span class="property">length</span> &gt; <span class="number">0</span> ? keys[keys.<span class="property">length</span> - <span class="number">1</span>].<span class="property">frame</span> / animation.<span class="property">framePerSecond</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">hasEasing</span>: !!animation.<span class="title function_">getEasingFunction</span>(),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 从Babylon文件加载动画</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadAnimationsFromFile</span>(<span class="params">url, targetMesh</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> importResult = <span class="keyword">await</span> <span class="title class_">SceneLoader</span>.<span class="title class_">ImportMeshAsync</span>(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, url, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (importResult.<span class="property">animationGroups</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        importResult.<span class="property">animationGroups</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">group</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">set</span>(group.<span class="property">name</span>, group)</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`加载了 <span class="subst">$&#123;importResult.animationGroups.length&#125;</span> 个动画组`</span>)</span><br><span class="line">        <span class="keyword">return</span> importResult.<span class="property">animationGroups</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> []</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;加载动画文件失败:&#x27;</span>, error)</span><br><span class="line">      <span class="keyword">return</span> []</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 混合动画</span></span><br><span class="line">  <span class="title function_">blendAnimations</span>(<span class="params">target, animation1Name, animation2Name, blendFactor</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> anim1 = <span class="variable language_">this</span>.<span class="property">animations</span>.<span class="title function_">get</span>(animation1Name)</span><br><span class="line">    <span class="keyword">const</span> anim2 = <span class="variable language_">this</span>.<span class="property">animations</span>.<span class="title function_">get</span>(animation2Name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!anim1 || !anim2) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;找不到要混合的动画&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里需要自定义混合逻辑</span></span><br><span class="line">    <span class="comment">// BabylonJS的动画混合通常通过AnimationGroup的weight属性实现</span></span><br><span class="line">    <span class="keyword">const</span> group1 = <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">get</span>(animation1Name + <span class="string">&#x27;_group&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> group2 = <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">get</span>(animation2Name + <span class="string">&#x27;_group&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (group1 &amp;&amp; group2) &#123;</span><br><span class="line">      group1.<span class="property">weight</span> = <span class="number">1</span> - blendFactor</span><br><span class="line">      group2.<span class="property">weight</span> = blendFactor</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 保存动画设置</span></span><br><span class="line">  <span class="title function_">saveAnimationSetup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> setup = &#123;</span><br><span class="line">      <span class="attr">animations</span>: [],</span><br><span class="line">      <span class="attr">animationGroups</span>: [],</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animations</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">animation, name</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">animations</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: name,</span><br><span class="line">        ...<span class="variable language_">this</span>.<span class="title function_">getAnimationInfo</span>(name),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">group, name</span>) =&gt;</span> &#123;</span><br><span class="line">      setup.<span class="property">animationGroups</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: name,</span><br><span class="line">        <span class="attr">isPlaying</span>: group.<span class="property">isPlaying</span>,</span><br><span class="line">        <span class="attr">speedRatio</span>: group.<span class="property">speedRatio</span>,</span><br><span class="line">        <span class="attr">weight</span>: group.<span class="property">weight</span>,</span><br><span class="line">        <span class="attr">targetedAnimations</span>: group.<span class="property">targetedAnimations</span>.<span class="property">length</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> setup</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 资源清理</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 停止所有动画</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animatables</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">animatable</span>) =&gt;</span> &#123;</span><br><span class="line">      animatable.<span class="title function_">stop</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animatables</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理动画组</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">group</span>) =&gt;</span> &#123;</span><br><span class="line">      group.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animationGroups</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理动画</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animations</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">animation</span>) =&gt;</span> &#123;</span><br><span class="line">      animation.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">animations</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> animationManager = <span class="keyword">new</span> <span class="title class_">AnimationManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建位置动画</span></span><br><span class="line"><span class="keyword">const</span> positionAnim = animationManager.<span class="title function_">createPositionAnimation</span>(</span><br><span class="line">  <span class="string">&#x27;boxMove&#x27;</span>,</span><br><span class="line">  [<span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">5</span>, <span class="number">2</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">10</span>, <span class="number">0</span>, <span class="number">5</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)],</span><br><span class="line">  <span class="number">30</span>,</span><br><span class="line">  <span class="number">4000</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加缓动函数</span></span><br><span class="line">positionAnim.<span class="title function_">setEasingFunction</span>(animationManager.<span class="title function_">createEasingFunction</span>(<span class="string">&#x27;bounce&#x27;</span>, <span class="number">3</span>, <span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建旋转动画</span></span><br><span class="line"><span class="keyword">const</span> rotationAnim = animationManager.<span class="title function_">createRotationAnimation</span>(</span><br><span class="line">  <span class="string">&#x27;boxRotate&#x27;</span>,</span><br><span class="line">  [<span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span>, <span class="number">0</span>), <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>, <span class="number">0</span>)],</span><br><span class="line">  <span class="number">30</span>,</span><br><span class="line">  <span class="number">3000</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建动画组</span></span><br><span class="line"><span class="keyword">const</span> boxAnimGroup = animationManager.<span class="title function_">createAnimationGroup</span>(<span class="string">&#x27;boxAnimations&#x27;</span>, [</span><br><span class="line">  &#123; <span class="attr">animation</span>: positionAnim, <span class="attr">target</span>: myBox &#125;,</span><br><span class="line">  &#123; <span class="attr">animation</span>: rotationAnim, <span class="attr">target</span>: myBox &#125;,</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment">// 播放动画组</span></span><br><span class="line">animationManager.<span class="title function_">playAnimationGroup</span>(<span class="string">&#x27;boxAnimations&#x27;</span>, <span class="literal">true</span>, <span class="number">1.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 相机动画</span></span><br><span class="line"><span class="keyword">const</span> cameraAnim = animationManager.<span class="title function_">createCameraAnimation</span>(</span><br><span class="line">  scene.<span class="property">activeCamera</span>,</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>),</span><br><span class="line">  <span class="title class_">Vector3</span>.<span class="title class_">Zero</span>(),</span><br><span class="line">  <span class="number">2000</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 播放相机动画</span></span><br><span class="line">animationManager.<span class="title function_">playAnimationGroup</span>(<span class="string">&#x27;cameraAnimation&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="🎆-ParticleSystem-粒子系统详解"><a href="#🎆-ParticleSystem-粒子系统详解" class="headerlink" title="🎆 ParticleSystem 粒子系统详解"></a>🎆 ParticleSystem 粒子系统详解</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ParticleSystem 粒子系统完整管理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ParticleSystemManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">particleSystems</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gpuParticleSystems</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupDefaultParticleSystems</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupDefaultParticleSystems</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 检查GPU粒子系统支持</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">supportsGPUParticles</span> = <span class="title class_">GPUParticleSystem</span>.<span class="property">IsSupported</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;GPU粒子系统支持:&#x27;</span>, <span class="variable language_">this</span>.<span class="property">supportsGPUParticles</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建基础CPU粒子系统</span></span><br><span class="line">  <span class="title function_">createParticleSystem</span>(<span class="params">name, capacity = <span class="number">2000</span>, emitter = <span class="literal">null</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> particleSystem = <span class="keyword">new</span> <span class="title class_">ParticleSystem</span>(name, capacity, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 基础发射器设置</span></span><br><span class="line">    <span class="keyword">if</span> (emitter) &#123;</span><br><span class="line">      particleSystem.<span class="property">emitter</span> = emitter</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      particleSystem.<span class="property">emitter</span> = <span class="title class_">Vector3</span>.<span class="title class_">Zero</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 粒子纹理</span></span><br><span class="line">    particleSystem.<span class="property">particleTexture</span> = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;/textures/flare.png&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发射属性</span></span><br><span class="line">    particleSystem.<span class="property">emitRate</span> = <span class="number">300</span> <span class="comment">// 每秒发射粒子数</span></span><br><span class="line">    particleSystem.<span class="property">maxEmitPower</span> = <span class="number">1.5</span> <span class="comment">// 最大发射力度</span></span><br><span class="line">    particleSystem.<span class="property">minEmitPower</span> = <span class="number">1.0</span> <span class="comment">// 最小发射力度</span></span><br><span class="line">    particleSystem.<span class="property">updateSpeed</span> = <span class="number">0.005</span> <span class="comment">// 更新速度</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生命周期</span></span><br><span class="line">    particleSystem.<span class="property">minLifeTime</span> = <span class="number">0.3</span> <span class="comment">// 最小生命时间</span></span><br><span class="line">    particleSystem.<span class="property">maxLifeTime</span> = <span class="number">1.5</span> <span class="comment">// 最大生命时间</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 尺寸</span></span><br><span class="line">    particleSystem.<span class="property">minSize</span> = <span class="number">0.1</span> <span class="comment">// 最小尺寸</span></span><br><span class="line">    particleSystem.<span class="property">maxSize</span> = <span class="number">0.5</span> <span class="comment">// 最大尺寸</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 角度范围</span></span><br><span class="line">    particleSystem.<span class="property">minAngularSpeed</span> = <span class="number">0</span> <span class="comment">// 最小角速度</span></span><br><span class="line">    particleSystem.<span class="property">maxAngularSpeed</span> = <span class="title class_">Math</span>.<span class="property">PI</span> <span class="comment">// 最大角速度</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 方向</span></span><br><span class="line">    particleSystem.<span class="property">direction1</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">7</span>, <span class="number">8</span>, <span class="number">3</span>) <span class="comment">// 方向1</span></span><br><span class="line">    particleSystem.<span class="property">direction2</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">7</span>, <span class="number">8</span>, -<span class="number">3</span>) <span class="comment">// 方向2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重力</span></span><br><span class="line">    particleSystem.<span class="property">gravity</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, -<span class="number">9.81</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 颜色变化</span></span><br><span class="line">    particleSystem.<span class="property">color1</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.7</span>, <span class="number">0.8</span>, <span class="number">1.0</span>, <span class="number">1.0</span>) <span class="comment">// 起始颜色</span></span><br><span class="line">    particleSystem.<span class="property">color2</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.2</span>, <span class="number">0.5</span>, <span class="number">1.0</span>, <span class="number">1.0</span>) <span class="comment">// 中间颜色</span></span><br><span class="line">    particleSystem.<span class="property">colorDead</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.2</span>, <span class="number">0.0</span>) <span class="comment">// 消失颜色</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发射形状</span></span><br><span class="line">    particleSystem.<span class="property">minEmitBox</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>) <span class="comment">// 发射盒最小值</span></span><br><span class="line">    particleSystem.<span class="property">maxEmitBox</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>) <span class="comment">// 发射盒最大值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 混合模式</span></span><br><span class="line">    particleSystem.<span class="property">blendMode</span> = <span class="title class_">ParticleSystem</span>.<span class="property">BLENDMODE_ONEONE</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">particleSystems</span>.<span class="title function_">set</span>(name, particleSystem)</span><br><span class="line">    <span class="keyword">return</span> particleSystem</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建GPU粒子系统</span></span><br><span class="line">  <span class="title function_">createGPUParticleSystem</span>(<span class="params">name, capacity = <span class="number">50000</span>, emitter = <span class="literal">null</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">supportsGPUParticles</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;当前设备不支持GPU粒子系统，使用CPU粒子系统代替&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">createParticleSystem</span>(name, <span class="title class_">Math</span>.<span class="title function_">min</span>(capacity, <span class="number">5000</span>), emitter)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> particleSystem = <span class="keyword">new</span> <span class="title class_">GPUParticleSystem</span>(name, &#123; <span class="attr">capacity</span>: capacity &#125;, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 基础发射器设置</span></span><br><span class="line">    <span class="keyword">if</span> (emitter) &#123;</span><br><span class="line">      particleSystem.<span class="property">emitter</span> = emitter</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      particleSystem.<span class="property">emitter</span> = <span class="title class_">Vector3</span>.<span class="title class_">Zero</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 粒子纹理</span></span><br><span class="line">    particleSystem.<span class="property">particleTexture</span> = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;/textures/flare.png&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// GPU特有的发射属性</span></span><br><span class="line">    particleSystem.<span class="property">emitRate</span> = <span class="number">5000</span> <span class="comment">// GPU可以处理更多粒子</span></span><br><span class="line">    particleSystem.<span class="property">maxEmitPower</span> = <span class="number">1.5</span></span><br><span class="line">    particleSystem.<span class="property">minEmitPower</span> = <span class="number">1.0</span></span><br><span class="line">    particleSystem.<span class="property">updateSpeed</span> = <span class="number">0.005</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生命周期</span></span><br><span class="line">    particleSystem.<span class="property">minLifeTime</span> = <span class="number">0.3</span></span><br><span class="line">    particleSystem.<span class="property">maxLifeTime</span> = <span class="number">1.5</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 尺寸</span></span><br><span class="line">    particleSystem.<span class="property">minSize</span> = <span class="number">0.1</span></span><br><span class="line">    particleSystem.<span class="property">maxSize</span> = <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 角度范围</span></span><br><span class="line">    particleSystem.<span class="property">minAngularSpeed</span> = <span class="number">0</span></span><br><span class="line">    particleSystem.<span class="property">maxAngularSpeed</span> = <span class="title class_">Math</span>.<span class="property">PI</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 方向</span></span><br><span class="line">    particleSystem.<span class="property">direction1</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">7</span>, <span class="number">8</span>, <span class="number">3</span>)</span><br><span class="line">    particleSystem.<span class="property">direction2</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">7</span>, <span class="number">8</span>, -<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重力</span></span><br><span class="line">    particleSystem.<span class="property">gravity</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, -<span class="number">9.81</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 颜色变化</span></span><br><span class="line">    particleSystem.<span class="property">color1</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.7</span>, <span class="number">0.8</span>, <span class="number">1.0</span>, <span class="number">1.0</span>)</span><br><span class="line">    particleSystem.<span class="property">color2</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.2</span>, <span class="number">0.5</span>, <span class="number">1.0</span>, <span class="number">1.0</span>)</span><br><span class="line">    particleSystem.<span class="property">colorDead</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.2</span>, <span class="number">0.0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发射形状</span></span><br><span class="line">    particleSystem.<span class="property">minEmitBox</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    particleSystem.<span class="property">maxEmitBox</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 混合模式</span></span><br><span class="line">    particleSystem.<span class="property">blendMode</span> = <span class="title class_">ParticleSystem</span>.<span class="property">BLENDMODE_ONEONE</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gpuParticleSystems</span>.<span class="title function_">set</span>(name, particleSystem)</span><br><span class="line">    <span class="keyword">return</span> particleSystem</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建火焰效果</span></span><br><span class="line">  <span class="title function_">createFireEffect</span>(<span class="params">name, emitter, intensity = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fireSystem = <span class="variable language_">this</span>.<span class="title function_">createParticleSystem</span>(name + <span class="string">&#x27;_fire&#x27;</span>, <span class="number">2000</span>, emitter)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 火焰特效参数</span></span><br><span class="line">    fireSystem.<span class="property">particleTexture</span> = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;/textures/fire.jpg&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    fireSystem.<span class="property">emitRate</span> = <span class="number">300</span> * intensity</span><br><span class="line">    fireSystem.<span class="property">maxEmitPower</span> = <span class="number">1.0</span></span><br><span class="line">    fireSystem.<span class="property">minEmitPower</span> = <span class="number">0.8</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 火焰生命周期</span></span><br><span class="line">    fireSystem.<span class="property">minLifeTime</span> = <span class="number">0.5</span></span><br><span class="line">    fireSystem.<span class="property">maxLifeTime</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 火焰尺寸</span></span><br><span class="line">    fireSystem.<span class="property">minSize</span> = <span class="number">0.5</span> * intensity</span><br><span class="line">    fireSystem.<span class="property">maxSize</span> = <span class="number">1.0</span> * intensity</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 火焰方向（向上）</span></span><br><span class="line">    fireSystem.<span class="property">direction1</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">0.5</span>, <span class="number">1</span>, -<span class="number">0.5</span>)</span><br><span class="line">    fireSystem.<span class="property">direction2</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0.5</span>, <span class="number">1</span>, <span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 无重力（火焰向上飘）</span></span><br><span class="line">    fireSystem.<span class="property">gravity</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 火焰颜色渐变</span></span><br><span class="line">    fireSystem.<span class="property">color1</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1.0</span>) <span class="comment">// 黄色</span></span><br><span class="line">    fireSystem.<span class="property">color2</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">1</span>, <span class="number">0.5</span>, <span class="number">0</span>, <span class="number">1.0</span>) <span class="comment">// 橙色</span></span><br><span class="line">    fireSystem.<span class="property">colorDead</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.5</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.0</span>) <span class="comment">// 红色渐隐</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 火焰发射形状</span></span><br><span class="line">    fireSystem.<span class="property">minEmitBox</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">0.3</span>, <span class="number">0</span>, -<span class="number">0.3</span>)</span><br><span class="line">    fireSystem.<span class="property">maxEmitBox</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0.3</span>, <span class="number">0</span>, <span class="number">0.3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 混合模式（叠加发光）</span></span><br><span class="line">    fireSystem.<span class="property">blendMode</span> = <span class="title class_">ParticleSystem</span>.<span class="property">BLENDMODE_ADD</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fireSystem</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建烟雾效果</span></span><br><span class="line">  <span class="title function_">createSmokeEffect</span>(<span class="params">name, emitter, intensity = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> smokeSystem = <span class="variable language_">this</span>.<span class="title function_">createParticleSystem</span>(name + <span class="string">&#x27;_smoke&#x27;</span>, <span class="number">1000</span>, emitter)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 烟雾特效参数</span></span><br><span class="line">    smokeSystem.<span class="property">particleTexture</span> = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;/textures/smoke.png&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    smokeSystem.<span class="property">emitRate</span> = <span class="number">50</span> * intensity</span><br><span class="line">    smokeSystem.<span class="property">maxEmitPower</span> = <span class="number">0.5</span></span><br><span class="line">    smokeSystem.<span class="property">minEmitPower</span> = <span class="number">0.2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 烟雾生命周期（较长）</span></span><br><span class="line">    smokeSystem.<span class="property">minLifeTime</span> = <span class="number">2.0</span></span><br><span class="line">    smokeSystem.<span class="property">maxLifeTime</span> = <span class="number">4.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 烟雾尺寸（逐渐增大）</span></span><br><span class="line">    smokeSystem.<span class="property">minSize</span> = <span class="number">1.0</span> * intensity</span><br><span class="line">    smokeSystem.<span class="property">maxSize</span> = <span class="number">3.0</span> * intensity</span><br><span class="line">    smokeSystem.<span class="property">minScaleX</span> = <span class="number">1.0</span></span><br><span class="line">    smokeSystem.<span class="property">maxScaleX</span> = <span class="number">3.0</span></span><br><span class="line">    smokeSystem.<span class="property">minScaleY</span> = <span class="number">1.0</span></span><br><span class="line">    smokeSystem.<span class="property">maxScaleY</span> = <span class="number">3.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 烟雾方向（向上扩散）</span></span><br><span class="line">    smokeSystem.<span class="property">direction1</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">1</span>, -<span class="number">1</span>)</span><br><span class="line">    smokeSystem.<span class="property">direction2</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 轻微重力</span></span><br><span class="line">    smokeSystem.<span class="property">gravity</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, -<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 烟雾颜色（灰色渐隐）</span></span><br><span class="line">    smokeSystem.<span class="property">color1</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.8</span>, <span class="number">0.8</span>, <span class="number">0.8</span>, <span class="number">0.8</span>)</span><br><span class="line">    smokeSystem.<span class="property">color2</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>)</span><br><span class="line">    smokeSystem.<span class="property">colorDead</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.3</span>, <span class="number">0.3</span>, <span class="number">0.3</span>, <span class="number">0.0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 烟雾发射形状</span></span><br><span class="line">    smokeSystem.<span class="property">minEmitBox</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">0.5</span>, <span class="number">0</span>, -<span class="number">0.5</span>)</span><br><span class="line">    smokeSystem.<span class="property">maxEmitBox</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0.5</span>, <span class="number">0.2</span>, <span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 混合模式（透明）</span></span><br><span class="line">    smokeSystem.<span class="property">blendMode</span> = <span class="title class_">ParticleSystem</span>.<span class="property">BLENDMODE_STANDARD</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> smokeSystem</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建爆炸效果</span></span><br><span class="line">  <span class="title function_">createExplosionEffect</span>(<span class="params">name, position, size = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> explosionSystem = <span class="variable language_">this</span>.<span class="title function_">createParticleSystem</span>(name + <span class="string">&#x27;_explosion&#x27;</span>, <span class="number">5000</span>, position)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 爆炸特效参数</span></span><br><span class="line">    explosionSystem.<span class="property">particleTexture</span> = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;/textures/explosion.png&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    explosionSystem.<span class="property">emitRate</span> = <span class="number">10000</span> <span class="comment">// 瞬间大量发射</span></span><br><span class="line">    explosionSystem.<span class="property">maxEmitPower</span> = <span class="number">10.0</span> * size</span><br><span class="line">    explosionSystem.<span class="property">minEmitPower</span> = <span class="number">5.0</span> * size</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 爆炸生命周期（短暂）</span></span><br><span class="line">    explosionSystem.<span class="property">minLifeTime</span> = <span class="number">0.1</span></span><br><span class="line">    explosionSystem.<span class="property">maxLifeTime</span> = <span class="number">0.8</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 爆炸尺寸</span></span><br><span class="line">    explosionSystem.<span class="property">minSize</span> = <span class="number">0.5</span> * size</span><br><span class="line">    explosionSystem.<span class="property">maxSize</span> = <span class="number">2.0</span> * size</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 全方向爆炸</span></span><br><span class="line">    explosionSystem.<span class="title function_">createSphereEmitter</span>(<span class="number">0.1</span>, <span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重力影响</span></span><br><span class="line">    explosionSystem.<span class="property">gravity</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, -<span class="number">5</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 爆炸颜色</span></span><br><span class="line">    explosionSystem.<span class="property">color1</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1.0</span>) <span class="comment">// 白色闪光</span></span><br><span class="line">    explosionSystem.<span class="property">color2</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">1</span>, <span class="number">0.8</span>, <span class="number">0.2</span>, <span class="number">1.0</span>) <span class="comment">// 橙黄色</span></span><br><span class="line">    explosionSystem.<span class="property">colorDead</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.3</span>, <span class="number">0.1</span>, <span class="number">0</span>, <span class="number">0.0</span>) <span class="comment">// 暗红色消散</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 混合模式（叠加）</span></span><br><span class="line">    explosionSystem.<span class="property">blendMode</span> = <span class="title class_">ParticleSystem</span>.<span class="property">BLENDMODE_ADD</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 限制发射时间（爆炸是瞬间的）</span></span><br><span class="line">    explosionSystem.<span class="property">targetStopDuration</span> = <span class="number">0.1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> explosionSystem</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建雨雪效果</span></span><br><span class="line">  <span class="title function_">createWeatherEffect</span>(<span class="params"></span></span><br><span class="line"><span class="params">    name,</span></span><br><span class="line"><span class="params">    type = <span class="string">&#x27;rain&#x27;</span>,</span></span><br><span class="line"><span class="params">    intensity = <span class="number">1.0</span>,</span></span><br><span class="line"><span class="params">    area = &#123; width: <span class="number">50</span>, height: <span class="number">20</span>, depth: <span class="number">50</span> &#125;,</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> weatherSystem = <span class="variable language_">this</span>.<span class="title function_">createParticleSystem</span>(name + <span class="string">&#x27;_weather&#x27;</span>, <span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (type === <span class="string">&#x27;rain&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// 雨效果</span></span><br><span class="line">      weatherSystem.<span class="property">particleTexture</span> = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;/textures/raindrop.png&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">      weatherSystem.<span class="property">emitRate</span> = <span class="number">1000</span> * intensity</span><br><span class="line">      weatherSystem.<span class="property">minLifeTime</span> = <span class="number">1.0</span></span><br><span class="line">      weatherSystem.<span class="property">maxLifeTime</span> = <span class="number">3.0</span></span><br><span class="line">      weatherSystem.<span class="property">minSize</span> = <span class="number">0.1</span></span><br><span class="line">      weatherSystem.<span class="property">maxSize</span> = <span class="number">0.3</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 雨滴方向（向下）</span></span><br><span class="line">      weatherSystem.<span class="property">direction1</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">0.2</span>, -<span class="number">1</span>, -<span class="number">0.1</span>)</span><br><span class="line">      weatherSystem.<span class="property">direction2</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0.2</span>, -<span class="number">1</span>, <span class="number">0.1</span>)</span><br><span class="line">      weatherSystem.<span class="property">gravity</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, -<span class="number">15</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 雨滴颜色</span></span><br><span class="line">      weatherSystem.<span class="property">color1</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.7</span>, <span class="number">0.8</span>, <span class="number">1.0</span>, <span class="number">0.8</span>)</span><br><span class="line">      weatherSystem.<span class="property">color2</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.5</span>, <span class="number">0.6</span>, <span class="number">0.8</span>, <span class="number">0.6</span>)</span><br><span class="line">      weatherSystem.<span class="property">colorDead</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.3</span>, <span class="number">0.4</span>, <span class="number">0.6</span>, <span class="number">0.0</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">&#x27;snow&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// 雪效果</span></span><br><span class="line">      weatherSystem.<span class="property">particleTexture</span> = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;/textures/snowflake.png&#x27;</span>, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">      weatherSystem.<span class="property">emitRate</span> = <span class="number">500</span> * intensity</span><br><span class="line">      weatherSystem.<span class="property">minLifeTime</span> = <span class="number">3.0</span></span><br><span class="line">      weatherSystem.<span class="property">maxLifeTime</span> = <span class="number">8.0</span></span><br><span class="line">      weatherSystem.<span class="property">minSize</span> = <span class="number">0.3</span></span><br><span class="line">      weatherSystem.<span class="property">maxSize</span> = <span class="number">0.8</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 雪花飘落</span></span><br><span class="line">      weatherSystem.<span class="property">direction1</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, -<span class="number">0.5</span>, -<span class="number">1</span>)</span><br><span class="line">      weatherSystem.<span class="property">direction2</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, -<span class="number">0.5</span>, <span class="number">1</span>)</span><br><span class="line">      weatherSystem.<span class="property">gravity</span> = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, -<span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 雪花颜色</span></span><br><span class="line">      weatherSystem.<span class="property">color1</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0.9</span>)</span><br><span class="line">      weatherSystem.<span class="property">color2</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.9</span>, <span class="number">0.9</span>, <span class="number">1</span>, <span class="number">0.8</span>)</span><br><span class="line">      weatherSystem.<span class="property">colorDead</span> = <span class="keyword">new</span> <span class="title class_">Color4</span>(<span class="number">0.8</span>, <span class="number">0.8</span>, <span class="number">0.9</span>, <span class="number">0.0</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置发射区域</span></span><br><span class="line">    weatherSystem.<span class="title function_">createBoxEmitter</span>(</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Vector3</span>(-area.<span class="property">width</span> / <span class="number">2</span>, area.<span class="property">height</span>, -area.<span class="property">depth</span> / <span class="number">2</span>),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Vector3</span>(area.<span class="property">width</span> / <span class="number">2</span>, area.<span class="property">height</span>, area.<span class="property">depth</span> / <span class="number">2</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> weatherSystem</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置发射器形状</span></span><br><span class="line">  <span class="title function_">setupEmitterShape</span>(<span class="params">particleSystem, shapeType, ...params</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (shapeType) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;box&#x27;</span>:</span><br><span class="line">        <span class="keyword">const</span> [minEmitBox, maxEmitBox] = params</span><br><span class="line">        particleSystem.<span class="property">minEmitBox</span> = minEmitBox || <span class="keyword">new</span> <span class="title class_">Vector3</span>(-<span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>)</span><br><span class="line">        particleSystem.<span class="property">maxEmitBox</span> = maxEmitBox || <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;sphere&#x27;</span>:</span><br><span class="line">        <span class="keyword">const</span> [radius, radiusRange] = params</span><br><span class="line">        particleSystem.<span class="title function_">createSphereEmitter</span>(radius || <span class="number">1.0</span>, radiusRange || <span class="number">1.0</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;cone&#x27;</span>:</span><br><span class="line">        <span class="keyword">const</span> [coneRadius, coneAngle, coneHeight] = params</span><br><span class="line">        particleSystem.<span class="title function_">createConeEmitter</span>(</span><br><span class="line">          coneRadius || <span class="number">1.0</span>,</span><br><span class="line">          coneAngle || <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>,</span><br><span class="line">          coneHeight || <span class="number">1.0</span>,</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;cylinder&#x27;</span>:</span><br><span class="line">        <span class="keyword">const</span> [cylRadius, cylHeight, cylRadiusRange] = params</span><br><span class="line">        particleSystem.<span class="title function_">createCylinderEmitter</span>(</span><br><span class="line">          cylRadius || <span class="number">1.0</span>,</span><br><span class="line">          cylHeight || <span class="number">1.0</span>,</span><br><span class="line">          cylRadiusRange || <span class="number">1.0</span>,</span><br><span class="line">          <span class="number">0</span>, <span class="comment">// directionRandomizer</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;hemisphere&#x27;</span>:</span><br><span class="line">        <span class="keyword">const</span> [hemiRadius, hemiRadiusRange] = params</span><br><span class="line">        particleSystem.<span class="title function_">createHemisphericEmitter</span>(hemiRadius || <span class="number">1.0</span>, hemiRadiusRange || <span class="number">1.0</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;未知的发射器形状:&#x27;</span>, shapeType)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 启动粒子系统</span></span><br><span class="line">  <span class="title function_">startParticleSystem</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> cpuSystem = <span class="variable language_">this</span>.<span class="property">particleSystems</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">const</span> gpuSystem = <span class="variable language_">this</span>.<span class="property">gpuParticleSystems</span>.<span class="title function_">get</span>(name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cpuSystem) &#123;</span><br><span class="line">      cpuSystem.<span class="title function_">start</span>()</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`CPU粒子系统 <span class="subst">$&#123;name&#125;</span> 已启动`</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (gpuSystem) &#123;</span><br><span class="line">      gpuSystem.<span class="title function_">start</span>()</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`GPU粒子系统 <span class="subst">$&#123;name&#125;</span> 已启动`</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`粒子系统 <span class="subst">$&#123;name&#125;</span> 未找到`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 停止粒子系统</span></span><br><span class="line">  <span class="title function_">stopParticleSystem</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> cpuSystem = <span class="variable language_">this</span>.<span class="property">particleSystems</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">const</span> gpuSystem = <span class="variable language_">this</span>.<span class="property">gpuParticleSystems</span>.<span class="title function_">get</span>(name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cpuSystem) &#123;</span><br><span class="line">      cpuSystem.<span class="title function_">stop</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (gpuSystem) &#123;</span><br><span class="line">      gpuSystem.<span class="title function_">stop</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 重置粒子系统</span></span><br><span class="line">  <span class="title function_">resetParticleSystem</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> cpuSystem = <span class="variable language_">this</span>.<span class="property">particleSystems</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">const</span> gpuSystem = <span class="variable language_">this</span>.<span class="property">gpuParticleSystems</span>.<span class="title function_">get</span>(name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cpuSystem) &#123;</span><br><span class="line">      cpuSystem.<span class="title function_">reset</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (gpuSystem) &#123;</span><br><span class="line">      gpuSystem.<span class="title function_">reset</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取粒子系统信息</span></span><br><span class="line">  <span class="title function_">getParticleSystemInfo</span>(<span class="params">particleSystemName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> particleSystem = <span class="variable language_">this</span>.<span class="property">particleSystems</span>.<span class="title function_">get</span>(particleSystemName)</span><br><span class="line">    <span class="keyword">if</span> (!particleSystem) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> info = &#123;</span><br><span class="line">      <span class="attr">name</span>: particleSystemName,</span><br><span class="line">      <span class="attr">type</span>: particleSystem.<span class="title function_">getClassName</span>(),</span><br><span class="line">      <span class="attr">emitRate</span>: particleSystem.<span class="property">emitRate</span>,</span><br><span class="line">      <span class="attr">lifeTime</span>: particleSystem.<span class="property">lifeTime</span>,</span><br><span class="line">      <span class="attr">size</span>: particleSystem.<span class="property">size</span>,</span><br><span class="line">      <span class="attr">color</span>: particleSystem.<span class="property">color</span>,</span><br><span class="line">      <span class="attr">color2</span>: particleSystem.<span class="property">color2</span>,</span><br><span class="line">      <span class="attr">colorDead</span>: particleSystem.<span class="property">colorDead</span>,</span><br><span class="line">      <span class="attr">gravity</span>: particleSystem.<span class="property">gravity</span>,</span><br><span class="line">      <span class="attr">direction</span>: particleSystem.<span class="property">direction</span>,</span><br><span class="line">      <span class="attr">direction2</span>: particleSystem.<span class="property">direction2</span>,</span><br><span class="line">      <span class="attr">minEmitPower</span>: particleSystem.<span class="property">minEmitPower</span>,</span><br><span class="line">      <span class="attr">maxEmitPower</span>: particleSystem.<span class="property">maxEmitPower</span>,</span><br><span class="line">      <span class="attr">minLifeTime</span>: particleSystem.<span class="property">minLifeTime</span>,</span><br><span class="line">      <span class="attr">maxLifeTime</span>: particleSystem.<span class="property">maxLifeTime</span>,</span><br><span class="line">      <span class="attr">minSize</span>: particleSystem.<span class="property">minSize</span>,</span><br><span class="line">      <span class="attr">maxSize</span>: particleSystem.<span class="property">maxSize</span>,</span><br><span class="line">      <span class="attr">minEmitBox</span>: particleSystem.<span class="property">minEmitBox</span>,</span><br><span class="line">      <span class="attr">maxEmitBox</span>: particleSystem.<span class="property">maxEmitBox</span>,</span><br><span class="line">      <span class="attr">emitBox</span>: particleSystem.<span class="property">emitBox</span>,</span><br><span class="line">      <span class="attr">particles</span>: particleSystem.<span class="property">particles</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">particle</span>) =&gt;</span> (&#123;</span><br><span class="line">        <span class="attr">position</span>: particle.<span class="property">position</span>.<span class="title function_">clone</span>(),</span><br><span class="line">        <span class="attr">velocity</span>: particle.<span class="property">velocity</span>.<span class="title function_">clone</span>(),</span><br><span class="line">        <span class="attr">color</span>: particle.<span class="property">color</span>.<span class="title function_">clone</span>(),</span><br><span class="line">        <span class="attr">size</span>: particle.<span class="property">size</span>,</span><br><span class="line">        <span class="attr">lifeTime</span>: particle.<span class="property">lifeTime</span>,</span><br><span class="line">      &#125;)),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 批量应用粒子系统</span></span><br><span class="line">  <span class="title function_">applyParticleSystems</span>(<span class="params">particleSystems</span>) &#123;</span><br><span class="line">    particleSystems.<span class="title function_">forEach</span>(<span class="function">(<span class="params">particleSystem, name</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">applyParticleSystem</span>(name, particleSystem)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 应用粒子系统</span></span><br><span class="line">  <span class="title function_">applyParticleSystem</span>(<span class="params">particleSystemName, particleSystem</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> currentParticleSystem = <span class="variable language_">this</span>.<span class="property">particleSystems</span>.<span class="title function_">get</span>(particleSystemName)</span><br><span class="line">    <span class="keyword">if</span> (!currentParticleSystem) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    currentParticleSystem.<span class="property">emitRate</span> = particleSystem.<span class="property">emitRate</span></span><br><span class="line">    currentParticleSystem.<span class="property">lifeTime</span> = particleSystem.<span class="property">lifeTime</span></span><br><span class="line">    currentParticleSystem.<span class="property">size</span> = particleSystem.<span class="property">size</span></span><br><span class="line">    currentParticleSystem.<span class="property">color</span> = particleSystem.<span class="property">color</span></span><br><span class="line">    currentParticleSystem.<span class="property">color2</span> = particleSystem.<span class="property">color2</span></span><br><span class="line">    currentParticleSystem.<span class="property">colorDead</span> = particleSystem.<span class="property">colorDead</span></span><br><span class="line">    currentParticleSystem.<span class="property">gravity</span> = particleSystem.<span class="property">gravity</span></span><br><span class="line">    currentParticleSystem.<span class="property">direction</span> = particleSystem.<span class="property">direction</span></span><br><span class="line">    currentParticleSystem.<span class="property">direction2</span> = particleSystem.<span class="property">direction2</span></span><br><span class="line">    currentParticleSystem.<span class="property">minEmitPower</span> = particleSystem.<span class="property">minEmitPower</span></span><br><span class="line">    currentParticleSystem.<span class="property">maxEmitPower</span> = particleSystem.<span class="property">maxEmitPower</span></span><br><span class="line">    currentParticleSystem.<span class="property">minLifeTime</span> = particleSystem.<span class="property">minLifeTime</span></span><br><span class="line">    currentParticleSystem.<span class="property">maxLifeTime</span> = particleSystem.<span class="property">maxLifeTime</span></span><br><span class="line">    currentParticleSystem.<span class="property">minSize</span> = particleSystem.<span class="property">minSize</span></span><br><span class="line">    currentParticleSystem.<span class="property">maxSize</span> = particleSystem.<span class="property">maxSize</span></span><br><span class="line">    currentParticleSystem.<span class="property">minEmitBox</span> = particleSystem.<span class="property">minEmitBox</span></span><br><span class="line">    currentParticleSystem.<span class="property">maxEmitBox</span> = particleSystem.<span class="property">maxEmitBox</span></span><br><span class="line">    currentParticleSystem.<span class="property">emitBox</span> = particleSystem.<span class="property">emitBox</span></span><br><span class="line">    currentParticleSystem.<span class="property">particles</span> = particleSystem.<span class="property">particles</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">particle</span>) =&gt;</span> (&#123;</span><br><span class="line">      <span class="attr">position</span>: particle.<span class="property">position</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">velocity</span>: particle.<span class="property">velocity</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">color</span>: particle.<span class="property">color</span>.<span class="title function_">clone</span>(),</span><br><span class="line">      <span class="attr">size</span>: particle.<span class="property">size</span>,</span><br><span class="line">      <span class="attr">lifeTime</span>: particle.<span class="property">lifeTime</span>,</span><br><span class="line">    &#125;))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 资源清理</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">particleSystems</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">particleSystem</span>) =&gt;</span> &#123;</span><br><span class="line">      particleSystem.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">particleSystems</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> particleSystemManager = <span class="keyword">new</span> <span class="title class_">ParticleSystemManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建基础粒子系统</span></span><br><span class="line"><span class="keyword">const</span> basicParticleSystem = particleSystemManager.<span class="title function_">createBasicParticleSystem</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建复合粒子系统</span></span><br><span class="line"><span class="keyword">const</span> complexParticleSystem = particleSystemManager.<span class="title function_">createComplexParticleSystem</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加粒子系统到场景</span></span><br><span class="line">scene.<span class="title function_">addParticleSystem</span>(basicParticleSystem)</span><br><span class="line">scene.<span class="title function_">addParticleSystem</span>(complexParticleSystem)</span><br></pre></td></tr></table></figure>

<h2 id="🔊-Audio-音频系统详解"><a href="#🔊-Audio-音频系统详解" class="headerlink" title="🔊 Audio 音频系统详解"></a>🔊 Audio 音频系统详解</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Audio 音频系统完整管理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AudioManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sounds</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">soundTracks</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">audioEngine</span> = <span class="title class_">Engine</span>.<span class="property">audioEngine</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupDefaultAudio</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupDefaultAudio</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 检查音频引擎是否可用</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">audioEngine</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;音频引擎不可用&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;音频引擎已初始化&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置全局音频参数</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setGlobalVolume</span>(<span class="number">1.0</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建音效</span></span><br><span class="line">  <span class="title function_">createSound</span>(<span class="params">name, url, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> soundOptions = &#123;</span><br><span class="line">      <span class="comment">// 基础属性</span></span><br><span class="line">      <span class="attr">autoplay</span>: options.<span class="property">autoplay</span> || <span class="literal">false</span>, <span class="comment">// 自动播放</span></span><br><span class="line">      <span class="attr">loop</span>: options.<span class="property">loop</span> || <span class="literal">false</span>, <span class="comment">// 循环播放</span></span><br><span class="line">      <span class="attr">volume</span>: options.<span class="property">volume</span> || <span class="number">1.0</span>, <span class="comment">// 音量</span></span><br><span class="line">      <span class="attr">playbackRate</span>: options.<span class="property">playbackRate</span> || <span class="number">1.0</span>, <span class="comment">// 播放速率</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 3D音频属性</span></span><br><span class="line">      <span class="attr">spatialSound</span>: options.<span class="property">spatialSound</span> || <span class="literal">false</span>, <span class="comment">// 3D空间音效</span></span><br><span class="line">      <span class="attr">maxDistance</span>: options.<span class="property">maxDistance</span> || <span class="number">100</span>, <span class="comment">// 最大距离</span></span><br><span class="line">      <span class="attr">rolloffFactor</span>: options.<span class="property">rolloffFactor</span> || <span class="number">1.0</span>, <span class="comment">// 衰减因子</span></span><br><span class="line">      <span class="attr">refDistance</span>: options.<span class="property">refDistance</span> || <span class="number">1.0</span>, <span class="comment">// 参考距离</span></span><br><span class="line">      <span class="attr">distanceModel</span>: options.<span class="property">distanceModel</span> || <span class="string">&#x27;linear&#x27;</span>, <span class="comment">// 距离模型</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 回调函数</span></span><br><span class="line">      <span class="attr">onended</span>: options.<span class="property">onended</span> || <span class="literal">null</span>, <span class="comment">// 播放结束回调</span></span><br><span class="line">      <span class="attr">onload</span>: options.<span class="property">onload</span> || <span class="literal">null</span>, <span class="comment">// 加载完成回调</span></span><br><span class="line">      <span class="attr">onerror</span>: options.<span class="property">onerror</span> || <span class="literal">null</span>, <span class="comment">// 错误回调</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 其他选项</span></span><br><span class="line">      <span class="attr">streaming</span>: options.<span class="property">streaming</span> || <span class="literal">false</span>, <span class="comment">// 流式播放</span></span><br><span class="line">      <span class="attr">length</span>: options.<span class="property">length</span> || <span class="number">0</span>, <span class="comment">// 音频长度（秒）</span></span><br><span class="line">      <span class="attr">offset</span>: options.<span class="property">offset</span> || <span class="number">0</span>, <span class="comment">// 播放偏移</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sound = <span class="keyword">new</span> <span class="title class_">Sound</span>(name, url, <span class="variable language_">this</span>.<span class="property">scene</span>, soundOptions.<span class="property">onload</span>, soundOptions)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">set</span>(name, sound)</span><br><span class="line">    <span class="keyword">return</span> sound</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建背景音乐</span></span><br><span class="line">  <span class="title function_">createBackgroundMusic</span>(<span class="params">name, url, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> musicOptions = &#123;</span><br><span class="line">      <span class="attr">autoplay</span>: options.<span class="property">autoplay</span> || <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">loop</span>: options.<span class="property">loop</span> || <span class="literal">true</span>, <span class="comment">// 背景音乐通常循环播放</span></span><br><span class="line">      <span class="attr">volume</span>: options.<span class="property">volume</span> || <span class="number">0.5</span>, <span class="comment">// 背景音乐音量较低</span></span><br><span class="line">      <span class="attr">spatialSound</span>: <span class="literal">false</span>, <span class="comment">// 背景音乐不使用3D音效</span></span><br><span class="line">      <span class="attr">streaming</span>: options.<span class="property">streaming</span> || <span class="literal">true</span>, <span class="comment">// 大文件使用流式播放</span></span><br><span class="line">      ...options,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">createSound</span>(name, url, musicOptions)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建3D音效</span></span><br><span class="line">  <span class="title function_">createSpatialSound</span>(<span class="params">name, url, mesh, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> spatialOptions = &#123;</span><br><span class="line">      <span class="attr">spatialSound</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">maxDistance</span>: options.<span class="property">maxDistance</span> || <span class="number">50</span>,</span><br><span class="line">      <span class="attr">rolloffFactor</span>: options.<span class="property">rolloffFactor</span> || <span class="number">2.0</span>,</span><br><span class="line">      <span class="attr">refDistance</span>: options.<span class="property">refDistance</span> || <span class="number">1.0</span>,</span><br><span class="line">      <span class="attr">distanceModel</span>: options.<span class="property">distanceModel</span> || <span class="string">&#x27;exponential&#x27;</span>,</span><br><span class="line">      ...options,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="title function_">createSound</span>(name, url, spatialOptions)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将音效附加到网格</span></span><br><span class="line">    <span class="keyword">if</span> (mesh) &#123;</span><br><span class="line">      sound.<span class="title function_">attachToMesh</span>(mesh)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sound</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建音轨组</span></span><br><span class="line">  <span class="title function_">createSoundTrack</span>(<span class="params">name, sounds = []</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> soundTrack = <span class="keyword">new</span> <span class="title class_">SoundTrack</span>(<span class="variable language_">this</span>.<span class="property">scene</span>, &#123;</span><br><span class="line">      <span class="attr">volume</span>: <span class="number">1.0</span>,</span><br><span class="line">      <span class="attr">mainTrack</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加音效到音轨</span></span><br><span class="line">    sounds.<span class="title function_">forEach</span>(<span class="function">(<span class="params">soundName</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">get</span>(soundName)</span><br><span class="line">      <span class="keyword">if</span> (sound) &#123;</span><br><span class="line">        soundTrack.<span class="title function_">addSound</span>(sound)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">soundTracks</span>.<span class="title function_">set</span>(name, soundTrack)</span><br><span class="line">    <span class="keyword">return</span> soundTrack</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 播放音效</span></span><br><span class="line">  <span class="title function_">playSound</span>(<span class="params">name, when = <span class="number">0</span>, offset = <span class="number">0</span>, length = <span class="number">0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">if</span> (!sound) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`音效 <span class="subst">$&#123;name&#125;</span> 未找到`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (when &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 延迟播放</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          sound.<span class="title function_">play</span>(when, offset, length)</span><br><span class="line">        &#125;, when * <span class="number">1000</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sound.<span class="title function_">play</span>(when, offset, length)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`播放音效 <span class="subst">$&#123;name&#125;</span> 失败:`</span>, error)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 停止音效</span></span><br><span class="line">  <span class="title function_">stopSound</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">if</span> (sound) &#123;</span><br><span class="line">      sound.<span class="title function_">stop</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 暂停音效</span></span><br><span class="line">  <span class="title function_">pauseSound</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">if</span> (sound) &#123;</span><br><span class="line">      sound.<span class="title function_">pause</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置音效音量</span></span><br><span class="line">  <span class="title function_">setSoundVolume</span>(<span class="params">name, volume</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">if</span> (sound) &#123;</span><br><span class="line">      sound.<span class="title function_">setVolume</span>(volume)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 淡入效果</span></span><br><span class="line">  <span class="title function_">fadeInSound</span>(<span class="params">name, duration = <span class="number">1.0</span>, targetVolume = <span class="number">1.0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">if</span> (!sound) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> startVolume = <span class="number">0</span></span><br><span class="line">    <span class="keyword">const</span> steps = <span class="number">60</span> <span class="comment">// 60帧</span></span><br><span class="line">    <span class="keyword">const</span> stepDuration = (duration * <span class="number">1000</span>) / steps</span><br><span class="line">    <span class="keyword">const</span> volumeStep = (targetVolume - startVolume) / steps</span><br><span class="line"></span><br><span class="line">    sound.<span class="title function_">setVolume</span>(startVolume)</span><br><span class="line">    sound.<span class="title function_">play</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> currentStep = <span class="number">0</span></span><br><span class="line">    <span class="keyword">const</span> fadeInterval = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      currentStep++</span><br><span class="line">      <span class="keyword">const</span> currentVolume = startVolume + volumeStep * currentStep</span><br><span class="line">      sound.<span class="title function_">setVolume</span>(currentVolume)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (currentStep &gt;= steps) &#123;</span><br><span class="line">        <span class="built_in">clearInterval</span>(fadeInterval)</span><br><span class="line">        sound.<span class="title function_">setVolume</span>(targetVolume)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, stepDuration)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 淡出效果</span></span><br><span class="line">  <span class="title function_">fadeOutSound</span>(<span class="params">name, duration = <span class="number">1.0</span>, stopAfterFade = <span class="literal">true</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">get</span>(name)</span><br><span class="line">    <span class="keyword">if</span> (!sound) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> startVolume = sound.<span class="title function_">getVolume</span>()</span><br><span class="line">    <span class="keyword">const</span> targetVolume = <span class="number">0</span></span><br><span class="line">    <span class="keyword">const</span> steps = <span class="number">60</span></span><br><span class="line">    <span class="keyword">const</span> stepDuration = (duration * <span class="number">1000</span>) / steps</span><br><span class="line">    <span class="keyword">const</span> volumeStep = (startVolume - targetVolume) / steps</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> currentStep = <span class="number">0</span></span><br><span class="line">    <span class="keyword">const</span> fadeInterval = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      currentStep++</span><br><span class="line">      <span class="keyword">const</span> currentVolume = startVolume - volumeStep * currentStep</span><br><span class="line">      sound.<span class="title function_">setVolume</span>(<span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="number">0</span>, currentVolume))</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (currentStep &gt;= steps) &#123;</span><br><span class="line">        <span class="built_in">clearInterval</span>(fadeInterval)</span><br><span class="line">        sound.<span class="title function_">setVolume</span>(targetVolume)</span><br><span class="line">        <span class="keyword">if</span> (stopAfterFade) &#123;</span><br><span class="line">          sound.<span class="title function_">stop</span>()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, stepDuration)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置全局音量</span></span><br><span class="line">  <span class="title function_">setGlobalVolume</span>(<span class="params">volume</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">audioEngine</span>) &#123;</span><br><span class="line">      <span class="title class_">Engine</span>.<span class="property">audioEngine</span>.<span class="title function_">setGlobalVolume</span>(volume)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 预加载音频</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">preloadSound</span>(<span class="params">name, url</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> sound = <span class="keyword">new</span> <span class="title class_">Sound</span>(</span><br><span class="line">        name,</span><br><span class="line">        url,</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">        <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">set</span>(name, sound)</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`音效 <span class="subst">$&#123;name&#125;</span> 预加载完成`</span>)</span><br><span class="line">          <span class="title function_">resolve</span>(sound)</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">autoplay</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">onError</span>: <span class="function">(<span class="params">sound, error</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`音效 <span class="subst">$&#123;name&#125;</span> 加载失败:`</span>, error)</span><br><span class="line">            <span class="title function_">reject</span>(error)</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取音效信息</span></span><br><span class="line">  <span class="title function_">getSoundInfo</span>(<span class="params">soundName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> sound = <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">get</span>(soundName)</span><br><span class="line">    <span class="keyword">if</span> (!sound) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">name</span>: soundName,</span><br><span class="line">      <span class="attr">isPlaying</span>: sound.<span class="property">isPlaying</span>,</span><br><span class="line">      <span class="attr">isPaused</span>: sound.<span class="property">isPaused</span>,</span><br><span class="line">      <span class="attr">volume</span>: sound.<span class="title function_">getVolume</span>(),</span><br><span class="line">      <span class="attr">playbackRate</span>: sound.<span class="property">playbackRate</span>,</span><br><span class="line">      <span class="attr">spatialSound</span>: sound.<span class="property">spatialSound</span>,</span><br><span class="line">      <span class="attr">loop</span>: sound.<span class="property">loop</span>,</span><br><span class="line">      <span class="attr">autoplay</span>: sound.<span class="property">autoplay</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 资源清理</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">sound</span>) =&gt;</span> &#123;</span><br><span class="line">      sound.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sounds</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">soundTracks</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">track</span>) =&gt;</span> &#123;</span><br><span class="line">      track.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">soundTracks</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> audioManager = <span class="keyword">new</span> <span class="title class_">AudioManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建背景音乐</span></span><br><span class="line">audioManager.<span class="title function_">createBackgroundMusic</span>(<span class="string">&#x27;bgMusic&#x27;</span>, <span class="string">&#x27;/audio/background.mp3&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">volume</span>: <span class="number">0.3</span>,</span><br><span class="line">  <span class="attr">autoplay</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建3D音效</span></span><br><span class="line"><span class="keyword">const</span> fireSound = audioManager.<span class="title function_">createSpatialSound</span>(<span class="string">&#x27;fire&#x27;</span>, <span class="string">&#x27;/audio/fire.wav&#x27;</span>, fireMesh, &#123;</span><br><span class="line">  <span class="attr">loop</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">volume</span>: <span class="number">0.8</span>,</span><br><span class="line">  <span class="attr">maxDistance</span>: <span class="number">50</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 播放音效</span></span><br><span class="line">audioManager.<span class="title function_">playSound</span>(<span class="string">&#x27;fire&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 淡入背景音乐</span></span><br><span class="line">audioManager.<span class="title function_">fadeInSound</span>(<span class="string">&#x27;bgMusic&#x27;</span>, <span class="number">2.0</span>, <span class="number">0.5</span>)</span><br></pre></td></tr></table></figure>

<h2 id="🎮-Input-输入系统详解"><a href="#🎮-Input-输入系统详解" class="headerlink" title="🎮 Input 输入系统详解"></a>🎮 Input 输入系统详解</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Input 输入系统完整管理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InputManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span> = scene.<span class="title function_">getEngine</span>().<span class="title function_">getRenderingCanvas</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">actionManager</span> = <span class="keyword">new</span> <span class="title class_">ActionManager</span>(scene)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输入状态</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">keys</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mouseButtons</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mousePosition</span> = &#123; <span class="attr">x</span>: <span class="number">0</span>, <span class="attr">y</span>: <span class="number">0</span> &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gamepads</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 事件监听器</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">keyboardObservables</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pointerObservables</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupDefaultInput</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupDefaultInput</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 设置键盘输入</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupKeyboardInput</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置鼠标输入</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupPointerInput</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置游戏手柄输入</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupGamepadInput</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置场景ActionManager</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">actionManager</span> = <span class="variable language_">this</span>.<span class="property">actionManager</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置键盘输入</span></span><br><span class="line">  <span class="title function_">setupKeyboardInput</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 监听键盘按下</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">keyboardObservables</span>.<span class="title function_">set</span>(</span><br><span class="line">      <span class="string">&#x27;keydown&#x27;</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onKeyboardObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">kbInfo</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (kbInfo.<span class="property">type</span> === <span class="title class_">KeyboardEventTypes</span>.<span class="property">KEYDOWN</span>) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">keys</span>.<span class="title function_">set</span>(kbInfo.<span class="property">event</span>.<span class="property">code</span>, &#123;</span><br><span class="line">            <span class="attr">key</span>: kbInfo.<span class="property">event</span>.<span class="property">key</span>,</span><br><span class="line">            <span class="attr">code</span>: kbInfo.<span class="property">event</span>.<span class="property">code</span>,</span><br><span class="line">            <span class="attr">pressed</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">          &#125;)</span><br><span class="line"></span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onKeyDown</span>(kbInfo.<span class="property">event</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听键盘释放</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">keyboardObservables</span>.<span class="title function_">set</span>(</span><br><span class="line">      <span class="string">&#x27;keyup&#x27;</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onKeyboardObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">kbInfo</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (kbInfo.<span class="property">type</span> === <span class="title class_">KeyboardEventTypes</span>.<span class="property">KEYUP</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> keyData = <span class="variable language_">this</span>.<span class="property">keys</span>.<span class="title function_">get</span>(kbInfo.<span class="property">event</span>.<span class="property">code</span>)</span><br><span class="line">          <span class="keyword">if</span> (keyData) &#123;</span><br><span class="line">            keyData.<span class="property">pressed</span> = <span class="literal">false</span></span><br><span class="line">            keyData.<span class="property">releasedTimestamp</span> = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onKeyUp</span>(kbInfo.<span class="property">event</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置指针（鼠标/触摸）输入</span></span><br><span class="line">  <span class="title function_">setupPointerInput</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 监听指针按下</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pointerObservables</span>.<span class="title function_">set</span>(</span><br><span class="line">      <span class="string">&#x27;pointerdown&#x27;</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onPointerObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">pointerInfo</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (pointerInfo.<span class="property">type</span> === <span class="title class_">PointerEventTypes</span>.<span class="property">POINTERDOWN</span>) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">mouseButtons</span>.<span class="title function_">set</span>(pointerInfo.<span class="property">event</span>.<span class="property">button</span>, &#123;</span><br><span class="line">            <span class="attr">button</span>: pointerInfo.<span class="property">event</span>.<span class="property">button</span>,</span><br><span class="line">            <span class="attr">pressed</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">position</span>: &#123; <span class="attr">x</span>: pointerInfo.<span class="property">event</span>.<span class="property">clientX</span>, <span class="attr">y</span>: pointerInfo.<span class="property">event</span>.<span class="property">clientY</span> &#125;,</span><br><span class="line">            <span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">          &#125;)</span><br><span class="line"></span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onPointerDown</span>(pointerInfo.<span class="property">event</span>, pointerInfo)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听指针释放</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pointerObservables</span>.<span class="title function_">set</span>(</span><br><span class="line">      <span class="string">&#x27;pointerup&#x27;</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onPointerObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">pointerInfo</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (pointerInfo.<span class="property">type</span> === <span class="title class_">PointerEventTypes</span>.<span class="property">POINTERUP</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> buttonData = <span class="variable language_">this</span>.<span class="property">mouseButtons</span>.<span class="title function_">get</span>(pointerInfo.<span class="property">event</span>.<span class="property">button</span>)</span><br><span class="line">          <span class="keyword">if</span> (buttonData) &#123;</span><br><span class="line">            buttonData.<span class="property">pressed</span> = <span class="literal">false</span></span><br><span class="line">            buttonData.<span class="property">releasedTimestamp</span> = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onPointerUp</span>(pointerInfo.<span class="property">event</span>, pointerInfo)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听指针移动</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pointerObservables</span>.<span class="title function_">set</span>(</span><br><span class="line">      <span class="string">&#x27;pointermove&#x27;</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onPointerObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">pointerInfo</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (pointerInfo.<span class="property">type</span> === <span class="title class_">PointerEventTypes</span>.<span class="property">POINTERMOVE</span>) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">mousePosition</span>.<span class="property">x</span> = pointerInfo.<span class="property">event</span>.<span class="property">clientX</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">mousePosition</span>.<span class="property">y</span> = pointerInfo.<span class="property">event</span>.<span class="property">clientY</span></span><br><span class="line"></span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onPointerMove</span>(pointerInfo.<span class="property">event</span>, pointerInfo)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听鼠标滚轮</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pointerObservables</span>.<span class="title function_">set</span>(</span><br><span class="line">      <span class="string">&#x27;wheel&#x27;</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onPointerObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">pointerInfo</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (pointerInfo.<span class="property">type</span> === <span class="title class_">PointerEventTypes</span>.<span class="property">POINTERWHEEL</span>) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">onWheel</span>(pointerInfo.<span class="property">event</span>, pointerInfo)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置游戏手柄输入</span></span><br><span class="line">  <span class="title function_">setupGamepadInput</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 检查游戏手柄支持</span></span><br><span class="line">    <span class="keyword">if</span> (navigator.<span class="property">getGamepads</span>) &#123;</span><br><span class="line">      <span class="comment">// 监听游戏手柄连接</span></span><br><span class="line">      <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;gamepadconnected&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">onGamepadConnected</span>(event.<span class="property">gamepad</span>)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 监听游戏手柄断开</span></span><br><span class="line">      <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;gamepaddisconnected&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">onGamepadDisconnected</span>(event.<span class="property">gamepad</span>)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 定期检查游戏手柄状态</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">gamepadCheckInterval</span> = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">updateGamepadState</span>()</span><br><span class="line">      &#125;, <span class="number">16</span>) <span class="comment">// 60fps</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 键盘事件处理器（可重写）</span></span><br><span class="line">  <span class="title function_">onKeyDown</span>(<span class="params">event</span>) &#123;</span><br><span class="line">    <span class="comment">// 默认实现 - 可被子类重写</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Key pressed: <span class="subst">$&#123;event.key&#125;</span> (<span class="subst">$&#123;event.code&#125;</span>)`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onKeyUp</span>(<span class="params">event</span>) &#123;</span><br><span class="line">    <span class="comment">// 默认实现 - 可被子类重写</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Key released: <span class="subst">$&#123;event.key&#125;</span> (<span class="subst">$&#123;event.code&#125;</span>)`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 指针事件处理器（可重写）</span></span><br><span class="line">  <span class="title function_">onPointerDown</span>(<span class="params">event, pointerInfo</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Pointer down: button <span class="subst">$&#123;event.button&#125;</span> at (<span class="subst">$&#123;event.clientX&#125;</span>, <span class="subst">$&#123;event.clientY&#125;</span>)`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onPointerUp</span>(<span class="params">event, pointerInfo</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Pointer up: button <span class="subst">$&#123;event.button&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onPointerMove</span>(<span class="params">event, pointerInfo</span>) &#123;</span><br><span class="line">    <span class="comment">// 通常不打印移动事件，频率太高</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onWheel</span>(<span class="params">event, pointerInfo</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Wheel: <span class="subst">$&#123;pointerInfo.event.deltaY&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 游戏手柄事件处理器</span></span><br><span class="line">  <span class="title function_">onGamepadConnected</span>(<span class="params">gamepad</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Gamepad connected: <span class="subst">$&#123;gamepad.id&#125;</span>`</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="title function_">set</span>(gamepad.<span class="property">index</span>, &#123;</span><br><span class="line">      <span class="attr">gamepad</span>: gamepad,</span><br><span class="line">      <span class="attr">lastState</span>: &#123;</span><br><span class="line">        <span class="attr">buttons</span>: <span class="title class_">Array</span>(gamepad.<span class="property">buttons</span>.<span class="property">length</span>).<span class="title function_">fill</span>(<span class="literal">false</span>),</span><br><span class="line">        <span class="attr">axes</span>: <span class="title class_">Array</span>(gamepad.<span class="property">axes</span>.<span class="property">length</span>).<span class="title function_">fill</span>(<span class="number">0</span>),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onGamepadDisconnected</span>(<span class="params">gamepad</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Gamepad disconnected: <span class="subst">$&#123;gamepad.id&#125;</span>`</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="title function_">delete</span>(gamepad.<span class="property">index</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">updateGamepadState</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> gamepads = navigator.<span class="title function_">getGamepads</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> gamepad <span class="keyword">of</span> gamepads) &#123;</span><br><span class="line">      <span class="keyword">if</span> (gamepad &amp;&amp; <span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="title function_">has</span>(gamepad.<span class="property">index</span>)) &#123;</span><br><span class="line">        <span class="keyword">const</span> gamepadData = <span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="title function_">get</span>(gamepad.<span class="property">index</span>)</span><br><span class="line">        <span class="keyword">const</span> lastState = gamepadData.<span class="property">lastState</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查按钮状态变化</span></span><br><span class="line">        gamepad.<span class="property">buttons</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">button, index</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> wasPressed = lastState.<span class="property">buttons</span>[index]</span><br><span class="line">          <span class="keyword">const</span> isPressed = button.<span class="property">pressed</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (isPressed &amp;&amp; !wasPressed) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">onGamepadButtonDown</span>(gamepad, index, button)</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isPressed &amp;&amp; wasPressed) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">onGamepadButtonUp</span>(gamepad, index, button)</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          lastState.<span class="property">buttons</span>[index] = isPressed</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查摇杆状态变化</span></span><br><span class="line">        gamepad.<span class="property">axes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">axis, index</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> lastValue = lastState.<span class="property">axes</span>[index]</span><br><span class="line">          <span class="keyword">const</span> currentValue = axis</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (<span class="title class_">Math</span>.<span class="title function_">abs</span>(currentValue - lastValue) &gt; <span class="number">0.1</span>) &#123;</span><br><span class="line">            <span class="comment">// 死区处理</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">onGamepadAxisMove</span>(gamepad, index, currentValue, lastValue)</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          lastState.<span class="property">axes</span>[index] = currentValue</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onGamepadButtonDown</span>(<span class="params">gamepad, buttonIndex, button</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Gamepad <span class="subst">$&#123;gamepad.index&#125;</span> button <span class="subst">$&#123;buttonIndex&#125;</span> pressed`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onGamepadButtonUp</span>(<span class="params">gamepad, buttonIndex, button</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Gamepad <span class="subst">$&#123;gamepad.index&#125;</span> button <span class="subst">$&#123;buttonIndex&#125;</span> released`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onGamepadAxisMove</span>(<span class="params">gamepad, axisIndex, currentValue, lastValue</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Gamepad <span class="subst">$&#123;gamepad.index&#125;</span> axis <span class="subst">$&#123;axisIndex&#125;</span>: <span class="subst">$&#123;currentValue&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 输入状态查询方法</span></span><br><span class="line">  <span class="title function_">isKeyPressed</span>(<span class="params">keyCode</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> keyData = <span class="variable language_">this</span>.<span class="property">keys</span>.<span class="title function_">get</span>(keyCode)</span><br><span class="line">    <span class="keyword">return</span> keyData ? keyData.<span class="property">pressed</span> : <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">isMouseButtonPressed</span>(<span class="params">button</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> buttonData = <span class="variable language_">this</span>.<span class="property">mouseButtons</span>.<span class="title function_">get</span>(button)</span><br><span class="line">    <span class="keyword">return</span> buttonData ? buttonData.<span class="property">pressed</span> : <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getMousePosition</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; ...<span class="variable language_">this</span>.<span class="property">mousePosition</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">isGamepadButtonPressed</span>(<span class="params">gamepadIndex, buttonIndex</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> gamepadData = <span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="title function_">get</span>(gamepadIndex)</span><br><span class="line">    <span class="keyword">if</span> (!gamepadData) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> gamepad = navigator.<span class="title function_">getGamepads</span>()[gamepadIndex]</span><br><span class="line">    <span class="keyword">return</span> gamepad &amp;&amp; gamepad.<span class="property">buttons</span>[buttonIndex] &amp;&amp; gamepad.<span class="property">buttons</span>[buttonIndex].<span class="property">pressed</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getGamepadAxisValue</span>(<span class="params">gamepadIndex, axisIndex</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> gamepadData = <span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="title function_">get</span>(gamepadIndex)</span><br><span class="line">    <span class="keyword">if</span> (!gamepadData) <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> gamepad = navigator.<span class="title function_">getGamepads</span>()[gamepadIndex]</span><br><span class="line">    <span class="keyword">return</span> gamepad &amp;&amp; gamepad.<span class="property">axes</span>[axisIndex] ? gamepad.<span class="property">axes</span>[axisIndex] : <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ActionManager 便捷方法</span></span><br><span class="line">  <span class="title function_">addKeyAction</span>(<span class="params">keyCode, trigger, callback</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> action = <span class="keyword">new</span> <span class="title class_">ExecuteCodeAction</span>(trigger || <span class="title class_">ActionManager</span>.<span class="property">OnKeyDownTrigger</span>, callback)</span><br><span class="line">    action.<span class="property">trigger</span>.<span class="property">parameter</span> = keyCode</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">actionManager</span>.<span class="title function_">registerAction</span>(action)</span><br><span class="line">    <span class="keyword">return</span> action</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">addPointerAction</span>(<span class="params">trigger, callback, condition = <span class="literal">null</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> action = <span class="keyword">new</span> <span class="title class_">ExecuteCodeAction</span>(trigger, callback)</span><br><span class="line">    <span class="keyword">if</span> (condition) &#123;</span><br><span class="line">      action.<span class="property">trigger</span>.<span class="property">parameter</span> = condition</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">actionManager</span>.<span class="title function_">registerAction</span>(action)</span><br><span class="line">    <span class="keyword">return</span> action</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 组合按键检测</span></span><br><span class="line">  <span class="title function_">areKeysPressed</span>(<span class="params">keyCodes</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> keyCodes.<span class="title function_">every</span>(<span class="function">(<span class="params">keyCode</span>) =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">isKeyPressed</span>(keyCode))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 快捷键绑定</span></span><br><span class="line">  <span class="title function_">bindShortcut</span>(<span class="params">keys, callback, description = <span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> shortcut = &#123;</span><br><span class="line">      <span class="attr">keys</span>: <span class="title class_">Array</span>.<span class="title function_">isArray</span>(keys) ? keys : [keys],</span><br><span class="line">      <span class="attr">callback</span>: callback,</span><br><span class="line">      <span class="attr">description</span>: description,</span><br><span class="line">      <span class="attr">active</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 每帧检查快捷键</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">checkShortcut</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (shortcut.<span class="property">active</span> &amp;&amp; <span class="variable language_">this</span>.<span class="title function_">areKeysPressed</span>(shortcut.<span class="property">keys</span>)) &#123;</span><br><span class="line">        <span class="title function_">callback</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">registerBeforeRender</span>(checkShortcut)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">unbind</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        shortcut.<span class="property">active</span> = <span class="literal">false</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">unregisterBeforeRender</span>(checkShortcut)</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">description</span>: shortcut.<span class="property">description</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 虚拟摇杆支持（移动端）</span></span><br><span class="line">  <span class="title function_">createVirtualJoystick</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title class_">VirtualJoystick</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;VirtualJoystick 不可用&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> joystick = <span class="keyword">new</span> <span class="title class_">VirtualJoystick</span>(options.<span class="property">leftJoystick</span> !== <span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置回调</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">onMove</span>) &#123;</span><br><span class="line">      joystick.<span class="title function_">setJoystickSensibility</span>(options.<span class="property">sensitivity</span> || <span class="number">25</span>)</span><br><span class="line">      joystick.<span class="property">onPointerDown</span> = options.<span class="property">onPointerDown</span></span><br><span class="line">      joystick.<span class="property">onPointerUp</span> = options.<span class="property">onPointerUp</span></span><br><span class="line">      joystick.<span class="property">onPointerMove</span> = options.<span class="property">onMove</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> joystick</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 触摸手势支持</span></span><br><span class="line">  <span class="title function_">setupTouchGestures</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">ontouchstart</span> === <span class="literal">undefined</span>) <span class="keyword">return</span> <span class="comment">// 不是触摸设备</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> touchStartTime = <span class="number">0</span></span><br><span class="line">    <span class="keyword">let</span> touchStartPos = &#123; <span class="attr">x</span>: <span class="number">0</span>, <span class="attr">y</span>: <span class="number">0</span> &#125;</span><br><span class="line">    <span class="keyword">let</span> lastTouchDistance = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;touchstart&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">      touchStartTime = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">      <span class="keyword">if</span> (event.<span class="property">touches</span>.<span class="property">length</span> === <span class="number">1</span>) &#123;</span><br><span class="line">        touchStartPos.<span class="property">x</span> = event.<span class="property">touches</span>[<span class="number">0</span>].<span class="property">clientX</span></span><br><span class="line">        touchStartPos.<span class="property">y</span> = event.<span class="property">touches</span>[<span class="number">0</span>].<span class="property">clientY</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.<span class="property">touches</span>.<span class="property">length</span> === <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> touch1 = event.<span class="property">touches</span>[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">const</span> touch2 = event.<span class="property">touches</span>[<span class="number">1</span>]</span><br><span class="line">        lastTouchDistance = <span class="title class_">Math</span>.<span class="title function_">sqrt</span>(</span><br><span class="line">          <span class="title class_">Math</span>.<span class="title function_">pow</span>(touch2.<span class="property">clientX</span> - touch1.<span class="property">clientX</span>, <span class="number">2</span>) +</span><br><span class="line">            <span class="title class_">Math</span>.<span class="title function_">pow</span>(touch2.<span class="property">clientY</span> - touch1.<span class="property">clientY</span>, <span class="number">2</span>),</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;touchend&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> touchDuration = <span class="title class_">Date</span>.<span class="title function_">now</span>() - touchStartTime</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (event.<span class="property">changedTouches</span>.<span class="property">length</span> === <span class="number">1</span> &amp;&amp; touchDuration &lt; <span class="number">300</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> touch = event.<span class="property">changedTouches</span>[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">const</span> deltaX = <span class="title class_">Math</span>.<span class="title function_">abs</span>(touch.<span class="property">clientX</span> - touchStartPos.<span class="property">x</span>)</span><br><span class="line">        <span class="keyword">const</span> deltaY = <span class="title class_">Math</span>.<span class="title function_">abs</span>(touch.<span class="property">clientY</span> - touchStartPos.<span class="property">y</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (deltaX &lt; <span class="number">10</span> &amp;&amp; deltaY &lt; <span class="number">10</span>) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">onTap</span> &amp;&amp; <span class="variable language_">this</span>.<span class="title function_">onTap</span>(touch)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;touchmove&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (event.<span class="property">touches</span>.<span class="property">length</span> === <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> touch1 = event.<span class="property">touches</span>[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">const</span> touch2 = event.<span class="property">touches</span>[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">const</span> currentDistance = <span class="title class_">Math</span>.<span class="title function_">sqrt</span>(</span><br><span class="line">          <span class="title class_">Math</span>.<span class="title function_">pow</span>(touch2.<span class="property">clientX</span> - touch1.<span class="property">clientX</span>, <span class="number">2</span>) +</span><br><span class="line">            <span class="title class_">Math</span>.<span class="title function_">pow</span>(touch2.<span class="property">clientY</span> - touch1.<span class="property">clientY</span>, <span class="number">2</span>),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> scale = currentDistance / lastTouchDistance</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">onPinch</span> &amp;&amp; <span class="variable language_">this</span>.<span class="title function_">onPinch</span>(scale)</span><br><span class="line">        lastTouchDistance = currentDistance</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 触摸回调设置</span></span><br><span class="line">  <span class="title function_">onTap</span>(<span class="params">touch</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Tap detected at:&#x27;</span>, touch.<span class="property">clientX</span>, touch.<span class="property">clientY</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onPinch</span>(<span class="params">scale</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Pinch detected, scale:&#x27;</span>, scale)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取输入状态信息</span></span><br><span class="line">  <span class="title function_">getInputState</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">keyboard</span>: &#123;</span><br><span class="line">        <span class="attr">pressedKeys</span>: <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="variable language_">this</span>.<span class="property">keys</span>.<span class="title function_">entries</span>()).<span class="title function_">filter</span>(<span class="function">(<span class="params">[, data]</span>) =&gt;</span> data.<span class="property">pressed</span>),</span><br><span class="line">        <span class="attr">keyCount</span>: <span class="variable language_">this</span>.<span class="property">keys</span>.<span class="property">size</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">mouse</span>: &#123;</span><br><span class="line">        <span class="attr">position</span>: <span class="variable language_">this</span>.<span class="property">mousePosition</span>,</span><br><span class="line">        <span class="attr">pressedButtons</span>: <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="variable language_">this</span>.<span class="property">mouseButtons</span>.<span class="title function_">entries</span>()).<span class="title function_">filter</span>(<span class="function">(<span class="params">[, data]</span>) =&gt;</span> data.<span class="property">pressed</span>),</span><br><span class="line">        <span class="attr">buttonCount</span>: <span class="variable language_">this</span>.<span class="property">mouseButtons</span>.<span class="property">size</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">gamepad</span>: &#123;</span><br><span class="line">        <span class="attr">connectedGamepads</span>: <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="title function_">keys</span>()),</span><br><span class="line">        <span class="attr">gamepadCount</span>: <span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="property">size</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 资源清理</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 清理键盘监听器</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">keyboardObservables</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">observable</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onKeyboardObservable</span>.<span class="title function_">remove</span>(observable)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">keyboardObservables</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理指针监听器</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pointerObservables</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">observable</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">onPointerObservable</span>.<span class="title function_">remove</span>(observable)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pointerObservables</span>.<span class="title function_">clear</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理游戏手柄监听器</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">gamepadCheckInterval</span>) &#123;</span><br><span class="line">      <span class="built_in">clearInterval</span>(<span class="variable language_">this</span>.<span class="property">gamepadCheckInterval</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理状态</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">keys</span>.<span class="title function_">clear</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mouseButtons</span>.<span class="title function_">clear</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gamepads</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> inputManager = <span class="keyword">new</span> <span class="title class_">InputManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 键盘事件重写示例</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomInputManager</span> <span class="keyword">extends</span> <span class="title class_ inherited__">InputManager</span> &#123;</span><br><span class="line">  <span class="title function_">onKeyDown</span>(<span class="params">event</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (event.<span class="property">code</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;KeyW&#x27;</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;向前移动&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;KeyS&#x27;</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;向后移动&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;KeyA&#x27;</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;向左移动&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;KeyD&#x27;</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;向右移动&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;Space&#x27;</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;跳跃&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onPointerDown</span>(<span class="params">event, pointerInfo</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (event.<span class="property">button</span> === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 左键</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;射击&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.<span class="property">button</span> === <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="comment">// 右键</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;瞄准&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建自定义输入管理器</span></span><br><span class="line"><span class="keyword">const</span> customInput = <span class="keyword">new</span> <span class="title class_">CustomInputManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绑定快捷键</span></span><br><span class="line"><span class="keyword">const</span> saveShortcut = customInput.<span class="title function_">bindShortcut</span>(</span><br><span class="line">  [<span class="string">&#x27;ControlLeft&#x27;</span>, <span class="string">&#x27;KeyS&#x27;</span>],</span><br><span class="line">  <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;保存游戏&#x27;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&#x27;保存游戏 (Ctrl+S)&#x27;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查输入状态</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;是否按下W键:&#x27;</span>, customInput.<span class="title function_">isKeyPressed</span>(<span class="string">&#x27;KeyW&#x27;</span>))</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;鼠标位置:&#x27;</span>, customInput.<span class="title function_">getMousePosition</span>())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 触摸手势支持</span></span><br><span class="line">customInput.<span class="title function_">setupTouchGestures</span>()</span><br><span class="line">customInput.<span class="property">onTap</span> = <span class="function">(<span class="params">touch</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;点击位置:&#x27;</span>, touch.<span class="property">clientX</span>, touch.<span class="property">clientY</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加ActionManager动作</span></span><br><span class="line">customInput.<span class="title function_">addKeyAction</span>(<span class="string">&#x27;KeyE&#x27;</span>, <span class="title class_">ActionManager</span>.<span class="property">OnKeyDownTrigger</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;互动&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="🔧-Asset-资源管理详解"><a href="#🔧-Asset-资源管理详解" class="headerlink" title="🔧 Asset 资源管理详解"></a>🔧 Asset 资源管理详解</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Asset 资源管理完整管理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AssetManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span> = scene.<span class="title function_">getEngine</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 资源容器</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">assetContainers</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">textures</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">models</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sounds</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">materials</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载状态</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loadingTasks</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loadedAssets</span> = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">failedAssets</span> = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">baseUrl</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">enableCaching</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maxConcurrentLoads</span> = <span class="number">6</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">retryAttempts</span> = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupDefaultConfiguration</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupDefaultConfiguration</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 设置SceneLoader插件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">enableLoaderPlugins</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置缓存策略</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupCaching</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">enableLoaderPlugins</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 确保必要的loader插件可用</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="title class_">GLTFFileLoader</span> !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable constant_">BABYLON</span>.<span class="property">SceneLoader</span>.<span class="title class_">RegisterPlugin</span>(<span class="keyword">new</span> <span class="title class_">GLTFFileLoader</span>())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="title class_">OBJFileLoader</span> !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable constant_">BABYLON</span>.<span class="property">SceneLoader</span>.<span class="title class_">RegisterPlugin</span>(<span class="keyword">new</span> <span class="title class_">OBJFileLoader</span>())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;资源加载器插件已启用&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupCaching</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">enableCaching</span>) &#123;</span><br><span class="line">      <span class="comment">// 设置纹理缓存</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="property">enableOfflineSupport</span> = <span class="literal">false</span> <span class="comment">// 根据需要调整</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;资源缓存已启用&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 加载3D模型</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadModel</span>(<span class="params">name, url, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> fullUrl = <span class="variable language_">this</span>.<span class="property">baseUrl</span> + url</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`开始加载模型: <span class="subst">$&#123;name&#125;</span> from <span class="subst">$&#123;fullUrl&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title class_">SceneLoader</span>.<span class="title class_">ImportMeshAsync</span>(</span><br><span class="line">        options.<span class="property">meshNames</span> || <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        fullUrl,</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">        options.<span class="property">onProgress</span>,</span><br><span class="line">        options.<span class="property">pluginExtension</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 创建资源容器</span></span><br><span class="line">      <span class="keyword">const</span> container = <span class="keyword">new</span> <span class="title class_">AssetContainer</span>(<span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 添加加载的资源到容器</span></span><br><span class="line">      result.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">        container.<span class="property">meshes</span>.<span class="title function_">push</span>(mesh)</span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">position</span>) mesh.<span class="property">position</span> = options.<span class="property">position</span></span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">rotation</span>) mesh.<span class="property">rotation</span> = options.<span class="property">rotation</span></span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">scaling</span>) mesh.<span class="property">scaling</span> = options.<span class="property">scaling</span></span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      result.<span class="property">materials</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">material</span>) =&gt;</span> &#123;</span><br><span class="line">        container.<span class="property">materials</span>.<span class="title function_">push</span>(material)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      result.<span class="property">textures</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">texture</span>) =&gt;</span> &#123;</span><br><span class="line">        container.<span class="property">textures</span>.<span class="title function_">push</span>(texture)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      result.<span class="property">animationGroups</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">animGroup</span>) =&gt;</span> &#123;</span><br><span class="line">        container.<span class="property">animationGroups</span>.<span class="title function_">push</span>(animGroup)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 存储资源</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">assetContainers</span>.<span class="title function_">set</span>(name, container)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">models</span>.<span class="title function_">set</span>(name, &#123;</span><br><span class="line">        <span class="attr">container</span>: container,</span><br><span class="line">        <span class="attr">meshes</span>: result.<span class="property">meshes</span>,</span><br><span class="line">        <span class="attr">materials</span>: result.<span class="property">materials</span>,</span><br><span class="line">        <span class="attr">textures</span>: result.<span class="property">textures</span>,</span><br><span class="line">        <span class="attr">animationGroups</span>: result.<span class="property">animationGroups</span>,</span><br><span class="line">        <span class="attr">skeletons</span>: result.<span class="property">skeletons</span>,</span><br><span class="line">        <span class="attr">url</span>: fullUrl,</span><br><span class="line">        <span class="attr">loadTime</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">loadedAssets</span>.<span class="title function_">add</span>(name)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`模型加载完成: <span class="subst">$&#123;name&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> result</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`模型加载失败: <span class="subst">$&#123;name&#125;</span>`</span>, error)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">failedAssets</span>.<span class="title function_">add</span>(name)</span><br><span class="line">      <span class="keyword">throw</span> error</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 加载纹理</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadTexture</span>(<span class="params">name, url, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> fullUrl = <span class="variable language_">this</span>.<span class="property">baseUrl</span> + url</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`开始加载纹理: <span class="subst">$&#123;name&#125;</span> from <span class="subst">$&#123;fullUrl&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> texture = <span class="keyword">new</span> <span class="title class_">Texture</span>(</span><br><span class="line">        fullUrl,</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">        options.<span class="property">noMipmap</span>,</span><br><span class="line">        options.<span class="property">invertY</span>,</span><br><span class="line">        options.<span class="property">samplingMode</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 等待纹理加载完成</span></span><br><span class="line">      <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        texture.<span class="property">onLoadObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> <span class="title function_">resolve</span>(texture))</span><br><span class="line">        texture.<span class="property">onErrorObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> <span class="title function_">reject</span>(error))</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 应用纹理设置</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">wrapU</span> !== <span class="literal">undefined</span>) texture.<span class="property">wrapU</span> = options.<span class="property">wrapU</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">wrapV</span> !== <span class="literal">undefined</span>) texture.<span class="property">wrapV</span> = options.<span class="property">wrapV</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">uOffset</span> !== <span class="literal">undefined</span>) texture.<span class="property">uOffset</span> = options.<span class="property">uOffset</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">vOffset</span> !== <span class="literal">undefined</span>) texture.<span class="property">vOffset</span> = options.<span class="property">vOffset</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">uScale</span> !== <span class="literal">undefined</span>) texture.<span class="property">uScale</span> = options.<span class="property">uScale</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">vScale</span> !== <span class="literal">undefined</span>) texture.<span class="property">vScale</span> = options.<span class="property">vScale</span></span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">set</span>(name, &#123;</span><br><span class="line">        <span class="attr">texture</span>: texture,</span><br><span class="line">        <span class="attr">url</span>: fullUrl,</span><br><span class="line">        <span class="attr">options</span>: options,</span><br><span class="line">        <span class="attr">loadTime</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">loadedAssets</span>.<span class="title function_">add</span>(name)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`纹理加载完成: <span class="subst">$&#123;name&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> texture</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`纹理加载失败: <span class="subst">$&#123;name&#125;</span>`</span>, error)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">failedAssets</span>.<span class="title function_">add</span>(name)</span><br><span class="line">      <span class="keyword">throw</span> error</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 加载立方体纹理</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadCubeTexture</span>(<span class="params">name, url, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> fullUrl = <span class="variable language_">this</span>.<span class="property">baseUrl</span> + url</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`开始加载立方体纹理: <span class="subst">$&#123;name&#125;</span> from <span class="subst">$&#123;fullUrl&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> cubeTexture = <span class="keyword">new</span> <span class="title class_">CubeTexture</span>(fullUrl, <span class="variable language_">this</span>.<span class="property">scene</span>, options.<span class="property">extensions</span>, options.<span class="property">noMipmap</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 等待加载完成</span></span><br><span class="line">      <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        cubeTexture.<span class="property">onLoadObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> <span class="title function_">resolve</span>(cubeTexture))</span><br><span class="line">        cubeTexture.<span class="property">onErrorObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> <span class="title function_">reject</span>(error))</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">set</span>(name, &#123;</span><br><span class="line">        <span class="attr">texture</span>: cubeTexture,</span><br><span class="line">        <span class="attr">url</span>: fullUrl,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;cube&#x27;</span>,</span><br><span class="line">        <span class="attr">loadTime</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">loadedAssets</span>.<span class="title function_">add</span>(name)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`立方体纹理加载完成: <span class="subst">$&#123;name&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> cubeTexture</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`立方体纹理加载失败: <span class="subst">$&#123;name&#125;</span>`</span>, error)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">failedAssets</span>.<span class="title function_">add</span>(name)</span><br><span class="line">      <span class="keyword">throw</span> error</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 加载HDR环境纹理</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadHDRTexture</span>(<span class="params">name, url, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> fullUrl = <span class="variable language_">this</span>.<span class="property">baseUrl</span> + url</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`开始加载HDR纹理: <span class="subst">$&#123;name&#125;</span> from <span class="subst">$&#123;fullUrl&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> hdrTexture = <span class="keyword">new</span> <span class="title class_">HDRCubeTexture</span>(</span><br><span class="line">        fullUrl,</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span>,</span><br><span class="line">        options.<span class="property">size</span>,</span><br><span class="line">        options.<span class="property">noMipmap</span>,</span><br><span class="line">        options.<span class="property">generateHarmonics</span>,</span><br><span class="line">        options.<span class="property">useInGammaSpace</span>,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 等待加载完成</span></span><br><span class="line">      <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        hdrTexture.<span class="property">onLoadObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> <span class="title function_">resolve</span>(hdrTexture))</span><br><span class="line">        hdrTexture.<span class="property">onErrorObservable</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> <span class="title function_">reject</span>(error))</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">textures</span>.<span class="title function_">set</span>(name, &#123;</span><br><span class="line">        <span class="attr">texture</span>: hdrTexture,</span><br><span class="line">        <span class="attr">url</span>: fullUrl,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;hdr&#x27;</span>,</span><br><span class="line">        <span class="attr">loadTime</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">loadedAssets</span>.<span class="title function_">add</span>(name)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`HDR纹理加载完成: <span class="subst">$&#123;name&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> hdrTexture</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`HDR纹理加载失败: <span class="subst">$&#123;name&#125;</span>`</span>, error)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">failedAssets</span>.<span class="title function_">add</span>(name)</span><br><span class="line">      <span class="keyword">throw</span> error</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 批量加载资源</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadAssets</span>(<span class="params">assetList, onProgress = <span class="literal">null</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> tasks = []</span><br><span class="line">    <span class="keyword">const</span> results = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> asset <span class="keyword">of</span> assetList) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; type, name, url, options = &#123;&#125; &#125; = asset</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> loadTask</span><br><span class="line">      <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;model&#x27;</span>:</span><br><span class="line">          loadTask = <span class="variable language_">this</span>.<span class="title function_">loadModel</span>(name, url, options)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;texture&#x27;</span>:</span><br><span class="line">          loadTask = <span class="variable language_">this</span>.<span class="title function_">loadTexture</span>(name, url, options)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;cubeTexture&#x27;</span>:</span><br><span class="line">          loadTask = <span class="variable language_">this</span>.<span class="title function_">loadCubeTexture</span>(name, url, options)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;hdrTexture&#x27;</span>:</span><br><span class="line">          loadTask = <span class="variable language_">this</span>.<span class="title function_">loadHDRTexture</span>(name, url, options)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;sound&#x27;</span>:</span><br><span class="line">          loadTask = <span class="variable language_">this</span>.<span class="title function_">loadSound</span>(name, url, options)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`未知的资源类型: <span class="subst">$&#123;type&#125;</span>`</span>)</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      tasks.<span class="title function_">push</span>(</span><br><span class="line">        loadTask</span><br><span class="line">          .<span class="title function_">then</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">            results.<span class="title function_">push</span>(&#123; name, type, <span class="attr">success</span>: <span class="literal">true</span>, result &#125;)</span><br><span class="line">            <span class="keyword">if</span> (onProgress) &#123;</span><br><span class="line">              <span class="title function_">onProgress</span>(results.<span class="property">length</span>, assetList.<span class="property">length</span>, name, type)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">          &#125;)</span><br><span class="line">          .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">            results.<span class="title function_">push</span>(&#123; name, type, <span class="attr">success</span>: <span class="literal">false</span>, error &#125;)</span><br><span class="line">            <span class="keyword">if</span> (onProgress) &#123;</span><br><span class="line">              <span class="title function_">onProgress</span>(results.<span class="property">length</span>, assetList.<span class="property">length</span>, name, type)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">          &#125;),</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(tasks)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> successful = results.<span class="title function_">filter</span>(<span class="function">(<span class="params">r</span>) =&gt;</span> r.<span class="property">success</span>).<span class="property">length</span></span><br><span class="line">    <span class="keyword">const</span> failed = results.<span class="title function_">filter</span>(<span class="function">(<span class="params">r</span>) =&gt;</span> !r.<span class="property">success</span>).<span class="property">length</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`批量加载完成: 成功 <span class="subst">$&#123;successful&#125;</span>, 失败 <span class="subst">$&#123;failed&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      results,</span><br><span class="line">      successful,</span><br><span class="line">      failed,</span><br><span class="line">      <span class="attr">successRate</span>: successful / assetList.<span class="property">length</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 克隆模型实例</span></span><br><span class="line">  <span class="title function_">cloneModel</span>(<span class="params">originalName, newName, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> modelData = <span class="variable language_">this</span>.<span class="property">models</span>.<span class="title function_">get</span>(originalName)</span><br><span class="line">    <span class="keyword">if</span> (!modelData) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`原始模型未找到: <span class="subst">$&#123;originalName&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> clonedMeshes = []</span><br><span class="line"></span><br><span class="line">    modelData.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> clonedMesh = mesh.<span class="title function_">clone</span>(newName + <span class="string">&#x27;_&#x27;</span> + mesh.<span class="property">name</span>, options.<span class="property">parent</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">position</span>) clonedMesh.<span class="property">position</span> = options.<span class="property">position</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">rotation</span>) clonedMesh.<span class="property">rotation</span> = options.<span class="property">rotation</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">scaling</span>) clonedMesh.<span class="property">scaling</span> = options.<span class="property">scaling</span></span><br><span class="line"></span><br><span class="line">      clonedMeshes.<span class="title function_">push</span>(clonedMesh)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建新的模型记录</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">models</span>.<span class="title function_">set</span>(newName, &#123;</span><br><span class="line">      ...modelData,</span><br><span class="line">      <span class="attr">meshes</span>: clonedMeshes,</span><br><span class="line">      <span class="attr">isClone</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">originalModel</span>: originalName,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`模型克隆完成: <span class="subst">$&#123;originalName&#125;</span> -&gt; <span class="subst">$&#123;newName&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">return</span> clonedMeshes</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 实例化模型</span></span><br><span class="line">  <span class="title function_">instanceModel</span>(<span class="params">originalName, newName, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> modelData = <span class="variable language_">this</span>.<span class="property">models</span>.<span class="title function_">get</span>(originalName)</span><br><span class="line">    <span class="keyword">if</span> (!modelData) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`原始模型未找到: <span class="subst">$&#123;originalName&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> instances = []</span><br><span class="line"></span><br><span class="line">    modelData.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (mesh.<span class="property">geometry</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> instance = mesh.<span class="title function_">createInstance</span>(newName + <span class="string">&#x27;_&#x27;</span> + mesh.<span class="property">name</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">position</span>) instance.<span class="property">position</span> = options.<span class="property">position</span></span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">rotation</span>) instance.<span class="property">rotation</span> = options.<span class="property">rotation</span></span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">scaling</span>) instance.<span class="property">scaling</span> = options.<span class="property">scaling</span></span><br><span class="line"></span><br><span class="line">        instances.<span class="title function_">push</span>(instance)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`模型实例化完成: <span class="subst">$&#123;originalName&#125;</span> -&gt; <span class="subst">$&#123;newName&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">return</span> instances</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加自定义资源</span></span><br><span class="line">  <span class="title function_">addCustomAssets</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 添加模型资源</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">addModelAsset</span>(<span class="string">&#x27;/models/customModel.glb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加纹理资源</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">addTextureAsset</span>(<span class="string">&#x27;/textures/customTexture.jpg&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加音频资源</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">addAudioAsset</span>(<span class="string">&#x27;/sounds/customSound.mp3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加环境资源</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">addEnvironmentAsset</span>(<span class="string">&#x27;/environments/customEnvironment.dds&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加模型资源</span></span><br><span class="line">  <span class="title function_">addModelAsset</span>(<span class="params">url</span>) &#123;</span><br><span class="line">    <span class="comment">// 创建模型资源</span></span><br><span class="line">    <span class="keyword">const</span> modelAsset = <span class="keyword">new</span> <span class="title class_">AssetContainer</span>(url, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    modelAsset.<span class="property">name</span> = url.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>).<span class="title function_">pop</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">assets</span>.<span class="title function_">set</span>(url, modelAsset)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加纹理资源</span></span><br><span class="line">  <span class="title function_">addTextureAsset</span>(<span class="params">url</span>) &#123;</span><br><span class="line">    <span class="comment">// 创建纹理资源</span></span><br><span class="line">    <span class="keyword">const</span> textureAsset = <span class="keyword">new</span> <span class="title class_">Texture</span>(url, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    textureAsset.<span class="property">name</span> = url.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>).<span class="title function_">pop</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">assets</span>.<span class="title function_">set</span>(url, textureAsset)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加音频资源</span></span><br><span class="line">  <span class="title function_">addAudioAsset</span>(<span class="params">url</span>) &#123;</span><br><span class="line">    <span class="comment">// 创建音频资源</span></span><br><span class="line">    <span class="keyword">const</span> audioAsset = <span class="keyword">new</span> <span class="title class_">Audio</span>(url, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    audioAsset.<span class="property">name</span> = url.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>).<span class="title function_">pop</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">assets</span>.<span class="title function_">set</span>(url, audioAsset)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加环境资源</span></span><br><span class="line">  <span class="title function_">addEnvironmentAsset</span>(<span class="params">url</span>) &#123;</span><br><span class="line">    <span class="comment">// 创建环境资源</span></span><br><span class="line">    <span class="keyword">const</span> environmentAsset = <span class="keyword">new</span> <span class="title class_">CubeTexture</span>(url, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    environmentAsset.<span class="property">name</span> = url.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>).<span class="title function_">pop</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">assets</span>.<span class="title function_">set</span>(url, environmentAsset)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取资源信息</span></span><br><span class="line">  <span class="title function_">getAssetInfo</span>(<span class="params">assetName</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> asset = <span class="variable language_">this</span>.<span class="property">assets</span>.<span class="title function_">get</span>(assetName)</span><br><span class="line">    <span class="keyword">if</span> (!asset) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> info = &#123;</span><br><span class="line">      <span class="attr">name</span>: assetName,</span><br><span class="line">      <span class="attr">type</span>: asset.<span class="title function_">getClassName</span>(),</span><br><span class="line">      <span class="attr">url</span>: asset.<span class="property">url</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 批量应用资源</span></span><br><span class="line">  <span class="title function_">applyAssets</span>(<span class="params">assets</span>) &#123;</span><br><span class="line">    assets.<span class="title function_">forEach</span>(<span class="function">(<span class="params">asset, name</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">applyAsset</span>(name, asset)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 应用资源</span></span><br><span class="line">  <span class="title function_">applyAsset</span>(<span class="params">assetName, asset</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> currentAsset = <span class="variable language_">this</span>.<span class="property">assets</span>.<span class="title function_">get</span>(assetName)</span><br><span class="line">    <span class="keyword">if</span> (!currentAsset) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    currentAsset.<span class="property">url</span> = asset.<span class="property">url</span></span><br><span class="line">    currentAsset.<span class="property">name</span> = asset.<span class="property">name</span></span><br><span class="line">    currentAsset.<span class="property">type</span> = asset.<span class="property">type</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 资源清理</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">assets</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">asset</span>) =&gt;</span> &#123;</span><br><span class="line">      asset.<span class="title function_">dispose</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">assets</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> assetManager = <span class="keyword">new</span> <span class="title class_">AssetManager</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加默认资源</span></span><br><span class="line">assetManager.<span class="title function_">addDefaultAssets</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加自定义资源</span></span><br><span class="line">assetManager.<span class="title function_">addCustomAssets</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取资源信息</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;资源信息:&#x27;</span>, assetManager.<span class="title function_">getAssetInfo</span>(<span class="string">&#x27;/models/defaultModel.glb&#x27;</span>))</span><br></pre></td></tr></table></figure>

<h2 id="⚡-Performance-性能优化详解"><a href="#⚡-Performance-性能优化详解" class="headerlink" title="⚡ Performance 性能优化详解"></a>⚡ Performance 性能优化详解</h2><h3 id="🎯-性能优化核心原则"><a href="#🎯-性能优化核心原则" class="headerlink" title="🎯 性能优化核心原则"></a>🎯 性能优化核心原则</h3><ol>
<li><strong>减少Draw Calls</strong> - 合并网格，使用实例化</li>
<li><strong>优化纹理</strong> - 压缩纹理，减少尺寸</li>
<li><strong>简化几何体</strong> - LOD系统，面数优化</li>
<li><strong>智能剔除</strong> - 视锥剔除，遮挡剔除</li>
<li><strong>内存管理</strong> - 及时释放资源，对象池</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 性能优化管理器</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PerformanceOptimizer</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span> = scene.<span class="title function_">getEngine</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 性能监控</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">performanceMonitor</span> = <span class="keyword">new</span> <span class="title class_">PerformanceMonitor</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fpsCounter</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">frameTime</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lastFrameTime</span> = performance.<span class="title function_">now</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 优化配置</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">config</span> = &#123;</span><br><span class="line">      <span class="attr">enableOptimizations</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">targetFPS</span>: <span class="number">60</span>,</span><br><span class="line">      <span class="attr">adaptiveQuality</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">enableLOD</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">enableFrustumCulling</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">maxLights</span>: <span class="number">8</span>,</span><br><span class="line">      <span class="attr">shadowMapSize</span>: <span class="number">1024</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">initializeOptimizations</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">initializeOptimizations</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupEngineOptimizations</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupSceneOptimizations</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupRenderingOptimizations</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">startPerformanceMonitoring</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== 引擎级优化 =====</span></span><br><span class="line">  <span class="title function_">setupEngineOptimizations</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> engine = <span class="variable language_">this</span>.<span class="property">engine</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 禁用不必要的功能</span></span><br><span class="line">    engine.<span class="property">enableOfflineSupport</span> = <span class="literal">false</span></span><br><span class="line">    engine.<span class="property">doNotHandleContextLost</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 优化WebGL状态</span></span><br><span class="line">    engine.<span class="title function_">setDepthFunction</span>(<span class="title class_">Engine</span>.<span class="property">LEQUAL</span>)</span><br><span class="line">    engine.<span class="title function_">setStencilBuffer</span>(<span class="literal">false</span>) <span class="comment">// 如果不需要模板缓冲</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自适应设备像素比</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">adaptiveQuality</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setupAdaptiveQuality</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;引擎优化设置完成&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupAdaptiveQuality</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> engine = <span class="variable language_">this</span>.<span class="property">engine</span></span><br><span class="line">    <span class="keyword">let</span> basePixelRatio = <span class="variable language_">window</span>.<span class="property">devicePixelRatio</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据性能动态调整像素比</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">registerBeforeRender</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">fpsCounter</span> &lt; <span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">targetFPS</span> * <span class="number">0.8</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> newRatio = <span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="number">0.5</span>, basePixelRatio * <span class="number">0.9</span>)</span><br><span class="line">        engine.<span class="title function_">setHardwareScalingLevel</span>(<span class="number">1</span> / newRatio)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">fpsCounter</span> &gt; <span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">targetFPS</span> * <span class="number">0.95</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> newRatio = <span class="title class_">Math</span>.<span class="title function_">min</span>(basePixelRatio, basePixelRatio * <span class="number">1.1</span>)</span><br><span class="line">        engine.<span class="title function_">setHardwareScalingLevel</span>(<span class="number">1</span> / newRatio)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== 场景级优化 =====</span></span><br><span class="line">  <span class="title function_">setupSceneOptimizations</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> scene = <span class="variable language_">this</span>.<span class="property">scene</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启用视锥剔除</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">enableFrustumCulling</span>) &#123;</span><br><span class="line">      scene.<span class="property">skipFrustumClipping</span> = <span class="literal">false</span></span><br><span class="line">      scene.<span class="property">autoClear</span> = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 优化光照</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">optimizeLighting</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 优化阴影</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">optimizeShadows</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启用实例化</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">enableInstancing</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;场景优化设置完成&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">optimizeLighting</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> scene = <span class="variable language_">this</span>.<span class="property">scene</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 限制光源数量</span></span><br><span class="line">    <span class="keyword">let</span> lightCount = <span class="number">0</span></span><br><span class="line">    scene.<span class="property">lights</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">light</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (lightCount &gt;= <span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">maxLights</span>) &#123;</span><br><span class="line">        light.<span class="title function_">setEnabled</span>(<span class="literal">false</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        lightCount++</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 禁用不需要的光照计算</span></span><br><span class="line">    scene.<span class="property">lightsEnabled</span> = lightCount &gt; <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">optimizeShadows</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> scene = <span class="variable language_">this</span>.<span class="property">scene</span></span><br><span class="line"></span><br><span class="line">    scene.<span class="property">lights</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">light</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (light.<span class="title function_">getShadowGenerator</span>()) &#123;</span><br><span class="line">        <span class="keyword">const</span> shadowGen = light.<span class="title function_">getShadowGenerator</span>()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 优化阴影贴图尺寸</span></span><br><span class="line">        shadowGen.<span class="property">mapSize</span> = <span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">shadowMapSize</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启用阴影优化</span></span><br><span class="line">        shadowGen.<span class="property">usePercentageCloserFiltering</span> = <span class="literal">false</span></span><br><span class="line">        shadowGen.<span class="property">useKernelBlur</span> = <span class="literal">false</span></span><br><span class="line">        shadowGen.<span class="property">blurKernel</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置合理的阴影距离</span></span><br><span class="line">        shadowGen.<span class="title function_">setDarkness</span>(<span class="number">0.3</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">enableInstancing</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 为相似网格启用实例化</span></span><br><span class="line">    <span class="keyword">const</span> meshGroups = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (mesh.<span class="property">geometry</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> key = mesh.<span class="property">geometry</span>.<span class="property">id</span> + <span class="string">&#x27;_&#x27;</span> + (mesh.<span class="property">material</span> ? mesh.<span class="property">material</span>.<span class="property">id</span> : <span class="string">&#x27;none&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!meshGroups.<span class="title function_">has</span>(key)) &#123;</span><br><span class="line">          meshGroups.<span class="title function_">set</span>(key, [])</span><br><span class="line">        &#125;</span><br><span class="line">        meshGroups.<span class="title function_">get</span>(key).<span class="title function_">push</span>(mesh)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对于相同几何体和材质的网格，使用实例化</span></span><br><span class="line">    meshGroups.<span class="title function_">forEach</span>(<span class="function">(<span class="params">meshes, key</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (meshes.<span class="property">length</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`发现 <span class="subst">$&#123;meshes.length&#125;</span> 个相似网格，建议使用实例化`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== 渲染优化 =====</span></span><br><span class="line">  <span class="title function_">setupRenderingOptimizations</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> scene = <span class="variable language_">this</span>.<span class="property">scene</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 优化材质</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">optimizeMaterials</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 优化纹理</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">optimizeTextures</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启用几何体优化</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">optimizeGeometry</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;渲染优化设置完成&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">optimizeMaterials</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">materials</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">material</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (material <span class="keyword">instanceof</span> <span class="title class_">StandardMaterial</span>) &#123;</span><br><span class="line">        <span class="comment">// 禁用不必要的材质特性</span></span><br><span class="line">        <span class="keyword">if</span> (!material.<span class="property">diffuseTexture</span>) material.<span class="property">disableLighting</span> = <span class="literal">false</span></span><br><span class="line">        material.<span class="property">maxSimultaneousLights</span> = <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="number">4</span>, <span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">maxLights</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 优化反射</span></span><br><span class="line">        <span class="keyword">if</span> (material.<span class="property">reflectionTexture</span>) &#123;</span><br><span class="line">          material.<span class="property">reflectionTexture</span>.<span class="property">level</span> = <span class="number">0.5</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (material <span class="keyword">instanceof</span> <span class="title class_">PBRMaterial</span>) &#123;</span><br><span class="line">        <span class="comment">// PBR材质优化</span></span><br><span class="line">        material.<span class="property">maxSimultaneousLights</span> = <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="number">4</span>, <span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">maxLights</span>)</span><br><span class="line">        material.<span class="property">useRadianceOcclusion</span> = <span class="literal">false</span></span><br><span class="line">        material.<span class="property">useHorizonOcclusion</span> = <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">optimizeTextures</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">textures</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">texture</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (texture <span class="keyword">instanceof</span> <span class="title class_">Texture</span>) &#123;</span><br><span class="line">        <span class="comment">// 设置合理的过滤模式</span></span><br><span class="line">        texture.<span class="property">samplingMode</span> = <span class="title class_">Texture</span>.<span class="property">TRILINEAR_SAMPLINGMODE</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启用纹理压缩（如果支持）</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">getCaps</span>().<span class="property">s3tc</span>) &#123;</span><br><span class="line">          <span class="comment">// 可以使用DDS压缩纹理</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 限制纹理尺寸</span></span><br><span class="line">        <span class="keyword">const</span> maxSize = <span class="number">1024</span></span><br><span class="line">        <span class="keyword">if</span> (texture.<span class="title function_">getSize</span>().<span class="property">width</span> &gt; maxSize || texture.<span class="title function_">getSize</span>().<span class="property">height</span> &gt; maxSize) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`纹理 <span class="subst">$&#123;texture.name&#125;</span> 尺寸过大，建议压缩`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">optimizeGeometry</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (mesh.<span class="property">geometry</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> vertexCount = mesh.<span class="title function_">getTotalVertices</span>()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对于高面数模型建议LOD</span></span><br><span class="line">        <span class="keyword">if</span> (vertexCount &gt; <span class="number">10000</span>) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`网格 <span class="subst">$&#123;mesh.name&#125;</span> 顶点数过多 (<span class="subst">$&#123;vertexCount&#125;</span>)，建议使用LOD`</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 合并顶点</span></span><br><span class="line">        <span class="keyword">if</span> (mesh.<span class="title function_">isVerticesDataPresent</span>(<span class="title class_">VertexBuffer</span>.<span class="property">PositionKind</span>)) &#123;</span><br><span class="line">          <span class="comment">// mesh.mergeVertices() // 谨慎使用，可能影响UV</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== LOD系统 =====</span></span><br><span class="line">  <span class="title function_">setupLODSystem</span>(<span class="params">meshes, distances = [<span class="number">10</span>, <span class="number">50</span>, <span class="number">100</span>]</span>) &#123;</span><br><span class="line">    meshes.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (mesh.<span class="property">geometry</span>) &#123;</span><br><span class="line">        <span class="comment">// 创建LOD级别</span></span><br><span class="line">        <span class="keyword">const</span> lod1 = mesh.<span class="title function_">simplify</span>(</span><br><span class="line">          [</span><br><span class="line">            &#123; <span class="attr">quality</span>: <span class="number">0.8</span>, <span class="attr">distance</span>: distances[<span class="number">0</span>] &#125;,</span><br><span class="line">            &#123; <span class="attr">quality</span>: <span class="number">0.5</span>, <span class="attr">distance</span>: distances[<span class="number">1</span>] &#125;,</span><br><span class="line">            &#123; <span class="attr">quality</span>: <span class="number">0.2</span>, <span class="attr">distance</span>: distances[<span class="number">2</span>] &#125;,</span><br><span class="line">          ],</span><br><span class="line">          <span class="literal">false</span>,</span><br><span class="line">          <span class="title class_">SimplificationType</span>.<span class="property">QUADRATIC</span>,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`为网格 <span class="subst">$&#123;mesh.name&#125;</span> 设置LOD系统`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== 对象池 =====</span></span><br><span class="line">  <span class="title function_">createObjectPool</span>(<span class="params">createFunc, resetFunc, initialSize = <span class="number">10</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> pool = []</span><br><span class="line">    <span class="keyword">const</span> inUse = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化对象池</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; initialSize; i++) &#123;</span><br><span class="line">      pool.<span class="title function_">push</span>(<span class="title function_">createFunc</span>())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="title function_">acquire</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> obj = pool.<span class="title function_">pop</span>()</span><br><span class="line">        <span class="keyword">if</span> (!obj) &#123;</span><br><span class="line">          obj = <span class="title function_">createFunc</span>()</span><br><span class="line">        &#125;</span><br><span class="line">        inUse.<span class="title function_">add</span>(obj)</span><br><span class="line">        <span class="keyword">return</span> obj</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="title function_">release</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (inUse.<span class="title function_">has</span>(obj)) &#123;</span><br><span class="line">          <span class="title function_">resetFunc</span>(obj)</span><br><span class="line">          inUse.<span class="title function_">delete</span>(obj)</span><br><span class="line">          pool.<span class="title function_">push</span>(obj)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="title function_">getStats</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          <span class="attr">poolSize</span>: pool.<span class="property">length</span>,</span><br><span class="line">          <span class="attr">inUse</span>: inUse.<span class="property">size</span>,</span><br><span class="line">          <span class="attr">total</span>: pool.<span class="property">length</span> + inUse.<span class="property">size</span>,</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== 性能监控 =====</span></span><br><span class="line">  <span class="title function_">startPerformanceMonitoring</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> scene = <span class="variable language_">this</span>.<span class="property">scene</span></span><br><span class="line"></span><br><span class="line">    scene.<span class="title function_">registerBeforeRender</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> currentTime = performance.<span class="title function_">now</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">frameTime</span> = currentTime - <span class="variable language_">this</span>.<span class="property">lastFrameTime</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">fpsCounter</span> = <span class="number">1000</span> / <span class="variable language_">this</span>.<span class="property">frameTime</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">lastFrameTime</span> = currentTime</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 更新性能监控器</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">performanceMonitor</span>.<span class="title function_">sampleFrame</span>(currentTime)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定期输出性能报告</span></span><br><span class="line">    <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">generatePerformanceReport</span>()</span><br><span class="line">    &#125;, <span class="number">5000</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">generatePerformanceReport</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> engine = <span class="variable language_">this</span>.<span class="property">engine</span></span><br><span class="line">    <span class="keyword">const</span> scene = <span class="variable language_">this</span>.<span class="property">scene</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> report = &#123;</span><br><span class="line">      <span class="attr">fps</span>: <span class="title class_">Math</span>.<span class="title function_">round</span>(<span class="variable language_">this</span>.<span class="property">fpsCounter</span>),</span><br><span class="line">      <span class="attr">frameTime</span>: <span class="title class_">Math</span>.<span class="title function_">round</span>(<span class="variable language_">this</span>.<span class="property">frameTime</span> * <span class="number">100</span>) / <span class="number">100</span>,</span><br><span class="line">      <span class="attr">drawCalls</span>: engine.<span class="title function_">getDrawCalls</span>(),</span><br><span class="line">      <span class="attr">meshes</span>: scene.<span class="property">meshes</span>.<span class="property">length</span>,</span><br><span class="line">      <span class="attr">materials</span>: scene.<span class="property">materials</span>.<span class="property">length</span>,</span><br><span class="line">      <span class="attr">textures</span>: scene.<span class="property">textures</span>.<span class="property">length</span>,</span><br><span class="line">      <span class="attr">lights</span>: scene.<span class="property">lights</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">l</span>) =&gt;</span> l.<span class="title function_">isEnabled</span>()).<span class="property">length</span>,</span><br><span class="line">      <span class="attr">memory</span>: &#123;</span><br><span class="line">        <span class="attr">geometries</span>: engine.<span class="title function_">getGeometriesStatistics</span>(),</span><br><span class="line">        <span class="attr">textures</span>: engine.<span class="title function_">getTexturesStatistics</span>(),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;性能报告:&#x27;</span>, report)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自动优化建议</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">generateOptimizationSuggestions</span>(report)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> report</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">generateOptimizationSuggestions</span>(<span class="params">report</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> suggestions = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (report.<span class="property">fps</span> &lt; <span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">targetFPS</span> * <span class="number">0.8</span>) &#123;</span><br><span class="line">      suggestions.<span class="title function_">push</span>(<span class="string">&#x27;FPS过低，建议：&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (report.<span class="property">drawCalls</span> &gt; <span class="number">100</span>) &#123;</span><br><span class="line">        suggestions.<span class="title function_">push</span>(<span class="string">&#x27;- 减少Draw Calls（当前：&#x27;</span> + report.<span class="property">drawCalls</span> + <span class="string">&#x27;）&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (report.<span class="property">meshes</span> &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">        suggestions.<span class="title function_">push</span>(<span class="string">&#x27;- 减少网格数量（当前：&#x27;</span> + report.<span class="property">meshes</span> + <span class="string">&#x27;）&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (report.<span class="property">lights</span> &gt; <span class="number">4</span>) &#123;</span><br><span class="line">        suggestions.<span class="title function_">push</span>(<span class="string">&#x27;- 减少光源数量（当前：&#x27;</span> + report.<span class="property">lights</span> + <span class="string">&#x27;）&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (report.<span class="property">frameTime</span> &gt; <span class="number">16.67</span>) &#123;</span><br><span class="line">      suggestions.<span class="title function_">push</span>(<span class="string">&#x27;- 帧时间过长，考虑降低渲染质量&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (suggestions.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;优化建议：&#x27;</span>, suggestions)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== 批量优化工具 =====</span></span><br><span class="line">  <span class="title function_">applyQuickOptimizations</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;应用快速优化设置...&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 引擎优化</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">setHardwareScalingLevel</span>(<span class="number">1.2</span>) <span class="comment">// 降低渲染分辨率</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 场景优化</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">skipPointerMovePicking</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">autoClear</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">autoClearDepthAndStencil</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 材质优化</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">materials</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">material</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (material <span class="keyword">instanceof</span> <span class="title class_">StandardMaterial</span>) &#123;</span><br><span class="line">        material.<span class="property">maxSimultaneousLights</span> = <span class="number">2</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阴影优化</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="property">lights</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">light</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (light.<span class="title function_">getShadowGenerator</span>()) &#123;</span><br><span class="line">        light.<span class="title function_">getShadowGenerator</span>().<span class="property">mapSize</span> = <span class="number">512</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;快速优化完成&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ===== 内存优化 =====</span></span><br><span class="line">  <span class="title function_">cleanupUnusedResources</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> scene = <span class="variable language_">this</span>.<span class="property">scene</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理未使用的纹理</span></span><br><span class="line">    scene.<span class="property">textures</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">texture</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (texture.<span class="title function_">getScene</span>() === <span class="literal">null</span>) &#123;</span><br><span class="line">        texture.<span class="title function_">dispose</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理未使用的材质</span></span><br><span class="line">    scene.<span class="property">materials</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">material</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (material.<span class="title function_">getBindedMeshes</span>().<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">        material.<span class="title function_">dispose</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理未使用的几何体</span></span><br><span class="line">    scene.<span class="property">geometries</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">geometry</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (geometry.<span class="property">meshes</span>.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">        geometry.<span class="title function_">dispose</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 强制垃圾回收（仅开发环境）</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">gc</span> &amp;&amp; <span class="keyword">typeof</span> <span class="variable language_">window</span>.<span class="property">gc</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable language_">window</span>.<span class="title function_">gc</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;资源清理完成&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 资源清理</span></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">performanceMonitor</span>.<span class="title function_">dispose</span>()</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;性能优化器已清理&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> optimizer = <span class="keyword">new</span> <span class="title class_">PerformanceOptimizer</span>(scene)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 应用快速优化</span></span><br><span class="line">optimizer.<span class="title function_">applyQuickOptimizations</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置LOD系统</span></span><br><span class="line"><span class="keyword">const</span> importantMeshes = scene.<span class="property">meshes</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">m</span>) =&gt;</span> m.<span class="title function_">getTotalVertices</span>() &gt; <span class="number">1000</span>)</span><br><span class="line">optimizer.<span class="title function_">setupLODSystem</span>(importantMeshes, [<span class="number">20</span>, <span class="number">100</span>, <span class="number">500</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建粒子对象池</span></span><br><span class="line"><span class="keyword">const</span> particlePool = optimizer.<span class="title function_">createObjectPool</span>(</span><br><span class="line">  <span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">ParticleSystem</span>(<span class="string">&#x27;pooled&#x27;</span>, <span class="number">100</span>, scene),</span><br><span class="line">  <span class="function">(<span class="params">ps</span>) =&gt;</span> &#123;</span><br><span class="line">    ps.<span class="title function_">stop</span>()</span><br><span class="line">    ps.<span class="title function_">reset</span>()</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="number">5</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取性能报告</span></span><br><span class="line"><span class="keyword">const</span> report = optimizer.<span class="title function_">generatePerformanceReport</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;当前性能：&#x27;</span>, report)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清理未使用资源</span></span><br><span class="line">optimizer.<span class="title function_">cleanupUnusedResources</span>()</span><br></pre></td></tr></table></figure>

<h3 id="🎯-具体优化技巧"><a href="#🎯-具体优化技巧" class="headerlink" title="🎯 具体优化技巧"></a>🎯 具体优化技巧</h3><h4 id="1-网格优化"><a href="#1-网格优化" class="headerlink" title="1. 网格优化"></a>1. 网格优化</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 合并网格减少Draw Calls</span></span><br><span class="line"><span class="keyword">const</span> merged = <span class="title class_">Mesh</span>.<span class="title class_">MergeMeshes</span>(meshesToMerge)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用实例化</span></span><br><span class="line"><span class="keyword">const</span> instances = []</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">  instances.<span class="title function_">push</span>(originalMesh.<span class="title function_">createInstance</span>(<span class="string">&#x27;instance_&#x27;</span> + i))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简化几何体</span></span><br><span class="line">mesh.<span class="title function_">simplify</span>([&#123; <span class="attr">quality</span>: <span class="number">0.5</span>, <span class="attr">distance</span>: <span class="number">100</span> &#125;])</span><br></pre></td></tr></table></figure>

<h4 id="2-纹理优化"><a href="#2-纹理优化" class="headerlink" title="2. 纹理优化"></a>2. 纹理优化</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 压缩纹理</span></span><br><span class="line">texture.<span class="property">format</span> = <span class="title class_">Engine</span>.<span class="property">TEXTUREFORMAT_RGB</span></span><br><span class="line">texture.<span class="property">samplingMode</span> = <span class="title class_">Texture</span>.<span class="property">BILINEAR_SAMPLINGMODE</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 纹理图集</span></span><br><span class="line"><span class="keyword">const</span> atlasTexture = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;atlas.jpg&#x27;</span>, scene)</span><br></pre></td></tr></table></figure>

<h4 id="3-光照优化"><a href="#3-光照优化" class="headerlink" title="3. 光照优化"></a>3. 光照优化</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 限制光源影响范围</span></span><br><span class="line">light.<span class="property">range</span> = <span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用烘焙光照</span></span><br><span class="line"><span class="keyword">const</span> bakedTexture = <span class="keyword">new</span> <span class="title class_">Texture</span>(<span class="string">&#x27;lightmap.jpg&#x27;</span>, scene)</span><br><span class="line">material.<span class="property">lightmapTexture</span> = bakedTexture</span><br></pre></td></tr></table></figure>

<h4 id="4-渲染管线优化"><a href="#4-渲染管线优化" class="headerlink" title="4. 渲染管线优化"></a>4. 渲染管线优化</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 禁用不必要的渲染特性（指针移动拾取）</span></span><br><span class="line">scene.<span class="property">skipPointerMovePicking</span> = <span class="literal">true</span></span><br><span class="line">scene.<span class="property">constantlyUpdateMeshUnderPointer</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义渲染顺序（不透明/透明分组）</span></span><br><span class="line">scene.<span class="title function_">setRenderingOrder</span>(</span><br><span class="line">  <span class="number">0</span>, <span class="comment">// opaque sorting (默认即可)</span></span><br><span class="line">  <span class="literal">null</span>, <span class="comment">// alpha test sorting</span></span><br><span class="line">  <span class="function">(<span class="params">a, b</span>) =&gt;</span> a.<span class="property">position</span>.<span class="property">z</span> - b.<span class="property">position</span>.<span class="property">z</span>, <span class="comment">// transparent: 前后排序，按需定制</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 请求渲染模式：仅在变化时渲染（降低功耗）</span></span><br><span class="line">engine.<span class="title function_">setHardwareScalingLevel</span>(isMobile ? <span class="number">1.5</span> : <span class="number">1.0</span>)</span><br><span class="line">scene.<span class="title function_">getEngine</span>().<span class="property">renderEvenInBackground</span> = <span class="literal">false</span></span><br><span class="line">scene.<span class="property">onAfterRenderObservable</span>.<span class="title function_">add</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 空闲阶段不强制刷新</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认渲染管线按需启用</span></span><br><span class="line"><span class="keyword">const</span> pipeline = <span class="keyword">new</span> <span class="title class_">DefaultRenderingPipeline</span>(<span class="string">&#x27;default&#x27;</span>, <span class="literal">true</span>, scene, [camera])</span><br><span class="line">pipeline.<span class="property">bloomEnabled</span> = <span class="literal">false</span></span><br><span class="line">pipeline.<span class="property">depthOfFieldEnabled</span> = <span class="literal">false</span></span><br><span class="line">pipeline.<span class="property">chromaticAberrationEnabled</span> = <span class="literal">false</span></span><br><span class="line">pipeline.<span class="property">grainEnabled</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 仅桌面端启用轻量 Bloom</span></span><br><span class="line"><span class="keyword">if</span> (!isMobile) &#123;</span><br><span class="line">  pipeline.<span class="property">bloomEnabled</span> = <span class="literal">true</span></span><br><span class="line">  pipeline.<span class="property">bloomThreshold</span> = <span class="number">0.95</span></span><br><span class="line">  pipeline.<span class="property">bloomKernel</span> = <span class="number">24</span></span><br><span class="line">  pipeline.<span class="property">bloomWeight</span> = <span class="number">0.4</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 移动端禁用 SSAO/高成本效果</span></span><br></pre></td></tr></table></figure>

<p>小清单：</p>
<ul>
<li>优先关闭未使用的后处理；移动端禁用 SSAO&#x2F;高核 Bloom&#x2F;DoF。</li>
<li>启用请求渲染模式，减少空帧渲染。</li>
<li>透明对象排序自定义，避免过度 overdraw。</li>
<li>分辨率按设备 <code>setHardwareScalingLevel()</code> 动态调整。</li>
</ul>
<h2 id="🎯-最佳实践"><a href="#🎯-最佳实践" class="headerlink" title="🎯 最佳实践"></a>🎯 最佳实践</h2><h3 id="🏗️-项目结构最佳实践"><a href="#🏗️-项目结构最佳实践" class="headerlink" title="🏗️ 项目结构最佳实践"></a>🏗️ 项目结构最佳实践</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 推荐的项目结构</span></span><br><span class="line">project/</span><br><span class="line">├── src/</span><br><span class="line">│   ├── scenes/          <span class="comment">// 场景管理</span></span><br><span class="line">│   ├── models/          <span class="comment">// 3D模型</span></span><br><span class="line">│   ├── materials/       <span class="comment">// 材质库</span></span><br><span class="line">│   ├── animations/      <span class="comment">// 动画控制</span></span><br><span class="line">│   ├── utils/           <span class="comment">// 工具函数</span></span><br><span class="line">│   └── main.<span class="property">js</span>          <span class="comment">// 入口文件</span></span><br><span class="line">├── assets/</span><br><span class="line">│   ├── models/          <span class="comment">// .glb, .babylon文件</span></span><br><span class="line">│   ├── textures/        <span class="comment">// 纹理贴图</span></span><br><span class="line">│   ├── sounds/          <span class="comment">// 音频文件</span></span><br><span class="line">│   └── environments/    <span class="comment">// 环境贴图</span></span><br><span class="line">└── public/</span><br><span class="line">    └── babylon/         <span class="comment">// BabylonJS库文件</span></span><br></pre></td></tr></table></figure>

<h3 id="📝-代码组织最佳实践"><a href="#📝-代码组织最佳实践" class="headerlink" title="📝 代码组织最佳实践"></a>📝 代码组织最佳实践</h3><h4 id="1-场景管理"><a href="#1-场景管理" class="headerlink" title="1. 场景管理"></a>1. 场景管理</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SceneManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">canvas</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span> = <span class="keyword">new</span> <span class="title class_">Engine</span>(canvas, <span class="literal">true</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = <span class="keyword">new</span> <span class="title class_">Scene</span>(<span class="variable language_">this</span>.<span class="property">engine</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setupBasicScene</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupBasicScene</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 相机</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span> = <span class="keyword">new</span> <span class="title class_">ArcRotateCamera</span>(<span class="string">&#x27;camera&#x27;</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="title class_">Vector3</span>.<span class="title class_">Zero</span>(), <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">camera</span>.<span class="title function_">attachToCanvas</span>(<span class="variable language_">this</span>.<span class="property">canvas</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 光照</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">light</span> = <span class="keyword">new</span> <span class="title class_">HemisphericLight</span>(<span class="string">&#x27;light&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>), <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 渲染循环</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">runRenderLoop</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">render</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">dispose</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">engine</span>.<span class="title function_">dispose</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-资源加载管理"><a href="#2-资源加载管理" class="headerlink" title="2. 资源加载管理"></a>2. 资源加载管理</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AssetLoader</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = scene</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loadedAssets</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadAssets</span>(<span class="params">assetList</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> promises = assetList.<span class="title function_">map</span>(<span class="function">(<span class="params">asset</span>) =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">loadSingleAsset</span>(asset))</span><br><span class="line">    <span class="keyword">const</span> results = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">allSettled</span>(promises)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> results.<span class="title function_">map</span>(<span class="function">(<span class="params">result, index</span>) =&gt;</span> (&#123;</span><br><span class="line">      <span class="attr">name</span>: assetList[index].<span class="property">name</span>,</span><br><span class="line">      <span class="attr">success</span>: result.<span class="property">status</span> === <span class="string">&#x27;fulfilled&#x27;</span>,</span><br><span class="line">      <span class="attr">asset</span>: result.<span class="property">value</span> || <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">error</span>: result.<span class="property">reason</span> || <span class="literal">null</span>,</span><br><span class="line">    &#125;))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadSingleAsset</span>(<span class="params">&#123; type, name, url, options = &#123;&#125; &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> asset</span><br><span class="line">      <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;model&#x27;</span>:</span><br><span class="line">          asset = <span class="keyword">await</span> <span class="title class_">SceneLoader</span>.<span class="title class_">ImportMeshAsync</span>(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, url, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;texture&#x27;</span>:</span><br><span class="line">          asset = <span class="keyword">new</span> <span class="title class_">Texture</span>(url, <span class="variable language_">this</span>.<span class="property">scene</span>)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`不支持的资源类型: <span class="subst">$&#123;type&#125;</span>`</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">loadedAssets</span>.<span class="title function_">set</span>(name, asset)</span><br><span class="line">      <span class="keyword">return</span> asset</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`加载资源失败: <span class="subst">$&#123;name&#125;</span>`</span>, error)</span><br><span class="line">      <span class="keyword">throw</span> error</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-错误处理"><a href="#3-错误处理" class="headerlink" title="3. 错误处理"></a>3. 错误处理</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ErrorHandler</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">handleError</span>(<span class="params">error, context = <span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`BabylonJS错误 [<span class="subst">$&#123;context&#125;</span>]:`</span>, error)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据错误类型进行处理</span></span><br><span class="line">    <span class="keyword">if</span> (error.<span class="property">message</span>.<span class="title function_">includes</span>(<span class="string">&#x27;WebGL&#x27;</span>)) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleWebGLError</span>(error)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error.<span class="property">message</span>.<span class="title function_">includes</span>(<span class="string">&#x27;loading&#x27;</span>)) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleLoadingError</span>(error)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleGenericError</span>(error)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">handleWebGLError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="title function_">alert</span>(<span class="string">&#x27;WebGL不支持或已禁用，请更新浏览器或启用硬件加速&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">handleLoadingError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;资源加载失败，将使用默认资源&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">handleGenericError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 通用错误处理</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">isDevelopment</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> error <span class="comment">// 开发环境抛出错误</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="🎨-开发最佳实践"><a href="#🎨-开发最佳实践" class="headerlink" title="🎨 开发最佳实践"></a>🎨 开发最佳实践</h3><h4 id="1-性能优化原则"><a href="#1-性能优化原则" class="headerlink" title="1. 性能优化原则"></a>1. 性能优化原则</h4><ul>
<li><strong>避免在渲染循环中创建对象</strong></li>
<li><strong>使用对象池管理频繁创建&#x2F;销毁的对象</strong></li>
<li><strong>合理使用LOD和实例化</strong></li>
<li><strong>及时释放不用的资源</strong></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误示例 - 在渲染循环中创建对象</span></span><br><span class="line">scene.<span class="title function_">registerBeforeRender</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> newVector = <span class="keyword">new</span> <span class="title class_">Vector3</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>) <span class="comment">// 每帧都创建新对象</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确示例 - 重用对象</span></span><br><span class="line"><span class="keyword">const</span> reusableVector = <span class="keyword">new</span> <span class="title class_">Vector3</span>()</span><br><span class="line">scene.<span class="title function_">registerBeforeRender</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  reusableVector.<span class="title function_">set</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>) <span class="comment">// 重用现有对象</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="2-内存管理"><a href="#2-内存管理" class="headerlink" title="2. 内存管理"></a>2. 内存管理</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ResourceManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">disposables</span> = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">addDisposable</span>(<span class="params">resource</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">disposables</span>.<span class="title function_">add</span>(resource)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">dispose</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">disposables</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">resource</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (resource.<span class="property">dispose</span>) &#123;</span><br><span class="line">        resource.<span class="title function_">dispose</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">disposables</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-调试技巧"><a href="#3-调试技巧" class="headerlink" title="3. 调试技巧"></a>3. 调试技巧</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启用调试功能</span></span><br><span class="line">scene.<span class="property">debugLayer</span>.<span class="title function_">show</span>(&#123;</span><br><span class="line">  <span class="attr">overlay</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">showExplorer</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">showInspector</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 性能计数器</span></span><br><span class="line">scene.<span class="title function_">registerBeforeRender</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">isDevelopment</span> &amp;&amp; <span class="title class_">Math</span>.<span class="title function_">random</span>() &lt; <span class="number">0.01</span>) &#123;</span><br><span class="line">    <span class="comment">// 1%概率输出</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(&#123;</span><br><span class="line">      <span class="attr">fps</span>: engine.<span class="title function_">getFps</span>(),</span><br><span class="line">      <span class="attr">meshes</span>: scene.<span class="property">meshes</span>.<span class="property">length</span>,</span><br><span class="line">      <span class="attr">drawCalls</span>: engine.<span class="title function_">getDrawCalls</span>(),</span><br><span class="line">      <span class="attr">materials</span>: scene.<span class="property">materials</span>.<span class="property">length</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="🛡️-安全性最佳实践"><a href="#🛡️-安全性最佳实践" class="headerlink" title="🛡️ 安全性最佳实践"></a>🛡️ 安全性最佳实践</h3><h4 id="1-输入验证"><a href="#1-输入验证" class="headerlink" title="1. 输入验证"></a>1. 输入验证</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">validateAssetUrl</span>(<span class="params">url</span>) &#123;</span><br><span class="line">  <span class="comment">// 只允许特定域名和文件类型</span></span><br><span class="line">  <span class="keyword">const</span> allowedDomains = [<span class="string">&#x27;your-cdn.com&#x27;</span>, <span class="string">&#x27;localhost&#x27;</span>]</span><br><span class="line">  <span class="keyword">const</span> allowedExtensions = [<span class="string">&#x27;.glb&#x27;</span>, <span class="string">&#x27;.babylon&#x27;</span>, <span class="string">&#x27;.jpg&#x27;</span>, <span class="string">&#x27;.png&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> urlObj = <span class="keyword">new</span> <span class="title function_">URL</span>(url)</span><br><span class="line">    <span class="keyword">const</span> isValidDomain = allowedDomains.<span class="title function_">some</span>(</span><br><span class="line">      <span class="function">(<span class="params">domain</span>) =&gt;</span> urlObj.<span class="property">hostname</span> === domain || urlObj.<span class="property">hostname</span>.<span class="title function_">endsWith</span>(<span class="string">&#x27;.&#x27;</span> + domain),</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">const</span> isValidExtension = allowedExtensions.<span class="title function_">some</span>(<span class="function">(<span class="params">ext</span>) =&gt;</span></span><br><span class="line">      urlObj.<span class="property">pathname</span>.<span class="title function_">toLowerCase</span>().<span class="title function_">endsWith</span>(ext),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> isValidDomain &amp;&amp; isValidExtension</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-资源限制"><a href="#2-资源限制" class="headerlink" title="2. 资源限制"></a>2. 资源限制</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">RESOURCE_LIMITS</span> = &#123;</span><br><span class="line">  <span class="attr">maxMeshes</span>: <span class="number">1000</span>,</span><br><span class="line">  <span class="attr">maxMaterials</span>: <span class="number">100</span>,</span><br><span class="line">  <span class="attr">maxTextures</span>: <span class="number">200</span>,</span><br><span class="line">  <span class="attr">maxTextureSize</span>: <span class="number">2048</span>,</span><br><span class="line">  <span class="attr">maxVerticesPerMesh</span>: <span class="number">50000</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">validateResourceLimits</span>(<span class="params">scene</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> issues = []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (scene.<span class="property">meshes</span>.<span class="property">length</span> &gt; <span class="variable constant_">RESOURCE_LIMITS</span>.<span class="property">maxMeshes</span>) &#123;</span><br><span class="line">    issues.<span class="title function_">push</span>(<span class="string">`网格数量超限: <span class="subst">$&#123;scene.meshes.length&#125;</span>/<span class="subst">$&#123;RESOURCE_LIMITS.maxMeshes&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  scene.<span class="property">meshes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mesh.<span class="title function_">getTotalVertices</span>() &gt; <span class="variable constant_">RESOURCE_LIMITS</span>.<span class="property">maxVerticesPerMesh</span>) &#123;</span><br><span class="line">      issues.<span class="title function_">push</span>(<span class="string">`网格 <span class="subst">$&#123;mesh.name&#125;</span> 顶点数过多: <span class="subst">$&#123;mesh.getTotalVertices()&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> issues</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="📱-移动端优化最佳实践"><a href="#📱-移动端优化最佳实践" class="headerlink" title="📱 移动端优化最佳实践"></a>📱 移动端优化最佳实践</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测移动设备</span></span><br><span class="line"><span class="keyword">const</span> isMobile = <span class="regexp">/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i</span>.<span class="title function_">test</span>(</span><br><span class="line">  navigator.<span class="property">userAgent</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isMobile) &#123;</span><br><span class="line">  <span class="comment">// 移动端优化设置</span></span><br><span class="line">  engine.<span class="title function_">setHardwareScalingLevel</span>(<span class="number">1.5</span>) <span class="comment">// 降低分辨率</span></span><br><span class="line">  scene.<span class="property">skipPointerMovePicking</span> = <span class="literal">true</span> <span class="comment">// 禁用鼠标移动拾取</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 简化材质</span></span><br><span class="line">  scene.<span class="property">materials</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">material</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (material <span class="keyword">instanceof</span> <span class="title class_">StandardMaterial</span>) &#123;</span><br><span class="line">      material.<span class="property">maxSimultaneousLights</span> = <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 启用触摸控制</span></span><br><span class="line">  scene.<span class="property">actionManager</span> = <span class="keyword">new</span> <span class="title class_">ActionManager</span>(scene)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="🎯-部署最佳实践"><a href="#🎯-部署最佳实践" class="headerlink" title="🎯 部署最佳实践"></a>🎯 部署最佳实践</h3><h4 id="1-生产环境配置"><a href="#1-生产环境配置" class="headerlink" title="1. 生产环境配置"></a>1. 生产环境配置</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生产环境优化</span></span><br><span class="line"><span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">  <span class="comment">// 禁用调试</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="property">log</span> = <span class="function">() =&gt;</span> &#123;&#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="property">warn</span> = <span class="function">() =&gt;</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 启用压缩</span></span><br><span class="line">  <span class="title class_">Engine</span>.<span class="property">audioEngine</span>.<span class="property">useCustomUnlockedState</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 错误上报</span></span><br><span class="line">  <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 发送错误报告到服务器</span></span><br><span class="line">    <span class="title function_">sendErrorReport</span>(event.<span class="property">error</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-CDN资源配置"><a href="#2-CDN资源配置" class="headerlink" title="2. CDN资源配置"></a>2. CDN资源配置</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">CDN_CONFIG</span> = &#123;</span><br><span class="line">  <span class="attr">models</span>: <span class="string">&#x27;https://cdn.example.com/models/&#x27;</span>,</span><br><span class="line">  <span class="attr">textures</span>: <span class="string">&#x27;https://cdn.example.com/textures/&#x27;</span>,</span><br><span class="line">  <span class="attr">sounds</span>: <span class="string">&#x27;https://cdn.example.com/sounds/&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getAssetUrl</span>(<span class="params">type, filename</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> baseUrl = <span class="variable constant_">CDN_CONFIG</span>[type] || <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="keyword">return</span> baseUrl + filename</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="📚-常见问题解决方案"><a href="#📚-常见问题解决方案" class="headerlink" title="📚 常见问题解决方案"></a>📚 常见问题解决方案</h3><h4 id="1-WebGL上下文丢失"><a href="#1-WebGL上下文丢失" class="headerlink" title="1. WebGL上下文丢失"></a>1. WebGL上下文丢失</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">canvas.<span class="title function_">addEventListener</span>(<span class="string">&#x27;webglcontextlost&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  event.<span class="title function_">preventDefault</span>()</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;WebGL上下文丢失&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">canvas.<span class="title function_">addEventListener</span>(<span class="string">&#x27;webglcontextrestored&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;WebGL上下文已恢复&#x27;</span>)</span><br><span class="line">  <span class="comment">// 重新初始化场景</span></span><br><span class="line">  <span class="title function_">initializeScene</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="2-内存泄漏预防"><a href="#2-内存泄漏预防" class="headerlink" title="2. 内存泄漏预防"></a>2. 内存泄漏预防</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 页面卸载时清理资源</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;beforeunload&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (scene) &#123;</span><br><span class="line">    scene.<span class="title function_">dispose</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (engine) &#123;</span><br><span class="line">    engine.<span class="title function_">dispose</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="3-异步加载处理"><a href="#3-异步加载处理" class="headerlink" title="3. 异步加载处理"></a>3. 异步加载处理</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">safeAsyncLoad</span>(<span class="params">loadFunction</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> timeout = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">_, reject</span>) =&gt;</span> <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;加载超时&#x27;</span>)), <span class="number">30000</span>))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">race</span>([<span class="title function_">loadFunction</span>(), timeout])</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;异步加载失败:&#x27;</span>, error)</span><br><span class="line">    <span class="keyword">throw</span> error</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="🤝-与-Cesium-同屏叠加（单图层）实现"><a href="#🤝-与-Cesium-同屏叠加（单图层）实现" class="headerlink" title="🤝 与 Cesium 同屏叠加（单图层）实现"></a>🤝 与 Cesium 同屏叠加（单图层）实现</h2><p>实现目标：在保持 Cesium 作为底图&#x2F;地形的前提下，BabylonJS 作为透明叠加层绘制自定义 3D&#x2F;特效，两个引擎同屏显示、相机同步。</p>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><ol>
<li>叠加一个透明 Canvas（置顶、事件穿透）</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">  <span class="selector-id">#wrap</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">position</span>: relative;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css">  <span class="selector-id">#cesium</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">position</span>: absolute;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">inset</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css">  <span class="selector-id">#babylon</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">position</span>: absolute;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">inset</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">pointer-events</span>: none;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;wrap&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;cesium&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">&quot;babylon&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>初始化两个引擎（Babylon 透明&#x2F;右手系）</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cesium</span></span><br><span class="line">aaa <span class="keyword">const</span> viewer = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Viewer</span>(<span class="string">&#x27;cesium&#x27;</span>, &#123; <span class="comment">/* ...底图/地形... */</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Babylon</span></span><br><span class="line">aaa <span class="keyword">const</span> babCanvas = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;babylon&#x27;</span>)</span><br><span class="line">aaa <span class="keyword">const</span> engine = <span class="keyword">new</span> <span class="variable constant_">BABYLON</span>.<span class="title class_">Engine</span>(babCanvas, <span class="literal">true</span>, &#123; <span class="attr">alpha</span>: <span class="literal">true</span>, <span class="attr">preserveDrawingBuffer</span>: <span class="literal">true</span>, <span class="attr">stencil</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">aaa <span class="keyword">const</span> scene = <span class="keyword">new</span> <span class="variable constant_">BABYLON</span>.<span class="title class_">Scene</span>(engine)</span><br><span class="line">aaa scene.<span class="property">useRightHandedSystem</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">aaa scene.<span class="property">clearColor</span> = <span class="keyword">new</span> <span class="variable constant_">BABYLON</span>.<span class="title class_">Color4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">const</span> camera = <span class="keyword">new</span> <span class="variable constant_">BABYLON</span>.<span class="title class_">FreeCamera</span>(<span class="string">&#x27;syncCam&#x27;</span>, <span class="keyword">new</span> <span class="variable constant_">BABYLON</span>.<span class="title class_">Vector3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), scene)</span><br><span class="line">camera.<span class="property">minZ</span> = <span class="number">0.1</span></span><br><span class="line">camera.<span class="property">maxZ</span> = <span class="number">1e9</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>相机同步（每帧 Cesium 渲染完成后同步 Babylon）</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">v3</span>(<span class="params">x, y, z</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="variable constant_">BABYLON</span>.<span class="title class_">Vector3</span>(x, y, z)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">syncBabylonCamera</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> c = viewer.<span class="property">camera</span></span><br><span class="line">  <span class="keyword">const</span> pos = c.<span class="property">positionWC</span></span><br><span class="line">  <span class="keyword">const</span> dir = c.<span class="property">directionWC</span></span><br><span class="line">  <span class="keyword">const</span> up = c.<span class="property">upWC</span></span><br><span class="line"></span><br><span class="line">  camera.<span class="property">position</span> = <span class="title function_">v3</span>(pos.<span class="property">x</span>, pos.<span class="property">y</span>, pos.<span class="property">z</span>)</span><br><span class="line">  camera.<span class="property">upVector</span> = <span class="title function_">v3</span>(up.<span class="property">x</span>, up.<span class="property">y</span>, up.<span class="property">z</span>)</span><br><span class="line">  camera.<span class="title function_">setTarget</span>(<span class="title function_">v3</span>(pos.<span class="property">x</span> + dir.<span class="property">x</span>, pos.<span class="property">y</span> + dir.<span class="property">y</span>, pos.<span class="property">z</span> + dir.<span class="property">z</span>))</span><br><span class="line">  camera.<span class="property">fov</span> = c.<span class="property">frustum</span>.<span class="property">fov</span></span><br><span class="line"></span><br><span class="line">  engine.<span class="title function_">resize</span>()</span><br><span class="line">  scene.<span class="title function_">render</span>()</span><br><span class="line">&#125;</span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">postRender</span>.<span class="title function_">addEventListener</span>(syncBabylonCamera)</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>在经纬高放置 Babylon 物体（经纬高 → ECEF → ENU 矩阵）</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">enuMatrixAt</span>(<span class="params">lon, lat, alt</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> ecef = <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(lon, lat, alt)</span><br><span class="line">  <span class="keyword">const</span> m = <span class="title class_">Cesium</span>.<span class="property">Transforms</span>.<span class="title function_">eastNorthUpToFixedFrame</span>(ecef) <span class="comment">// 4x4 列主序</span></span><br><span class="line">  <span class="keyword">return</span> <span class="variable constant_">BABYLON</span>.<span class="property">Matrix</span>.<span class="title class_">FromArray</span>([</span><br><span class="line">    m[<span class="number">0</span>],</span><br><span class="line">    m[<span class="number">1</span>],</span><br><span class="line">    m[<span class="number">2</span>],</span><br><span class="line">    m[<span class="number">3</span>],</span><br><span class="line">    m[<span class="number">4</span>],</span><br><span class="line">    m[<span class="number">5</span>],</span><br><span class="line">    m[<span class="number">6</span>],</span><br><span class="line">    m[<span class="number">7</span>],</span><br><span class="line">    m[<span class="number">8</span>],</span><br><span class="line">    m[<span class="number">9</span>],</span><br><span class="line">    m[<span class="number">10</span>],</span><br><span class="line">    m[<span class="number">11</span>],</span><br><span class="line">    m[<span class="number">12</span>],</span><br><span class="line">    m[<span class="number">13</span>],</span><br><span class="line">    m[<span class="number">14</span>],</span><br><span class="line">    m[<span class="number">15</span>],</span><br><span class="line">  ])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> box = <span class="variable constant_">BABYLON</span>.<span class="property">MeshBuilder</span>.<span class="title class_">CreateBox</span>(<span class="string">&#x27;box&#x27;</span>, &#123; <span class="attr">size</span>: <span class="number">50</span> &#125;, scene)</span><br><span class="line">box.<span class="title function_">setPreTransformMatrix</span>(<span class="title function_">enuMatrixAt</span>(<span class="number">116.4074</span>, <span class="number">39.9042</span>, <span class="number">100</span>))</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>注意事项</li>
</ol>
<ul>
<li>Babylon 画布透明渲染有成本：减少后处理与高开销材质</li>
<li>指针事件：默认穿透给 Cesium；需要 Babylon 拾取时移除 <code>pointer-events: none</code> 并进行事件路由</li>
<li>两引擎深度不互通：遮挡&#x2F;阴影互不影响，按需在 Babylon 内做自洽光照</li>
</ul>
<h3 id="方案优势"><a href="#方案优势" class="headerlink" title="方案优势"></a>方案优势</h3><ul>
<li>低耦合：两引擎互不入侵，升级&#x2F;配置互不影响</li>
<li>快速落地：仅需透明层 + 相机同步 + 经纬高摆放</li>
<li>强扩展：可将 Babylon 的 Shader&#x2F;粒子&#x2F;后处理作为“视觉层”无缝叠加到 Cesium 地理场景</li>
<li>跨平台稳健：不依赖私有接口，运行在常规 Web 环境</li>
</ul>
<h3 id="拓展性建议"><a href="#拓展性建议" class="headerlink" title="拓展性建议"></a>拓展性建议</h3><ul>
<li>事件路由：提供开关切换事件归属（Cesium&#x2F;Babylon），或按区域分配</li>
<li>坐标工具化：封装 <code>lonlat-&gt;ECEF-&gt;ENU</code> 与矩阵应用工具，统一放置误差</li>
<li>渲染策略：请求渲染模式、分辨率缩放、按需渲染（只在 Cesium 相机变化时驱动 Babylon）</li>
<li>组件化：抽象为 <code>CesiumBabylonOverlay</code> 类，提供 <code>addMeshAt(lon,lat,alt,mesh)</code> 等 API</li>
</ul>
<h3 id="🎉-总结"><a href="#🎉-总结" class="headerlink" title="🎉 总结"></a>🎉 总结</h3><p>遵循这些最佳实践可以帮助你：</p>
<ul>
<li><strong>提高应用性能</strong> - 通过合理的资源管理和优化</li>
<li><strong>增强代码可维护性</strong> - 通过清晰的结构和错误处理</li>
<li><strong>确保用户体验</strong> - 通过移动端优化和安全性措施</li>
<li><strong>简化调试过程</strong> - 通过完善的日志和监控</li>
</ul>
<p>记住，最佳实践是指导原则，需要根据具体项目需求灵活调整。持续学习和优化是BabylonJS开发的关键。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://aoayaoa.github.io">aoaYaoa</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://aoayaoa.github.io/2025/07/31/babylonjs/">https://aoayaoa.github.io/2025/07/31/babylonjs/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://aoayaoa.github.io" target="_blank">aoaYaoa</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/BabylonJS/">BabylonJS</a></div><div class="post-share"><div class="social-share" data-image="/img/babylonjs.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/04/25/Go%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" title="Go语言学习总结"><img class="cover" src="/img/go.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Go语言学习总结</div></div><div class="info-2"><div class="info-item-1">Go语言学习总结目录 一、Go语言基础 1. 安装与环境配置 2. Go语言核心概念 包与模块 基本数据类型 数据类型使用场景 复数类型详解 变量与常量 流程控制   3. 函数与方法 4. 结构体与接口 5. 并发编程 6. 通道详解 7. Context上下文   二、项目架构与设计模式 1. 分层架构 2. 仓储模式 3. 服务层 4. 配置管理 5. 中间件设计 6. 日志工具   三、Web应用开发 1. 路由设置 2. 控制器实现 3. 主程序入口   四、最佳实践与编码规范 1. 错误处理 2. 并发控制 3. 单元测试 4. 性能优化 5....</div></div></div></a><a class="pagination-related" href="/2025/07/31/cesium/" title="Cesium 开发文档"><img class="cover" src="/img/cesium.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Cesium 开发文档</div></div><div class="info-2"><div class="info-item-1">Cesium 完整离线开发指南📋 目录 离线环境配置 Viewer 详细配置 坐标系统详解 实体系统完整属性 影像系统详解 地形系统详解 相机系统完整属性 事件系统详解 材质系统详解 动画系统详解 几何体系统详解 场景控制详解 数据源详解 时间系统详解 绘制功能详解 性能优化详解  离线环境配置完整离线包下载123456789101112131415161718# 1. 下载Cesium完整包wget https://github.com/CesiumGS/cesium/releases/download/1.110/Cesium-1.110.zip# 2....</div></div></div></a></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">aoaYaoa</div><div class="author-info-description">个人博客，记录成长点滴...</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">13</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">15</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/aoaYaoa"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/aoaYaoa" rel="external nofollow noreferrer" target="_blank" title="GitHub"><i class="fab fa-github" style="color: #181717;"></i></a><a class="social-icon" href="https://twitter.com/yourname" rel="external nofollow noreferrer" target="_blank" title="Twitter"><i class="fab fa-twitter" style="color: #1DA1F2;"></i></a><a class="social-icon" href="mailto:skyeeq9@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #EA4335;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">算了，不知道写什么，就这样吧！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#BabylonJS-%E5%AE%8C%E6%95%B4%E7%A6%BB%E7%BA%BF%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97"><span class="toc-number">1.</span> <span class="toc-text">BabylonJS 完整离线开发指南</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%93%8B-%E7%9B%AE%E5%BD%95"><span class="toc-number">1.1.</span> <span class="toc-text">📋 目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%9A%80-BabylonJS-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.2.</span> <span class="toc-text">🚀 BabylonJS 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E7%89%B9%E6%80%A7"><span class="toc-number">1.2.1.</span> <span class="toc-text">核心特性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%92%BB-%E7%A6%BB%E7%BA%BF%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.</span> <span class="toc-text">💻 离线环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Vite-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.1.</span> <span class="toc-text">Vite 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.2.</span> <span class="toc-text">项目结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E5%AE%89%E8%A3%85"><span class="toc-number">1.3.3.</span> <span class="toc-text">依赖安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.3.4.</span> <span class="toc-text">基础初始化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AF-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">1.4.</span> <span class="toc-text">🎯 核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9D%90%E6%A0%87%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.4.1.</span> <span class="toc-text">坐标系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E5%AD%A6%E5%B7%A5%E5%85%B7"><span class="toc-number">1.4.2.</span> <span class="toc-text">数学工具</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AC-Engine-%E5%BC%95%E6%93%8E%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.5.</span> <span class="toc-text">🎬 Engine 引擎详解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AD-Scene-%E5%9C%BA%E6%99%AF%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.6.</span> <span class="toc-text">🎭 Scene 场景详解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%93%B7-Camera-%E7%9B%B8%E6%9C%BA%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.7.</span> <span class="toc-text">📷 Camera 相机系统详解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%92%A1-Light-%E5%85%89%E7%85%A7%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.8.</span> <span class="toc-text">💡 Light 光照系统详解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%A8-Material-%E6%9D%90%E8%B4%A8%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.9.</span> <span class="toc-text">🎨 Material 材质系统详解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AD-Mesh-%E7%BD%91%E6%A0%BC%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.10.</span> <span class="toc-text">🎭 Mesh 网格系统详解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AC-Animation-%E5%8A%A8%E7%94%BB%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.11.</span> <span class="toc-text">🎬 Animation 动画系统详解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%86-ParticleSystem-%E7%B2%92%E5%AD%90%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.12.</span> <span class="toc-text">🎆 ParticleSystem 粒子系统详解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%94%8A-Audio-%E9%9F%B3%E9%A2%91%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.13.</span> <span class="toc-text">🔊 Audio 音频系统详解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AE-Input-%E8%BE%93%E5%85%A5%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.14.</span> <span class="toc-text">🎮 Input 输入系统详解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%94%A7-Asset-%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.15.</span> <span class="toc-text">🔧 Asset 资源管理详解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%9A%A1-Performance-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.16.</span> <span class="toc-text">⚡ Performance 性能优化详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8E%AF-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%A0%B8%E5%BF%83%E5%8E%9F%E5%88%99"><span class="toc-number">1.16.1.</span> <span class="toc-text">🎯 性能优化核心原则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8E%AF-%E5%85%B7%E4%BD%93%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A7"><span class="toc-number">1.16.2.</span> <span class="toc-text">🎯 具体优化技巧</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E7%BD%91%E6%A0%BC%E4%BC%98%E5%8C%96"><span class="toc-number">1.16.2.1.</span> <span class="toc-text">1. 网格优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%BA%B9%E7%90%86%E4%BC%98%E5%8C%96"><span class="toc-number">1.16.2.2.</span> <span class="toc-text">2. 纹理优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%85%89%E7%85%A7%E4%BC%98%E5%8C%96"><span class="toc-number">1.16.2.3.</span> <span class="toc-text">3. 光照优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%B8%B2%E6%9F%93%E7%AE%A1%E7%BA%BF%E4%BC%98%E5%8C%96"><span class="toc-number">1.16.2.4.</span> <span class="toc-text">4. 渲染管线优化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AF-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.17.</span> <span class="toc-text">🎯 最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8F%97%EF%B8%8F-%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.17.1.</span> <span class="toc-text">🏗️ 项目结构最佳实践</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%93%9D-%E4%BB%A3%E7%A0%81%E7%BB%84%E7%BB%87%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.17.2.</span> <span class="toc-text">📝 代码组织最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%9C%BA%E6%99%AF%E7%AE%A1%E7%90%86"><span class="toc-number">1.17.2.1.</span> <span class="toc-text">1. 场景管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD%E7%AE%A1%E7%90%86"><span class="toc-number">1.17.2.2.</span> <span class="toc-text">2. 资源加载管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">1.17.2.3.</span> <span class="toc-text">3. 错误处理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8E%A8-%E5%BC%80%E5%8F%91%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.17.3.</span> <span class="toc-text">🎨 开发最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%8E%9F%E5%88%99"><span class="toc-number">1.17.3.1.</span> <span class="toc-text">1. 性能优化原则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="toc-number">1.17.3.2.</span> <span class="toc-text">2. 内存管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7"><span class="toc-number">1.17.3.3.</span> <span class="toc-text">3. 调试技巧</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%9B%A1%EF%B8%8F-%E5%AE%89%E5%85%A8%E6%80%A7%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.17.4.</span> <span class="toc-text">🛡️ 安全性最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E8%BE%93%E5%85%A5%E9%AA%8C%E8%AF%81"><span class="toc-number">1.17.4.1.</span> <span class="toc-text">1. 输入验证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6"><span class="toc-number">1.17.4.2.</span> <span class="toc-text">2. 资源限制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%93%B1-%E7%A7%BB%E5%8A%A8%E7%AB%AF%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.17.5.</span> <span class="toc-text">📱 移动端优化最佳实践</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8E%AF-%E9%83%A8%E7%BD%B2%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.17.6.</span> <span class="toc-text">🎯 部署最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.17.6.1.</span> <span class="toc-text">1. 生产环境配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-CDN%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE"><span class="toc-number">1.17.6.2.</span> <span class="toc-text">2. CDN资源配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%93%9A-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.17.7.</span> <span class="toc-text">📚 常见问题解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-WebGL%E4%B8%8A%E4%B8%8B%E6%96%87%E4%B8%A2%E5%A4%B1"><span class="toc-number">1.17.7.1.</span> <span class="toc-text">1. WebGL上下文丢失</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E9%A2%84%E9%98%B2"><span class="toc-number">1.17.7.2.</span> <span class="toc-text">2. 内存泄漏预防</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%BC%82%E6%AD%A5%E5%8A%A0%E8%BD%BD%E5%A4%84%E7%90%86"><span class="toc-number">1.17.7.3.</span> <span class="toc-text">3. 异步加载处理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A4%9D-%E4%B8%8E-Cesium-%E5%90%8C%E5%B1%8F%E5%8F%A0%E5%8A%A0%EF%BC%88%E5%8D%95%E5%9B%BE%E5%B1%82%EF%BC%89%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.18.</span> <span class="toc-text">🤝 与 Cesium 同屏叠加（单图层）实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.18.1.</span> <span class="toc-text">步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%BC%98%E5%8A%BF"><span class="toc-number">1.18.2.</span> <span class="toc-text">方案优势</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%93%E5%B1%95%E6%80%A7%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.18.3.</span> <span class="toc-text">拓展性建议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8E%89-%E6%80%BB%E7%BB%93"><span class="toc-number">1.18.4.</span> <span class="toc-text">🎉 总结</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/07/31/babylonjs/" title="BabylonJS"><img src="/img/babylonjs.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="BabylonJS"/></a><div class="content"><a class="title" href="/2025/07/31/babylonjs/" title="BabylonJS">BabylonJS</a><time datetime="2025-07-30T16:00:00.000Z" title="发表于 2025-07-31 00:00:00">2025-07-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/07/31/cesium/" title="Cesium 开发文档"><img src="/img/cesium.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Cesium 开发文档"/></a><div class="content"><a class="title" href="/2025/07/31/cesium/" title="Cesium 开发文档">Cesium 开发文档</a><time datetime="2025-07-30T16:00:00.000Z" title="发表于 2025-07-31 00:00:00">2025-07-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/07/31/mars3d/" title="mars3D 开发文档"><img src="/img/mars3d.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="mars3D 开发文档"/></a><div class="content"><a class="title" href="/2025/07/31/mars3d/" title="mars3D 开发文档">mars3D 开发文档</a><time datetime="2025-07-30T16:00:00.000Z" title="发表于 2025-07-31 00:00:00">2025-07-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/25/Go%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" title="Go语言学习总结"><img src="/img/go.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Go语言学习总结"/></a><div class="content"><a class="title" href="/2025/04/25/Go%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" title="Go语言学习总结">Go语言学习总结</a><time datetime="2025-04-24T16:00:00.000Z" title="发表于 2025-04-25 00:00:00">2025-04-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/15/deno%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" title="Deno学习记录"><img src="/img/deno.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Deno学习记录"/></a><div class="content"><a class="title" href="/2025/04/15/deno%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" title="Deno学习记录">Deno学习记录</a><time datetime="2025-04-14T16:00:00.000Z" title="发表于 2025-04-15 00:00:00">2025-04-15</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By aoaYaoa</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.4</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoogo.netlify.app/.netlify/functions/twikoo',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = (el = document, path = location.pathname) => {
    twikoo.init({
      el: el.querySelector('#twikoo-wrap'),
      envId: 'https://twikoogo.netlify.app/.netlify/functions/twikoo',
      region: '',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      },
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    

    isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
      if (el.children.length) {
        el.innerHTML = ''
        el.classList.add('no-comment')
      }
    })
  }

  const loadTwikoo = (el, path) => {
    if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
    else btf.getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(() => init(el, path))
  }

  if (isShuoshuo) {
    'Twikoo' === 'Twikoo'
      ? window.shuoshuoComment = { loadComment: loadTwikoo }
      : window.loadOtherComment = loadTwikoo
    return
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><div class="aplayer no-destroy" data-id="13528716738" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="true"> </div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="富强,民主,文明,和谐,自由,平等,公正,法治,爱国,敬业,诚信,友善" data-fontsize="15px" data-random="true" async="async"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script>(() => {
  const destroyAplayer = () => {
    if (window.aplayers) {
      for (let i = 0; i < window.aplayers.length; i++) {
        if (!window.aplayers[i].options.fixed) {
          window.aplayers[i].destroy()
        }
      }
    }
  }

  const runMetingJS = () => {
    typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()
  }

  btf.addGlobalFn('pjaxSend', destroyAplayer, 'destroyAplayer')
  btf.addGlobalFn('pjaxComplete', loadMeting, 'runMetingJS')
})()</script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => fn())
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      const usePjax = true
      true 
        ? (usePjax ? pjax.loadUrl('/404.html') : window.location.href = '/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章..." type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>